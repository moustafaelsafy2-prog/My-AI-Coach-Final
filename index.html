<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ | Intelligent Health Coach</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Marked + DOMPurify -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>

  <style>
    :root{
      --brand:#6c5ce7; --brand-2:#00c2ff;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      /* Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø¯Ø§ÙƒÙ† */
      --bg1:#0a0f1c; --bg2:#0e1526; --fg:#eaf0ff;
      --muted:#93a2b8; --card-bg1:rgba(255,255,255,.08); --card-bg2:rgba(255,255,255,.03);
      --card-border:rgba(255,255,255,.10); --field-bg:rgba(255,255,255,.06); --field-border:rgba(255,255,255,.12);
      --table-head:rgba(255,255,255,.08); --table-cell:rgba(255,255,255,.14);
    }
    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ (ØªØ¨Ø§ÙŠÙ† Ù…Ù…ØªØ§Ø²) */
    body.theme-light{
      --bg1:#eef2ff; --bg2:#f7f9ff; --fg:#0b1220;
      --muted:#4b5563; --card-bg1:#ffffff; --card-bg2:#ffffff;
      --card-border:#e5e7eb; --field-bg:#ffffff; --field-border:#d1d5db;
      --table-head:#f3f4f6; --table-cell:#d1d5db;
    }

    html[dir="rtl"] body{ font-family:Tajawal,system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",sans-serif }
    html[dir="ltr"] body{ font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif }

    body{ background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%); color:var(--fg); }
    .glass{ background:linear-gradient(180deg,var(--card-bg1),var(--card-bg2)); border:1px solid var(--card-border); }
    .title-grad{ background:linear-gradient(90deg,var(--brand),var(--brand-2)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; font-weight:800; border-radius:.8rem; padding:.7rem 1rem; }
    .btn-primary{ background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#fff; }
    .btn-ghost{ background:var(--field-bg); border:1px solid var(--field-border); color:var(--fg); }
    .field{ background:var(--field-bg); border:1px solid var(--field-border); border-radius:.7rem; padding:.65rem .8rem; outline:none; width:100%; color:var(--fg); }
    .field::placeholder{ color:var(--muted) }
    .field:focus{ border-color:var(--brand-2); box-shadow:0 0 0 3px rgba(0,194,255,.15); }
    .chip{ background:var(--field-bg); border:1px solid var(--field-border); color:var(--fg); border-radius:999px; padding:.35rem .6rem; font-size:.78rem; }

    .progress{ height:.4rem; background:rgba(127,127,127,.15); border-radius:999px; overflow:hidden; }
    .progress > i{ display:block; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); width:0%; transition:width .25s ease; }

    .status-dot{ width:.6rem; height:.6rem; border-radius:999px; display:inline-block; }
    .st-pending{ background:#94a3b8 } .st-running{ background:var(--warn) }
    .st-done{ background:var(--ok) } .st-fail{ background:var(--err) }

    .ai-content h2{ font-weight:900; font-size:1.3rem; margin:.6rem 0 }
    .ai-content h3{ font-weight:800; font-size:1.1rem; margin:.5rem 0 }
    .ai-content table{ border-collapse:collapse; width:100%; background:transparent; margin:.6rem 0 }
    .ai-content th,.ai-content td{ border:1px solid var(--table-cell); padding:.5rem; vertical-align:top; color:var(--fg) }
    .ai-content th{ background:var(--table-head); font-weight:800 }

    @media print{
      body{ background:#fff; color:#111 }
      #bar, #sticky, #actions{ display:none!important }
      .ai-content th,.ai-content td{ border-color:#333; color:#111 }
      .ai-content th{ background:#f3f4f6 }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header id="bar" class="sticky top-0 z-40 glass border-b backdrop-blur">
    <div class="max-w-6xl mx-auto px-3 md:px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-[var(--brand)] to-[var(--brand-2)] grid place-items-center font-black">AI</div>
        <div>
          <div id="app-title" class="text-base md:text-lg font-extrabold">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ</div>
          <div class="hidden md:block text-xs" style="color:var(--muted)" id="subtitle">Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù % Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€“ Ù…Ø®ØµØµØ© Ù„Ùƒ</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="lang-ar" class="chip" type="button">Ø¹Ø±Ø¨Ù‰</button>
        <button id="lang-en" class="chip" type="button">EN</button>
        <button id="toggle-theme" class="chip" type="button">â˜€/â˜¾</button>
        <button id="btn-print" class="btn btn-ghost" type="button">ğŸ–¨ï¸ <span id="t-print">Ø·Ø¨Ø§Ø¹Ø©</span></button>
      </div>
    </div>
    <div id="sticky" class="border-t">
      <div class="max-w-6xl mx-auto px-3 md:px-4 py-2 flex items-center justify-between gap-3">
        <div class="text-xs" style="color:var(--muted)" id="hint">Ø§Ù„ØªÙ‚Ø¯Ù…</div>
        <div class="w-40 md:w-60 progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><i id="global-progress"></i></div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-3 md:px-4 py-5">
    <!-- Form -->
    <section class="glass rounded-2xl p-4 md:p-5 mb-4">
      <div class="text-xl title-grad font-extrabold mb-3" id="step-title">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
        <!-- Profile -->
        <div class="glass rounded-xl p-4">
          <div class="font-extrabold mb-2" id="lbl-profile">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
          <div class="space-y-2">
            <label class="block text-sm" id="lbl-name">Ø§Ù„Ø§Ø³Ù…
              <input id="name" class="field mt-1" placeholder="Ø§Ù„Ø§Ø³Ù…" />
            </label>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm" id="lbl-age">Ø§Ù„Ø¹Ù…Ø±
                <input id="age" class="field mt-1" inputmode="numeric" pattern="[0-9]*" />
              </label>
              <label class="block text-sm" id="lbl-sex">Ø§Ù„Ø¬Ù†Ø³
                <select id="sex" class="field mt-1">
                  <option value="Male">Ø°ÙƒØ±</option>
                  <option value="Female">Ø£Ù†Ø«Ù‰</option>
                </select>
              </label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm" id="lbl-h">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)
                <input id="height" class="field mt-1" inputmode="numeric" pattern="[0-9]*" />
              </label>
              <label class="block text-sm" id="lbl-w">Ø§Ù„ÙˆØ²Ù† (ÙƒØº)
                <input id="weight" class="field mt-1" inputmode="numeric" pattern="[0-9]*" />
              </label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm" id="lbl-bf">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† % (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                <input id="bodyFat" class="field mt-1" inputmode="numeric" pattern="[0-9]*" />
              </label>
              <label class="block text-sm" id="lbl-waist">Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ± (Ø³Ù…) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                <input id="waist" class="field mt-1" inputmode="numeric" pattern="[0-9]*" />
              </label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm" id="lbl-tw">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (ÙƒØº)
                <input id="targetWeight" class="field mt-1" inputmode="numeric" pattern="[0-9]*" />
              </label>
              <label class="block text-sm" id="lbl-td">Ù…ÙˆØ¹Ø¯ ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù
                <input id="targetDate" type="date" class="field mt-1" />
              </label>
            </div>
          </div>
        </div>

        <!-- Diet -->
        <div class="glass rounded-xl p-4">
          <div class="font-extrabold mb-2" id="lbl-diet">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª</div>
          <div class="space-y-2">
            <div class="text-sm" id="lbl-goals">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ù…ØªØ¹Ø¯Ø¯)</div>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <label><input type="checkbox" class="goal" value="fatLoss" /> <span id="g1">Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†</span></label>
              <label><input type="checkbox" class="goal" value="build" /> <span id="g2">Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª</span></label>
              <label><input type="checkbox" class="goal" value="strength" /> <span id="g3">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©</span></label>
              <label><input type="checkbox" class="goal" value="endurance" /> <span id="g4">ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„</span></label>
              <label><input type="checkbox" class="goal" value="health" /> <span id="g5">ØµØ­Ø© Ø¹Ø§Ù…Ø©</span></label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm" id="lbl-meals">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª
                <input id="meals" class="field mt-1" inputmode="numeric" pattern="[0-9]*" value="3" />
              </label>
              <label class="block text-sm" id="lbl-pref">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù‘Ù„
                <select id="prefDiet" class="field mt-1">
                  <option value="Balanced">Ù†Ø¸Ø§Ù… Ù…ØªÙˆØ§Ø²Ù†</option>
                  <option value="LowCarb">Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª</option>
                  <option value="Keto">ÙƒÙŠØªÙˆ</option>
                  <option value="Arabic/Mediter.">Ù…ØªÙˆØ³Ø·ÙŠ/Ø¹Ø±Ø¨ÙŠ</option>
                  <option value="Plant">Ù†Ø¨Ø§ØªÙŠ/Ù…Ø±Ù†</option>
                </select>
              </label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm" id="lbl-if">Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹
                <select id="fasting" class="field mt-1">
                  <option value="off">ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</option>
                  <option value="16:8">16:8</option>
                  <option value="18:6">18:6</option>
                  <option value="20:4">20:4</option>
                </select>
              </label>
              <label class="block text-sm" id="lbl-cuisine">Ø§Ù„Ù…Ø·Ø¨Ø®
                <input id="cuisine" class="field mt-1" value="Arabic/Mediter." />
              </label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm" id="lbl-prep">Ø²Ù…Ù† Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø¯)
                <input id="prep" class="field mt-1" inputmode="numeric" pattern="[0-9]*" value="20" />
              </label>
              <label class="block text-sm" id="lbl-budget">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
                <div class="flex gap-2 mt-1">
                  <input id="budget" class="field flex-1" inputmode="numeric" pattern="[0-9]*" value="0" />
                  <select id="currency" class="field w-28">
                    <option>USD</option><option>EUR</option><option>GBP</option>
                    <option>SAR</option><option>AED</option><option>KWD</option><option>QAR</option><option>EGP</option>
                  </select>
                </div>
              </label>
            </div>
            <label class="block text-sm" id="lbl-avoid">Ø£Ø·Ø¹Ù…Ø© Ù„Ø§ ØªØ±ØºØ¨ Ø¨Ù‡Ø§/Ø­Ø³Ø§Ø³ÙŠØ§Øª
              <input id="avoid" class="field mt-1" placeholder="Ù…Ø«Ø§Ù„: Ù„Ø§ Ø£Ø­Ø¨ Ø§Ù„Ø³Ù…ÙƒØŒ Ø­Ø³Ø§Ø³ÙŠØ© ÙØ³ØªÙ‚â€¦" />
            </label>
            <label class="block text-sm" id="lbl-allergy">Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø´Ø§Ø¦Ø¹Ø©
              <input id="allergies" class="field mt-1" placeholder="Gluten, Lactose, Nutsâ€¦" />
            </label>
          </div>
        </div>

        <!-- Lifestyle + Medical -->
        <div class="space-y-3">
          <div class="glass rounded-xl p-4">
            <div class="font-extrabold mb-2" id="lbl-life">Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨</div>
            <div class="space-y-2">
              <div class="grid grid-cols-2 gap-2">
                <label class="block text-sm" id="lbl-work">Ø§Ù„Ø¹Ù…Ù„/Ø§Ù„Ù†Ø´Ø§Ø·
                  <select id="work" class="field mt-1">
                    <option value="Sedentary">Ù…ÙƒØªØ¨ÙŠ</option><option value="Light">Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ</option>
                    <option value="Moderate">Ù…ØªÙˆØ³Ø·</option><option value="High">Ù…Ø±ØªÙØ¹</option>
                  </select>
                </label>
                <label class="block text-sm" id="lbl-steps">Ø®Ø·ÙˆØ§Øª/Ø§Ù„ÙŠÙˆÙ…
                  <input id="steps" class="field mt-1" inputmode="numeric" pattern="[0-9]*" value="6000" />
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label class="block text-sm" id="lbl-sleep">Ø§Ù„Ù†ÙˆÙ…
                  <select id="sleep" class="field mt-1"><option>Low</option><option>Medium</option><option>High</option></select>
                </label>
                <label class="block text-sm" id="lbl-stress">Ø§Ù„ØªÙˆØªØ±
                  <select id="stress" class="field mt-1"><option>Low</option><option>Medium</option><option>High</option></select>
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label class="block text-sm" id="lbl-place">Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ…Ø±ÙŠÙ†
                  <input id="place" class="field mt-1" value="Home/Gym" />
                </label>
                <label class="block text-sm" id="lbl-session">Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯)
                  <input id="session" class="field mt-1" inputmode="numeric" pattern="[0-9]*" value="60" />
                </label>
              </div>
              <div class="text-sm" id="lbl-days">Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
              <div class="grid grid-cols-7 gap-2 text-xs">
                <label class="chip"><input type="checkbox" id="d0" class="me-1" /> Ø³</label>
                <label class="chip"><input type="checkbox" id="d1" class="me-1" /> Ø­</label>
                <label class="chip"><input type="checkbox" id="d2" class="me-1" /> Ù†</label>
                <label class="chip"><input type="checkbox" id="d3" class="me-1" /> Ø«</label>
                <label class="chip"><input type="checkbox" id="d4" class="me-1" /> Ø±</label>
                <label class="chip"><input type="checkbox" id="d5" class="me-1" /> Ø®</label>
                <label class="chip"><input type="checkbox" id="d6" class="me-1" /> Ø¬</label>
              </div>
              <label class="block text-sm" id="lbl-eq">Ø§Ù„Ù…Ø¹Ø¯Ø§Øª
                <input id="equip" class="field mt-1" placeholder="Dumbbells, barbell, bandsâ€¦" />
              </label>
              <div class="grid grid-cols-2 gap-2">
                <label class="block text-sm" id="lbl-exp">Ø§Ù„Ø®Ø¨Ø±Ø©
                  <select id="exp" class="field mt-1"><option>Beginner (0-6m)</option><option>Intermediate (6-24m)</option><option>Advanced (24m+)</option></select>
                </label>
                <label class="block text-sm" id="lbl-rpe">RPE
                  <input id="rpe" class="field mt-1" inputmode="numeric" pattern="[0-9]*" value="8" />
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label class="block text-sm" id="lbl-caf">ÙƒØ§ÙÙŠÙŠÙ†/Ø§Ù„ÙŠÙˆÙ…
                  <input id="caf" class="field mt-1" inputmode="numeric" pattern="[0-9]*" value="0" />
                </label>
                <label class="block text-sm" id="lbl-inj">Ø¥ØµØ§Ø¨Ø§Øª/Ù‚ÙŠÙˆØ¯
                  <input id="inj" class="field mt-1" placeholder="Shoulder impingementâ€¦" />
                </label>
              </div>
            </div>
          </div>

          <div class="glass rounded-xl p-4">
            <div class="font-extrabold mb-2" id="lbl-med">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª</div>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <!-- medical checkboxes -->
              <label><input type="checkbox" class="cond" value="Hypertension" /> Ø¶ØºØ· Ø§Ù„Ø¯Ù…</label>
              <label><input type="checkbox" class="cond" value="Diabetes" /> Ø§Ù„Ø³ÙƒØ±ÙŠ</label>
              <label><input type="checkbox" class="cond" value="Insulin Resistance" /> Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†</label>
              <label><input type="checkbox" class="cond" value="Thyroid issues" /> Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØºØ¯Ø©</label>
              <label><input type="checkbox" class="cond" value="Hormonal issues" /> Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©</label>
              <label><input type="checkbox" class="cond" value="Fatty Liver" /> Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ</label>
              <label><input type="checkbox" class="cond" value="Joint/Knee problems" /> Ù…ÙØ§ØµÙ„/Ø±ÙƒØ¨</label>
              <label><input type="checkbox" class="cond" value="Heart disease" /> Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨</label>
              <label><input type="checkbox" class="cond" value="IBD/Ulcer" /> IBD/Ù‚Ø±Ø­Ø©</label>
              <label><input type="checkbox" class="cond" value="GERD/Reflux" /> GERD/Ø§Ø±ØªØ¬Ø§Ø¹</label>
              <label><input type="checkbox" class="cond" value="Gluten intolerance" /> Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†</label>
              <label><input type="checkbox" class="cond" value="Lactose intolerance" /> Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²</label>
            </div>
            <div class="mt-2 space-y-2">
              <label class="block text-sm" id="lbl-other">Ø£Ù…Ø±Ø§Ø¶ Ø£Ø®Ø±Ù‰
                <input id="otherCond" class="field mt-1" />
              </label>
              <label class="block text-sm" id="lbl-meds">Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ©
                <input id="meds" class="field mt-1" />
              </label>
              <label class="block text-sm" id="lbl-supps">Ù…ÙƒÙ…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ©
                <input id="supps" class="field mt-1" />
              </label>
              <label class="block text-sm" id="lbl-past">ØªØ­Ø¯ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©
                <input id="past" class="field mt-1" placeholder="Ø¬ÙˆØ¹ Ø´Ø¯ÙŠØ¯ØŒ Ù…Ù„Ù„ Ù…Ù† Ø§Ù„Ø·Ø¹Ø§Ù…ØŒ Ø¥ØµØ§Ø¨Ø§Øªâ€¦" />
              </label>
              <label class="block text-sm" id="lbl-motiv">Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØ­ÙÙŠØ²
                <select id="motiv" class="field mt-1"><option value="Direct">Ø¹Ù…Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±</option><option value="Warm">ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…</option></select>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="mt-4 flex items-center justify-between">
        <button id="cancel" class="btn btn-ghost hidden" type="button">âœ– Ø¥Ù„ØºØ§Ø¡</button>
        <div class="flex items-center gap-2">
          <button id="generate" class="btn btn-primary" type="button">âš¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©</button>
        </div>
      </div>
    </section>

    <!-- Timeline -->
    <section class="glass rounded-2xl p-4 md:p-5 mb-4">
      <div class="font-extrabold mb-2" id="lbl-progress">ØªÙ‚Ø¯Ù… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ (Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù…)</div>
      <div id="timeline" class="flex flex-wrap gap-2 text-xs"></div>
    </section>

    <!-- Plan -->
    <section id="plan" class="glass rounded-2xl p-4 md:p-5">
      <div id="plan-empty" class="text-sm" style="color:var(--muted)">â€” Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© â€”</div>
      <div id="plan-content" class="ai-content"></div>
      <div id="actions" class="mt-5 flex items-center justify-end gap-2">
        <button class="btn btn-ghost" id="scroll-top" type="button">â†‘ Ø£Ø¹Ù„Ù‰</button>
        <button class="btn btn-primary" id="print-bottom" type="button">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
      </div>
      <div class="mt-6 text-center text-[0.8rem]" style="color:var(--muted)" id="footer-credit">
        Powered by <strong>Coach Mustafa Elsafy</strong> â€” Ø§Ù„Ù…Ø¯Ø±Ø¨ <strong>Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ</strong> Â© 2025
      </div>
    </section>
  </main>

  <script>
    /* ============= Globals ============= */
    const hasMarked = !!window.marked;
    if (hasMarked) { try { marked.setOptions({ breaks:true, mangle:false, headerIds:false }); } catch(_){} }
    const hasDOMPurify = !!window.DOMPurify;

    const $ = (id)=>document.getElementById(id);
    const esc = (s)=> (s??'').toString().replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
    const state = {
      lang:(navigator.language||'ar').startsWith('ar')?'ar':'en',
      currency: detectCurrency(),
      cancelCtrl: null,
      profile:{}, diet:{}, lifestyle:{availableDays:[]}, fitness:{}, medical:{}, challenges:{},
      targets:null
    };

    /* ============= I18N Minimal ============= */
    const L = {
      ar:{
        app:'Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ', sub:'Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù % Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€“ Ù…Ø®ØµØµØ© Ù„Ùƒ',
        print:'Ø·Ø¨Ø§Ø¹Ø©', progress:'Ø§Ù„ØªÙ‚Ø¯Ù…', formTitle:'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',
        profile:'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', diet:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª', life:'Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨', med:'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª',
        goals:'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ù…ØªØ¹Ø¯Ø¯)', g1:'Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†', g2:'Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª', g3:'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©', g4:'ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„', g5:'ØµØ­Ø© Ø¹Ø§Ù…Ø©',
        planProgress:'ØªÙ‚Ø¯Ù… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ (Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù…)', planEmpty:'â€” Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© â€”',
        footer:`Powered by <strong>Coach Mustafa Elsafy</strong> â€” Ø§Ù„Ù…Ø¯Ø±Ø¨ <strong>Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ</strong> Â© 2025`
      },
      en:{
        app:'Intelligent Health Coach', sub:'100% precise plan for nutrition, training & supplements â€“ fully personalized',
        print:'Print', progress:'Progress', formTitle:'Profile',
        profile:'Profile', diet:'Diet & Preferences', life:'Lifestyle & Training', med:'Medical & Challenges',
        goals:'Goals (multi-select)', g1:'Fat loss', g2:'Build muscle', g3:'Strength', g4:'Endurance', g5:'General health',
        planProgress:'Live generation (section by section)', planEmpty:'â€” Sections will stream here â€”',
        footer:`Powered by <strong>Coach Mustafa Elsafy</strong> â€” Â© 2025`
      }
    };
    function setLang(lang){
      state.lang=lang;
      const t=L[lang];
      document.documentElement.lang=lang;
      document.documentElement.dir=(lang==='ar')?'rtl':'ltr';
      $('app-title').textContent=t.app; $('subtitle').textContent=t.sub;
      $('t-print').textContent=t.print; $('hint').textContent=t.progress;
      $('step-title').textContent=t.formTitle;
      $('lbl-profile').textContent=t.profile; $('lbl-diet').textContent=t.diet;
      $('lbl-life').textContent=t.life; $('lbl-med').textContent=t.med;
      $('lbl-goals').textContent=t.goals; $('g1').textContent=t.g1; $('g2').textContent=t.g2; $('g3').textContent=t.g3; $('g4').textContent=t.g4; $('g5').textContent=t.g5;
      $('lbl-progress').textContent=t.planProgress; $('plan-empty').textContent=t.planEmpty;
      $('footer-credit').innerHTML=t.footer;
    }

    /* ============= Theme ============= */
    function setTheme(light){
      document.body.classList.toggle('theme-light', !!light);
    }

    /* ============= Read Form ============= */
    function readForm(){
      const goals=[...document.querySelectorAll('.goal')].filter(x=>x.checked).map(x=>x.value);
      const cond=[...document.querySelectorAll('.cond')].filter(x=>x.checked).map(x=>x.value);
      const days=[]; for(let i=0;i<7;i++){ if($('d'+i).checked) days.push(i); }
      state.profile = {
        name: $('name').value.trim(), age:$('age').value.trim(), height:$('height').value.trim(), weight:$('weight').value.trim(),
        bodyFat:$('bodyFat').value.trim(), waist:$('waist').value.trim(), sex:$('sex').value,
        targetWeight:$('targetWeight').value.trim(), targetDate:$('targetDate').value
      };
      state.diet = {
        goals, mealsPerDay:+($('meals').value||3), preferredDiet:$('prefDiet').value, cuisine:$('cuisine').value,
        prepTime:+($('prep').value||20), monthlyBudget:+($('budget').value||0), foodsToAvoid:$('avoid').value, allergies:$('allergies').value,
        fasting:$('fasting').value
      };
      state.lifestyle = {
        workActivity:$('work').value, stepsPerDay:+($('steps').value||6000), sleep:$('sleep').value, stress:$('stress').value,
        trainingPlace:$('place').value, sessionLength:+($('session').value||60), availableDays:days,
        equipment:$('equip').value, experience:$('exp').value, rpe:+($('rpe').value||8), caffeine:+($('caf').value||0), injuries:$('inj').value
      };
      state.medical = { conditions:cond, other:$('otherCond').value, meds:$('meds').value, supplements:$('supps').value };
      state.challenges = { past:$('past').value, motivation:$('motiv').value };
      state.currency = $('currency').value;
    }

    function computeTargets(){
      const p=state.profile, Ls=state.lifestyle, goals=state.diet.goals||[];
      const W=+p.weight||0, H=+p.height||0, A=+p.age||0, male=(p.sex==='Male'||p.sex==='Ø°ÙƒØ±');
      const BMR=male?10*W+6.25*H-5*A+5:10*W+6.25*H-5*A-161;
      const mult={Sedentary:1.2,Light:1.35,Moderate:1.5,High:1.7}[Ls.workActivity]||1.35;
      let TDEE=BMR*mult; if(goals.includes('fatLoss')) TDEE*=0.85; if(goals.includes('build')) TDEE*=1.10;
      const bf=+p.bodyFat||null; const LM=bf?W*(1-bf/100):(p.targetWeight?+p.targetWeight:W*0.8);
      let protein=Math.round(2.0*Math.max(LM,40)), fat=Math.round(Math.max(0.8*W,40)), carbs=Math.round((TDEE-(protein*4+fat*9))/4);
      if(state.medical.conditions?.some(c=>c==='Diabetes'||c==='Insulin Resistance')) carbs=Math.min(carbs,120);
      carbs=Math.max(40,carbs);
      return { bmr:Math.round(BMR), tdee:Math.round(TDEE), protein_g:protein, fat_g:fat, carb_g:carbs };
    }

    /* ============= Timeline ============= */
    const SECTION_ORDER = ()=> {
      const arr=['welcome','analysis','allowed']; if(($('fasting').value||'off')!=='off') arr.push('fasting');
      for(let i=1;i<=7;i++) arr.push('nutrition-day-'+i);
      for(let i=1;i<=7;i++) arr.push('training-day-'+i);
      arr.push('supplements','progression','troubleshoot','safety','closing'); return arr;
    };
    const TITLES = {
      ar:{welcome:'Ø§Ù„ØªØ±Ø­ÙŠØ¨',analysis:'Ø§Ù„ØªØ­Ù„ÙŠÙ„',allowed:'Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹',fasting:'Ø§Ù„ØµÙŠØ§Ù…','nutrition':'Ø§Ù„ØªØºØ°ÙŠØ© â€” ÙŠÙˆÙ…','training':'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ â€” ÙŠÙˆÙ…',supplements:'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª',progression:'Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…',troubleshoot:'Ø§Ù„Ù…Ø´Ø§ÙƒÙ„',safety:'Ø§Ù„Ø³Ù„Ø§Ù…Ø©',closing:'Ø§Ù„Ø®ØªØ§Ù…'},
      en:{welcome:'Welcome',analysis:'Analysis',allowed:'Allowed / Limits',fasting:'Intermittent fasting','nutrition':'Nutrition â€” Day','training':'Training â€” Day',supplements:'Supplements',progression:'Progression',troubleshoot:'Troubleshooting',safety:'Safety',closing:'Closing'}
    };
    function buildTimeline(sections){
      const wrap=$('timeline'); wrap.innerHTML='';
      const TT=TITLES[state.lang];
      sections.forEach(k=>{
        const item=document.createElement('div'); item.dataset.key=k;
        item.className='flex items-center gap-2 px-2 py-1 rounded-lg';
        item.style.background='var(--field-bg)'; item.style.border='1px solid var(--field-border)';
        const dot='<span class="status-dot st-pending"></span>';
        const lab = k.startsWith('nutrition-day') ? `${TT.nutrition} ${k.split('-').pop()}`
                 : k.startsWith('training-day') ? `${TT.training} ${k.split('-').pop()}`
                 : TT[k]||k;
        item.innerHTML=`${dot}<span class="font-semibold">${lab}</span>`;
        wrap.appendChild(item);
      });
    }
    function setTimelineStatus(key,status){
      const el=[...$('timeline').children].find(x=>x.dataset.key===key); if(!el) return;
      const dot=el.querySelector('.status-dot');
      dot.className='status-dot '+(status==='run'?'st-running':status==='ok'?'st-done':status==='fail'?'st-fail':'st-pending');
    }

    /* ============= Markdown Safe ============= */
    const simpleMD=(md)=> (md||'').split(/\n{2,}/).map(p=>`<p>${esc(p).replace(/\n/g,'<br>')}</p>`).join('\n');
    function renderMD(md){ let h=hasMarked?marked.parse(md||''):simpleMD(md); if(hasDOMPurify) h=DOMPurify.sanitize(h,{USE_PROFILES:{html:true}}); return h; }

    /* ============= AI Call ============= */
    async function callAI(prompt,{retries=1,timeoutMs=45000,signal}={}){
      const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeoutMs);
      try{
        const res=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt}),signal:signal||ctrl.signal});
        if(!res.ok) throw new Error('HTTP '+res.status); const data=await res.json(); return {ok:true,text:data.text};
      }catch(e){ if(retries>0) return await callAI(prompt,{retries:retries-1,timeoutMs,signal}); return {ok:false,error:String(e)}; }
      finally{ clearTimeout(t); }
    }

    /* ============= Prompt Builder (Ù„ØºØ© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©) ============= */
    function buildPrompt(section, extra={}){
      const lang=state.lang; // <<< Ù…Ù‡Ù…: ÙŠØ­Ø¯Ø¯ Ù„ØºØ© Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª
      const P=state.profile, D=state.diet, Ls=state.lifestyle, F=state.fitness||{};
      state.targets = computeTargets(); const T=state.targets;
      const days_ar=['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'];
      const days_en=['Sat','Sun','Mon','Tue','Wed','Thu','Fri'];
      const days = (lang==='ar'?days_ar:days_en);
      const avail=Ls.availableDays.map(i=>days[i]).join(', ')||(lang==='ar'?'ØºÙŠØ± Ù…Ø­Ø¯Ø¯':'Not specified');
      const med=(state.medical.conditions||[]).join(', ')||'None';
      const tone=(state.challenges.motivation==='Direct')?(lang==='ar'?'Ø¹Ù…Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±':'Direct & pragmatic'):(lang==='ar'?'ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…':'Supportive & warm');

      const header = `
Name:${P.name} | Sex:${P.sex} | Age:${P.age} | H:${P.height}cm | W:${P.weight}kg | BF%:${P.bodyFat||'n/a'} | Waist:${P.waist||'n/a'}
Goals:${(D.goals||[]).join(', ')} | Preferred diet:${D.preferredDiet} | Meals/day:${D.mealsPerDay} | IF:${D.fasting}
Cuisine:${D.cuisine} | Prep time:${D.prepTime}min | Budget:${state.currency} ${D.monthlyBudget}
Activity:${Ls.workActivity} | Steps/day:${Ls.stepsPerDay} | Sleep:${Ls.sleep} | Stress:${Ls.stress}
Training place:${Ls.trainingPlace} | Session:${Ls.sessionLength}min | Available days:${avail} | RPE:${Ls.rpe} | Equipment:${Ls.equipment||'Bodyweight'}
Fitness test: HR ${F.restingHR||'?'} | Push-ups ${F.maxPushups||'?'} | Plank ${F.plank||'?'} | 1km ${F.kmTime||'?'}
Medical:${med} | Injuries:${Ls.injuries||'None'} | Allergies:${D.allergies||'None'} | Dislikes:${D.foodsToAvoid||'None'}
Targets: ~${T.tdee} kcal | P ${T.protein_g}g / F ${T.fat_g}g / C ${T.carb_g}g
Tone:${tone}
LANGUAGE:${lang}. EXERCISES in English.`.trim();

      if(section==='welcome') return `${header}\n\n${lang==='ar'
        ? 'Ø§ÙƒØªØ¨ ØªØ±Ø­ÙŠØ¨Ù‹Ø§ Ù‚ØµÙŠØ±Ù‹Ø§ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ„Ù…Ø­Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù† Ø§Ù„Ø®Ø·Ø©. Ù…Ù‡Ù†ÙŠ ÙˆÙ…Ø¨Ø§Ø´Ø±.'
        : 'Write a short welcome by name with a crisp preview of the plan. Professional and concise.'}`;
      if(section==='analysis') return `${header}\n\n${lang==='ar'?'Ø­Ù„Ù‘Ù„ Ø¨Ø¥ÙŠØ¬Ø§Ø² ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø¹Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø§ÙƒØ±ÙˆØ² Ø¨Ù†Ù‚Ø§Ø·.':'Concise bullet analysis of goals, constraints, and macro logic.'}`;
      if(section==='allowed') return `${header}\n\n${lang==='ar'?'Ù‚Ø§Ø¦Ù…ØªØ§Ù†: 1) Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù‚ØªØ±Ø­ 2) Ù…Ø§ ÙŠÙØ¶Ù‘Ù„ Ø§Ù„Ø­Ø¯ Ù…Ù†Ù‡/ØªØ¬Ù†Ø¨Ù‡.':'Two lists: 1) Allowed/Recommended 2) Limit/Avoid.'}`;
      if(section==='fasting') return `${header}\n\n${lang==='ar'?'Ø·Ø¨Ù‘Ù‚ Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹ Ø¨Ø£Ù…Ø§Ù† (Ø³ÙˆØ§Ø¦Ù„/ÙƒØ§ÙÙŠÙŠÙ†/ØªÙˆÙ‚ÙŠØª Ø§Ù„ØªÙ…Ø±ÙŠÙ†).':'How to implement IF safely (hydration/caffeine/training timing).'} (${D.fasting})`;
      if(section==='nutrition-day'){ const d=extra.day; return `${header}\n\n${lang==='ar'
        ? `Ø®Ø·Ø© Ø§Ù„ØªØºØ°ÙŠØ© Ù„ÙŠÙˆÙ… ${d} Ù…Ù† Ù§. Ø¬Ø¯ÙˆÙ„: Ø§Ù„ÙˆØ¬Ø¨Ø© | Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª (Ø¬Ø±Ø§Ù…) | kcal | Protein | Fat | Carbs. Ø£Ø®ØªÙ… Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠÙˆÙ…ÙŠ Ø¶Ù…Ù† Â±10% Ù…Ù† Ø§Ù„Ø£Ù‡Ø¯Ø§Ù. Ø¶Ø¹ [SWAP:MEAL:<name>].`
        : `Nutrition plan for Day ${d} of 7. Table rows: Meal | Ingredients (g) | kcal | Protein | Fat | Carbs. Close with daily totals within Â±10%. Tag [SWAP:MEAL:<name>].`}`; }
      if(section==='training-day'){ const d=extra.day; return `${header}\n\n${lang==='ar'
        ? `Ø®Ø·Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ù„ÙŠÙˆÙ… ${d} Ù…Ù† Ù§. Ø¬Ø¯ÙˆÙ„: Ø§Ù„ÙŠÙˆÙ… | Exercise | Sets | Reps | Rest(s). Ø±Ø§Ø¹Ù Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª ÙˆØ±ÙƒÙ‘Ø² Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù. Ø¶Ø¹ [SWAP:EXERCISE:<name>].`
        : `Training for Day ${d} of 7. Table: Day | Exercise | Sets | Reps | Rest(s). Respect injuries and focus weak muscles. Tag [SWAP:EXERCISE:<name>].`}`; }
      if(section==='supplements') return `${header}\n\n${lang==='ar'?'Ù…ÙƒÙ…Ù„Ø§Øª Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù„ÙŠÙ„: Ø£Ø³Ø§Ø³ÙŠ/Ù…ÙˆØ¬Ù‘Ù‡/Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ù…Ø¹ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª + ØªÙ†Ø¨ÙŠÙ‡ Ø·Ø¨ÙŠ.':'Evidence-based supplements: essential/goal-specific/budget with doses/timing + brief medical disclaimer.'}`;
      if(section==='progression') return `${header}\n\n${lang==='ar'?'Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø¯Ù‘Ù… 8â€“12 Ø£Ø³Ø¨ÙˆØ¹Ù‹Ø§: Ø²ÙŠØ§Ø¯Ø§ØªØŒ Ø¯Ù„ÙˆØ¯ØŒ ÙƒØ§Ø±Ø¯ÙŠÙˆØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· TDEE.':'8â€“12 week progression: load/reps/rest adjustments, deloads, cardio, TDEE retune.'}`;
      if(section==='troubleshoot') return `${header}\n\n${lang==='ar'?'Ø­Ù„ÙˆÙ„ Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø¬ÙˆØ¹/Ø§Ù„Ø«Ø¨Ø§Øª/Ø§Ù„Ù†ÙˆÙ…/Ø§Ù„Ø¶ØºØ·/Ø§Ù„Ø±ØºØ¨Ø§Øª/Ø§Ù„Ø³ÙØ± ÙˆØ§Ù„Ù…Ø·Ø§Ø¹Ù… (Ù¢â€“Ù£ Ù†Ù‚Ø§Ø· Ù„ÙƒÙ„ Ø¨Ù†Ø¯).':'Quick fixes for hunger/plateaus/sleep/stress/cravings/travel & eating out (2â€“3 bullets each).'}`
      if(section==='safety') return `${header}\n\n${lang==='ar'?'Ø³Ù„Ø§Ù…Ø©: ØªÙ‚Ù†ÙŠØ©ØŒ ÙˆÙ‚Ø§ÙŠØ© Ø¥ØµØ§Ø¨Ø§ØªØŒ ØªØ±ÙˆÙŠØ© ÙˆÙ†ÙˆÙ…ØŒ Ù…ØªÙ‰ Ù†ÙˆÙ‚Ù ÙˆÙ†Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨.':'Safety notes: technique, injury prevention, hydration/sleep, when to stop and seek care.'}`;
      if(section==='closing') return `${header}\n\n${lang==='ar'?'Ø®ØªØ§Ù… ØªØ­ÙÙŠØ²ÙŠ Ù‚ØµÙŠØ± Ù…ÙˆØ¬Ù‘Ù‡ Ø¨Ø§Ù„Ø§Ø³Ù… Ø¨Ù„Ø§ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ±Ø­ÙŠØ¨.':'Short motivating closing addressed by name, no repeated welcome.'}`;
      return header;
    }

    /* ============= Section Cards ============= */
    function addCard(key){
      const c=$('plan-content');
      const card=document.createElement('article');
      card.className='mb-4 rounded-xl';
      card.style.border='1px solid var(--field-border)'; card.style.background='var(--field-bg)';
      card.style.padding='1rem';
      const titles=TITLES[state.lang];
      const title = key.startsWith('nutrition-day') ? `${titles.nutrition} ${key.split('-').pop()}`
                 : key.startsWith('training-day') ? `${titles.training} ${key.split('-').pop()}`
                 : titles[key]||key;
      card.innerHTML=`<div class="flex items-center justify-between mb-2">
        <h2 class="text-base md:text-lg font-extrabold">${title}</h2>
        <span class="text-xs" style="color:var(--muted)" id="${key}-state">${state.lang==='ar'?'ÙŠÙÙˆÙ„ÙÙ‘Ø¯â€¦':'Generatingâ€¦'}</span>
      </div>
      <div id="${key}-body" class="text-sm md:text-[0.95rem] leading-6">
        <div class="animate-pulse"><div class="h-3 rounded" style="background:rgba(127,127,127,.15)"></div></div>
      </div>`;
      c.appendChild(card); $('plan-empty').style.display='none'; card.scrollIntoView({behavior:'smooth',block:'start'});
    }
    function fillCard(key, markdown, ok){
      const s=$(key+'-state'), b=$(key+'-body'); if(!s||!b) return;
      s.textContent = ok ? (state.lang==='ar'?'ØªÙ…':'Done') : (state.lang==='ar'?'ÙØ´Ù„':'Failed');
      b.innerHTML = ok ? renderMD(markdown) : `<div style="color:#ef4444">${state.lang==='ar'?'ØªØ¹Ø°Ù‘Ø± ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….':'Failed to generate this section.'}</div>`;
    }

    /* ============= Generate Streamed ============= */
    async function generatePlan(){
      readForm();
      if(!state.profile.name || !+state.profile.age || !+state.profile.height || !+state.profile.weight){
        alert(state.lang==='ar'?'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ø·ÙˆÙ„/Ø§Ù„ÙˆØ²Ù†.':'Please complete name/age/height/weight.'); return;
      }
      const sections = SECTION_ORDER(); buildTimeline(sections);
      $('generate').classList.add('hidden'); $('cancel').classList.remove('hidden');

      const cancel=new AbortController(); state.cancelCtrl=cancel;
      let done=0, total=sections.length;

      for(const k of sections){
        if(cancel.signal.aborted) break;
        setTimelineStatus(k,'run'); addCard(k);

        let sec=k, extra={}; if(k.startsWith('nutrition-day')){ sec='nutrition-day'; extra.day=+k.split('-').pop(); }
        if(k.startsWith('training-day')){ sec='training-day'; extra.day=+k.split('-').pop(); }

        const prompt=buildPrompt(sec,extra);
        const {ok,text}=await callAI(prompt,{retries:1,timeoutMs:45000,signal:cancel.signal});
        setTimelineStatus(k, ok?'ok':'fail'); fillCard(k,text,ok);

        done++; const pct=Math.round((done/total)*100); $('global-progress').style.width=pct+'%';
      }

      $('generate').classList.remove('hidden'); $('cancel').classList.add('hidden');
      state.cancelCtrl=null;
    }

    /* ============= Events ============= */
    $('generate').addEventListener('click', generatePlan);
    $('cancel').addEventListener('click', ()=>{ if(state.cancelCtrl) state.cancelCtrl.abort(); $('generate').classList.remove('hidden'); $('cancel').classList.add('hidden'); });
    $('scroll-top').onclick = ()=>window.scrollTo({top:0,behavior:'smooth'});
    $('btn-print').onclick = ()=>window.print();
    $('print-bottom').onclick = ()=>window.print();

    $('toggle-theme').onclick = ()=>{
      const light=!document.body.classList.contains('theme-light'); setTheme(light);
    };
    $('lang-ar').onclick = ()=>{ setLang('ar'); };
    $('lang-en').onclick = ()=>{ setLang('en'); };

    /* ============= Utils ============= */
    function detectCurrency(){
      try{
        const u=(Intl.DateTimeFormat().resolvedOptions().locale||navigator.language||'en-US').toUpperCase();
        if(u.includes('AE')) return 'AED'; if(u.includes('SA')) return 'SAR'; if(u.includes('EG')) return 'EGP';
        if(u.includes('QA')) return 'QAR'; if(u.includes('KW')) return 'KWD'; if(u.includes('GB')) return 'GBP';
        if(u.includes('DE')||u.includes('FR')||u.includes('IT')||u.includes('ES')||u.includes('EU')) return 'EUR';
        return 'USD';
      }catch{ return 'USD'; }
    }

    /* init */
    window.addEventListener('load', ()=>{
      setTheme(false);           // Ø¯Ø§ÙƒÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠ
      setLang(state.lang);       // Ù„ØºØ© Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØµÙØ­
      $('currency').value=state.currency;
    });
  </script>
</body>
</html>
