<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>ุงููุณุชุดุงุฑ ุงูุตุญู ุงูุฐูู | Intelligent Health Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --brand:#4f46e5; --ok:#10b981; --warn:#f59e0b; }
    html,body{height:100%}
    body{background:linear-gradient(180deg,#f6f7fb,#eef1f7)}
    .card{background:#fff}
    .title{letter-spacing:.2px}
    .ai h2{font-weight:800;margin-top:1.2rem;font-size:1.15rem}
    .ai h3{font-weight:700;margin-top:.9rem}
    .ai table{width:100%;border-collapse:collapse;margin:10px 0;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden}
    .ai th,.ai td{border:1px solid #e5e7eb;padding:.6rem;vertical-align:top}
    .ai th{background:#f9fafb}
    .overlay{backdrop-filter: blur(6px)}
    .step-dot{width:26px;height:26px}
    @media print{
      #toolbar,#wizard,#actions,.no-print{display:none !important}
      body{background:#fff}
      #plan{box-shadow:none;border:none}
    }
  </style>
</head>
<body class="min-h-screen text-slate-800">

<!-- Top bar -->
<header id="toolbar" class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-indigo-600 text-white grid place-items-center font-black">AI</div>
      <div>
        <div id="brandTitle" class="title font-extrabold">ุงููุณุชุดุงุฑ ุงูุตุญู ุงูุฐูู</div>
        <div id="brandSub" class="text-xs text-slate-500">ุฎุทุฉ ุฏูููุฉ 100% ููุชุบุฐูุฉ ูุงูุชุฏุฑูุจ ูุงูููููุงุช โ ูุฎุตุตุฉ ูู</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnAr" class="px-3 py-1.5 rounded-md text-sm font-bold bg-indigo-600 text-white">ุนุฑุจู</button>
      <button id="btnEn" class="px-3 py-1.5 rounded-md text-sm font-bold bg-slate-100">EN</button>
      <button id="btnTheme" class="px-3 py-1.5 rounded-md border">โ๏ธ/๐</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 pb-24">

  <!-- Intro -->
  <section class="mt-6 card rounded-2xl shadow border p-5">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 id="heroTitle" class="title text-2xl sm:text-3xl font-black text-slate-900">ููููุดุฆ ุฃูุถู ุฎุทุฉ ููุญููุฉ ููุฏูู</h1>
        <p id="heroSub" class="mt-1 text-sm text-slate-500">
          ุณูุชู ุชูููุฏ ุงูุฎุทุฉ ูุณููุง ุจุนุฏ ูุณู: ุชุฑุญูุจ โ ุชุญููู โ ุงููุณููุญ/ุงูููููุน โ ุงูุตูุงู (ุฅู ูุฒู) โ ุงูุชุบุฐูุฉ 7 ุฃูุงู โ ุงูุชุฏุฑูุจ 7 ุฃูุงู โ ุงูููููุงุช โ ุงูุชูุฏูู โ ุงูุญููู โ ุงูุณูุงูุฉ โ ุงูุฎุงุชูุฉ.
        </p>
        <div id="readyState" class="mt-2 text-xs text-slate-400">ุฌุงูุฒ</div>
      </div>
      <button id="startTop" class="hidden sm:block px-4 h-10 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold">
        ุงุจุฏุฃ ุงูุชูููุฏ
      </button>
    </div>
  </section>

  <!-- Wizard -->
  <section id="wizard" class="mt-6 grid lg:grid-cols-3 gap-5">
    <!-- Profile -->
    <div id="sec1" class="card rounded-2xl shadow border p-5">
      <h2 class="title text-lg font-extrabold mb-4 flex items-center gap-2">
        <span class="w-1.5 h-5 rounded bg-indigo-600"></span><span id="hProfile">ุงูููู ุงูุดุฎุตู</span>
      </h2>
      <div class="grid grid-cols-2 gap-3">
        <label class="col-span-2">
          <span id="lblName" class="text-sm font-medium">ุงูุงุณู</span>
          <input id="name" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblAge" class="text-sm font-medium">ุงูุนูุฑ</span>
          <input id="age" type="number" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblHeight" class="text-sm font-medium">ุงูุทูู (ุณู)</span>
          <input id="height" type="number" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblWeight" class="text-sm font-medium">ุงููุฒู (ูุบ)</span>
          <input id="weight" type="number" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblBodyfat" class="text-sm font-medium">% ูุณุจุฉ ุงูุฏููู (ุงุฎุชูุงุฑู)</span>
          <input id="bodyfat" type="number" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblWaist" class="text-sm font-medium">ูุญูุท ุงูุฎุตุฑ (ุณู) (ุงุฎุชูุงุฑู)</span>
          <input id="waist" type="number" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblSex" class="text-sm font-medium">ุงูุฌูุณ</span>
          <select id="sex" class="mt-1 w-full rounded-md border p-2">
            <option value="Male">ุฐูุฑ</option><option value="Female">ุฃูุซู</option>
          </select>
        </label>
        <label>
          <span id="lblTargetW" class="text-sm font-medium">ุงููุฒู ุงููุณุชูุฏู (ูุบ) (ุงุฎุชูุงุฑู)</span>
          <input id="targetWeight" type="number" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblTargetD" class="text-sm font-medium">ุชุงุฑูุฎ ุชุญููู ุงููุฏู (ุงุฎุชูุงุฑู)</span>
          <input id="targetDate" type="date" class="mt-1 w-full rounded-md border p-2"/>
        </label>
      </div>
    </div>

    <!-- Diet & Prefs -->
    <div id="sec2" class="card rounded-2xl shadow border p-5">
      <h2 class="title text-lg font-extrabold mb-4 flex items-center gap-2">
        <span class="w-1.5 h-5 rounded bg-indigo-600"></span><span id="hDiet">ุงููุธุงู ุงูุบุฐุงุฆู ูุงูุชูุถููุงุช</span>
      </h2>

      <fieldset class="mb-3">
        <legend id="lblGoals" class="text-sm font-medium">ุงูุฃูุฏุงู (ูุชุนุฏุฏ)</legend>
        <div class="grid grid-cols-2 gap-2 mt-1">
          <label class="flex items-center gap-2"><input class="goal" type="checkbox" value="Fat Loss"><span id="g1">ุฎุณุงุฑุฉ ุงูุฏููู</span></label>
          <label class="flex items-center gap-2"><input class="goal" type="checkbox" value="Build Muscle"><span id="g2">ุจูุงุก ุงูุนุถูุงุช</span></label>
          <label class="flex items-center gap-2"><input class="goal" type="checkbox" value="Strength"><span id="g3">ุฒูุงุฏุฉ ุงูููุฉ</span></label>
          <label class="flex items-center gap-2"><input class="goal" type="checkbox" value="Endurance"><span id="g4">ุชุญุณูู ุงูุชุญูู</span></label>
          <label class="flex items-center gap-2"><input class="goal" type="checkbox" value="General Health"><span id="g5">ุตุญุฉ ุนุงูุฉ</span></label>
        </div>
      </fieldset>

      <div class="grid grid-cols-2 gap-3">
        <label>
          <span id="lblMeals" class="text-sm font-medium">ุนุฏุฏ ุงููุฌุจุงุช/ุงูููู</span>
          <input id="meals" type="number" value="3" min="2" max="7" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblDietType" class="text-sm font-medium">ุงููุธุงู ุงูููุถู</span>
          <select id="dietType" class="mt-1 w-full rounded-md border p-2">
            <option>Balanced</option><option>Low carb</option><option>Mediterranean</option><option>Keto</option><option>Plant-based</option>
          </select>
        </label>

        <label>
          <span id="lblFasting" class="text-sm font-medium">ุงูุตูุงู ุงููุชูุทุน</span>
          <select id="fasting" class="mt-1 w-full rounded-md border p-2">
            <option value="None">ุบูุฑ ูููุนู</option><option>16:8</option><option>18:6</option><option>20:4</option>
          </select>
        </label>
        <label>
          <span id="lblCuisine" class="text-sm font-medium">ุงููุทุจุฎ ุงูููุถู</span>
          <select id="cuisine" class="mt-1 w-full rounded-md border p-2">
            <option>Arabic/Mediterr.</option><option>Asian</option><option>Western</option><option>Indian</option>
          </select>
        </label>

        <label>
          <span id="lblPrep" class="text-sm font-medium">ุฒูู ุงูุชุญุถูุฑ (ุฏ)</span>
          <input id="prep" type="number" value="20" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblBudget" class="text-sm font-medium">ููุฒุงููุฉ ุดูุฑูุฉ ุชูุฑูุจูุฉ</span>
          <div class="relative">
            <input id="budget" type="number" value="0" class="mt-1 w-full rounded-md border p-2 pr-12"/>
            <span id="currency" class="absolute right-3 top-2.5 text-slate-500">USD</span>
          </div>
          <small id="budgetHelp" class="text-xs text-slate-400">ุณูุญุงูู ุงูุงูุชุฒุงู ุจุงูููุฒุงููุฉ ูุฏุฑ ุงูุฅููุงู.</small>
        </label>

        <label class="col-span-2">
          <span id="lblAvoid" class="text-sm font-medium">ุฃุทุนูุฉ ูุง ุชุฑุบุจ ุจูุง/ุญุณุงุณูุงุช</span>
          <input id="avoid" class="mt-1 w-full rounded-md border p-2" placeholder="Gluten, lactose, seafoodโฆ"/>
        </label>
      </div>

      <!-- Muscles focus -->
      <div class="mt-4">
        <h3 id="musclesTitle" class="font-bold mb-2">ุนุถูุงุช ุชุญุชุงุฌ ุนูุงูุฉ ุฎุงุตุฉ</h3>
        <div id="musclesWrap" class="grid md:grid-cols-2 gap-3"></div>
      </div>

      <!-- Challenges & Motivation -->
      <div class="mt-4">
        <h3 id="hChallenges" class="font-bold mb-2">ุชุญุฏูุงุช ุณุงุจูุฉ ูุน ุงูุฃูุธูุฉ</h3>
        <textarea id="pastChallenges" rows="2" class="w-full rounded-md border p-2" placeholder="ุฌูุน ุดุฏูุฏุ ููู ูู ุงูุทุนุงูุ ุฅุตุงุจุงุช ุนูุฏ ุงูุชูุฑููโฆ"></textarea>
      </div>
      <div class="mt-3">
        <h3 id="hMotivation" class="font-bold mb-2">ุฃุณููุจ ุงูุชุญููุฒ ุงูููุถู</h3>
        <select id="motivation" class="w-full rounded-md border p-2">
          <option value="Direct and firm">ุญุงุฒู ููุจุงุดุฑ</option>
          <option value="Positive and supportive">ุชุดุฌูุนู ูุฏุงุนู</option>
          <option value="Minimal check-ins">ูุชุงุจุนุฉ ุฎูููุฉ</option>
        </select>
      </div>
    </div>

    <!-- Lifestyle & Medical -->
    <div id="sec3" class="card rounded-2xl shadow border p-5">
      <h2 class="title text-lg font-extrabold mb-4 flex items-center gap-2">
        <span class="w-1.5 h-5 rounded bg-indigo-600"></span><span id="hLifestyle">ููุท ุงูุญูุงุฉ ูุงูุชุฏุฑูุจ</span>
      </h2>

      <div class="grid grid-cols-2 gap-3">
        <label>
          <span id="lblWork" class="text-sm font-medium">ุงูุนูู/ุงููุดุงุท</span>
          <select id="work" class="mt-1 w-full rounded-md border p-2">
            <option value="Sedentary">ููุชุจู</option><option value="Light">ูุดุงุท ุฎููู</option>
            <option value="Moderate">ูุดุงุท ูุชูุณุท</option><option value="Heavy">ูุดุงุท ุจุฏูู ุซููู</option>
          </select>
        </label>
        <label>
          <span id="lblSteps" class="text-sm font-medium">ุฎุทูุงุช/ุงูููู</span>
          <input id="steps" type="number" value="6000" class="mt-1 w-full rounded-md border p-2"/>
        </label>

        <label>
          <span id="lblSleep" class="text-sm font-medium">ุงูููู (ุณ)</span>
          <select id="sleep" class="mt-1 w-full rounded-md border p-2">
            <option value="Low">ููุฎูุถ</option><option value="Moderate">ูุชูุณุท</option><option value="High">ุฌูุฏ</option>
          </select>
        </label>
        <label>
          <span id="lblStress" class="text-sm font-medium">ุงูุชูุชุฑ</span>
          <select id="stress" class="mt-1 w-full rounded-md border p-2">
            <option value="Low">ููุฎูุถ</option><option value="Moderate">ูุชูุณุท</option><option value="High">ูุฑุชูุน</option>
          </select>
        </label>

        <label>
          <span id="lblPlace" class="text-sm font-medium">ููุงู ุงูุชุฏุฑูุจ</span>
          <select id="place" class="mt-1 w-full rounded-md border p-2">
            <option>Gym</option><option>Home</option><option>Outdoor</option>
          </select>
        </label>
        <label>
          <span id="lblSession" class="text-sm font-medium">ูุฏุฉ ุงูุฌูุณุฉ (ุฏ)</span>
          <input id="session" type="number" value="60" class="mt-1 w-full rounded-md border p-2"/>
        </label>

        <!-- Fitness test -->
        <fieldset class="col-span-2">
          <legend id="hFit" class="text-sm font-bold mb-1">ุงุฎุชุจุงุฑ ุงูููุงูุฉ ุงููุจุณุท</legend>
          <div class="grid grid-cols-2 gap-3">
            <label><span id="lblRHR" class="text-sm font-medium">Resting HR (bpm)</span><input id="rhr" type="number" class="mt-1 w-full rounded-md border p-2"/></label>
            <label><span id="lblPush" class="text-sm font-medium">Push-ups (max)</span><input id="pushups" type="number" class="mt-1 w-full rounded-md border p-2"/></label>
            <label><span id="lblPlank" class="text-sm font-medium">Plank (s)</span><input id="plank" type="number" class="mt-1 w-full rounded-md border p-2"/></label>
            <label><span id="lblKm" class="text-sm font-medium">1 ูู (ุฏ:ุซ)</span><input id="kmTime" class="mt-1 w-full rounded-md border p-2" placeholder="6:30"/></label>
          </div>
        </fieldset>

        <!-- Days -->
        <fieldset class="col-span-2">
          <legend id="lblDays" class="text-sm font-medium mb-1">ุฃูุงู ุงูุชุฏุฑูุจ ุงููุชุงุญุฉ</legend>
          <div id="days" class="flex flex-wrap gap-3"></div>
        </fieldset>

        <label class="col-span-2"><span id="lblEq" class="text-sm font-medium">ุงููุนุฏุงุช ุงููุชุงุญุฉ</span><input id="equipment" class="mt-1 w-full rounded-md border p-2" placeholder="ุฏูุจูุ ุจุงุฑุ ุฃุฌูุฒุฉโฆ"/></label>

        <label><span id="lblExp" class="text-sm font-medium">ุงูุฎุจุฑุฉ</span>
          <select id="experience" class="mt-1 w-full rounded-md border p-2">
            <option>Beginner (0-6m)</option><option>Intermediate (6-24m)</option><option>Advanced (24m+)</option>
          </select>
        </label>
        <label><span id="lblRPE" class="text-sm font-medium">RPE</span><input id="rpe" type="number" value="8" class="mt-1 w-full rounded-md border p-2"/></label>
        <label><span id="lblCaf" class="text-sm font-medium">ูุงูููู/ููู (ุฃููุงุจ)</span><input id="caffeine" type="number" class="mt-1 w-full rounded-md border p-2"/></label>
        <label><span id="lblInj" class="text-sm font-medium">ุฅุตุงุจุงุช/ูููุฏ</span><input id="injuries" class="mt-1 w-full rounded-md border p-2"/></label>
      </div>

      <!-- Medical -->
      <div class="mt-5">
        <h2 id="hMedical" class="title text-lg font-extrabold mb-3 flex items-center gap-2">
          <span class="w-1.5 h-5 rounded bg-indigo-600"></span><span>ุงูุญุงูุฉ ุงูุตุญูุฉ</span>
        </h2>
        <div id="medicalWrap" class="grid md:grid-cols-2 gap-2"></div>
        <label class="block mt-2"><span id="lblOther" class="text-sm font-medium">ุฃูุฑุงุถ/ุญุงูุงุช ุฃุฎุฑู</span><input id="otherCond" class="mt-1 w-full rounded-md border p-2"/></label>
        <label class="block mt-2"><span id="lblMeds" class="text-sm font-medium">ุฃุฏููุฉ ุญุงููุฉ</span><input id="meds" class="mt-1 w-full rounded-md border p-2"/></label>
        <label class="block mt-2"><span id="lblSupp" class="text-sm font-medium">ููููุงุช ุญุงููุฉ</span><input id="supps" class="mt-1 w-full rounded-md border p-2"/></label>
      </div>
    </div>
  </section>

  <!-- Actions -->
  <section id="actions" class="mt-4 flex flex-wrap gap-3 justify-between items-center">
    <div id="genHint" class="text-xs text-slate-500">
      ุนูุฏ ุงูุถุบุท ุนูู ยซุชูููุฏ ุงูุฎุทุฉยปุ ุณูููุดุฆ ุงูุฃูุณุงู ุจุงูุชุฑุชูุจ. ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑ ุญุชู ููุชูู ุงูุชูููุฏ ุจุงููุงูู.
    </div>
    <div class="flex gap-2 w-full sm:w-auto">
      <button id="btnGenerate" class="flex-1 sm:flex-none bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold px-5 py-2 rounded-lg">ุชูููุฏ ุงูุฎุทุฉ</button>
      <button id="btnPrint" class="px-4 py-2 rounded-lg border">ุทุจุงุนุฉ</button>
    </div>
  </section>

  <!-- Plan result -->
  <section id="plan" class="mt-6 card rounded-2xl shadow border p-5 ai"></section>
</main>

<!-- Overlay -->
<div id="overlay" class="hidden fixed inset-0 z-30 grid place-items-center bg-black/30 overlay">
  <div class="bg-white/95 rounded-2xl p-6 w-[min(92vw,520px)] text-center shadow-xl border">
    <div class="mx-auto w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
    <h3 id="ovTitle" class="mt-4 font-extrabold">ูุฌููุฒ ุฎุทุชู ุงูุขู</h3>
    <p id="ovMsg" class="text-sm text-slate-600 mt-1">ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑุ ุณููููุฏ ุงูุฎุทุฉ ูุณููุง ุจุนุฏ ูุณูโฆ</p>
    <div class="mt-3 text-xs text-slate-500" id="progressTxt">0%</div>
  </div>
</div>

<script>
/* ---------- Utilities ---------- */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const i18n={
  ar:{dir:'rtl',brand:'ุงููุณุชุดุงุฑ ุงูุตุญู ุงูุฐูู',brandSub:'ุฎุทุฉ ุฏูููุฉ 100% ููุชุบุฐูุฉ ูุงูุชุฏุฑูุจ ูุงูููููุงุช โ ูุฎุตุตุฉ ูู',
      start:'ุงุจุฏุฃ ุงูุชูููุฏ', gen:'ุชูููุฏ ุงูุฎุทุฉ', print:'ุทุจุงุนุฉ', ready:'ุฌุงูุฒ',
      hero:'ููููุดุฆ ุฃูุถู ุฎุทุฉ ููุญููุฉ ููุฏูู',
      hint:'ุณูุชู ุชูููุฏ ุงูุฎุทุฉ ูุณููุง ุจุนุฏ ูุณู: ุชุฑุญูุจ โ ุชุญููู โ ุงููุณููุญ/ุงูููููุน โ ุงูุตูุงู (ุฅู ูุฒู) โ ุงูุชุบุฐูุฉ 7 ุฃูุงู โ ุงูุชุฏุฑูุจ 7 ุฃูุงู โ ุงูููููุงุช โ ุงูุชูุฏูู โ ุงูุญููู โ ุงูุณูุงูุฉ โ ุงูุฎุงุชูุฉ.',
      overlayTitle:'ูุฌููุฒ ุฎุทุชู ุงูุขู', overlayMsg:'ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑุ ุณููููุฏ ุงูุฎุทุฉ ูุณููุง ุจุนุฏ ูุณูโฆ',
      profile:'ุงูููู ุงูุดุฎุตู', diet:'ุงููุธุงู ุงูุบุฐุงุฆู ูุงูุชูุถููุงุช', lifestyle:'ููุท ุงูุญูุงุฉ ูุงูุชุฏุฑูุจ',
      labels:{
        name:'ุงูุงุณู',age:'ุงูุนูุฑ',height:'ุงูุทูู (ุณู)',weight:'ุงููุฒู (ูุบ)',bodyfat:'% ูุณุจุฉ ุงูุฏููู (ุงุฎุชูุงุฑู)',waist:'ูุญูุท ุงูุฎุตุฑ (ุณู) (ุงุฎุชูุงุฑู)',sex:'ุงูุฌูุณ',
        targetW:'ุงููุฒู ุงููุณุชูุฏู (ูุบ) (ุงุฎุชูุงุฑู)',targetD:'ุชุงุฑูุฎ ุชุญููู ุงููุฏู (ุงุฎุชูุงุฑู)',
        goals:'ุงูุฃูุฏุงู (ูุชุนุฏุฏ)',meals:'ุนุฏุฏ ุงููุฌุจุงุช/ุงูููู',dietType:'ุงููุธุงู ุงูููุถู',fasting:'ุงูุตูุงู ุงููุชูุทุน',cuisine:'ุงููุทุจุฎ ุงูููุถู',prep:'ุฒูู ุงูุชุญุถูุฑ (ุฏ)',budget:'ููุฒุงููุฉ ุดูุฑูุฉ ุชูุฑูุจูุฉ',avoid:'ุฃุทุนูุฉ ูุง ุชุฑุบุจ ุจูุง/ุญุณุงุณูุงุช',
        muscles:'ุนุถูุงุช ุชุญุชุงุฌ ุนูุงูุฉ ุฎุงุตุฉ',issue:'ูุตู ุงููุดููุฉ/ุงูุณุจุจ',challenges:'ุชุญุฏูุงุช ุณุงุจูุฉ ูุน ุงูุฃูุธูุฉ',motivation:'ุฃุณููุจ ุงูุชุญููุฒ ุงูููุถู',
        work:'ุงูุนูู/ุงููุดุงุท',steps:'ุฎุทูุงุช/ุงูููู',sleep:'ุงูููู (ุณ)',stress:'ุงูุชูุชุฑ',place:'ููุงู ุงูุชุฏุฑูุจ',session:'ูุฏุฉ ุงูุฌูุณุฉ (ุฏ)',
        fit:'ุงุฎุชุจุงุฑ ุงูููุงูุฉ ุงููุจุณุท',rhr:'Resting HR (bpm)',push:'Push-ups (max)',plank:'Plank (s)',km:'1 ูู (ุฏ:ุซ)',
        days:'ุฃูุงู ุงูุชุฏุฑูุจ ุงููุชุงุญุฉ',equip:'ุงููุนุฏุงุช ุงููุชุงุญุฉ',exp:'ุงูุฎุจุฑุฉ',rpe:'RPE',caffeine:'ูุงูููู/ููู (ุฃููุงุจ)',inj:'ุฅุตุงุจุงุช/ูููุฏ',
        medical:'ุงูุญุงูุฉ ุงูุตุญูุฉ',other:'ุฃูุฑุงุถ/ุญุงูุงุช ุฃุฎุฑู',meds:'ุฃุฏููุฉ ุญุงููุฉ',supps:'ููููุงุช ุญุงููุฉ'
      },
      musclesList:['ุงูุตุฏุฑ','ุงูุธูุฑ','ุงูุฃูุชุงู','ุงูุจุงูุณุจุณ','ุงูุชุฑุงูุณุจุณ','ุงูุฃุฑุฌู ุงูุฃูุงููุฉ','ุงูุฃุฑุฌู ุงูุฎูููุฉ','ุงููุคุฎุฑุฉ','ุงูุณูุงูุฉ','ุงูุจุทู'],
      medicalList:['ุถุบุท ุงูุฏู','ุงูุณูุฑู','ููุงููุฉ ุงูุฃูุณูููู','ูุดุงูู ุงูุบุฏุฉ','ุงููุจุฏ ุงูุฏููู','ูุดุงูู ุงูููุงุตู/ุงูุฑูุจุฉ','ุฃูุฑุงุถ ุงูููุจ','ูุฑุญุฉ/ููููู','ุงุฑุชุฌุงุน/ุญุฑูุฉ','ุญุณุงุณูุฉ ุงูุฌููุชูู','ุนุฏู ุชุญูู ุงููุงูุชูุฒ'],
      days:['ุงูุณุจุช','ุงูุฃุญุฏ','ุงูุฅุซููู','ุงูุซูุงุซุงุก','ุงูุฃุฑุจุนุงุก','ุงูุฎููุณ','ุงูุฌูุนุฉ'],
      reqError:'ุฃููู ุงูุญููู ุงูุฃุณุงุณูุฉ: ุงูุงุณู/ุงูุนูุฑ/ุงูุทูู/ุงููุฒู.'
  },
  en:{dir:'ltr',brand:'Intelligent Health Coach',brandSub:'100% precise plan for nutrition, training and supplements โ fully personalized',
      start:'Generate Plan', gen:'Generate Plan', print:'Print', ready:'Ready',
      hero:'Letโs build the best, precise plan for your goal',
      hint:'We will generate: Welcome โ Analysis โ Allowed/Limits โ Intermittent Fasting (if any) โ Nutrition 7 days โ Training 7 days โ Supplements โ Progress โ Troubleshooting โ Safety โ Closing.',
      overlayTitle:'Preparing your plan', overlayMsg:'Please wait while we generate the plan section-by-sectionโฆ',
      profile:'Profile', diet:'Diet & Preferences', lifestyle:'Lifestyle & Training',
      labels:{
        name:'Name',age:'Age',height:'Height (cm)',weight:'Weight (kg)',bodyfat:'Body fat % (optional)',waist:'Waist (cm) (optional)',sex:'Sex',
        targetW:'Target weight (kg) (optional)',targetD:'Target date (optional)',
        goals:'Goals (multi-select)',meals:'Meals per day',dietType:'Preferred diet',fasting:'Intermittent fasting',cuisine:'Cuisine',prep:'Prep time (min)',budget:'Monthly budget',avoid:'Foods to avoid / allergies',
        muscles:'Muscles needing special focus',issue:'Describe the issue/reason',challenges:'Past challenges with plans',motivation:'Preferred motivation style',
        work:'Work/activity',steps:'Steps/day',sleep:'Sleep (hr)',stress:'Stress',place:'Training place',session:'Session length (min)',
        fit:'Quick fitness test',rhr:'Resting HR (bpm)',push:'Max push-ups',plank:'Plank (s)',km:'1 km time (m:s)',
        days:'Available training days',equip:'Available equipment',exp:'Experience',rpe:'RPE',caffeine:'Caffeine/day (cups)',inj:'Injuries/constraints',
        medical:'Medical status',other:'Other conditions',meds:'Current medications',supps:'Current supplements'
      },
      musclesList:['Chest','Back','Shoulders','Biceps','Triceps','Quads','Hamstrings','Glutes','Calves','Abs'],
      medicalList:['Hypertension','Diabetes','Insulin Resistance','Thyroid issues','Fatty Liver','Joint/Knee problems','Heart disease','IBD/Ulcer','GERD/Reflux','Gluten intolerance','Lactose intolerance'],
      days:['Sat','Sun','Mon','Tue','Wed','Thu','Fri'],
      reqError:'Complete required fields: name/age/height/weight.'
  }
};

let LANG='ar';
function setLang(l){
  LANG=l;
  const L=i18n[l];
  document.documentElement.lang=l;
  document.documentElement.dir=L.dir;

  // headings / hints
  $('#brandTitle').textContent=L.brand;
  $('#brandSub').textContent=L.brandSub;
  $('#heroTitle').textContent=L.hero;
  $('#heroSub').textContent=L.hint;
  $('#readyState').textContent=L.ready;
  $('#ovTitle').textContent=L.overlayTitle;
  $('#ovMsg').textContent=L.overlayMsg;
  $('#genHint').textContent=L.hint;
  $('#btnGenerate').textContent=L.gen;
  $('#btnPrint').textContent=L.print;
  $('#btnAr').className = 'px-3 py-1.5 rounded-md text-sm font-bold ' + (l==='ar'?'bg-indigo-600 text-white':'bg-slate-100');
  $('#btnEn').className = 'px-3 py-1.5 rounded-md text-sm font-bold ' + (l==='en'?'bg-indigo-600 text-white':'bg-slate-100');

  // section titles
  $('#hProfile').textContent=L.profile;
  $('#hDiet').textContent=L.diet;
  $('#hLifestyle').textContent=L.lifestyle;
  $('#hMedical').querySelector('span').textContent=L.labels.medical;

  // labels
  const t=L.labels;
  $('#lblName').textContent=t.name; $('#lblAge').textContent=t.age; $('#lblHeight').textContent=t.height; $('#lblWeight').textContent=t.weight;
  $('#lblBodyfat').textContent=t.bodyfat; $('#lblWaist').textContent=t.waist; $('#lblSex').textContent=t.sex;
  $('#lblTargetW').textContent=t.targetW; $('#lblTargetD').textContent=t.targetD;
  $('#lblGoals').textContent=t.goals; $('#lblMeals').textContent=t.meals; $('#lblDietType').textContent=t.dietType; $('#lblFasting').textContent=t.fasting;
  $('#lblCuisine').textContent=t.cuisine; $('#lblPrep').textContent=t.prep; $('#lblBudget').textContent=t.budget; $('#lblAvoid').textContent=t.avoid;
  $('#musclesTitle').textContent=t.muscles; $('#hChallenges').textContent=t.challenges; $('#hMotivation').textContent=t.motivation;
  $('#lblWork').textContent=t.work; $('#lblSteps').textContent=t.steps; $('#lblSleep').textContent=t.sleep; $('#lblStress').textContent=t.stress;
  $('#lblPlace').textContent=t.place; $('#lblSession').textContent=t.session;
  $('#hFit').textContent=t.fit; $('#lblRHR').textContent=t.rhr; $('#lblPush').textContent=t.push; $('#lblPlank').textContent=t.plank; $('#lblKm').textContent=t.km;
  $('#lblDays').textContent=t.days; $('#lblEq').textContent=t.equip; $('#lblExp').textContent=t.exp; $('#lblRPE').textContent=t.rpe; $('#lblCaf').textContent=t.caffeine; $('#lblInj').textContent=t.inj;
  $('#lblOther').textContent=t.other; $('#lblMeds').textContent=t.meds; $('#lblSupp').textContent=t.supps;

  // rebuild dynamic checklists
  buildMuscles();
  buildMedical();
  buildDays();

  // column visual order for RTL/LTR (ุจุฏูู ููู DOM)
  const rtl = l==='ar';
  $('#wizard').classList.toggle('rtl', rtl);
}

function buildMuscles(){
  const wrap = $('#musclesWrap'); wrap.innerHTML='';
  i18n[LANG].musclesList.forEach((m,idx)=>{
    const id='m_'+idx;
    wrap.insertAdjacentHTML('beforeend',`
      <div class="border rounded-md p-2">
        <label class="flex items-center gap-2">
          <input id="${id}" class="mchk" type="checkbox" value="${m}"><span>${m}</span>
        </label>
        <input id="${id}_d" class="mt-2 w-full rounded-md border p-2" placeholder="${i18n[LANG].labels.issue}"/>
      </div>`);
  });
}

function buildMedical(){
  const wrap = $('#medicalWrap'); wrap.innerHTML='';
  i18n[LANG].medicalList.forEach((c,idx)=>{
    wrap.insertAdjacentHTML('beforeend',`
      <label class="flex items-center gap-2">
        <input class="cchk" type="checkbox" value="${c}"><span>${c}</span>
      </label>`);
  });
}

function buildDays(){
  const wrap=$('#days'); wrap.innerHTML='';
  const keys=['Sat','Sun','Mon','Tue','Wed','Thu','Fri'];
  i18n[LANG].days.forEach((d,i)=>{
    wrap.insertAdjacentHTML('beforeend',`
      <label class="flex items-center gap-2">
        <input class="day" type="checkbox" value="${keys[i]}"><span>${d}</span>
      </label>`);
  });
}

function detectCurrency(){
  try{
    const loc = Intl.DateTimeFormat().resolvedOptions().locale || 'en-US';
    const map={'ar-SA':'SAR','ar-AE':'AED','ar-EG':'EGP','en-US':'USD','en-GB':'GBP','ar-KW':'KWD','ar-QA':'QAR','ar-OM':'OMR','ar-BH':'BHD','ar-JO':'JOD','ar-IQ':'IQD','ar-MA':'MAD','ar-DZ':'DZD','fr-FR':'EUR','de-DE':'EUR'};
    $('#currency').textContent = map[loc] || 'USD';
  }catch{ $('#currency').textContent='USD'; }
}

/* ---------- Collect + Validate ---------- */
function collect(){
  const goals=[...$$('.goal:checked')].map(e=>e.value);
  const muscles=[...$$('.mchk:checked')].map(e=>{
    const d=$(`#${e.id}_d`).value.trim(); return d?`${e.value}: ${d}`:e.value;
  });
  const medical=[...$$('.cchk:checked')].map(e=>e.value);
  const days=[...$$('.day:checked')].map(e=>e.value);

  const u={
    name:$('#name').value.trim(), age:$('#age').value, height:$('#height').value, weight:$('#weight').value,
    bodyfat:$('#bodyfat').value, waist:$('#waist').value, sex:$('#sex').value,
    targetWeight:$('#targetWeight').value, targetDate:$('#targetDate').value,
    goals, meals:$('#meals').value, dietType:$('#dietType').value, fasting:$('#fasting').value, cuisine:$('#cuisine').value,
    prep:$('#prep').value, budget:$('#budget').value, currency:$('#currency').textContent, avoid:$('#avoid').value,
    muscles, pastChallenges:$('#pastChallenges').value, motivation:$('#motivation').value,
    work:$('#work').value, steps:$('#steps').value, sleep:$('#sleep').value, stress:$('#stress').value,
    place:$('#place').value, session:$('#session').value,
    rhr:$('#rhr').value, pushups:$('#pushups').value, plank:$('#plank').value, kmTime:$('#kmTime').value,
    days, equipment:$('#equipment').value, experience:$('#experience').value, rpe:$('#rpe').value, caffeine:$('#caffeine').value, injuries:$('#injuries').value,
    medical, otherCond:$('#otherCond').value, meds:$('#meds').value, supps:$('#supps').value
  };
  if(!u.name || !u.age || !u.height || !u.weight){
    toast(i18n[LANG].reqError); return null;
  }
  return u;
}

function toast(msg){
  const t=document.createElement('div');
  t.className='fixed bottom-4 left-1/2 -translate-x-1/2 bg-black/85 text-white px-4 py-2 rounded-lg text-sm z-40';
  t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),2500);
}

/* ---------- Calculations ---------- */
function computeTargets(u){
  const W=Number(u.weight)||0, H=Number(u.height)||0, A=Number(u.age)||0;
  const male=u.sex==='Male';
  const BMR = male? 10*W+6.25*H-5*A+5 : 10*W+6.25*H-5*A-161;
  const factor = u.work==='Sedentary'?1.2 : u.work==='Light'?1.35 : u.work==='Moderate'?1.5 : 1.7;
  let TDEE=BMR*factor;
  if(u.goals.includes('Fat Loss')) TDEE*=0.85; else if(u.goals.includes('Build Muscle')) TDEE*=1.1;
  const targetW=Number(u.targetWeight)||W||1;
  const protein=Math.round(2.0*targetW);
  const fat=Math.round(Math.max(0,0.8*W));
  let carbs=Math.round((TDEE - (protein*4 + fat*9))/4);
  if((u.medical||[]).some(x=>/(Diabetes|Insulin|ุงูุณูุฑู|ููุงููุฉ)/i.test(x))) carbs=Math.min(carbs,120);
  return {calories:Math.round(TDEE), macros:{protein, fat, carbs:Math.max(0,carbs)}};
}

/* ---------- AI Call ---------- */
async function callAI(prompt){
  const res=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
  if(!res.ok){ const e=await res.text(); throw new Error(e||'Server error'); }
  const data=await res.json(); return data.text||'';
}

/* ---------- Plan Generation ---------- */
let running=false;
async function generatePlan(){
  if(running) return;
  const u=collect(); if(!u) return;
  running=true; $('#plan').innerHTML=''; $('#overlay').classList.remove('hidden'); $('#progressTxt').textContent='0%';

  const L=LANG==='ar'?'Arabic':'English';
  const t=computeTargets(u);

  try{
    // Welcome + Analysis
    let p=`
You are "Mustafa Elsafy", certified international coach. Write only in ${L}. Use clear Markdown.
User: ${u.name}. Build a complete, exhaustive plan with measurable outcomes.

Profile:
- Sex ${u.sex}, Age ${u.age}, Height ${u.height}cm, Weight ${u.weight}kg, BF ${u.bodyfat||'N/A'}%, Waist ${u.waist||'N/A'}cm.
- Goals: ${u.goals.join(', ')||'N/A'}; Target ${u.targetWeight||'N/A'} kg by ${u.targetDate||'N/A'}.
- Lifestyle: Work ${u.work}, Steps ${u.steps}/day, Sleep ${u.sleep}, Stress ${u.stress}, Training ${u.place} ${u.session}min.
- Fitness: RHR ${u.rhr||'?'}, Push-ups ${u.pushups||'?'}, Plank ${u.plank||'?'}, 1km ${u.kmTime||'?'}.
- Days: ${u.days.join(', ')||'N/A'}; Equipment: ${u.equipment||'None'}; Experience: ${u.experience}; Target RPE ${u.rpe}.
- Diet: ${u.meals} meals/day, ${u.dietType}, Cuisine ${u.cuisine}, Prep ${u.prep} min, Fasting ${u.fasting}, Budget ${u.budget} ${u.currency}.
- Avoid: ${u.avoid||'None'}.
- Focus muscles: ${u.muscles.join('; ')||'None'}.
- Medical: ${u.medical.join('; ')||'None'}; Other: ${u.otherCond||'None'}; Injuries: ${u.injuries||'None'}.
- Meds: ${u.meds||'None'}; Supplements: ${u.supps||'None'}.
- Motivation: ${u.motivation}; Past challenges: ${u.pastChallenges||'None'}.

Computed daily targets: ${t.calories} kcal; Protein ${t.macros.protein} g; Fat ${t.macros.fat} g; Carbs ${t.macros.carbs} g.

Task: Return a warm **welcome** paragraph and a concise **analysis** bullets with clear objectives and success metrics.
`;
    $('#progressTxt').textContent='10%';
    append(await callAI(p));

    // Allowed & Limits
    p=`Write in ${L}.
Create two bullet lists: **Allowed/Recommended** and **To limit/avoid** considering diet "${u.dietType}", allergies "${u.avoid||'None'}", medical "${u.medical.join(', ')||'None'}".`;
    $('#progressTxt').textContent='20%';
    append(sectionTitle(L==='Arabic'?'ูุงุฆูุฉ ุงููุณููุญ ูุงูููููุน':'Allowed & Limits') + '\n' + await callAI(p));

    // Fasting (if any or fat loss)
    if(u.fasting!=='None' || u.goals.includes('Fat Loss')){
      p=`In ${L}, describe intermittent fasting protocol "${u.fasting==='None'?'16:8':u.fasting}" with timing, hydration, electrolytes, aligning with ${u.meals} meals/day and ${u.session} min training. Safety notes for ${u.medical.join(', ')||'None'}.`;
      $('#progressTxt').textContent='30%';
      append(sectionTitle(L==='Arabic'?'ุงูุตูุงู ุงููุชูุทุน':'Intermittent Fasting')+'\n'+await callAI(p));
    }

    // Nutrition 7 days
    p=`Generate a **7-day nutrition plan** (Day 1..Day 7) in ${L}.
Rules:
- ${u.meals} meals/day + optional snacks.
- Hit daily targets: ${t.calories} kcal; P ${t.macros.protein} g; F ${t.macros.fat} g; C ${t.macros.carbs} g.
- Style "${u.dietType}", Cuisine "${u.cuisine}", Prep ~${u.prep} min/meal, Budget ${u.budget} ${u.currency}.
- Avoid "${u.avoid||'None'}"; Medical: "${u.medical.join(', ')||'None'}".
- For each meal: name, ingredients (grams), macros, calories; add [SWAP:MEAL:<name>] after each meal.
Return Markdown: **table per day** with totals row. No placeholders.`;
    $('#progressTxt').textContent='55%';
    append(sectionTitle(L==='Arabic'?'ุงูุชุบุฐูุฉ (7 ุฃูุงู)':'Nutrition (7 days)')+'\n'+await callAI(p));

    // Training 7 days
    p=`Create a **7-day training plan** in ${L}, day-by-day.
Constraints: Experience ${u.experience}, Place ${u.place}, Equipment "${u.equipment||'bodyweight'}", Session ~${u.session} min, RPE ${u.rpe}, Days ${u.days.join(', ')||'N/A'}.
Prioritize weak muscles: ${u.muscles.join('; ')||'None'}; avoid aggravating "${u.injuries||'None'}".
Include warm-up, main sets, cool-down, and progression.
Return Markdown tables (Day | Exercise EN | Sets | Reps | Rest s). Add [SWAP:EXERCISE:<Exercise>] entries.`;
    $('#progressTxt').textContent='75%';
    append(sectionTitle(L==='Arabic'?'ุงูุชุฏุฑูุจ (7 ุฃูุงู)':'Training (7 days)')+'\n'+await callAI(p));

    // Supplements
    p=`Evidence-based supplements in ${L} tailored to goals "${u.goals.join(', ')||'None'}", medical "${u.medical.join(', ')||'None'}", meds "${u.meds||'None'}".
Sections: Core stack (doses, timing, contraindications), Goal-specific, Budget option. Include safety interactions.`;
    $('#progressTxt').textContent='85%';
    append(sectionTitle(L==='Arabic'?'ุงูููููุงุช':'Supplements')+'\n'+await callAI(p));

    // Progress & Troubleshooting & Safety & Closing
    p=`In ${L}, write:
- **Progression** rules (when to adjust calories, macro examples, training overload).
- **Troubleshooting** tailored to past challenges "${u.pastChallenges||'None'}".
- **Safety** notes for ${u.medical.join(', ')||'None'} and injuries "${u.injuries||'None'}".
- Motivational **closing** using style "${u.motivation}". Sign as "Mustafa Elsafy".`;
    $('#progressTxt').textContent='100%';
    append(await callAI(p));

  }catch(e){
    append(`> โ ${e.message||e}`);
  }finally{
    $('#overlay').classList.add('hidden');
    running=false;
  }
}

function sectionTitle(t){ return `### ${t}`; }
function append(md){ $('#plan').insertAdjacentHTML('beforeend', marked.parse(md)); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); }

/* ---------- Events ---------- */
$('#btnAr').onclick=()=>setLang('ar');
$('#btnEn').onclick=()=>setLang('en');
$('#startTop').onclick=()=>$('#btnGenerate').click();
$('#btnGenerate').onclick=generatePlan;
$('#btnPrint').onclick=()=>window.print();
$('#btnTheme').onclick=()=>document.documentElement.classList.toggle('dark');

/* ---------- Init ---------- */
window.addEventListener('load',()=>{
  setLang('ar');
  buildMuscles(); buildMedical(); buildDays(); detectCurrency();
});
</script>
</body>
</html>
