<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ± â€” Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ</title>

  <!-- Tailwind + Marked -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Ø®Ø·ÙˆØ· -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Ù„ÙˆØ­Ø© Ø£Ù„ÙˆØ§Ù† Ù‡Ø§Ø¯Ø¦Ø© + ØªØ­Ø³ÙŠÙ† Ù‚Ø±Ø§Ø¡Ø© -->
  <style id="theme-override">
    :root{
      --bg:#f8fafc; --surface:#ffffff; --border:#e5e7eb;
      --text:#0f172a; --muted:#475569;
      --primary:#2563eb; --primary-700:#1d4ed8;
      --accent:#10b981; --warn:#f59e0b; --error:#ef4444;
    }
    html,body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
    .font-tajawal{font-family:'Tajawal',sans-serif}
    .font-poppins{font-family:'Poppins',sans-serif}
    .card{background:var(--surface)!important;border:1px solid var(--border)!important;box-shadow:0 6px 20px rgba(15,23,42,.06)!important}
    header,#topbar{background:linear-gradient(to right,rgba(37,99,235,.10),rgba(16,185,129,.08))!important;border-bottom:1px solid var(--border)}
    #next{background:var(--primary)!important} #next:hover{background:var(--primary-700)!important}
    #prev{background:#e2e8f0!important;color:#0f172a!important} #prev:hover{background:#cbd5e1!important}
    .badge-ok{background:#ecfdf5!important;color:#065f46!important;border:1px solid #a7f3d0!important}
    .badge-warn{background:#fffbeb!important;color:#92400e!important;border:1px solid #fde68a!important}
    .badge-err{background:#fef2f2!important;color:#991b1b!important;border:1px solid #fecaca!important}
    @media (prefers-reduced-motion:reduce){
      *{animation-duration:.001ms!important;animation-iteration-count:1!important;transition-duration:.001ms!important;scroll-behavior:auto!important}
    }
    /* Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
    .ai-prose .day-card{border:1px solid rgba(2,6,23,.08);border-radius:.75rem;padding:1rem;margin:1rem 0;background:#fff}
    .ai-prose table{width:100%;border-collapse:collapse;margin:.85rem 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .ai-prose th,.ai-prose td{border:1px solid #e5e7eb;padding:.6rem;vertical-align:top;font-size:.92rem}
    .ai-prose th{background:#f8fafc;font-weight:700}
    .supp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:.75rem}
    .supp-card{background:#fff;border:1px solid rgba(2,6,23,.08);border-radius:.75rem;padding:.8rem}
    @media print{
      .page-break{page-break-before:always}
      .section-break{page-break-after:always}
      header,#sticky,.no-print{display:none!important}
    }
  </style>
</head>

<body class="font-tajawal min-h-screen">
  <!-- Ø±Ø£Ø³/Ù„ØºØ© -->
  <header id="topbar" class="px-4 sm:px-6 py-3 flex items-center justify-between">
    <div class="leading-tight">
      <div class="text-xs text-slate-600">COACH</div>
      <div class="font-extrabold">Mustafa Al-Safi</div>
      <div class="text-xs text-slate-500">Certified International Coach</div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn-print" class="px-3 py-1.5 rounded-lg border text-sm no-print">Ø·Ø¨Ø§Ø¹Ø© PDF</button>
      <button id="btn-en" class="px-2.5 py-1.5 rounded-lg text-sm font-bold">EN</button>
      <button id="btn-ar" class="px-2.5 py-1.5 rounded-lg text-sm font-bold">Ø¹Ø±Ø¨ÙŠ</button>
    </div>
  </header>

  <!-- Ø§Ù„Ø­Ø§ÙˆÙŠØ© -->
  <div id="app" class="max-w-4xl mx-auto my-4 sm:my-10 card rounded-2xl overflow-hidden">
    <!-- Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
    <div class="p-6 sm:p-8">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-slate-900 text-center">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±</h1>
      <p class="text-sm text-slate-600 text-center mt-1">Ø®Ø·Ø© Ù…Ø®ØµØµØ© Ø¨Ø¯Ù‚Ø© 100% Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ø£Ù‡Ø¯Ø§ÙÙƒ ÙˆØµØ­ØªÙƒ ÙˆÙ†Ù…Ø· Ø­ÙŠØ§ØªÙƒ.</p>
      <p class="text-xs text-slate-500 text-center mt-1">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯ â€¢ Powered by Mustafa Elsafy 2025</p>

      <!-- Ù…Ù„Ø®Øµ Ø¬ÙˆØ¯Ø© Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
      <div class="grid sm:grid-cols-3 gap-3 mt-5">
        <div class="card p-3">
          <div class="text-xs text-slate-600 mb-1">Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</div>
          <div class="text-sm">Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© | Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯</div>
          <div class="text-xs text-slate-500 mt-1">Powered by Mustafa Elsafy 2025</div>
        </div>
        <div class="card p-3">
          <div class="text-xs text-slate-600 mb-1">Ø¬ÙˆØ¯Ø© Ø§Ù„Ø®Ø·Ø©</div>
          <div class="flex items-center gap-2">
            <span id="badgeDays" class="badge-warn day-badge px-2 py-0.5 rounded">0/7</span>
            <span id="badgeMacros" class="badge-warn day-badge px-2 py-0.5 rounded">â€”</span>
          </div>
        </div>
        <div class="card p-3">
          <div class="text-xs text-slate-600 mb-1">Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙ‚Ø¯Ù…</div>
          <div class="h-2.5 bg-gray-200 rounded-full overflow-hidden" role="progressbar" aria-valuemin="0" aria-valuemax="100">
            <div id="progress" class="h-full bg-gradient-to-r from-indigo-500 to-blue-500 transition-all duration-300" style="width:0%"></div>
          </div>
          <div class="mt-2 text-xs text-gray-500">Ø§Ù„Ø®Ø·ÙˆØ© <span id="step">0</span> Ù…Ù† 12</div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ -->
    <main id="content" class="p-5 sm:p-8"></main>

    <!-- Ø£Ø²Ø±Ø§Ø± ØªÙ†Ù‚Ù„ -->
    <div id="sticky" class="sticky bottom-0 bg-white/80 backdrop-blur-md border-t px-4 sm:px-6 py-3 flex gap-3 justify-between">
      <button id="prev" class="w-1/3 sm:w-40 font-bold py-2.5 rounded-lg" type="button">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button id="next" class="flex-1 text-white font-extrabold py-2.5 rounded-lg" type="button">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
  </div>

  <!-- ========== Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ========== -->
  <script>
  /* -------------------- STATE -------------------- */
  const TOTAL_STEPS = 12;
  const content = document.getElementById('content');
  const progressBar = document.getElementById('progress');
  const stepEl = document.getElementById('step');
  const btnPrev = document.getElementById('prev');
  const btnNext = document.getElementById('next');
  const btnAr = document.getElementById('btn-ar');
  const btnEn = document.getElementById('btn-en');
  const badgeDays = document.getElementById('badgeDays');
  const badgeMacros = document.getElementById('badgeMacros');

  let state = {
    lang: 'ar',
    current: 0,
    user: {
      goals: [], weak_points:{}, health_conditions:[], allergies:[],
      steps_target: 8000
    },
    calc: { tdee_goal: 0, protein_g: 0, fat_g: 0, carb_g: 0, pal: 1.35 }
  };

  /* -------------------- I18N -------------------- */
  const T = {
    ar: {
      start: "Ø§Ø¨Ø¯Ø£", next:"Ø§Ù„ØªØ§Ù„ÙŠ", prev:"Ø§Ù„Ø³Ø§Ø¨Ù‚", submit:"Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†!",
      welcome_title:"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­ÙˆÙ„!", welcome_desc:"Ø³Ø£ØµÙ…Ù… Ù„Ùƒ Ø®Ø·Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª.",
      name_q:"Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ", age:"Ø§Ù„Ø¹Ù…Ø±", height:"Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)", weight:"Ø§Ù„ÙˆØ²Ù† (ÙƒØº)", gender:"Ø§Ù„Ø¬Ù†Ø³", male:"Ø°ÙƒØ±", female:"Ø£Ù†Ø«Ù‰",
      stage_1_title:"Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù…Ù† Ø£Ù†ØªØŸ", stage_1_desc:"Ø§Ø³Ù…Ùƒ Ù‡Ùˆ Ø¨Ø¯Ø§ÙŠØ© ØªØ®ØµÙŠØµ Ø§Ù„ØªØ¬Ø±Ø¨Ø©.",
      stage_2_title:"Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", stage_2_desc:"Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±Ø§Øª.",
      stage_3_title:"ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù", stage_3_desc:"Ø§Ø®ØªØ± Ø£Ù‡Ø¯Ø§ÙÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.",
      goal1:"Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†", goal2:"Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª", goal3:"Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©", goal4:"ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„", goal5:"ØµØ­Ø© Ø¹Ø§Ù…Ø©",
      stage_4_title:"Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©", stage_5_title:"Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ Ø§Ù„Ù…ÙØ¶Ù„", stage_6_title:"Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©",
      stage_7_title:"Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ", stage_8_title:"Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØªØ±ÙƒÙŠØ²", stage_9_title:"Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©",
      stage_10_title:"Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©", stage_11_title:"Ù…Ù„ÙØ§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© (ØµÙˆØ±/InBody)",
      loading_title:(n)=>`Ù„Ø­Ø¸Ø§Øª Ù…Ù† ÙØ¶Ù„Ùƒ ÙŠØ§ ${n}...`, loading_sub:"ÙŠÙ‚ÙˆÙ… Ø®Ø¨ÙŠØ±Ù†Ø§ Ø§Ù„Ø°ÙƒÙŠ Ø¨ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø¨Ù†Ø§Ø¡ Ø®Ø·Ø© Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©.",
      print_btn:"Ø·Ø¨Ø§Ø¹Ø© / ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·Ø©", export:"ØªØµØ¯ÙŠØ±", export_json:"JSON", export_csv:"CSV",
      api_key_error:"ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„. ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ø£Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­."
    },
    en: {
      start:"Start", next:"Next", prev:"Back", submit:"Generate Plan",
      welcome_title:"Welcome to your transformation!", welcome_desc:"I'll craft a precise nutrition, training and supplements plan for you.",
      name_q:"Your name?", age:"Age", height:"Height (cm)", weight:"Weight (kg)", gender:"Gender", male:"Male", female:"Female",
      stage_1_title:"Step 1: Who are you?", stage_1_desc:"Your name personalizes the experience.",
      stage_2_title:"Basic data", stage_2_desc:"This is the foundation for calorie math.",
      stage_3_title:"Select your goals", stage_3_desc:"Pick your main goals.",
      goal1:"Fat loss", goal2:"Muscle gain", goal3:"Strength", goal4:"Endurance", goal5:"General health",
      stage_4_title:"Advanced target", stage_5_title:"Preferred diet style", stage_6_title:"Food allergies",
      stage_7_title:"Training history", stage_8_title:"Weak points", stage_9_title:"Health status",
      stage_10_title:"Lifestyle", stage_11_title:"Optional files (Photos/InBody)",
      loading_title:(n)=>`One moment ${n}...`, loading_sub:"Analyzing your inputs to craft a precise plan.",
      print_btn:"Print / Download", export:"Export", export_json:"JSON", export_csv:"CSV",
      api_key_error:"Cannot reach the model. Check function or key."
    }
  };
  const muscles = ['chest','back','shoulders','biceps','triceps','quads','hamstrings','glutes','calves','abs'];

  /* -------------------- HELPERS -------------------- */
  function t(k,...a){ const pack = T[state.lang]; const v = pack[k]; return typeof v==='function'? v(...a) : (v||k); }
  function setLang(lang){ state.lang = lang; document.documentElement.lang = lang; document.documentElement.dir = lang==='ar'?'rtl':'ltr';
    document.body.classList.toggle('font-tajawal', lang==='ar'); document.body.classList.toggle('font-poppins', lang!=='ar');
    btnAr.className = `px-2.5 py-1.5 rounded-lg text-sm font-bold ${lang==='ar'?'bg-indigo-600 text-white':'bg-gray-100 text-gray-700'}`;
    btnEn.className = `px-2.5 py-1.5 rounded-lg text-sm font-bold ${lang==='en'?'bg-indigo-600 text-white':'bg-gray-100 text-gray-700'}`;
    updateCTA();
    if (state.current===12) localizeResultButtons();
  }
  function updateProgress(){ const p = Math.max(0, ((state.current-1)/TOTAL_STEPS)*100); progressBar.style.width = `${p}%`; stepEl.textContent = String(Math.min(state.current,TOTAL_STEPS)); }
  function updateCTA(){ btnNext.textContent = state.current===TOTAL_STEPS ? t('submit') : t('next'); btnPrev.textContent = t('prev'); btnPrev.disabled = state.current<=1; }
  function field(label,id,opts={}){ const {type='text',value='',required=false,select=null,placeholder='',num=false}=opts;
    if (select) return `<label class="block"><span class="font-medium text-gray-800">${label}</span><select id="${id}" class="mt-1 w-full p-3 border rounded-lg">${select.map(o=>`<option ${String(value)===String(o.value)?'selected':''} value="${o.value}">${o.label}</option>`).join('')}</select></label>`;
    if (type==='textarea') return `<label class="block"><span class="font-medium text-gray-800">${label}</span><textarea id="${id}" rows="3" placeholder="${placeholder}" class="mt-1 w-full p-3 border rounded-lg">${value||''}</textarea></label>`;
    return `<label class="block"><span class="font-medium text-gray-800">${label}</span><input id="${id}" type="${type}" ${required?'required':''} value="${value}" placeholder="${placeholder}" ${num?'inputmode="numeric" pattern="[0-9]*"':''} class="mt-1 w-full p-3 border rounded-lg"></label>`;
  }
  function stage(title,desc,inner){ return `<section class="stage-enter" aria-live="polite"><h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900">${title}</h2><p class="mt-1 text-gray-600">${desc||''}</p><form id="form" class="space-y-5 mt-6" onsubmit="event.preventDefault();">${inner}</form></section>`; }

  /* -------------------- STAGES (Ù…Ø®ØªØµØ±Ø© ÙˆÙˆØ§Ø¶Ø­Ø©) -------------------- */
  function render(){
    updateProgress(); updateCTA();
    const s = state.user; let html='';
    switch(state.current){
      case 0:
        content.innerHTML = `<section class="text-center p-8">
          <h2 class="text-3xl font-extrabold mb-2">${t('welcome_title')}</h2>
          <p class="text-gray-600 max-w-xl mx-auto">${t('welcome_desc')}</p>
          <div class="mt-6 inline-flex gap-2 items-center">
            <select id="lang-select" class="p-3 rounded-lg border">
              <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option>
            </select>
            <button id="start" class="bg-indigo-600 hover:bg-indigo-700 text-white font-extrabold px-8 py-3 rounded-xl" type="button">${t('start')}</button>
          </div></section>`;
        document.getElementById('start').onclick=()=>{ setLang(document.getElementById('lang-select').value); state.current=1; render(); };
        break;
      case 1:
        html = field(t('name_q'),'name',{required:true,value:s.name||''});
        content.innerHTML = stage(t('stage_1_title'),t('stage_1_desc'),html); break;
      case 2:
        html = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          ${field(t('age'),'age',{type:'number',value:s.age||'',required:true,num:true})}
          ${field(t('height'),'height',{type:'number',value:s.height||'',required:true,num:true})}
          ${field(t('weight'),'weight',{type:'number',value:s.weight||'',required:true,num:true})}
          ${field(t('gender'),'gender',{select:[{value:'Male',label:t('male')},{value:'Female',label:t('female')}], value:s.gender||'Male'})}
        </div>`;
        content.innerHTML=stage(t('stage_2_title'),t('stage_2_desc'),html); break;
      case 3:
        const gs=['goal1','goal2','goal3','goal4','goal5'];
        html = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${gs.map(k=>{
          const v=t(k); const on=(s.goals||[]).includes(v)?'checked':''; return `<label class="block p-3 rounded-lg border cursor-pointer"><input ${on} type="checkbox" name="goal" value="${v}" class="mr-2 accent-indigo-600"> ${v}</label>`}).join('')}</div>`;
        content.innerHTML=stage(t('stage_3_title'),t('stage_3_desc'),html); break;
      case 4:
        html = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          ${field('Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (ÙƒØº) / Target weight','target_weight',{type:'number',value:s.target_weight||'',num:true})}
          ${field('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¯Ù / Target date','target_date',{type:'date',value:s.target_date||''})}
        </div>`;
        content.innerHTML=stage(t('stage_4_title'),' ',html); break;
      case 5:
        const dietKeys=[ 'Ù…ØªÙˆØ§Ø²Ù† / Balanced','Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª / Low-Carb','ØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹ / IF','ÙƒÙŠØªÙˆ / Keto','Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø· / Mediterranean','Ù†Ø¨Ø§ØªÙŠ / Plant-based'];
        html = field(t('stage_5_title'),'diet_preference',{select:dietKeys.map(k=>({value:k,label:k})), value:s.diet_preference||dietKeys[0]});
        content.innerHTML=stage(t('stage_5_title'),' ',html); break;
      case 6:
        const allergyVals=['Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†','Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²','Ø§Ù„Ù…ÙƒØ³Ø±Ø§Øª','Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ©','Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø©','Ø§Ù„Ø²ÙŠÙˆØª Ø§Ù„Ù†Ø¨Ø§ØªÙŠØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©'];
        html = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${allergyVals.map(v=>{
          const on=(s.allergies||[]).includes(v)?'checked':''; return `<label class="block p-3 rounded-lg border cursor-pointer"><input ${on} type="checkbox" name="allergy" value="${v}" class="mr-2 accent-indigo-600"> ${v}</label>`}).join('')}</div>
          ${field('Ø­Ø³Ø§Ø³ÙŠØ© Ø£Ø®Ø±Ù‰ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)','other_allergies',{value:s.other_allergies||''})}`;
        content.innerHTML=stage(t('stage_6_title'),' ',html); break;
      case 7:
        html = `${field('Ø¢Ø®Ø± Ø§Ù„ØªØ²Ø§Ù… ØªØ¯Ø±ÙŠØ¨ÙŠ','last_train',{select:[{value:'Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±',label:'Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±'},{value:'3-12 Ø´Ù‡Ø±',label:'3-12 Ø´Ù‡Ø±'},{value:'Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†Ø©',label:'Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†Ø©'}],value:s.last_train||'Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±'})}
                ${field('Ø®Ø¨Ø±ØªÙƒ ÙÙŠ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©','training_exp',{select:[{value:'Ù…Ø¨ØªØ¯Ø¦',label:'Ù…Ø¨ØªØ¯Ø¦'},{value:'Ù…ØªÙˆØ³Ø·',label:'Ù…ØªÙˆØ³Ø·'},{value:'Ù…ØªÙ‚Ø¯Ù…',label:'Ù…ØªÙ‚Ø¯Ù…'}],value:s.training_exp||'Ù…Ø¨ØªØ¯Ø¦'})}`;
        content.innerHTML=stage(t('stage_7_title'),' ',html); break;
      case 8:
        html = `<div class="space-y-4">${muscles.map(m=>`<div class="flex items-center gap-3">
          <input id="${m}" type="checkbox" ${(s.weak_points||{})[m]?'checked':''} class="accent-indigo-600">
          <label for="${m}" class="w-24">${m}</label>
          <input id="${m}_desc" placeholder="Ù‡Ø¯Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©" value="${(s.weak_points||{})[m]||''}" class="flex-1 p-2 border rounded">
        </div>`).join('')}</div>`;
        content.innerHTML=stage(t('stage_8_title'),' ',html); break;
      case 9:
        const cond = ['Ø¶ØºØ· Ø§Ù„Ø¯Ù…','Ø§Ù„Ø³ÙƒØ±ÙŠ','Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†','Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©','Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ','Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©','Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù‡Ø¶Ù…ÙŠ'];
        html = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${cond.map(v=>{
          const on=(s.health_conditions||[]).includes(v)?'checked':''; return `<label class="block p-3 rounded-lg border cursor-pointer"><input ${on} type="checkbox" name="health_condition" value="${v}" class="mr-2 accent-indigo-600"> ${v}</label>`}).join('')}</div>
          ${field('Ø¥ØµØ§Ø¨Ø§Øª (Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…ÙƒØ§Ù†)','injuries',{type:'textarea',value:s.injuries||''})}`;
        content.innerHTML=stage(t('stage_9_title'),' ',html); break;
      case 10:
        html = `<div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          ${field('Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¹Ù…Ù„','job_activity',{select:[{value:'Ù…ÙƒØªØ¨ÙŠ',label:'Ù…ÙƒØªØ¨ÙŠ'},{value:'Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ',label:'Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ'},{value:'Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·',label:'Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·'}],value:s.job_activity||'Ù…ÙƒØªØ¨ÙŠ'})}
          ${field('Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù†ÙˆÙ…','sleep_hours',{type:'number',value:s.sleep_hours||'',required:true,num:true})}
          ${field('Ø§Ù„Ø¶ØºØ·/Ø§Ù„ØªÙˆØªØ±','stress_level',{select:[{value:'Ù…Ù†Ø®ÙØ¶',label:'Ù…Ù†Ø®ÙØ¶'},{value:'Ù…ØªÙˆØ³Ø·',label:'Ù…ØªÙˆØ³Ø·'},{value:'Ù…Ø±ØªÙØ¹',label:'Ù…Ø±ØªÙØ¹'}],value:s.stress_level||'Ù…ØªÙˆØ³Ø·'})}
        </div>
        ${field('Ù‡Ø¯Ù Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (NEAT)','steps_target',{type:'number',value:s.steps_target||8000,num:true})}`;
        content.innerHTML=stage(t('stage_10_title'),' ',html); break;
      case 11:
        html = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <label class="p-6 block text-center rounded-xl border cursor-pointer"><span>ğŸ“· Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ø¬Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span><input type="file" id="photos" class="hidden" multiple accept="image/*"></label>
          <label class="p-6 block text-center rounded-xl border cursor-pointer"><span>ğŸ“„ Ø±ÙØ¹ InBody (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span><input type="file" id="inbody" class="hidden" accept="image/*,.pdf"></label>
        </div>`;
        content.innerHTML=stage(t('stage_11_title'),' ',html); break;
      case 12:
        content.innerHTML = `<section class="text-center p-8">
          <h2 class="text-2xl font-extrabold mb-2">${t('loading_title', s.name||'')}</h2>
          <p class="text-gray-600">${t('loading_sub')}</p>
          <div class="mt-6 animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600 mx-auto" aria-hidden="true"></div>
          <div id="plan" class="mt-8 ai-content" dir="${state.lang==='ar'?'rtl':'ltr'}"></div>
        </section>`;
        generatePlan();
        break;
    }
  }

  /* -------------------- SAVE + NAV -------------------- */
  function saveAndNext(){
    const s = state.user;
    try{
      switch(state.current){
        case 1: s.name=document.getElementById('name').value.trim(); if(!s.name) throw 0; break;
        case 2: s.age=document.getElementById('age').value; s.height=document.getElementById('height').value; s.weight=document.getElementById('weight').value; s.gender=document.getElementById('gender').value; if(!s.age||!s.height||!s.weight) throw 0; break;
        case 3: s.goals=[...document.querySelectorAll('input[name="goal"]:checked')].map(e=>e.value); if(!s.goals.length) throw 0; break;
        case 4: s.target_weight=document.getElementById('target_weight').value; s.target_date=document.getElementById('target_date').value; break;
        case 5: s.diet_preference=document.getElementById('diet_preference').value; break;
        case 6: s.allergies=[...document.querySelectorAll('input[name="allergy"]:checked')].map(e=>e.value); const other=document.getElementById('other_allergies').value.trim(); if(other) s.allergies.push(other); break;
        case 7: s.last_train=document.getElementById('last_train').value; s.training_exp=document.getElementById('training_exp').value; break;
        case 8: s.weak_points={}; muscles.forEach(m=>{ const cb=document.getElementById(m); if(cb?.checked) s.weak_points[m]=document.getElementById(`${m}_desc`).value||'General Strengthening'; }); break;
        case 9: s.health_conditions=[...document.querySelectorAll('input[name="health_condition"]:checked')].map(e=>e.value); s.injuries=document.getElementById('injuries').value; break;
        case 10: s.job_activity=document.getElementById('job_activity').value; s.sleep_hours=document.getElementById('sleep_hours').value; s.stress_level=document.getElementById('stress_level').value; s.steps_target=Number(document.getElementById('steps_target').value||8000); if(!s.sleep_hours) throw 0; break;
        case 11: s.has_photos=document.getElementById('photos')?.files.length>0; s.has_inbody=document.getElementById('inbody')?.files.length>0; break;
      }
      state.current++; render();
    }catch{ notify(state.lang==='ar'?'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©':'Please complete required fields','error'); }
  }
  function goBack(){ if(state.current>1){ state.current--; render(); } }
  btnPrev.onclick=goBack; btnNext.onclick=()=>{ if(state.current<TOTAL_STEPS) saveAndNext(); else generatePlan(); };
  btnAr.onclick=()=>setLang('ar'); btnEn.onclick=()=>setLang('en');
  document.getElementById('btn-print').onclick=()=>window.print();

  /* -------------------- CALC ENGINE -------------------- */
  function compute(){
    const p = state.user;
    const W = Number(p.weight)||0, H=Number(p.height)||0, A=Number(p.age)||0;
    const male = p.gender==='Male';
    const BMR = male ? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161;
    const pal = p.job_activity==='Ù…ÙƒØªØ¨ÙŠ'||p.job_activity==='Office' ? 1.2 : (p.job_activity==='Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·'||p.job_activity==='Moderate'?1.5:1.35);
    let TDEE = BMR * pal;
    if ((p.goals||[]).includes(t('goal1'))) TDEE *= 0.85;
    else if ((p.goals||[]).includes(t('goal2'))) TDEE *= 1.1;
    const targetW = Number(p.target_weight) || W || 1;
    const protein_g = Math.round(2.0 * targetW);
    const fat_g = Math.round(Math.max(0, 0.8 * W));
    let carb_g = Math.round((TDEE - (protein_g*4 + fat_g*9))/4);
    const hasIR = (p.health_conditions||[]).some(h=>/Ø§Ù„Ø³ÙƒØ±ÙŠ|Ù…Ù‚Ø§ÙˆÙ…Ø©/.test(h));
    if (hasIR) carb_g = Math.min(carb_g, 120);
    carb_g = Math.max(0, carb_g);
    state.calc = { tdee_goal: Math.round(TDEE), protein_g, fat_g, carb_g, pal };
  }

  /* -------------------- AI PROMPT + CALL -------------------- */
  async function generatePlan(){
    compute();
    lockUI(true);
    try{
      const prompt = buildPrompt(state.user, state.lang, state.calc);
      const res = await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
      const raw = await res.text(); let data=null; try{ data=raw?JSON.parse(raw):null; }catch{}
      if(!res.ok) throw new Error(data?.error || raw || 'Server error');
      renderAI(data?.text||''); qualityPass(data?.text||'');
      notify(state.lang==='ar'?'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©':'Plan generated');
    }catch(e){
      renderErrorCard(e.message||String(e)); notify(state.lang==='ar'?'ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©':'Failed to generate','error');
    }finally{ lockUI(false); }
  }

  function buildPrompt(profile, lang, calc){
    const weak = Object.entries(profile.weak_points||{}).map(([m,d])=>`${m}: ${d}`).join(', ') || (lang==='ar'?'Ù„Ø§ ÙŠÙˆØ¬Ø¯':'None');
    const hardRules = `
CRITICAL OUTPUT RULES:
1) Entire response in ${lang.toUpperCase()}.
2) Food names & ingredients in ${lang.toUpperCase()} with exact grams.
3) Exercise NAMES in ENGLISH + short Arabic cues.
4) Provide calories and macros per meal (P/F/C grams) and daily total (Â±5%).
5) Cover FULL 7 DAYS nutrition & training. If missing, reprint.
6) Respect allergies: ${(profile.allergies||[]).join(', ')|| (lang==='ar'?'Ù„Ø§ ØªÙˆØ¬Ø¯':'None') }.
7) Respect health conditions: ${(profile.health_conditions||[]).join(', ')|| (lang==='ar'?'Ù„Ø§ ØªÙˆØ¬Ø¯':'None') }.
8) If insulin resistance/diabetes â†’ cap carbs â‰¤ 120g/day and keep protein high.
9) Every meal & exercise must be swappable: [SWAP:MEAL:Ø§Ø³Ù…] / [SWAP:EXERCISE:EN].
10) Close with:
**Ù…Ø¹ Ø®Ø§Ù„Øµ ØªÙ…Ù†ÙŠØ§ØªÙŠ Ù„Ùƒ Ø¨Ø§Ù„Ù†Ø¬Ø§Ø­ØŒ**
**Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯**
**Powered by Mustafa Elsafy 2025**
`;
    return `
Act as "Coach Mustafa Al-Safi" (Certified International Coach). Produce a professional, SAFE, fully-detailed plan in ${lang.toUpperCase()}.

USER DATA:
- Name: ${profile.name}
- Age/Height/Weight/Gender: ${profile.age}/${profile.height}cm/${profile.weight}kg/${profile.gender}
- Goals: ${(profile.goals||[]).join(', ')}
- Target: ${profile.target_weight||'N/A'} by ${profile.target_date||'N/A'}
- Training: Last ${profile.last_train} | Experience ${profile.training_exp}
- Weak points: ${weak}
- Health: ${(profile.health_conditions||[]).join(', ')||'None'} | Injuries: ${profile.injuries||'None'} | Allergies: ${(profile.allergies||[]).join(', ')||'None'}
- Diet: ${profile.diet_preference}
- Lifestyle: Job ${profile.job_activity} | Sleep ${profile.sleep_hours}h | Stress ${profile.stress_level} | Steps ${profile.steps_target}/d | PAL ${calc.pal}
- Daily targets: ~${calc.tdee_goal} kcal | P ${calc.protein_g}g / F ${calc.fat_g}g / C ${calc.carb_g}g

${hardRules}

OUTPUT SKELETON (STRICT):
### 1) ${lang==='ar'?'Ù…Ù„Ø®Øµ Ø­Ø§Ù„ØªÙƒ Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ':'Diagnostic Summary'}
(Ø§ÙƒØªØ¨ Ù…Ù„Ø®ØµÙ‹Ø§ ÙˆØ§Ø¶Ø­Ù‹Ø§ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ£Ù‡Ø¯Ø§ÙÙ‡)

### 2) ${lang==='ar'?'Ø£Ù‡Ø¯Ø§ÙÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©':'Daily Targets'}
- ${calc.tdee_goal} kcal â€” P ${calc.protein_g}g / F ${calc.fat_g}g / C ${calc.carb_g}g

### 3) ${lang==='ar'?'Ø§Ù„ØªØºØ°ÙŠØ© â€” 7 Ø£ÙŠØ§Ù…':'Nutrition â€” 7 Days'}
(Ù„ÙƒÙ„ ÙŠÙˆÙ…: Ø¬Ø¯ÙˆÙ„ ÙˆØ¬Ø¨Ø§Øª Ø¥ÙØ·Ø§Ø±/Ø³Ù†Ø§Ùƒ/ØºØ¯Ø§Ø¡/Ø³Ù†Ø§Ùƒ/Ø¹Ø´Ø§Ø¡ + Ø³Ø¹Ø±Ø§Øª ÙˆP/F/C Ù„ÙƒÙ„ ÙˆØ¬Ø¨Ø© + Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…. ÙƒÙ„ ÙˆØ¬Ø¨Ø© SWAP)

### 4) ${lang==='ar'?'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹':'Allowed/Avoid'}
(Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù…Ù„ÙŠØ© ØªØ±Ø§Ø¹ÙŠ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©)

### 5) ${lang==='ar'?'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ â€” 7 Ø£ÙŠØ§Ù…':'Training â€” 7 Days'}
(Ù„ÙƒÙ„ ÙŠÙˆÙ…: Exercise (EN) + ÙˆØµÙ Ø¹Ø±Ø¨ÙŠ + SetsÃ—Reps + Tempo + RIR + Rest(s) + Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª + SWAP)

### 6) ${lang==='ar'?'Ø§Ù„ÙƒØ§Ø±Ø¯ÙŠÙˆ Ùˆ NEAT':'Cardio & NEAT'}
(Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ÙƒØ§Ø±Ø¯ÙŠÙˆØŒ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù†Ø¨Ø¶ØŒ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª)

### 7) ${lang==='ar'?'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª ÙˆØ§Ù„ØªØ¹Ø§ÙÙŠ':'Supplements & Recovery'}
| Ø§Ù„Ù…ÙƒÙ…Ù„ | Ø§Ù„Ø¬Ø±Ø¹Ø© | Ø§Ù„ØªÙˆÙ‚ÙŠØª | Ø§Ù„Ù‡Ø¯Ù | ØªØ­Ø°ÙŠØ±Ø§Øª |
|---|---|---|---|---|

### 8) ${lang==='ar'?'Ø®Ø·Ø© Ø§Ù„ØªÙ‚Ø¯Ù…':'Progression Plan'}
(Ù…ØªÙ‰ ØªØ²ÙŠØ¯ Ø§Ù„Ø£Ø­Ù…Ø§Ù„/Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª ÙˆÙ…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)

### 9) ${lang==='ar'?'Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ­Ù‚ÙˆÙ‚':'Legal & Rights'}
(Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø© Ø´Ø®ØµÙŠØ© ÙÙ‚Ø·)
`;
  }

  /* -------------------- RENDER RESULTS + QA + SUPPS + SWAP + EXPORT -------------------- */
  function renderAI(markdown){
    // SWAP buttons
    let md = markdown.replace(/\[SWAP:(EXERCISE|MEAL):(.*?)\]/g,(m,type,item)=>{
      const t = type.toLowerCase(); const clean = String(item).replace(/"/g,'&quot;');
      const btn = `<button type="button" data-type="${t}" data-item="${encodeURIComponent(clean)}" class="no-print inline-flex items-center gap-1 text-xs px-2 py-1 rounded-md border hover:bg-slate-50" onclick="swapItem(event)">${state.lang==='ar'?'ØªØ¨Ø¯ÙŠÙ„':'Swap'}</button>`;
      return t==='meal'? `<span class="inline-flex items-center gap-2">${item} ${btn}</span>` : `<span class="inline-flex items-center gap-2"><span class="font-semibold">${item}</span>${btn}</span>`;
    });

    const html = marked.parse(md);
    content.innerHTML = `
      <section class="card p-6">
        <div class="prose ai-prose max-w-none">${html}</div>
        <div class="mt-4 flex gap-2 no-print">
          <button class="px-3 py-2 rounded-lg border" onclick="exportJSON()">JSON</button>
          <button class="px-3 py-2 rounded-lg border" onclick="exportCSV()">CSV</button>
          <button class="px-3 py-2 rounded-lg border" onclick="window.print()">${state.lang==='ar'?'Ø·Ø¨Ø§Ø¹Ø© PDF':'Print PDF'}</button>
        </div>
        <div class="mt-6 text-xs text-slate-500 border-t pt-3">
          <div><strong>${state.lang==='ar'?'Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯':'Coach Mustafa Al-Safi â€” Certified International Coach'}</strong></div>
          <div>Powered by Mustafa Elsafy 2025</div>
        </div>
      </section>
    `;

    // Post enhancements
    dayByDayAccuracy(markdown);
    renderSupplementsPanel(markdown);
  }

  function qualityPass(markdown){
    // Strict parse + summary badges
    const struct = parsePlan(markdown);
    strictQA(struct);
  }

  function renderErrorCard(msg){
    content.innerHTML = `<section class="card p-6">
      <div class="p-4 rounded-lg border border-red-200 bg-red-50 text-red-800">
        <div class="font-bold mb-1">${state.lang==='ar'?'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©':'Error generating plan'}</div>
        <div class="text-sm">${escapeHtml(msg)}</div>
      </div></section>`;
  }

  function dayByDayAccuracy(markdown){
    const langAr = state.lang==='ar';
    const dayHeaderRx = langAr ? /(?:^|\n)Ø§Ù„ÙŠÙˆÙ…\s*(\d)\b[\s\S]*?(?=(?:\nØ§Ù„ÙŠÙˆÙ…\s*\d\b)|$)/gi
                               : /(?:^|\n)Day\s*(\d)\b[\s\S]*?(?=(?:\nDay\s*\d\b)|$)/gi;
    const blocks=[]; let m;
    while((m=dayHeaderRx.exec(markdown))!==null){ blocks.push({day:Number(m[1]), chunk:m[0]}); }
    if(!blocks.length) return;

    const wrap = document.createElement('div'); wrap.className='mt-4';
    wrap.innerHTML = `<div class="text-sm font-bold mb-2">${langAr?'ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©':'Daily Accuracy Audit'}</div>`;
    const list = document.createElement('div'); list.className='grid sm:grid-cols-2 gap-2';

    const target = state.calc; let covered=0;
    blocks.forEach(({day,chunk})=>{
      const kcalMatch = chunk.match(/(?:total|Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ)[^\d]{0,12}(\d{3,4})\s*(?:kcal|ÙƒØ§Ù„)/i);
      const pMatch = chunk.match(/(?:P|Ø¨Ø±ÙˆØªÙŠÙ†)\s*[:=]?\s*(\d{1,3})\s*g/i);
      const fMatch = chunk.match(/(?:F|Ø¯Ù‡ÙˆÙ†)\s*[:=]?\s*(\d{1,3})\s*g/i);
      const cMatch = chunk.match(/(?:C|ÙƒØ§Ø±Ø¨)\s*[:=]?\s*(\d{1,3})\s*g/i);
      const dayK = kcalMatch?Number(kcalMatch[1]):null;
      const dayP = pMatch?Number(pMatch[1]):null;
      const dayF = fMatch?Number(fMatch[1]):null;
      const dayC = cMatch?Number(cMatch[1]):null;

      const card = document.createElement('div'); card.className='day-card';
      let badgeClass='badge-warn', statusText=langAr?'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©':'Incomplete';
      if(dayK && dayP!=null && dayF!=null && dayC!=null){
        covered++;
        const dev = Math.abs(dayK-target.tdee_goal)/target.tdee_goal;
        if(dev<=0.05){badgeClass='badge-ok';statusText=langAr?'Ø¶Ù…Ù† Â±5%':'Within Â±5%';}
        else if(dev<=0.10){badgeClass='badge-warn';statusText=langAr?'Ø§Ù†Ø­Ø±Ø§Ù Ù…ØªÙˆØ³Ø·':'Moderate deviation';}
        else{badgeClass='badge-err';statusText=langAr?'Ø§Ù†Ø­Ø±Ø§Ù ÙƒØ¨ÙŠØ±':'Large deviation';}
      }
      card.innerHTML = `
        <div class="flex items-center justify-between mb-1"><div class="font-bold">${langAr?'Ø§Ù„ÙŠÙˆÙ…':'Day'} ${day}</div><span class="day-badge ${badgeClass}">${statusText}</span></div>
        <div class="text-xs text-slate-600">${langAr?'Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù':'Target'}: ${target.tdee_goal} kcal | P ${target.protein_g} | F ${target.fat_g} | C ${target.carb_g}</div>
        <div class="text-sm mt-1">${langAr?'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ':'Total'}: <b>${dayK??'â€”'}</b> kcal | P <b>${dayP??'â€”'}</b>g | F <b>${dayF??'â€”'}</b>g | C <b>${dayC??'â€”'}</b>g</div>`;
      list.appendChild(card);
    });
    wrap.appendChild(list); content.querySelector('section.card')?.appendChild(wrap);

    badgeDays.textContent = (state.lang==='ar'?'Ø£ÙŠØ§Ù… Ù…ØºØ·Ø§Ø©: ':'Days covered: ')+`${covered}/7`;
    badgeDays.className='px-2 py-1 rounded-lg text-xs '+(covered===7?'badge-ok':'badge-warn');
  }

  function renderSupplementsPanel(markdown){
    const startIdx = markdown.search(/^(?:###\s*7\)|###\s*\d+\)|###)\s*(?:Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª|Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª ÙˆØ§Ù„ØªØ¹Ø§ÙÙŠ|Supplements)/mi);
    if(startIdx===-1) return;
    const section = markdown.slice(startIdx); const endIdx = section.search(/\n###\s*\d+/m);
    const suppText = endIdx>0?section.slice(0,endIdx):section;
    const rows=[]; const rx=/^\|\s*([^|]+)\|\s*([^|]+)\|\s*([^|]+)\|\s*([^|]+)\|\s*([^|]+)\|$/gm; let r;
    while((r=rx.exec(suppText))!==null){ const [_,name,dose,timing,goal,warn]=r.map(s=>s.trim()); if(/^(?:Ø§Ù„Ù…ÙƒÙ…Ù„|Supplement)/i.test(name)) continue; rows.push({name,dose,timing,goal,warn}); }
    if(!rows.length) return;
    const panel=document.createElement('section'); panel.className='card p-6 mt-4';
    panel.innerHTML=`<h3 class="text-xl">${state.lang==='ar'?'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª ÙˆØ§Ù„ØªØ¹Ø§ÙÙŠ â€” Ø¨Ø·Ø§Ù‚Ø§Øª ØªÙ†ÙÙŠØ°ÙŠØ©':'Supplements & Recovery â€” Action Cards'}</h3>
      <p class="text-sm text-slate-600 mt-1">${state.lang==='ar'?'Ø§Ø®ØªØ± Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨ Ø­Ø§Ù„ØªÙƒ Ø§Ù„ØµØ­ÙŠØ© ÙˆØ£Ù‡Ø¯Ø§ÙÙƒ. Ø§Ø³ØªØ´Ø± Ø·Ø¨ÙŠØ¨Ùƒ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„Ø§Øª Ø·Ø¨ÙŠØ©.':'Select what fits your health goals. Consult your physician if you have medical conditions.'}</p>
      <div class="supp-grid mt-4"></div>`;
    const grid=panel.querySelector('.supp-grid');
    rows.forEach(x=>{
      const c=document.createElement('div'); c.className='supp-card';
      c.innerHTML=`<div class="text-sm font-bold mb-1">${escapeHtml(x.name)}</div>
        <div class="text-xs text-slate-600"><div><b>${state.lang==='ar'?'Ø§Ù„Ø¬Ø±Ø¹Ø©':'Dose'}:</b> ${escapeHtml(x.dose)}</div>
        <div><b>${state.lang==='ar'?'Ø§Ù„ØªÙˆÙ‚ÙŠØª':'Timing'}:</b> ${escapeHtml(x.timing)}</div>
        <div><b>${state.lang==='ar'?'Ø§Ù„Ù‡Ø¯Ù':'Goal'}:</b> ${escapeHtml(x.goal)}</div>
        <div class="mt-1 text-[11px] text-slate-500"><b>${state.lang==='ar'?'ØªØ­Ø°ÙŠØ±':'Warning'}:</b> ${escapeHtml(x.warn)}</div></div>`;
      grid.appendChild(c);
    });
    content.querySelector('section.card')?.appendChild(panel);
  }

  // Parser âœ JSON Ù…Ù†Ø¸Ù…
  function parsePlan(markdown){
    const result={nutrition:[],training:[],supplements:[],lifestyle:{steps:state.user.steps_target,pal:state.calc.pal,sleep:state.user.sleep_hours,stress:state.user.stress_level}};
    const text=markdown.replace(/\r/g,''); const dayBlockRx=/(?:^|\n)(?:Day|Ø§Ù„ÙŠÙˆÙ…)\s*(\d)\b([\s\S]*?)(?=\n(?:Day|Ø§Ù„ÙŠÙˆÙ…)\s*\d\b|$)/gi; let m;
    while((m=dayBlockRx.exec(text))!==null){ const day=Number(m[1]),chunk=m[2];
      const meals=[]; const mealRx=/(?:^|\n)\s*(?:ÙˆØ¬Ø¨Ø©|Meal|Ø§Ù„Ø¥ÙØ·Ø§Ø±|Ø§Ù„ÙØ·ÙˆØ±|Ø§Ù„ØºØ¯Ø§Ø¡|Ø§Ù„Ø¹Ø´Ø§Ø¡|Ø³Ù†Ø§Ùƒ|Snack)[^\n]*?(\d{2,4})\s*(?:kcal|ÙƒØ§Ù„)[^\n]*?(?:P|Ø¨Ø±ÙˆØªÙŠÙ†)\s*:?=?\s*(\d{1,3})\s*g[^\n]*?(?:F|Ø¯Ù‡ÙˆÙ†)\s*:?=?\s*(\d{1,3})\s*g[^\n]*?(?:C|ÙƒØ§Ø±Ø¨)\s*:?=?\s*(\d{1,3})\s*g.*$/gmi; let mm;
      while((mm=mealRx.exec(chunk))!==null){ meals.push({line:mm[0].trim(),kcal:Number(mm[1]),P:Number(mm[2]),F:Number(mm[3]),C:Number(mm[4])}); }
      const tot={kcal:(chunk.match(/(?:total|Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ)[^\d]{0,12}(\d{3,4})\s*(?:kcal|ÙƒØ§Ù„)/i)||[])[1],P:(chunk.match(/(?:P|Ø¨Ø±ÙˆØªÙŠÙ†)\s*[:=]?\s*(\d{1,3})\s*g/i)||[])[1],F:(chunk.match(/(?:F|Ø¯Ù‡ÙˆÙ†)\s*[:=]?\s*(\d{1,3})\s*g/i)||[])[1],C:(chunk.match(/(?:C|ÙƒØ§Ø±Ø¨)\s*[:=]?\s*(\d{1,3})\s*g/i)||[])[1]};
      const daily=(tot.kcal&&tot.P&&tot.F&&tot.C)?{kcal:Number(tot.kcal),P:Number(tot.P),F:Number(tot.F),C:Number(tot.C)}:null;
      const exercises=[]; const exRx=/(?:^|\n)\s*(?:\*|-|â€¢)?\s*([A-Za-z][A-Za-z0-9\s\-()\/]+)\s*:\s*.*?(?:Sets|Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª)\s*[:=]?\s*(\d{1,2}).*?(?:Reps|Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª)\s*[:=]?\s*([0-9\-xâ€“]+).*?(?:Rest|Ø§Ù„Ø±Ø§Ø­Ø©)\s*[:=]?\s*([0-9]{1,3})\s*s.*$/gmi; let ex;
      while((ex=exRx.exec(chunk))!==null){ exercises.push({name:ex[1].trim(),sets:ex[2],reps:ex[3],rest_s:ex[4]}); }
      result.nutrition.push({day,meals,total:daily}); result.training.push({day,blocks:exercises});
    }
    const suppStart=text.search(/^(?:###\s*7\)|###\s*\d+\)|###)\s*(?:Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª|Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª ÙˆØ§Ù„ØªØ¹Ø§ÙÙŠ|Supplements)/mi);
    if(suppStart>-1){ const tail=text.slice(suppStart); const next=tail.search(/\n###\s*\d+/m); const body=next>0?tail.slice(0,next):tail;
      const lineRx=/^\|\s*([^|]+)\|\s*([^|]+)\|\s*([^|]+)\|\s*([^|]+)\|\s*([^|]+)\|$/gm; let r;
      while((r=lineRx.exec(body))!==null){ const [_,name,dose,timing,goal,warn]=r.map(s=>s.trim()); if(/^(?:Ø§Ù„Ù…ÙƒÙ…Ù„|Supplement)/i.test(name)) continue; result.supplements.push({name,dose,timing,goal,warn}); }
    }
    return result;
  }

  // Strict QA + badges
  function strictQA(struct){
    const out={days:[],okDays:0}; const target=state.calc;
    struct.nutrition.sort((a,b)=>a.day-b.day).forEach(d=>{
      const tot=d.total; let devStatus='warn', kcalDev=null;
      if(tot){ const dev=Math.abs(tot.kcal-target.tdee_goal)/target.tdee_goal; kcalDev=dev; devStatus=dev<=0.05?'ok':(dev<=0.10?'warn':'err'); }
      out.days.push({day:d.day,hasTotal:!!tot,kcalDev,devStatus});
    });
    const panel=document.createElement('section'); panel.className='card p-6 section-break';
    panel.innerHTML=`<h3 class="text-xl">${state.lang==='ar'?'Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø¬ÙˆØ¯Ø©':'Final Quality Audit'}</h3><div class="qa-summary mt-2"></div>`;
    const grid=panel.querySelector('.qa-summary');
    out.days.forEach(d=>{
      const pill=document.createElement('div'); pill.className='qa-pill '+(d.devStatus==='ok'?'qa-ok':d.devStatus==='warn'?'qa-warn':'qa-err');
      pill.innerHTML=`<b>${state.lang==='ar'?'Ø§Ù„ÙŠÙˆÙ…':'Day'} ${d.day}</b> â€” ${state.lang==='ar'?'Ø¥Ø¬Ù…Ø§Ù„ÙŠ':'Total'}: ${d.hasTotal?'âœ“':'â€”'} â€¢ ${state.lang==='ar'?'Ø§Ù†Ø­Ø±Ø§Ù':'Deviation'}: ${d.kcalDev!=null?(d.kcalDev*100).toFixed(1)+'%':'â€”'}`;
      grid.appendChild(pill);
    });
    content.querySelector('section.card')?.appendChild(panel);

    const covered=out.days.filter(d=>d.day>=1&&d.day<=7).length;
    const exactOK=out.days.filter(d=>d.kcalDev!=null&&d.kcalDev<=0.05).length;
    badgeDays.textContent=(state.lang==='ar'?'Ø£ÙŠØ§Ù… Ù…ØºØ·Ø§Ø©: ':'Days covered: ')+`${covered}/7`;
    badgeDays.className='px-2 py-1 rounded-lg text-xs '+(covered===7?'badge-ok':'badge-warn');
    badgeMacros.textContent=(state.lang==='ar'?'Ø£ÙŠØ§Ù… Ø¶Ù…Ù† Â±5%: ':'Days within Â±5%: ')+`${exactOK}/7`;
    badgeMacros.className='px-2 py-1 rounded-lg text-xs '+(exactOK>=6?'badge-ok':'badge-warn');
  }

  // SWAP Ø°ÙƒÙŠ Ù…Ø¨Ø³Ø·
  async function swapItem(ev){
    const btn=ev.target.closest('button'); if(!btn) return;
    const type=btn.dataset.type; const original=decodeURIComponent(btn.dataset.item||'');
    const old=btn.textContent; btn.disabled=true; btn.textContent=state.lang==='ar'?'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„...':'Swapping...';
    try{
      const prompt = (type==='meal') ? `
User needs ONE alternative meal for: "${original}".
- Language: ${state.lang.toUpperCase()}.
- Respect diet: "${state.user.diet_preference}".
- Avoid allergens: "${(state.user.allergies||[]).join(', ')}".
- Match calories within Â±8% of ${(state.calc.tdee_goal/3|0)} per meal and protein >= 25g.
FORMAT: Single line with ingredients (grams), calories and P/F/C, ending [SWAP:MEAL:<name>]`
      : `
User needs ONE safe alternative exercise for "${original}".
- Same target muscle, EN name + short Arabic cues, include SetsÃ—Reps, Tempo, RIR, Rest(s).
- Avoid injuries: "${state.user.injuries||'None'}".
FORMAT: Single line ending [SWAP:EXERCISE:<EN name>]`;
      const res=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
      const raw=await res.text(); let data=null; try{data=raw?JSON.parse(raw):null;}catch{}
      if(!res.ok) throw new Error(data?.error||raw||'Server error');
      const txt=data?.text||'';

      if(type==='meal'){
        const kc=(txt.match(/(\d{2,4})\s*(?:kcal|ÙƒØ§Ù„)/i)||[])[1]; const P=(txt.match(/(?:P|Ø¨Ø±ÙˆØªÙŠÙ†)\s*[:=]?\s*(\d{1,3})\s*g/i)||[])[1];
        if(!(kc&&P)) throw new Error('missing macros');
        const kcal=Number(kc); const dev=Math.abs(kcal-(state.calc.tdee_goal/3))/(state.calc.tdee_goal/3);
        if(dev>0.08 || Number(P)<25) throw new Error('out of spec');
        const node=btn.parentElement; node.childNodes[0].nodeValue=txt.trim()+' '; btn.dataset.item=encodeURIComponent(txt.replace(/\[.*?\]$/,'').trim());
      }else{
        const node=btn.parentElement; const newName=(txt.match(/\[SWAP:EXERCISE:(.*?)\]/)||[])[1] || txt.split('\n')[0];
        const title=node.querySelector('.font-semibold'); if(title) title.textContent=newName.trim(); btn.dataset.item=encodeURIComponent(newName.trim());
      }
    }catch{ notify(state.lang==='ar'?'ØªØ¹Ø°Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„':'Swap failed','error'); }
    btn.disabled=false; btn.textContent=old;
  }

  // Export
  function exportJSON(){ const md=content.querySelector('.prose')?.innerText||''; const struct=parsePlan(md);
    const payload={user:state.user,calc:state.calc,...struct};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='ai-coach-plan.json'; a.click();
  }
  function exportCSV(){
    const md=content.querySelector('.prose')?.innerText||''; const struct=parsePlan(md); const rows=[];
    rows.push(['SECTION','DAY','TYPE','NAME/DESC','KCAL','P','F','C','SETS','REPS','REST']);
    struct.nutrition.sort((a,b)=>a.day-b.day).forEach(d=>{ (d.meals||[]).forEach(m=>rows.push(['NUTRITION',d.day,'MEAL',m.line,m.kcal,m.P,m.F,m.C,'','','']));
      if(d.total) rows.push(['NUTRITION',d.day,'TOTAL','â€”',d.total.kcal,d.total.P,d.total.F,d.total.C,'','','']); });
    struct.training.sort((a,b)=>a.day-b.day).forEach(d=>{ (d.blocks||[]).forEach(b=>rows.push(['TRAINING',d.day,'EXERCISE',b.name,'','','','',b.sets,b.reps,b.rest_s])); });
    (struct.supplements||[]).forEach(s=>rows.push(['SUPPLEMENT','â€”','â€”',`${s.name} | ${s.dose} | ${s.timing} | ${s.goal} | ${s.warn}`,'','','','','','','']));
    const csv=rows.map(r=>r.map(x=>`"${String(x??'').replaceAll('"','""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ai-coach-plan.csv'; a.click();
  }

  /* -------------------- UTILITIES -------------------- */
  function notify(msg,type='success'){ const el=document.createElement('div'); el.className=`fixed top-5 right-5 p-3 rounded-lg shadow text-white z-50 ${type==='error'?'bg-red-500':type==='warning'?'bg-amber-500':'bg-emerald-600'}`; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),3000); }
  function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  function lockUI(on){ try{btnPrev.disabled=!!on; btnNext.disabled=!!on; btnNext.textContent = on ? (state.lang==='ar'?'Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ†ÙÙŠØ°â€¦':'Workingâ€¦') : (state.current>=12 ? t('submit') : t('next'));}catch{} }
  function localizeResultButtons(){ const actionBtns=content.querySelectorAll('button'); actionBtns.forEach(b=>{ if(b.textContent.match(/Print|Ø·Ø¨Ø§Ø¹Ø©/)) b.textContent=state.lang==='ar'?'Ø·Ø¨Ø§Ø¹Ø© PDF':'Print PDF'; if(b.textContent==='JSON') b.textContent='JSON'; if(b.textContent==='CSV') b.textContent='CSV'; if(b.textContent.match(/ØªØ¨Ø¯ÙŠÙ„|Swap/)) b.textContent=state.lang==='ar'?'ØªØ¨Ø¯ÙŠÙ„':'Swap'; }); }

  /* -------------------- INIT -------------------- */
  setLang('ar'); state.current=0; render();
  </script>
</body>
</html>
