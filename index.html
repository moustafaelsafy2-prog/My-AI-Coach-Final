<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ | Intelligent Health Coach</title>

  <!-- Fonts & libs -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --brand:#6c5ce7; --brand-2:#00c2ff;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      --muted:#93a2b8;
    }
    html[dir="rtl"] body{font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",sans-serif}
    html[dir="ltr"] body{font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
    body{background:linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%);color:#eaf0ff}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.10);border-radius:16px}
    .title-grad{background:linear-gradient(90deg,var(--brand),var(--brand-2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:.35rem .6rem;border-radius:999px;font-size:.75rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1rem;border-radius:.8rem;font-weight:800;transition:.2s}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff}
    .btn-primary:hover{filter:brightness(1.08);transform:translateY(-1px)}
    .btn-ghost{background:rgba(255,255,255,.06);color:#eaf0ff;border:1px solid rgba(255,255,255,.12)}
    .field{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);border-radius:.7rem;padding:.65rem .8rem;outline:none;width:100%;color:#eaf0ff}
    .field::placeholder{color:#aab7cf}.field:focus{border-color:var(--brand-2);box-shadow:0 0 0 3px rgba(0,194,255,.15)}
    .section-title{font-weight:900;letter-spacing:.3px}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent)}
    .progress{height:.45rem;background:rgba(255,255,255,.10);border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand-2));width:0%;transition:width .25s ease}
    .badge{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .55rem;border-radius:.5rem;font-size:.72rem;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06)}
    .status-dot{width:.55rem;height:.55rem;border-radius:999px}
    .g{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:14px}
    html[dir="rtl"] .c1{grid-column:1/span 4} html[dir="rtl"] .c2{grid-column:5/span 4} html[dir="rtl"] .c3{grid-column:9/span 4}
    html[dir="ltr"] .c1{grid-column:1/span 4} html[dir="ltr"] .c2{grid-column:5/span 4} html[dir="ltr"] .c3{grid-column:9/span 4}
    @media (max-width:1024px){.g .c1,.g .c2,.g .c3{grid-column:1/span 12}}
    .light body,.light{background:linear-gradient(180deg,#eef2ff 0%,#f7f9ff 100%);color:#0e1526}
    .light .glass{background:linear-gradient(180deg,rgba(0,0,0,.03),rgba(0,0,0,.02));border-color:rgba(0,0,0,.10)}
    .light .field{background:rgba(0,0,0,.03);color:#0e1526;border-color:rgba(0,0,0,.12)}
    @media print{body{background:#fff;color:#111}.glass,.btn,.chip,.title-grad{all:unset}
      .ai-content h2,.ai-content h3{color:#111}
      .ai-content table{border-collapse:collapse;width:100%}
      .ai-content th,.ai-content td{border:1px solid #333;padding:.55rem;vertical-align:top}}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="sticky top-0 z-40 glass border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="size-9 rounded-xl bg-gradient-to-br from-[var(--brand)] to-[var(--brand-2)] grid place-items-center font-black">AI</div>
        <div>
          <div id="app-title" class="text-lg font-extrabold">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ</div>
          <div id="subtitle" class="text-xs text-[color:var(--muted)]">Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù Ùª Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ø®ØµØµØ© Ù„Ùƒ</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="toggle-theme" class="chip" title="Theme">â˜¾/â˜€</button>
        <button id="lang-ar" class="chip">Ø¹Ø±Ø¨ÙŠ</button>
        <button id="lang-en" class="chip">EN</button>
        <button id="btn-print" class="btn btn-ghost">ğŸ–¨</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Stepper -->
    <section class="glass p-4 mb-4">
      <div class="flex items-center justify-between gap-3">
        <div id="hint" class="text-sm text-[color:var(--muted)]"></div>
        <div class="w-56 progress"><i id="global-progress"></i></div>
      </div>
    </section>

    <!-- Wizard -->
    <section id="wizard" class="glass p-4">
      <div class="section-title title-grad text-xl mb-3" id="step-title">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
      <div id="step-body"></div>
      <div class="divider my-4"></div>
      <div class="flex items-center justify-between">
        <div id="live-hint" class="text-xs text-[color:var(--muted)]">â€”</div>
        <div class="flex items-center gap-2">
          <button id="prev" class="btn btn-ghost" disabled>â—€ <span id="t-prev">Ø§Ù„Ø³Ø§Ø¨Ù‚</span></button>
          <button id="next" class="btn btn-primary"><span id="t-next">Ø§Ù„ØªØ§Ù„ÙŠ</span> â–¶</button>
          <button id="generate-current" class="btn btn-primary">âš¡ <span id="t-generate">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</span></button>
        </div>
      </div>
    </section>

    <!-- Plan -->
    <section class="glass p-5 mt-6">
      <div class="flex items-center justify-between">
        <div id="plan-title" class="section-title text-lg">Ø§Ù„Ø®Ø·Ø©</div>
        <div class="badge"><i id="run-dot" class="status-dot" style="background:#888"></i><span id="run-label">Idle</span></div>
      </div>

      <div class="my-3">
        <div class="w-full progress"><i id="run-progress"></i></div>
        <div id="run-msg" class="text-xs mt-1 text-[color:var(--muted)]">â€”</div>
      </div>

      <div id="sections-board" class="flex flex-wrap gap-2 my-2"></div>
      <div id="plan-content" class="ai-content space-y-4"></div>
    </section>

    <section class="flex items-center justify-end gap-2 mt-5">
      <button id="scroll-top" class="btn btn-ghost">â†‘ <span id="t-top">Ø£Ø¹Ù„Ù‰</span></button>
      <button id="print-bottom" class="btn btn-primary">ğŸ–¨ <span id="t-print2">Ø·Ø¨Ø§Ø¹Ø© / PDF</span></button>
    </section>

    <footer class="text-center text-xs text-[color:var(--muted)] mt-6">
      2025 Â© Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Powered by <strong>Coach Mustafa Elsafy</strong>
    </footer>
  </main>

<script>
/* ===================== CONFIG ===================== */
/* âœ… Root endpoint in prod; localhost when dev */
const ENDPOINT =
  (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
    ? 'http://localhost:8888/.netlify/functions/gemini-proxy'
    : '/.netlify/functions/gemini-proxy';

/* Models fallback rotation to reduce â€œBoth endpoints failedâ€ */
const MODELS = [
  'gemini-1.5-pro',
  'gemini-1.5-flash',
  'gemini-2.0-flash-exp' // if not available, server will ignore and next retry will use first ones again
];

/* single-flight queue: avoid parallel hitting the function */
let queue = Promise.resolve();

/* ===================== STATE ===================== */
const state = {
  lang:(navigator.language||'ar').startsWith('ar')?'ar':'en',
  theme:'dark',
  step:0,
  currency:detectCurrency(),
  profile:{name:'',age:'',height:'',weight:'',bodyFat:'',waist:'',sex:'Male',targetWeight:'',targetDate:''},
  diet:{goals:[],mealsPerDay:3,preferredDiet:'Balanced',cuisine:'Arabic/Mediter.',prepTime:20,monthlyBudget:0,foodsToAvoid:'',allergies:'',fasting:'off'},
  lifestyle:{workActivity:'Sedentary',stepsPerDay:6000,sleep:'Low',stress:'Low',trainingPlace:'Home/Gym',sessionLength:60,availableDays:[],equipment:'',experience:'Beginner (0-6m)',rpe:8,caffeine:0,injuries:''},
  fitness:{restingHR:'',maxPushups:'',plank:'',kmTime:''},
  muscles:{chest:{on:false,note:''},back:{on:false,note:''},shoulders:{on:false,note:''},biceps:{on:false,note:''},triceps:{on:false,note:''},quads:{on:false,note:''},hamstrings:{on:false,note:''},glutes:{on:false,note:''},calves:{on:false,note:''},abs:{on:false,note:''}},
  medical:{conditions:[],other:'',meds:'',supplements:''},
  challenges:{past:'',motivation:'Direct'},
  targets:null,
  sections:[
    'welcome','analysis','allowed','fasting',
    'nutrition-day-1','nutrition-day-2','nutrition-day-3','nutrition-day-4','nutrition-day-5','nutrition-day-6','nutrition-day-7',
    'training-day-1','training-day-2','training-day-3','training-day-4','training-day-5','training-day-6','training-day-7',
    'supplements','progression','troubleshoot','safety','closing'
  ],
  sectionStatus:{}
};

/* ===================== I18N ===================== */
const T={
  ar:{appTitle:'Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ',subtitle:'Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù Ùª Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ø®ØµØµØ© Ù„Ùƒ',hint:'Ø³Ù†ÙÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆÙŠØ¸Ù‡Ø± ÙƒÙ„ Ù‚Ø³Ù… Ø¨Ù…Ø¬Ø±Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØªÙ‡.',
    steps:['Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ','Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª','Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©','Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª'],
    next:'Ø§Ù„ØªØ§Ù„ÙŠ',prev:'Ø§Ù„Ø³Ø§Ø¨Ù‚',generate:'ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ',top:'Ø£Ø¹Ù„Ù‰',print2:'Ø·Ø¨Ø§Ø¹Ø© / PDF',
    profile:'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',dietPrefs:'Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª',lifestyle:'Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©',med:'Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª',
    name:'Ø§Ù„Ø§Ø³Ù…',age:'Ø§Ù„Ø¹Ù…Ø±',height:'Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)',weight:'Ø§Ù„ÙˆØ²Ù† (ÙƒØº)',bodyFat:'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† % (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',waist:'Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ± (Ø³Ù…) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',sex:'Ø§Ù„Ø¬Ù†Ø³',
    male:'Ø°ÙƒØ±',female:'Ø£Ù†Ø«Ù‰',targetWeight:'Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (ÙƒØº)',targetDate:'Ù…ÙˆØ¹Ø¯ ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù (ØªØ§Ø±ÙŠØ®)',
    goals:'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù',fatLoss:'Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†',build:'Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª',strength:'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©',endurance:'Ø§Ù„ØªØ­Ù…Ù„',health:'ØµØ­Ø© Ø¹Ø§Ù…Ø©',
    mealsPerDay:'Ø§Ù„ÙˆØ¬Ø¨Ø§Øª/Ø§Ù„ÙŠÙˆÙ…',preferredDiet:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù„',balanced:'Ù…ØªÙˆØ§Ø²Ù†',lowCarb:'Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª',keto:'ÙƒÙŠØªÙˆ',medc:'Ù…ØªÙˆØ³Ø·ÙŠ/Ø¹Ø±Ø¨ÙŠ',veg:'Ù†Ø¨Ø§ØªÙŠ/Ù…Ø±Ù†',
    fasting:'Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹',off:'ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„',f16:'16:8',f18:'18:6',f20:'20:4',cuisine:'Ø§Ù„Ù…Ø·Ø¨Ø®',prepTime:'ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø¯)',budget:'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©',
    foodsAvoid:'Ø£Ø·Ø¹Ù…Ø© Ù„Ø§ ØªØ±ØºØ¨ Ø¨Ù‡Ø§/Ø­Ø³Ø§Ø³ÙŠØ§Øª',allergies:'Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø´Ø§Ø¦Ø¹Ø©',workActivity:'Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¹Ù…Ù„',steps:'Ø§Ù„Ø®Ø·ÙˆØ§Øª/Ø§Ù„ÙŠÙˆÙ…',sleep:'Ø§Ù„Ù†ÙˆÙ…',stress:'Ø§Ù„ØªÙˆØªØ±',
    place:'Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ…Ø±ÙŠÙ†',session:'Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯)',days:'Ø£ÙŠØ§Ù… Ø§Ù„ØªÙ…Ø±ÙŠÙ†',equipment:'Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©',experience:'Ø§Ù„Ø®Ø¨Ø±Ø©',rpe:'RPE',caffeine:'ÙƒØ§ÙÙŠÙŠÙ†/Ø£ÙƒÙˆØ§Ø¨',injuries:'Ø¥ØµØ§Ø¨Ø§Øª/Ù‚ÙŠÙˆØ¯',
    quick:'Ø§Ø®ØªØ¨Ø§Ø± Ù„ÙŠØ§Ù‚Ø© Ù…Ø¨Ø³Ù‘Ø·',restingHR:'Ù†Ø¨Ø¶ Ø§Ù„Ø±Ø§Ø­Ø© (bpm)',pushups:'Ø£Ù‚ØµÙ‰ Push-ups',plank:'Plank (Ø¯)',kmTime:'Ø²Ù…Ù† 1 ÙƒÙ… (Ø¯:Ø«)',
    musclesFocus:'Ø¹Ø¶Ù„Ø§Øª ØªØ­ØªØ§Ø¬ Ø¹Ù†Ø§ÙŠØ©',describe:'ÙˆØµÙ/Ø³Ø¨Ø¨',
    medicalStatus:'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©',otherCond:'Ø£Ù…Ø±Ø§Ø¶ Ø£Ø®Ø±Ù‰',currentMeds:'Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ©',currentSupp:'Ù…ÙƒÙ…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ©',
    pastCh:'ØªØ­Ø¯ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©',motiv:'Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØ­ÙÙŠØ²',motivDir:'Ø¹Ù…Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±',motivWarm:'ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…',
    plan:'Ø§Ù„Ø®Ø·Ø©',idle:'Ø¬Ø§Ù‡Ø²',gen:'ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯â€¦',done:'Ø§ÙƒØªÙ…Ù„',failed:'ÙØ´Ù„',retry:'Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…',
    waitMsg:'Ø³ÙŠØ¸Ù‡Ø± ÙƒÙ„ Ù‚Ø³Ù… ÙÙˆØ± ØªÙˆÙ„ÙŠØ¯Ù‡ â€” Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±â€¦'
  },
  en:{appTitle:'Intelligent Health Coach',subtitle:'100% precise plan for nutrition, training & supplements â€” fully personalized',hint:'Sections are generated sequentially and appear as soon as they are ready.',
    steps:['Profile','Diet & Preferences','Lifestyle','Medical & Challenges'],
    next:'Next',prev:'Back',generate:'Generate current section',top:'Top',print2:'Print / PDF',
    profile:'Profile',dietPrefs:'Diet & Preferences',lifestyle:'Lifestyle',med:'Medical & Challenges',
    name:'Name',age:'Age',height:'Height (cm)',weight:'Weight (kg)',bodyFat:'Body fat % (optional)',waist:'Waist (cm) (optional)',sex:'Sex',
    male:'Male',female:'Female',targetWeight:'Target weight (kg)',targetDate:'Target date',
    goals:'Goals',fatLoss:'Fat loss',build:'Build muscle',strength:'Strength',endurance:'Endurance',health:'General health',
    mealsPerDay:'Meals/day',preferredDiet:'Preferred diet',balanced:'Balanced',lowCarb:'Low-carb',keto:'Keto',medc:'Mediterranean/Arabic',veg:'Plant-forward',
    fasting:'Intermittent fasting',off:'Off',f16:'16:8',f18:'18:6',f20:'20:4',cuisine:'Cuisine',prepTime:'Prep time (min)',budget:'Monthly budget',
    foodsAvoid:'Foods to avoid / dislikes',allergies:'Common allergies',workActivity:'Work/Activity',steps:'Steps/day',sleep:'Sleep',stress:'Stress',
    place:'Training place',session:'Session length (min)',days:'Available training days',equipment:'Available equipment',experience:'Experience',rpe:'RPE',caffeine:'Caffeine/day (cups)',injuries:'Injuries/constraints',
    quick:'Quick fitness test',restingHR:'Resting HR (bpm)',pushups:'Max push-ups',plank:'Plank (min)',kmTime:'1 km time (m:s)',
    musclesFocus:'Muscles needing focus',describe:'Describe issue/reason',
    medicalStatus:'Medical status',otherCond:'Other conditions',currentMeds:'Current medications',currentSupp:'Current supplements',
    pastCh:'Past challenges',motiv:'Preferred motivation',motivDir:'Direct & pragmatic',motivWarm:'Supportive & encouraging',
    plan:'Plan',idle:'Idle',gen:'Generatingâ€¦',done:'Done',failed:'Failed',retry:'Retry this section',
    waitMsg:'Each section will appear as soon as itâ€™s generated. Please waitâ€¦'
  }
};
const t=(k)=> (T[state.lang]&&T[state.lang][k])||k;

/* ===================== HELPERS ===================== */
function detectCurrency(){
  try{
    const loc=Intl.DateTimeFormat().resolvedOptions().locale||navigator.language||'en-US';
    if(loc.includes('EG'))return 'EGP'; if(loc.includes('SA'))return 'SAR'; if(loc.includes('AE'))return 'AED';
    if(loc.includes('QA'))return 'QAR'; if(loc.includes('KW'))return 'KWD'; if(loc.includes('GB'))return 'GBP';
    if(/(DE|FR|IT|ES)/.test(loc))return 'EUR'; return 'USD';
  }catch{ return 'USD'; }
}
function esc(s){return (s??'').toString().replace(/"/g,'&quot;')}
function Lbl(label,id,value='',ph=''){return `<label class="block mb-2"><div class="mb-1">${label}</div><input id="${id}" class="field" value="${esc(value)}" placeholder="${ph}"></label>`}
function Num(label,id,value='',ph=''){return `<label class="block mb-2"><div class="mb-1">${label}</div><input id="${id}" inputmode="numeric" pattern="[0-9]*" class="field" value="${esc(value)}" placeholder="${ph}"></label>`}

/* ===================== UI ===================== */
function setLang(lang){
  state.lang=lang; document.documentElement.lang=lang; document.documentElement.dir=(lang==='ar'?'rtl':'ltr');
  id('app-title').textContent=t('appTitle'); id('subtitle').textContent=t('subtitle'); id('hint').textContent=t('hint');
  id('t-prev').textContent=t('prev'); id('t-next').textContent=t('next'); id('t-generate').textContent=t('generate');
  id('t-top').textContent=t('top'); id('t-print2').textContent=t('print2'); id('plan-title').textContent=t('plan');
  renderStep(); renderBoard();
}
function setTheme(mode){state.theme=mode; if(mode==='light')document.documentElement.classList.add('light'); else document.documentElement.classList.remove('light')}
function id(x){return document.getElementById(x)}

function renderStep(){
  const titles=T[state.lang].steps; id('step-title').textContent=titles[state.step];
  const el=id('step-body');

  if(state.step===0){
    el.innerHTML=`
      <div class="g">
        <div class="glass p-4 c1">
          <div class="section-title mb-2">${t('profile')}</div>
          ${Lbl(t('name'),'name',state.profile.name,t('name'))}
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('age'),'age',state.profile.age)}
            <label class="block mb-2"><div class="mb-1">${t('sex')}</div>
              <select id="sex" class="field">
                <option value="Male">${t('male')}</option>
                <option value="Female">${t('female')}</option>
              </select>
            </label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('height'),'height',state.profile.height)} ${Num(t('weight'),'weight',state.profile.weight)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('bodyFat'),'bodyFat',state.profile.bodyFat)} ${Num(t('waist'),'waist',state.profile.waist)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('targetWeight'),'targetWeight',state.profile.targetWeight)}
            <label class="block mb-2"><div class="mb-1">${t('targetDate')}</div><input id="targetDate" type="date" class="field" value="${esc(state.profile.targetDate)}"></label>
          </div>
        </div>

        <div class="glass p-4 c2">
          <div class="section-title mb-2">${t('dietPrefs')}</div>
          <div class="mb-2">${t('goals')}</div>
          <div class="grid grid-cols-2 gap-2 mb-2">
            ${['fatLoss','build','strength','endurance','health'].map(k=>`
              <label class="flex items-center gap-2">
                <input type="checkbox" id="g-${k}" class="accent-[var(--brand-2)]" ${state.diet.goals.includes(k)?'checked':''}>
                <span>${t(k)}</span>
              </label>`).join('')}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('mealsPerDay'),'meals',state.diet.mealsPerDay)}
            <label class="block mb-2"><div class="mb-1">${t('preferredDiet')}</div>
              <select id="prefDiet" class="field">
                <option value="Balanced">${t('balanced')}</option><option value="LowCarb">${t('lowCarb')}</option>
                <option value="Keto">${t('keto')}</option><option value="Arabic/Mediter.">${t('medc')}</option>
                <option value="Plant">${t('veg')}</option>
              </select>
            </label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('fasting')}</div>
              <select id="fasting" class="field">
                <option value="off">${t('off')}</option><option value="16:8">${t('f16')}</option>
                <option value="18:6">${t('f18')}</option><option value="20:4">${t('f20')}</option>
              </select>
            </label>
            ${Lbl(t('cuisine'),'cuisine',state.diet.cuisine)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('prepTime'),'prep',state.diet.prepTime)}
            <label class="block mb-2"><div class="mb-1">${t('budget')}</div>
              <div class="flex gap-2">
                <input id="budget" class="field flex-1" inputmode="numeric" value="${esc(state.diet.monthlyBudget)}">
                <select id="currency" class="field w-28">
                  ${['USD','EUR','GBP','SAR','AED','KWD','QAR','EGP'].map(c=>`<option ${state.currency===c?'selected':''}>${c}</option>`).join('')}
                </select>
              </div>
            </label>
          </div>
          ${Lbl(t('foodsAvoid'),'avoid',state.diet.foodsToAvoid,"Ù…Ø«Ø§Ù„: Ù„Ø§ Ø£Ø­Ø¨ Ø§Ù„Ø³Ù…Ùƒâ€¦")}
          ${Lbl(t('allergies'),'allergies',state.diet.allergies,"Gluten, Lactoseâ€¦")}
        </div>

        <div class="glass p-4 c3">
          <div class="section-title mb-2">${t('lifestyle')}</div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('workActivity')}</div>
              <select id="work" class="field"><option value="Sedentary">Sedentary</option><option value="Light">Light</option><option value="Moderate">Moderate</option><option value="High">High</option></select>
            </label>
            ${Num(t('steps'),'steps',state.lifestyle.stepsPerDay)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('sleep')}</div>
              <select id="sleep" class="field"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option></select>
            </label>
            <label class="block mb-2"><div class="mb-1">${t('stress')}</div>
              <select id="stress" class="field"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option></select>
            </label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Lbl(t('place'),'place',state.lifestyle.trainingPlace)} ${Num(t('session'),'session',state.lifestyle.sessionLength)}
          </div>
          <div class="mb-2">
            <div class="mb-1">${t('days')}</div>
            <div class="grid grid-cols-7 gap-2 text-xs">
              ${(state.lang==='ar'?['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©']:['Sat','Sun','Mon','Tue','Wed','Thu','Fri'])
                .map((d,i)=>`<label class="flex items-center gap-1 bg-white/5 px-2 py-1 rounded-md border border-white/10"><input type="checkbox" id="day-${i}" class="accent-[var(--brand-2)]"><span>${d}</span></label>`).join('')}
            </div>
          </div>
          ${Lbl(t('equipment'),'equip',state.lifestyle.equipment,'Dumbbells, barbell, bandsâ€¦')}
          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('experience')}</div>
              <select id="exp" class="field"><option>Beginner (0-6m)</option><option>Intermediate (6-24m)</option><option>Advanced (24m+)</option></select>
            </label>
            ${Num(t('rpe'),'rpe',state.lifestyle.rpe)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('caffeine'),'caf',state.lifestyle.caffeine)} ${Lbl(t('injuries'),'inj',state.lifestyle.injuries,'Shoulder impingementâ€¦')}
          </div>
        </div>
      </div>`;
    id('sex').value=state.profile.sex||'Male';
    id('prefDiet').value=state.diet.preferredDiet; id('fasting').value=state.diet.fasting; id('currency').value=state.currency;
    id('work').value=state.lifestyle.workActivity; id('sleep').value=state.lifestyle.sleep; id('stress').value=state.lifestyle.stress; id('exp').value=state.lifestyle.experience;
    (state.lifestyle.availableDays||[]).forEach(i=>{const el=id('day-'+i); if(el) el.checked=true;});
  }

  if(state.step===1){
    el.innerHTML=`
      <div class="glass p-4">
        <div class="section-title mb-2">${t('quick')}</div>
        <div class="grid grid-cols-2 gap-2">
          ${Num(t('restingHR'),'q-hr',state.fitness.restingHR)} ${Num(t('pushups'),'q-pu',state.fitness.maxPushups)}
        </div>
        <div class="grid grid-cols-2 gap-2">
          ${Num(t('plank'),'q-pl',state.fitness.plank)} ${Lbl(t('kmTime'),'q-km',state.fitness.kmTime,'5:30')}
        </div>
      </div>`;
  }

  if(state.step===2){
    el.innerHTML=`
      <div class="glass p-4">
        <div class="section-title mb-2">${t('musclesFocus')}</div>
        ${['chest','back','shoulders','biceps','triceps','quads','hamstrings','glutes','calves','abs'].map(k=>{
          const ar={chest:'Ø§Ù„ØµØ¯Ø±',back:'Ø§Ù„Ø¸Ù‡Ø±',shoulders:'Ø§Ù„Ø£ÙƒØªØ§Ù',biceps:'Ø§Ù„Ø¨Ø§ÙŠØ³Ø¨Ø³',triceps:'Ø§Ù„ØªØ±Ø§ÙŠØ³Ø¨Ø³',quads:'Ø§Ù„Ø£Ø±Ø¬Ù„ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©',hamstrings:'Ø§Ù„Ø£Ø±Ø¬Ù„ Ø§Ù„Ø®Ù„ÙÙŠØ©',glutes:'Ø§Ù„Ù…Ø¤Ø®Ø±Ø©',calves:'Ø§Ù„Ø³Ù…Ø§Ù†Ø©',abs:'Ø§Ù„Ø¨Ø·Ù†'};
          const lab=(state.lang==='ar'?ar[k]:k[0].toUpperCase()+k.slice(1)), v=state.muscles[k];
          return `<div class="grid grid-cols-2 gap-2 items-center mb-2">
            <label class="flex items-center gap-2"><input type="checkbox" id="m-${k}" class="accent-[var(--brand-2)]" ${v.on?'checked':''}><span>${lab}</span></label>
            <input id="mnote-${k}" class="field" value="${esc(v.note)}" placeholder="${t('describe')}">
          </div>`;}).join('')}
      </div>`;
  }

  if(state.step===3){
    const items=[['Hypertension','Ø¶ØºØ· Ø§Ù„Ø¯Ù…'],['Diabetes','Ø§Ù„Ø³ÙƒØ±ÙŠ'],['Insulin Resistance','Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†'],['Thyroid issues','Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØºØ¯Ø©'],['Hormonal issues','Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©'],['Fatty Liver','Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ'],['Joint/Knee problems','Ù…Ø´Ø§ÙƒÙ„ Ù…ÙØ§ØµÙ„/Ø±ÙƒØ¨'],['Heart disease','Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨'],['IBD/Ulcer','IBD/Ù‚Ø±Ø­Ø©'],['GERD/Reflux','GERD/Ø§Ø±ØªØ¬Ø§Ø¹'],['Gluten intolerance','Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†'],['Lactose intolerance','Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²']];
    el.innerHTML=`
      <div class="g">
        <div class="glass p-4 c1">
          <div class="section-title mb-2">${t('medicalStatus')}</div>
          <div class="grid md:grid-cols-2 gap-2 mb-2">
            ${items.map(([en,ar],i)=>{const lab=(state.lang==='ar'?ar:en); const chkd=state.medical.conditions.includes(en);
              return `<label class="flex items-center gap-2"><input type="checkbox" id="cond-${i}" class="accent-[var(--brand-2)]" ${chkd?'checked':''}><span>${lab}</span></label>`}).join('')}
          </div>
          ${Lbl(t('otherCond'),'otherCond',state.medical.other)} ${Lbl(t('currentMeds'),'meds',state.medical.meds)} ${Lbl(t('currentSupp'),'supps',state.medical.supplements)}
        </div>
        <div class="glass p-4 c2">
          ${Lbl(t('pastCh'),'past',state.challenges.past,'Ø¬ÙˆØ¹ Ø´Ø¯ÙŠØ¯â€¦')}
          <label class="block mb-2"><div class="mb-1">${t('motiv')}</div>
            <select id="motiv" class="field"><option value="Direct">${t('motivDir')}</option><option value="Warm">${t('motivWarm')}</option></select>
          </label>
        </div>
        <div class="glass p-4 c3">
          <div class="section-title mb-2">${t('plan')}</div>
          <div class="text-sm text-[color:var(--muted)]">${t('waitMsg')}</div>
        </div>
      </div>`;
    id('motiv').value=state.challenges.motivation;
  }

  id('live-hint').textContent=t('hint');
  id('prev').disabled=(state.step===0);
  id('next').disabled=(state.step===3);
}

function saveStep(){
  const $=(x)=>id(x);
  if(state.step===0){
    state.profile.name=$('name').value.trim(); state.profile.age=$('age').value.trim();
    state.profile.height=$('height').value.trim(); state.profile.weight=$('weight').value.trim();
    state.profile.bodyFat=$('bodyFat').value.trim(); state.profile.waist=$('waist').value.trim();
    state.profile.sex=$('sex').value; state.profile.targetWeight=$('targetWeight').value.trim(); state.profile.targetDate=$('targetDate').value;

    const goals=[]; ['fatLoss','build','strength','endurance','health'].forEach(k=>{ if($('g-'+k)?.checked) goals.push(k) }); state.diet.goals=goals;
    state.diet.mealsPerDay=Number($('meals').value||3); state.diet.preferredDiet=$('prefDiet').value; state.diet.fasting=$('fasting').value;
    state.diet.cuisine=$('cuisine').value; state.diet.prepTime=Number($('prep').value||20);
    state.diet.monthlyBudget=Number($('budget').value||0); state.currency=$('currency').value;
    state.diet.foodsToAvoid=$('avoid').value; state.diet.allergies=$('allergies').value;

    state.lifestyle.workActivity=$('work').value; state.lifestyle.stepsPerDay=Number($('steps').value||6000);
    state.lifestyle.sleep=$('sleep').value; state.lifestyle.stress=$('stress').value;
    state.lifestyle.trainingPlace=$('place').value; state.lifestyle.sessionLength=Number($('session').value||60);
    state.lifestyle.availableDays=[]; for(let i=0;i<7;i++) if($('day-'+i)?.checked) state.lifestyle.availableDays.push(i);
    state.lifestyle.equipment=$('equip').value; state.lifestyle.experience=$('exp').value;
    state.lifestyle.rpe=Number($('rpe').value||8); state.lifestyle.caffeine=Number($('caf').value||0); state.lifestyle.injuries=$('inj').value;
  }
  if(state.step===1){ state.fitness.restingHR=$('q-hr').value; state.fitness.maxPushups=$('q-pu').value; state.fitness.plank=$('q-pl').value; state.fitness.kmTime=$('q-km').value; }
  if(state.step===2){ Object.keys(state.muscles).forEach(k=>{ const c=id('m-'+k), n=id('mnote-'+k); if(c) state.muscles[k].on=c.checked; if(n) state.muscles[k].note=n.value; }); }
  if(state.step===3){
    const map=['Hypertension','Diabetes','Insulin Resistance','Thyroid issues','Hormonal issues','Fatty Liver','Joint/Knee problems','Heart disease','IBD/Ulcer','GERD/Reflux','Gluten intolerance','Lactose intolerance'];
    state.medical.conditions=[]; for(let i=0;i<12;i++){const el=id('cond-'+i); if(el && el.checked) state.medical.conditions.push(map[i]);}
    state.medical.other=$('otherCond').value; state.medical.meds=$('meds').value; state.medical.supplements=$('supps').value;
    state.challenges.past=$('past').value; state.challenges.motivation=$('motiv').value;
  }
}

/* ===================== BOARD ===================== */
function renderBoard(){
  const board=id('sections-board'); board.innerHTML='';
  const list=state.sections.filter(s=> s!=='fasting' || state.diet.fasting!=='off');
  list.forEach(sec=>{
    if(!state.sectionStatus[sec]) state.sectionStatus[sec]={status:'idle'};
    const st=state.sectionStatus[sec].status;
    const color = st==='ok'?'var(--ok)':st==='fail'?'var(--err)':st==='run'?'var(--warn)':'#888';
    const b=document.createElement('button');
    b.className='badge'; b.innerHTML=`<span class="status-dot" style="background:${color}"></span><span>${pretty(sec)}</span>`;
    b.onclick=()=>{const card=id('sec-'+sec); if(card) card.scrollIntoView({behavior:'smooth',block:'center'});};
    board.appendChild(b);
  });
}
const pretty=(idstr)=>{
  if(idstr==='welcome') return state.lang==='ar'?'Ø§Ù„ØªØ±Ø­ÙŠØ¨':'Welcome';
  if(idstr==='analysis') return state.lang==='ar'?'Ø§Ù„ØªØ­Ù„ÙŠÙ„':'Analysis';
  if(idstr==='allowed') return state.lang==='ar'?'Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹':'Allowed / Limits';
  if(idstr==='fasting') return state.lang==='ar'?'Ø§Ù„ØµÙŠØ§Ù…':'Fasting';
  if(idstr.startsWith('nutrition-day')) return (state.lang==='ar'?'Ø§Ù„ØªØºØ°ÙŠØ© â€” ÙŠÙˆÙ… ':'Nutrition â€” Day ')+idstr.split('-').pop();
  if(idstr.startsWith('training-day')) return (state.lang==='ar'?'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ â€” ÙŠÙˆÙ… ':'Training â€” Day ')+idstr.split('-').pop();
  if(idstr==='supplements') return state.lang==='ar'?'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª':'Supplements';
  if(idstr==='progression') return state.lang==='ar'?'Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…':'Progression';
  if(idstr==='troubleshoot') return state.lang==='ar'?'Ø§Ù„Ù…Ø´Ø§ÙƒÙ„':'Troubleshooting';
  if(idstr==='safety') return state.lang==='ar'?'Ø§Ù„Ø³Ù„Ø§Ù…Ø©':'Safety';
  if(idstr==='closing') return state.lang==='ar'?'Ø§Ù„Ø®ØªØ§Ù…':'Closing';
  return idstr;
};

/* ===================== TARGETS & PROMPTS ===================== */
function computeTargets(){
  const p=state.profile,L=state.lifestyle,D=state.diet;
  const W=+p.weight||0,H=+p.height||0,A=+p.age||0;
  const male=(p.sex==='Male'||p.sex===t('male'));
  const BMR= male? 10*W+6.25*H-5*A+5 : 10*W+6.25*H-5*A-161;
  const act={'Sedentary':1.2,'Light':1.35,'Moderate':1.5,'High':1.7}[L.workActivity]||1.35;
  let TDEE=BMR*act; if(D.goals.includes('fatLoss')) TDEE*=0.86; if(D.goals.includes('build')) TDEE*=1.10;
  const targetW=Number(p.targetWeight)||W||1; let protein=Math.round(2.0*targetW); let fat=Math.round(Math.max(0.8*W,40));
  let carbs=Math.round((TDEE-(protein*4+fat*9))/4);
  const hasIR=state.medical.conditions.includes('Diabetes')||state.medical.conditions.includes('Insulin Resistance');
  if(hasIR) carbs=Math.min(carbs,120); carbs=Math.max(40,carbs);
  return {bmr:Math.round(BMR),tdee:Math.round(TDEE),protein_g:protein,fat_g:fat,carb_g:carbs};
}
function headerBlock(){
  const P=state.profile,D=state.diet,L=state.lifestyle,F=state.fitness,T=state.targets;
  const weak=Object.entries(state.muscles).filter(([k,v])=>v.on).map(([k,v])=>`${k}: ${v.note}`).join(', ')||'None';
  const med=state.medical.conditions.join(', ')||'None';
  const days=(state.lang==='ar'?['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©']:['Sat','Sun','Mon','Tue','Wed','Thu','Fri']);
  const avail=L.availableDays.map(i=>days[i]).join(', ')||(state.lang==='ar'?'ØºÙŠØ± Ù…Ø­Ø¯Ø¯':'Not specified');
  const tone=state.challenges.motivation==='Direct'?(state.lang==='ar'?'Ø¹Ù…Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø± Ø¨Ù„Ø§ Ù…Ø¨Ø§Ù„ØºØ©':'Pragmatic, direct, no fluff'):(state.lang==='ar'?'ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…':'Supportive & warm');
  const goalsLocalized=state.diet.goals.map(k=>t(k)).join(', ');
  return `Name:${P.name} | Sex:${P.sex} | Age:${P.age} | H:${P.height}cm | W:${P.weight}kg
Goals:${goalsLocalized} | Diet:${D.preferredDiet} | Meals:${D.mealsPerDay} | Fast:${D.fasting}
Cuisine:${D.cuisine} | Prep:${D.prepTime}min | Budget:${state.currency} ${D.monthlyBudget}
Activity:${L.workActivity} | Steps:${L.stepsPerDay} | Sleep:${L.sleep} | Stress:${L.stress}
Training:${L.trainingPlace} | Session:${L.sessionLength}min | Days:${avail} | RPE:${L.rpe} | Equip:${L.equipment||'Bodyweight'}
Fitness: HR ${F.restingHR||'?'}; PU ${F.maxPushups||'?'}; Plank ${F.plank||'?'}; 1km ${F.kmTime||'?'}
Weak:${weak} | Injuries:${L.injuries||'None'} | Medical:${med}
Targets: ~${T.tdee} kcal; P ${T.protein_g}g / F ${T.fat_g}g / C ${T.carb_g}g
Tone:${tone}. LANGUAGE:${state.lang}. FOOD in ${state.lang}. Exercises EN only.`.trim();
}
function promptFor(section){
  const H=headerBlock();
  const forceLong = state.lang==='ar'
    ? '\n\nÙ„Ø§ ØªØ®ØªØµØ± Ø£Ø¨Ø¯Ù‹Ø§. Ø£Ø¹Ø·Ù Ù…Ø®Ø±Ø¬Ø§Øª ØªÙØµÙŠÙ„ÙŠØ© ÙƒØ§Ù…Ù„Ø©.'
    : '\n\nDo NOT be brief. Provide fully detailed outputs.';
  if(section==='welcome') return `${H}\n\nCreate a professional ${state.lang} welcome (1â€“2 short paragraphs).${forceLong}`;
  if(section==='analysis') return `${H}\n\nDetailed ${state.lang} analysis in bullets with clear logic behind macros, constraints, and plan.${forceLong}`;
  if(section==='allowed') return `${H}\n\nTwo lists in ${state.lang}: 1) Allowed/Recommended foods by cuisine. 2) Limits/Avoid (respect allergies/dislikes).${forceLong}`;
  if(section==='fasting' && state.diet.fasting!=='off') return `${H}\n\nExplain ${state.diet.fasting} intermittent fasting in ${state.lang}: timings, hydration, caffeine, training window, safety.${forceLong}`;

  if(section.startsWith('nutrition-day')){
    const d=+section.split('-').pop();
    return `${H}

STRICT OUTPUT: Markdown table ONLY. No prose.
Columns: | Meal | Ingredients (g) | kcal | Protein | Fat | Carbs |
Rows: 3 main meals + TOTAL row (4 rows in total).
Daily macros MUST be within Â±10% of the Targets.
Language: ${state.lang}. Day ${d} of 7.${forceLong}`;
  }
  if(section.startsWith('training-day')){
    const d=+section.split('-').pop();
    return `${H}

STRICT OUTPUT: Markdown table ONLY.
Columns: | Day | Exercise | Sets | Reps | Rest (sec) |
Include warm-up first row if needed. Respect injuries and focus weak muscles.
Day ${d} of 7.${forceLong}`;
  }
  if(section==='supplements') return `${H}\n\nEvidence-based supplements in ${state.lang}: essential, goal-specific, budget â€” with dosing/timing. Add brief medical disclaimer.${forceLong}`;
  if(section==='progression') return `${H}\n\n8â€“12 week progression in ${state.lang}: adjust weights/reps/rest, deloads, cardio, and how to recalc TDEE on weight change.${forceLong}`;
  if(section==='troubleshoot') return `${H}\n\nTroubleshooting in ${state.lang}: hunger, plateaus, poor sleep, stress, cravings, travel/eating out (2â€“3 bullets each).${forceLong}`;
  if(section==='safety') return `${H}\n\nSafety notes in ${state.lang}: technique, injury prevention, hydration, sleep, and red flags to stop & seek care.${forceLong}`;
  if(section==='closing') return `${H}\n\nShort motivating closing in ${state.lang} addressing user by name.${forceLong}`;
  return H+forceLong;
}

/* ===================== API (robust) ===================== */
async function callAI(prompt, opt={}, { attempts=4, sectionId="" } = {}){
  // queue to serialize requests (reduces upstream 429/500)
  return queue = queue.then(() => _call(prompt, opt, {attempts, sectionId}));
}
async function _call(prompt, opt={}, { attempts, sectionId }){
  for(let i=0;i<attempts;i++){
    const model = MODELS[i % MODELS.length];
    try{
      const body = JSON.stringify({
        prompt,
        model,
        response_mime_type:'text/markdown',
        temperature: i>=2 ? 0.2 : 0.35,   // reduce on later retries
        top_p: 0.9,
        max_output_tokens: 8192,
        section: sectionId
      });
      const ctrl = new AbortController();
      const to = setTimeout(()=>ctrl.abort(), 45000); // 45s hard timeout
      const r = await fetch(ENDPOINT, {method:'POST',headers:{'content-type':'application/json'},body,signal:ctrl.signal});
      clearTimeout(to);

      const raw = await r.text();
      let data=null; try{ data=JSON.parse(raw); }catch{}
      if(!r.ok) throw new Error((data && (data.error||data.details||data.message))||raw.slice(0,400));
      const text = (data && data.text) ? String(data.text).trim() : '';
      if(!text || /^<!doctype/i.test(text)) throw new Error('Invalid body');
      return {ok:true, text};
    }catch(e){
      await new Promise(res=>setTimeout(res, 800*(i+1))); // backoff
    }
  }
  return {ok:false, error:'Both endpoints failed'};
}

/* Nutrition fallback: split each meal request */
async function generateNutritionFallback(sectionId){
  const day=+sectionId.split('-').pop();
  const base=headerBlock();
  const mk=(mealName)=>`${base}

OUTPUT: Markdown single row ONLY for ${mealName}.
Columns: | Meal | Ingredients (g) | kcal | Protein | Fat | Carbs |
Language: ${state.lang}. Day ${day}.`;
  const [r1,r2,r3]=await Promise.all([
    callAI(mk(state.lang==='ar'?'ÙˆØ¬Ø¨Ø© 1':'Meal 1'),{}, {attempts:3,sectionId}),
    callAI(mk(state.lang==='ar'?'ÙˆØ¬Ø¨Ø© 2':'Meal 2'),{}, {attempts:3,sectionId}),
    callAI(mk(state.lang==='ar'?'ÙˆØ¬Ø¨Ø© 3':'Meal 3'),{}, {attempts:3,sectionId})
  ]);
  if(!(r1.ok && r2.ok && r3.ok)) return {ok:false,error:'Both endpoints failed'};
  const total=await callAI(`${base}

You are given three Markdown rows (without header). Compute a TOTAL row and return ONLY that TOTAL row (kcal, Protein, Fat, Carbs). 
Rows:
${r1.text}
${r2.text}
${r3.text}`,{}, {attempts:2,sectionId});
  if(!total.ok) return {ok:false,error:'Both endpoints failed'};
  return {ok:true,text:r1.text.trim()+"\n"+r2.text.trim()+"\n"+r3.text.trim()+"\n"+total.text.trim()};
}

/* ===================== GENERATION ===================== */
function ensureTargets(){state.targets=computeTargets()}
function planCard(sectionId){
  const wrap=id('plan-content');
  const card=document.createElement('div'); card.className='glass p-4'; card.id='sec-'+sectionId;
  card.innerHTML=`
    <div class="flex items-center justify-between mb-2">
      <div class="section-title">${pretty(sectionId)}</div>
      <button id="retry-${sectionId}" class="chip" style="display:none;">âŸ³ ${t('retry')}</button>
    </div>
    <div id="note-${sectionId}" class="text-xs text-[color:var(--muted)]">${t('gen')}</div>
    <div class="w-full progress my-2"><i id="bar-${sectionId}" style="width:0%"></i></div>
    <div id="body-${sectionId}" class="ai-content"></div>
    <div id="err-${sectionId}" class="text-xs text-[color:var(--muted)] mt-2"></div>`;
  wrap.appendChild(card);
  id(`retry-${sectionId}`).onclick=()=>regenerateSection(sectionId);
  return card;
}
function setSectionStatus(sec,st,err){
  state.sectionStatus[sec]={status:st,error:err}; renderBoard();
  const dot=id('run-dot');
  if(st==='run'){dot.style.background='var(--warn)'; id('run-label').textContent=t('gen')}
  if(st==='ok'){dot.style.background='var(--ok)'; id('run-label').textContent=t('done')}
  if(st==='fail'){dot.style.background='var(--err)'; id('run-label').textContent=t('failed')}
}
function updateGlobalProgress(p){id('run-progress').style.width=p+'%'; id('global-progress').style.width=p+'%'; id('run-msg').textContent=Math.round(p)+'% â€” '+t('waitMsg')}

async function generateAllSequential(){
  saveStep(); ensureTargets();
  id('plan-content').innerHTML='';
  const list=state.sections.filter(s=> s!=='fasting' || state.diet.fasting!=='off');
  for(let i=0;i<list.length;i++){ await generateOne(list[i], (i/list.length)*100, ((i+1)/list.length)*100); }
  updateGlobalProgress(100);
}
async function generateOne(sectionId,startPct,endPct){
  setSectionStatus(sectionId,'run'); planCard(sectionId);
  const bodyEl=id('body-'+sectionId), noteEl=id('note-'+sectionId), barEl=id('bar-'+sectionId);
  noteEl.textContent=t('gen');

  let r=await callAI(promptFor(sectionId),{}, {attempts:4,sectionId});
  if(!r.ok && sectionId.startsWith('nutrition-day')) r=await generateNutritionFallback(sectionId);

  if(!r.ok){
    setSectionStatus(sectionId,'fail',r.error);
    id('err-'+sectionId).textContent=r.error||'Failed'; id('retry-'+sectionId).style.display='inline-flex';
    barEl.style.width=(startPct+(endPct-startPct)*.2)+'%'; return;
  }
  bodyEl.innerHTML = marked.parse(r.text);
  noteEl.textContent=t('done'); barEl.style.width='100%'; setSectionStatus(sectionId,'ok'); updateGlobalProgress(endPct);
}
async function regenerateSection(sectionId){
  const card=id('sec-'+sectionId); if(card) card.remove();
  await generateOne(sectionId,0,5);
}

/* ===================== EVENTS ===================== */
id('next').onclick=()=>{saveStep(); state.step=Math.min(3,state.step+1); renderStep()};
id('prev').onclick=()=>{saveStep(); state.step=Math.max(0,state.step-1); renderStep()};
id('generate-current').onclick=()=>generateAllSequential();
id('btn-print').onclick=()=>window.print();
id('print-bottom').onclick=()=>window.print();
id('scroll-top').onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
id('lang-ar').onclick=()=>setLang('ar');
id('lang-en').onclick=()=>setLang('en');
id('toggle-theme').onclick=()=>setTheme(state.theme==='dark'?'light':'dark');

/* ===================== INIT ===================== */
window.addEventListener('load',()=>{
  setLang(state.lang); setTheme('dark'); renderStep(); renderBoard();
  id('run-label').textContent=t('idle'); id('hint').textContent=t('hint');
});
<script>
/* ================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ================== */

// Ø§Ù„Ù„ØºØ© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† ÙˆØ§Ø¬Ù‡ØªÙƒ (ar | en)
let currentLang = (window.APP_LANG || 'ar'); 

// Ø®Ø±ÙŠØ·Ø© ØªØ±Ø¬Ù…Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù†Ø¸Ø§Ù… ØªØ±Ø¬Ù…Ø© Ø§ØªØ±ÙƒÙ‡Ø§)
const i18n = {
  ar: {
    keepReading: "â€” Ø³ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„ Ù‚Ø³Ù… ÙÙˆØ± ØªÙˆÙ„ÙŠØ¯Ù‡â€¦ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± â€”",
    sectionReady: "ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯",
    regenerating: "Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…",
    longFormNote: "Ø§ÙƒØªØ¨ Ø¨Ø¥Ø³Ù‡Ø§Ø¨ ÙˆØ¨Ø¯ÙˆÙ† Ø§Ø®ØªØµØ§Ø±ØŒ Ø¨Ù†Ø¨Ø±Ø© Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ø¶Ø­Ø©.",
    noDuplicates: "Ù„Ø§ ØªÙÙƒØ±Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø£Ùˆ Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø£Ùˆ Ø£ÙŠ Ù…Ø­ØªÙˆÙ‰ ØªÙ… Ø°ÙƒØ±Ù‡ Ø³Ø§Ø¨Ù‚Ù‹Ø§.",
    noDisclaimers: "ÙŠÙÙ…Ù†Ø¹ ÙƒØªØ§Ø¨Ø© Ø¬ÙÙ…Ù„ Ø¹Ø§Ù…Ø© Ù…Ø«Ù„: Ù‡Ø°Ù‡ Ø®Ø·Ø© ØºÙŠØ± Ù…Ø®ØµØµØ© / Ø§Ø³ØªØ´Ø± Ø£Ø®ØµØ§Ø¦ÙŠ / Ù‡Ø°Ù‡ Ù„ÙŠØ³Øª Ù†ØµÙŠØ­Ø© Ø·Ø¨ÙŠØ©â€¦ Ø¥Ù„Ø®.",
    cohesion: "Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ ØªØ³Ù„Ø³Ù„ Ø­Ø¯ÙŠØ« Ù…Ù†Ø·Ù‚ÙŠ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ø§ ØªÙ… Ø´Ø±Ø­Ù‡ ÙÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©. Ù„Ø§ ØªØ¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©.",
    onlyLang: "Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø· Ø¯ÙˆÙ† Ø£ÙŠ Ø¥Ø¯Ø±Ø§Ø¬ Ù„Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©.",
    sectionIntro: "Ø§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ø¨Ù…Ø­ØªÙˆÙ‰ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ù„Ø§ ØªØ±Ø­ÙŠØ¨ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø±ÙŠÙ.",
  },
  en: {
    keepReading: "â€” Each section will appear as soon as itâ€™s ready â€” please wait â€”",
    sectionReady: "Ready",
    regenerating: "Regenerate this section",
    longFormNote: "Write in-depth (no summaries) with a practical tone.",
    noDuplicates: "Do not repeat profile, welcome, or any previously stated content.",
    noDisclaimers: "Do NOT add generic warnings like: not personalized plan / consult a professional / not medical advice, etc.",
    cohesion: "Ensure narrative continuity that references prior sections. Do NOT start a new chat.",
    onlyLang: "Write in the selected language only (no code-switching).",
    sectionIntro: "Start directly with this section content; no greetings or re-introductions.",
  }
};

// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ³Ù„Ø³Ù„ ÙˆØ¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
const PlanState = {
  lang: currentLang,
  profile: null,                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªÙÙ…Ù„Ø£ Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬)
  completedSections: [],        // [{key, text}]
  seenSentences: new Set(),     // Ù…ÙƒØ§ÙØ­Ø© ØªÙƒØ±Ø§Ø± Ø¬ÙÙ…Ù„ Ø­Ø±ÙÙŠÙ‹Ø§
  pushSection(key, text) {
    this.completedSections.push({ key, text });
  },
  previousContext(maxChars = 4000) {
    // Ù†Ø¬Ù…Ø¹ Ù…Ù„Ø®ØµÙ‹Ø§ Ù…ÙˆØ¬Ø²Ù‹Ø§ Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ø¥Ø¹Ø·Ø§Ø¦Ù‡ Ù„Ù„Ù‚Ø³Ù… Ø§Ù„ØªØ§Ù„ÙŠ
    const joined = this.completedSections.map(s => `# ${s.key}\n${s.text}`).join('\n\n');
    return joined.slice(-maxChars); // Ø¢Ø®Ø± N Ø­Ø±Ù ÙƒÙØ§ÙŠØ© Ù„Ù„Ø³ÙŠØ§Ù‚
  }
};

/* ================== Ù…ÙÙˆÙØ­ÙÙ‘Ø¯ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ ================== */

function buildRules(lang) {
  const t = i18n[lang];
  return [
    t.longFormNote,
    t.onlyLang,
    t.noDuplicates,
    t.noDisclaimers,
    t.cohesion,
    t.sectionIntro,
    // ØªÙ†Ø³ÙŠÙ‚ Ù…Ø®Ø±Ø¬Ø§Øª ÙˆØ§Ø¶Ø­ Ù„ÙƒÙ„ Ù‚Ø³Ù…
    "Ù‚Ø¯Ù‘Ù… ÙÙ‚Ø±Ø§Øª Ù…Ø±ØªØ¨Ø© ÙˆÙ†Ù‚Ø§Ø·Ù‹Ø§ Ù…Ø±Ù‚Ù‘Ù…Ø© ÙˆØ¬Ø¯Ø§ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.",
    "Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø§ÙˆÙŠÙ† ÙØ±Ø¹ÙŠØ© ÙˆØ§Ø¶Ø­Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø· Ø¯ÙˆÙ† Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¹Ø§Ù…Ø© Ù…ÙƒØ±Ø±Ø©.",
    "Ù„Ø§ ØªÙØ¯Ø±Ø¬ ÙˆØ³ÙˆÙ… HTML Ø£Ùˆ Ø±Ø£Ø³ ØµÙØ­Ø© Ø£Ùˆ Ø£ÙŠ Ù‡ÙŠÙƒÙ„ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨."
  ].join('\n- ');
}

/* ================== Ù…ÙÙƒÙˆÙÙ‘Ù† Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ù„ÙƒÙ„ Ù‚Ø³Ù… ================== */

function buildSectionPrompt({ lang, sectionKey, sectionSpec }) {
  const t = i18n[lang];
  const rules = buildRules(lang);
  const prev = PlanState.previousContext();

  const profile = PlanState.profile || {};

  // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙŠØ¶Ù…Ù† Ø£Ù† ÙƒÙ„ Ù‚Ø³Ù… ÙŠØ¹Ø±Ù Ù…Ø§ ÙƒÙØªØ¨ Ø³Ø§Ø¨Ù‚Ù‹Ø§ ÙˆÙŠÙÙƒÙ…Ù„ Ø¹Ù„ÙŠÙ‡
  const continuity = [
    "Ø³ÙŠØ§Ù‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ù…Ù„Ø®Øµ Ù„Ù„Ø§Ø³ØªØ¯Ù„Ø§Ù„ØŒ Ù„Ø§ ØªØ¹ÙŠØ¯Ù‡ Ø­Ø±ÙÙŠÙ‹Ø§):",
    "----",
    prev || "(Ù„Ø§ Ø³ÙŠØ§Ù‚ Ø³Ø§Ø¨Ù‚ Ø¨Ø¹Ø¯.)",
    "----",
  ].join('\n');

  // ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù‚Ø³Ù…ÙŠØ© Ù…ÙØ®ØµØµØ©
  const sectionDirectives = sectionSpec.instructions[lang];

  // Ø¨Ù†ÙŠÙ†Ø§ Ø¨Ø±ÙˆÙ…Ø¨Øª Ù…ÙˆØ­Ø¯Ù‹Ø§ Ø·ÙˆÙŠÙ„Ù‹Ø§
  return [
    `Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${sectionSpec.title[lang]} (${sectionKey})`,
    "Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: " + (lang === 'ar' ? "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" : "English"),
    "Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ù„Ø²Ù…Ø©:",
    rules,
    "",
    "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø§Ø³ØªØ¯Ù„Ø§Ù„ ÙÙ‚Ø·ØŒ Ù„Ø§ ØªÙØ¹Ø¯ Ø·Ø¨Ø¹Ù‡Ø§):",
    JSON.stringify(profile, null, 2),
    "",
    continuity,
    "",
    "ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…:",
    sectionDirectives,
    "",
    "Ù‚Ø¯Ù‘Ù… Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ø¢Ù† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø·ØŒ Ø·ÙˆÙŠÙ„Ø© ÙˆÙ…ÙØµÙ„Ø© ÙˆØºÙŠØ± Ù…ÙØ®ØªØµØ±Ø©."
  ].join('\n');
}

/* ================== ØªÙ†Ø¸ÙŠÙ/ØªØ³ÙˆÙŠØ© Ø§Ù„Ù†Øµ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ ================== */

const RE_STRIP = [
  // Ø¥Ø®Ù„Ø§Ø¡Ø§Øª Ø¹Ø§Ù…Ø© Ø¹Ø±Ø¨ÙŠØ©
  /Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.*?Ù„ÙŠØ³Øª(?:\s|\S){0,40}?Ø§Ø³ØªØ´Ø§Ø±Ø©(?:\s|\S){0,10}?Ø·Ø¨ÙŠØ¨.*$/gim,
  /Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø©.*?(?:ØºÙŠØ±|Ù„ÙŠØ³Øª).*?(?:Ù…Ø®ØµØµØ©|Ø·Ø¨ÙŠØ©).*$/gim,
  /Ø§Ø³ØªØ´Ø±\s+(?:Ø·Ø¨ÙŠØ¨|Ø£Ø®ØµØ§Ø¦ÙŠ|Ù…Ø¯Ø±Ø¨)[^\n]*$/gim,
  // Ø¥Ø®Ù„Ø§Ø¡Ø§Øª Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
  /this (?:plan|information).*?(?:not|isn['â€™]t).*?(?:personalized|medical advice)[^\n]*$/gim,
  /consult (?:a )?(?:physician|doctor|dietitian|coach)[^\n]*$/gim,
  // Ø±Ø¤ÙˆØ³ HTML ØªØ³Ø±Ø¨Øª Ø£Ø­ÙŠØ§Ù†Ù‹Ø§
  /<!DOCTYPE[\s\S]*?<body[^>]*>/gim,
  /<\/body>\s*<\/html>/gim
];

function sanitizeLLM(raw, lang = 'ar') {
  let text = String(raw || '');

  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ HTML Ø´Ø§Ø±Ø¯
  RE_STRIP.forEach(rx => text = text.replace(rx, ''));

  // Ø¥Ø¬Ø¨Ø§Ø± Ù„ØºØ© ÙˆØ§Ø­Ø¯Ø©: Ø¥Ù† Ø¸Ù‡Ø±Øª Ø£Ø³Ø·Ø± Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ³Ø· Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¹ÙƒØ³ Ù†Ø­Ø§ÙˆÙ„ ÙÙ„ØªØ±ØªÙ‡Ø§
  if (lang === 'ar') {
    // Ø§Ù…Ø³Ø­ Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ Ù…Ø¹Ø¸Ù…Ù‡Ø§ Ø£Ø­Ø±Ù Ù„Ø§ØªÙŠÙ†ÙŠØ©/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    text = text.split('\n').filter(line => {
      const latin = (line.match(/[A-Za-z]/g) || []).length;
      const arabic = (line.match(/[\u0600-\u06FF]/g) || []).length;
      return arabic >= latin; // Ù†ÙØ¨Ù‚ÙŠ Ù…Ø§ ÙŠØºÙ„Ø¨ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
    }).join('\n');
  } else {
    text = text.split('\n').filter(line => {
      const latin = (line.match(/[A-Za-z]/g) || []).length;
      const arabic = (line.match(/[\u0600-\u06FF]/g) || []).length;
      return latin >= arabic;
    }).join('\n');
  }

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¬ÙÙ…ÙÙ„ Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø­Ø±ÙÙŠÙ‹Ø§
  const dedup = [];
  for (const para of text.split('\n')) {
    const p = para.trim();
    if (!p) { dedup.push(''); continue; }
    const key = p.replace(/\s+/g, ' ').toLowerCase();
    if (PlanState.seenSentences.has(key)) continue;
    PlanState.seenSentences.add(key);
    dedup.push(para);
  }
  text = dedup.join('\n');

  // ØªÙ†Ø¸ÙŠÙ ÙØ±Ø§ØºØ§Øª Ø²Ø§Ø¦Ø¯Ø©
  text = text.replace(/\n{3,}/g, '\n\n').trim();

  return text;
}

/* ================== ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ================== */

const SECTIONS = [
  {
    key: 'welcome',
    title: { ar: 'Ø§Ù„ØªØ±Ø­ÙŠØ¨', en: 'Welcome' },
    instructions: {
      ar: [
        "Ù‚Ø¯Ù… ÙÙ‚Ø±Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© Ù‚ØµÙŠØ±Ø© (3-4 Ø£Ø³Ø·Ø±) Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….",
        "Ù„Ø§ ØªÙÙƒØ±Ø± Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¹Ù…Ø± Ø¥Ù† ÙƒØ§Ù† Ù…Ø°ÙƒÙˆØ±Ù‹Ø§ Ù…Ø³Ø¨Ù‚Ù‹Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¬Ù…Ù„Ø© Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©.",
        "Ù„Ø§ ØªØ¶Ø¹ Ø£Ù‡Ø¯Ø§ÙÙ‹Ø§ Ø¹Ø§Ù…Ø© â€” Ø§Ø±Ø¨Ø· Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¨Ù‡Ø¯Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯."
      ].join('\n- '),
      en: "Short contextual welcome (3â€“4 lines) tied to the user profile."
    }
  },
  {
    key: 'analysis',
    title: { ar: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„', en: 'Analysis' },
    instructions: {
      ar: [
        "Ø­Ù„Ù„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø³Ø¹Ø±Ø§Øª/Ù…Ø§ÙƒØ±ÙˆØ²/Ù†Ø´Ø§Ø·/Ù‚ÙŠÙˆØ¯) Ø¨Ø¹Ù…Ù‚ Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ.",
        "Ø§Ø±Ø¨Ø· Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù…Ø§ ÙˆØ±Ø¯ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙˆØ§Ù„Ù…Ù„Ù Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ù†Ø³ÙŠØ§Ø¨ÙŠØ©.",
        "Ù„Ø§ ØªÙØ¯Ø±Ø¬ Ø£ÙŠ ØªÙˆØµÙŠØ© Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…."
      ].join('\n- '),
      en: "Deep analysis without reprinting profile; keep narrative continuity."
    }
  },
  {
    key: 'allowed',
    title: { ar: 'Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹', en: 'Allowed / Avoid' },
    instructions: {
      ar: [
        "Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ÙƒØ²Ø© Ø¨Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ ÙˆØ§Ù„Ø­Ø¯/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹ØŒ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ù…Ø·Ø¨Ø® Ø§Ù„Ù…ÙØ¶Ù„.",
        "Ù„Ø§ ØªÙØ¹Ø¯ ØªÙ„Ø®ÙŠØµ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø› ÙÙ‚Ø· ØµÙ„Ù‘Ù‡ Ø¨Ø®Ù„Ø§ØµØ© Ø¬Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø©."
      ].join('\n- '),
      en: "Food lists tailored to cuisine/budget; no generic advice."
    }
  },
  // â€¦ Ø£ÙƒÙ…Ù„ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙƒÙ…Ø§ Ù‡ÙŠ Ù„Ø¯ÙŠÙƒ â€¦
];

/* ================== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯ (Ø¨Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ) ================== */

async function callGemini(prompt) {
  const res = await fetch('/.netlify/functions/gemini-proxy', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ prompt })
  });
  if (!res.ok) {
    const msg = await res.text();
    throw new Error(`Gemini proxy error: ${res.status} ${msg}`);
  }
  const data = await res.json();
  return data.text || '';
}

/* ================== ØªÙˆÙ„ÙŠØ¯ Ù‚Ø³Ù… ÙˆØ§Ø­Ø¯ ================== */

async function generateSection(sectionKey) {
  const sectionSpec = SECTIONS.find(s => s.key === sectionKey);
  if (!sectionSpec) throw new Error(`Unknown section: ${sectionKey}`);

  const prompt = buildSectionPrompt({
    lang: PlanState.lang,
    sectionKey,
    sectionSpec
  });

  const raw = await callGemini(prompt);
  const clean = sanitizeLLM(raw, PlanState.lang);
  PlanState.pushSection(sectionKey, clean);
  return clean;
}

/* ================== Ø±Ø¨Ø·Ù‡ Ø¨Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ================== */

// Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ø±Ø¨Ø·Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù† ÙƒØ§Ù†Øª Ø£Ø³Ù…Ø§Ø¡Ùƒ Ù…Ø®ØªÙ„ÙØ©
window.APP_API = window.APP_API || {};
window.APP_API.setProfile = (profileObj) => {
  PlanState.profile = { ...profileObj };
};

window.APP_API.generateAllSequentially = async (keys, onProgress) => {
  for (let i = 0; i < keys.length; i++) {
    const k = keys[i];
    try {
      const txt = await generateSection(k);
      onProgress?.({ key: k, status: 'ok', text: txt, index: i, total: keys.length });
    } catch (e) {
      onProgress?.({ key: k, status: 'error', error: String(e), index: i, total: keys.length });
    }
  }
};

// Ù…Ø«Ø§Ù„ Ø¹Ø±Ø¶ Ù†Øµ ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ù‚Ø³Ù… (Ø¨Ø¯Ù‘Ù„ selector Ø¨Ù…Ø§ Ø¹Ù†Ø¯Ùƒ)
function renderSection(key, htmlText) {
  const el = document.querySelector(`[data-section="${key}"] .section-body`);
  if (el) el.textContent = htmlText; // Ù†Øµ ÙÙ‚Ø·ØŒ Ù„Ùˆ ØªØ±ÙŠØ¯ Markdown Ø¹Ø§Ù„Ø¬Ù‡ Ù‡Ù†Ø§
}

// Ù…Ø«Ø§Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù…: Ø²Ø± â€œØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠâ€
window.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-gen-one]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const key = btn.getAttribute('data-gen-one');
      btn.disabled = true;
      try {
        const txt = await generateSection(key);
        renderSection(key, txt);
      } finally {
        btn.disabled = false;
      }
    });
  });

  // Ø²Ø± â€œØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙ„ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨â€
  const genAllBtn = document.querySelector('[data-gen-all]');
  if (genAllBtn) {
    genAllBtn.addEventListener('click', async () => {
      const keys = SECTIONS.map(s => s.key); // Ø£Ùˆ Ù…ØµÙÙˆÙØ© Ù…Ø®ØµØµØ©
      genAllBtn.disabled = true;
      await window.APP_API.generateAllSequentially(keys, (ev) => {
        if (ev.status === 'ok') renderSection(ev.key, ev.text);
        // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… + Ø±Ø³Ø§Ù„Ø© "Ø³ÙŠØ¸Ù‡Ø± ÙƒÙ„ Ù‚Ø³Ù… ÙÙˆØ± ØªÙˆÙ„ÙŠØ¯Ù‡"
      });
      genAllBtn.disabled = false;
    });
  }
});
</script>
</body>
</html>
