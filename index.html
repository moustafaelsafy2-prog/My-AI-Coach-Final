<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>المدرب الشخصي الخبير — مصطفى الصافي</title>

  <!-- Tailwind + Marked -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Theme -->
  <style>
    :root{
      --bg:#f8fafc; --surface:#ffffff; --border:#e5e7eb;
      --text:#0f172a; --muted:#475569;
      --primary:#1d4ed8; --primary-700:#1e40af;
    }
    html,body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .font-tajawal{font-family:'Tajawal',sans-serif}
    .font-poppins{font-family:'Poppins',sans-serif}
    .card{background:var(--surface);border:1px solid var(--border);box-shadow:0 6px 18px rgba(2,6,23,.06)}
    .btn{border:1px solid var(--border);padding:.6rem .9rem;border-radius:.6rem}
    .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn-primary:hover{background:var(--primary-700)}
    .btn-ghost{background:#e2e8f0}
    header{background:linear-gradient(90deg,rgba(29,78,216,.08),rgba(16,185,129,.08))}
    .badge{padding:.2rem .5rem;border-radius:.45rem;font-size:.75rem;border:1px solid}
    .ok{color:#065f46;background:#ecfdf5;border-color:#a7f3d0}
    .warn{color:#92400e;background:#fffbeb;border-color:#fde68a}
    .err{color:#991b1b;background:#fef2f2;border-color:#fecaca}
    .ai-prose table{width:100%;border-collapse:collapse;margin:12px 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .ai-prose th,.ai-prose td{border:1px solid #e5e7eb;padding:.65rem;vertical-align:top}
    .ai-prose th{background:#f8fafc;font-weight:700}
    @media print{
      header,#sticky,.no-print{display:none!important}
      body{background:#fff}
      #app{box-shadow:none;border:none;max-width:100%;margin:0}
      .page-break{page-break-before:always}
    }
  </style>
</head>

<body class="font-tajawal min-h-screen">
  <!-- Topbar -->
  <header class="px-4 sm:px-6 py-3 flex items-center justify-between border-b">
    <div class="leading-tight">
      <div class="text-xs text-slate-600">COACH</div>
      <div class="font-extrabold">Mustafa Al-Safi</div>
      <div class="text-xs text-slate-500">Certified International Coach</div>
    </div>
    <div class="flex items-center gap-2">
      <button id="cmd-print" class="btn no-print" type="button">طباعة PDF</button>
      <button id="btn-en" class="btn" type="button">EN</button>
      <button id="btn-ar" class="btn" type="button">عربي</button>
    </div>
  </header>

  <!-- Shell -->
  <div id="app" class="max-w-4xl mx-auto my-5 sm:my-10 card rounded-2xl overflow-hidden">
    <!-- Hero -->
    <div class="p-6 sm:p-8">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-center">المدرب الشخصي الخبير</h1>
      <p class="text-sm text-slate-600 text-center mt-1">
        خطة دقيقة 100% للتغذية والتدريب والمكملات — مناسبة لأهدافك وصحتك ونمط حياتك.
      </p>
      <p class="text-xs text-slate-500 text-center mt-1">
        المدرب مصطفى الصافي — خبير التغذية واللياقة البدنية │ مدرب دولي معتمد • Powered by Mustafa Elsafy 2025
      </p>

      <div class="grid sm:grid-cols-3 gap-3 mt-5">
        <div class="card p-3">
          <div class="text-xs text-slate-600 mb-1">الحقوق والاعتماد</div>
          <div class="text-sm">مصطفى الصافي — خبير التغذية واللياقة البدنية | مدرب دولي معتمد</div>
          <div class="text-xs text-slate-500 mt-1">Powered by Mustafa Elsafy 2025</div>
        </div>
        <div class="card p-3">
          <div class="text-xs text-slate-600 mb-1">جودة الخطة</div>
          <div class="flex items-center gap-2">
            <span id="badgeDays" class="badge warn">0/7</span>
            <span id="badgeMacros" class="badge warn">±2% 0/7</span>
          </div>
        </div>
        <div class="card p-3">
          <div class="text-xs text-slate-600 mb-1">مرحلة التقدم</div>
          <div class="h-2.5 bg-gray-200 rounded-full overflow-hidden">
            <div id="progress" class="h-full bg-gradient-to-r from-indigo-500 to-blue-500 transition-all duration-300" style="width:0%"></div>
          </div>
          <div class="mt-2 text-xs text-gray-500">الخطوة <span id="step">0</span> من 12</div>
        </div>
      </div>
    </div>

    <!-- Dynamic content -->
    <main id="content" class="p-5 sm:p-8"></main>

    <!-- Sticky nav -->
    <div id="sticky" class="sticky bottom-0 bg-white/80 backdrop-blur-md border-t px-4 sm:px-6 py-3 flex gap-3 justify-between">
      <button id="prev" class="btn btn-ghost w-1/3 sm:w-40" type="button">السابق</button>
      <button id="next" class="btn btn-primary flex-1" type="button">التالي</button>
    </div>
  </div>

  <!-- App -->
  <script>
  /* ---------- STATE ---------- */
  const TOTAL = 12;
  const content = document.getElementById('content');
  const progressBar = document.getElementById('progress');
  const stepEl = document.getElementById('step');
  const badgeDays = document.getElementById('badgeDays');
  const badgeMacros = document.getElementById('badgeMacros');
  const btnPrev = document.getElementById('prev');
  const btnNext = document.getElementById('next');
  const btnAr = document.getElementById('btn-ar');
  const btnEn = document.getElementById('btn-en');

  let state = {
    lang: 'ar',
    step: 0,
    user: {
      name: '',
      age: null, height: null, weight: null, gender: 'Male',
      goals: [], target_weight: null, target_date: null,
      diet_preference: 'Balanced / متوازن',
      meals_per_day: 4,
      fasting: { enabled: false, protocol: '16:8', start: '12:00', end: '20:00' },
      allergies: [], other_allergies: '',
      last_train: '', training_exp: 'مبتدئ',
      weak_points: {}, health_conditions: [], injuries: '',
      job_activity: 'مكتبي', sleep_hours: null, stress_level: 'متوسط',
      steps_target: 9000,
      has_photos: false, has_inbody: false
    },
    calc: { tdee: 0, P: 0, F: 0, C: 0, pal: 1.35 }
  };

  /* ---------- I18N ---------- */
  const I = {
    ar: {
      start:"ابدأ", next:"التالي", prev:"السابق", submit:"احصل على خطتك الآن!",
      welcome_title:"أهلاً بك!", welcome_desc:"سأصمم لك خطة مكتملة للتغذية والتدريب والمكملات.",
      name_q:"الاسم", age:"العمر", height:"الطول (سم)", weight:"الوزن (كغ)", gender:"الجنس", male:"ذكر", female:"أنثى",
      stage_1:"من أنت؟", stage_2:"بيانات أساسية", stage_3:"الأهداف", stage_4:"هدف متقدم", stage_5:"نظامك المفضل",
      stage_6:"الحساسية", stage_7:"تاريخ رياضي", stage_8:"نقاط التركيز", stage_9:"الصحة", stage_10:"نمط الحياة", stage_11:"ملفات اختيارية",
      api_error:"تعذر الاتصال بالموديل. تحقق من الدالة أو المفتاح."
    },
    en: {
      start:"Start", next:"Next", prev:"Back", submit:"Generate Plan",
      welcome_title:"Welcome!", welcome_desc:"I'll craft a complete plan for nutrition, training and supplements.",
      name_q:"Name", age:"Age", height:"Height (cm)", weight:"Weight (kg)", gender:"Gender", male:"Male", female:"Female",
      stage_1:"Who are you?", stage_2:"Basics", stage_3:"Goals", stage_4:"Advanced target", stage_5:"Diet style",
      stage_6:"Allergies", stage_7:"Training history", stage_8:"Focus areas", stage_9:"Health", stage_10:"Lifestyle", stage_11:"Optional files",
      api_error:"Cannot reach model. Check function or key."
    }
  };
  function t(k){return I[state.lang][k]||k}
  function setLang(l){
    state.lang=l; document.documentElement.lang=l; document.documentElement.dir=l==='ar'?'rtl':'ltr';
    document.body.classList.toggle('font-tajawal',l==='ar'); document.body.classList.toggle('font-poppins',l!=='ar');
    btnEn.className='btn '+(l==='en'?'btn-primary':''); btnAr.className='btn '+(l==='ar'?'btn-primary':'');
    updateCTA();
  }
  btnAr.onclick=()=>setLang('ar'); btnEn.onclick=()=>setLang('en');
  document.getElementById('cmd-print').onclick=()=>window.print();

  /* ---------- RENDER UTILS ---------- */
  function updateProgress(){ const p=Math.max(0,((state.step-1)/TOTAL)*100); progressBar.style.width=p+'%'; stepEl.textContent=String(Math.min(state.step,TOTAL)); }
  function updateCTA(){ btnPrev.textContent=t('prev'); btnNext.textContent = state.step===TOTAL ? t('submit') : t('next'); btnPrev.disabled=state.step<=1; }
  function field(label,id,opt={}){ const {type='text',value='',required=false,select=null,placeholder='',num=false}=opt;
    if(select) return `<label class="block"><span class="font-medium">${label}</span><select id="${id}" class="mt-1 w-full p-3 border rounded-lg">${select.map(o=>`<option ${String(value)===String(o.value)?'selected':''} value="${o.value}">${o.label}</option>`).join('')}</select></label>`;
    if(type==='textarea') return `<label class="block"><span class="font-medium">${label}</span><textarea id="${id}" rows="3" placeholder="${placeholder}" class="mt-1 w-full p-3 border rounded-lg">${value||''}</textarea></label>`;
    return `<label class="block"><span class="font-medium">${label}</span><input id="${id}" type="${type}" ${required?'required':''} value="${value}" placeholder="${placeholder}" ${num?'inputmode="numeric" pattern="[0-9]*"':''} class="mt-1 w-full p-3 border rounded-lg"></label>`;
  }
  function stage(title,desc,inner){ return `<section><h2 class="text-2xl sm:text-3xl font-extrabold">${title}</h2><p class="mt-1 text-slate-600">${desc||''}</p><form class="space-y-5 mt-6" onsubmit="event.preventDefault();">${inner}</form></section>` }

  /* ---------- STAGES ---------- */
  function render(){
    updateProgress(); updateCTA();
    const s = state.user; let html='';
    switch(state.step){
      case 0:
        content.innerHTML=`<section class="text-center p-10"><h2 class="text-3xl font-extrabold mb-2">${t('welcome_title')}</h2><p class="text-slate-600">${t('welcome_desc')}</p><div class="mt-6 inline-flex items-center gap-2"><select id="lang-select" class="p-3 border rounded"><option value="ar">العربية</option><option value="en">English</option></select><button id="start" class="btn btn-primary">${t('start')}</button></div></section>`;
        document.getElementById('start').onclick=()=>{ setLang(document.getElementById('lang-select').value); state.step=1; render(); }; break;

      case 1:
        html = field(t('name_q'),'name',{required:true,value:s.name||''});
        content.innerHTML=stage(t('stage_1'),' ',html); break;

      case 2:
        html = `<div class="grid sm:grid-cols-2 gap-4">
          ${field(t('age'),'age',{type:'number',num:true,value:s.age||'',required:true})}
          ${field(t('height'),'height',{type:'number',num:true,value:s.height||'',required:true})}
          ${field(t('weight'),'weight',{type:'number',num:true,value:s.weight||'',required:true})}
          ${field(t('gender'),'gender',{select:[{value:'Male',label:t('male')},{value:'Female',label:t('female')}],value:s.gender||'Male'})}
        </div>`;
        content.innerHTML=stage(t('stage_2'),' ',html); break;

      case 3:
        const goals = (state.lang==='ar')? ['خسارة الدهون','بناء العضلات','زيادة القوة','تحسين التحمل','صحة عامة'] : ['Fat loss','Muscle gain','Strength','Endurance','General health'];
        html = `<div class="grid sm:grid-cols-2 gap-2">${goals.map(g=>`<label class="p-3 border rounded cursor-pointer"><input type="checkbox" name="goal" value="${g}" class="mr-2 accent-indigo-600"> ${g}</label>`).join('')}</div>`;
        content.innerHTML=stage(t('stage_3'),' ',html); break;

      case 4:
        html = `<div class="grid sm:grid-cols-2 gap-4">
          ${field('Target weight / الوزن المستهدف','target_weight',{type:'number',num:true,value:s.target_weight||''})}
          ${field('Target date / تاريخ الهدف','target_date',{type:'date',value:s.target_date||''})}
        </div>`;
        content.innerHTML=stage(t('stage_4'),' ',html); break;

      case 5: {
        // اختيار النظام + عدد الوجبات + الصيام المتقطع
        const ds = [
          'Balanced / متوازن','Low-Carb / قليل الكربوهيدرات','IF / صيام متقطع',
          'Keto / كيتو','Mediterranean / البحر المتوسط','Plant-based / نباتي'
        ];
        const showFasting = (s.goals||[]).some(g => /خسارة|Fat/i.test(g)) ||
                            (s.health_conditions||[]).some(h => /سكري|Insulin|Diab/i.test(h)) ||
                            /IF|صيام/.test(s.diet_preference);

        const fastingBlock = `
          <div id="fasting-wrap" class="${showFasting?'':'hidden'} grid sm:grid-cols-3 gap-3 mt-2 border p-3 rounded">
            <label class="flex items-center gap-2">
              <input id="fasting_enabled" type="checkbox" class="accent-indigo-600" ${s.fasting?.enabled?'checked':''}>
              <span>تفعيل الصيام المتقطع</span>
            </label>
            <label>
              <span class="text-sm text-slate-600">البروتوكول</span>
              <select id="fasting_protocol" class="mt-1 w-full p-2 border rounded">
                ${['14:10','16:8','18:6'].map(p=>`<option ${s.fasting?.protocol===p?'selected':''}>${p}</option>`).join('')}
              </select>
            </label>
            <div class="grid grid-cols-2 gap-2">
              <label><span class="text-sm text-slate-600">نافذة الأكل من</span>
                <input id="fasting_start" type="time" value="${s.fasting?.start||'12:00'}" class="mt-1 w-full p-2 border rounded">
              </label>
              <label><span class="text-sm text-slate-600">إلى</span>
                <input id="fasting_end" type="time" value="${s.fasting?.end||'20:00'}" class="mt-1 w-full p-2 border rounded">
              </label>
            </div>
            <p class="sm:col-span-3 text-xs text-slate-500">* لا تُتَناول السعرات خارج النافذة. الماء/القهوة السوداء/الشاي بدون سكر مسموح. أضف إلكترولايت عند التدريب صباحًا.</p>
          </div>`;

        const mealsSelect = `
          <label class="block">
            <span class="font-medium">عدد الوجبات/اليوم</span>
            <select id="meals_per_day" class="mt-1 w-full p-3 border rounded">
              ${[3,4,5,6].map(n=>`<option ${Number(s.meals_per_day)===n?'selected':''} value="${n}">${n}</option>`).join('')}
            </select>
          </label>`;

        const html5 = `
          ${field(t('stage_5'),'diet_preference',{select:ds.map(x=>({value:x,label:x})), value:s.diet_preference||ds[0]})}
          ${mealsSelect}
          ${fastingBlock}`;

        content.innerHTML = stage(t('stage_5'),'اختر نظامك، حدّد عدد الوجبات، وفعّل الصيام إن كان مناسباً.', html5);

        setTimeout(()=>{
          const dp = document.getElementById('diet_preference');
          dp?.addEventListener('change',()=>document.getElementById('fasting-wrap')?.classList.toggle('hidden', !/IF|صيام/.test(dp.value)));
        },0);
        break;
      }

      case 6:
        const al = ['الجلوتين','اللاكتوز','المكسرات','المأكولات البحرية','السكريات المصنعة','الزيوت النباتية المصنعة','البقوليات','الأكتين'];
        html = `<div class="grid sm:grid-cols-2 gap-2">${al.map(v=>`<label class="p-3 border rounded cursor-pointer"><input type="checkbox" name="allergy" value="${v}" class="mr-2 accent-indigo-600"> ${v}</label>`).join('')}</div>${field('حساسيات أخرى (اختياري)','other_allergies',{value:s.other_allergies||''})}`;
        content.innerHTML=stage(t('stage_6'),' ',html); break;

      case 7:
        html = `${field('آخر التزام تدريبي','last_train',{select:[{value:'آخر 3 أشهر',label:'آخر 3 أشهر'},{value:'3-12 شهر',label:'3-12 شهر'},{value:'أكثر من سنة',label:'أكثر من سنة'}],value:s.last_train||'آخر 3 أشهر'})}
                ${field('خبرتك في المقاومة','training_exp',{select:[{value:'مبتدئ',label:'مبتدئ'},{value:'متوسط',label:'متوسط'},{value:'متقدم',label:'متقدم'}],value:s.training_exp||'مبتدئ'})}`;
        content.innerHTML=stage(t('stage_7'),' ',html); break;

      case 8:
        const muscles=['chest','back','shoulders','biceps','triceps','quads','hamstrings','glutes','calves','abs'];
        html = `<div class="space-y-3">${muscles.map(m=>`<div class="flex items-center gap-3"><input id="${m}" type="checkbox" class="accent-indigo-600"><label class="w-28">${m}</label><input id="${m}_desc" class="flex-1 p-2 border rounded" placeholder="وصف الهدف"></div>`).join('')}</div>`;
        content.innerHTML=stage(t('stage_8'),' ',html); break;

      case 9:
        const cond=['ضغط الدم','السكري','مقاومة الأنسولين','الغدة الدرقية','الكبد الدهني','مشاكل هرمونية','الجهاز الهضمي'];
        html = `<div class="grid sm:grid-cols-2 gap-2">${cond.map(v=>`<label class="p-3 border rounded cursor-pointer"><input type="checkbox" name="hc" value="${v}" class="mr-2 accent-indigo-600"> ${v}</label>`).join('')}</div>${field('إصابات (اختياري)','injuries',{type:'textarea',value:s.injuries||''})}`;
        content.innerHTML=stage(t('stage_9'),' ',html); break;

      case 10:
        html = `<div class="grid sm:grid-cols-3 gap-4">
          ${field('طبيعة العمل','job_activity',{select:[{value:'مكتبي',label:'مكتبي'},{value:'نشاط خفيف',label:'نشاط خفيف'},{value:'نشاط متوسط',label:'نشاط متوسط'}],value:s.job_activity||'مكتبي'})}
          ${field('ساعات النوم','sleep_hours',{type:'number',num:true,value:s.sleep_hours||'',required:true})}
          ${field('مستوى التوتر','stress_level',{select:[{value:'منخفض',label:'منخفض'},{value:'متوسط',label:'متوسط'},{value:'مرتفع',label:'مرتفع'}],value:s.stress_level||'متوسط'})}
        </div>${field('هدف الخطوات اليومية (NEAT)','steps_target',{type:'number',num:true,value:s.steps_target||9000})}`;
        content.innerHTML=stage(t('stage_10'),' ',html); break;

      case 11:
        html = `<div class="grid sm:grid-cols-2 gap-4">
          <label class="p-6 border rounded-xl text-center cursor-pointer">📷 صور الجسم<input type="file" id="photos" class="hidden" multiple accept="image/*"></label>
          <label class="p-6 border rounded-xl text-center cursor-pointer">📄 InBody<input type="file" id="inbody" class="hidden" accept="image/*,.pdf"></label>
        </div>`;
        content.innerHTML=stage(t('stage_11'),' ',html); break;

      case 12:
        content.innerHTML=`<section class="text-center p-8"><h2 class="text-2xl font-extrabold mb-1">${state.user.name?('معك '+state.user.name):'جارٍ التحليل'}</h2><p class="text-slate-600">أقوم بتحليل بياناتك لصياغة خطة دقيقة ومتكاملة…</p><div class="mt-6 animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600 mx-auto"></div><div id="plan" class="mt-8" dir="${state.lang==='ar'?'rtl':'ltr'}"></div></section>`;
        generatePlan(); break;
    }
  }

  /* ---------- SAVE & NAV ---------- */
  function saveAndNext(){
    const s=state.user;
    try{
      switch(state.step){
        case 1: s.name=document.getElementById('name').value.trim(); if(!s.name) throw 0; break;
        case 2: s.age=+document.getElementById('age').value; s.height=+document.getElementById('height').value; s.weight=+document.getElementById('weight').value; s.gender=document.getElementById('gender').value; if(!s.age||!s.height||!s.weight) throw 0; break;
        case 3: s.goals=[...document.querySelectorAll('input[name="goal"]:checked')].map(e=>e.value); if(!s.goals.length) throw 0; break;
        case 4: s.target_weight=+document.getElementById('target_weight').value||null; s.target_date=document.getElementById('target_date').value||null; break;
        case 5:
          s.diet_preference = document.getElementById('diet_preference').value;
          s.meals_per_day = Number(document.getElementById('meals_per_day').value)||4;
          if (document.getElementById('fasting_enabled')) {
            s.fasting = {
              enabled: document.getElementById('fasting_enabled').checked,
              protocol: document.getElementById('fasting_protocol').value,
              start: document.getElementById('fasting_start').value,
              end: document.getElementById('fasting_end').value
            };
          }
          break;
        case 6: s.allergies=[...document.querySelectorAll('input[name="allergy"]:checked')].map(e=>e.value); const other=document.getElementById('other_allergies').value.trim(); if(other) s.allergies.push(other); break;
        case 7: s.last_train=document.getElementById('last_train').value; s.training_exp=document.getElementById('training_exp').value; break;
        case 8: const muscles=['chest','back','shoulders','biceps','triceps','quads','hamstrings','glutes','calves','abs']; s.weak_points={}; muscles.forEach(m=>{ const cb=document.getElementById(m); if(cb?.checked) s.weak_points[m]=document.getElementById(m+'_desc').value||'Strengthening'; }); break;
        case 9: s.health_conditions=[...document.querySelectorAll('input[name="hc"]:checked')].map(e=>e.value); s.injuries=document.getElementById('injuries').value||''; break;
        case 10: s.job_activity=document.getElementById('job_activity').value; s.sleep_hours=+document.getElementById('sleep_hours').value; s.stress_level=document.getElementById('stress_level').value; s.steps_target=+document.getElementById('steps_target').value||9000; if(!s.sleep_hours) throw 0; break;
        case 11: s.has_photos=document.getElementById('photos')?.files.length>0; s.has_inbody=document.getElementById('inbody')?.files.length>0; break;
      }
      state.step++; render();
    }catch{ notify(state.lang==='ar'?'أكمل الحقول المطلوبة':'Complete required fields','err'); }
  }
  function back(){ if(state.step>1){ state.step--; render(); } }
  btnPrev.onclick=back; btnNext.onclick=()=>{ if(state.step<TOTAL) saveAndNext(); else generatePlan(); };

  /* ---------- CALC ---------- */
  function compute(){
    const p=state.user; const W=+p.weight||0,H=+p.height||0,A=+p.age||0; const male=p.gender==='Male';
    const BMR = male ? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161;
    const pal = p.job_activity==='مكتبي' ? 1.2 : (p.job_activity==='نشاط متوسط' ? 1.5 : 1.35);
    let TDEE=BMR*pal;
    if((p.goals||[]).includes('خسارة الدهون')|| (p.goals||[]).includes('Fat loss')) TDEE*=0.85;
    else if((p.goals||[]).includes('بناء العضلات')|| (p.goals||[]).includes('Muscle gain')) TDEE*=1.10;
    const targetW=+p.target_weight||W||1;
    const P=Math.round(2.0*targetW), F=Math.round(Math.max(0,0.8*W));
    let C=Math.round((TDEE-(P*4+F*9))/4);
    if((p.health_conditions||[]).some(h=>/سكري|الأنسولين|Insulin|Diab/i.test(h))) C=Math.min(C,120);
    C=Math.max(0,C);
    state.calc={tdee:Math.round(TDEE),P,F,C,pal};
  }

  /* ---------- AI CALL ---------- */
  async function generatePlan(){
    compute();
    lock(true);
    try{
      const prompt = buildPrompt(state.user,state.lang,state.calc);
      const r = await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
      const raw=await r.text(); let data=null; try{data=raw?JSON.parse(raw):null;}catch{}
      if(!r.ok) throw new Error(data?.error||raw||'Server error');
      renderAI(data?.text||''); audit(data?.text||'');
      notify(state.lang==='ar'?'تم إنشاء الخطة':'Plan generated','ok');
    }catch(e){ showError(e.message||String(e)); notify(t('api_error'),'err'); }
    finally{ lock(false); }
  }

  function buildPrompt(p, lang, c) {
    const weak = Object.entries(p.weak_points||{}).map(([k,v])=>`${k}: ${v}`).join(', ') || 'None';
    const meals = Number(p.meals_per_day||4);
    const fasting = p.fasting?.enabled ? `YES (${p.fasting.protocol}, window ${p.fasting.start}-${p.fasting.end})` : 'NO';

    return `
Act as "Coach Mustafa Al-Safi" (Certified International Coach).
You MUST deliver a COMPLETE, SAFE, EXECUTABLE plan in ${lang.toUpperCase()}.

HARD RULES:
1) Use clean Markdown with clear tables.
2) Calories and macros must be **accurate**:
   - Daily target: ~${c.tdee} kcal (tolerance ≤ 2%).
   - Macros per day: Protein ${c.P} g, Fat ${c.F} g, Carbs ${c.C} g.
   - Show **per-meal** calories & P/F/C AND a **Daily Total** line at the bottom of each day's table.
3) Meals per day: **${meals}**. Distribute calories/macros accordingly.
4) Fasting: ${fasting}.
   - If fasting YES: No calories outside window; water/black coffee/unsweetened tea allowed.
   - Add hydration & electrolytes guidance on fasted training.
5) Allergies/Health must be respected strictly:
   - Allergies: ${(p.allergies||[]).join(', ')||'None'}.
   - Conditions: ${(p.health_conditions||[]).join(', ')||'None'}.
   - If diabetes/insulin resistance: keep carbs ≤ 120 g/day unless rationally explained.
6) Supplements must be **condition-tailored** with safety notes.

USER SNAPSHOT:
- ${p.name} — ${p.gender}, ${p.age}y, ${p.height}cm, ${p.weight}kg
- Goals: ${(p.goals||[]).join(', ')}; Target: ${p.target_weight||'—'} by ${p.target_date||'—'}
- Experience: ${p.training_exp||'—'}, Last train: ${p.last_train||'—'}
- Weak points: ${weak}
- Diet: ${p.diet_preference||'—'}; Meals/day: ${meals}; Fasting: ${fasting}
- Lifestyle: Job ${p.job_activity||'—'}, Sleep ${p.sleep_hours||'—'}h, Stress ${p.stress_level||'—'}, Steps ${p.steps_target}/d, PAL ${c.pal}
- Daily Targets: ~${c.tdee} kcal | P ${c.P} g / F ${c.F} g / C ${c.C} g

OUTPUT (exact order, Arabic headings):

### 1) شرح الحالة والهدف من الحمية
- لخص وضع المستخدم الصحي والبدني بدقة (وزن/عمر/جنس/تاريخ تدريبي/نقاط الضعف).
- اربط الأهداف بسلوكيات يومية قابلة للقياس (سعرات/ماكروز/نوم/خطوات/تمارين).

### 2) أهم الإرشادات التنفيذية
- 6–10 نقاط قصيرة وعملية (النوم، الترطيب، البروتين، توقيت الوجبات، التعامل مع المناسبات خارج المنزل…).

### 3) قائمة المسموح والممنوع
- جدولان منفصلان: "مسموح" و"ممنوع" (يُراعي الحساسية والحالة الصحية والنظام المختار).

### 4) بروتوكول الصيام المتقطع (إن كان مفعلاً)
- اشرح البروتوكول ${p.fasting?.protocol||'—'} مع النافذة ${p.fasting?.start||'—'}–${p.fasting?.end||'—'}.
- تعليمات التدريب داخل/خارج النافذة، متى القهوة السوداء، متى الإلكتروليت، ومتى كسر الصيام.
- إن لم يكن الصيام فعالاً: ضع فقرة قصيرة تشرح لماذا ولماذا قد يُنصح به أو لا.

### 5) التغذية — 7 أيام كاملة
- لكل يوم **${meals} وجبات**.
- جدول قياسي:
| اليوم | الوجبة | المكونات (غ) | السعرات | البروتين (g) | الدهون (g) | الكارب (g) |
|---|---|---|---:|---:|---:|---:|
(اكتب كل الوجبات، ثم في الأسفل سطر: **الإجمالي اليومي: XXXX kcal — P XX / F XX / C XX** ويجب أن يطابق التارجت ±2%)

### 6) التدريب — 7 أيام كاملة
- استخدم EN لأسماء التمارين + ملاحظة عربية موجزة.
- جدول:
| اليوم | Exercise (EN) + ملاحظة | Sets | Reps | Tempo | RIR | Rest(s) |
|---|---|---:|---:|---:|---:|---:|
- راعِ الإصابات المذكورة: "${p.injuries||'None'}".
- اربط الخطة بنقاط الضعف: "${weak}".

### 7) الكارديو و NEAT
- دقائق/اليوم + منطقة النبض المستهدفة + هدف الخطوات (${p.steps_target}/اليوم).
- ماذا تفعل في أيام السفر/الضغوط.

### 8) المكملات (مخصصة للحالة)
- جدول شامل:
| المكمل | الجرعة | التوقيت | الهدف | تحذيرات |
- مثال (عدِّل حسب الحالة): Vitamin D3 (2000 IU AM)، Omega-3 (2–3 g/d with fat)، Creatine (5 g post-workout)، Magnesium glycinate (200–400 mg PM)، Electrolytes في الصيام/كيتو، Probiotic/Prebiotic للـGI… مع تحذيرات التداخلات/الحمل/الأدوية.

### 9) رسائل تحفيزية يومية
- 7 رسائل قصيرة عملية (واحدة لكل يوم) تربط السلوك بالهدف.

### 10) خطة التقدم والتعديل
- كيف تزيد الأحمال/التكرارات، وكيف تعدل السعرات ±100–150 عند ثبات الميزان، ومتى تُعاد التقييمات.

### 11) إخلاء مسؤولية وحقوق
- هذه الخطة مخصصة للمستخدم فقط. استشر طبيبك عند وجود حالات مزمنة.

**التوقيع:**
**المدرب مصطفى الصافي — خبير التغذية واللياقة البدنية │ مدرب دولي معتمد**  
**Powered by Mustafa Elsafy 2025**
`;
  }

  /* ---------- RENDER RESULTS + TOOLS ---------- */
  function renderAI(md){
    const html = marked.parse(
      md.replace(/\[SWAP:(EXERCISE|MEAL):(.*?)\]/g,(m,type,item)=>{
        const t=type.toLowerCase(); const clean=(item||'').replace(/"/g,'&quot;');
        const btn=`<button type="button" class="btn no-print" data-type="${t}" data-item="${encodeURIComponent(clean)}" onclick="swapItem(event)">${state.lang==='ar'?'تبديل':'Swap'}</button>`;
        return t==='meal'? `<span class="inline-flex items-center gap-2">${item} ${btn}</span>` : `<span class="inline-flex items-center gap-2"><b>${item}</b>${btn}</span>`;
      })
    );
    content.innerHTML = `<section class="card p-6"><article class="ai-prose max-w-none">${html}</article>
      <div class="no-print mt-4 flex gap-2"><button class="btn" onclick="doJSON()">JSON</button><button class="btn" onclick="doCSV()">CSV</button><button class="btn" onclick="window.print()">${state.lang==='ar'?'طباعة PDF':'Print PDF'}</button></div>
      <div class="mt-6 text-xs text-slate-500 border-t pt-3"><b>المدرب مصطفى الصافي — خبير التغذية واللياقة البدنية │ مدرب دولي معتمد</b><div>Powered by Mustafa Elsafy 2025</div></div></section>`;
  }

  function audit(md){
    const days = (md.match(/(?:^|\n)(?:Day|اليوم)\s*\d/gi)||[]).length;
    badgeDays.textContent = `${Math.min(days,7)}/7`;
    badgeDays.className = 'badge ' + (days===7 ? 'ok':'warn');

    const totals = [...md.matchAll(/الإجمالي اليومي\s*:\s*([\d,.]+)\s*kcal/gi)].map(m=>Number((m[1]||'0').replace(/[^\d.]/g,'')));
    badgeMacros.textContent = `±2% ${Math.min(totals.length,7)}/7`;
    badgeMacros.className = 'badge ' + (totals.length===7 ? 'ok':'warn');
  }

  async function swapItem(ev){
    const b=ev.target.closest('button'); if(!b) return;
    const type=b.dataset.type, original=decodeURIComponent(b.dataset.item||''); const old=b.textContent;
    b.disabled=true; b.textContent=state.lang==='ar'?'جاري…':'Working…';
    try{
      const prompt=(type==='meal')
        ? `Give ONE ${state.lang==='ar'?'وجبة بديلة':'alternative meal'} for "${original}" in ${state.lang.toUpperCase()}, respecting diet "${state.user.diet_preference}", avoiding "${(state.user.allergies||[]).join(', ')}". Include calories and P/F/C. End with [SWAP:MEAL:<name>].`
        : `Give ONE alternative exercise (EN name + Arabic cue) for "${original}", same muscle, safe for injuries "${state.user.injuries||'None'}". Include Sets x Reps, Tempo, RIR, Rest(s). End with [SWAP:EXERCISE:<EN>].`;
      const r=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
      const raw=await r.text(); let data=null; try{data=raw?JSON.parse(raw):null;}catch{}
      if(!r.ok) throw new Error(data?.error||raw||'Server error');
      const txt=data?.text?.trim()||'';
      b.parentElement.childNodes[0].nodeValue=(type==='meal'?txt:txt.split('\n')[0])+' ';
      b.dataset.item=encodeURIComponent(txt.replace(/\[.*?\]$/,'').trim());
    }catch{ notify(state.lang==='ar'?'تعذر التبديل':'Swap failed','err'); }
    b.disabled=false; b.textContent=old;
  }

  // Exporters
  function doJSON(){
    const payload={ user:state.user, calc:state.calc, raw:content.querySelector('.ai-prose')?.innerText||'' };
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='ai-coach-plan.json'; a.click();
  }
  function doCSV(){
    const text=content.querySelector('.ai-prose')?.innerText||''; const rows=[['section','day','type','details']];
    text.split('\n').forEach(line=>{ if(line.trim()) rows.push(['plan','','',line.trim()]); });
    const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ai-coach-plan.csv'; a.click();
  }

  /* ---------- UX ---------- */
  function notify(msg,level='ok'){ const c=document.createElement('div'); c.className=`fixed top-5 right-5 z-50 text-white px-3 py-2 rounded ${level==='ok'?'bg-emerald-600':level==='warn'?'bg-amber-600':'bg-rose-600'}`; c.textContent=msg; document.body.appendChild(c); setTimeout(()=>c.remove(),2600); }
  function showError(m){ content.innerHTML=`<section class="card p-6"><div class="p-4 bg-rose-50 border border-rose-200 rounded text-rose-800"><b>${state.lang==='ar'?'خطأ':'Error'}</b><div class="text-sm mt-1">${m}</div></div></section>`; }
  function lock(on){ btnPrev.disabled=on; btnNext.disabled=on; btnNext.textContent = on ? (state.lang==='ar'?'جارٍ التنفيذ…':'Working…') : (state.step>=12?t('submit'):t('next')); }

  // Init
  setLang('ar'); state.step=0; render();
  </script>
</body>
</html>
