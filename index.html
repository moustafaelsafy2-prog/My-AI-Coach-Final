<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>المدرب الشخصي الخبير — مصطفى الصافي</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#f6f7fb; --surface:#ffffff; --muted:#55607a;
      --border:#e6e8ee; --ink:#0b1220; --brand:#1f3a8a; --accent:#0ea5a4;
    }
    html,body{background:var(--bg);color:var(--ink);-webkit-font-smoothing:antialiased}
    .font-tajawal{font-family:'Tajawal',sans-serif}
    .font-poppins{font-family:'Poppins',sans-serif}
    .card{background:var(--surface);border:1px solid var(--border);box-shadow:0 10px 26px rgba(2,6,23,.05)}
    .btn{padding:.65rem 1rem;border-radius:.7rem;border:1px solid var(--border);transition:.2s}
    .btn:disabled{opacity:.6}
    .btn-ghost{background:#eef2f7}
    .btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn-primary:hover{background:#172554}
    .kpi{background:#f9fbff;border:1px dashed #dbe2ef}
    .badge{padding:.2rem .55rem;border-radius:.45rem;font-size:.75rem;border:1px solid}
    .ok{color:#065f46;background:#ecfdf5;border-color:#a7f3d0}
    .warn{color:#92400e;background:#fffbeb;border-color:#fde68a}
    .err{color:#991b1b;background:#fef2f2;border-color:#fecaca}
    .k-table th,.k-table td{border:1px solid #e5e7eb;padding:.6rem .55rem;vertical-align:top}
    .k-table th{background:#f8fafc;font-weight:700}
    header{background:linear-gradient(90deg,rgba(31,58,138,.08),rgba(14,165,164,.08))}
    .sr{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    @media print{
      header,#sticky,.no-print{display:none!important}
      body{background:#fff}
      #app{box-shadow:none;border:none;max-width:100%;margin:0}
      .page-break{page-break-before:always}
    }
  </style>
</head>

<body class="font-tajawal min-h-screen">
  <!-- Topbar -->
  <header class="px-4 sm:px-6 py-3 flex items-center justify-between border-b">
    <div class="leading-tight">
      <div class="text-xs text-slate-600">COACH</div>
      <div class="font-extrabold">Mustafa Al-Safi</div>
      <div class="text-xs text-slate-500">Certified International Coach</div>
    </div>
    <div class="flex items-center gap-2">
      <button id="cmd-print" class="btn no-print" type="button" title="Print PDF">طباعة PDF</button>
      <button id="btn-en" class="btn" type="button" title="English UI">EN</button>
      <button id="btn-ar" class="btn btn-primary" type="button" title="Arabic UI">عربي</button>
    </div>
  </header>

  <!-- Shell -->
  <div id="app" class="max-w-5xl mx-auto my-6 sm:my-10 card rounded-2xl overflow-hidden">
    <!-- Hero -->
    <div class="p-6 sm:p-8">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-center">المدرب الشخصي الخبير</h1>
      <p class="text-sm text-slate-600 text-center mt-1">خطة دقيقة 100% للتغذية والتدريب والمكملات — مخصصة وفق أهدافك وصحتك ونمط حياتك.</p>
      <p class="text-xs text-slate-500 text-center mt-1">
        المدرب مصطفى الصافي — خبير التغذية واللياقة البدنية │ مدرب دولي معتمد • Powered by Mustafa Elsafy 2025
      </p>

      <div class="grid sm:grid-cols-3 gap-3 mt-5">
        <div class="kpi p-3 rounded-lg">
          <div class="text-xs text-slate-600 mb-1">العلامة المهنية</div>
          <div class="text-sm">Coach: Mustafa Al-Safi — International Certified</div>
          <div class="text-xs text-slate-500 mt-1">Powered by Mustafa Elsafy 2025</div>
        </div>
        <div class="kpi p-3 rounded-lg">
          <div class="text-xs text-slate-600 mb-1">سلامة الخطة</div>
          <div class="flex items-center gap-2">
            <span id="badgeDays" class="badge warn">0/7</span>
            <span id="badgeMacros" class="badge warn">±2% 0/7</span>
          </div>
        </div>
        <div class="kpi p-3 rounded-lg">
          <div class="text-xs text-slate-600 mb-1">مرحلة التقدم</div>
          <div class="h-2.5 bg-gray-200 rounded-full overflow-hidden">
            <div id="progress" class="h-full bg-gradient-to-r from-indigo-600 to-cyan-600 transition-all duration-300" style="width:0%"></div>
          </div>
          <div class="mt-2 text-xs text-gray-500">الخطوة <span id="step">0</span> من 12</div>
        </div>
      </div>
    </div>

    <!-- Dynamic content -->
    <main id="content" class="p-5 sm:p-8"></main>

    <!-- Sticky nav -->
    <div id="sticky" class="sticky bottom-0 bg-white/90 backdrop-blur-md border-t px-4 sm:px-6 py-3 flex gap-3 justify-between">
      <button id="prev" class="btn btn-ghost w-1/3 sm:w-44" type="button">السابق</button>
      <button id="next" class="btn btn-primary flex-1" type="button">التالي</button>
    </div>
  </div>

  <!-- App -->
  <script>
  /* =========================
     STATE & I18N
  ========================== */
  const TOTAL = 12;
  const content = document.getElementById('content');
  const progressBar = document.getElementById('progress');
  const stepEl = document.getElementById('step');
  const badgeDays = document.getElementById('badgeDays');
  const badgeMacros = document.getElementById('badgeMacros');
  const btnPrev = document.getElementById('prev');
  const btnNext = document.getElementById('next');
  const btnAr = document.getElementById('btn-ar');
  const btnEn = document.getElementById('btn-en');

  let state = {
    lang: 'ar',
    step: 0,
    user: {
      name: '',
      age: null, height: null, weight: null, gender: 'Male',
      goals: [], target_weight: null, target_date: null,
      diet_preference: 'Balanced / متوازن',
      meals_per_day: 4,
      fasting: { enabled: false, protocol: '16:8', start: '12:00', end: '20:00' },
      allergies: [], other_allergies: '',
      last_train: '', training_exp: 'مبتدئ',
      weak_points: {}, health_conditions: [], injuries: '',
      job_activity: 'مكتبي', sleep_hours: null, stress_level: 'متوسط',
      steps_target: 9000,
      has_photos: false, has_inbody: false
    },
    calc: { tdee: 0, P: 0, F: 0, C: 0, pal: 1.35 }
  };

  const I = {
    ar: {
      start:"ابدأ", next:"التالي", prev:"السابق", submit:"احصل على خطتك الآن!",
      welcome_title:"أهلاً بك!", welcome_desc:"سأصمم لك خطة مكتملة للتغذية والتدريب والمكملات.",
      name_q:"الاسم", age:"العمر", height:"الطول (سم)", weight:"الوزن (كغ)", gender:"الجنس", male:"ذكر", female:"أنثى",
      stage_1:"من أنت؟", stage_2:"بيانات أساسية", stage_3:"الأهداف", stage_4:"هدف متقدم", stage_5:"نظامك المفضل",
      stage_6:"الحساسية", stage_7:"تاريخ رياضي", stage_8:"نقاط التركيز", stage_9:"الصحة", stage_10:"نمط الحياة", stage_11:"ملفات اختيارية",
      api_error:"تعذر الاتصال بالموديل. تحقق من الدالة أو المفتاح."
    },
    en: {
      start:"Start", next:"Next", prev:"Back", submit:"Generate Plan",
      welcome_title:"Welcome!", welcome_desc:"I will craft a complete plan for nutrition, training, and supplements.",
      name_q:"Name", age:"Age", height:"Height (cm)", weight:"Weight (kg)", gender:"Gender", male:"Male", female:"Female",
      stage_1:"Who are you?", stage_2:"Basics", stage_3:"Goals", stage_4:"Advanced Target", stage_5:"Preferred Diet",
      stage_6:"Allergies", stage_7:"Training History", stage_8:"Focus Areas", stage_9:"Health", stage_10:"Lifestyle", stage_11:"Optional Files",
      api_error:"Cannot reach the model. Check the function or API key."
    }
  };
  function t(k){return I[state.lang][k]||k}
  function setLang(l){
    state.lang=l; document.documentElement.lang=l; document.documentElement.dir=(l==='ar'?'rtl':'ltr');
    document.body.classList.toggle('font-tajawal',l==='ar'); document.body.classList.toggle('font-poppins',l!=='ar');
    btnEn.className='btn '+(l==='en'?'btn-primary':''); btnAr.className='btn '+(l==='ar'?'btn-primary':'');
    updateCTA();
  }
  btnAr.onclick=()=>setLang('ar'); btnEn.onclick=()=>setLang('en');
  document.getElementById('cmd-print').onclick=()=>window.print();

  /* =========================
     RENDER UTILS
  ========================== */
  function updateProgress(){ const p=Math.max(0,((state.step-1)/TOTAL)*100); progressBar.style.width=p+'%'; stepEl.textContent=String(Math.min(state.step,TOTAL)); }
  function updateCTA(){ btnPrev.textContent=t('prev'); btnNext.textContent = state.step===TOTAL ? t('submit') : t('next'); btnPrev.disabled=state.step<=1; }
  function field(label,id,opt={}){ const {type='text',value='',required=false,select=null,placeholder='',num=false}=opt;
    if(select) return `<label class="block"><span class="font-medium">${label}</span><select id="${id}" class="mt-1 w-full p-3 border rounded-lg">${select.map(o=>`<option ${String(value)===String(o.value)?'selected':''} value="${o.value}">${o.label}</option>`).join('')}</select></label>`;
    if(type==='textarea') return `<label class="block"><span class="font-medium">${label}</span><textarea id="${id}" rows="3" placeholder="${placeholder}" class="mt-1 w-full p-3 border rounded-lg">${value||''}</textarea></label>`;
    return `<label class="block"><span class="font-medium">${label}</span><input id="${id}" type="${type}" ${required?'required':''} value="${value}" placeholder="${placeholder}" ${num?'inputmode="numeric" pattern="[0-9]*"':''} class="mt-1 w-full p-3 border rounded-lg"></label>`;
  }
  function stage(title,desc,inner){ return `<section><h2 class="text-2xl sm:text-3xl font-extrabold">${title}</h2><p class="mt-1 text-slate-600">${desc||''}</p><form class="space-y-5 mt-6" onsubmit="event.preventDefault();">${inner}</form></section>` }

  /* =========================
     STAGES
  ========================== */
  function render(){
    updateProgress(); updateCTA();
    const s = state.user; let html='';
    switch(state.step){
      case 0:
        content.innerHTML=`<section class="text-center p-10"><h2 class="text-3xl font-extrabold mb-2">${t('welcome_title')}</h2><p class="text-slate-600">${t('welcome_desc')}</p><div class="mt-6 inline-flex items-center gap-2"><select id="lang-select" class="p-3 border rounded"><option value="ar">العربية</option><option value="en">English</option></select><button id="start" class="btn btn-primary">${t('start')}</button></div></section>`;
        document.getElementById('start').onclick=()=>{ setLang(document.getElementById('lang-select').value); state.step=1; render(); }; break;

      case 1:
        html = field(t('name_q'),'name',{required:true,value:s.name||''});
        content.innerHTML=stage(t('stage_1'),' ',html); break;

      case 2:
        html = `<div class="grid sm:grid-cols-2 gap-4">
          ${field(t('age'),'age',{type:'number',num:true,value:s.age||'',required:true})}
          ${field(t('height'),'height',{type:'number',num:true,value:s.height||'',required:true})}
          ${field(t('weight'),'weight',{type:'number',num:true,value:s.weight||'',required:true})}
          ${field(t('gender'),'gender',{select:[{value:'Male',label:t('male')},{value:'Female',label:t('female')}],value:s.gender||'Male'})}
        </div>`;
        content.innerHTML=stage(t('stage_2'),' ',html); break;

      case 3:
        const goals = (state.lang==='ar')? ['خسارة الدهون','بناء العضلات','زيادة القوة','تحسين التحمل','صحة عامة'] : ['Fat loss','Muscle gain','Strength','Endurance','General health'];
        html = `<div class="grid sm:grid-cols-2 gap-2">${goals.map(g=>`<label class="p-3 border rounded cursor-pointer"><input type="checkbox" name="goal" value="${g}" class="mr-2 accent-indigo-600"> ${g}</label>`).join('')}</div>`;
        content.innerHTML=stage(t('stage_3'),' ',html); break;

      case 4:
        html = `<div class="grid sm:grid-cols-2 gap-4">
          ${field('Target weight / الوزن المستهدف','target_weight',{type:'number',num:true,value:s.target_weight||''})}
          ${field('Target date / تاريخ الهدف','target_date',{type:'date',value:s.target_date||''})}
        </div>`;
        content.innerHTML=stage(t('stage_4'),' ',html); break;

      case 5: {
        const ds = [
          'Balanced / متوازن','Low-Carb / قليل الكربوهيدرات','IF / صيام متقطع',
          'Keto / كيتو','Mediterranean / البحر المتوسط','Plant-based / نباتي'
        ];
        const showFasting = (s.goals||[]).some(g => /خسارة|Fat/i.test(g)) ||
                            (s.health_conditions||[]).some(h => /سكري|Insulin|Diab/i.test(h)) ||
                            /IF|صيام/.test(s.diet_preference);

        const fastingBlock = `
          <div id="fasting-wrap" class="${showFasting?'':'hidden'} grid sm:grid-cols-3 gap-3 mt-2 border p-3 rounded">
            <label class="flex items-center gap-2">
              <input id="fasting_enabled" type="checkbox" class="accent-indigo-600" ${s.fasting?.enabled?'checked':''}>
              <span>تفعيل الصيام المتقطع</span>
            </label>
            <label>
              <span class="text-sm text-slate-600">البروتوكول</span>
              <select id="fasting_protocol" class="mt-1 w-full p-2 border rounded">
                ${['14:10','16:8','18:6'].map(p=>`<option ${s.fasting?.protocol===p?'selected':''}>${p}</option>`).join('')}
              </select>
            </label>
            <div class="grid grid-cols-2 gap-2">
              <label><span class="text-sm text-slate-600">نافذة الأكل من</span>
                <input id="fasting_start" type="time" value="${s.fasting?.start||'12:00'}" class="mt-1 w-full p-2 border rounded">
              </label>
              <label><span class="text-sm text-slate-600">إلى</span>
                <input id="fasting_end" type="time" value="${s.fasting?.end||'20:00'}" class="mt-1 w-full p-2 border rounded">
              </label>
            </div>
            <p class="sm:col-span-3 text-xs text-slate-500">* لا تُتَناول السعرات خارج النافذة. الماء/القهوة السوداء/الشاي بدون سكر مسموح. أضف إلكترولايت عند التدريب صباحًا.</p>
          </div>`;

        const mealsSelect = `
          <label class="block">
            <span class="font-medium">عدد الوجبات/اليوم</span>
            <select id="meals_per_day" class="mt-1 w-full p-3 border rounded">
              ${[3,4,5,6].map(n=>`<option ${Number(s.meals_per_day)===n?'selected':''} value="${n}">${n}</option>`).join('')}
            </select>
          </label>`;

        const html5 = `
          ${field(t('stage_5'),'diet_preference',{select:ds.map(x=>({value:x,label:x})), value:s.diet_preference||ds[0]})}
          ${mealsSelect}
          ${fastingBlock}`;

        content.innerHTML = stage(t('stage_5'),'اختر نظامك، حدّد عدد الوجبات، وفعّل الصيام إن كان مناسباً.', html5);

        setTimeout(()=>{
          const dp = document.getElementById('diet_preference');
          dp?.addEventListener('change',()=>document.getElementById('fasting-wrap')?.classList.toggle('hidden', !/IF|صيام/.test(dp.value)));
        },0);
        break;
      }

      case 6:
        const al = ['الجلوتين','اللاكتوز','المكسرات','المأكولات البحرية','السكريات المصنعة','الزيوت النباتية المصنعة','البقوليات'];
        html = `<div class="grid sm:grid-cols-2 gap-2">${al.map(v=>`<label class="p-3 border rounded cursor-pointer"><input type="checkbox" name="allergy" value="${v}" class="mr-2 accent-indigo-600"> ${v}</label>`).join('')}</div>${field('حساسيات أخرى (اختياري)','other_allergies',{value:s.other_allergies||''})}`;
        content.innerHTML=stage(t('stage_6'),' ',html); break;

      case 7:
        html = `${field('آخر التزام تدريبي','last_train',{select:[{value:'آخر 3 أشهر',label:'آخر 3 أشهر'},{value:'3-12 شهر',label:'3-12 شهر'},{value:'أكثر من سنة',label:'أكثر من سنة'}],value:s.last_train||'آخر 3 أشهر'})}
                ${field('خبرتك في المقاومة','training_exp',{select:[{value:'مبتدئ',label:'مبتدئ'},{value:'متوسط',label:'متوسط'},{value:'متقدم',label:'متقدم'}],value:s.training_exp||'مبتدئ'})}`;
        content.innerHTML=stage(t('stage_7'),' ',html); break;

      case 8:
        const muscles=['chest','back','shoulders','biceps','triceps','quads','hamstrings','glutes','calves','abs'];
        html = `<div class="space-y-3">${muscles.map(m=>`<div class="flex items-center gap-3"><input id="${m}" type="checkbox" class="accent-indigo-600"><label class="w-28">${m}</label><input id="${m}_desc" class="flex-1 p-2 border rounded" placeholder="وصف الهدف"></div>`).join('')}</div>`;
        content.innerHTML=stage(t('stage_8'),' ',html); break;

      case 9:
        const cond=['ضغط الدم','السكري','مقاومة الأنسولين','الغدة الدرقية','الكبد الدهني','مشاكل هرمونية','الجهاز الهضمي'];
        html = `<div class="grid sm:grid-cols-2 gap-2">${cond.map(v=>`<label class="p-3 border rounded cursor-pointer"><input type="checkbox" name="hc" value="${v}" class="mr-2 accent-indigo-600"> ${v}</label>`).join('')}</div>${field('إصابات (اختياري)','injuries',{type:'textarea',value:s.injuries||''})}`;
        content.innerHTML=stage(t('stage_9'),' ',html); break;

      case 10:
        html = `<div class="grid sm:grid-cols-3 gap-4">
          ${field('طبيعة العمل','job_activity',{select:[{value:'مكتبي',label:'مكتبي'},{value:'نشاط خفيف',label:'نشاط خفيف'},{value:'نشاط متوسط',label:'نشاط متوسط'}],value:s.job_activity||'مكتبي'})}
          ${field('ساعات النوم','sleep_hours',{type:'number',num:true,value:s.sleep_hours||'',required:true})}
          ${field('مستوى التوتر','stress_level',{select:[{value:'منخفض',label:'منخفض'},{value:'متوسط',label:'متوسط'},{value:'مرتفع',label:'مرتفع'}],value:s.stress_level||'متوسط'})}
        </div>${field('هدف الخطوات اليومية (NEAT)','steps_target',{type:'number',num:true,value:s.steps_target||9000})}`;
        content.innerHTML=stage(t('stage_10'),' ',html); break;

      case 11:
        html = `<div class="grid sm:grid-cols-2 gap-4">
          <label class="p-6 border rounded-xl text-center cursor-pointer">📷 صور الجسم<input type="file" id="photos" class="hidden" multiple accept="image/*"></label>
          <label class="p-6 border rounded-xl text-center cursor-pointer">📄 InBody<input type="file" id="inbody" class="hidden" accept="image/*,.pdf"></label>
        </div>`;
        content.innerHTML=stage(t('stage_11'),' ',html); break;

      case 12:
        content.innerHTML=`<section class="text-center p-8">
          <h2 class="text-2xl font-extrabold mb-1">${state.user.name?('معك '+state.user.name):'جارٍ التحليل'}</h2>
          <p class="text-slate-600">أقوم بتحليل بياناتك لصياغة خطة دقيقة ومتكاملة…</p>
          <div class="mt-6 animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600 mx-auto" aria-label="Loading"></div>
          <div id="plan" class="mt-8"></div>
          <div id="rawErr" class="hidden mt-6 text-left text-xs p-3 bg-rose-50 border border-rose-200 rounded"></div>
        </section>`;
        generatePlan(); break;
    }
  }

  /* =========================
     SAVE & NAV
  ========================== */
  function saveAndNext(){
    const s=state.user;
    try{
      switch(state.step){
        case 1: s.name=document.getElementById('name').value.trim(); if(!s.name) throw 0; break;
        case 2: s.age=+document.getElementById('age').value; s.height=+document.getElementById('height').value; s.weight=+document.getElementById('weight').value; s.gender=document.getElementById('gender').value; if(!s.age||!s.height||!s.weight) throw 0; break;
        case 3: s.goals=[...document.querySelectorAll('input[name="goal"]:checked')].map(e=>e.value); if(!s.goals.length) throw 0; break;
        case 4: s.target_weight=+document.getElementById('target_weight').value||null; s.target_date=document.getElementById('target_date').value||null; break;
        case 5:
          s.diet_preference = document.getElementById('diet_preference').value;
          s.meals_per_day = Number(document.getElementById('meals_per_day').value)||4;
          if (document.getElementById('fasting_enabled')) {
            s.fasting = {
              enabled: document.getElementById('fasting_enabled').checked,
              protocol: document.getElementById('fasting_protocol').value,
              start: document.getElementById('fasting_start').value,
              end: document.getElementById('fasting_end').value
            };
          }
          break;
        case 6: s.allergies=[...document.querySelectorAll('input[name="allergy"]:checked')].map(e=>e.value); const other=document.getElementById('other_allergies').value.trim(); if(other) s.allergies.push(other); break;
        case 7: s.last_train=document.getElementById('last_train').value; s.training_exp=document.getElementById('training_exp').value; break;
        case 8: const muscles=['chest','back','shoulders','biceps','triceps','quads','hamstrings','glutes','calves','abs']; s.weak_points={}; muscles.forEach(m=>{ const cb=document.getElementById(m); if(cb?.checked) s.weak_points[m]=document.getElementById(m+'_desc').value||'Strengthening'; }); break;
        case 9: s.health_conditions=[...document.querySelectorAll('input[name="hc"]:checked')].map(e=>e.value); s.injuries=document.getElementById('injuries').value||''; break;
        case 10: s.job_activity=document.getElementById('job_activity').value; s.sleep_hours=+document.getElementById('sleep_hours').value; s.stress_level=document.getElementById('stress_level').value; s.steps_target=+document.getElementById('steps_target').value||9000; if(!s.sleep_hours) throw 0; break;
        case 11: s.has_photos=document.getElementById('photos')?.files.length>0; s.has_inbody=document.getElementById('inbody')?.files.length>0; break;
      }
      state.step++; render();
    }catch{ notify(state.lang==='ar'?'أكمل الحقول المطلوبة':'Complete required fields','err'); }
  }
  function back(){ if(state.step>1){ state.step--; render(); } }
  btnPrev.onclick=back; btnNext.onclick=()=>{ if(state.step<TOTAL) saveAndNext(); else generatePlan(); };

  /* =========================
     CALCULATIONS
  ========================== */
  function compute(){
    const p=state.user; const W=+p.weight||0,H=+p.height||0,A=+p.age||0; const male=p.gender==='Male';
    const BMR = male ? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161;
    const pal = p.job_activity==='مكتبي' ? 1.2 : (p.job_activity==='نشاط متوسط' ? 1.5 : 1.35);
    let TDEE=BMR*pal;
    if((p.goals||[]).includes('خسارة الدهون')|| (p.goals||[]).includes('Fat loss')) TDEE*=0.85;
    else if((p.goals||[]).includes('بناء العضلات')|| (p.goals||[]).includes('Muscle gain')) TDEE*=1.10;
    const targetW=+p.target_weight||W||1;
    const P=Math.round(2.0*targetW), F=Math.round(Math.max(0,0.8*W));
    let C=Math.round((TDEE-(P*4+F*9))/4);
    if((p.health_conditions||[]).some(h=>/سكري|الأنسولين|Insulin|Diab/i.test(h))) C=Math.min(C,120);
    C=Math.max(0,C);
    state.calc={tdee:Math.round(TDEE),P,F,C,pal};
  }

  /* =========================
     JSON GENERATION (Robust)
  ========================== */
  async function generatePlan(){
    compute(); lock(true);
    const proxy = '/.netlify/functions/gemini-proxy';
    const prompt = buildJSONPrompt(state.user, state.lang, state.calc);

    try {
      let raw = await callRaw(proxy, prompt);
      let plan = safeExtractJSON(raw);

      if (!isValidPlan(plan)) {
        // إعادة محاولة مع تشديد التعليمات
        raw = await callRaw(proxy, prompt + '\nReturn VALID JSON only (no markdown, no code fences, no explanations).');
        plan = safeExtractJSON(raw);
      }
      if (!isValidPlan(plan)) throw new Error('Invalid JSON');

      const fixed = validateAndFix(plan, state.calc, state.user.meals_per_day || 4);
      renderFromJSON(fixed);
      auditOK();
      notify(state.lang==='ar'?'تم إنشاء خطة دقيقة':'Accurate plan generated','ok');
    } catch (e) {
      showRawError(e.message);
    } finally {
      lock(false);
    }
  }

  // يستدعي البروكسي ويرجع النص كما هو
  async function callRaw(url, prompt){
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({prompt}) });
    const text = await res.text();
    if (!res.ok) throw new Error(text || 'Server error');
    try { const j=JSON.parse(text); return (typeof j.text==='string') ? j.text : text; } catch { return text; }
  }

  // استخراج JSON حتى لو ملفوف داخل ```json أو يوجد نص زائد
  function safeExtractJSON(text){
    if (!text) return null;
    // إزالة code fences إن وجدت
    text = text.replace(/^\s*```(?:json)?\s*/i,'').replace(/\s*```\s*$/,'').trim();
    // إن بقي كلام زائد قبل/بعد JSON، نلتقط أول { وآخر } مع التوازن
    const block = extractJSONObject(text);
    if (!block) return null;
    try { return JSON.parse(block); } catch { return null; }
  }

  // يلتقط أول كائن JSON متوازن من النص
  function extractJSONObject(s){
    const start = s.indexOf('{');
    if (start === -1) return null;
    let depth = 0;
    for (let i=start;i<s.length;i++){
      const ch = s[i];
      if (ch === '{') depth++;
      else if (ch === '}'){
        depth--;
        if (depth === 0) return s.slice(start, i+1);
      }
    }
    return null;
  }

  function isValidPlan(p){
    return p && Array.isArray(p.nutrition) && p.nutrition.length>=7 && Array.isArray(p.training) && p.training.length>=7;
  }

  /* =========================
     PROMPT (STRICT JSON CONTRACT)
  ========================== */
  function buildJSONPrompt(p, lang, c) {
    const meals = Number(p.meals_per_day || 4);
    const fastingEnabled = !!(p.fasting && p.fasting.enabled);
    const fastingMeta = fastingEnabled
      ? `YES | protocol ${p.fasting.protocol} | window ${p.fasting.start}-${p.fasting.end}`
      : 'NO';

    const schema = `
{
  "profile": { "name": "string", "gender": "Male|Female", "age": "number", "height_cm": "number", "weight_kg": "number" },
  "diagnosis": "string",
  "guidelines": ["string"],
  "allowed": ["string"], "avoid": ["string"],
  "fasting": { "enabled": "boolean", "protocol": "string", "window": "HH:MM-HH:MM", "notes": ["string"] },
  "nutrition": [
    { "day": 1, "meals": [ { "name": "string", "kcal": "number", "p": "number", "f": "number", "c": "number" } ],
      "daily_total": { "kcal": "number", "p": "number", "f": "number", "c": "number" } }
  ],
  "training": [
    { "day": 1, "blocks": [
      { "exercise_en": "string", "note_ar": "string", "sets": "number", "reps": "string", "tempo": "string", "rir": "number", "rest": "number" }
    ]}
  ],
  "cardio_neat": { "minutes_per_day": "number", "zone": "string", "steps_target": "number" },
  "supplements": [
    { "name": "string", "dose": "string", "timing": "string", "goal": "string", "warnings": "string" }
  ],
  "motivation": ["string","string","string","string","string","string","string"],
  "progression": "string",
  "disclaimer": "string",
  "signature": "string"
}`;

    return `
You are Coach "Mustafa Al-Safi" (Certified International Coach).
Return STRICT JSON ONLY that matches the <SCHEMA>. No markdown, no code fences, no explanations.

<CONTEXT>
LANG=${lang.toUpperCase()} (Food & narrative in ${lang}; exercise names in EN + short AR note)
GOALS=${(p.goals||[]).join(', ') || '—'}
DIET=${p.diet_preference || 'Balanced'}
ALLERGIES=${(p.allergies||[]).join(', ') || 'None'}
CONDITIONS=${(p.health_conditions||[]).join(', ') || 'None'}
INJURIES=${p.injuries || 'None'}
MEALS_PER_DAY=${meals}
FASTING=${fastingMeta}
PAL=${c.pal}
DAILY_TARGET=~${c.tdee} kcal (±2%) | P=${c.P}g F=${c.F}g C=${c.C}g
CARB_CAP_IF_IR_OR_DM=≤120g/day unless clearly justified
USER=${p.name || 'Client'} | ${p.gender}, ${p.age}y, ${p.height}cm, ${p.weight}kg
</CONTEXT>

<HARD RULES>
1) 7 days for both nutrition and training — no missing days.
2) For each day: exactly ${meals} meals. Per-meal kcal/P/F/C + "daily_total" matching targets (±2%).
3) Respect allergies/conditions strictly. If diabetic/IR: carbs ≤120 g/day unless justified.
4) FASTING=${fastingMeta}. If YES: include hydration/electrolytes/fasted training notes.
5) Supplements: condition-tailored with dose/timing/goal/warnings.
6) Realistic, executable, safe language.

<SCHEMA>
${schema}
</SCHEMA>
`;
  }

  /* =========================
     VALIDATE & FIX
  ========================== */
  function validateAndFix(plan, calc, mealsPerDay){
    const tgt = { kcal: calc.tdee, p: calc.P, f: calc.F, c: calc.C };
    const tol = 0.02; // ±2%

    plan.nutrition = (plan.nutrition||[]).slice(0,7);
    while(plan.nutrition.length<7){
      plan.nutrition.push({ day: plan.nutrition.length+1, meals: [], daily_total:{kcal:0,p:0,f:0,c:0} });
    }
    plan.training = (plan.training||[]).slice(0,7);
    while(plan.training.length<7){ plan.training.push({ day: plan.training.length+1, blocks: [] }); }

    plan.nutrition = plan.nutrition.map(d=>{
      d.meals = (d.meals||[]).slice(0, mealsPerDay);
      while(d.meals.length<mealsPerDay){ d.meals.push({name:'Balanced Meal',kcal:0,p:0,f:0,c:0}); }

      const sum = d.meals.reduce((a,m)=>({kcal:a.kcal+(+m.kcal||0), p:a.p+(+m.p||0), f:a.f+(+m.f||0), c:a.c+(+m.c||0)}), {kcal:0,p:0,f:0,c:0});

      const needAdj = (Math.abs(sum.kcal - tgt.kcal) / tgt.kcal > tol)
        || Math.abs(sum.p - tgt.p) > 2
        || Math.abs(sum.f - tgt.f) > 2
        || Math.abs(sum.c - tgt.c) > 3;

      if (needAdj) {
        const per = { kcal: tgt.kcal / mealsPerDay, p: tgt.p / mealsPerDay, f: tgt.f / mealsPerDay, c: tgt.c / mealsPerDay };
        d.meals = d.meals.map((m,i)=>({
          name: m.name || `Meal ${i+1}`,
          kcal: Math.round(per.kcal),
          p: Math.round(per.p),
          f: Math.round(per.f),
          c: Math.round(per.c)
        }));
      }

      const fin = d.meals.reduce((a,m)=>({kcal:a.kcal+m.kcal, p:a.p+m.p, f:a.f+m.f, c:a.c+m.c}), {kcal:0,p:0,f:0,c:0});
      d.daily_total = fin;
      return d;
    });

    plan.supplements = (plan.supplements||[]).map(s=>({
      name: s.name||'—', dose: s.dose||'—', timing: s.timing||'—', goal: s.goal||'—', warnings: s.warnings||'—'
    }));

    plan.signature = 'المدرب مصطفى الصافي — خبير التغذية واللياقة البدنية │ مدرب دولي معتمد • Powered by Mustafa Elsafy 2025';
    plan.disclaimer = plan.disclaimer || 'هذه الخطة شخصية ولا تُستخدم لغيرك. في وجود حالات مزمنة أو أدوية، استشر طبيبك.';
    return plan;
  }

  /* =========================
     RENDER FROM JSON
  ========================== */
  function renderFromJSON(plan){
    const kpi = `
      <div class="grid sm:grid-cols-4 gap-3">
        <div class="card p-3"><div class="text-xs text-slate-600">TDEE</div><div class="font-bold">${state.calc.tdee} kcal</div></div>
        <div class="card p-3"><div class="text-xs text-slate-600">Protein</div><div class="font-bold">${state.calc.P} g</div></div>
        <div class="card p-3"><div class="text-xs text-slate-600">Fat</div><div class="font-bold">${state.calc.F} g</div></div>
        <div class="card p-3"><div class="text-xs text-slate-600">Carbs</div><div class="font-bold">${state.calc.C} g</div></div>
      </div>`;

    const diag = `<section class="card p-5 mt-4">
        <h3 class="text-lg font-bold mb-2">شرح الحالة والهدف</h3>
        <p class="text-slate-700">${escapeHTML(plan.diagnosis||'')}</p>
      </section>`;

    const guide = `<section class="card p-5 mt-4">
        <h3 class="text-lg font-bold mb-2">أهم الإرشادات</h3>
        <ul class="list-disc pr-6 text-slate-700">${(plan.guidelines||[]).map(x=>`<li>${escapeHTML(x)}</li>`).join('')}</ul>
      </section>`;

    const allowAvoid = `<section class="card p-5 mt-4">
        <h3 class="text-lg font-bold mb-2">قائمة المسموح والممنوع</h3>
        <div class="grid sm:grid-cols-2 gap-4">
          <div><div class="font-bold mb-1">مسموح</div><ul class="list-disc pr-6">${(plan.allowed||[]).map(x=>`<li>${escapeHTML(x)}</li>`).join('')}</ul></div>
          <div><div class="font-bold mb-1">ممنوع</div><ul class="list-disc pr-6">${(plan.avoid||[]).map(x=>`<li>${escapeHTML(x)}</li>`).join('')}</ul></div>
        </div>
      </section>`;

    const fasting = plan.fasting?.enabled ? `<section class="card p-5 mt-4">
        <h3 class="text-lg font-bold mb-2">بروتوكول الصيام المتقطع</h3>
        <p class="text-slate-700">البروتوكول: <b>${escapeHTML(plan.fasting.protocol)}</b> — نافذة الأكل: <b>${escapeHTML(plan.fasting.window)}</b></p>
        <ul class="list-disc pr-6 mt-2 text-slate-700">${(plan.fasting.notes||[]).map(x=>`<li>${escapeHTML(x)}</li>`).join('')}</ul>
      </section>` : '';

    const nutrition = `<section class="card p-5 mt-4">
        <h3 class="text-lg font-bold mb-3">التغذية — 7 أيام</h3>
        ${plan.nutrition.map(d=>`
          <div class="mb-5">
            <div class="font-bold mb-1">اليوم ${d.day}</div>
            <div class="overflow-auto">
              <table class="w-full border-collapse k-table" role="table" aria-label="Nutrition Day ${d.day}">
                <thead><tr>
                  <th>الوجبة</th><th>السعرات</th><th>P</th><th>F</th><th>C</th>
                </tr></thead>
                <tbody>
                  ${d.meals.map(m=>`
                    <tr>
                      <td>${escapeHTML(m.name)}</td>
                      <td class="text-right">${m.kcal}</td>
                      <td class="text-right">${m.p}</td>
                      <td class="text-right">${m.f}</td>
                      <td class="text-right">${m.c}</td>
                    </tr>`).join('')}
                  <tr class="bg-slate-50 font-bold">
                    <td>الإجمالي اليومي</td>
                    <td class="text-right">${d.daily_total.kcal}</td>
                    <td class="text-right">${d.daily_total.p}</td>
                    <td class="text-right">${d.daily_total.f}</td>
                    <td class="text-right">${d.daily_total.c}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>`).join('')}
      </section>`;

    const training = `<section class="card p-5 mt-4">
        <h3 class="text-lg font-bold mb-3">التدريب — 7 أيام</h3>
        ${plan.training.map(d=>`
          <div class="mb-5">
            <div class="font-bold mb-1">اليوم ${d.day}</div>
            <div class="overflow-auto">
              <table class="w-full border-collapse k-table" role="table" aria-label="Training Day ${d.day}">
                <thead><tr>
                  <th>Exercise (EN) + ملاحظة</th><th>Sets</th><th>Reps</th><th>Tempo</th><th>RIR</th><th>Rest(s)</th>
                </tr></thead>
                <tbody>
                  ${(d.blocks||[]).map(b=>`
                    <tr>
                      <td>${escapeHTML(b.exercise_en)} — <span class="text-slate-600">${escapeHTML(b.note_ar||'')}</span></td>
                      <td class="text-right">${b.sets||'-'}</td>
                      <td class="text-right">${b.reps||'-'}</td>
                      <td class="text-right">${b.tempo||'-'}</td>
                      <td class="text-right">${b.rir??'-'}</td>
                      <td class="text-right">${b.rest||'-'}</td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>`).join('')}
      </section>`;

    const cardio = `<section class="card p-5 mt-4">
        <h3 class="text-lg font-bold mb-2">الكارديو و NEAT</h3>
        <p class="text-slate-700">
          دقائق يوميًا: <b>${(plan.cardio_neat||{}).minutes_per_day || 0}</b> •
          المنطقة: <b>${escapeHTML((plan.cardio_neat||{}).zone || '-')}</b> •
          هدف الخطوات: <b>${(plan.cardio_neat||{}).steps_target || state.user.steps_target}</b>
        </p>
      </section>`;

    const supp = `<section class="card p-5 mt-4">
        <h3 class="text-lg font-bold mb-2">المكملات</h3>
        <div class="overflow-auto">
          <table class="w-full border-collapse k-table">
            <thead><tr>
              <th>المكمل</th><th>الجرعة</th><th>التوقيت</th><th>الهدف</th><th>تحذيرات</th>
            </tr></thead>
            <tbody>
              ${(plan.supplements||[]).map(s=>`
                <tr>
                  <td>${escapeHTML(s.name)}</td>
                  <td>${escapeHTML(s.dose)}</td>
                  <td>${escapeHTML(s.timing)}</td>
                  <td>${escapeHTML(s.goal)}</td>
                  <td>${escapeHTML(s.warnings)}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </section>`;

    const motivation = `<section class="card p-5 mt-4">
        <h3 class="text-lg font-bold mb-2">رسائل تحفيزية يومية</h3>
        <ol class="list-decimal pr-6 text-slate-700">${(plan.motivation||[]).slice(0,7).map(x=>`<li>${escapeHTML(x)}</li>`).join('')}</ol>
      </section>`;

    const progression = `<section class="card p-5 mt-4">
        <h3 class="text-lg font-bold mb-2">التقدم والتعديل</h3>
        <p class="text-slate-700">${escapeHTML(plan.progression||'')}</p>
      </section>`;

    const legal = `<section class="card p-5 mt-4">
        <div class="text-xs text-slate-600">${escapeHTML(plan.disclaimer||'')}</div>
        <div class="text-xs text-slate-700 mt-1"><b>${escapeHTML(plan.signature||'')}</b></div>
      </section>`;

    content.innerHTML = `
      <section class="p-5">
        ${kpi}
        ${diag}
        ${guide}
        ${allowAvoid}
        ${fasting}
        ${nutrition}
        <div class="page-break"></div>
        ${training}
        ${cardio}
        ${supp}
        ${motivation}
        ${progression}
        ${legal}
        <div class="no-print mt-4 flex gap-2">
          <button class="btn" onclick="downloadJSON(${JSON.stringify(JSON.stringify(plan))})">JSON</button>
          <button class="btn" onclick="window.print()">${state.lang==='ar'?'طباعة PDF':'Print PDF'}</button>
        </div>
      </section>`;

    // شارات النجاح
    badgeDays.textContent='7/7'; badgeDays.className='badge ok';
    badgeMacros.textContent='±2% 7/7'; badgeMacros.className='badge ok';
  }

  /* =========================
     UI HELPERS
  ========================== */
  function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function downloadJSON(s){ const blob=new Blob([JSON.parse(s)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='plan.json'; a.click(); }
  function notify(msg,level='ok'){ const c=document.createElement('div'); c.className=`fixed top-5 right-5 z-50 text-white px-3 py-2 rounded ${level==='ok'?'bg-emerald-600':level==='warn'?'bg-amber-600':'bg-rose-600'}`; c.textContent=msg; document.body.appendChild(c); setTimeout(()=>c.remove(),2600); }
  function showError(m){ content.innerHTML=`<section class="card p-6"><div class="p-4 bg-rose-50 border border-rose-200 rounded text-rose-800"><b>${state.lang==='ar'?'خطأ':'Error'}</b><div class="text-sm mt-1">${escapeHTML(m)}</div></div></section>`; }
  function showRawError(msg){
    showError(msg || (state.lang==='ar'?'فشل استخراج JSON':'JSON extraction failed'));
    const box=document.getElementById('rawErr'); if(box){ box.classList.remove('hidden'); box.textContent='Debug: Invalid JSON payload was returned. Please try again.'; }
  }
  function lock(on){ btnPrev.disabled=on; btnNext.disabled=on; btnNext.textContent = on ? (state.lang==='ar'?'جارٍ التنفيذ…':'Working…') : (state.step>=12?t('submit'):t('next')); }

  /* =========================
     INIT
  ========================== */
  setLang('ar'); state.step=0; render();
  </script>
</body>
</html>
