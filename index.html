<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>ุงููุณุชุดุงุฑ ุงูุตุญู ุงูุฐูู โ ุฎุทุฉ ูุฎุตุตุฉ ุจุงูุชุบุฐูุฉ ูุงูุชุฏุฑูุจ</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- html2pdf -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;--card:#ffffff;--ink:#0f172a;--sub:#475569;--line:#e5e7eb;
      --brand:#6b6cff;--accent:#22c55e;--chip:#eef2ff;--warn:#f97316;
    }
    html.dark{ --bg:#0b0f17;--card:#0f1624;--ink:#f1f5f9;--sub:#9aa4b2;--line:#1f2738;--brand:#7c81ff;--accent:#34d399;--chip:#121a2b }
    *{ font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,sans-serif }
    body{ background:var(--bg); color:var(--ink) }
    .card{ background:var(--card); border:1px solid var(--line) }
    .btn{ padding:.6rem 1rem;border-radius:.75rem;font-weight:800 }
    .btn-primary{ background:var(--brand); color:#fff }
    .btn-ghost{ background:transparent; border:1px solid var(--line); color:var(--ink) }
    .btn-success{ background:var(--accent); color:#0b0f17 }
    .tag{ background:var(--chip); border:1px solid var(--line); color:var(--sub); font-size:.75rem; padding:.2rem .5rem; border-radius:.5rem }
    .h-xl{ font-size:1.35rem; font-weight:800 }
    .section-title{ font-weight:800; font-size:1.15rem; margin:.5rem 0 1rem; padding-inline-start:.7rem; border-inline-start:6px solid var(--brand) }
    .day-title{ color:var(--brand); font-weight:800; margin:.75rem 0 .35rem }
    .progress{ height:8px; background:linear-gradient(90deg,var(--brand),var(--accent)); transition:width .25s }
    .toast{ position:fixed; inset-inline:0; top:10px; margin:auto; width:min(720px,90%); background:#fff; border:1px solid var(--line); color:var(--ink); border-radius:.75rem; padding:.6rem .9rem; z-index:60 }
    .toast.warn{ border-color:#fed7aa; background:#fffbeb; color:#713f12 }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:50 }
    .modal .box{ background:var(--card); color:var(--ink); width:min(680px,95%); border:1px solid var(--line); border-radius:1rem; padding:1rem 1.25rem }
    @media print{ #topbar,#setup,#topActions,.modal,#langSwitch{display:none!important} body{background:#fff} }
  </style>
</head>
<body>

<!-- Topbar -->
<header id="topbar" class="sticky top-0 z-40 backdrop-blur bg-[color:var(--card)]/90 border-b">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <div class="size-9 rounded-xl grid place-items-center text-white font-extrabold" style="background:var(--brand)">AI</div>
      <div>
        <div class="font-extrabold">ุงููุณุชุดุงุฑ ุงูุตุญู ุงูุฐูู</div>
        <div class="text-[11px] text-[color:var(--sub)]">ุฎุทุฉ ุฏูููุฉ 100% ููุชุบุฐูุฉ ูุงูุชุฏุฑูุจ ูุงูููููุงุช โ ูุฎุตุตุฉ ูู</div>
      </div>
    </div>
    <div id="langSwitch" class="flex items-center gap-2">
      <button id="lang-ar" class="btn btn-ghost text-sm">ุนุฑุจู</button>
      <button id="lang-en" class="btn btn-ghost text-sm">EN</button>
      <div class="w-px h-6 bg-[color:var(--line)]"></div>
      <button id="btn-theme" class="btn btn-ghost text-sm">๐</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">

  <!-- Lead card -->
  <section class="card rounded-2xl p-5 md:p-7 mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <div class="h-xl mb-1" id="leadTitle">ููููุดุฆ ุฃูุถู ุฎุทุฉ ููููุฉ ููุฏูู</div>
        <p class="text-sm text-[color:var(--sub)]" id="leadDesc">
          ุณููููุฏ ุงูุฎุทุฉ **ูุณููุง ุจุนุฏ ูุณู** ูุถูุงู ุงูุฏููุฉ: ุชุฑุญูุจ โ ุชุญููู โ ุงููุณููุญ/ุงูููููุน โ ุงูุตูุงู โ ุงูุชุบุฐูุฉ **ููููุง ุจููู** โ ุงูุชุฏุฑูุจ **ููููุง ุจููู** โ ููููุงุช โ ูุชุงุจุนุฉ โ ุญููู โ ุณูุงูุฉ โ ุฎุชุงู.
        </p>
      </div>
      <div id="topActions" class="flex flex-wrap items-center gap-2">
        <button id="startTop" class="btn btn-primary">ุงุจุฏุฃ ุงูุชูููุฏ</button>
        <button id="regen" class="btn btn-ghost hidden">ุฅุนุงุฏุฉ ุชูููุฏ ูุงูู</button>
      </div>
    </div>
    <div class="mt-4">
      <div class="w-full h-2 rounded-full overflow-hidden bg-[color:var(--line)]"><div id="bar" class="progress w-0"></div></div>
      <div id="barTxt" class="text-[12px] text-[color:var(--sub)] mt-1">ุฌุงูุฒ</div>
    </div>
  </section>

  <!-- Form (3 columns) -->
  <section id="setup" class="grid grid-cols-1 lg:grid-cols-3 gap-5">

    <!-- Column 1: Lifestyle & training -->
    <div class="card rounded-2xl p-5">
      <div class="section-title">ููุท ุงูุญูุงุฉ ูุงูุชุฏุฑูุจ</div>
      <div class="grid grid-cols-2 gap-3">
        <label><div class="text-sm mb-1">ุงูุนูู/ุงููุดุงุท</div>
          <select id="job" class="w-full rounded-lg border px-3 py-2 bg-transparent">
            <option value="Sedentary">ููุชุจู</option><option value="Light">ูุดุงุท ุฎููู</option><option value="Moderate">ูุดุงุท ูุชูุณุท</option>
          </select></label>
        <label><div class="text-sm mb-1">ุฎุทูุงุช/ุงูููู</div><input id="steps" type="number" min="0" step="500" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="6000"/></label>
        <label><div class="text-sm mb-1">ุงูููู (ุณ)</div><input id="sleep" type="number" min="3" max="12" class="w-full rounded-lg border px-3 py-2 bg-transparent"/></label>
        <label><div class="text-sm mb-1">ุงูุชูุชุฑ</div><select id="stress" class="w-full rounded-lg border px-3 py-2 bg-transparent"><option>ููุฎูุถ</option><option>ูุชูุณุท</option><option>ูุฑุชูุน</option></select></label>
        <label><div class="text-sm mb-1">ููุงู ุงูุชุฏุฑูุจ</div><select id="place" class="w-full rounded-lg border px-3 py-2 bg-transparent"><option>ูุงุฏู</option><option>ููุฒู</option></select></label>
        <label><div class="text-sm mb-1">ูุฏุฉ ุงูุฌูุณุฉ (ุฏ)</div><input id="session" type="number" min="20" max="120" class="w-full rounded-lg border px-3 py-2 bg-transparent"/></label>
        <label class="col-span-2"><div class="text-sm mb-1">ุฃูุงู ุงูุชุฏุฑูุจ ุงููุชุงุญุฉ</div>
          <div class="grid grid-cols-4 gap-2">
            <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Sat" class="accent-[var(--brand)]"><span>ุงูุณุจุช</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Sun" class="accent-[var(--brand)]"><span>ุงูุฃุญุฏ</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Mon" class="accent-[var(--brand)]"><span>ุงูุงุซููู</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Tue" class="accent-[var(--brand)]"><span>ุงูุซูุงุซุงุก</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Wed" class="accent-[var(--brand)]"><span>ุงูุฃุฑุจุนุงุก</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Thu" class="accent-[var(--brand)]"><span>ุงูุฎููุณ</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Fri" class="accent-[var(--brand)]"><span>ุงูุฌูุนุฉ</span></label>
          </div>
        </label>
        <label class="col-span-2"><div class="text-sm mb-1">ุงููุนุฏุงุช ุงููุชุงุญุฉ</div><input id="equipment" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="ุฏูุจูุ ุจุงุฑโฆ"/></label>
        <label><div class="text-sm mb-1">ุงูุฎุจุฑุฉ</div><select id="exp" class="w-full rounded-lg border px-3 py-2 bg-transparent"><option>ูุจุชุฏุฆ (0-6 ุฃุดูุฑ)</option><option>ูุชูุณุท (6-24 ุดูุฑ)</option><option>ูุชูุฏู (+24 ุดูุฑ)</option></select></label>
        <label><div class="text-sm mb-1">RPE</div><select id="rpe" class="w-full rounded-lg border px-3 py-2 bg-transparent"><option>6</option><option>7</option><option selected>8</option><option>9</option></select></label>
        <label><div class="text-sm mb-1">ูุงูููู/ููู (ุฃููุงุจ)</div><input id="caffeine" type="number" min="0" max="10" class="w-full rounded-lg border px-3 py-2 bg-transparent"/></label>
        <label class="col-span-2"><div class="text-sm mb-1">ุฅุตุงุจุงุช/ูููุฏ</div><input id="injuries" class="w-full rounded-lg border px-3 py-2 bg-transparent"/></label>
        <label class="col-span-2"><div class="text-sm mb-1">ุฃุฏููุฉ/ููููุงุช ุญุงููุฉ</div><input id="meds" class="w-full rounded-lg border px-3 py-2 bg-transparent"/></label>
      </div>
    </div>

    <!-- Column 2: Diet -->
    <div class="card rounded-2xl p-5">
      <div class="section-title">ุงููุธุงู ุงูุบุฐุงุฆู ูุงูุชูุถููุงุช</div>
      <div class="grid grid-cols-2 gap-3">
        <label class="col-span-2"><div class="text-sm mb-1">ุงูุฃูุฏุงู (ูุชุนุฏุฏ)</div>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="ุฎุณุงุฑุฉ ุงูุฏููู" class="accent-[var(--brand)]"><span>ุฎุณุงุฑุฉ ุงูุฏููู</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="ุจูุงุก ุงูุนุถูุงุช" class="accent-[var(--brand)]"><span>ุจูุงุก ุงูุนุถูุงุช</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="ุฒูุงุฏุฉ ุงูููุฉ" class="accent-[var(--brand)]"><span>ุฒูุงุฏุฉ ุงูููุฉ</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="ุชุญุณูู ุงูุชุญูู" class="accent-[var(--brand)]"><span>ุชุญุณูู ุงูุชุญูู</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="ุตุญุฉ ุนุงูุฉ" class="accent-[var(--brand)]"><span>ุตุญุฉ ุนุงูุฉ</span></label>
          </div>
        </label>
        <label><div class="text-sm mb-1">ุนุฏุฏ ุงููุฌุจุงุช</div><select id="meals" class="w-full rounded-lg border px-3 py-2 bg-transparent"><option>3</option><option>4</option><option>5</option></select></label>
        <label><div class="text-sm mb-1">ุงููุธุงู ุงูููุถู</div><select id="diet" class="w-full rounded-lg border px-3 py-2 bg-transparent"><option>ูุธุงู ูุชูุงุฒู</option><option>ูููู ุงููุฑุจูููุฏุฑุงุช</option><option>ุตูุงู ูุชูุทุน</option><option>ููุชู</option><option>ูุธุงู ุงูุจุญุฑ ุงููุชูุณุท</option><option>ูุจุงุชู</option></select></label>
        <label><div class="text-sm mb-1">ุงูุตูุงู ุงููุชูุทุน</div><select id="fasting" class="w-full rounded-lg border px-3 py-2 bg-transparent"><option value="off">ุบูุฑ ููุนู</option><option>16:8</option><option>18:6</option><option>20:4</option></select></label>
        <label><div class="text-sm mb-1">ูุทุจุฎ ููุถู</div><select id="cuisine" class="w-full rounded-lg border px-3 py-2 bg-transparent"><option>ุนุฑุจู/ูุชูุณุทู</option><option>ุบุฑุจู</option><option>ุขุณููู</option><option>ูุชููุน</option></select></label>
        <label><div class="text-sm mb-1">ุฒูู ุงูุชุญุถูุฑ (ุฏ)</div><input id="cookTime" type="number" min="5" max="90" class="w-full rounded-lg border px-3 py-2 bg-transparent"/></label>
        <label><div class="text-sm mb-1">ููุฒุงููุฉ ููููุฉ ุชูุฑูุจูุฉ</div><input id="budget" type="number" min="0" step="1" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="ุนููุฉ ูุญููุฉ"/></label>
        <label class="col-span-2"><div class="text-sm mb-1">ุฃุทุนูุฉ ูุง ุชุฑุบุจ ุจูุง/ุญุณุงุณูุฉ</div><input id="dislikes" class="w-full rounded-lg border px-3 py-2 bg-transparent"/></label>
      </div>
    </div>

    <!-- Column 3: Profile -->
    <div class="card rounded-2xl p-5">
      <div class="section-title">ุงูููู ุงูุดุฎุตู</div>
      <div class="grid grid-cols-2 gap-3">
        <label class="col-span-2"><div class="text-sm mb-1">ุงูุงุณู</div><input id="name" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="ุงูุงุณู"/></label>
        <label><div class="text-sm mb-1">ุงูุนูุฑ</div><input id="age" type="number" min="12" max="100" class="w-full rounded-lg border px-3 py-2 bg-transparent"/></label>
        <label><div class="text-sm mb-1">ุงูุทูู (ุณู)</div><input id="height" type="number" min="120" max="230" class="w-full rounded-lg border px-3 py-2 bg-transparent"/></label>
        <label><div class="text-sm mb-1">ุงููุฒู (ูุบ)</div><input id="weight" type="number" min="30" max="250" class="w-full rounded-lg border px-3 py-2 bg-transparent"/></label>
        <label><div class="text-sm mb-1">ูุณุจุฉ ุงูุฏููู %</div><input id="bodyfat" type="number" step="0.1" min="3" max="60" class="w-full rounded-lg border px-3 py-2 bg-transparent"/></label>
        <label><div class="text-sm mb-1">ูุญูุท ุงูุฎุตุฑ (ุณู)</div><input id="waist" type="number" min="40" max="160" class="w-full rounded-lg border px-3 py-2 bg-transparent"/></label>
        <label><div class="text-sm mb-1">ุงูุฌูุณ</div><select id="gender" class="w-full rounded-lg border px-3 py-2 bg-transparent"><option value="Male">ุฐูุฑ</option><option value="Female">ุฃูุซู</option></select></label>
        <label class="col-span-2"><div class="text-sm mb-1">ูุฏู ุฑููู/ููุนุฏ (ุงุฎุชูุงุฑู)</div><input id="targetNote" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="ูุซุงู: -8ูุบ ุฎูุงู 12 ุฃุณุจูุนุงูโฆ"/></label>
      </div>
    </div>
  </section>

  <!-- Bottom sticky actions -->
  <section class="mt-5">
    <div class="flex items-center justify-center gap-2">
      <button id="startBottom" class="btn btn-success">ุงุจุฏุฃ ุงูุชูููุฏ</button>
      <button id="printTop" class="btn btn-ghost">ุทุจุงุนุฉ</button>
      <button id="pdfTop" class="btn btn-ghost">PDF</button>
    </div>
  </section>

  <!-- Results -->
  <section id="result" class="hidden mt-6">
    <div id="resultRoot" class="card rounded-2xl p-5 md:p-8">
      <div class="flex items-center justify-between gap-3 mb-3">
        <div class="h-xl" id="resTitle">ุงูุฎุทุฉ ุงูููุงุฆูุฉ โ ูุฎุตุตุฉ 100%</div>
        <div class="flex items-center gap-2"><span class="tag">ุชูููุฏ ูููุธูู</span><span class="tag">ููููุง ุจููู</span></div>
      </div>
      <article id="ai" class="prose max-w-none prose-p:leading-7 prose-ul:leading-7 prose-ol:leading-7"></article>

      <!-- bottom export -->
      <div class="mt-6 flex flex-wrap items-center justify-center gap-2">
        <button id="print2" class="btn btn-ghost">ุทุจุงุนุฉ</button>
        <button id="pdf2" class="btn btn-ghost">PDF</button>
      </div>
    </div>
  </section>

  <footer class="text-center text-[11px] text-[color:var(--sub)] mt-6">Powered by Mustafa Elsafy 2025 โ ุฌููุน ุงูุญููู ูุญููุธุฉ</footer>
</main>

<!-- Modal (pre-generation explainer) -->
<div id="modal" class="modal">
  <div class="box">
    <div class="h-xl mb-1" id="mTitle">ุณูููู ุจุชูููุฏ ุงูุฎุทุฉ ูุงููุฉ</div>
    <p class="text-sm text-[color:var(--sub)]" id="mDesc">
      ุณููููุฏ ุงูุฃูุณุงู ุจุชุณูุณู ุชููุงุฆู ููููู ุจุงูุชุฃูุฏ ูู ุตุญุฉ ุงูุฌุฏุงูู. ุงูุนูููุฉ ูุฏ ุชุณุชุบุฑู ุจุถุน ุฏูุงุฆู ุญุณุจ ุณุฑุนุฉ ุงูุดุจูุฉ. ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑ ุญุชู ุงูุชูุงู ุงูุชูุฏู 100% ูุจู ุงูุทุจุงุนุฉ ุฃู ุชูุฒูู PDF.
    </p>
    <div class="mt-3 flex gap-2 justify-end">
      <button id="mCancel" class="btn btn-ghost">ุฅูุบุงุก</button>
      <button id="mGo" class="btn btn-primary">ุงุจุฏุฃ ุงูุขู</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden"></div>

<script>
/* ======== UTIL ======== */
const $ = id=>document.getElementById(id);
const PROXY = '/.netlify/functions/gemini-proxy';
const st = { lang:'ar' };

function showToast(msg, warn=false){
  const t=$('toast'); t.textContent=msg; t.classList.remove('hidden'); t.classList.toggle('warn',warn);
  setTimeout(()=>t.classList.add('hidden'), 3200);
}
function setTheme(){ document.documentElement.classList.toggle('dark'); }
function setProgress(i,total,label){ $('bar').style.width=Math.round(i/total*100)+'%'; $('barTxt').textContent=`${Math.round(i/total*100)}% โ ${label}`; }
function checks(name){ return [...document.querySelectorAll(`input[name="${name}"]:checked`)].map(e=>e.value) }

/* ======== LANGUAGE ======== */
function setLang(l){
  st.lang=l;
  document.documentElement.lang=(l==='ar'?'ar':'en');
  document.documentElement.dir =(l==='ar'?'rtl':'ltr');
  $('lang-ar').classList.toggle('btn-primary', l==='ar');
  $('lang-en').classList.toggle('btn-primary', l==='en');
  // UI text
  if(l==='ar'){
    $('leadTitle').textContent='ููููุดุฆ ุฃูุถู ุฎุทุฉ ููููุฉ ููุฏูู';
    $('leadDesc').textContent='ุณููููุฏ ุงูุฎุทุฉ ูุณููุง ุจุนุฏ ูุณู ูุถูุงู ุงูุฏููุฉ: ุชุฑุญูุจ โ ุชุญููู โ ุงููุณููุญ/ุงูููููุน โ ุงูุตูุงู โ ุงูุชุบุฐูุฉ ููููุง ุจููู โ ุงูุชุฏุฑูุจ ููููุง ุจููู โ ููููุงุช โ ูุชุงุจุนุฉ โ ุญููู โ ุณูุงูุฉ โ ุฎุชุงู.';
    $('startTop').textContent='ุงุจุฏุฃ ุงูุชูููุฏ'; $('startBottom').textContent='ุงุจุฏุฃ ุงูุชูููุฏ';
    $('mTitle').textContent='ุณูููู ุจุชูููุฏ ุงูุฎุทุฉ ูุงููุฉ';
    $('mDesc').textContent='ุณููููุฏ ุงูุฃูุณุงู ุจุชุณูุณู ุชููุงุฆู ููููู ุจุงูุชุฃูุฏ ูู ุตุญุฉ ุงูุฌุฏุงูู. ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑ ุญุชู ุงูุชูุงู ุงูุชูุฏู 100%.';
    $('resTitle').textContent='ุงูุฎุทุฉ ุงูููุงุฆูุฉ โ ูุฎุตุตุฉ 100%';
  }else{
    $('leadTitle').textContent='Letโs build the best plan for your goal';
    $('leadDesc').textContent='We will generate the plan section-by-section: Welcome โ Analysis โ Allowed/Limits โ Intermittent Fasting โ Nutrition day-by-day โ Training day-by-day โ Supplements โ Progression โ Troubleshooting โ Safety โ Closing.';
    $('startTop').textContent='Generate Plan'; $('startBottom').textContent='Generate Plan';
    $('mTitle').textContent='We will generate your full plan';
    $('mDesc').textContent='Sections will be generated in order with validation. Please wait until progress hits 100% before printing or downloading.';
    $('resTitle').textContent='Final Plan โ 100% Personalized';
  }
  $('barTxt').textContent=(l==='ar'?'ุฌุงูุฒ':'Ready');
}
// auto-detect from browser + inputs (Arabic letters)
(function autoLang(){
  const nav = (navigator.language||'ar').toLowerCase();
  setLang(nav.startsWith('ar')?'ar':'en');
  // detect from first text input
  ['name','dislikes','injuries','meds'].forEach(id=>{
    const el=$(id);
    el.addEventListener('input', ()=>{
      const v=el.value;
      if(/[ุก-ู]/.test(v)) setLang('ar');
      else if(/[A-Za-z]/.test(v) && st.lang==='ar') setLang('en');
    });
  });
})();

/* ======== COLLECT & TARGETS ======== */
function collect(){
  return {
    name: $('name').value.trim(), age:+$('age').value||0, height:+$('height').value||0, weight:+$('weight').value||0,
    bodyfat:+$('bodyfat').value||0, waist:+$('waist').value||0, gender:$('gender').value, targetNote:$('targetNote').value.trim(),
    goals: checks('goals'), meals:+$('meals').value, diet:$('diet').value, fasting:$('fasting').value, cuisine:$('cuisine').value,
    cookTime:+$('cookTime').value||0, budget:+$('budget').value||0, dislikes:$('dislikes').value.trim(),
    job:$('job').value, steps:+$('steps').value||0, sleep:+$('sleep').value||0, stress:$('stress').value,
    place:$('place').value, session:+$('session').value||0, days:checks('days'), equipment:$('equipment').value.trim(),
    exp:$('exp').value, rpe:+$('rpe').value||8, caffeine:+$('caffeine').value||0, injuries:$('injuries').value.trim(), meds:$('meds').value.trim()
  };
}
function targets(){
  const u=collect();
  const male=u.gender==='Male';
  const BMR = male? (10*u.weight + 6.25*u.height - 5*u.age + 5)
                   : (10*u.weight + 6.25*u.height - 5*u.age - 161);
  const factor = (u.job==='Sedentary'?1.2: u.job==='Moderate'?1.5:1.35);
  let TDEE=Math.round(BMR*factor);
  if(u.goals.includes('ุฎุณุงุฑุฉ ุงูุฏููู')||u.goals.includes('Fat Loss')) TDEE=Math.round(TDEE*0.88);
  if(u.goals.includes('ุจูุงุก ุงูุนุถูุงุช')||u.goals.includes('Build Muscle')) TDEE=Math.round(TDEE*1.10);
  const P=Math.round(2.0*(u.weight||1));
  const F=Math.round(0.8*(u.weight||1));
  let C=Math.max(0,Math.round((TDEE-(P*4+F*9))/4));
  if((u.meds||'').toLowerCase().includes('metformin')) C=Math.min(C,140);
  return {TDEE,P,F,C};
}

/* ======== AI CALL ======== */
async function callAI(prompt){
  const r = await fetch(PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
  if(!r.ok){ const tx=await r.text().catch(()=> ''); throw new Error('Proxy '+r.status+': '+tx.slice(0,200)); }
  const j = await r.json(); if(!j?.text) throw new Error('Empty response'); return j.text;
}

/* ======== PROMPTS (no greeting except Welcome) ======== */
function baseHeader(){
  const u=collect(), t=targets(), locale=(st.lang==='ar'?'Arabic':'English');
  return `
LANGUAGE: ${locale} ONLY. Do not mix languages.
Do not repeat the profile fields inside sections (except Welcome).
Use clear Markdown headings and tables. No placeholders.

PROFILE (internal only):
Name ${u.name}; Sex ${u.gender}; ${u.age}y; ${u.height}cm; ${u.weight}kg; BF ${u.bodyfat||'n/a'}%; Waist ${u.waist||'n/a'}cm
Goals: ${(u.goals||[]).join(', ')}; Target: ${u.targetNote||'โ'}
Diet ${u.diet}; Meals ${u.meals}; Fasting ${u.fasting}; Cuisine ${u.cuisine}; Cook <= ${u.cookTime||'n/a'} min; Budget ${u.budget||'n/a'}; Dislikes ${u.dislikes||'None'}
Activity ${u.job} ~${u.steps||'n/a'} steps; Sleep ${u.sleep}h; Stress ${u.stress}; Caffeine ${u.caffeine}
Training: ${u.place}, days ${(u.days||[]).join(', ')||'n/a'}, session ~${u.session||'n/a'} min, equipment "${u.equipment||'โ'}", exp ${u.exp}, RPE ${u.rpe}, injuries ${u.injuries||'None'}
Meds/supps: ${u.meds||'None'}

TARGETS (reference):
Calories โ ${t.TDEE} kcal; Protein โ ${t.P} g; Fat โ ${t.F} g; Carbs โ ${t.C} g`.trim();
}
function pWelcome(){ const u=collect(); return `${baseHeader()}

SECTION: WELCOME
Write a single welcome paragraph addressing **${u.name|| (st.lang==='ar'?'ุงูุนููู':'client')}**, congratulating them and outlining the generation steps briefly. 5โ7 lines.`; }
function pAnalysis(){ return `${baseHeader()}

SECTION: ANALYSIS & RATIONALE
Explain why the targets fit the goals and constraints, and how sleep/steps/stress influence progress. Practical notes on RPE and session duration. No greeting.`; }
function pAllowed(){ const u=collect(); return `${baseHeader()}

SECTION: ALLOWED & LIMIT LIST
Two bullet lists only:
- Preferred/allowed foods (respect ${u.diet}, ${u.cuisine}, prep <= ${u.cookTime||'n/a'}, budget โ ${u.budget||'n/a'})
- Limit/avoid (respect allergies/dislikes: ${u.dislikes||'None'})`; }
function pIF(){ const u=collect(); return `${baseHeader()}

SECTION: INTERMITTENT FASTING
If "${u.fasting}" describe window, hydration/electrolytes, first/last meals, caffeine timing, and sleep. If "off", state not applicable.`; }
function pNutritionDay(d){
  const day = st.lang==='ar'?`ุงูููู ${d}`:`Day ${d}`;
  const u=collect(), t=targets();
  return `${baseHeader()}

SECTION: NUTRITION โ ${day}
Provide a Markdown table with EXACTLY ${u.meals} meals:
| ${st.lang==='ar'?'ุงูููู':'Day'} | ${st.lang==='ar'?'ุงููุฌุจุฉ':'Meal'} | ${st.lang==='ar'?'ุงูููููุงุช (ุฌู/ูู)':'Ingredients (g/ml)'} | Protein (g) | Fat (g) | Carbs (g) | kcal |
Totals row โ ${t.P}P / ${t.F}F / ${t.C}C / ${t.TDEE} kcal (ยฑ2%).
Short compliance tip after the table. No greeting.`; }
function pTrainingDay(d){
  const day = st.lang==='ar'?`ุงูููู ${d}`:`Day ${d}`;
  const u=collect();
  return `${baseHeader()}

SECTION: TRAINING โ ${day}
Tailor to: ${u.exp}, ${u.place}, equipment "${u.equipment||'โ'}", session ~${u.session||'n/a'} min; days ${(u.days||[]).join(', ')||'n/a'}. Avoid injuries: ${u.injuries||'None'}.
Markdown table:
| ${st.lang==='ar'?'ุงูููู':'Day'} | Exercise (English) | Sets | Reps | Tempo | Rest (s) | Notes |
Include warm-up & cool-down notes after the table. No greeting.`; }
function pSupps(){ const u=collect(); return `${baseHeader()}

SECTION: SUPPLEMENTS
1) Core stack โ item, dose, timing, duration.
2) Condition-linked โ only if relevant to ${u.meds||'None'} / injuries ${u.injuries||'None'} else state not indicated.
One short safety note.`; }
const pProgress = ()=> `${baseHeader()}

SECTION: PROGRESSION & TRACKING
How to progress loads/reps weekly, when to deload, caloric adjustments by weekly average, and a weekly checklist.`;
const pTrouble = ()=> `${baseHeader()}

SECTION: TROUBLESHOOTING
Common issues (hunger/plateau/fatigue/sleep/time) with concrete fixes.`;
const pSafety  = ()=> `${baseHeader()}

SECTION: SAFETY & HEALTH
Hydration, sleep, technique, warm-up, stop signs (red flags).`;
const pClosing = ()=> `${baseHeader()}

SECTION: CLOSING
Positive motivating paragraph (no greeting).`;

/* ======== VALIDATION ======== */
const hasTable = md => md.split('\n').filter(l=>l.includes('|')).length>=5;
function vNutrition(md,d){ const tag = st.lang==='ar'?`ุงูููู\\s*${d}`:`\\bDay\\s*${d}\\b`; return new RegExp(tag).test(md) && hasTable(md); }
function vTraining(md,d){ const tag = st.lang==='ar'?`ุงูููู\\s*${d}`:`\\bDay\\s*${d}\\b`; return new RegExp(tag).test(md) && hasTable(md); }

/* ======== PIPELINE ======== */
async function pipeline(){
  const u=collect();
  if(!u.name||!u.age||!u.height||!u.weight||!u.sleep){
    showToast(st.lang==='ar'?'ุฃููู ุงูุญููู ุงูุฃุณุงุณูุฉ: ุงูุงุณู/ุงูุนูุฑ/ุงูุทูู/ุงููุฒู/ุงูููู.':'Fill required fields: name/age/height/weight/sleep.', true); return;
  }
  $('result').classList.remove('hidden'); $('ai').innerHTML='';
  const steps = 4 + 7 + 7 + 4; let i=0;

  async function step(label, fn){
    setProgress(++i,steps,label); addSpin(label); const md = await fn(); endSpin(md);
  }
  function addSpin(label){
    const d=document.createElement('div');
    d.id='spin'; d.className='tag block w-full text-center my-2 py-2';
    d.textContent=(st.lang==='ar'?'ูููู ุจุฅุนุฏุงุฏ ูุฐุง ุงููุณู ุจุนูุงูุฉุ ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑโฆ':'Preparing this section carefully, please waitโฆ')+' โ '+label;
    $('ai').appendChild(d);
  }
  function endSpin(md){ const s=$('spin'); if(s) s.remove(); const box=document.createElement('section'); box.innerHTML=marked.parse(md); $('ai').appendChild(box); }

  await step(st.lang==='ar'?'ุชุฑุญูุจ':'Welcome', ()=>callAI(pWelcome()));
  await step(st.lang==='ar'?'ุชุญููู':'Analysis', ()=>callAI(pAnalysis()));
  await step(st.lang==='ar'?'ูุณููุญ/ููููุน':'Allowed/Limits', ()=>callAI(pAllowed()));
  await step(st.lang==='ar'?'ุงูุตูุงู ุงููุชูุทุน':'Intermittent Fasting', ()=>callAI(pIF()));

  for(let d=1; d<=7; d++){
    const label= st.lang==='ar'?`ุงูุชุบุฐูุฉ โ ุงูููู ${d}`:`Nutrition โ Day ${d}`;
    setProgress(++i,steps,label); addSpin(label);
    let md = await callAI(pNutritionDay(d));
    if(!vNutrition(md,d)){
      md = await callAI(`${baseHeader()}

The previous nutrition for ${st.lang==='ar'?`ุงูููู ${d}`:`Day ${d}`} failed validation. Regenerate exactly per rules with proper table and totals.`);
    }
    endSpin(md);
  }

  for(let d=1; d<=7; d++){
    const label= st.lang==='ar'?`ุงูุชุฏุฑูุจ โ ุงูููู ${d}`:`Training โ Day ${d}`;
    setProgress(++i,steps,label); addSpin(label);
    let md = await callAI(pTrainingDay(d));
    if(!vTraining(md,d)){
      md = await callAI(`${baseHeader()}

The previous training for ${st.lang==='ar'?`ุงูููู ${d}`:`Day ${d}`} failed validation. Regenerate with correct table/fields.`);
    }
    endSpin(md);
  }

  await step(st.lang==='ar'?'ุงูููููุงุช':'Supplements', ()=>callAI(pSupps()));
  await step(st.lang==='ar'?'ุงูุชูุฏู ูุงููุชุงุจุนุฉ':'Progress & Tracking', ()=>callAI(pProgress()));
  await step(st.lang==='ar'?'ุญููู ุงููุดููุงุช':'Troubleshooting', ()=>callAI(pTrouble()));
  await step(st.lang==='ar'?'ุงูุณูุงูุฉ':'Safety', ()=>callAI(pSafety()));
  await step(st.lang==='ar'?'ุงูุฎุชุงู':'Closing', ()=>callAI(pClosing()));

  setProgress(steps,steps, st.lang==='ar'?'ุงูุชูู ุงูุชูููุฏ':'Generation complete');
  $('regen').classList.remove('hidden');
  $('resultRoot').scrollIntoView({behavior:'smooth'});
}

/* ======== EXPORT ======== */
function exportPDF(){
  const node=$('resultRoot'); if(!node){ window.print(); return; }
  const fn=(st.lang==='ar'?'ุฎุทุฉ-':'plan-')+(collect().name||'client')+'.pdf';
  const opt={ filename:fn, margin:[8,8,8,8], image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2,useCORS:true}, pagebreak:{mode:['css','legacy']}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
  try{ html2pdf().from(node).set(opt).save(); }catch(e){ window.print(); }
}

/* ======== EVENTS ======== */
$('btn-theme').onclick=setTheme;
$('lang-ar').onclick=()=>setLang('ar');
$('lang-en').onclick=()=>setLang('en');

function openModal(){ $('modal').style.display='flex'; }
function closeModal(){ $('modal').style.display='none'; }
$('mCancel').onclick=closeModal;
$('mGo').onclick=()=>{ closeModal(); pipeline(); };

$('startTop').onclick=openModal;
$('startBottom').onclick=openModal;
$('regen').onclick=openModal;

$('printTop').onclick=()=>window.print();
$('pdfTop').onclick=exportPDF;
$('print2').onclick=()=>window.print();
$('pdf2').onclick=exportPDF;
</script>
</body>
</html>
