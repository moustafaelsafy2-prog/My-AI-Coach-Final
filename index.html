<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ± â€” Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- DOMPurify -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0a0f15; --panel:#0e1621; --ink:#e7eaf0; --ink-soft:#a8b0bc; --line:#1b2736;
      --brand:#7c3aed; --brand2:#06b6d4; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    }
    html,body{height:100%}
    body{background:linear-gradient(180deg,var(--bg) 0%, #0c141d 100%);color:var(--ink);-webkit-font-smoothing:antialiased}
    .font-ar{font-family:"Tajawal",sans-serif}
    .font-en{font-family:"Poppins",sans-serif}
    .glass{background:rgba(14,22,33,.8);border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(10px)}
    .panel{background:var(--panel);border:1px solid var(--line)}
    .btn{border:1px solid #2a384a;border-radius:1rem;padding:.85rem 1rem;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand2));border-color:transparent;color:#fff}
    .btn-ghost{background:#0b121a}
    .chip{padding:.3rem .65rem;border-radius:.6rem;font-size:.75rem;background:#0b121a;border:1px dashed #334155;color:#93c5fd}
    .kpi{background:#0b121a;border:1px solid #223043;border-radius:.8rem;padding:.6rem}
    .muted{color:var(--ink-soft)}
    .pill{font-size:.7rem;padding:.2rem .5rem;border:1px solid #334155;border-radius:.5rem}
    .prose :where(table){width:100%;border-collapse:collapse}
    .prose :where(th,td){border:1px solid #263241;padding:.6rem;vertical-align:top}
    .prose :where(th){background:#0b121a;color:#cbd5e1}
    .rtl\:text-right[dir="rtl"]{text-align:right}
    .ltr\:text-left[dir="ltr"]{text-align:left}
    .ok{color:#34d399}.warn{color:#fbbf24}.err{color:#f87171}
    @media print{
      .no-print, header, #controls {display:none!important}
      body{background:#fff;color:#000}
      .panel,.glass{background:#fff;border:none}
      #result{box-shadow:none;border:none}
      table{page-break-inside:avoid}
    }
  </style>
</head>
<body class="font-ar">

  <!-- Header -->
  <header class="glass sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-600 to-cyan-500 text-white grid place-items-center font-extrabold">AI</div>
        <div class="leading-tight">
          <div class="text-xs muted">COACH</div>
          <div class="font-extrabold">Mustafa Al-Safi</div>
          <div class="text-[11px] muted">Certified International Coach</div>
        </div>
      </div>
      <div class="flex items-center gap-2 no-print">
        <button id="btn-lang-ar" class="btn btn-ghost">AR</button>
        <button id="btn-lang-en" class="btn btn-ghost">EN</button>
        <button id="btn-print" class="btn btn-primary">Ø·Ø¨Ø§Ø¹Ø© / Print</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 mt-6">
    <div class="glass rounded-2xl p-6 relative overflow-hidden">
      <div class="absolute -top-10 -left-10 w-56 h-56 rounded-full bg-gradient-to-br from-violet-600/25 to-cyan-500/25 blur-2xl"></div>
      <div class="absolute -bottom-10 -right-10 w-56 h-56 rounded-full bg-gradient-to-br from-cyan-500/18 to-violet-600/18 blur-2xl"></div>
      <div class="relative grid lg:grid-cols-[1.1fr,.9fr] gap-6 items-center">
        <div>
          <h1 id="hero-title" class="text-3xl sm:text-4xl font-extrabold">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±</h1>
          <p id="hero-sub" class="muted mt-1">
            Ø®Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ù„Ø§ Ø§Ø®ØªØµØ§Ø±: ØªØºØ°ÙŠØ© 7 Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø©ØŒ ØªØ¯Ø±ÙŠØ¨ 7 Ø£ÙŠØ§Ù… Ø¨Ù…Ø³ØªÙˆÙ‰ Ø´Ø¯Ø© Ù…Ù†Ø§Ø³Ø¨ØŒ Ù…ÙƒÙ…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ ÙˆØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹ Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ø¨ØªÙˆÙ‚ÙŠØ¹
            <b>Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ</b> Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯.
          </p>
          <p class="text-xs muted mt-2"><b>Powered by Mustafa Elsafy 2025</b></p>
          <div class="flex items-center gap-2 mt-4 flex-wrap">
            <span class="chip">Ø¬Ø¯Ø§ÙˆÙ„ Ø¯Ù‚ÙŠÙ‚Ø©</span>
            <span class="chip">Ø¨Ø¯ÙˆÙ† Ø§Ø®ØªØµØ§Ø±</span>
            <span class="chip">RTL/LTR</span>
            <span class="chip">ØªØ¯Ù‚ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
            <span class="chip">Ø¥ØµÙ„Ø§Ø­ Ø°ÙƒÙŠ</span>
          </div>
        </div>
        <div class="panel rounded-2xl p-4">
          <div class="text-xs muted mb-2" id="kpi-title">Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
          <div class="grid grid-cols-3 gap-3 text-center">
            <div class="kpi"><div class="text-[11px] muted">TDEE</div><div id="kpi-tdee" class="font-extrabold">â€”</div></div>
            <div class="kpi"><div class="text-[11px] muted">Protein</div><div id="kpi-P" class="font-extrabold">â€”</div></div>
            <div class="kpi"><div class="text-[11px] muted">Carbs</div><div id="kpi-C" class="font-extrabold">â€”</div></div>
          </div>
          <div class="mt-3">
            <div class="h-2 bg-[#0b121a] rounded-full overflow-hidden">
              <div id="bar" class="h-full bg-gradient-to-r from-violet-600 to-cyan-500 w-0 transition-all duration-300"></div>
            </div>
            <div class="text-[11px] muted mt-1">Step <span id="step">1</span> / 5</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 mt-6 grid xl:grid-cols-[minmax(0,1fr),420px] gap-6">
    <!-- Builder -->
    <section id="builder" class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="text-sm pill muted">Tab-friendly â€¢ ARIA â€¢ Input guards</div>
        <div class="text-xs pill">Â© Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€¢ Powered by Mustafa Elsafy 2025</div>
      </div>
      <div id="stage"></div>
      <div id="controls" class="mt-6 flex gap-2">
        <button id="btn-prev" class="btn btn-ghost flex-1">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button id="btn-next" class="btn btn-primary flex-1">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </section>

    <!-- Live summary -->
    <aside class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <div id="live-title" class="text-sm font-bold">Ù…Ù„Ø®Øµ ÙÙˆØ±ÙŠ</div>
        <span id="lang-badge" class="chip">AR</span>
      </div>
      <div id="live" class="mt-3 space-y-2 text-sm"></div>
      <div class="mt-3 text-[11px] muted">* ÙŠÙ„ØªØ²Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù€ 7 Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø© ÙˆÙ…Ø®ØªÙ„ÙØ© + Ø¬Ø¯Ø§ÙˆÙ„ ØµØ§Ø±Ù…Ø© + ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø§ÙƒØ±ÙˆØ² ÙŠÙˆÙ…ÙŠÙ‹Ø§ (Â±1%).</div>
    </aside>
  </main>

  <!-- Result -->
  <section id="result" class="max-w-7xl mx-auto px-4 sm:px-6 mt-6 mb-16 hidden">
    <article class="glass rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <h2 id="plan-title" class="text-2xl font-extrabold">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
        <div class="no-print flex gap-2">
          <button id="btn-again" class="btn btn-ghost">Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</button>
          <button id="btn-print-2" class="btn btn-primary">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸</button>
        </div>
      </div>
      <div class="text-[13px] muted">
        ØªØ´Ø®ÙŠØµ Ù…ÙØµÙ„ØŒ Ù…Ø³Ù…ÙˆØ­/Ù…Ù…Ù†ÙˆØ¹ØŒ ØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹ØŒ ØªØºØ°ÙŠØ© 7 Ø£ÙŠØ§Ù… Ø¨Ø¬Ø¯Ø§ÙˆÙ„ ÙƒØ§Ù…Ù„Ø©ØŒ ØªØ¯Ø±ÙŠØ¨ 7 Ø£ÙŠØ§Ù… (Tempo/RIR/Rest)ØŒ Ù…ÙƒÙ…Ù„Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØµØ­ÙŠØ©ØŒ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ù†Ø¬Ø§Ø­ØŒ Ø±Ø³Ø§Ø¦Ù„ ØªØ­ÙÙŠØ²ÙŠØ©ØŒ ÙˆÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©.
      </div>
      <div id="audit-banner" class="hidden mt-3"></div>
      <div id="ai-html" class="prose prose-invert rtl:text-right ltr:text-left mt-4"></div>
      <div class="no-print mt-4 flex flex-wrap gap-2">
        <button id="btn-export-json" class="btn btn-ghost">Export JSON</button>
        <button id="btn-export-csv" class="btn btn-ghost">Export CSV</button>
      </div>
      <div class="border-t border-slate-700 mt-6 pt-2 text-[11px] muted">
        <b>Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯</b> â€¢ <b>Powered by Mustafa Elsafy 2025</b>
      </div>
    </article>
  </section>

  <script>
    /* ======================== I18N ======================== */
    const L = {
      ar:{ ui:{
        title:'Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±',
        sub:'Ø®Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ù„Ø§ Ø§Ø®ØªØµØ§Ø±: ØªØºØ°ÙŠØ© 7 Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø©ØŒ ØªØ¯Ø±ÙŠØ¨ 7 Ø£ÙŠØ§Ù… Ø¨Ù…Ø³ØªÙˆÙ‰ Ø´Ø¯Ø© Ù…Ù†Ø§Ø³Ø¨ØŒ Ù…ÙƒÙ…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ ÙˆØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹ Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ø¨ØªÙˆÙ‚ÙŠØ¹ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ.',
        kpi:'Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©', live:'Ù…Ù„Ø®Øµ ÙÙˆØ±ÙŠ',
        steps:['Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª','Ø§Ù„Ø£Ù‡Ø¯Ø§Ù & Ø§Ù„Ù†Ø¸Ø§Ù…','Ø§Ù„ØµØ­Ø© & Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©','Ø§Ù„ØªØ§Ø±ÙŠØ® & Ø§Ù„ØªØ±ÙƒÙŠØ²','Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©'],
        next:'Ø§Ù„ØªØ§Ù„ÙŠ', prev:'Ø§Ù„Ø³Ø§Ø¨Ù‚', submit:'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¢Ù†',
        name:'Ø§Ù„Ø§Ø³Ù…', age:'Ø§Ù„Ø¹Ù…Ø±', height:'Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)', weight:'Ø§Ù„ÙˆØ²Ù† (ÙƒØº)', gender:'Ø§Ù„Ø¬Ù†Ø³', male:'Ø°ÙƒØ±', female:'Ø£Ù†Ø«Ù‰',
        job:'Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¹Ù…Ù„', jobVals:['Ù…ÙƒØªØ¨ÙŠ','Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ','Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·'],
        goals:['Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†','Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª','Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©','ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„','ØµØ­Ø© Ø¹Ø§Ù…Ø©'],
        meals:'Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª', diet:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ', diets:['Ù…ØªÙˆØ§Ø²Ù†','Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª','ÙƒÙŠØªÙˆ','Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·','Ù†Ø¨Ø§ØªÙŠ'],
        fasting:'Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹', enable:'ØªÙØ¹ÙŠÙ„', protocol:'Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„', from:'Ù…Ù†', to:'Ø¥Ù„Ù‰',
        health:'Ø­Ø§Ù„Ø§Øª ØµØ­ÙŠØ©', healthVals:['Ø¶ØºØ· Ø§Ù„Ø¯Ù…','Ø§Ù„Ø³ÙƒØ±ÙŠ','Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†','Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©','Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ','Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©','Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù‡Ø¶Ù…ÙŠ'],
        allergies:'Ø­Ø³Ø§Ø³ÙŠØ§Øª', allergyVals:['Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†','Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²','Ø§Ù„Ù…ÙƒØ³Ø±Ø§Øª','Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ©','Ø§Ù„Ø¨Ù‚ÙˆÙ„ÙŠØ§Øª','Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø©','Ø§Ù„Ø²ÙŠÙˆØª Ø§Ù„Ù†Ø¨Ø§ØªÙŠØ©'],
        injuries:'Ø¥ØµØ§Ø¨Ø§Øª (Ø¥Ù† ÙˆØ¬Ø¯Øª)', exp:'Ø®Ø¨Ø±Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©', expVals:['Ù…Ø¨ØªØ¯Ø¦','Ù…ØªÙˆØ³Ø·','Ù…ØªÙ‚Ø¯Ù…'],
        weak:'Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ±ÙƒÙŠØ² (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', desc:'Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ø¶Ù„Ø©: Ø§Ù„Ù‡Ø¯Ù (Ù…Ø«Ø§Ù„: ØµØ¯Ø±: Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø£Ø¹Ù„Ù‰Ø› Ø¸Ù‡Ø±: ÙƒØ«Ø§ÙØ©)',
        detail:'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙØµÙŠÙ„', days:'Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨/Ø£Ø³Ø¨ÙˆØ¹', addons:'ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©',
        add:{ grocery:'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', micro:'Ø§Ù„Ù…ØºØ°ÙŠØ§Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©', hydration:'Ø§Ù„Ø³ÙˆØ§Ø¦Ù„', periodization:'ØªØµØ¹ÙŠØ¯ 4 Ø£Ø³Ø§Ø¨ÙŠØ¹', budget:'Ø¨Ø¯Ø§Ø¦Ù„ Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©', prep:'Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ­Ø¶ÙŠØ±', cooking:'Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø·Ø¨Ø®' },
        building:'Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ù„Ø§ Ø§Ø®ØªØµØ§Ø±â€¦', apiFail:'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
        err:'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', print:'Ø·Ø¨Ø§Ø¹Ø© / Print',
        auditOK:'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚: ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø£Ù‡Ø¯Ø§Ù (Â±1%) ÙˆØ¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª ØµØ­ÙŠØ­.',
        auditWarn:'ØªÙ†Ø¨ÙŠÙ‡: ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø£ÙŠØ§Ù… Ù„Ø§ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø´Ø§Ø±Ø§Øª.',
        auditErr:'ØªØ­Ø°ÙŠØ±: Ø£ÙŠØ§Ù… Ù„Ø§ ØªØ²Ø§Ù„ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚. Ø¹Ø¯Ù‘Ù„ Ø£Ùˆ Ø£Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯.',
        badgeOK:'âœ… Ù…Ø·Ø§Ø¨Ù‚', badgeFix:'ğŸ› ï¸ ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­', badgeFail:'âš ï¸ ÙŠÙ„Ø²Ù… Ù…Ø±Ø§Ø¬Ø¹Ø©'
      },
      map:{
        job:{'Desk':'Ù…ÙƒØªØ¨ÙŠ','Light':'Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ','Moderate':'Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·'},
        diet:{'Balanced':'Ù…ØªÙˆØ§Ø²Ù†','Low-Carb':'Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª','Keto':'ÙƒÙŠØªÙˆ','Mediterranean':'Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·','Plant-based':'Ù†Ø¨Ø§ØªÙŠ'},
        goals:{'Fat loss':'Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†','Muscle gain':'Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª','Strength':'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©','Endurance':'ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„','General health':'ØµØ­Ø© Ø¹Ø§Ù…Ø©'},
        exp:{'Beginner':'Ù…Ø¨ØªØ¯Ø¦','Intermediate':'Ù…ØªÙˆØ³Ø·','Advanced':'Ù…ØªÙ‚Ø¯Ù…'}
      }},
      en:{ ui:{
        title:'Expert Personal Coach',
        sub:'A no-shortcut plan: full 7-day nutrition, 7-day training with proper intensity, condition-aware supplements, optional IF â€” signed by Mustafa Al-Safi.',
        kpi:'Quick KPIs', live:'Live Summary',
        steps:['Basics','Goals & Diet','Health & Allergies','History & Focus','Create Plan'],
        next:'Next', prev:'Back', submit:'Generate Now',
        name:'Name', age:'Age', height:'Height (cm)', weight:'Weight (kg)', gender:'Gender', male:'Male', female:'Female',
        job:'Job activity', jobVals:['Desk','Light','Moderate'],
        goals:['Fat loss','Muscle gain','Strength','Endurance','General health'],
        meals:'Meals per day', diet:'Preferred diet', diets:['Balanced','Low-Carb','Keto','Mediterranean','Plant-based'],
        fasting:'Intermittent fasting', enable:'Enable', protocol:'Protocol', from:'from', to:'to',
        health:'Health conditions', healthVals:['Hypertension','Diabetes','Insulin Resistance','Thyroid','Fatty Liver','Hormonal issues','GI issues'],
        allergies:'Allergies', allergyVals:['Gluten','Lactose','Nuts','Seafood','Legumes','Added sugars','Vegetable oils'],
        injuries:'Injuries (if any)', exp:'Resistance experience', expVals:['Beginner','Intermediate','Advanced'],
        weak:'Focus points (optional)', desc:'Type muscle: goal (e.g., Chest: upper emphasis; Back: density)',
        detail:'Detail level', days:'Training days/week', addons:'Add-on modules',
        add:{ grocery:'Grocery list', micro:'Micronutrient targets', hydration:'Hydration plan', periodization:'4-week periodization', budget:'Budget swaps', prep:'Meal-prep guide', cooking:'Cooking tips' },
        building:'Generating a fully-detailed plan, no shortcutsâ€¦', apiFail:'Model unreachable. Try again.',
        err:'Please complete required fields', print:'Print / Save',
        auditOK:'Validated: all days match targets (Â±1%) and meal count is correct.',
        auditWarn:'Notice: some days were auto-repaired to match targets. Check badges.',
        auditErr:'Warning: some days still out of range. Adjust or regenerate.',
        badgeOK:'âœ… OK', badgeFix:'ğŸ› ï¸ Fixed', badgeFail:'âš ï¸ Check'
      },
      map:{
        job:{'Ù…ÙƒØªØ¨ÙŠ':'Desk','Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ':'Light','Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·':'Moderate'},
        diet:{'Ù…ØªÙˆØ§Ø²Ù†':'Balanced','Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª':'Low-Carb','ÙƒÙŠØªÙˆ':'Keto','Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·':'Mediterranean','Ù†Ø¨Ø§ØªÙŠ':'Plant-based'},
        goals:{'Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†':'Fat loss','Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª':'Muscle gain','Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©':'Strength','ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„':'Endurance','ØµØ­Ø© Ø¹Ø§Ù…Ø©':'General health'},
        exp:{'Ù…Ø¨ØªØ¯Ø¦':'Beginner','Ù…ØªÙˆØ³Ø·':'Intermediate','Ù…ØªÙ‚Ø¯Ù…':'Advanced'}
      }}
    };

    /* ======================== State & Elements ======================== */
    const el = id => document.getElementById(id);
    const content=el('stage'), live=el('live'), bar=el('bar'), stepSpan=el('step');
    const kTDEE=el('kpi-tdee'), kP=el('kpi-P'), kC=el('kpi-C');
    let lang='ar', step=0; const total=5;

    const user={
      name:'', age:'', height:'', weight:'', gender:'Male', job:'Desk',
      goals:[], meals:4, diet:'Balanced',
      fasting:{enabled:false, protocol:'16:8', start:'12:00', end:'20:00'},
      health:[], allergies:[], injuries:'',
      exp:'Beginner', weak_points:{},
      detail:'max', train_days:7,
      include:{grocery:true, micro:true, hydration:true, periodization:true, budget:false, prepGuide:true, cookingTips:true}
    };

    let planJSON=null;        // JSON Ù…Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
    let proseMD='';           // Markdown Ù…Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©
    let audit=null;           // Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚

    /* ======================== Helpers ======================== */
    const T = k=>L[lang].ui[k];
    function setLang(l){
      lang=l; document.documentElement.lang=l; document.documentElement.dir=(l==='ar'?'rtl':'ltr');
      document.body.classList.toggle('font-ar',l==='ar'); document.body.classList.toggle('font-en',l!=='ar');
      el('hero-title').textContent=T('title'); el('hero-sub').textContent=L[lang].ui.sub;
      el('kpi-title').textContent=T('kpi'); el('live-title').textContent=T('live');
      el('lang-badge').textContent=l.toUpperCase(); el('btn-print').textContent=T('print'); el('btn-print-2').textContent=T('print');
      draw(); updateLive(); updateCTA();
    }
    function f(label,id,opt={}){ const {type='text',value='',select=null,rows=3,placeholder=''}=opt;
      if(select){ return `<label class="block"><span class="text-sm">${label}</span>
        <select id="${id}" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700">
          ${select.map(o=>`<option value="${o.value}" ${String(value)===String(o.value)?'selected':''}>${o.label}</option>`).join('')}
        </select></label>`;}
      if(type==='textarea'){ return `<label class="block"><span class="text-sm">${label}</span>
        <textarea id="${id}" rows="${rows}" placeholder="${placeholder}" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700">${value||''}</textarea></label>`;}
      return `<label class="block"><span class="text-sm">${label}</span>
        <input id="${id}" type="${type}" value="${value}" placeholder="${placeholder}" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700"/></label>`;
    }
    function chips(name,arr,checked=[]){
      return `<div class="flex flex-wrap gap-2">${arr.map(v=>`
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-[#0b121a] border border-slate-700 cursor-pointer">
          <input type="checkbox" name="${name}" value="${v}" class="accent-violet-600" ${checked.includes(v)?'checked':''}/>
          <span class="text-sm">${v}</span></label>`).join('')}</div>`;
    }
    function mapOut(type,val){ // normalize display
      if(lang==='ar'){ const map=L.ar.map[type]||{}; return map[val]||val; }
      else          { const map=L.en.map[type]||{}; return map[val]||val; }
    }
    function mapGoalsOut(arr){ if(lang==='ar') return arr.map(v=>L.ar.map.goals[v]||v); else return arr.map(v=>L.en.map.goals[v]||v); }

    function calc(){
      const W=+user.weight||0, H=+user.height||0, A=+user.age||0, male=(user.gender==='Male');
      const BMR = male? 10*W+6.25*H-5*A+5 : 10*W+6.25*H-5*A-161;
      const pal = /Desk|Ù…ÙƒØªØ¨ÙŠ/.test(user.job)?1.2 : /Moderate|Ù…ØªÙˆØ³Ø·/.test(user.job)?1.5 : 1.35;
      let TDEE=BMR*pal;
      if(user.goals.some(g=>/Fat|Ø¯Ù‡ÙˆÙ†/.test(g))) TDEE*=0.85;
      if(user.goals.some(g=>/Muscle|Ø¹Ø¶Ù„Ø§Øª/.test(g))) TDEE*=1.10;
      const P=Math.round(2.0*(+user.weight||1));
      const F=Math.round(0.8*(+user.weight||1));
      let C=Math.round((TDEE-(P*4+F*9))/4);
      if(user.health.some(h=>/Diab|Ø§Ù„Ø³ÙƒØ±ÙŠ|Insulin|Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†/.test(h))) C=Math.min(C,120);
      C=Math.max(0,C);
      return {TDEE:Math.round(TDEE),P,F,C};
    }
    function updateKPIs(){ const c=calc(); kTDEE.textContent=c.TDEE; kP.textContent=c.P+' g'; kC.textContent=c.C+' g'; }
    function updateProgress(){ bar.style.width=(((step+1)/total)*100)+'%'; stepSpan.textContent=String(step+1); }
    function updateCTA(){ el('btn-prev').textContent=T('prev'); el('btn-next').textContent = step===total-1?T('submit'):T('next'); el('btn-prev').disabled=(step===0); }

    function updateLive(){
      updateKPIs(); const c=calc();
      const g = (user.goals||[]).join(lang==='ar'?'ØŒ ':', ')||'â€”';
      live.innerHTML = `
        <div class="text-xs muted">${T('name')}: <b class="text-slate-200">${user.name||'â€”'}</b></div>
        <div class="grid grid-cols-3 gap-2 text-xs">
          <div class="kpi"><div class="muted">${T('age')}</div><b>${user.age||'â€”'}</b></div>
          <div class="kpi"><div class="muted">${T('height')}</div><b>${user.height||'â€”'}</b></div>
          <div class="kpi"><div class="muted">${T('weight')}</div><b>${user.weight||'â€”'}</b></div>
        </div>
        <div class="text-xs muted">${lang==='ar'?'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù':'Goals'}: <b class="text-slate-200">${g}</b></div>
        <div class="text-xs muted">${T('diet')}: <b class="text-slate-200">${mapOut('diet',user.diet)}</b> â€” ${T('meals')}: <b class="text-slate-200">${user.meals}</b></div>
        <div class="text-xs muted">${T('fasting')}: <b class="text-slate-200">${user.fasting.enabled? user.fasting.protocol+' '+user.fasting.start+'-'+user.fasting.end : 'â€”'}</b></div>
        <div class="grid grid-cols-3 gap-2 text-xs mt-2">
          <div class="kpi"><div>Ø§Ù„Ø³Ø¹Ø±Ø§Øª</div><b>${c.TDEE} kcal</b></div>
          <div class="kpi"><div>Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†</div><b>${c.P} g</b></div>
          <div class="kpi"><div>Ø§Ù„ÙƒØ§Ø±Ø¨</div><b>${c.C} g</b></div>
        </div>`;
      const mods = Object.entries(user.include).filter(([_,v])=>v).map(([k])=>T('add')[k]||k).join(' â€¢ ')||'â€”';
      live.innerHTML += `<div class="text-[11px] muted mt-2">${T('addons')}: ${mods}</div>`;
    }

    /* ======================== UI (Stages) ======================== */
    function draw(){
      updateProgress();
      const U=L[lang].ui;
      if(step===0){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[0]}</h3>
          <div class="grid sm:grid-cols-2 gap-4">
            ${f(U.name,'name',{value:user.name})}
            ${f(U.gender,'gender',{select:[{value:'Male',label:U.male},{value:'Female',label:U.female}],value:user.gender})}
            ${f(U.age,'age',{type:'number',value:user.age})}
            ${f(U.height,'height',{type:'number',value:user.height})}
            ${f(U.weight,'weight',{type:'number',value:user.weight})}
            ${f(U.job,'job',{select:U.jobVals.map(v=>({value:v,label:v})),value:mapOut('job',user.job)})}
          </div>
          <div class="grid lg:grid-cols-3 gap-4 mt-3">
            <label class="block">
              <span class="text-sm">${U.detail}</span>
              <select id="detail" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700">
                <option value="minimal">minimal</option><option value="standard">standard</option><option value="max" selected>max</option>
              </select>
            </label>
            <label class="block">
              <span class="text-sm">${U.days}</span>
              <select id="train_days" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700">
                <option>3</option><option>4</option><option>5</option><option selected>7</option>
              </select>
            </label>
            <div class="rounded-xl p-3 bg-[#0b121a] border border-slate-700">
              <div class="text-sm mb-2">${U.addons}</div>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <label class="inline-flex items-center gap-2"><input id="inc_grocery" type="checkbox" class="accent-violet-600" checked/>${U.add.grocery}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_micro" type="checkbox" class="accent-violet-600" checked/>${U.add.micro}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_hyd" type="checkbox" class="accent-violet-600" checked/>${U.add.hydration}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_period" type="checkbox" class="accent-violet-600" checked/>${U.add.periodization}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_budget" type="checkbox" class="accent-violet-600"/>${U.add.budget}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_prep" type="checkbox" class="accent-violet-600" checked/>${U.add.prep}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_cook" type="checkbox" class="accent-violet-600" checked/>${U.add.cooking}</label>
              </div>
            </div>
          </div>`;
      } else if(step===1){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[1]}</h3>
          <div class="space-y-4">
            <div><div class="text-sm mb-1">${lang==='ar'?'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù':'Goals'}</div>${chips('goal',U.goals,mapGoalsOut(user.goals))}</div>
            <div class="grid sm:grid-cols-3 gap-4">
              ${f(U.meals,'meals',{select:[{value:3,label:'3'},{value:4,label:'4'},{value:5,label:'5'},{value:6,label:'6'}],value:user.meals})}
              ${f(U.diet,'diet',{select:U.diets.map(d=>({value:d,label:d})),value:mapOut('diet',user.diet)})}
            </div>
            <div class="rounded-xl p-3 bg-[#0b121a] border border-slate-700">
              <label class="inline-flex items-center gap-2"><input id="fasting_enabled" type="checkbox" class="accent-violet-600" ${user.fasting.enabled?'checked':''}/>
                <span>${U.fasting} â€” ${U.enable}</span></label>
              <div class="grid sm:grid-cols-3 gap-3 mt-2">
                ${f(U.protocol,'fasting_protocol',{select:['14:10','16:8','18:6','20:4'].map(x=>({value:x,label:x})),value:user.fasting.protocol})}
                <label><span class="text-sm">${U.from}</span><input id="fasting_start" type="time" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700" value="${user.fasting.start}"/></label>
                <label><span class="text-sm">${U.to}</span><input id="fasting_end" type="time" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700" value="${user.fasting.end}"/></label>
              </div>
            </div>
          </div>`;
      } else if(step===2){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[2]}</h3>
          <div class="space-y-4">
            <div><div class="text-sm mb-1">${U.health}</div>${chips('health',U.healthVals,user.health)}</div>
            <div><div class="text-sm mb-1">${U.allergies}</div>${chips('all',U.allergyVals,user.allergies)}</div>
            ${f(U.injuries,'injuries',{type:'textarea',rows:3,value:user.injuries,placeholder: lang==='ar'?'Ø§Ø°ÙƒØ± Ø§Ù„Ù…ÙƒØ§Ù† ÙˆØ§Ù„ÙˆØµÙ':'Describe area & details'})}
          </div>`;
      } else if(step===3){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[3]}</h3>
          <div class="grid sm:grid-cols-3 gap-4">
            ${f(U.exp,'exp',{select:U.expVals.map(x=>({value:x,label:x})),value:mapOut('exp',user.exp)})}
            <label class="block col-span-2"><span class="text-sm">${U.weak}</span>
              <input id="weak_raw" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700" placeholder="${U.desc}" value="${serializeWeak()}">
            </label>
          </div>`;
      } else {
        content.innerHTML=`
          <div class="text-center py-8"><div class="text-sm muted mb-2">${U.building}</div>
          <div class="w-12 h-12 rounded-full border-4 border-violet-600 border-t-transparent animate-spin mx-auto"></div></div>`;
      }
    }
    function serializeWeak(){ const e=Object.entries(user.weak_points||{}); return e.length? e.map(([k,v])=>`${k}:${v}`).join('; '):''; }
    function saveStep(){
      try{
        if(step===0){
          user.name=el('name').value.trim(); user.gender=el('gender').value;
          user.age=+el('age').value; user.height=+el('height').value; user.weight=+el('weight').value;
          const jobVal=el('job').value; user.job = (lang==='ar') ? (L.en.map.job[jobVal]||jobVal) : jobVal;
          user.detail=el('detail').value; user.train_days=+el('train_days').value;
          user.include={grocery:el('inc_grocery').checked, micro:el('inc_micro').checked, hydration:el('inc_hyd').checked, periodization:el('inc_period').checked, budget:el('inc_budget').checked, prepGuide:el('inc_prep').checked, cookingTips:el('inc_cook').checked};
          if(!user.name||!user.age||!user.height||!user.weight) throw 0;
        } else if(step===1){
          const rawGoals=[...document.querySelectorAll('input[name="goal"]:checked')].map(e=>e.value);
          user.goals = (lang==='ar') ? rawGoals.map(g=>L.en.map.goals[g]||g) : rawGoals;
          const dietVal=el('diet').value; user.diet=(lang==='ar')?(L.en.map.diet[dietVal]||dietVal):dietVal;
          user.meals=+el('meals').value; user.fasting.enabled=el('fasting_enabled').checked;
          user.fasting.protocol=el('fasting_protocol').value; user.fasting.start=el('fasting_start').value; user.fasting.end=el('fasting_end').value;
          if(!user.goals.length) throw 0;
        } else if(step===2){
          user.health=[...document.querySelectorAll('input[name="health"]:checked')].map(e=>e.value);
          user.allergies=[...document.querySelectorAll('input[name="all"]:checked')].map(e=>e.value);
          user.injuries=el('injuries').value||'';
        } else if(step===3){
          const expVal=el('exp').value; user.exp=(lang==='ar')?(L.en.map.exp[expVal]||expVal):expVal;
          const weak_raw=el('weak_raw').value.trim(); user.weak_points={};
          if(weak_raw){ weak_raw.split(';').forEach(pair=>{ const [k,...rest]=pair.split(':'); const v=rest.join(':').trim(); if(k&&v) user.weak_points[k.trim()]=v; }); }
        }
        updateLive(); return true;
      }catch{ toast(L[lang].ui.err,'err'); return false; }
    }

    /* ======================== AI JSON-FIRST PIPELINE ======================== */
    function buildSchemaPrompt(){
      const c=calc(); const outLang=(lang==='ar'?'AR':'EN'); const meals=user.meals;
      const inc=user.include, detail=user.detail, train=user.train_days;
      return `
You are **Coach Mustafa Al-Safi**. OUTPUT LANGUAGE: **${outLang}**.
Return **ONLY strict JSON** (no prose). Seven fully detailed, different days. No placeholders. Respect allergies/conditions. Meals per day = ${meals}. Daily macros must hit target Â±1%.

"targets": { "kcal": ${c.TDEE}, "protein_g": ${c.P}, "fat_g": ${c.F}, "carb_g": ${c.C} }

Schema:
{
  "client": {
    "name": string,
    "language": "${outLang}",
    "goals": string[],           // e.g. ["Fat loss","Muscle gain"]
    "diet": string,              // Balanced/Low-Carb/Keto/Mediterranean/Plant-based
    "meals_per_day": ${meals},
    "fasting": { "enabled": ${user.fasting.enabled}, "protocol": "${user.fasting.protocol}", "start": "${user.fasting.start}", "end": "${user.fasting.end}" },
    "health": string[],
    "allergies": string[],
    "injuries": string,
    "experience": "${user.exp}",
    "focus_points": { /* e.g. Chest:"upper", Back:"density" */ }
  },
  "nutrition": [
    // 7 objects Day 1..7
    {
      "day": 1,
      "meals": [
        {
          "index": 1,
          "name": "Arabic food name if AR; English if EN",
          "items": [ { "name": "food item", "qty": number, "unit": "g|ml|unit" }, ... ],
          "protein_g": number,
          "fat_g": number,
          "carb_g": number,
          "kcal": number
        }
        // count = ${meals}
      ],
      "total": { "protein_g": number, "fat_g": number, "carb_g": number, "kcal": number }
    }
    // days 2..7
  ],
  "training": [
    // 7 objects Day 1..7
    {
      "day": 1,
      "blocks": [
        {
          "exercise": "English name only",
          "notes": "${(lang==='ar')?'Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ø±Ø¨ÙŠØ© Ù‚ØµÙŠØ±Ø©':'Short English note'}",
          "sets": number, "reps": "e.g. 8-12", "tempo": "e.g. 3-1-1", "rest_s": number, "rir": number
        }
        // 5â€“7 exercises depending on detail
      ]
    }
    // days 2..7
  ],
  "supplements": {
    "core": [ { "name":"Creatine Monohydrate", "dose":"5 g/day", "timing":"post-workout or any time", "notes":"" }, ... ],
    "condition": [ { "condition":"Diabetes", "name":"...", "dose":"...", "timing":"...", "cautions":"..." }, ... ]
  },
  "addons": {
    "grocery": ${inc.grocery},
    "micronutrients": ${inc.micro},
    "hydration": ${inc.hydration},
    "periodization": ${inc.periodization},
    "budget": ${inc.budget},
    "prepGuide": ${inc.prepGuide},
    "cookingTips": ${inc.cookingTips}
  }
}

Constraints:
- 7 FULL DIFFERENT days for nutrition & training.
- Each nutrition day must have ${meals} meals.
- Sum of day totals must be within Â±1% of targets.
- Avoid all allergies: ${(user.allergies||[]).join(', ')||'None'}.
- Respect conditions: ${(user.health||[]).join(', ')||'None'} and injuries: ${user.injuries||'None'}.
- No placeholder text. All numeric fields must be numbers.
Client summary:
${JSON.stringify({
  name:user.name, goals:user.goals, diet:user.diet, meals_per_day:user.meals,
  fasting:user.fasting, health:user.health, allergies:user.allergies,
  injuries:user.injuries, experience:user.exp, focus_points:user.weak_points
})}
      `.trim();
    }

    function buildProsePrompt(){
      const outLang=(lang==='ar'?'AR':'EN');
      return `
You are **Coach Mustafa Al-Safi**. OUTPUT LANGUAGE: **${outLang}**.
Given the attached structured JSON (already validated): write ONLY Markdown prose sections **without altering tables or numbers**:
1) ## Intro & Case Assessment â€” detailed, practical.
2) ## Allowed & Avoid List â€” tailored to diet/allergies/conditions.
3) ## Intermittent Fasting â€” exact protocol, what breaks fast, mistakes, cautions.
4) ## Supplements & Recovery â€” Core vs Condition-specific with doses/timing/cautions.
5) ## Success & Progression â€” calorie adjustments, steps/sleep/water/stress, carb tuning.
6) ## 7 Daily Motivation Messages â€” Day 1 â†’ Day 7, short and actionable.
7) ## Add-On Modules â€” as requested (grocery/micro/hydration/periodization/budget/prep/cooking).
8) ## Coach Signature & Rights â€” include: "Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯" and "Powered by Mustafa Elsafy 2025".

Rules:
- If AR: Arabic prose & food names; exercise names remain in English with a short Arabic note.
- If EN: English prose; exercise names in English with short English note.
- No placeholders, no repetition. No summaries: write fully.
      `.trim();
    }

    async function callAI(body, tries=2){
      for(let i=0;i<tries;i++){
        const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), 30000);
        try{
          const r=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body),signal:ctrl.signal});
          clearTimeout(t);
          if(r.ok) return await r.json();
          if(i===tries-1) throw new Error(await r.text());
        }catch(e){ if(i===tries-1) throw e; await new Promise(s=>setTimeout(s, 1200*(i+1))); }
      }
    }

    function within1pct(actual, target){ const pct=(a,b)=>Math.abs(a-b)/Math.max(1,b); return pct(actual.kcal,target.kcal)<=0.01 && pct(actual.protein_g,target.protein_g)<=0.01 && pct(actual.fat_g,target.fat_g)<=0.01 && pct(actual.carb_g,target.carb_g)<=0.01; }

    function auditJSON(json){
      const target={kcal:json.targets.kcal, protein_g:json.targets.protein_g, fat_g:json.targets.fat_g, carb_g:json.targets.carb_g};
      const mealsRequired = json.client.meals_per_day;
      const res={nutrition:[], training:[], summary:{ok:true, fixed:false}};
      for(const day of json.nutrition){
        const okMeals = (day.meals||[]).length===mealsRequired;
        const totals = day.total||{protein_g:0,fat_g:0,carb_g:0,kcal:0};
        const okMacros = within1pct(totals,target);
        res.nutrition.push({day:day.day, okMeals, okMacros});
        if(!okMeals || !okMacros) res.summary.ok=false;
      }
      for(const day of json.training){
        let okSchema = true;
        for(const b of (day.blocks||[])){
          if(!b.exercise || !b.sets || !b.reps || !b.tempo || !b.rest_s || (b.rir===undefined)) { okSchema=false; break; }
        }
        res.training.push({day:day.day, okSchema}); if(!okSchema) res.summary.ok=false;
      }
      return res;
    }

    async function repairDays(json, auditRes){
      const target=json.targets;
      let repaired=false;
      for(const n of auditRes.nutrition){
        if(n.okMeals && n.okMacros) continue;
        // Ø·Ù„Ø¨ Ø¥ØµÙ„Ø§Ø­ ÙŠÙˆÙ… Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·
        const fixPrompt = `
Fix ONLY this nutrition day to match targets Â±1% and exactly ${json.client.meals_per_day} meals.
Return strict JSON for this day:
{ "day": ${n.day}, "meals":[...], "total":{"protein_g":number,"fat_g":number,"carb_g":number,"kcal":number} }
Targets: ${JSON.stringify(target)}
Allergies: ${(json.client.allergies||[]).join(', ')||'None'} â€¢ Conditions: ${(json.client.health||[]).join(', ')||'None'}
Diet: ${json.client.diet} â€¢ Meals/day: ${json.client.meals_per_day}
Language: ${json.client.language}
        `.trim();
        const r = await callAI({prompt:fixPrompt});
        try{
          const txt = (r && r.text) ? r.text : JSON.stringify(r||{});
          const fixed = JSON.parse(txt);
          // Ø¯Ù…Ø¬
          const i = json.nutrition.findIndex(d=>d.day===n.day);
          if(i>=0 && fixed && fixed.meals && fixed.total) { json.nutrition[i]=fixed; repaired=true; }
        }catch{}
      }
      return {json, repaired};
    }

    function renderTablesFromJSON(json){
      const out=[];
      // ØªØºØ°ÙŠØ© 7 Ø£ÙŠØ§Ù…
      out.push(`<h2 id="nutrition">## ${lang==='ar'?'Ø®Ø·Ø© Ø§Ù„ØªØºØ°ÙŠØ© (7 Ø£ÙŠØ§Ù…)':'Nutrition Plan (7 Days)'}</h2>`);
      for(const day of json.nutrition){
        const badge = badgeForDay(day.day, json);
        out.push(`<h3>${lang==='ar'?'Ø§Ù„ÙŠÙˆÙ…':'Day'} ${day.day} ${badge}</h3>`);
        out.push(`<table>
          <thead><tr>
            <th style="text-align:right">Meal #</th>
            <th style="text-align:right">${lang==='ar'?'Ø§Ù„ÙˆØ¬Ø¨Ø©':'Meal'}</th>
            <th style="text-align:right">${lang==='ar'?'Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª (Ø¨Ø§Ù„Ø¬Ø±Ø§Ù…/Ø§Ù„ÙˆØ­Ø¯Ø©)':'Ingredients (g/unit)'}</th>
            <th style="text-align:right">Protein (g)</th>
            <th style="text-align:right">Fat (g)</th>
            <th style="text-align:right">Carbs (g)</th>
            <th style="text-align:right">Calories</th>
          </tr></thead><tbody>
          ${day.meals.map(m=>{
            const items = (m.items||[]).map(it=>`${it.name} ${it.qty}${it.unit||'g'}`).join(' â€¢ ');
            return `<tr>
              <td style="text-align:right">${m.index}</td>
              <td style="text-align:right">${m.name} <span class="pill">[Swap]</span></td>
              <td style="text-align:right">${items}</td>
              <td style="text-align:right">${m.protein_g}</td>
              <td style="text-align:right">${m.fat_g}</td>
              <td style="text-align:right">${m.carb_g}</td>
              <td style="text-align:right">${m.kcal}</td>
            </tr>`;
          }).join('')}
          </tbody></table>
          <div><b>${lang==='ar'?'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ':'Daily Total'} â†’ P:${day.total.protein_g} F:${day.total.fat_g} C:${day.total.carb_g} Kcal:${day.total.kcal}</b></div>`);
      }

      // ØªØ¯Ø±ÙŠØ¨ 7 Ø£ÙŠØ§Ù…
      out.push(`<h2 id="training">## ${lang==='ar'?'Ø®Ø·Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)':'Training Plan (7 Days)'}</h2>`);
      for(const day of json.training){
        out.push(`<h3>${lang==='ar'?'Ø§Ù„ÙŠÙˆÙ…':'Day'} ${day.day}</h3>`);
        out.push(`<table>
          <thead><tr>
            <th style="text-align:right">${lang==='ar'?'Ø§Ù„ÙŠÙˆÙ…':'Day'}</th>
            <th style="text-align:right">Exercise (EN)</th>
            <th style="text-align:right">${lang==='ar'?'Ù…Ù„Ø§Ø­Ø¸Ø§Øª':'Notes'}</th>
            <th style="text-align:right">Sets</th>
            <th style="text-align:right">Reps</th>
            <th style="text-align:right">Tempo</th>
            <th style="text-align:right">Rest (s)</th>
            <th style="text-align:right">RIR</th>
          </tr></thead><tbody>
          ${day.blocks.map(b=>`<tr>
            <td style="text-align:right">${day.day}</td>
            <td style="text-align:right">${b.exercise}</td>
            <td style="text-align:right">${b.notes||''}</td>
            <td style="text-align:right">${b.sets}</td>
            <td style="text-align:right">${b.reps}</td>
            <td style="text-align:right">${b.tempo}</td>
            <td style="text-align:right">${b.rest_s}</td>
            <td style="text-align:right">${b.rir}</td>
          </tr>`).join('')}
          </tbody></table>`);
      }
      return out.join('\n');
    }

    function badgeForDay(dayIndex, json){
      const target=json.targets, mealsRequired=json.client.meals_per_day;
      const day = json.nutrition.find(d=>d.day===dayIndex);
      const okMeals = (day.meals||[]).length===mealsRequired;
      const okMacros = within1pct(day.total, target);
      // Ù‡Ù„ ØªÙ… Ø¥ØµÙ„Ø§Ø­ØŸ
      const a = audit || {nutrition:[]};
      const rec = (a.nutrition||[]).find(x=>x.day===dayIndex);
      let status = '';
      if(okMeals && okMacros) status = `<span class="${(rec && !rec.okMeals || rec && !rec.okMacros)?'warn':'ok'}"> ${L[lang].ui[ (rec && (!rec.okMeals || !rec.okMacros)) ? 'badgeFix' : 'badgeOK' ]}</span>`;
      else status = `<span class="err"> ${L[lang].ui.badgeFail}</span>`;
      return status;
    }

    /* ======================== PIPELINE MAIN ======================== */
    async function generatePlan(){
      // Ø¹Ø±Ø¶ Ø¬Ø²Ø¡ Ø§Ù„Ù†ØªÙŠØ¬Ø©
      el('result').classList.remove('hidden');
      el('ai-html').innerHTML = `<div class="text-center py-10">
        <div class="w-12 h-12 rounded-full border-4 border-violet-600 border-t-transparent animate-spin mx-auto"></div>
        <div class="mt-3">${L[lang].ui.building}</div></div>`;

      // 1) Ø·Ù„Ø¨ JSON
      const schemaPrompt = buildSchemaPrompt();
      const jRes = await callAI({prompt:schemaPrompt});
      let raw = (jRes && jRes.text) ? jRes.text : JSON.stringify(jRes||{});
      // ØªÙ†Ø¸ÙŠÙ Ø£Ø³Ø·Ø± Ø²Ø§Ø¦Ø¯Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª
      raw = raw.trim().replace(/```json|```/g,'');
      try{ planJSON = JSON.parse(raw); }catch(e){
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø©: Ø§Ø·Ù„Ø¨ Ù…Ù†Ù‡ Ø¥Ø¹Ø§Ø¯Ø© JSON ØµØ§Ù„Ø­
        const fix = await callAI({prompt:`Your previous JSON was invalid. Return ONLY strict valid JSON for the same schema now: ${schemaPrompt.slice(0,1800)}`});
        const fixedRaw = (fix && fix.text) ? fix.text.trim().replace(/```json|```/g,'') : '{}';
        planJSON = JSON.parse(fixedRaw);
      }

      // 2) ØªØ¯Ù‚ÙŠÙ‚
      audit = auditJSON(planJSON);
      // 3) Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£ÙŠØ§Ù… Ø¥Ù† Ù„Ø²Ù…
      if(!audit.summary?.ok){
        const repaired = await repairDays(planJSON, audit);
        planJSON = repaired.json;
        audit = auditJSON(planJSON);
      }

      // 4) Ø±Ù†Ø¯Ø±Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ù† JSON (Ø¨Ø¯ÙˆÙ† Ù†Øµ)
      const tablesHTML = renderTablesFromJSON(planJSON);

      // 5) Ø·Ù„Ø¨ "Ù†ØµÙˆØµ" ÙÙ‚Ø· (Prose Pass) â€” Ù„Ø§ ÙŠØºÙŠØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
      const prosePrompt = buildProsePrompt();
      const proseRes = await callAI({prompt: prosePrompt + `\n\nUse this client JSON as context:\n${JSON.stringify(planJSON).slice(0,150000)}`});
      proseMD = (proseRes && proseRes.text) ? proseRes.text : '';

      // 6) Ø¯Ù…Ø¬: Ù†ØµÙˆØµ + Ø¬Ø¯Ø§ÙˆÙ„
      const mergedMD = [
        proseMD,
        '\n\n---\n',
        tablesHTML
      ].join('\n');

      // 7) Ø¹Ø±Ø¶ Ø¨Ø£Ù…Ø§Ù†
      const withAnchors = mergedMD.replace(/^#{2,3}\s+(.*)$/gm,(m,h)=>`${m}\n[â¬†ï¸](#top)\n<a id="${(h||'').trim().toLowerCase().replace(/[^\w\u0600-\u06FF]+/g,'-')}"></a>`);
      const safe = DOMPurify.sanitize(marked.parse(withAnchors), {ALLOWED_ATTR:['id','class','href','align']});
      el('ai-html').innerHTML = `<div id="top"></div>` + safe;

      // 8) Ø¨Ø§Ù†Ø± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚
      const banner = el('audit-banner');
      if(audit.summary.ok){
        banner.className='mt-3 rounded-xl p-3 border border-emerald-500/30 bg-emerald-500/10';
        banner.innerHTML=`<b>${L[lang].ui.auditOK}</b>`;
      } else {
        const key = (audit.summary.fixed?'auditWarn':'auditErr');
        banner.className='mt-3 rounded-xl p-3 border border-amber-500/30 bg-amber-500/10';
        banner.innerHTML=`<b>${L[lang].ui[key]}</b>`;
      }
      banner.classList.remove('hidden');

      // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
      el('ai-html').querySelectorAll('table').forEach(t=>{
        t.classList.add('w-full','text-sm');
        t.querySelectorAll('th').forEach(th=>th.classList.add('bg-[#0b121a]'));
      });
    }

    /* ======================== Controls ======================== */
    function scrollToResult(){ el('result').scrollIntoView({behavior:'smooth',block:'start'}); }
    function toast(msg,kind='ok'){ const box=document.createElement('div'); box.className=`fixed top-5 ${lang==='ar'?'right-5':'left-5'} z-50 px-3 py-2 rounded-xl text-sm text-white ${kind==='err'?'bg-red-600':'bg-emerald-600'}`; box.textContent=msg; document.body.appendChild(box); setTimeout(()=>box.remove(),2200); }
    function updateUIAfterLang(){ draw(); updateLive(); updateCTA(); }
    el('btn-prev').onclick=()=>{ if(step>0){ step--; draw(); updateCTA(); } };
    el('btn-next').onclick=async ()=>{
      if(step<total-1){
        if(!saveStep()) return;
        step++; draw(); updateCTA();
        if(step===total-1){ if(!saveStep()) return; await generatePlan(); scrollToResult(); }
      }
    };
    el('btn-again').onclick=()=>location.reload();
    el('btn-print').onclick=()=>window.print();
    el('btn-print-2').onclick=()=>window.print();

    el('btn-lang-ar').onclick=()=>{
      if(!confirm('Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„ Ø´ÙŠØ¡ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©. Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
      setLang('ar'); planJSON=null; proseMD=''; audit=null; el('result').classList.add('hidden'); updateUIAfterLang();
    };
    el('btn-lang-en').onclick=()=>{
      if(!confirm('Regenerate everything in English?')) return;
      setLang('en'); planJSON=null; proseMD=''; audit=null; el('result').classList.add('hidden'); updateUIAfterLang();
    };

    el('btn-export-json').onclick=()=>{
      if(!planJSON) return toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø© Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§','err');
      const blob=new Blob([JSON.stringify(planJSON,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='plan.json'; a.click();
    };
    el('btn-export-csv').onclick=()=>{
      if(!planJSON) return toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø© Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§','err');
      const rows=[['type','day','col1','col2','col3','col4','col5','col6','col7']];
      for(const d of planJSON.nutrition){
        for(const m of d.meals){
          const items=(m.items||[]).map(i=>`${i.name} ${i.qty}${i.unit||'g'}`).join(' | ');
          rows.push(['meal',d.day,String(m.index),m.name,items, String(m.protein_g),String(m.fat_g),String(m.carb_g),String(m.kcal)]);
        }
        rows.push(['total',d.day,'','','', String(d.total.protein_g),String(d.total.fat_g),String(d.total.carb_g),String(d.total.kcal)]);
      }
      for(const d of planJSON.training){
        for(const b of d.blocks){
          rows.push(['exercise',d.day,b.exercise,b.notes||'', String(b.sets),b.reps,b.tempo,String(b.rest_s),String(b.rir)]);
        }
      }
      const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='plan.csv'; a.click();
    };

    /* ======================== Init ======================== */
    function updateCTA(){ el('btn-prev').textContent=T('prev'); el('btn-next').textContent= (step===total-1?T('submit'):T('next')); el('btn-prev').disabled=(step===0); }
    setLang('ar'); draw(); updateLive(); updateCTA();
  </script>
</body>
</html>
