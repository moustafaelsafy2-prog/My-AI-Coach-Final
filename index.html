<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>المدرب الشخصي — خطة نهائية دقيقة</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com" defer></script>
  <!-- Markdown + Sanitize + PDF -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer onerror="window.__NO_MARKED__=true"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js" defer onerror="window.__NO_PURIFY__=true"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js" defer onerror="window.__NO_PDF__=true"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0a0f15; --panel:#0e1621; --ink:#e7eaf0; --muted:#a8b0bc; --line:#1b2736;
      --brand:#7c3aed; --brand2:#06b6d4; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --chip:#0b121a; --th:#0b121a;
    }
    [data-theme="light"]{
      --bg:#f6f8fb; --panel:#ffffff; --ink:#0b1220; --muted:#5b6878; --line:#e5eaf1;
      --brand:#6d28d9; --brand2:#0891b2; --ok:#059669; --warn:#d97706; --err:#dc2626;
      --chip:#f1f5f9; --th:#f3f4f6;
    }
    html,body{height:100%}
    body{background:linear-gradient(180deg,var(--bg) 0%, color-mix(in oklab, var(--bg) 75%, white 25%) 100%);color:var(--ink);-webkit-font-smoothing:antialiased}
    .font-ar{font-family:"Tajawal",sans-serif}
    .font-en{font-family:"Poppins",sans-serif}
    .glass{background:color-mix(in oklab, var(--panel) 90%, transparent 10%);border:1px solid color-mix(in oklab, var(--line) 85%, transparent 15%);backdrop-filter:blur(10px)}
    .panel{background:var(--panel);border:1px solid var(--line)}
    .btn{border:1px solid color-mix(in oklab, var(--line) 70%, transparent 30%);border-radius:12px;padding:.8rem 1rem;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand2));border-color:transparent;color:#fff}
    .btn-ghost{background:var(--chip);color:var(--ink)}
    .btn-soft{background:color-mix(in oklab, var(--panel) 95%, white 5%);border:1px solid color-mix(in oklab, var(--line) 80%, transparent 20%)}
    .chip{padding:.28rem .55rem;border-radius:.6rem;font-size:.74rem;background:var(--chip);border:1px dashed color-mix(in oklab, var(--line) 70%, transparent 30%);color:color-mix(in oklab, var(--brand2) 65%, var(--ink) 35%)}
    .kpi{background:color-mix(in oklab, var(--panel) 95%, white 5%);border:1px solid color-mix(in oklab, var(--line) 80%, transparent 20%);border-radius:.8rem;padding:.6rem}
    .muted{color:var(--muted)}
    .prose :where(table){width:100%;border-collapse:collapse}
    .prose :where(th,td){border:1px solid color-mix(in oklab, var(--line) 80%, transparent 20%);padding:.6rem;vertical-align:top}
    .prose :where(th){background:var(--th)}
    .fixed-actions{position:sticky; bottom:0; z-index:50; display:flex; gap:8px; padding:.75rem; background:color-mix(in oklab, var(--panel) 85%, transparent 15%); border-top:1px solid var(--line)}
    @media print{ .no-print, header, #themeToggle {display:none!important}
      body{background:#fff;color:#000}
      .panel,.glass{background:#fff;border:none}
      table{page-break-inside:avoid}
    }
  </style>
</head>
<body class="font-ar">
  <!-- Header -->
  <header class="glass sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-600 to-cyan-500 text-white grid place-items-center font-extrabold">AI</div>
        <div class="leading-tight">
          <div class="text-xs muted">Personal Coaching</div>
          <div class="font-extrabold">Smart Plan</div>
          <div class="text-[11px] muted">Nutrition • Training • Compliance</div>
        </div>
      </div>
      <div class="flex items-center gap-2 no-print">
        <div class="inline-flex bg-[color:var(--chip)] border border-[color:var(--line)] rounded-xl overflow-hidden">
          <button id="btn-lang-ar" class="px-3 py-2 text-sm font-bold">AR</button>
          <button id="btn-lang-en" class="px-3 py-2 text-sm font-bold">EN</button>
        </div>
        <button id="themeToggle" class="btn btn-ghost" title="Theme">☀️/🌙</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 mt-6">
    <div class="glass rounded-2xl p-6 relative overflow-hidden">
      <div class="absolute -top-10 -left-10 w-56 h-56 rounded-full bg-gradient-to-br from-violet-600/25 to-cyan-500/25 blur-2xl"></div>
      <div class="absolute -bottom-10 -right-10 w-56 h-56 rounded-full bg-gradient-to-br from-cyan-500/18 to-violet-600/18 blur-2xl"></div>
      <div class="relative grid lg:grid-cols-[1.1fr,.9fr] gap-6 items-center">
        <div>
          <h1 id="hero-title" class="text-3xl sm:text-4xl font-extrabold">المدرب الشخصي — خطة نهائية دقيقة</h1>
          <p id="hero-sub" class="muted mt-1">
            خطة مخصصة كاملة: ٧ أيام تغذية، ٧ أيام تدريب مطابق لمستواك، مكملات مرتبطة بالحالة الصحية، وإرشادات تطبيق واضحة — بدون اختصار.
          </p>
        </div>
        <div class="panel rounded-2xl p-4">
          <div class="text-xs muted mb-2" id="kpi-title">مؤشرات سريعة</div>
          <div class="grid grid-cols-3 gap-3 text-center">
            <div class="kpi"><div class="text-[11px] muted">TDEE</div><div id="kpi-tdee" class="font-extrabold">—</div></div>
            <div class="kpi"><div class="text-[11px] muted">Protein</div><div id="kpi-P" class="font-extrabold">—</div></div>
            <div class="kpi"><div class="text-[11px] muted">Carbs</div><div id="kpi-C" class="font-extrabold">—</div></div>
          </div>
          <div class="mt-3">
            <div class="h-2 bg-[color:var(--chip)] rounded-full overflow-hidden">
              <div id="bar" class="h-full bg-gradient-to-r from-violet-600 to-cyan-500 w-0 transition-all duration-300"></div>
            </div>
            <div class="text-[11px] muted mt-1">Step <span id="step">1</span> / <span id="stepsTotal">5</span></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 mt-6 grid xl:grid-cols-[minmax(0,1fr),420px] gap-6">
    <!-- Form Panel -->
    <section class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="text-sm chip muted">AR/EN • PDF/Print • Responsive</div>
        <div class="text-xs chip">Powered by Mustafa Elsafy 2025</div>
      </div>
      <div id="stage"></div>
      <div id="controls" class="mt-6 flex gap-2">
        <button id="btn-prev" class="btn btn-soft flex-1">السابق</button>
        <button id="btn-next" class="btn btn-primary flex-1">التالي</button>
      </div>
    </section>

    <!-- Live Summary -->
    <aside class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <div id="live-title" class="text-sm font-bold">ملخص فوري</div>
        <span id="lang-badge" class="chip">AR</span>
      </div>
      <div id="live" class="mt-3 space-y-2 text-sm"></div>
      <div class="mt-3 text-[11px] muted">* توليد كامل عبر الذكاء الاصطناعي — ٧ أيام بتفاصيل كاملة.</div>
    </aside>
  </main>

  <!-- Result -->
  <section id="result" class="max-w-7xl mx-auto px-4 sm:px-6 mt-6 mb-14 hidden">
    <article class="glass rounded-2xl p-6" id="resultRoot">
      <div class="flex items-center justify-between">
        <h2 id="plan-title" class="text-2xl font-extrabold">الخطة الشاملة</h2>
        <div class="no-print flex gap-2">
          <button id="btn-regen-day" class="btn btn-soft" title="إعادة توليد يوم محدد">🔁 يوم</button>
          <button id="btn-regen-sec" class="btn btn-soft" title="إعادة توليد قسم (تغذية/تدريب)">🔁 قسم</button>
        </div>
      </div>

      <div id="welcome" class="mt-3 text-sm">
        <div class="kpi">
          <b id="welcome-title">تم إعداد خطة تنفيذية دقيقة وفق بياناتك.</b>
          <div id="welcome-sub" class="muted mt-1">
            تشمل: تشخيص الحالة، الأهداف، المسموح/الممنوع، الصيام المتقطع (اختياري)، تغذية وتدريب ٧ أيام بجداول كاملة، مكملات، قواعد التقدّم، معالجة التعثر، قائمة تنفيذ، أسئلة شائعة، وسلامة الاستخدام.
          </div>
        </div>
      </div>

      <div id="status" class="mt-3 hidden"></div>
      <div id="ai-nutrition" class="prose prose-invert rtl:text-right ltr:text-left mt-4"></div>
      <hr class="my-6 border-[color:var(--line)]"/>
      <div id="ai-training" class="prose prose-invert rtl:text-right ltr:text-left mt-2"></div>

      <!-- إجراءات سريعة -->
      <div class="fixed-actions no-print">
        <div class="flex-1"></div>
        <button id="act-new" class="btn btn-ghost" title="خطة جديدة / New">↻</button>
        <button id="act-pdf" class="btn btn-ghost" title="PDF">PDF</button>
        <button id="act-print" class="btn btn-primary" title="Print">Print</button>
      </div>

      <footer class="border-t border-slate-700 mt-6 pt-2 text-[12px] muted flex items-center justify-between">
        <span id="rights">Powered by Mustafa Elsafy 2025</span>
        <span id="foot-note"></span>
      </footer>
    </article>
  </section>

  <script>
  (function(){
    // ===== Utilities
    const $ = (id)=>document.getElementById(id);
    const text = (id,val)=>{ const el=$(id); if(el) el.textContent=val; };
    const html = (id,val)=>{ const el=$(id); if(el) el.innerHTML=val; };
    const addClass=(id,c)=>{ const el=$(id); if(el) el.classList.add(c); };
    const rmClass=(id,c)=>{ const el=$(id); if(el) el.classList.remove(c); };

    // ===== Theme
    const themeBtn=$('themeToggle');
    function applyTheme(t){ document.documentElement.setAttribute('data-theme',t); localStorage.setItem('theme',t); themeBtn.textContent=(t==='dark'?'☀️':'🌙'); }
    applyTheme(localStorage.getItem('theme')||'dark');
    themeBtn && (themeBtn.onclick=()=>applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'));

    // ===== i18n
    const L={
      ar:{ ui:{
        title:'المدرب الشخصي — خطة نهائية دقيقة', live:'ملخص فوري',
        steps:['الأساسيات المتقدمة','الأهداف • النظام • الصيام','الصحة • الحساسية • الأدوية','الخبرة • الإصابات • التركيز','إنشاء الخطة'],
        next:'التالي', prev:'السابق', submit:'إنشاء الخطة الآن',
        name:'الاسم', age:'العمر', height:'الطول (سم)', weight:'الوزن (كغ)', gender:'الجنس', male:'ذكر', female:'أنثى',
        job:'النشاط اليومي (PAL)', jobVals:['مكتبي جدًا (PAL 1.15)','مكتبي/خفيف (PAL 1.25)','نشاط متوسط (PAL 1.4)','نشاط عالٍ (PAL 1.6)'],
        goals:['خسارة الدهون','بناء العضلات','زيادة القوة','تحسين التحمل','صحة عامة'],
        meals:'عدد الوجبات/اليوم', diet:'النظام الغذائي', diets:['متوازن','قليل الكربوهيدرات','كيتو','البحر المتوسط','نباتي'],
        fasting:'الصيام المتقطع', enable:'تفعيل', protocol:'البروتوكول',
        window:'نافذة الأكل', from:'من', to:'إلى',
        training_place:'مكان التدريب', placeVals:['نادي كامل','منزل + دامبلز','منزل وزن الجسم'],
        equipment:'معدات متوفرة', equipPH:'اكتب المعدات المتاحة (اختياري)',
        sleep:'ساعات النوم', stress:'مستوى التوتر', stressVals:['منخفض','متوسط','مرتفع'],
        dislikes:'أطعمة غير مفضلة (اختياري)',
        health:'حالات صحية', healthVals:['ضغط الدم','السكري','مقاومة الأنسولين','الغدة الدرقية','الكبد الدهني','مشاكل هرمونية','الجهاز الهضمي'],
        meds:'أدوية (إن وجدت)',
        allergies:'حساسيات', allergyVals:['الجلوتين','اللاكتوز','المكسرات','المأكولات البحرية','البقوليات','السكريات المضافة','الزيوت النباتية'],
        injuries:'إصابات (اذكر المكان والوصف)',
        exp:'خبرة المقاومة', expVals:['مبتدئ','متوسط','متقدم'],
        buildingN:'نُنشئ خطة التغذية (٧ أيام) — الرجاء الانتظار.',
        buildingT:'نُنشئ خطة التدريب (٧ أيام) — الرجاء الانتظار.',
        apiFail:'تعذّر الاتصال — تحقّق من وظيفة Netlify والمفتاح.',
        err:'أكمل الحقول المطلوبة',
        print:'طباعة', pdf:'حفظ PDF',
        rights:'Powered by Mustafa Elsafy 2025',
        resultTitle:'الخطة الشاملة',
        regenDay:'أعد توليد يوم (1-7):',
        regenSec:'اختر القسم لإعادة توليده: التغذية أو التدريب'
      }},
      en:{ ui:{
        title:'Personal Coach — Precise Final Plan', live:'Live Summary',
        steps:['Advanced Basics','Goals • Diet • IF','Health • Allergies • Meds','Experience • Injuries • Focus','Generate Plan'],
        next:'Next', prev:'Back', submit:'Generate Plan Now',
        name:'Name', age:'Age', height:'Height (cm)', weight:'Weight (kg)', gender:'Gender', male:'Male', female:'Female',
        job:'Daily activity (PAL)', jobVals:['Very desk (PAL 1.15)','Desk/Light (PAL 1.25)','Moderate (PAL 1.4)','High (PAL 1.6)'],
        goals:['Fat loss','Muscle gain','Strength','Endurance','General health'],
        meals:'Meals/day', diet:'Preferred diet', diets:['Balanced','Low-Carb','Keto','Mediterranean','Plant-based'],
        fasting:'Intermittent Fasting', enable:'Enable', protocol:'Protocol',
        window:'Feeding window', from:'from', to:'to',
        training_place:'Training place', placeVals:['Full gym','Home + dumbbells','Home bodyweight'],
        equipment:'Available equipment', equipPH:'List available equipment (optional)',
        sleep:'Sleep hours', stress:'Stress level', stressVals:['Low','Moderate','High'],
        dislikes:'Disliked foods (optional)',
        health:'Health conditions', healthVals:['Hypertension','Diabetes','Insulin Resistance','Thyroid','Fatty Liver','Hormonal issues','GI issues'],
        meds:'Medications (if any)',
        allergies:'Allergies', allergyVals:['Gluten','Lactose','Nuts','Seafood','Legumes','Added sugars','Vegetable oils'],
        injuries:'Injuries (location & description)',
        exp:'Resistance experience', expVals:['Beginner','Intermediate','Advanced'],
        buildingN:'Generating Nutrition Plan (7 days) — please wait.',
        buildingT:'Generating Training Plan (7 days) — please wait.',
        apiFail:'Couldn’t reach the model — verify Netlify function and key.',
        err:'Please complete required fields',
        print:'Print', pdf:'Save PDF',
        rights:'Powered by Mustafa Elsafy 2025',
        resultTitle:'The Comprehensive Plan',
        regenDay:'Regenerate day (1-7):',
        regenSec:'Choose section to regenerate: nutrition or training'
      }}
    };

    // ===== State
    const content=$('stage'), live=$('live'), bar=$('bar'), stepSpan=$('step'), stepsTotal=$('stepsTotal');
    const kTDEE=$('kpi-tdee'), kP=$('kpi-P'), kC=$('kpi-C');
    let lang='ar', step=0, total=5; stepsTotal.textContent=String(total);

    const user={
      name:'', age:'', height:'', weight:'', gender:'Male',
      jobLabel:'Desk/Light (PAL 1.25)',
      goals:[], meals:4, diet:(lang==='ar'?'متوازن':'Balanced'),
      fasting:{enabled:false, protocol:'16:8', start:'12:00', end:'20:00'},
      training_place:'Full gym', equipment:'',
      sleep:7, stress:(lang==='ar'?'متوسط':'Moderate'),
      dislikes:'',
      health:[], meds:'',
      allergies:[], injuries:'',
      exp:(lang==='ar'?'مبتدئ':'Beginner'), weak_points:{},
    };

    // ===== Helpers
    function T(k){ return L[lang].ui[k]; }
    function toast(msg,kind='ok'){
      const box=document.createElement('div');
      const side=(document.documentElement.dir==='rtl'?'right':'left');
      box.className=`fixed top-5 ${side}-5 z-50 px-3 py-2 rounded-xl text-sm text-white ${kind==='err'?'bg-red-600':kind==='warn'?'bg-amber-600':'bg-emerald-600'}`;
      box.textContent=msg; document.body.appendChild(box); setTimeout(()=>box.remove(),2600);
    }
    function parsePAL(label){ const m=String(label).match(/PAL\s*([0-9.]+)/); return m? parseFloat(m[1]) : 1.25; }
    function calc(){
      const W=+user.weight||0, H=+user.height||0, A=+user.age||0, male=(user.gender==='Male');
      const BMR = male? 10*W+6.25*H-5*A+5 : 10*W+6.25*H-5*A-161;
      const pal = parsePAL(user.jobLabel||'PAL 1.25');
      let TDEE=BMR*pal;
      if(user.goals.some(g=>/Fat|دهون/.test(g))) TDEE*=0.86;
      if(user.goals.some(g=>/Muscle|عضلات/.test(g))) TDEE*=1.10;
      const P=Math.round(2.0*(+user.weight||1));
      const F=Math.round(Math.max(0,0.8*(+user.weight||1)));
      let C=Math.round((TDEE-(P*4+F*9))/4);
      if(user.health.some(h=>/Diab|السكري|Insulin|الأنسولين/.test(h))) C=Math.min(C,120);
      C=Math.max(0,C);
      return {TDEE:Math.round(TDEE),P,F,C};
    }
    function updateKPIs(){ const c=calc(); kTDEE.textContent=c.TDEE; kP.textContent=c.P+' g'; kC.textContent=c.C+' g'; }
    function updateProgress(){ bar.style.width=(((step+1)/total)*100)+'%'; stepSpan.textContent=String(step+1); }
    function updateButtons(){ $('btn-prev').disabled=(step===0); $('btn-next').textContent=(step===total-1?T('submit'):T('next')); }
    function updateLive(){
      const c=calc();
      const g=(user.goals||[]).join(lang==='ar'?'، ':', ')||'—';
      live.innerHTML=`
        <div class="text-xs muted">${T('name')}: <b>${user.name||'—'}</b></div>
        <div class="grid grid-cols-3 gap-2 text-xs">
          <div class="kpi"><div class="muted">${T('age')}</div><b>${user.age||'—'}</b></div>
          <div class="kpi"><div class="muted">${T('height')}</div><b>${user.height||'—'}</b></div>
          <div class="kpi"><div class="muted">${T('weight')}</div><b>${user.weight||'—'}</b></div>
        </div>
        <div class="text-xs muted">${lang==='ar'?'الأهداف':'Goals'}: <b>${g}</b></div>
        <div class="text-xs muted">${T('diet')}: <b>${user.diet}</b> — ${T('meals')}: <b>${user.meals}</b></div>`;
    }

    // ===== Fields
    function field(label,id,opt={}){ const {type='text',value='',select=null,rows=3,placeholder=''}=opt;
      if(select){ return `<label class="block"><span class="text-sm">${label}</span>
        <select id="${id}" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]">
          ${select.map(o=>`<option value="${o.value}" ${String(value)===String(o.value)?'selected':''}>${o.label}</option>`).join('')}
        </select></label>`;}
      if(type==='textarea'){ return `<label class="block"><span class="text-sm">${label}</span>
        <textarea id="${id}" rows="${rows}" placeholder="${placeholder}" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]">${value||''}</textarea></label>`;}
      return `<label class="block"><span class="text-sm">${label}</span>
        <input id="${id}" type="${type}" value="${value}" placeholder="${placeholder}" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]"/></label>`;
    }
    function chips(name,arr,checked=[]){
      return `<div class="flex flex-wrap gap-2">${arr.map(v=>`
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)] cursor-pointer">
          <input type="checkbox" name="${name}" value="${v}" class="accent-violet-600" ${checked.includes(v)?'checked':''}/>
          <span class="text-sm">${v}</span></label>`).join('')}</div>`;
    }

    // ===== Steps (نفس الخطوات السابقة باختصار)
    function renderStep(){
      updateProgress(); updateButtons();
      const U=L[lang].ui;
      if(step===0){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[0]}</h3>
          <div class="grid md:grid-cols-3 gap-4">
            ${field(U.name,'name',{value:user.name})}
            ${field(U.gender,'gender',{select:[{value:'Male',label:U.male},{value:'Female',label:U.female}],value:user.gender})}
            ${field(U.age,'age',{type:'number',value:user.age})}
            ${field(U.height,'height',{type:'number',value:user.height})}
            ${field(U.weight,'weight',{type:'number',value:user.weight})}
            <label class="block md:col-span-2"><span class="text-sm">${U.job}</span>
              <select id="job" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]">
                ${U.jobVals.map((lbl,i)=>`<option ${i===1?'selected':''}>${lbl}</option>`).join('')}
              </select>
            </label>
            ${field(U.sleep,'sleep',{type:'number',value:user.sleep})}
            ${field(U.stress,'stress',{select:U.stressVals.map(v=>({value:v,label:v})),value:user.stress})}
            ${field(U.training_place,'training_place',{select:U.placeVals.map(v=>({value:v,label:v})),value:user.training_place})}
            ${field(U.equipment,'equipment',{placeholder:U.equipPH,value:user.equipment})}
          </div>`;
      } else if(step===1){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[1]}</h3>
          <div class="space-y-4">
            <div><div class="text-sm mb-1">${lang==='ar'?'الأهداف':'Goals'}</div>${chips('goal',['Fat loss','Muscle gain','Strength','Endurance','General health','خسارة الدهون','بناء العضلات','زيادة القوة','تحسين التحمل','صحة عامة'],user.goals)}</div>
            <div class="grid md:grid-cols-3 gap-4">
              ${field(U.meals,'meals',{select:[{value:3,label:'3'},{value:4,label:'4'},{value:5,label:'5'}],value:user.meals})}
              ${field(U.diet,'diet',{select:U.diets.map(d=>({value:d,label:d})),value:user.diet})}
              <label class="block">
                <span class="text-sm">${U.fasting} — ${U.enable}</span>
                <input id="fasting_enabled" type="checkbox" class="accent-violet-600 ml-2" ${user.fasting.enabled?'checked':''}/>
              </label>
            </div>
            <div id="ifWrap" class="grid md:grid-cols-3 gap-4">
              ${field(U.protocol,'fasting_protocol',{select:['14:10','16:8','18:6','20:4'].map(x=>({value:x,label:x})),value:user.fasting.protocol})}
              <label><span class="text-sm">${U.window} ${U.from}</span><input id="fasting_start" type="time" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]" value="${user.fasting.start}"/></label>
              <label><span class="text-sm">${U.window} ${U.to}</span><input id="fasting_end" type="time" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]" value="${user.fasting.end}"/></label>
            </div>
            ${field(U.dislikes,'dislikes',{placeholder:(lang==='ar'?'مثال: الكبدة، القرنبيط':'e.g., liver, cauliflower'),value:user.dislikes})}
          </div>`;
      } else if(step===2){
        const U=L[lang].ui;
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[2]}</h3>
          <div class="space-y-4">
            <div><div class="text-sm mb-1">${U.health}</div>${chips('health',U.healthVals,user.health)}</div>
            ${field(U.meds,'meds',{type:'textarea',rows:2,placeholder:'Metformin, Thyroxine…',value:user.meds})}
            <div><div class="text-sm mb-1">${U.allergies}</div>${chips('all',['Gluten','Lactose','Nuts','Seafood','Legumes','Added sugars','Vegetable oils','الجلوتين','اللاكتوز','المكسرات','المأكولات البحرية','البقوليات','السكريات المضافة','الزيوت النباتية'],user.allergies)}</div>
          </div>`;
      } else if(step===3){
        const U=L[lang].ui;
        content.innerHTML=`
          <h3 class="text-xl font-extrabول mb-3">${U.steps[3]}</h3>
          <div class="grid md:grid-cols-3 gap-4">
            ${field(U.exp,'exp',{select:U.expVals.map(x=>({value:x,label:x})),value:user.exp})}
            ${field(U.injuries,'injuries',{type:'textarea',rows:2,placeholder: lang==='ar'?'مثال: ألم أسفل الظهر':'e.g., Lower-back pain',value:user.injuries})}
            <label class="md:col-span-2"><span class="text-sm">${U.weak}</span>
              <input id="weak_raw" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]" placeholder="${U.weakPH}">
            </label>
          </div>`;
      } else {
        const msgN = L[lang].ui.buildingN;
        const msgT = L[lang].ui.buildingT;
        content.innerHTML=`
          <div class="space-y-6">
            <div class="text-center py-6 panel rounded-2xl">
              <div class="text-sm muted mb-2">${msgN}</div>
              <div class="w-10 h-10 rounded-full border-4 border-violet-600 border-t-transparent animate-spin mx-auto"></div>
              <div class="mt-2 text-xs muted">Nutrition…</div>
            </div>
            <div class="text-center py-6 panel rounded-2xl">
              <div class="text-sm muted mb-2">${msgT}</div>
              <div class="w-10 h-10 rounded-full border-4 border-cyan-500 border-t-transparent animate-spin mx-auto"></div>
              <div class="mt-2 text-xs muted">Training…</div>
            </div>
          </div>`;
      }
    }

    function saveStep(){
      try{
        if(step===0){
          user.name=$('name').value.trim(); user.gender=$('gender').value;
          user.age=+$('age').value; user.height=+$('height').value; user.weight=+$('weight').value;
          user.jobLabel=$('job').value; user.sleep=+$('sleep').value; user.stress=$('stress').value;
          user.training_place=$('training_place').value; user.equipment=$('equipment').value;
          if(!user.name||!user.age||!user.height||!user.weight) throw 0;
        } else if(step===1){
          user.goals=[...document.querySelectorAll('input[name="goal"]:checked')].map(e=>e.value);
          user.meals=+$('meals').value; user.diet=$('diet').value; user.dislikes=$('dislikes').value||'';
          user.fasting.enabled=$('fasting_enabled').checked;
          user.fasting.protocol=$('fasting_protocol').value; user.fasting.start=$('fasting_start').value; user.fasting.end=$('fasting_end').value;
          if(!user.goals.length) throw 0;
        } else if(step===2){
          user.health=[...document.querySelectorAll('input[name="health"]:checked')].map(e=>e.value);
          user.meds=$('meds').value||''; user.allergies=[...document.querySelectorAll('input[name="all"]:checked')].map(e=>e.value);
        } else if(step===3){
          user.exp=$('exp').value;
          const raw=$('weak_raw').value.trim(); user.weak_points={};
          if(raw){ raw.split(';').forEach(pair=>{ const [k,...r]=pair.split(':'); const v=r.join(':').trim(); if(k&&v) user.weak_points[k.trim()]=v; }); }
        }
        updateLive(); return true;
      }catch{ toast(L[lang].ui.err,'err'); return false; }
    }

    // ===== Prompt Builders (Nutrition / Training / Single Day)
    function baseHeader(){
      const c=calc();
      const locale=(lang==='ar'?'Arabic':'English');
      const diet=user.diet;
      const fasting=user.fasting.enabled? `${user.fasting.protocol} (${user.fasting.start}-${user.fasting.end})` : 'disabled';
      const goals=(user.goals||[]).join(', ') || (lang==='ar'?'غير محدد':'unspecified');
      return `
Return ${locale} **Markdown only**. Use executive structure, clear headings/tables, full details.
CLIENT PROFILE
- Name: ${user.name}
- Sex: ${user.gender}
- Age/Height/Weight: ${user.age}y / ${user.height}cm / ${user.weight}kg
- Daily Activity (PAL): ${user.jobLabel}
- Sleep: ${user.sleep}h, Stress: ${user.stress}
- Goals: ${goals}
- Diet style: ${diet}; Meals/day: ${user.meals}; IF: ${fasting}
- Training place: ${user.training_place}; Equipment: ${user.equipment||'—'}
- Experience: ${user.exp}; Injuries: ${user.injuries||'None'}
- Allergies: ${(user.allergies||[]).join(', ')||'None'}; Health: ${(user.health||[]).join(', ')||'None'}
- Dislikes: ${user.dislikes||'None'}
TARGETS (daily): ~${c.TDEE} kcal, ~${c.P} g protein, ~${c.F} g fat, ~${c.C} g carbs; tolerance ±2%.
Quality gate: If any day misses meals/macros or totals deviate > ±2%, REWRITE that day fully. No placeholders, no "repeat".
`.trim();
    }

    function nutritionPrompt(){
      const locale=(lang==='ar'?'Arabic':'English');
      return `
${baseHeader()}

=== TASK: 7-Day Nutrition Plan ONLY ===
1) Welcome & commitment (2 lines).
2) Allowed vs Avoid (tailored to ${user.diet}, allergies, dislikes).
3) Intermittent Fasting (if enabled): exact protocol, hydration, breaking-fast rules, meds note.
4) 7 FULL DAYS:
   - For each day: exactly ${user.meals} named meals.
   - Each meal: ingredients with quantities (g/ml) + per-meal macros (P/F/C/kcal).
   - End each day with Totals (within ±2%) and a compliance tip.
Formatting: headings (###), tables for meals. Food names in ${locale}.
`.trim();
    }

    function trainingPrompt(){
      return `
${baseHeader()}

=== TASK: 7-Day Training Plan ONLY ===
- Tailored to ${user.exp} at ${user.training_place}; avoid aggravating: ${user.injuries||'None'}.
- For each of 7 days: table with columns: Exercise (English) • Sets • Reps • Tempo • Rest (s) • Notes (cues/progression).
- Include "Progression & Check-ins", "Troubleshooting & Implementation Checklist", "Safety & FAQs", and a short professional closing.
Formatting: headings (###), tables for sessions. Exercises in English only.
`.trim();
    }

    function singleDayPrompt(section, day){
      const c=calc();
      const locale=(lang==='ar'?'Arabic':'English');
      if(section==='nutrition'){
        return `
${baseHeader()}

=== TASK: Regenerate Day ${day} — Nutrition ONLY ===
- Write Day ${day} meals (exactly ${user.meals}) with ingredients, quantities (g/ml), and per-meal macros.
- Provide end-of-day Totals that match targets (~${c.TDEE} kcal; P ${c.P} g; F ${c.F} g; C ${c.C} g) within ±2%.
- Respect ${user.diet}, allergies, dislikes, and IF (${user.fasting.enabled ? user.fasting.protocol : 'disabled'}).
- Output only Day ${day} with its table and compliance tip (no other days).
Food names in ${locale}.
`.trim();
      } else {
        return `
${baseHeader()}

=== TASK: Regenerate Day ${day} — Training ONLY ===
- Day ${day}: table with Exercise (English) • Sets • Reps • Tempo • Rest (s) • Notes (cues/progression).
- Tailored to ${user.exp} at ${user.training_place}; avoid: ${user.injuries||'None'}.
- Output only Day ${day} session (no other days).
`.trim();
      }
    }

    // ===== AI Call
    async function callAI(prompt, section, maxTokens=8192){
      try{
        const r = await fetch('/.netlify/functions/gemini-proxy',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ prompt, section, locale:(lang==='ar'?'ar':'en'), maxTokens })
        });
        if(!r.ok){ throw new Error(await r.text()); }
        const data = await r.json();
        return data?.text || '';
      }catch(e){
        console.error('AI error:', e);
        return '';
      }
    }

    function renderMD(targetId, md){
      if(!md){ html(targetId,''); return; }
      if(window.marked && !window.__NO_MARKED__){
        const raw=window.marked.parse(md);
        if(window.DOMPurify && !window.__NO_PURIFY__){
          $(targetId).innerHTML = window.DOMPurify.sanitize(raw);
        } else { $(targetId).innerHTML = raw; }
      } else { $(targetId).textContent = md; }
    }

    // ===== Generation Flow (Sequential)
    async function generateNutrition(){
      $('result').classList.remove('hidden');
      renderMD('ai-nutrition', `
<div class="text-center py-8">
  <div class="w-10 h-10 rounded-full border-4 border-violet-600 border-t-transparent animate-spin mx-auto"></div>
  <div class="mt-2 text-sm muted">${L[lang].ui.buildingN}</div>
</div>`);
      const md = await callAI(nutritionPrompt(), 'nutrition', 9000);
      if(!md){ renderMD('ai-nutrition', `<div class="p-4 panel rounded-xl text-sm">${L[lang].ui.apiFail}</div>`); return ''; }
      renderMD('ai-nutrition', md);
      return md;
    }

    async function generateTraining(){
      renderMD('ai-training', `
<div class="text-center py-8">
  <div class="w-10 h-10 rounded-full border-4 border-cyan-500 border-t-transparent animate-spin mx-auto"></div>
  <div class="mt-2 text-sm muted">${L[lang].ui.buildingT}</div>
</div>`);
      const md = await callAI(trainingPrompt(), 'training', 9000);
      if(!md){ renderMD('ai-training', `<div class="p-4 panel rounded-xl text-sm">${L[lang].ui.apiFail}</div>`); return ''; }
      renderMD('ai-training', md);
      return md;
    }

    // ===== Re-generation helpers (Quality Gate manual fix)
    function extractDayBlock(md, dayLabel){
      if(!md) return '';
      const lines = md.split('\n');
      const startIdx = lines.findIndex(l => new RegExp(`(Day\\s*${dayLabel}|اليوم\\s*${dayLabel})`, 'i').test(l));
      if(startIdx < 0) return '';
      let endIdx = lines.length;
      for(let i = startIdx+1; i < lines.length; i++){
        if(/^(###|##)\s/.test(lines[i]) || /(Day\s*\d+|اليوم\s*\d+)/i.test(lines[i])){ endIdx = i; break; }
      }
      return lines.slice(startIdx, endIdx).join('\n').trim();
    }

    async function regenDay(section){
      const ask = prompt(L[lang].ui.regenDay);
      const day = Number(ask);
      if(!(day>=1 && day<=7)){ toast(lang==='ar'?'رقم اليوم غير صالح':'Invalid day','err'); return; }
      const md = await callAI(singleDayPrompt(section, day), section, 4000);
      if(!md){ toast(L[lang].ui.apiFail,'err'); return; }
      // دمج اليوم في مكانه
      const targetId = (section==='nutrition'?'ai-nutrition':'ai-training');
      const current = $(targetId).innerText || '';
      const oldBlock = extractDayBlock(current, day);
      let merged;
      if(oldBlock){
        merged = current.replace(oldBlock, md);
      }else{
        merged = current + '\n\n' + md;
      }
      renderMD(targetId, merged);
      toast(lang==='ar'?'تم تحديث اليوم':'Day updated','ok');
    }

    async function regenSection(){
      const ask = prompt(L[lang].ui.regenSec + ' (nutrition/training)');
      const key = (ask||'').toLowerCase().trim();
      if(!['nutrition','training'].includes(key)){ toast('Invalid section','err'); return; }
      if(key==='nutrition'){ await generateNutrition(); } else { await generateTraining(); }
      toast(lang==='ar'?'تم تحديث القسم':'Section updated','ok');
    }

    // ===== Buttons & Navigation
    function applyLang(l){
      lang=l; document.documentElement.lang=l; document.documentElement.dir=(l==='ar'?'rtl':'ltr');
      document.body.classList.toggle('font-ar',l==='ar'); document.body.classList.toggle('font-en',l!=='ar');
      $('lang-badge').textContent=l.toUpperCase();
      $('hero-title').textContent=L[l].ui.title;
      $('live-title').textContent=L[l].ui.live;
      $('plan-title').textContent=(l==='ar'?L.ar.ui.resultTitle:L.en.ui.resultTitle);
      text('rights', L[l].ui.rights);
      renderStep(); updateLive(); updateKPIs(); updateButtons();
    }

    function updateButtons(){ $('btn-prev').disabled=(step===0); $('btn-next').textContent=(step===total-1?L[lang].ui.submit:L[lang].ui.next); }
    $('btn-prev').onclick=()=>{ if(step>0){ step--; renderStep(); updateKPIs(); updateLive(); } };
    $('btn-next').onclick=async ()=>{
      if(step<total-1){
        if(!saveStep()) return;
        step++; renderStep(); updateKPIs(); updateLive();
        if(step===total-1){
          $('result').classList.remove('hidden');
          await generateNutrition();     // أولًا التغذية
          await generateTraining();      // ثم التدريب
          $('result').scrollIntoView({behavior:'smooth',block:'start'});
        }
      }
    };

    // Result actions
    $('act-new').onclick=()=>location.reload();
    $('act-print').onclick=()=>window.print();
    $('act-pdf').onclick=()=>{
      if(window.html2pdf && !window.__NO_PDF__){
        const opt={ margin:10, filename:(lang==='ar'?'خطة-':'plan-')+(user.name||'client')+'.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
        window.html2pdf().from($('resultRoot')).set(opt).save();
      } else { toast(lang==='ar'?'تعذر حفظ PDF — استخدم الطباعة':'PDF unavailable — use print','warn'); window.print(); }
    };

    // Regen buttons
    $('btn-regen-day').onclick=()=>regenDay(confirm(lang==='ar'?'هل تريد إعادة توليد يوم من التغذية؟ اضغط "إلغاء" للتدريب.':'Regenerate nutrition day? Click "Cancel" for training.')
      ? 'nutrition' : 'training');
    $('btn-regen-sec').onclick=regenSection;

    // Header language buttons
    $('btn-lang-ar').onclick=()=>applyLang('ar');
    $('btn-lang-en').onclick=()=>applyLang('en');

    // ===== Init
    applyLang('ar');
  })();
  </script>

  <!-- Footer -->
  <footer class="max-w-7xl mx-auto px-4 sm:px-6 mt-8 mb-10 text-center text-[12px] muted no-print">
    Powered by Mustafa Elsafy 2025
  </footer>
</body>
</html>
