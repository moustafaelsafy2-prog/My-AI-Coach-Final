<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ | Intelligent Health Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      --bg:#0b1220; --card:#ffffff; --ink:#0f172a; --ink-2:#334155; --brand:#4f46e5; --brand-2:#22c55e;
      --muted:#64748b; --surface:#f8fafc;
    }
    html,body{height:100%}
    body{background:linear-gradient(180deg,#f6f7fb,#eef1f7)}
    .card{background:var(--card)}
    .title{letter-spacing:.2px}
    .rtl *{direction:rtl}
    .ltr *{direction:ltr}
    .step-bullet{width:28px;height:28px}
    .badge{font-variant-numeric: tabular-nums}
    .overlay{backdrop-filter: blur(6px)}
    .ring-brand{box-shadow: 0 0 0 3px #e0e7ff inset}
    .ai h2{font-size:1.25rem;font-weight:800;margin-top:1.25rem;color:#111827}
    .ai h3{font-size:1.1rem;font-weight:700;margin-top:.75rem;color:#1f2937}
    .ai table{width:100%;border-collapse:collapse;border:1px solid #e5e7eb;margin:12px 0;border-radius:8px;overflow:hidden}
    .ai th,.ai td{border:1px solid #e5e7eb;padding:.6rem;vertical-align:top}
    .ai th{background:#f8fafc}
    @media (prefers-color-scheme: dark){
      :root{--card:#0f172a; --ink:#e5e7eb; --ink-2:#94a3b8; --surface:#0b1220}
      body{background:#0b1220}
      .ai th{background:#0b1220}
      .ai th,.ai td{border-color:#1f2937}
    }
    @media print{
      #toolbar,#wizard,#actions,.no-print{display:none !important}
      body{background:white}
      #plan{box-shadow:none}
    }
  </style>
</head>
<body class="min-h-screen text-slate-800">

<!-- Toolbar -->
<header id="toolbar" class="sticky top-0 z-20 bg-white/85 backdrop-blur border-b">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-indigo-600 text-white grid place-items-center font-black">AI</div>
      <div>
        <div class="title font-extrabold" id="brandTitle">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ</div>
        <div class="text-xs text-slate-500" id="brandSub">Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© 100% Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€“ Ù…Ø®ØµØµØ© Ù„Ùƒ</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnAr" class="px-3 py-1.5 rounded-md text-sm font-bold bg-indigo-600 text-white">Ø¹Ø±Ø¨ÙŠ</button>
      <button id="btnEn" class="px-3 py-1.5 rounded-md text-sm font-bold bg-slate-100">EN</button>
      <button id="theme" class="ml-2 px-3 py-1.5 text-sm rounded-md border">â˜€ï¸/ğŸŒ™</button>
    </div>
  </div>
</header>

<!-- Container -->
<main class="max-w-6xl mx-auto px-4 pb-24">

  <!-- Intro -->
  <section class="mt-6 card rounded-2xl shadow border p-5">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 id="heroTitle" class="title text-2xl sm:text-3xl font-black text-slate-900">Ù„Ù†ÙÙ†Ø´Ø¦ Ø£ÙØ¶Ù„ Ø®Ø·Ø© Ù…ÙÙ…ÙƒÙ†Ø© Ù„Ù‡Ø¯ÙÙƒ</h1>
        <p id="heroSub" class="mt-1 text-sm text-slate-500">
          Ø³Ù†ÙÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø®Ø·Ø© Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù…: ØªØ±Ø­ÙŠØ¨ â†’ ØªØ­Ù„ÙŠÙ„ â†’ Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹ â†’ Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹ (Ø¥Ù† Ù„Ø²Ù…) â†’
          Ø§Ù„ØªØºØ°ÙŠØ© ÙŠÙˆÙ…Ù‹Ø§ Ø¨ÙŠÙˆÙ… (7) â†’ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙŠÙˆÙ…Ù‹Ø§ Ø¨ÙŠÙˆÙ… (7) â†’ Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â†’ Ø§Ù„ØªÙ‚Ø¯Ù… â†’ Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø§Øª â†’ Ø§Ù„Ø³Ù„Ø§Ù…Ø© â†’ Ø®Ø§ØªÙ…Ø©.
        </p>
        <div id="status" class="mt-2 text-xs text-slate-400">Ø¬Ø§Ù‡Ø²</div>
      </div>
      <button id="startTop" class="hidden sm:block px-4 h-10 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold">
        <span id="startLabel">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙˆÙ„ÙŠØ¯</span>
      </button>
    </div>
  </section>

  <!-- Wizard -->
  <section id="wizard" class="mt-6 grid lg:grid-cols-3 gap-5">

    <!-- Column 1 : Profile -->
    <div class="card rounded-2xl shadow border p-5" id="colProfile">
      <h2 class="title text-lg font-extrabold mb-4 flex items-center gap-2">
        <span class="w-1.5 h-5 rounded bg-indigo-600"></span><span id="secProfile">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
      </h2>

      <div class="grid grid-cols-2 gap-3">
        <label class="col-span-2">
          <span id="lblName" class="text-sm font-medium">Ø§Ù„Ø§Ø³Ù…</span>
          <input id="name" class="mt-1 w-full rounded-md border p-2"/>
        </label>

        <label>
          <span id="lblAge" class="text-sm font-medium">Ø§Ù„Ø¹Ù…Ø±</span>
          <input id="age" type="number" inputmode="numeric" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblHeight" class="text-sm font-medium">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</span>
          <input id="height" type="number" class="mt-1 w-full rounded-md border p-2"/>
        </label>

        <label>
          <span id="lblWeight" class="text-sm font-medium">Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</span>
          <input id="weight" type="number" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblBf" class="text-sm font-medium">% Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
          <input id="bodyfat" type="number" class="mt-1 w-full rounded-md border p-2"/>
        </label>

        <label>
          <span id="lblWaist" class="text-sm font-medium">Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ± (Ø³Ù…) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
          <input id="waist" type="number" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblSex" class="text-sm font-medium">Ø§Ù„Ø¬Ù†Ø³</span>
          <select id="sex" class="mt-1 w-full rounded-md border p-2">
            <option value="Male">Ø°ÙƒØ±</option>
            <option value="Female">Ø£Ù†Ø«Ù‰</option>
          </select>
        </label>

        <label>
          <span id="lblTargetW" class="text-sm font-medium">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (ÙƒØº) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
          <input id="targetWeight" type="number" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblTargetD" class="text-sm font-medium">ØªØ§Ø±ÙŠØ® ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
          <input id="targetDate" type="date" class="mt-1 w-full rounded-md border p-2"/>
        </label>
      </div>
    </div>

    <!-- Column 2 : Diet & Prefs -->
    <div class="card rounded-2xl shadow border p-5" id="colDiet">
      <h2 class="title text-lg font-extrabold mb-4 flex items-center gap-2">
        <span class="w-1.5 h-5 rounded bg-indigo-600"></span><span id="secDiet">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª</span>
      </h2>

      <div class="grid grid-cols-2 gap-3">
        <fieldset class="col-span-2">
          <legend id="lblGoals" class="text-sm font-medium mb-1">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ù…ØªØ¹Ø¯Ø¯)</legend>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2"><input type="checkbox" value="Fat Loss" class="goal"/> <span id="g1">Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" value="Build Muscle" class="goal"/> <span id="g2">Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" value="Strength" class="goal"/> <span id="g3">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" value="Endurance" class="goal"/> <span id="g4">ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" value="General Health" class="goal"/> <span id="g5">ØµØ­Ø© Ø¹Ø§Ù…Ø©</span></label>
          </div>
        </fieldset>

        <label>
          <span id="lblMeals" class="text-sm font-medium">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª/Ø§Ù„ÙŠÙˆÙ…</span>
          <input id="meals" type="number" min="2" max="7" value="3" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblDietType" class="text-sm font-medium">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù„</span>
          <select id="dietType" class="mt-1 w-full rounded-md border p-2">
            <option value="Balanced">Balanced</option>
            <option value="Low carb">Low carb</option>
            <option value="Mediterranean">Mediterranean</option>
            <option value="Keto">Keto</option>
            <option value="Plant-based">Plant-based</option>
          </select>
        </label>

        <label>
          <span id="lblFasting" class="text-sm font-medium">Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹</span>
          <select id="fasting" class="mt-1 w-full rounded-md border p-2">
            <option value="None">ØºÙŠØ± Ù…ÙÙØ¹Ù„</option>
            <option value="16:8">16:8</option>
            <option value="18:6">18:6</option>
            <option value="20:4">20:4</option>
          </select>
        </label>

        <label>
          <span id="lblCuisine" class="text-sm font-medium">Ø§Ù„Ù…Ø·Ø¨Ø® Ø§Ù„Ù…ÙØ¶Ù„</span>
          <select id="cuisine" class="mt-1 w-full rounded-md border p-2">
            <option value="Arabic/Mediterr.">Arabic/Mediterr.</option>
            <option value="Asian">Asian</option>
            <option value="Western">Western</option>
            <option value="Indian">Indian</option>
          </select>
        </label>

        <label>
          <span id="lblPrep" class="text-sm font-medium">Ø²Ù…Ù† Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø¯)</span>
          <input id="prep" type="number" value="20" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblBudget" class="text-sm font-medium">Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø´Ù‡Ø±ÙŠØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©</span>
          <div class="relative">
            <input id="budget" type="number" value="0" class="mt-1 w-full rounded-md border p-2 pr-12"/>
            <span id="currency" class="absolute right-3 top-2.5 text-slate-500">USD</span>
          </div>
          <small id="budgetHelp" class="text-slate-400 text-xs">Ø³Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†.</small>
        </label>

        <label class="col-span-2">
          <span id="lblAvoid" class="text-sm font-medium">Ø£Ø·Ø¹Ù…Ø© Ù„Ø§ ØªØ±ØºØ¨ Ø¨Ù‡Ø§/Ø­Ø³Ø§Ø³ÙŠØ§Øª</span>
          <input id="avoid" class="mt-1 w-full rounded-md border p-2" placeholder="Gluten, lactose, seafoodâ€¦"/>
        </label>
      </div>

      <div class="mt-4">
        <h3 class="font-bold text-slate-700 mb-2" id="musclesTitle">Ø¹Ø¶Ù„Ø§Øª ØªØ­ØªØ§Ø¬ Ø¹Ù†Ø§ÙŠØ© Ø®Ø§ØµØ©</h3>
        <div class="grid md:grid-cols-2 gap-3" id="musclesWrap"></div>
      </div>

      <div class="mt-4">
        <h3 class="font-bold text-slate-700 mb-2" id="challengeTitle">ØªØ­Ø¯ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©</h3>
        <textarea id="pastChallenges" rows="2" class="w-full rounded-md border p-2" placeholder="Ø¬ÙˆØ¹ Ø´Ø¯ÙŠØ¯ØŒ Ù…Ù„Ù„ Ù…Ù† Ø§Ù„Ø·Ø¹Ø§Ù…ØŒ Ø¥ØµØ§Ø¨Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†â€¦"></textarea>
      </div>

      <div class="mt-4">
        <h3 class="font-bold text-slate-700 mb-2" id="motivationTitle">Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØ­ÙÙŠØ² Ø§Ù„Ù…ÙØ¶Ù„</h3>
        <select id="motivation" class="w-full rounded-md border p-2">
          <option value="Direct and firm">Ø­Ø§Ø²Ù… ÙˆÙ…Ø¨Ø§Ø´Ø±</option>
          <option value="Positive and supportive">ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…</option>
          <option value="Minimal check-ins">Ù…ØªØ§Ø¨Ø¹Ø© Ø®ÙÙŠÙØ©</option>
        </select>
      </div>

    </div>

    <!-- Column 3 : Lifestyle/Medical/Fitness -->
    <div class="card rounded-2xl shadow border p-5" id="colLifestyle">
      <h2 class="title text-lg font-extrabold mb-4 flex items-center gap-2">
        <span class="w-1.5 h-5 rounded bg-indigo-600"></span><span id="secLifestyle">Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨</span>
      </h2>

      <div class="grid grid-cols-2 gap-3">
        <label>
          <span id="lblWork" class="text-sm font-medium">Ø§Ù„Ø¹Ù…Ù„/Ø§Ù„Ù†Ø´Ø§Ø·</span>
          <select id="work" class="mt-1 w-full rounded-md border p-2">
            <option value="Sedentary">Ù…ÙƒØªØ¨ÙŠ</option>
            <option value="Light">Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ</option>
            <option value="Moderate">Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·</option>
            <option value="Heavy">Ù†Ø´Ø§Ø· Ø¨Ø¯Ù†ÙŠ Ø«Ù‚ÙŠÙ„</option>
          </select>
        </label>
        <label>
          <span id="lblSteps" class="text-sm font-medium">Ø®Ø·ÙˆØ§Øª/Ø§Ù„ÙŠÙˆÙ…</span>
          <input id="steps" type="number" value="6000" class="mt-1 w-full rounded-md border p-2"/>
        </label>

        <label>
          <span id="lblSleep" class="text-sm font-medium">Ø§Ù„Ù†ÙˆÙ… (Ø³)</span>
          <select id="sleep" class="mt-1 w-full rounded-md border p-2">
            <option value="Low">Ù…Ù†Ø®ÙØ¶</option>
            <option value="Moderate">Ù…ØªÙˆØ³Ø·</option>
            <option value="High">Ø¬ÙŠØ¯</option>
          </select>
        </label>
        <label>
          <span id="lblStress" class="text-sm font-medium">Ø§Ù„ØªÙˆØªØ±</span>
          <select id="stress" class="mt-1 w-full rounded-md border p-2">
            <option value="Low">Ù…Ù†Ø®ÙØ¶</option>
            <option value="Moderate">Ù…ØªÙˆØ³Ø·</option>
            <option value="High">Ù…Ø±ØªÙØ¹</option>
          </select>
        </label>

        <label>
          <span id="lblPlace" class="text-sm font-medium">Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨</span>
          <select id="place" class="mt-1 w-full rounded-md border p-2">
            <option value="Gym">Ù†Ø§Ø¯ÙŠ</option>
            <option value="Home">Ù…Ù†Ø²Ù„</option>
            <option value="Outdoor">Ø®Ø§Ø±Ø¬ÙŠ</option>
          </select>
        </label>
        <label>
          <span id="lblLength" class="text-sm font-medium">Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯)</span>
          <input id="session" type="number" value="60" class="mt-1 w-full rounded-md border p-2"/>
        </label>

        <fieldset class="col-span-2">
          <legend id="fitTitle" class="text-sm font-bold mb-1">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ù…Ø¨Ø³Ø·</legend>
          <div class="grid grid-cols-2 gap-3">
            <label>
              <span id="lblRhr" class="text-sm font-medium">Resting HR (bpm)</span>
              <input id="rhr" type="number" class="mt-1 w-full rounded-md border p-2"/>
            </label>
            <label>
              <span id="lblPush" class="text-sm font-medium">Push-ups (max)</span>
              <input id="pushups" type="number" class="mt-1 w-full rounded-md border p-2"/>
            </label>
            <label>
              <span id="lblPlank" class="text-sm font-medium">Plank (s)</span>
              <input id="plank" type="number" class="mt-1 w-full rounded-md border p-2"/>
            </label>
            <label>
              <span id="lblKm" class="text-sm font-medium">1 ÙƒÙ… (Ø¯:Ø«)</span>
              <input id="kmTime" class="mt-1 w-full rounded-md border p-2" placeholder="6:30"/>
            </label>
          </div>
        </fieldset>

        <fieldset class="col-span-2">
          <legend id="lblDays" class="text-sm font-medium mb-1">Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©</legend>
          <div id="days" class="flex flex-wrap gap-3"></div>
        </fieldset>

        <label class="col-span-2">
          <span id="lblEquip" class="text-sm font-medium">Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</span>
          <input id="equipment" class="mt-1 w-full rounded-md border p-2" placeholder="Ø¨Ø§Ø±ØŒ Ø¯Ù…Ø¨Ù„ØŒ Ø£Ø¬Ù‡Ø²Ø©â€¦"/>
        </label>

        <label>
          <span id="lblExp" class="text-sm font-medium">Ø§Ù„Ø®Ø¨Ø±Ø©</span>
          <select id="experience" class="mt-1 w-full rounded-md border p-2">
            <option value="Beginner (0-6m)">Ù…Ø¨ØªØ¯Ø¦ (0-6 Ø£Ø´Ù‡Ø±)</option>
            <option value="Intermediate (6-24m)">Ù…ØªÙˆØ³Ø· (6-24 Ø´Ù‡Ø±)</option>
            <option value="Advanced (24m+)">Ù…ØªÙ‚Ø¯Ù… (Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†ØªÙŠÙ†)</option>
          </select>
        </label>
        <label>
          <span id="lblRpe" class="text-sm font-medium">RPE</span>
          <input id="rpe" type="number" value="8" class="mt-1 w-full rounded-md border p-2"/>
        </label>

        <label>
          <span id="lblCaffeine" class="text-sm font-medium">ÙƒØ§ÙÙŠÙŠÙ†/ÙŠÙˆÙ… (Ø£ÙƒÙˆØ§Ø¨)</span>
          <input id="caffeine" type="number" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label>
          <span id="lblInjury" class="text-sm font-medium">Ø¥ØµØ§Ø¨Ø§Øª/Ù‚ÙŠÙˆØ¯</span>
          <input id="injuries" class="mt-1 w-full rounded-md border p-2"/>
        </label>
      </div>

      <div class="mt-5">
        <h2 class="title text-lg font-extrabold mb-3 flex items-center gap-2">
          <span class="w-1.5 h-5 rounded bg-indigo-600"></span><span id="secMedical">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©</span>
        </h2>
        <div id="medicalWrap" class="grid md:grid-cols-2 gap-2"></div>

        <label class="mt-3 block">
          <span id="lblOtherCond" class="text-sm font-medium">Ø£Ù…Ø±Ø§Ø¶/Ø­Ø§Ù„Ø§Øª Ø£Ø®Ø±Ù‰</span>
          <input id="otherCond" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label class="mt-2 block">
          <span id="lblMeds" class="text-sm font-medium">Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ©</span>
          <input id="meds" class="mt-1 w-full rounded-md border p-2"/>
        </label>
        <label class="mt-2 block">
          <span id="lblSupps" class="text-sm font-medium">Ù…ÙƒÙ…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ©</span>
          <input id="supps" class="mt-1 w-full rounded-md border p-2"/>
        </label>
      </div>
    </div>
  </section>

  <!-- Actions -->
  <section id="actions" class="mt-4 flex flex-wrap gap-3 justify-between items-center">
    <div class="text-xs text-slate-500" id="guardMsg">
      Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Â«ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©Â»ØŒ Ø³Ù†ÙÙ†Ø´Ø¦ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙƒØªÙ…Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.
    </div>
    <div class="flex gap-2 w-full sm:w-auto">
      <button id="generate" class="flex-1 sm:flex-none bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold px-5 py-2 rounded-lg">
        <span id="genLabel">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©</span>
      </button>
      <button id="print" class="px-4 py-2 rounded-lg border">Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
  </section>

  <!-- Plan -->
  <section id="plan" class="mt-6 card rounded-2xl shadow border p-5 ai"></section>
</main>

<!-- Loading Overlay -->
<div id="overlay" class="hidden fixed inset-0 z-30 grid place-items-center bg-black/30 overlay">
  <div class="bg-white/95 rounded-2xl p-6 w-[min(92vw,520px)] text-center shadow-xl border">
    <div class="mx-auto w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
    <h3 id="ovTitle" class="mt-4 font-extrabold">Ù†Ø¬Ù‡Ù‘Ø² Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†</h3>
    <p id="ovMsg" class="text-sm text-slate-600 mt-1">
      Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±Ø› Ø³Ù†ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø®Ø·Ø© Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù… (ØªØ­Ù„ÙŠÙ„ØŒ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹ØŒ Ø§Ù„ØµÙŠØ§Ù…ØŒ Ø§Ù„ØªØºØ°ÙŠØ© 7 Ø£ÙŠØ§Ù…ØŒ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ 7 Ø£ÙŠØ§Ù…ØŒ Ø§Ù„Ù…ÙƒÙ…Ù„Ø§ØªØŒ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…ØŒ Ø§Ù„Ø³Ù„Ø§Ù…Ø©ØŒ Ø§Ù„Ø®Ø§ØªÙ…Ø©)â€¦
    </p>
    <div class="mt-3 text-xs text-slate-500" id="progressTxt">0%</div>
  </div>
</div>

<script>
/* ============================ Internationalization ============================ */
const i18n = {
  ar: {
    dir:'rtl', name:'Ø§Ù„Ø§Ø³Ù…', age:'Ø§Ù„Ø¹Ù…Ø±', height:'Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)', weight:'Ø§Ù„ÙˆØ²Ù† (ÙƒØº)',
    bodyfat:'% Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', waist:'Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ± (Ø³Ù…) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', sex:'Ø§Ù„Ø¬Ù†Ø³',
    targetW:'Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (ÙƒØº) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', targetD:'ØªØ§Ø±ÙŠØ® ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
    goals:'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ù…ØªØ¹Ø¯Ø¯)', meals:'Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª/Ø§Ù„ÙŠÙˆÙ…', dietType:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù„',
    fasting:'Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹', cuisine:'Ø§Ù„Ù…Ø·Ø¨Ø® Ø§Ù„Ù…ÙØ¶Ù„', prep:'Ø²Ù…Ù† Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø¯)',
    budget:'Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø´Ù‡Ø±ÙŠØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©', avoid:'Ø£Ø·Ø¹Ù…Ø© Ù„Ø§ ØªØ±ØºØ¨ Ø¨Ù‡Ø§/Ø­Ø³Ø§Ø³ÙŠØ§Øª',
    muscles:'Ø¹Ø¶Ù„Ø§Øª ØªØ­ØªØ§Ø¬ Ø¹Ù†Ø§ÙŠØ© Ø®Ø§ØµØ©', issue:'ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©/Ø§Ù„Ø³Ø¨Ø¨',
    past:'ØªØ­Ø¯ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©', motivation:'Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØ­ÙÙŠØ² Ø§Ù„Ù…ÙØ¶Ù„',
    work:'Ø§Ù„Ø¹Ù…Ù„/Ø§Ù„Ù†Ø´Ø§Ø·', steps:'Ø®Ø·ÙˆØ§Øª/Ø§Ù„ÙŠÙˆÙ…', sleep:'Ø§Ù„Ù†ÙˆÙ… (Ø³)', stress:'Ø§Ù„ØªÙˆØªØ±',
    place:'Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨', session:'Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯)', fitness:'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ù…Ø¨Ø³Ø·',
    rhr:'Resting HR (bpm)', push:'Push-ups (max)', plank:'Plank (s)', km:'1 ÙƒÙ… (Ø¯:Ø«)',
    days:'Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©', equip:'Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©', exp:'Ø§Ù„Ø®Ø¨Ø±Ø©', rpe:'RPE',
    caffeine:'ÙƒØ§ÙÙŠÙŠÙ†/ÙŠÙˆÙ… (Ø£ÙƒÙˆØ§Ø¨)', injuries:'Ø¥ØµØ§Ø¨Ø§Øª/Ù‚ÙŠÙˆØ¯',
    medical:'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©', condOther:'Ø£Ù…Ø±Ø§Ø¶/Ø­Ø§Ù„Ø§Øª Ø£Ø®Ø±Ù‰', meds:'Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ©', supps:'Ù…ÙƒÙ…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ©',
    profile:'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', diet:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª', lifestyle:'Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨',
    brand:'Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ', brandSub:'Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© 100% Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€“ Ù…Ø®ØµØµØ© Ù„Ùƒ',
    start:'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙˆÙ„ÙŠØ¯', gen:'ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©', print:'Ø·Ø¨Ø§Ø¹Ø©',
    ready:'Ø¬Ø§Ù‡Ø²', waitTitle:'Ù†Ø¬Ù‡Ù‘Ø² Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†', waitMsg:'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±Ø› Ø³Ù†ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø®Ø·Ø© Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù…â€¦',
    musclesList:['Ø§Ù„ØµØ¯Ø±','Ø§Ù„Ø¸Ù‡Ø±','Ø§Ù„Ø£ÙƒØªØ§Ù','Ø§Ù„Ø¨Ø§ÙŠØ³Ø¨Ø³','Ø§Ù„ØªØ±Ø§ÙŠØ³Ø¨Ø³','Ø§Ù„Ø£Ø±Ø¬Ù„ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©','Ø§Ù„Ø£Ø±Ø¬Ù„ Ø§Ù„Ø®Ù„ÙÙŠØ©','Ø§Ù„Ù…Ø¤Ø®Ø±Ø©','Ø§Ù„Ø³Ù…Ø§Ù†Ø©','Ø§Ù„Ø¨Ø·Ù†'],
    medicalList:[
      'Ø¶ØºØ· Ø§Ù„Ø¯Ù…','Ø§Ù„Ø³ÙƒØ±ÙŠ','Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†','Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØºØ¯Ø©','Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ',
      'Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙØ§ØµÙ„/Ø§Ù„Ø±ÙƒØ¨Ø©','Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨','Ù‚Ø±Ø­Ø©/Ù‚ÙˆÙ„ÙˆÙ†','Ø§Ø±ØªØ¬Ø§Ø¹/Ø­Ø±Ù‚Ø©','Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†','Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²'
    ],
    stepsNav:['Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ','Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª','Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©','Ø§Ù„ØµØ­Ø©','Ø§Ù„Ø¹Ø¶Ù„Ø§Øª','Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª/Ø§Ù„ØªØ­ÙÙŠØ²'],
    welcomeTitle:(n)=>`Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙŠØ§ ${n} ğŸ‘‹`,
    welcomeBody:`ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ Ø¹Ù„Ù‰ Ø¨Ø¯Ø¡ Ø±Ø­Ù„ØªÙƒ! Ø³Ù†Ø¨Ù†ÙŠ Ø®Ø·Ø© Ø´Ø§Ù…Ù„Ø© Ø¯Ù‚ÙŠÙ‚Ø©ØŒ Ù…ØµÙ…Ù…Ø© Ù„Ùƒ 100Ùª.`,
    sectionDone:(t)=>`âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù‚Ø³Ù…: ${t}`
  },
  en: {
    dir:'ltr', name:'Name', age:'Age', height:'Height (cm)', weight:'Weight (kg)',
    bodyfat:'Body fat % (optional)', waist:'Waist (cm) (optional)', sex:'Sex',
    targetW:'Target weight (kg) (optional)', targetD:'Target date (optional)',
    goals:'Goals (multi-select)', meals:'Meals per day', dietType:'Preferred diet',
    fasting:'Intermittent fasting', cuisine:'Cuisine', prep:'Prep time (min)',
    budget:'Monthly budget', avoid:'Foods to avoid / allergies',
    muscles:'Muscles needing special focus', issue:'Describe the issue/reason',
    past:'Past challenges with plans', motivation:'Preferred motivation style',
    work:'Work/activity', steps:'Steps/day', sleep:'Sleep (hr)', stress:'Stress',
    place:'Training place', session:'Session length (min)', fitness:'Quick fitness test',
    rhr:'Resting HR (bpm)', push:'Max push-ups', plank:'Plank (s)', km:'1 km time (m:s)',
    days:'Available training days', equip:'Available equipment', exp:'Experience', rpe:'RPE',
    caffeine:'Caffeine/day (cups)', injuries:'Injuries/constraints',
    medical:'Medical status', condOther:'Other conditions', meds:'Current medications', supps:'Current supplements',
    profile:'Profile', diet:'Diet & Preferences', lifestyle:'Lifestyle & Training',
    brand:'Intelligent Health Coach', brandSub:'100% precise plan for nutrition, training and supplements â€“ fully personalized',
    start:'Generate Plan', gen:'Generate Plan', print:'Print',
    ready:'Ready', waitTitle:'Preparing your plan', waitMsg:'Please wait while we generate the plan section-by-sectionâ€¦',
    musclesList:['Chest','Back','Shoulders','Biceps','Triceps','Quads','Hamstrings','Glutes','Calves','Abs'],
    medicalList:[
      'Hypertension','Diabetes','Insulin Resistance','Thyroid issues','Fatty Liver',
      'Joint/Knee problems','Heart disease','IBD/Ulcer','GERD/Reflux','Gluten intolerance','Lactose intolerance'
    ],
    stepsNav:['Profile','Preferences','Lifestyle','Medical','Muscles','Challenges/Motivation'],
    welcomeTitle:(n)=>`Welcome ${n} ğŸ‘‹`,
    welcomeBody:`Congrats on taking action! Weâ€™ll build a precise, fully personalized plan.`,
    sectionDone:(t)=>`âœ… Section generated: ${t}`
  }
};

let lang='ar';
const $=sel=>document.querySelector(sel);
const $$=sel=>Array.from(document.querySelectorAll(sel));
const st={user:{}, sections:[], running:false};

/* ============================ UI Helpers ============================ */
function setLang(l){
  lang=l;
  const L=i18n[l];
  document.documentElement.lang=l;
  document.documentElement.dir=L.dir;
  document.body.classList.toggle('rtl',L.dir==='rtl');
  document.body.classList.toggle('ltr',L.dir==='ltr');

  $('#brandTitle').textContent=L.brand;
  $('#brandSub').textContent=L.brandSub;
  $('#startLabel').textContent=L.start;
  $('#genLabel').textContent=L.gen;
  $('#print').textContent=L.print;
  $('#status').textContent=L.ready;
  $('#heroTitle').textContent(l==='ar'?'Ù„Ù†ÙÙ†Ø´Ø¦ Ø£ÙØ¶Ù„ Ø®Ø·Ø© Ù…ÙÙ…ÙƒÙ†Ø© Ù„Ù‡Ø¯ÙÙƒ':'Letâ€™s build the best plan for your goal');
  $('#heroSub').textContent(l==='ar'
      ?'Ø³Ù†ÙÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø®Ø·Ø© Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù…: ØªØ±Ø­ÙŠØ¨ â†’ ØªØ­Ù„ÙŠÙ„ â†’ Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹ â†’ Ø§Ù„ØµÙŠØ§Ù…â€¦'
      :'We will generate the plan section-by-section: Welcome â†’ Analysis â†’ Allowed/limits â†’ Fasting â†’ Nutrition day-by-day â†’ Training day-by-day â†’ Supplements â†’ Progress â†’ Troubleshooting â†’ Safety â†’ Closing.');
  $('#guardMsg').textContent(l==='ar'?'Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Â«ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©Â»ØŒ Ø³Ù†ÙÙ†Ø´Ø¦ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙƒØªÙ…Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.'
      :'Once you click Generate Plan, we will create sections in order. Please wait until everything completes.');

  // labels
  $('#secProfile').textContent=L.profile; $('#secDiet').textContent=L.diet; $('#secLifestyle').textContent=L.lifestyle;
  $('#lblName').textContent=L.name; $('#lblAge').textContent=L.age; $('#lblHeight').textContent=L.height; $('#lblWeight').textContent=L.weight;
  $('#lblBf').textContent=L.bodyfat; $('#lblWaist').textContent=L.waist; $('#lblSex').textContent=L.sex;
  $('#lblTargetW').textContent=L.targetW; $('#lblTargetD').textContent=L.targetD;
  $('#lblMeals').textContent=L.meals; $('#lblDietType').textContent=L.dietType;
  $('#lblFasting').textContent=L.fasting; $('#lblCuisine').textContent=L.cuisine;
  $('#lblPrep').textContent=L.prep; $('#lblBudget').textContent=L.budget; $('#lblAvoid').textContent=L.avoid;
  $('#musclesTitle').textContent=L.muscles; $('#challengeTitle').textContent=L.past; $('#motivationTitle').textContent=L.motivation;
  $('#lblWork').textContent=L.work; $('#lblSteps').textContent=L.steps; $('#lblSleep').textContent=L.sleep; $('#lblStress').textContent=L.stress;
  $('#lblPlace').textContent=L.place; $('#lblLength').textContent=L.session;
  $('#fitTitle').textContent=L.fitness; $('#lblRhr').textContent=L.rhr; $('#lblPush').textContent=L.push; $('#lblPlank').textContent=L.plank; $('#lblKm').textContent=L.km;
  $('#lblDays').textContent=L.days; $('#lblEquip').textContent=L.equip; $('#lblExp').textContent=L.exp; $('#lblRpe').textContent=L.rpe;
  $('#lblCaffeine').textContent=L.caffeine; $('#lblInjury').textContent=L.injuries;
  $('#secMedical').textContent=L.medical; $('#lblOtherCond').textContent=L.condOther; $('#lblMeds').textContent=L.meds; $('#lblSupps').textContent=L.supps;

  // muscles check grid
  const mW = $('#musclesWrap'); mW.innerHTML='';
  i18n[l].musclesList.forEach((m,i)=>{
    const id='m_'+i;
    mW.insertAdjacentHTML('beforeend',`
      <div class="border rounded-md p-2">
        <label class="flex items-center gap-2">
          <input id="${id}" type="checkbox" class="mchk" value="${m}"><span>${m}</span>
        </label>
        <input id="${id}_desc" class="mt-2 w-full rounded-md border p-2" placeholder="${i18n[l].issue}">
      </div>`);
  });

  // medical checklist
  const med = $('#medicalWrap'); med.innerHTML='';
  i18n[l].medicalList.forEach((c,i)=>{
    const id='c_'+i;
    med.insertAdjacentHTML('beforeend',`
      <label class="flex items-center gap-2">
        <input id="${id}" type="checkbox" class="cchk" value="${c}"><span>${c}</span>
      </label>`);
  });

  // days
  const D=['Sat','Sun','Mon','Tue','Wed','Thu','Fri'];
  const DN=l==='ar'?['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©']:D;
  const days=$('#days'); days.innerHTML='';
  D.forEach((d,i)=>{
    days.insertAdjacentHTML('beforeend',`
      <label class="flex items-center gap-2">
        <input type="checkbox" class="day" value="${d}"><span>${DN[i]}</span>
      </label>`);
  });

  // overlay
  $('#ovTitle').textContent=L.waitTitle; $('#ovMsg').textContent=L.waitMsg;
}

function toast(msg){
  const el=document.createElement('div');
  el.className='fixed bottom-4 left-1/2 -translate-x-1/2 z-40 bg-black/80 text-white px-4 py-2 rounded-lg text-sm';
  el.textContent=msg; document.body.appendChild(el);
  setTimeout(()=>el.remove(),2500);
}

/* ============================ Currency / Locale ============================ */
function detectCurrency(){
  try{
    const loc = Intl.NumberFormat().resolvedOptions().locale || 'en-US';
    const region = new Intl.DateTimeFormat(loc,{timeZoneName:'short'}).resolvedOptions().locale || loc;
    // cheap map
    const map = { 'ar-EG':'EGP','ar-SA':'SAR','ar-AE':'AED','en-US':'USD','en-GB':'GBP','en-EU':'EUR','ar-KW':'KWD','ar-QA':'QAR','ar-BH':'BHD','ar-OM':'OMR','ar-JO':'JOD','ar-IQ':'IQD','ar-MA':'MAD','ar-DZ':'DZD' };
    const cur = map[region] || map[loc] || 'USD';
    $('#currency').textContent=cur;
  }catch{ $('#currency').textContent='USD'; }
}

/* ============================ Validation ============================ */
function collect(){
  const L=i18n[lang];
  const goals=[...$$('.goal:checked')].map(x=>x.value);
  const muscles=[...$$('.mchk:checked')].map(ch=>{
    const d=$(`#${ch.id}_desc`).value.trim(); return d?`${ch.value}: ${d}`:ch.value;
  });
  const medical=[...$$('.cchk:checked')].map(x=>x.value);
  const days=[...$$('.day:checked')].map(x=>x.value);

  const u={
    name:$('#name').value.trim(),
    age:$('#age').value, height:$('#height').value, weight:$('#weight').value,
    bodyfat:$('#bodyfat').value, waist:$('#waist').value, sex:$('#sex').value,
    targetWeight:$('#targetWeight').value, targetDate:$('#targetDate').value,
    goals, meals:$('#meals').value, dietType:$('#dietType').value,
    fasting:$('#fasting').value, cuisine:$('#cuisine').value, prep:$('#prep').value,
    budget:$('#budget').value, avoid:$('#avoid').value,
    muscles, pastChallenges:$('#pastChallenges').value, motivation:$('#motivation').value,
    work:$('#work').value, steps:$('#steps').value, sleep:$('#sleep').value, stress:$('#stress').value,
    place:$('#place').value, session:$('#session').value,
    rhr:$('#rhr').value, pushups:$('#pushups').value, plank:$('#plank').value, kmTime:$('#kmTime').value,
    days, equipment:$('#equipment').value, experience:$('#experience').value,rpe:$('#rpe').value,
    caffeine:$('#caffeine').value, injuries:$('#injuries').value,
    medical, otherCond:$('#otherCond').value, meds:$('#meds').value, supps:$('#supps').value
  };
  // minimal required
  if(!u.name || !u.age || !u.height || !u.weight){
    toast(lang==='ar'?'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ø·ÙˆÙ„/Ø§Ù„ÙˆØ²Ù†.':'Complete required fields: name/age/height/weight.');
    return null;
  }
  return u;
}

/* ============================ Calculations (TDEE/Macros) ============================ */
function computeTargets(u){
  const W=Number(u.weight)||0, H=Number(u.height)||0, A=Number(u.age)||0;
  const male=u.sex==='Male';
  const BMR = male? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161;
  const factor = u.work==='Sedentary'?1.2 : u.work==='Light'?1.35 : u.work==='Moderate'?1.5 : 1.7;
  let TDEE=BMR*factor;
  if(u.goals.includes('Fat Loss')) TDEE*=0.85;
  else if(u.goals.includes('Build Muscle')) TDEE*=1.1;
  const targetW=Number(u.targetWeight)||W||1;
  const proteinG=Math.round(2.0*targetW);
  const fatG=Math.round(Math.max(0,0.8*W));
  let carbG=Math.round((TDEE - (proteinG*4 + fatG*9))/4);
  const hasIR = (u.medical||[]).some(x=>/(Diabetes|Insulin|Ø§Ù„Ø³ÙƒØ±ÙŠ|Ù…Ù‚Ø§ÙˆÙ…Ø©)/i.test(x));
  if(hasIR) carbG=Math.min(carbG,120);
  carbG=Math.max(0,carbG);
  return {calories:Math.round(TDEE), macros:{proteinG, fatG, carbG}};
}

/* ============================ AI Generation (section-by-section) ============================ */
async function callAI(prompt){
  const res=await fetch('/.netlify/functions/gemini-proxy',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({prompt})});
  if(!res.ok){ throw new Error(await res.text()); }
  const data=await res.json(); return data.text||'';
}

function sectionTitle(key){
  return lang==='ar'? key : key; // simple passthrough; titles included in prompt
}

function appendMarkdown(md){
  const html = marked.parse(md);
  $('#plan').insertAdjacentHTML('beforeend',html);
  window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
}

async function generatePlan(){
  if(st.running) return; const u=collect(); if(!u) return;
  st.running=true; $('#plan').innerHTML=''; $('#overlay').classList.remove('hidden'); $('#progressTxt').textContent='0%';
  const L=i18n[lang]; const targets=computeTargets(u);

  const sec=(title,body)=>`### ${title}\n${body}\n`;

  // 1) Welcome
  let p = `
You are "Mustafa Elsafy", certified international coach. Write only in ${lang==='ar'?'Arabic':'English'}.
Audience: ${u.name}. Create a professional, exhaustive plan. Use clear Markdown headings and tables. No placeholders.

User profile:
- Sex: ${u.sex}, Age ${u.age}, Height ${u.height}cm, Weight ${u.weight}kg, BodyFat ${u.bodyfat||'N/A'}%, Waist ${u.waist||'N/A'}cm
- Goals: ${u.goals.join(', ')||'N/A'}; Target weight ${u.targetWeight||'N/A'} by ${u.targetDate||'N/A'}
- Lifestyle: Work ${u.work}, Steps ${u.steps}/day, Sleep ${u.sleep}, Stress ${u.stress}, Training ${u.place} ${u.session}min
- Fitness: RHR ${u.rhr||'?'}, Push-ups ${u.pushups||'?'}, Plank ${u.plank||'?'}, 1km ${u.kmTime||'?'}
- Days available: ${u.days.join(', ')||'N/A'}; Equipment: ${u.equipment||'None'}
- Experience: ${u.experience}, Target RPE ${u.rpe}
- Diet: Meals ${u.meals}/day, Style ${u.dietType}, Cuisine ${u.cuisine}, Prep ${u.prep}min, Fasting ${u.fasting}
- Budget: ${u.budget} ${$('#currency').textContent}; Avoid: ${u.avoid||'None'}
- Focus muscles: ${u.muscles.join('; ')||'None'}
- Medical: ${u.medical.join('; ')||'None'}; Other: ${u.otherCond||'None'}; Injuries: ${u.injuries||'None'}
- Current meds: ${u.meds||'None'}; Supplements: ${u.supps||'None'}
- Motivation: ${u.motivation}; Past challenges: ${u.pastChallenges||'None'}

Daily targets computed:
- Calories ~ ${targets.calories} kcal
- Macros: Protein ${targets.macros.proteinG} g, Fat ${targets.macros.fatG} g, Carbs ${targets.macros.carbG} g

Task: Generate the plan SEQUENTIALLY. Start with a warm welcome paragraph (no repetition later), then an analytic summary of the user's situation and clear objectives and success metrics.
`;
  $('#progressTxt').textContent='8%';
  appendMarkdown(await callAI(p));

  // 2) Allowed / Limits
  p = `Write in ${lang==='ar'?'Arabic':'English'}.
Create a section with two bullet lists: **Allowed / Recommended** and **To limit/avoid** based on:
diet style ${u.dietType}, allergies/avoid "${u.avoid}", medical "${u.medical.join(', ')}".
Keep it practical.`;
  $('#progressTxt').textContent='16%';
  appendMarkdown(sec(lang==='ar'?'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹':'Allowed & Limits', await callAI(p)));

  // 3) Intermittent fasting (if enabled or goal fat loss)
  if(u.fasting!=='None' || u.goals.includes('Fat Loss')){
    p=`In ${lang==='ar'?'Arabic':'English'}, describe intermittent fasting protocol "${u.fasting==='None'?'16:8':u.fasting}" with:
- eating window, hydration, electrolytes;
- how to align with ${u.meals} meals/day and ${u.session} min sessions;
- safety notes for conditions: ${u.medical.join(', ')||'None'}.`;
    $('#progressTxt').textContent='24%';
    appendMarkdown(sec(lang==='ar'?'Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹':'Intermittent Fasting', await callAI(p)));
  }

  // 4) Nutrition 7 days â€“ day by day
  p=`Generate a **7-day nutrition plan** day-by-day (Day 1..Day 7) in ${lang==='ar'?'Arabic':'English'}.
Rules:
- ${u.meals} meals/day + optional snacks.
- Tightly match daily targets: ${targets.calories} kcal; Protein ${targets.macros.proteinG}g, Fat ${targets.macros.fatG}g, Carbs ${targets.macros.carbG}g.
- Respect "${u.dietType}" style, cuisine "${u.cuisine}", prep time ~ ${u.prep} min/meal, budget ${u.budget} ${$('#currency').textContent}.
- Honor avoid/allergy list: ${u.avoid||'None'} and medical limits: ${u.medical.join(', ')||'None'}.
- For each meal list: name, ingredients with grams, macros and calories, and note [SWAP:MEAL:<name>] to allow swapping.

Return as Markdown with a table per day. No generic adviceâ€”full menus.`;
  $('#progressTxt').textContent='45%';
  appendMarkdown(sec(lang==='ar'?'Ø§Ù„ØªØºØ°ÙŠØ© (7 Ø£ÙŠØ§Ù…)':'Nutrition (7 days)', await callAI(p)));

  // 5) Training 7 days â€“ day by day
  p=`Create a **7-day training plan** day-by-day in ${lang==='ar'?'Arabic':'English'}.
Constraints:
- Experience ${u.experience}, place ${u.place}, equipment "${u.equipment||'bodyweight'}", RPE target ${u.rpe}.
- Session length ~ ${u.session} min. Available days: ${u.days.join(', ')||'N/A'}.
- Include warm-up and cool-down, volume and progressive overload across the week.
- Prioritize weak/focus muscles: ${u.muscles.join('; ')||'None'} with specific exercise choices and form cues.
- Avoid aggravating injuries: ${u.injuries||'None'} and conditions: ${u.medical.join(', ')||'None'}.
Format: A Markdown table per day with columns: Day | Exercise (English) | Sets | Reps | Rest (s). Add [SWAP:EXERCISE:<Exercise>].`;
  $('#progressTxt').textContent='66%';
  appendMarkdown(sec(lang==='ar'?'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)':'Training (7 days)', await callAI(p)));

  // 6) Supplements
  p=`Propose evidence-based supplements in ${lang==='ar'?'Arabic':'English'}, tailored to: goals "${u.goals.join(', ')}", medical "${u.medical.join(', ')}", meds "${u.meds||'None'}".
Structure:
- **Core stack** (daily, doses, timing, contraindications).
- **Goal-specific** (fat loss/strength/endurance as relevant).
- **If budget-limited** (cheapest effective).
Safety and interactions must be explicit.`;
  $('#progressTxt').textContent='78%';
  appendMarkdown(sec(lang==='ar'?'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª':'Supplements', await callAI(p)));

  // 7) Progression
  p=`In ${lang==='ar'?'Arabic':'English'}, write a practical progression plan:
- weekly weight/measurement tracking; expected rate (based on ${u.goals});
- when to adjust calories/macros; examples;
- training progression (sets/reps/load, RPE use).`;
  $('#progressTxt').textContent='86%';
  appendMarkdown(sec(lang==='ar'?'Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©':'Progress & Tracking', await callAI(p)));

  // 8) Troubleshooting & Safety & Closing
  p=`In ${lang==='ar'?'Arabic':'English'}, add:
- Troubleshooting common issues considering past challenges "${u.pastChallenges||'None'}".
- Safety notes specific to: ${u.medical.join(', ')||'None'}, injuries "${u.injuries||'None'}".
- Motivational closing according to style "${u.motivation}". Sign as "Mustafa Elsafy".`;
  $('#progressTxt').textContent='100%';
  appendMarkdown(await callAI(p));

  $('#overlay').classList.add('hidden');
  st.running=false;
  toast(i18n[lang].sectionDone(lang==='ar'?'Ø§Ù„Ø®Ø·Ø© ÙƒØ§Ù…Ù„Ø©':'Full plan'));
}

/* ============================ Events ============================ */
$('#btnAr').onclick=()=>setLang('ar');
$('#btnEn').onclick=()=>setLang('en');
$('#startTop').onclick=()=>$('#generate').click();
$('#generate').onclick=generatePlan;
$('#print').onclick=()=>window.print();
$('#theme').onclick=()=>document.documentElement.classList.toggle('dark');

/* ============================ Init ============================ */
window.addEventListener('load',()=>{
  setLang('ar');
  detectCurrency();
});
</script>
</body>
</html>
