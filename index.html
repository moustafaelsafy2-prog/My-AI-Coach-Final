<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ | Intelligent Health Coach</title>

  <!-- Fonts & libs -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --brand:#6c5ce7; --brand-2:#00c2ff;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      --muted:#93a2b8;
    }
    html[dir="rtl"] body { font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",sans-serif }
    html[dir="ltr"] body { font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif }
    body{ background:linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%); color:#eaf0ff }
    .glass{ background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.10); border-radius:16px }
    .title-grad{ background:linear-gradient(90deg,var(--brand),var(--brand-2)); -webkit-background-clip:text; background-clip:text; color:transparent }
    .chip{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); padding:.35rem .6rem; border-radius:999px; font-size:.75rem }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.75rem 1rem; border-radius:.8rem; font-weight:800; transition:.2s }
    .btn-primary{ background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#fff }
    .btn-primary:hover{ filter:brightness(1.08); transform:translateY(-1px) }
    .btn-ghost{ background:rgba(255,255,255,.06); color:#eaf0ff; border:1px solid rgba(255,255,255,.12) }
    .field{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); border-radius:.7rem; padding:.65rem .8rem; outline:none; width:100%; color:#eaf0ff }
    .field::placeholder{ color:#aab7cf } .field:focus{ border-color:var(--brand-2); box-shadow:0 0 0 3px rgba(0,194,255,.15) }
    .section-title{ font-weight:900; letter-spacing:.3px }
    .divider{ height:1px; background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent) }
    .progress{ height:.45rem; background:rgba(255,255,255,.10); border-radius:999px; overflow:hidden }
    .progress>i{ display:block; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); width:0%; transition:width .25s ease }
    .badge{ display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .55rem; border-radius:.5rem; font-size:.72rem; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06) }
    .status-dot{ width:.55rem; height:.55rem; border-radius:999px }
    .g{ display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:14px }
    html[dir="rtl"] .c1{grid-column:1/span 4} html[dir="rtl"] .c2{grid-column:5/span 4} html[dir="rtl"] .c3{grid-column:9/span 4}
    html[dir="ltr"] .c1{grid-column:1/span 4} html[dir="ltr"] .c2{grid-column:5/span 4} html[dir="ltr"] .c3{grid-column:9/span 4}
    @media (max-width:1024px){ .g .c1,.g .c2,.g .c3{ grid-column:1 / span 12 } }
    .light body,.light{ background:linear-gradient(180deg,#eef2ff 0%,#f7f9ff 100%); color:#0e1526 }
    .light .glass{ background:linear-gradient(180deg,rgba(0,0,0,.03),rgba(0,0,0,.02)); border-color:rgba(0,0,0,.10) }
    .light .field{ background:rgba(0,0,0,.03); color:#0e1526; border-color:rgba(0,0,0,.12) }
    @media print{
      body{ background:#fff; color:#111 } .glass,.btn,.chip,.title-grad{ all:unset }
      .ai-content h2,.ai-content h3{ color:#111 }
      .ai-content table{ border-collapse:collapse; width:100% }
      .ai-content th,.ai-content td{ border:1px solid #333; padding:.55rem; vertical-align:top }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="sticky top-0 z-40 glass border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="size-9 rounded-xl bg-gradient-to-br from-[var(--brand)] to-[var(--brand-2)] grid place-items-center font-black">AI</div>
        <div>
          <div id="app-title" class="text-lg font-extrabold">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ</div>
          <div id="subtitle" class="text-xs text-[color:var(--muted)]">Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù Ùª Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ø®ØµØµØ© Ù„Ùƒ</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="toggle-theme" class="chip" title="Theme">â˜¾/â˜€</button>
        <button id="lang-ar" class="chip">Ø¹Ø±Ø¨ÙŠ</button>
        <button id="lang-en" class="chip">EN</button>
        <button id="btn-print" class="btn btn-ghost">ğŸ–¨</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Stepper -->
    <section class="glass p-4 mb-4">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm text-[color:var(--muted)]" id="hint"></div>
        <div class="w-56 progress"><i id="global-progress"></i></div>
      </div>
    </section>

    <!-- Wizard -->
    <section id="wizard" class="glass p-4">
      <div class="section-title title-grad text-xl mb-3" id="step-title">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
      <div id="step-body"></div>

      <div class="divider my-4"></div>
      <!-- NAV at bottom -->
      <div class="flex items-center justify-between">
        <div class="text-xs text-[color:var(--muted)]" id="live-hint">â€”</div>
        <div class="flex items-center gap-2">
          <button id="prev" class="btn btn-ghost" disabled>â—€ <span id="t-prev">Ø§Ù„Ø³Ø§Ø¨Ù‚</span></button>
          <button id="next" class="btn btn-primary"><span id="t-next">Ø§Ù„ØªØ§Ù„ÙŠ</span> â–¶</button>
          <button id="generate-current" class="btn btn-primary">âš¡ <span id="t-generate">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</span></button>
        </div>
      </div>
    </section>

    <!-- Plan area -->
    <section class="glass p-5 mt-6">
      <div class="flex items-center justify-between">
        <div class="section-title text-lg" id="plan-title">Ø§Ù„Ø®Ø·Ø©</div>
        <div class="badge"><i class="status-dot" id="run-dot" style="background:#888"></i><span id="run-label">Idle</span></div>
      </div>

      <div class="my-3">
        <div class="w-full progress"><i id="run-progress"></i></div>
        <div class="text-xs mt-1 text-[color:var(--muted)]" id="run-msg">â€”</div>
      </div>

      <div id="sections-board" class="flex flex-wrap gap-2 my-2"></div>
      <div id="plan-content" class="ai-content space-y-4"></div>
    </section>

    <section class="flex items-center justify-end gap-2 mt-5">
      <button class="btn btn-ghost" id="scroll-top">â†‘ <span id="t-top">Ø£Ø¹Ù„Ù‰</span></button>
      <button class="btn btn-primary" id="print-bottom">ğŸ–¨ <span id="t-print2">Ø·Ø¨Ø§Ø¹Ø© / PDF</span></button>
    </section>

    <footer class="text-center text-xs text-[color:var(--muted)] mt-6">
      2025 Â© Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Powered by <strong>Coach Mustafa Elsafy</strong>
    </footer>
  </main>

<script>
/* ============================ CONFIG ============================ */
const ENDPOINT = '/.netlify/functions/gemini-proxy';

/* ============================ STATE ============================ */
const state = {
  lang: (navigator.language || 'ar').startsWith('ar') ? 'ar' : 'en',
  theme: 'dark',
  step: 0,
  currency: detectCurrency(),
  profile: { name:'', age:'', height:'', weight:'', bodyFat:'', waist:'', sex:'Male', targetWeight:'', targetDate:'' },
  diet: { goals:[], mealsPerDay:3, preferredDiet:'Balanced', cuisine:'Arabic/Mediter.', prepTime:20, monthlyBudget:0, foodsToAvoid:'', allergies:'', fasting:'off' },
  lifestyle:{ workActivity:'Sedentary', stepsPerDay:6000, sleep:'Low', stress:'Low', trainingPlace:'Home/Gym', sessionLength:60, availableDays:[], equipment:'', experience:'Beginner (0-6m)', rpe:8, caffeine:0, injuries:'' },
  fitness:{ restingHR:'', maxPushups:'', plank:'', kmTime:'' },
  muscles: { chest:{on:false,note:''}, back:{on:false,note:''}, shoulders:{on:false,note:''}, biceps:{on:false,note:''}, triceps:{on:false,note:''}, quads:{on:false,note:''}, hamstrings:{on:false,note:''}, glutes:{on:false,note:''}, calves:{on:false,note:''}, abs:{on:false,note:''} },
  medical:{ conditions:[], other:'', meds:'', supplements:'' },
  challenges:{ past:'', motivation:'Direct' },
  targets:null,
  sections:[
    'welcome','analysis','allowed','fasting',
    'nutrition-day-1','nutrition-day-2','nutrition-day-3','nutrition-day-4','nutrition-day-5','nutrition-day-6','nutrition-day-7',
    'training-day-1','training-day-2','training-day-3','training-day-4','training-day-5','training-day-6','training-day-7',
    'supplements','progression','troubleshoot','safety','closing'
  ],
  sectionStatus:{}
};

/* ============================ I18N ============================ */
const T = {
  ar:{ appTitle:'Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ', subtitle:'Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù Ùª Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ø®ØµØµØ© Ù„Ùƒ', hint:'Ø³Ù†ÙÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆÙŠØ¸Ù‡Ø± ÙƒÙ„ Ù‚Ø³Ù… Ø¨Ù…Ø¬Ø±Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØªÙ‡.',
    steps:['Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ','Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª','Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©','Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª'],
    next:'Ø§Ù„ØªØ§Ù„ÙŠ', prev:'Ø§Ù„Ø³Ø§Ø¨Ù‚', generate:'ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ', top:'Ø£Ø¹Ù„Ù‰', print2:'Ø·Ø¨Ø§Ø¹Ø© / PDF',
    profile:'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', dietPrefs:'Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª', lifestyle:'Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©', med:'Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª',
    name:'Ø§Ù„Ø§Ø³Ù…', age:'Ø§Ù„Ø¹Ù…Ø±', height:'Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)', weight:'Ø§Ù„ÙˆØ²Ù† (ÙƒØº)', bodyFat:'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† % (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', waist:'Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ± (Ø³Ù…) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', sex:'Ø§Ù„Ø¬Ù†Ø³',
    male:'Ø°ÙƒØ±', female:'Ø£Ù†Ø«Ù‰', targetWeight:'Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (ÙƒØº)', targetDate:'Ù…ÙˆØ¹Ø¯ ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù (ØªØ§Ø±ÙŠØ®)',
    goals:'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù', fatLoss:'Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†', build:'Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª', strength:'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©', endurance:'Ø§Ù„ØªØ­Ù…Ù„', health:'ØµØ­Ø© Ø¹Ø§Ù…Ø©',
    mealsPerDay:'Ø§Ù„ÙˆØ¬Ø¨Ø§Øª/Ø§Ù„ÙŠÙˆÙ…', preferredDiet:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù„', balanced:'Ù…ØªÙˆØ§Ø²Ù†', lowCarb:'Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª', keto:'ÙƒÙŠØªÙˆ', medc:'Ù…ØªÙˆØ³Ø·ÙŠ/Ø¹Ø±Ø¨ÙŠ', veg:'Ù†Ø¨Ø§ØªÙŠ/Ù…Ø±Ù†',
    fasting:'Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹', off:'ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„', f16:'16:8', f18:'18:6', f20:'20:4', cuisine:'Ø§Ù„Ù…Ø·Ø¨Ø®', prepTime:'ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø¯)', budget:'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©',
    foodsAvoid:'Ø£Ø·Ø¹Ù…Ø© Ù„Ø§ ØªØ±ØºØ¨ Ø¨Ù‡Ø§/Ø­Ø³Ø§Ø³ÙŠØ§Øª', allergies:'Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø´Ø§Ø¦Ø¹Ø©', workActivity:'Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¹Ù…Ù„', steps:'Ø§Ù„Ø®Ø·ÙˆØ§Øª/Ø§Ù„ÙŠÙˆÙ…', sleep:'Ø§Ù„Ù†ÙˆÙ…', stress:'Ø§Ù„ØªÙˆØªØ±',
    place:'Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ…Ø±ÙŠÙ†', session:'Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯)', days:'Ø£ÙŠØ§Ù… Ø§Ù„ØªÙ…Ø±ÙŠÙ†', equipment:'Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©', experience:'Ø§Ù„Ø®Ø¨Ø±Ø©', rpe:'RPE', caffeine:'ÙƒØ§ÙÙŠÙŠÙ†/Ø£ÙƒÙˆØ§Ø¨', injuries:'Ø¥ØµØ§Ø¨Ø§Øª/Ù‚ÙŠÙˆØ¯',
    quick:'Ø§Ø®ØªØ¨Ø§Ø± Ù„ÙŠØ§Ù‚Ø© Ù…Ø¨Ø³Ù‘Ø·', restingHR:'Ù†Ø¨Ø¶ Ø§Ù„Ø±Ø§Ø­Ø© (bpm)', pushups:'Ø£Ù‚ØµÙ‰ Push-ups', plank:'Plank (Ø¯)', kmTime:'Ø²Ù…Ù† 1 ÙƒÙ… (Ø¯:Ø«)',
    musclesFocus:'Ø¹Ø¶Ù„Ø§Øª ØªØ­ØªØ§Ø¬ Ø¹Ù†Ø§ÙŠØ©', describe:'ÙˆØµÙ/Ø³Ø¨Ø¨',
    medicalStatus:'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©', otherCond:'Ø£Ù…Ø±Ø§Ø¶ Ø£Ø®Ø±Ù‰', currentMeds:'Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ©', currentSupp:'Ù…ÙƒÙ…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ©',
    pastCh:'ØªØ­Ø¯ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©', motiv:'Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØ­ÙÙŠØ²', motivDir:'Ø¹Ù…Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±', motivWarm:'ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…',
    plan:'Ø§Ù„Ø®Ø·Ø©', idle:'Ø¬Ø§Ù‡Ø²', gen:'ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯â€¦', done:'Ø§ÙƒØªÙ…Ù„', failed:'ÙØ´Ù„', retry:'Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…',
    waitMsg:'Ø³ÙŠØ¸Ù‡Ø± ÙƒÙ„ Ù‚Ø³Ù… ÙÙˆØ± ØªÙˆÙ„ÙŠØ¯Ù‡ â€” Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±â€¦'
  },
  en:{ appTitle:'Intelligent Health Coach', subtitle:'100% precise plan for nutrition, training & supplements â€” fully personalized', hint:'Sections are generated sequentially and appear as soon as they are ready.',
    steps:['Profile','Diet & Preferences','Lifestyle','Medical & Challenges'],
    next:'Next', prev:'Back', generate:'Generate current section', top:'Top', print2:'Print / PDF',
    profile:'Profile', dietPrefs:'Diet & Preferences', lifestyle:'Lifestyle', med:'Medical & Challenges',
    name:'Name', age:'Age', height:'Height (cm)', weight:'Weight (kg)', bodyFat:'Body fat % (optional)', waist:'Waist (cm) (optional)', sex:'Sex',
    male:'Male', female:'Female', targetWeight:'Target weight (kg)', targetDate:'Target date',
    goals:'Goals', fatLoss:'Fat loss', build:'Build muscle', strength:'Strength', endurance:'Endurance', health:'General health',
    mealsPerDay:'Meals/day', preferredDiet:'Preferred diet', balanced:'Balanced', lowCarb:'Low-carb', keto:'Keto', medc:'Mediterranean/Arabic', veg:'Plant-forward',
    fasting:'Intermittent fasting', off:'Off', f16:'16:8', f18:'18:6', f20:'20:4', cuisine:'Cuisine', prepTime:'Prep time (min)', budget:'Monthly budget',
    foodsAvoid:'Foods to avoid / dislikes', allergies:'Common allergies', workActivity:'Work/Activity', steps:'Steps/day', sleep:'Sleep', stress:'Stress',
    place:'Training place', session:'Session length (min)', days:'Available training days', equipment:'Available equipment', experience:'Experience', rpe:'RPE', caffeine:'Caffeine/day (cups)', injuries:'Injuries/constraints',
    quick:'Quick fitness test', restingHR:'Resting HR (bpm)', pushups:'Max push-ups', plank:'Plank (min)', kmTime:'1 km time (m:s)',
    musclesFocus:'Muscles needing focus', describe:'Describe issue/reason',
    medicalStatus:'Medical status', otherCond:'Other conditions', currentMeds:'Current medications', currentSupp:'Current supplements',
    pastCh:'Past challenges', motiv:'Preferred motivation', motivDir:'Direct & pragmatic', motivWarm:'Supportive & encouraging',
    plan:'Plan', idle:'Idle', gen:'Generatingâ€¦', done:'Done', failed:'Failed', retry:'Retry this section',
    waitMsg:'Each section will appear as soon as itâ€™s generated. Please waitâ€¦'
  }
};
const t=(k)=> (T[state.lang] && T[state.lang][k]) || k;

/* ============================ HELPERS ============================ */
function detectCurrency(){
  try{
    const loc = Intl.DateTimeFormat().resolvedOptions().locale || navigator.language || 'en-US';
    if(loc.includes('EG')) return 'EGP'; if(loc.includes('SA')) return 'SAR'; if(loc.includes('AE')) return 'AED';
    if(loc.includes('QA')) return 'QAR'; if(loc.includes('KW')) return 'KWD'; if(loc.includes('GB')) return 'GBP';
    if(/(DE|FR|IT|ES)/.test(loc)) return 'EUR'; return 'USD';
  }catch{ return 'USD'; }
}
function esc(s){ return (s??'').toString().replace(/"/g,'&quot;'); }
function Lbl(label, id, value='', placeholder=''){
  return `<label class="block mb-2"><div class="mb-1">${label}</div><input id="${id}" class="field" value="${esc(value)}" placeholder="${placeholder}"></label>`;
}
function Num(label, id, value='', placeholder=''){
  return `<label class="block mb-2"><div class="mb-1">${label}</div><input id="${id}" inputmode="numeric" pattern="[0-9]*" class="field" value="${esc(value)}" placeholder="${placeholder}"></label>`;
}

/* ============================ UI ============================ */
function setLang(lang){
  state.lang=lang; document.documentElement.lang=lang; document.documentElement.dir=(lang==='ar'?'rtl':'ltr');
  document.getElementById('app-title').textContent=t('appTitle');
  document.getElementById('subtitle').textContent=t('subtitle');
  document.getElementById('hint').textContent=t('hint');
  document.getElementById('t-prev').textContent=t('prev');
  document.getElementById('t-next').textContent=t('next');
  document.getElementById('t-generate').textContent=t('generate');
  document.getElementById('t-top').textContent=t('top');
  document.getElementById('t-print2').textContent=t('print2');
  document.getElementById('plan-title').textContent=t('plan');
  renderStep(); renderBoard();
}
function setTheme(mode){ state.theme=mode; if(mode==='light') document.documentElement.classList.add('light'); else document.documentElement.classList.remove('light'); }

function renderStep(){
  const titles=T[state.lang].steps; document.getElementById('step-title').textContent=titles[state.step];
  const el=document.getElementById('step-body');

  if(state.step===0){
    el.innerHTML = `
      <div class="g">
        <div class="glass p-4 c1">
          <div class="section-title mb-2">${t('profile')}</div>
          ${Lbl(t('name'),'name',state.profile.name,t('name'))}
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('age'),'age',state.profile.age)}
            <label class="block mb-2"><div class="mb-1">${t('sex')}</div>
              <select id="sex" class="field">
                <option value="Male">${t('male')}</option><option value="Female">${t('female')}</option>
              </select>
            </label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('height'),'height',state.profile.height)} ${Num(t('weight'),'weight',state.profile.weight)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('bodyFat'),'bodyFat',state.profile.bodyFat)} ${Num(t('waist'),'waist',state.profile.waist)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('targetWeight'),'targetWeight',state.profile.targetWeight)}
            <label class="block mb-2"><div class="mb-1">${t('targetDate')}</div><input id="targetDate" type="date" class="field" value="${esc(state.profile.targetDate)}"></label>
          </div>
        </div>

        <div class="glass p-4 c2">
          <div class="section-title mb-2">${t('dietPrefs')}</div>
          <div class="mb-2">${t('goals')}</div>
          <div class="grid grid-cols-2 gap-2 mb-2">
            ${['fatLoss','build','strength','endurance','health'].map(id=>`
              <label class="flex items-center gap-2">
                <input type="checkbox" id="g-${id}" class="accent-[var(--brand-2)]" ${state.diet.goals.includes(id)?'checked':''}>
                <span>${t(id)}</span>
              </label>`).join('')}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('mealsPerDay'),'meals',state.diet.mealsPerDay)}
            <label class="block mb-2"><div class="mb-1">${t('preferredDiet')}</div>
              <select id="prefDiet" class="field">
                <option value="Balanced">${t('balanced')}</option><option value="LowCarb">${t('lowCarb')}</option>
                <option value="Keto">${t('keto')}</option><option value="Arabic/Mediter.">${t('medc')}</option>
                <option value="Plant">${t('veg')}</option>
              </select>
            </label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('fasting')}</div>
              <select id="fasting" class="field">
                <option value="off">${t('off')}</option><option value="16:8">${t('f16')}</option>
                <option value="18:6">${t('f18')}</option><option value="20:4">${t('f20')}</option>
              </select>
            </label>
            ${Lbl(t('cuisine'),'cuisine',state.diet.cuisine)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('prepTime'),'prep',state.diet.prepTime)}
            <label class="block mb-2"><div class="mb-1">${t('budget')}</div>
              <div class="flex gap-2">
                <input id="budget" class="field flex-1" inputmode="numeric" value="${esc(state.diet.monthlyBudget)}">
                <select id="currency" class="field w-28">
                  ${['USD','EUR','GBP','SAR','AED','KWD','QAR','EGP'].map(c=>`<option ${state.currency===c?'selected':''}>${c}</option>`).join('')}
                </select>
              </div>
            </label>
          </div>
          ${Lbl(t('foodsAvoid'),'avoid',state.diet.foodsToAvoid,"Ù…Ø«Ø§Ù„: Ù„Ø§ Ø£Ø­Ø¨ Ø§Ù„Ø³Ù…Ùƒâ€¦")}
          ${Lbl(t('allergies'),'allergies',state.diet.allergies,"Gluten, Lactoseâ€¦")}
        </div>

        <div class="glass p-4 c3">
          <div class="section-title mb-2">${t('lifestyle')}</div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('workActivity')}</div>
              <select id="work" class="field"><option value="Sedentary">Sedentary</option><option value="Light">Light</option><option value="Moderate">Moderate</option><option value="High">High</option></select>
            </label>
            ${Num(t('steps'),'steps',state.lifestyle.stepsPerDay)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('sleep')}</div>
              <select id="sleep" class="field"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option></select>
            </label>
            <label class="block mb-2"><div class="mb-1">${t('stress')}</div>
              <select id="stress" class="field"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option></select>
            </label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Lbl(t('place'),'place',state.lifestyle.trainingPlace)} ${Num(t('session'),'session',state.lifestyle.sessionLength)}
          </div>
          <div class="mb-2">
            <div class="mb-1">${t('days')}</div>
            <div class="grid grid-cols-7 gap-2 text-xs">
              ${(state.lang==='ar'?['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©']:['Sat','Sun','Mon','Tue','Wed','Thu','Fri'])
                .map((d,i)=>`<label class="flex items-center gap-1 bg-white/5 px-2 py-1 rounded-md border border-white/10"><input type="checkbox" id="day-${i}" class="accent-[var(--brand-2)]"><span>${d}</span></label>`).join('')}
            </div>
          </div>
          ${Lbl(t('equipment'),'equip',state.lifestyle.equipment,'Dumbbells, barbell, bandsâ€¦')}
          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('experience')}</div>
              <select id="exp" class="field"><option>Beginner (0-6m)</option><option>Intermediate (6-24m)</option><option>Advanced (24m+)</option></select>
            </label>
            ${Num(t('rpe'),'rpe',state.lifestyle.rpe)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('caffeine'),'caf',state.lifestyle.caffeine)} ${Lbl(t('injuries'),'inj',state.lifestyle.injuries,'Shoulder impingementâ€¦')}
          </div>
        </div>
      </div>`;
    document.getElementById('sex').value=state.profile.sex||'Male';
    document.getElementById('prefDiet').value=state.diet.preferredDiet;
    document.getElementById('fasting').value=state.diet.fasting;
    document.getElementById('currency').value=state.currency;
    document.getElementById('work').value=state.lifestyle.workActivity;
    document.getElementById('sleep').value=state.lifestyle.sleep;
    document.getElementById('stress').value=state.lifestyle.stress;
    document.getElementById('exp').value=state.lifestyle.experience;
    (state.lifestyle.availableDays||[]).forEach(i=>{ const el=document.getElementById('day-'+i); if(el) el.checked=true; });
  }

  if(state.step===1){
    el.innerHTML = `
      <div class="glass p-4">
        <div class="section-title mb-2">${t('quick')}</div>
        <div class="grid grid-cols-2 gap-2">
          ${Num(t('restingHR'),'q-hr',state.fitness.restingHR)} ${Num(t('pushups'),'q-pu',state.fitness.maxPushups)}
        </div>
        <div class="grid grid-cols-2 gap-2">
          ${Num(t('plank'),'q-pl',state.fitness.plank)} ${Lbl(t('kmTime'),'q-km',state.fitness.kmTime,'5:30')}
        </div>
      </div>`;
  }

  if(state.step===2){
    el.innerHTML = `
      <div class="glass p-4">
        <div class="section-title mb-2">${t('musclesFocus')}</div>
        ${['chest','back','shoulders','biceps','triceps','quads','hamstrings','glutes','calves','abs'].map(k=>{
          const arNames={chest:'Ø§Ù„ØµØ¯Ø±',back:'Ø§Ù„Ø¸Ù‡Ø±',shoulders:'Ø§Ù„Ø£ÙƒØªØ§Ù',biceps:'Ø§Ù„Ø¨Ø§ÙŠØ³Ø¨Ø³',triceps:'Ø§Ù„ØªØ±Ø§ÙŠØ³Ø¨Ø³',quads:'Ø§Ù„Ø£Ø±Ø¬Ù„ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©',hamstrings:'Ø§Ù„Ø£Ø±Ø¬Ù„ Ø§Ù„Ø®Ù„ÙÙŠØ©',glutes:'Ø§Ù„Ù…Ø¤Ø®Ø±Ø©',calves:'Ø§Ù„Ø³Ù…Ø§Ù†Ø©',abs:'Ø§Ù„Ø¨Ø·Ù†'};
          const lab=(state.lang==='ar'?arNames[k]:k[0].toUpperCase()+k.slice(1));
          const v=state.muscles[k];
          return `<div class="grid grid-cols-2 gap-2 items-center mb-2">
              <label class="flex items-center gap-2"><input type="checkbox" id="m-${k}" class="accent-[var(--brand-2)]" ${v.on?'checked':''}><span>${lab}</span></label>
              <input id="mnote-${k}" class="field" value="${esc(v.note)}" placeholder="${t('describe')}">
            </div>`;
        }).join('')}
      </div>`;
  }

  if(state.step===3){
    const items=[['Hypertension','Ø¶ØºØ· Ø§Ù„Ø¯Ù…'],['Diabetes','Ø§Ù„Ø³ÙƒØ±ÙŠ'],['Insulin Resistance','Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†'],['Thyroid issues','Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØºØ¯Ø©'],['Hormonal issues','Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©'],['Fatty Liver','Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ'],['Joint/Knee problems','Ù…Ø´Ø§ÙƒÙ„ Ù…ÙØ§ØµÙ„/Ø±ÙƒØ¨'],['Heart disease','Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨'],['IBD/Ulcer','IBD/Ù‚Ø±Ø­Ø©'],['GERD/Reflux','GERD/Ø§Ø±ØªØ¬Ø§Ø¹'],['Gluten intolerance','Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†'],['Lactose intolerance','Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²']];
    el.innerHTML = `
      <div class="g">
        <div class="glass p-4 c1">
          <div class="section-title mb-2">${t('medicalStatus')}</div>
          <div class="grid md:grid-cols-2 gap-2 mb-2">
            ${items.map(([en,ar],i)=>{ const lab=(state.lang==='ar'?ar:en); const chkd=state.medical.conditions.includes(en);
              return `<label class="flex items-center gap-2"><input type="checkbox" id="cond-${i}" class="accent-[var(--brand-2)]" ${chkd?'checked':''}><span>${lab}</span></label>`; }).join('')}
          </div>
          ${Lbl(t('otherCond'),'otherCond',state.medical.other)} ${Lbl(t('currentMeds'),'meds',state.medical.meds)} ${Lbl(t('currentSupp'),'supps',state.medical.supplements)}
        </div>
        <div class="glass p-4 c2">
          ${Lbl(t('pastCh'),'past',state.challenges.past,'Ø¬ÙˆØ¹ Ø´Ø¯ÙŠØ¯â€¦')}
          <label class="block mb-2"><div class="mb-1">${t('motiv')}</div>
            <select id="motiv" class="field"><option value="Direct">${t('motivDir')}</option><option value="Warm">${t('motivWarm')}</option></select>
          </label>
        </div>
        <div class="glass p-4 c3">
          <div class="section-title mb-2">${t('plan')}</div>
          <div class="text-sm text-[color:var(--muted)]">${t('waitMsg')}</div>
        </div>
      </div>`;
    document.getElementById('motiv').value=state.challenges.motivation;
  }

  document.getElementById('live-hint').textContent=t('hint');
  document.getElementById('prev').disabled=(state.step===0);
  document.getElementById('next').disabled=(state.step===3);
}

function saveStep(){
  const $=id=>document.getElementById(id);
  if(state.step===0){
    state.profile.name=$('name').value.trim(); state.profile.age=$('age').value.trim();
    state.profile.height=$('height').value.trim(); state.profile.weight=$('weight').value.trim();
    state.profile.bodyFat=$('bodyFat').value.trim(); state.profile.waist=$('waist').value.trim();
    state.profile.sex=$('sex').value; state.profile.targetWeight=$('targetWeight').value.trim();
    state.profile.targetDate=$('targetDate').value;

    const goals=[]; ['fatLoss','build','strength','endurance','health'].forEach(id=>{ if($('g-'+id)?.checked) goals.push(id); });
    state.diet.goals=goals;
    state.diet.mealsPerDay=Number($('meals').value||3); state.diet.preferredDiet=$('prefDiet').value; state.diet.fasting=$('fasting').value;
    state.diet.cuisine=$('cuisine').value; state.diet.prepTime=Number($('prep').value||20);
    state.diet.monthlyBudget=Number($('budget').value||0); state.currency=$('currency').value;
    state.diet.foodsToAvoid=$('avoid').value; state.diet.allergies=$('allergies').value;

    state.lifestyle.workActivity=$('work').value; state.lifestyle.stepsPerDay=Number($('steps').value||6000);
    state.lifestyle.sleep=$('sleep').value; state.lifestyle.stress=$('stress').value;
    state.lifestyle.trainingPlace=$('place').value; state.lifestyle.sessionLength=Number($('session').value||60);
    state.lifestyle.availableDays=[]; for(let i=0;i<7;i++) if($('day-'+i)?.checked) state.lifestyle.availableDays.push(i);
    state.lifestyle.equipment=$('equip').value; state.lifestyle.experience=$('exp').value;
    state.lifestyle.rpe=Number($('rpe').value||8); state.lifestyle.caffeine=Number($('caf').value||0);
    state.lifestyle.injuries=$('inj').value;
  }
  if(state.step===1){ state.fitness.restingHR=$('q-hr').value; state.fitness.maxPushups=$('q-pu').value; state.fitness.plank=$('q-pl').value; state.fitness.kmTime=$('q-km').value; }
  if(state.step===2){ Object.keys(state.muscles).forEach(k=>{ const c=document.getElementById('m-'+k); const n=document.getElementById('mnote-'+k); if(c) state.muscles[k].on=c.checked; if(n) state.muscles[k].note=n.value; }); }
  if(state.step===3){
    const map=['Hypertension','Diabetes','Insulin Resistance','Thyroid issues','Hormonal issues','Fatty Liver','Joint/Knee problems','Heart disease','IBD/Ulcer','GERD/Reflux','Gluten intolerance','Lactose intolerance'];
    state.medical.conditions=[]; for(let i=0;i<12;i++){ const el=document.getElementById('cond-'+i); if(el && el.checked) state.medical.conditions.push(map[i]); }
    state.medical.other=$('otherCond').value; state.medical.meds=$('meds').value; state.medical.supplements=$('supps').value;
    state.challenges.past=$('past').value; state.challenges.motivation=$('motiv').value;
  }
}

/* ============================ BOARD ============================ */
function renderBoard(){
  const board=document.getElementById('sections-board'); board.innerHTML='';
  const list=state.sections.filter(s=> s!=='fasting' || state.diet.fasting!=='off');
  list.forEach(id=>{
    if(!state.sectionStatus[id]) state.sectionStatus[id]={status:'idle'};
    const st=state.sectionStatus[id].status;
    const color = st==='ok'?'var(--ok)':st==='fail'?'var(--err)':st==='run'?'var(--warn)':'#888';
    const el=document.createElement('button');
    el.className='badge'; el.innerHTML=`<span class="status-dot" style="background:${color}"></span><span>${pretty(id)}</span>`;
    el.onclick=()=>{ const card=document.getElementById('sec-'+id); if(card) card.scrollIntoView({behavior:'smooth',block:'center'}); };
    board.appendChild(el);
  });
}
const pretty=(id)=>{
  if(id==='welcome') return state.lang==='ar'?'Ø§Ù„ØªØ±Ø­ÙŠØ¨':'Welcome';
  if(id==='analysis') return state.lang==='ar'?'Ø§Ù„ØªØ­Ù„ÙŠÙ„':'Analysis';
  if(id==='allowed') return state.lang==='ar'?'Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹':'Allowed / Limits';
  if(id==='fasting') return state.lang==='ar'?'Ø§Ù„ØµÙŠØ§Ù…':'Fasting';
  if(id.startsWith('nutrition-day')) return (state.lang==='ar'?'Ø§Ù„ØªØºØ°ÙŠØ© â€” ÙŠÙˆÙ… ':'Nutrition â€” Day ')+id.split('-').pop();
  if(id.startsWith('training-day')) return (state.lang==='ar'?'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ â€” ÙŠÙˆÙ… ':'Training â€” Day ')+id.split('-').pop();
  if(id==='supplements') return state.lang==='ar'?'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª':'Supplements';
  if(id==='progression') return state.lang==='ar'?'Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…':'Progression';
  if(id==='troubleshoot') return state.lang==='ar'?'Ø§Ù„Ù…Ø´Ø§ÙƒÙ„':'Troubleshooting';
  if(id==='safety') return state.lang==='ar'?'Ø§Ù„Ø³Ù„Ø§Ù…Ø©':'Safety';
  if(id==='closing') return state.lang==='ar'?'Ø§Ù„Ø®ØªØ§Ù…':'Closing';
  return id;
};

/* ============================ TARGETS & PROMPTS ============================ */
function computeTargets(){
  const p=state.profile, L=state.lifestyle, D=state.diet; const W=+p.weight||0, H=+p.height||0, A=+p.age||0;
  const male=(p.sex==='Male'||p.sex===t('male'));
  const BMR= male? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161;
  const act={'Sedentary':1.2,'Light':1.35,'Moderate':1.5,'High':1.7}[L.workActivity] || 1.35;
  let TDEE=BMR*act; if(D.goals.includes('fatLoss')) TDEE*=0.86; if(D.goals.includes('build')) TDEE*=1.10;
  const targetW=Number(p.targetWeight)||W||1; let protein=Math.round(2.0*targetW); let fat=Math.round(Math.max(0.8*W,40));
  let carbs=Math.round((TDEE - (protein*4 + fat*9))/4); const hasIR=state.medical.conditions.includes('Diabetes')||state.medical.conditions.includes('Insulin Resistance');
  if(hasIR) carbs=Math.min(carbs,120); carbs=Math.max(40,carbs);
  return { bmr:Math.round(BMR), tdee:Math.round(TDEE), protein_g:protein, fat_g:fat, carb_g:carbs };
}
function headerBlock(){
  const P=state.profile, D=state.diet, L=state.lifestyle, F=state.fitness;
  const weak=Object.entries(state.muscles).filter(([k,v])=>v.on).map(([k,v])=>`${k}: ${v.note}`).join(', ')||'None';
  const med=state.medical.conditions.join(', ')||'None';
  const days=(state.lang==='ar'?['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©']:['Sat','Sun','Mon','Tue','Wed','Thu','Fri']);
  const avail=L.availableDays.map(i=>days[i]).join(', ') || (state.lang==='ar'?'ØºÙŠØ± Ù…Ø­Ø¯Ø¯':'Not specified');
  const tone=state.challenges.motivation==='Direct'?(state.lang==='ar'?'Ø¹Ù…Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø± Ø¨Ù„Ø§ Ù…Ø¨Ø§Ù„ØºØ©':'Pragmatic, direct, no fluff'):(state.lang==='ar'?'ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…':'Supportive & warm');
  const T=state.targets; const goalsLocalized=state.diet.goals.map(id=>t(id)).join(', ');
  return `Name:${P.name} | Sex:${P.sex} | Age:${P.age} | H:${P.height}cm | W:${P.weight}kg
Goals:${goalsLocalized} | Diet:${D.preferredDiet} | Meals:${D.mealsPerDay} | Fast:${D.fasting}
Cuisine:${D.cuisine} | Prep:${D.prepTime}min | Budget:${state.currency} ${D.monthlyBudget}
Activity:${L.workActivity} | Steps:${L.stepsPerDay} | Sleep:${L.sleep} | Stress:${L.stress}
Training:${L.trainingPlace} | Session:${L.sessionLength}min | Days:${avail} | RPE:${L.rpe} | Equip:${L.equipment||'Bodyweight'}
Fitness: HR ${F.restingHR||'?'}; PU ${F.maxPushups||'?'}; Plank ${F.plank||'?'}; 1km ${F.kmTime||'?'}
Weak:${weak} | Injuries:${L.injuries||'None'} | Medical:${med}
Targets: ~${T.tdee} kcal; P ${T.protein_g}g / F ${T.fat_g}g / C ${T.carb_g}g
Tone:${tone}. LANGUAGE:${state.lang}. FOOD in ${state.lang}. Exercises EN only.`.trim();
}
function promptFor(section){
  const H=headerBlock();
  const noBrief = state.lang==='ar'
    ? '\n\nÙ„Ø§ ØªØ®ØªØµØ±. Ø§ÙƒØªØ¨ Ù…Ø®Ø±Ø¬Ø§Øª ØªÙØµÙŠÙ„ÙŠØ© Ø´Ø§Ù…Ù„Ø© Ù…Ø¹ Ù‚ÙˆØ§Ø¦Ù…/Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ø¶Ø­Ø© ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø·Ù„ÙˆØ¨. ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø².'
    : '\n\nDo NOT summarize. Provide a comprehensive, fully detailed output with explicit lists/tables as instructed. Avoid brevity.';
  if(section==='welcome') return `${H}\n\nCreate a short ${state.lang} welcome. Professional, one paragraph.${noBrief}`;
  if(section==='analysis') return `${H}\n\nWrite a detailed ${state.lang} analysis (bullets) with plan logic and macros.${noBrief}`;
  if(section==='allowed') return `${H}\n\nTwo lists in ${state.lang}: (1) Allowed/Recommended by cuisine. (2) Limits/Avoid (respect allergies/dislikes). Practical.${noBrief}`;
  if(section==='fasting' && state.diet.fasting!=='off') return `${H}\n\nExplain in ${state.lang} Intermittent Fasting (${state.diet.fasting}) safely: timing, hydration, caffeine, training window.${noBrief}`;

  if(section.startsWith('nutrition-day')){
    const day=+section.split('-').pop();
    return `${H}

STRICT OUTPUT: Markdown table ONLY. No prose, no bullets, no explanations.
Columns: | Meal | Ingredients (g) | kcal | Protein | Fat | Carbs |
Rows: 3 main meals + TOTAL row only (4 rows total).
Daily macros MUST be within Â±10% of Targets at the end row.
Language: ${state.lang}. Use local Arabic dish names if lang=ar.
Day ${day} of 7.${noBrief}`; }

  if(section.startsWith('training-day')){
    const day=+section.split('-').pop();
    return `${H}

STRICT OUTPUT: Markdown table ONLY.
Columns: | Day | Exercise | Sets | Reps | Rest (sec) |
Include warm-up as first row if needed. Respect injuries and focus weak muscles.
Day ${day} of 7.${noBrief}`; }

  if(section==='supplements') return `${H}\n\nEvidence-based supplements in ${state.lang}: essential, goal-specific, budget. Doses & timing. Medical disclaimer.${noBrief}`;
  if(section==='progression') return `${H}\n\n8â€“12 week progression in ${state.lang}: adjust weights/reps/rest, deloads, cardio, TDEE recalculation. Bullets.${noBrief}`;
  if(section==='troubleshoot') return `${H}\n\nTroubleshooting in ${state.lang}: hunger, plateaus, poor sleep, stress, cravings, travel/eating out. 2â€“3 bullets each.${noBrief}`;
  if(section==='safety') return `${H}\n\nSafety notes in ${state.lang}: technique, injury prevention, hydration, sleep, when to stop and seek medical help.${noBrief}`;
  if(section==='closing') return `${H}\n\nShort motivating closing in ${state.lang} addressing user by name.${noBrief}`;
  return H + noBrief;
}

/* ============================ API ============================ */
async function callAI(prompt, params = {}, { attempts = 2, sectionId = "" } = {}) {
  const body = JSON.stringify({ prompt, section: sectionId, ...params });
  for (let i = 0; i < attempts; i++) {
    try {
      const r = await fetch(ENDPOINT, { method:'POST', headers:{'content-type':'application/json'}, body });
      const raw = await r.text();
      let data = null; try { data = JSON.parse(raw); } catch {}
      if (!r.ok) throw new Error((data && (data.error || data.details || data.message)) || raw.slice(0, 400));
      const text = (data && data.text) ? String(data.text).trim() : "";
      if (!text || /^<!doctype/i.test(text)) throw new Error('Invalid response body');
      return { ok:true, text };
    } catch (e) {
      if (i < attempts - 1) await new Promise(res => setTimeout(res, 1200*(i+1)));
    }
  }
  return { ok:false, error:`Endpoint failed: ${ENDPOINT}` };
}

/* Params â€” LONG for ALL */
function paramsFor(sectionId){
  return {
    response_mime_type: "text/markdown",
    model: "gemini-1.5-pro",
    temperature: 0.35,
    top_p: 0.9,
    max_output_tokens: 8192
  };
}

/* Nutrition fallback (optional; still present for resilience) */
async function generateNutritionFallback(sectionId){
  const day = +sectionId.split('-').pop();
  const base = headerBlock();
  const params = paramsFor(sectionId);

  const p1 = `${base}

OUTPUT: Markdown table ONLY with 2 meals (Breakfast + Lunch).
Columns: | Meal | Ingredients (g) | kcal | Protein | Fat | Carbs |
Language: ${state.lang}. Day ${day} (part 1 of 2).`;

  const p2 = `${base}

OUTPUT: Markdown table ONLY with 1 meal (Dinner).
Columns: | Meal | Ingredients (g) | kcal | Protein | Fat | Carbs |
Language: ${state.lang}. Day ${day} (part 2 of 2).`;

  const [r1, r2] = await Promise.all([
    callAI(p1, params, { attempts: 2, sectionId }),
    callAI(p2, params, { attempts: 2, sectionId })
  ]);

  if(!(r1.ok && r2.ok)) return { ok:false, error: (r1.error||'') + ' ' + (r2.error||'') };

  const totalPrompt = `${base}

You are given the rows below as Markdown rows (without header).
Compute a TOTAL row (kcal, Protein, Fat, Carbs) and return ONLY the TOTAL row.
Rows:
${r1.text}\n${r2.text}`;

  const rTotal = await callAI(totalPrompt, params, { attempts: 2, sectionId });
  if(!rTotal.ok) return { ok:false, error:rTotal.error };

  const merged = r1.text.trim() + "\n" + r2.text.trim() + "\n" + rTotal.text.trim();
  return { ok:true, text: merged };
}

/* ============================ GENERATION ============================ */
function ensureTargets(){ state.targets=computeTargets(); }
function planCard(sectionId){
  const wrap=document.getElementById('plan-content');
  const card=document.createElement('div'); card.className='glass p-4'; card.id='sec-'+sectionId;
  card.innerHTML=`
    <div class="flex items-center justify-between mb-2">
      <div class="section-title">${pretty(sectionId)}</div>
      <button class="chip" id="retry-${sectionId}" style="display:none;">âŸ³ ${t('retry')}</button>
    </div>
    <div class="text-xs text-[color:var(--muted)]" id="note-${sectionId}">${t('gen')}</div>
    <div class="w-full progress my-2"><i id="bar-${sectionId}" style="width:0%"></i></div>
    <div id="body-${sectionId}" class="ai-content"></div>
    <div class="text-xs text-[color:var(--muted)] mt-2" id="err-${sectionId}"></div>`;
  wrap.appendChild(card);
  document.getElementById('retry-'+sectionId).onclick=()=>regenerateSection(sectionId);
  return card;
}
function setSectionStatus(id,status,err){
  state.sectionStatus[id]={status,error:err}; renderBoard();
  const dot=document.getElementById('run-dot');
  if(status==='run'){ dot.style.background='var(--warn)'; document.getElementById('run-label').textContent=t('gen'); }
  if(status==='ok'){ dot.style.background='var(--ok)'; document.getElementById('run-label').textContent=t('done'); }
  if(status==='fail'){ dot.style.background='var(--err)'; document.getElementById('run-label').textContent=t('failed'); }
}
function updateGlobalProgress(pct){
  document.getElementById('run-progress').style.width=pct+'%';
  document.getElementById('global-progress').style.width=pct+'%';
  document.getElementById('run-msg').textContent=Math.round(pct)+'% â€” '+t('waitMsg');
}

async function generateAllSequential(){
  saveStep(); ensureTargets();
  document.getElementById('plan-content').innerHTML='';
  const all=state.sections.filter(s=> s!=='fasting' || state.diet.fasting!=='off');
  for(let i=0;i<all.length;i++){
    const s=all[i]; await generateOne(s, (i/all.length)*100, ((i+1)/all.length)*100);
  }
  updateGlobalProgress(100);
}
async function generateOne(sectionId,startPct,endPct){
  setSectionStatus(sectionId,'run'); planCard(sectionId);
  const bodyEl=document.getElementById('body-'+sectionId);
  const noteEl=document.getElementById('note-'+sectionId);
  const barEl=document.getElementById('bar-'+sectionId); noteEl.textContent=t('gen');

  let r = await callAI(promptFor(sectionId), paramsFor(sectionId), { attempts: 2, sectionId });

  if(!r.ok && sectionId.startsWith('nutrition-day')){
    r = await generateNutritionFallback(sectionId);
  }

  if(!r.ok){
    setSectionStatus(sectionId,'fail',r.error);
    document.getElementById('err-'+sectionId).textContent=r.error||'Failed';
    document.getElementById('retry-'+sectionId).style.display='inline-flex';
    barEl.style.width=(startPct+(endPct-startPct)*0.2)+'%';
    return;
  }
  bodyEl.innerHTML=marked.parse(r.text); noteEl.textContent=t('done'); barEl.style.width='100%';
  setSectionStatus(sectionId,'ok'); updateGlobalProgress(endPct);
}
async function regenerateSection(sectionId){
  const card=document.getElementById('sec-'+sectionId); if(card) card.remove();
  await generateOne(sectionId, 0, 5);
}

/* ============================ EVENTS ============================ */
document.getElementById('next').onclick=()=>{ saveStep(); state.step=Math.min(3,state.step+1); renderStep(); };
document.getElementById('prev').onclick=()=>{ saveStep(); state.step=Math.max(0,state.step-1); renderStep(); };
document.getElementById('generate-current').onclick=()=>generateAllSequential();
document.getElementById('btn-print').onclick=()=>window.print();
document.getElementById('print-bottom').onclick=()=>window.print();
document.getElementById('scroll-top').onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
document.getElementById('lang-ar').onclick=()=>setLang('ar');
document.getElementById('lang-en').onclick=()=>setLang('en');
document.getElementById('toggle-theme').onclick=()=>setTheme(state.theme==='dark'?'light':'dark');

/* ============================ INIT ============================ */
window.addEventListener('load', ()=>{
  setLang(state.lang); setTheme('dark'); renderStep(); renderBoard();
  document.getElementById('run-label').textContent=t('idle');
  document.getElementById('hint').textContent=t('hint');
});
</script>
</body>
</html>
