<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ | Intelligent Health Coach</title>

<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet"/>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>

<style>
:root{
  --brand:#6c5ce7; --brand2:#00c2ff; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
  --bg1:#0a0f1c; --bg2:#0e1526; --fg:#eaf0ff; --muted:#93a2b8;
  --card1:rgba(255,255,255,.08); --card2:rgba(255,255,255,.03);
  --border:rgba(255,255,255,.12); --field:rgba(255,255,255,.06);
}
body.light{
  --bg1:#eef2ff; --bg2:#f7f9ff; --fg:#0b1220; --muted:#4b5563;
  --card1:#ffffff; --card2:#ffffff; --border:#d1d5db; --field:#ffffff;
}
html[dir="rtl"] body{font-family:Tajawal,system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",sans-serif}
html[dir="ltr"] body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
body{background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%);color:var(--fg)}
.glass{background:linear-gradient(180deg,var(--card1),var(--card2));border:1px solid var(--border);border-radius:16px}
.btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.8rem;font-weight:800;padding:.7rem 1rem}
.btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff}
.btn-ghost{background:var(--field);border:1px solid var(--border);color:var(--fg)}
.field{background:var(--field);border:1px solid var(--border);border-radius:.7rem;padding:.6rem .8rem;outline:none;width:100%;color:var(--fg)}
.field:focus{border-color:var(--brand2);box-shadow:0 0 0 3px rgba(0,194,255,.15)}
.chip{background:var(--field);border:1px solid var(--border);color:var(--fg);border-radius:999px;padding:.35rem .6rem;font-size:.78rem}
.title-grad{background:linear-gradient(90deg,var(--brand),var(--brand2));-webkit-background-clip:text;background-clip:text;color:transparent}
.progress{height:.4rem;background:rgba(127,127,127,.15);border-radius:999px;overflow:hidden}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2));width:0%;transition:width .25s}
.status{width:.6rem;height:.6rem;border-radius:999px;background:#94a3b8}
.status.run{background:var(--warn)} .status.ok{background:var(--ok)} .status.fail{background:var(--err)}
.ai-content h2{font-weight:900;font-size:1.25rem;margin:.5rem 0}
.ai-content h3{font-weight:800;font-size:1.05rem;margin:.45rem 0}
.ai-content table{width:100%;border-collapse:collapse;margin:.6rem 0}
.ai-content th,.ai-content td{border:1px solid var(--border);padding:.5rem;vertical-align:top}
.ai-content th{background:rgba(255,255,255,.06)}

#overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(9,12,20,.55);backdrop-filter:blur(6px);z-index:60}
#overlay .card{width:min(92vw,520px)}
@media print{#topbar,#sticky,#form,#actions{display:none!important} body{background:#fff;color:#111}}
</style>
</head>
<body>

<!-- Topbar -->
<header id="topbar" class="sticky top-0 z-40 glass backdrop-blur">
  <div class="max-w-6xl mx-auto px-3 md:px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-[var(--brand)] to-[var(--brand2)] grid place-items-center font-black">AI</div>
      <div>
        <div id="app-title" class="text-base md:text-lg font-extrabold">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ</div>
        <div id="subtitle" class="hidden md:block text-xs" style="color:var(--muted)">Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù % Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ø®ØµØµØ© Ù„Ùƒ</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn-ar" class="chip" type="button">Ø¹Ø±Ø¨ÙŠ</button>
      <button id="btn-en" class="chip" type="button">EN</button>
      <button id="btn-theme" class="chip" type="button">â˜€/â˜¾</button>
      <button id="btn-print" class="btn btn-ghost" type="button">ğŸ–¨ <span id="t-print">Ø·Ø¨Ø§Ø¹Ø©</span></button>
    </div>
  </div>
  <div id="sticky" class="border-t">
    <div class="max-w-6xl mx-auto px-3 md:px-4 py-2 flex items-center justify-between gap-3">
      <div id="hint" class="text-xs" style="color:var(--muted)">Ø§Ù„ØªÙ‚Ø¯Ù…</div>
      <div class="w-40 md:w-60 progress" aria-valuemin="0" aria-valuemax="100"><i id="bar"></i></div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-3 md:px-4 py-5">

  <!-- ====== FORM ====== -->
  <section id="form" class="glass p-4 md:p-5 mb-4">
    <div class="text-xl title-grad font-extrabold mb-3" id="form-title">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
      <!-- Profile -->
      <div class="glass p-4">
        <div class="font-extrabold mb-2" id="lbl-prof">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
        <div class="space-y-2">
          <label class="block text-sm"><span id="l-name">Ø§Ù„Ø§Ø³Ù…</span><input id="name" class="field mt-1" placeholder="Ø§Ù„Ø§Ø³Ù…"/></label>
          <div class="grid grid-cols-2 gap-2">
            <label class="block text-sm"><span id="l-age">Ø§Ù„Ø¹Ù…Ø±</span><input id="age" class="field mt-1" inputmode="numeric"/></label>
            <label class="block text-sm"><span id="l-sex">Ø§Ù„Ø¬Ù†Ø³</span>
              <select id="sex" class="field mt-1"><option value="Male">Ø°ÙƒØ±</option><option value="Female">Ø£Ù†Ø«Ù‰</option></select>
            </label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block text-sm"><span id="l-h">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</span><input id="height" class="field mt-1" inputmode="numeric"/></label>
            <label class="block text-sm"><span id="l-w">Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</span><input id="weight" class="field mt-1" inputmode="numeric"/></label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block text-sm"><span id="l-bf">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† % (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span><input id="bodyFat" class="field mt-1" inputmode="numeric"/></label>
            <label class="block text-sm"><span id="l-waist">Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ± (Ø³Ù…) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span><input id="waist" class="field mt-1" inputmode="numeric"/></label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block text-sm"><span id="l-tw">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (ÙƒØº)</span><input id="targetWeight" class="field mt-1" inputmode="numeric"/></label>
            <label class="block text-sm"><span id="l-td">Ù…ÙˆØ¹Ø¯ ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù</span><input id="targetDate" type="date" class="field mt-1"/></label>
          </div>
        </div>
      </div>

      <!-- Diet -->
      <div class="glass p-4">
        <div class="font-extrabold mb-2" id="lbl-diet">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª</div>
        <div class="space-y-2">
          <div class="text-sm" id="l-goals">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ù…ØªØ¹Ø¯Ø¯)</div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <label><input type="checkbox" class="goal" value="fatLoss"/> <span id="g1">Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†</span></label>
            <label><input type="checkbox" class="goal" value="build"/> <span id="g2">Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª</span></label>
            <label><input type="checkbox" class="goal" value="strength"/> <span id="g3">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©</span></label>
            <label><input type="checkbox" class="goal" value="endurance"/> <span id="g4">ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„</span></label>
            <label><input type="checkbox" class="goal" value="health"/> <span id="g5">ØµØ­Ø© Ø¹Ø§Ù…Ø©</span></label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block text-sm"><span id="l-meals">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</span><input id="meals" class="field mt-1" value="3" inputmode="numeric"/></label>
            <label class="block text-sm"><span id="l-pref">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù‘Ù„</span>
              <select id="prefDiet" class="field mt-1">
                <option value="Balanced">Ù†Ø¸Ø§Ù… Ù…ØªÙˆØ§Ø²Ù†</option><option value="LowCarb">Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª</option>
                <option value="Keto">ÙƒÙŠØªÙˆ</option><option value="Arabic/Mediter.">Ù…ØªÙˆØ³Ø·ÙŠ/Ø¹Ø±Ø¨ÙŠ</option><option value="Plant">Ù†Ø¨Ø§ØªÙŠ/Ù…Ø±Ù†</option>
              </select>
            </label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block text-sm"><span id="l-if">Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹</span>
              <select id="fasting" class="field mt-1"><option value="off">ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</option><option>16:8</option><option>18:6</option><option>20:4</option></select>
            </label>
            <label class="block text-sm"><span id="l-cuisine">Ø§Ù„Ù…Ø·Ø¨Ø®</span><input id="cuisine" class="field mt-1" value="Arabic/Mediter."/></label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block text-sm"><span id="l-prep">Ø²Ù…Ù† Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø¯)</span><input id="prep" class="field mt-1" value="20" inputmode="numeric"/></label>
            <label class="block text-sm"><span id="l-budget">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</span>
              <div class="flex gap-2 mt-1">
                <input id="budget" class="field flex-1" value="0" inputmode="numeric"/>
                <select id="currency" class="field w-28">
                  <option>USD</option><option>EUR</option><option>GBP</option><option>SAR</option><option>AED</option><option>KWD</option><option>QAR</option><option>EGP</option>
                </select>
              </div>
            </label>
          </div>
          <label class="block text-sm"><span id="l-avoid">Ø£Ø·Ø¹Ù…Ø© Ù„Ø§ ØªØ±ØºØ¨ Ø¨Ù‡Ø§/Ø­Ø³Ø§Ø³ÙŠØ§Øª</span><input id="avoid" class="field mt-1" placeholder="Ù…Ø«Ø§Ù„: Ù„Ø§ Ø£Ø­Ø¨ Ø§Ù„Ø³Ù…ÙƒØŒ Ø­Ø³Ø§Ø³ÙŠØ© ÙØ³ØªÙ‚â€¦"/></label>
          <label class="block text-sm"><span id="l-allergy">Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø´Ø§Ø¦Ø¹Ø©</span><input id="allergies" class="field mt-1" placeholder="Gluten, Lactose, Nutsâ€¦"/></label>
        </div>
      </div>

      <!-- Life + Medical -->
      <div class="space-y-3">
        <div class="glass p-4">
          <div class="font-extrabold mb-2" id="lbl-life">Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨</div>
          <div class="space-y-2">
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm"><span id="l-work">Ø§Ù„Ø¹Ù…Ù„/Ø§Ù„Ù†Ø´Ø§Ø·</span>
                <select id="work" class="field mt-1"><option value="Sedentary">Ù…ÙƒØªØ¨ÙŠ</option><option value="Light">Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ</option><option value="Moderate">Ù…ØªÙˆØ³Ø·</option><option value="High">Ù…Ø±ØªÙØ¹</option></select>
              </label>
              <label class="block text-sm"><span id="l-steps">Ø®Ø·ÙˆØ§Øª/Ø§Ù„ÙŠÙˆÙ…</span><input id="steps" class="field mt-1" value="6000" inputmode="numeric"/></label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm"><span id="l-sleep">Ø§Ù„Ù†ÙˆÙ…</span><select id="sleep" class="field mt-1"><option>Low</option><option>Medium</option><option>High</option></select></label>
              <label class="block text-sm"><span id="l-stress">Ø§Ù„ØªÙˆØªØ±</span><select id="stress" class="field mt-1"><option>Low</option><option>Medium</option><option>High</option></select></label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm"><span id="l-place">Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ…Ø±ÙŠÙ†</span><input id="place" class="field mt-1" value="Home/Gym"/></label>
              <label class="block text-sm"><span id="l-session">Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯)</span><input id="session" class="field mt-1" value="60" inputmode="numeric"/></label>
            </div>
            <div class="text-sm" id="l-days">Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
            <div class="grid grid-cols-7 gap-2 text-xs">
              <label class="chip"><input type="checkbox" id="d0" class="me-1"/> Ø³</label>
              <label class="chip"><input type="checkbox" id="d1" class="me-1"/> Ø­</label>
              <label class="chip"><input type="checkbox" id="d2" class="me-1"/> Ù†</label>
              <label class="chip"><input type="checkbox" id="d3" class="me-1"/> Ø«</label>
              <label class="chip"><input type="checkbox" id="d4" class="me-1"/> Ø±</label>
              <label class="chip"><input type="checkbox" id="d5" class="me-1"/> Ø®</label>
              <label class="chip"><input type="checkbox" id="d6" class="me-1"/> Ø¬</label>
            </div>
            <label class="block text-sm"><span id="l-equip">Ø§Ù„Ù…Ø¹Ø¯Ø§Øª</span><input id="equip" class="field mt-1" placeholder="Dumbbells, barbell, bandsâ€¦"/></label>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm"><span id="l-exp">Ø§Ù„Ø®Ø¨Ø±Ø©</span><select id="exp" class="field mt-1"><option>Beginner (0-6m)</option><option>Intermediate (6-24m)</option><option>Advanced (24m+)</option></select></label>
              <label class="block text-sm"><span id="l-rpe">RPE</span><input id="rpe" class="field mt-1" value="8" inputmode="numeric"/></label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm"><span id="l-caf">ÙƒØ§ÙÙŠÙŠÙ†/Ø§Ù„ÙŠÙˆÙ…</span><input id="caf" class="field mt-1" value="0" inputmode="numeric"/></label>
              <label class="block text-sm"><span id="l-inj">Ø¥ØµØ§Ø¨Ø§Øª/Ù‚ÙŠÙˆØ¯</span><input id="inj" class="field mt-1" placeholder="Shoulder impingementâ€¦"/></label>
            </div>
          </div>
        </div>

        <div class="glass p-4">
          <div class="font-extrabold mb-2" id="lbl-med">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª</div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <label><input type="checkbox" class="cond" value="Hypertension"/> Ø¶ØºØ· Ø§Ù„Ø¯Ù…</label>
            <label><input type="checkbox" class="cond" value="Diabetes"/> Ø§Ù„Ø³ÙƒØ±ÙŠ</label>
            <label><input type="checkbox" class="cond" value="Insulin Resistance"/> Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†</label>
            <label><input type="checkbox" class="cond" value="Thyroid issues"/> Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØºØ¯Ø©</label>
            <label><input type="checkbox" class="cond" value="Hormonal issues"/> Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©</label>
            <label><input type="checkbox" class="cond" value="Fatty Liver"/> Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ</label>
            <label><input type="checkbox" class="cond" value="Joint/Knee problems"/> Ù…ÙØ§ØµÙ„/Ø±ÙƒØ¨</label>
            <label><input type="checkbox" class="cond" value="Heart disease"/> Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨</label>
            <label><input type="checkbox" class="cond" value="IBD/Ulcer"/> IBD/Ù‚Ø±Ø­Ø©</label>
            <label><input type="checkbox" class="cond" value="GERD/Reflux"/> GERD/Ø§Ø±ØªØ¬Ø§Ø¹</label>
            <label><input type="checkbox" class="cond" value="Gluten intolerance"/> Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†</label>
            <label><input type="checkbox" class="cond" value="Lactose intolerance"/> Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²</label>
          </div>
          <div class="mt-2 space-y-2">
            <label class="block text-sm"><span id="l-other">Ø£Ù…Ø±Ø§Ø¶ Ø£Ø®Ø±Ù‰</span><input id="otherCond" class="field mt-1"/></label>
            <label class="block text-sm"><span id="l-meds">Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ©</span><input id="meds" class="field mt-1"/></label>
            <label class="block text-sm"><span id="l-supps">Ù…ÙƒÙ…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ©</span><input id="supps" class="field mt-1"/></label>
            <label class="block text-sm"><span id="l-past">ØªØ­Ø¯ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©</span><input id="past" class="field mt-1" placeholder="Ø¬ÙˆØ¹ Ø´Ø¯ÙŠØ¯ØŒ Ù…Ù„Ù„â€¦"/></label>
            <label class="block text-sm"><span id="l-motiv">Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØ­ÙÙŠØ²</span><select id="motiv" class="field mt-1"><option value="Direct">Ø¹Ù…Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±</option><option value="Warm">ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…</option></select></label>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="mt-4 flex items-center justify-between">
        <button id="btn-generate-all" class="btn btn-primary">âš¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© ÙƒØ§Ù…Ù„Ø©</button>
        <div class="flex items-center gap-2">
          <button id="btn-save" class="btn btn-ghost">ğŸ’¾ Ø­ÙØ¸</button>
          <button id="btn-print-form" class="btn btn-ghost">ğŸ–¨</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ====== PROGRESS TIMELINE ====== -->
  <section class="glass p-4 md:p-5 mb-4">
    <div class="font-extrabold mb-2" id="sectionsTitle">ØªÙ‚Ø¯Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
    <div id="timeline" class="flex flex-wrap gap-2 text-xs"></div>
  </section>

  <!-- ====== PLAN RESULT (hidden until finish) ====== -->
  <section id="result" class="glass p-4 md:p-5 hidden">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-extrabold" id="resultTitle">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
      <div class="flex items-center gap-2">
        <button class="btn btn-ghost" id="btn-top">â†‘ Ø£Ø¹Ù„Ù‰</button>
        <button class="btn btn-primary" id="btn-print">ğŸ–¨ PDF / Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    </div>
    <div id="plan-content" class="ai-content"></div>
  </section>

  <footer class="text-center text-[.85rem] mt-6" style="color:var(--muted)">
    Powered by <strong>Coach Mustafa Elsafy</strong> â€” Ø§Ù„Ù…Ø¯Ø±Ø¨ <strong>Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ</strong> Â© 2025
  </footer>
</main>

<!-- Overlay -->
<div id="overlay">
  <div class="glass card p-5 text-center">
    <div class="mx-auto mb-3 w-10 h-10 rounded-full border-4 border-white/30 border-t-[var(--brand2)] animate-spin"></div>
    <div id="ov-title" class="font-extrabold mb-1">Ù†Ø¬Ù‡Ù‘Ø² Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†</div>
    <div id="ov-sub" class="text-sm" style="color:var(--muted)">Ù†ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­ØªÙ‰ ØªÙƒØªÙ…Ù„ Ø§Ù„Ø®Ø·Ø©â€¦</div>
    <div class="mt-3 progress w-64 mx-auto"><i id="ov-bar"></i></div>
  </div>
</div>

<script>
/* ====== Setup ====== */
const hasMD=!!window.marked, purifier=window.DOMPurify;
if(hasMD){ try{ marked.setOptions({breaks:true,mangle:false,headerIds:false}); }catch{} }
const $=id=>document.getElementById(id);
const KEY='ihc.form.v2';

const S={lang:(navigator.language||'ar').startsWith('ar')?'ar':'en', theme:'dark', data:{}, results:{}, statuses:{}, sectionList:[]};

/* ====== I18N ====== */
const I18N={
  ar:{app:'Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ',sub:'Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù % Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ø®ØµØµØ© Ù„Ùƒ',print:'Ø·Ø¨Ø§Ø¹Ø©',progress:'Ø§Ù„ØªÙ‚Ø¯Ù…',
      formTitle:'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',sectionsTitle:'ØªÙ‚Ø¯Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù…',result:'Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©',
      ok:'ØªÙ…',run:'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',fail:'ÙØ´Ù„',retry:'Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…',need:'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ø·ÙˆÙ„/Ø§Ù„ÙˆØ²Ù†.',
      secT:{welcome:'Ø§Ù„ØªØ±Ø­ÙŠØ¨',analysis:'Ø§Ù„ØªØ­Ù„ÙŠÙ„',allowed:'Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹',fasting:'Ø§Ù„ØµÙŠØ§Ù…',nutrition:'Ø§Ù„ØªØºØ°ÙŠØ© â€” ÙŠÙˆÙ…',training:'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ â€” ÙŠÙˆÙ…',supplements:'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª',progression:'Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…',troubleshoot:'Ø§Ù„Ù…Ø´Ø§ÙƒÙ„',safety:'Ø§Ù„Ø³Ù„Ø§Ù…Ø©',closing:'Ø§Ù„Ø®ØªØ§Ù…'}
  },
  en:{app:'Intelligent Health Coach',sub:'100% precise plan for nutrition, training & supplements â€“ fully personalized',print:'Print',progress:'Progress',
      formTitle:'Profile',sectionsTitle:'Section progress',result:'Final Plan',
      ok:'Done',run:'Running',fail:'Failed',retry:'Regenerate this section',need:'Please complete: name/age/height/weight.',
      secT:{welcome:'Welcome',analysis:'Analysis',allowed:'Allowed / Limits',fasting:'Intermittent fasting',nutrition:'Nutrition â€” Day',training:'Training â€” Day',supplements:'Supplements',progression:'Progression',troubleshoot:'Troubleshooting',safety:'Safety',closing:'Closing'}
  }
};
function applyLang(){
  const t=I18N[S.lang]; const st=t.secT;
  document.documentElement.lang=S.lang;
  document.documentElement.dir=(S.lang==='ar')?'rtl':'ltr';
  $('app-title').textContent=t.app; $('subtitle').textContent=t.sub; $('t-print').textContent=t.print;
  $('hint').textContent=t.progress; $('form-title').textContent=t.formTitle; $('sectionsTitle').textContent=t.sectionsTitle; $('resultTitle').textContent=t.result;
  // rebuild timeline labels
  buildTimeline(S.sectionList, st);
}

/* ====== Form read/save ====== */
function saveForm(){
  const goals=[...document.querySelectorAll('.goal')].filter(x=>x.checked).map(x=>x.value);
  const cond=[...document.querySelectorAll('.cond')].filter(x=>x.checked).map(x=>x.value);
  const days=[]; for(let i=0;i<7;i++) if($('d'+i).checked) days.push(i);
  S.data={
    profile:{name:$('name').value.trim(),age:$('age').value.trim(),height:$('height').value.trim(),weight:$('weight').value.trim(),bodyFat:$('bodyFat').value.trim(),waist:$('waist').value.trim(),sex:$('sex').value,targetWeight:$('targetWeight').value.trim(),targetDate:$('targetDate').value},
    diet:{goals,mealsPerDay:+($('meals').value||3),preferredDiet:$('prefDiet').value,cuisine:$('cuisine').value,prepTime:+($('prep').value||20),monthlyBudget:+($('budget').value||0),foodsToAvoid:$('avoid').value,allergies:$('allergies').value,fasting:$('fasting').value},
    lifestyle:{workActivity:$('work').value,stepsPerDay:+($('steps').value||6000),sleep:$('sleep').value,stress:$('stress').value,trainingPlace:$('place').value,sessionLength:+($('session').value||60),availableDays:days,equipment:$('equip').value,experience:$('exp').value,rpe:+($('rpe').value||8),caffeine:+($('caf').value||0),injuries:$('inj').value},
    medical:{conditions:cond,other:$('otherCond').value,meds:$('meds').value,supplements:$('supps').value},
    challenges:{past:$('past').value,motivation:$('motiv').value},
    currency:$('currency').value
  };
  localStorage.setItem(KEY, JSON.stringify(S.data));
}
function loadForm(){
  try{
    const v=JSON.parse(localStorage.getItem(KEY)||'{}'); if(!v.profile) return;
    const set=(id,val)=>{ const el=$(id); if(el && val!=null) el.value=val; };
    set('name',v.profile.name); set('age',v.profile.age); set('height',v.profile.height); set('weight',v.profile.weight);
    set('bodyFat',v.profile.bodyFat); set('waist',v.profile.waist); set('sex',v.profile.sex); set('targetWeight',v.profile.targetWeight); set('targetDate',v.profile.targetDate);
    (v.diet?.goals||[]).forEach(g=>{ const el=[...document.querySelectorAll('.goal')].find(x=>x.value===g); if(el) el.checked=true; });
    set('meals',v.diet?.mealsPerDay); set('prefDiet',v.diet?.preferredDiet); set('cuisine',v.diet?.cuisine); set('prep',v.diet?.prepTime);
    set('budget',v.diet?.monthlyBudget); set('avoid',v.diet?.foodsToAvoid); set('allergies',v.diet?.allergies); set('fasting',v.diet?.fasting); set('currency',v.currency);
    (v.lifestyle?.availableDays||[]).forEach(i=>{ const el=$('d'+i); if(el) el.checked=true; });
    set('work',v.lifestyle?.workActivity); set('steps',v.lifestyle?.stepsPerDay); set('sleep',v.lifestyle?.sleep); set('stress',v.lifestyle?.stress);
    set('place',v.lifestyle?.trainingPlace); set('session',v.lifestyle?.sessionLength); set('equip',v.lifestyle?.equipment); set('exp',v.lifestyle?.experience);
    set('rpe',v.lifestyle?.rpe); set('caf',v.lifestyle?.caffeine); set('inj',v.lifestyle?.injuries);
    (v.medical?.conditions||[]).forEach(c=>{ const el=[...document.querySelectorAll('.cond')].find(x=>x.value===c); if(el) el.checked=true; });
    set('otherCond',v.medical?.other); set('meds',v.medical?.meds); set('supps',v.medical?.supplements);
    set('past',v.challenges?.past); set('motiv',v.challenges?.motivation);
    S.data=v;
  }catch{}
}

/* ====== Targets & prompts ====== */
function targets(){
  const p=S.data.profile||{}, L=S.data.lifestyle||{}, goals=S.data.diet?.goals||[];
  const W=+p.weight||0, H=+p.height||0, A=+p.age||0, male=(p.sex==='Male'||p.sex==='Ø°ÙƒØ±');
  const BMR= male? 10*W+6.25*H-5*A+5 : 10*W+6.25*H-5*A-161;
  const mult={Sedentary:1.2,Light:1.35,Moderate:1.5,High:1.7}[L.workActivity||'Light'];
  let T=BMR*mult; if(goals.includes('fatLoss')) T*=0.85; if(goals.includes('build')) T*=1.10;
  const bf=+p.bodyFat||null, LM=bf?W*(1-bf/100):(p.targetWeight?+p.targetWeight:W*0.8);
  let P=Math.round(2.0*Math.max(LM,40)), F=Math.round(Math.max(0.8*W,40)), C=Math.round((T-(P*4+F*9))/4);
  if((S.data.medical?.conditions||[]).some(c=>c==='Diabetes'||c==='Insulin Resistance')) C=Math.min(C,120);
  return {bmr:Math.round(BMR),tdee:Math.round(T),protein_g:P,fat_g:F,carb_g:Math.max(40,C)};
}
function buildSections(){
  const arr=['welcome','analysis','allowed'];
  if(($('fasting').value||'off')!=='off') arr.push('fasting');
  for(let i=1;i<=7;i++) arr.push('nutrition-day-'+i);
  for(let i=1;i<=7;i++) arr.push('training-day-'+i);
  arr.push('supplements','progression','troubleshoot','safety','closing');
  S.sectionList=arr;
}
function buildPrompt(section,extra={}){
  const lang=S.lang, P=S.data.profile, D=S.data.diet, L=S.data.lifestyle, M=S.data.medical, C=S.data.currency, T=targets();
  const daysAR=['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'];
  const daysEN=['Sat','Sun','Mon','Tue','Wed','Thu','Fri'];
  const days=(lang==='ar')?daysAR:daysEN;
  const avail=(L.availableDays||[]).map(i=>days[i]).join(', ')||(lang==='ar'?'ØºÙŠØ± Ù…Ø­Ø¯Ø¯':'Not specified');
  const header=`
Name:${P.name} | Sex:${P.sex} | Age:${P.age} | H:${P.height}cm | W:${P.weight}kg | BF%:${P.bodyFat||'n/a'} | Waist:${P.waist||'n/a'}
Goals:${(D.goals||[]).join(', ')} | Preferred diet:${D.preferredDiet} | Meals/day:${D.mealsPerDay} | IF:${D.fasting}
Cuisine:${D.cuisine} | Prep:${D.prepTime}min | Budget:${C} ${D.monthlyBudget}
Activity:${L.workActivity} | Steps:${L.stepsPerDay} | Sleep:${L.sleep} | Stress:${L.stress}
Training place:${L.trainingPlace} | Session:${L.sessionLength}min | Available days:${avail} | RPE:${L.rpe} | Equipment:${L.equipment||'Bodyweight'}
Medical:${(M.conditions||[]).join(', ')||'None'} | Injuries:${L.injuries||'None'}
Allergies:${D.allergies||'None'} | Dislikes:${D.foodsToAvoid||'None'}
Energy targets: ~${T.tdee} kcal | P ${T.protein_g}g / F ${T.fat_g}g / C ${T.carb_g}g
LANGUAGE:${lang}. EXERCISES in English.`.trim();

  const A=(lang==='ar');
  if(section==='welcome') return `${header}\n\n${A?'Ø§ÙƒØªØ¨ ØªØ±Ø­ÙŠØ¨Ù‹Ø§ Ù‚ØµÙŠØ±Ù‹Ø§ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ„Ù…Ø­Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù† Ø§Ù„Ø®Ø·Ø©.':'Write a short welcome by name with a crisp plan preview.'}`;
  if(section==='analysis') return `${header}\n\n${A?'Ø­Ù„Ù‘Ù„ Ø¨Ø¥ÙŠØ¬Ø§Ø² Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙˆØ§Ù„Ù‚ÙŠÙˆØ¯ ÙˆÙ…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø¹Ø±Ø§Øª/Ø§Ù„Ù…Ø§ÙƒØ±ÙˆØ² Ø¨Ù†Ù‚Ø§Ø·.':'Concise bullet analysis of goals/constraints and macro logic.'}`;
  if(section==='allowed') return `${header}\n\n${A?'Ù‚Ø§Ø¦Ù…ØªØ§Ù†: 1) Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù‚ØªØ±Ø­ 2) Ù…Ø§ ÙŠÙØ¶Ù‘Ù„ Ø§Ù„Ø­Ø¯ Ù…Ù†Ù‡/ØªØ¬Ù†Ø¨Ù‡.':'Two lists: 1) Allowed/Recommended 2) Limit/Avoid.'}`;
  if(section==='fasting') return `${header}\n\n${A?'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹ Ø¨Ø£Ù…Ø§Ù† (Ø§Ù„Ø³ÙˆØ§Ø¦Ù„/Ø§Ù„ÙƒØ§ÙÙŠÙŠÙ†/ØªÙˆÙ‚ÙŠØª Ø§Ù„ØªÙ…Ø±ÙŠÙ†).':'Implement IF safely (hydration/caffeine/training timing).'} (${D.fasting})`;
  if(section==='nutrition-day'){const d=extra.day;return `${header}\n\n${A?`Ø®Ø·Ø© Ø§Ù„ØªØºØ°ÙŠØ© Ù„ÙŠÙˆÙ… ${d} Ù…Ù† Ù§. Ø¬Ø¯ÙˆÙ„: Ø§Ù„ÙˆØ¬Ø¨Ø© | Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª (Ø¬Ø±Ø§Ù…) | kcal | Protein | Fat | Carbs. Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠÙˆÙ…ÙŠ Ø¶Ù…Ù† Â±10% Ù…Ù† Ø§Ù„Ø£Ù‡Ø¯Ø§Ù. Ø¶Ø¹ [SWAP:MEAL:<name>].`:`Nutrition plan for Day ${d} of 7. Table: Meal | Ingredients (g) | kcal | Protein | Fat | Carbs. Totals within Â±10%. Add [SWAP:MEAL:<name>].`}`;}
  if(section==='training-day'){const d=extra.day;return `${header}\n\n${A?`Ø®Ø·Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ù„ÙŠÙˆÙ… ${d} Ù…Ù† Ù§. Ø¬Ø¯ÙˆÙ„: Ø§Ù„ÙŠÙˆÙ… | Exercise | Sets | Reps | Rest(s). Ø±Ø§Ø¹Ù Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª ÙˆØ±ÙƒØ² Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù. Ø¶Ø¹ [SWAP:EXERCISE:<name>].`:`Training for Day ${d} of 7. Table: Day | Exercise | Sets | Reps | Rest(s). Respect injuries & weak areas. Tag [SWAP:EXERCISE:<name>].`}`;}
  if(section==='supplements') return `${header}\n\n${A?'Ù…ÙƒÙ…Ù„Ø§Øª Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù„ÙŠÙ„: Ø£Ø³Ø§Ø³ÙŠ/Ù…ÙˆØ¬Ù‘Ù‡/Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ù…Ø¹ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª + ØªÙ†Ø¨ÙŠÙ‡ Ø·Ø¨ÙŠ.':'Evidence-based supplements: essential/goal-specific/budget with doses & timing + disclaimer.'}`;
  if(section==='progression') return `${header}\n\n${A?'Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø¯Ù‘Ù… 8â€“12 Ø£Ø³Ø¨ÙˆØ¹Ù‹Ø§: Ø²ÙŠØ§Ø¯Ø§Øª ÙˆØ¯Ù„ÙˆØ¯ ÙˆÙƒØ§Ø±Ø¯ÙŠÙˆ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· TDEE.':'8â€“12 week progression: increases, deloads, cardio, TDEE retune.'}`;
  if(section==='troubleshoot') return `${header}\n\n${A?'Ø­Ù„ÙˆÙ„ Ù„Ù„Ø¬ÙˆØ¹/Ø§Ù„Ø«Ø¨Ø§Øª/Ø§Ù„Ù†ÙˆÙ…/Ø§Ù„Ø¶ØºØ·/Ø§Ù„Ø±ØºØ¨Ø§Øª/Ø§Ù„Ø³ÙØ± ÙˆØ§Ù„Ù…Ø·Ø§Ø¹Ù… (Ù¢â€“Ù£ Ù†Ù‚Ø§Ø·).':'Fixes for hunger/plateaus/sleep/stress/cravings/travel/eating out (2â€“3 bullets each).'}`
  if(section==='safety') return `${header}\n\n${A?'Ø³Ù„Ø§Ù…Ø©: ØªÙ‚Ù†ÙŠØ©ØŒ ÙˆÙ‚Ø§ÙŠØ© Ø¥ØµØ§Ø¨Ø§ØªØŒ ØªØ±ÙˆÙŠØ© ÙˆÙ†ÙˆÙ…ØŒ Ù…ØªÙ‰ Ù†ÙˆÙ‚Ù Ø§Ù„ØªÙ…Ø±ÙŠÙ† ÙˆÙ†Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨.':'Safety: technique, injury prevention, hydration/sleep, when to stop and seek care.'}`;
  if(section==='closing') return `${header}\n\n${A?'Ø®ØªØ§Ù… ØªØ­ÙÙŠØ²ÙŠ Ù‚ØµÙŠØ± Ù…ÙˆØ¬Ù‘Ù‡ Ø¨Ø§Ù„Ø§Ø³Ù… Ø¨Ù„Ø§ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ±Ø­ÙŠØ¨.':'Short motivating closing by name, no repeated welcome.'}`;
  return header;
}

/* ====== AI call ====== */
async function callAI(prompt,{retries=2,timeoutMs=50000}={}){
  for(let i=0;i<=retries;i++){
    const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(),timeoutMs);
    try{
      const res=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt}),signal:ctrl.signal});
      clearTimeout(to);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json(); return {ok:true,text:data.text};
    }catch(e){ if(i===retries) return {ok:false,error:String(e)}; }
  }
}

/* ====== Timeline ====== */
function buildTimeline(list, titles=I18N[S.lang].secT){
  const wrap=$('timeline'); wrap.innerHTML='';
  list.forEach(k=>{
    const div=document.createElement('div');
    div.className='px-2 py-1 rounded-lg flex items-center gap-2';
    div.style.background='var(--field)'; div.style.border='1px solid var(--border)';
    const dot=document.createElement('span'); dot.className='status'; div.appendChild(dot);
    const lab=document.createElement('span'); lab.className='font-semibold';
    lab.textContent = k.startsWith('nutrition-day') ? `${titles.nutrition} ${k.split('-').pop()}`
                : k.startsWith('training-day') ? `${titles.training} ${k.split('-').pop()}`
                : titles[k]||k;
    div.appendChild(lab); div.dataset.key=k; wrap.appendChild(div);
  });
}
function setTimeline(key,st){ const el=[...$('timeline').children].find(x=>x.dataset.key===key); if(!el) return; const d=el.querySelector('.status'); d.className='status '+st; }

/* ====== Generation Orchestrator (sequential, show result at end) ====== */
function showOverlay(on){ $('overlay').style.display=on?'flex':'none'; }
async function generateAll(){
  saveForm();
  const need = ['name','age','height','weight'];
  if(need.some(k=>!(S.data.profile?.[k]))){ alert(I18N[S.lang].need); return; }

  // sections & timeline
  buildSections();
  buildTimeline(S.sectionList);

  S.results={}; S.statuses={};
  $('result').classList.add('hidden'); // Ù†Ø®ÙÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø­ØªÙ‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
  showOverlay(true);

  const total=S.sectionList.length; let idx=0;
  for(const key of S.sectionList){
    setTimeline(key,'run');
    let sec=key, extra={}; if(key.startsWith('nutrition-day')){sec='nutrition-day'; extra.day=+key.split('-').pop();}
    if(key.startsWith('training-day')){sec='training-day'; extra.day=+key.split('-').pop();}
    const prompt=buildPrompt(sec,extra);
    const {ok,text}=await callAI(prompt,{retries:2,timeoutMs:55000});
    S.results[key]= ok? text: '';
    S.statuses[key]= ok? 'ok':'fail';
    setTimeline(key, S.statuses[key]);
    $('ov-bar').style.width= Math.round(((++idx)/total)*100) + '%';
    $('bar').style.width= $('ov-bar').style.width;
  }

  // Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ â€” ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªÙŠØ¬Ø©
  renderFinal();
  showOverlay(false);
  $('result').classList.remove('hidden');
  document.getElementById('result').scrollIntoView({behavior:'smooth'});
}

/* ====== Final render + Retry per section ====== */
function mdSafe(s){ let out=hasMD?marked.parse(s||''):(s||'').replace(/\n/g,'<br>'); return purifier?DOMPurify.sanitize(out,{USE_PROFILES:{html:true}}):out; }
function renderFinal(){
  const wrap=$('plan-content'); wrap.innerHTML='';
  const t=I18N[S.lang].secT;
  for(const key of S.sectionList){
    const card=document.createElement('article'); card.className='mb-4 glass p-3 md:p-4';
    const title = key.startsWith('nutrition-day') ? `${t.nutrition} ${key.split('-').pop()}`
               : key.startsWith('training-day') ? `${t.training} ${key.split('-').pop()}`
               : t[key]||key;

    const status=S.statuses[key];
    const head=`<div class="flex items-center justify-between mb-2">
      <h2 class="text-base md:text-lg font-extrabold">${title}</h2>
      <div class="flex items-center gap-2">
        <span class="text-xs" style="color:var(--muted)">${status==='ok'?I18N[S.lang].ok:status==='fail'?I18N[S.lang].fail:I18N[S.lang].run}</span>
        ${status==='fail'?`<button class="btn btn-ghost text-xs" data-retry="${key}">â†» ${I18N[S.lang].retry}</button>`:''}
      </div>
    </div>`;
    const body=`<div id="body-${key}" class="text-sm leading-6">${ status==='ok' ? mdSafe(S.results[key]) : `<div style="color:var(--err)">${I18N[S.lang].fail}</div>`}</div>`;
    card.innerHTML=head+body;
    wrap.appendChild(card);
  }
}

/* delegate retry buttons */
document.addEventListener('click', async (e)=>{
  const btn=e.target.closest('[data-retry]'); if(!btn) return;
  const key=btn.getAttribute('data-retry');
  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ù„Ù„Ù‚Ø³Ù… ÙÙ‚Ø·
  btn.disabled=true; btn.textContent='â€¦';
  let sec=key, extra={}; if(key.startsWith('nutrition-day')){sec='nutrition-day'; extra.day=+key.split('-').pop();}
  if(key.startsWith('training-day')){sec='training-day'; extra.day=+key.split('-').pop();}
  const prompt=buildPrompt(sec,extra);
  const {ok,text}=await callAI(prompt,{retries:2,timeoutMs:55000});
  S.results[key]= ok? text: '';
  S.statuses[key]= ok? 'ok':'fail';
  setTimeline(key, S.statuses[key]);
  document.querySelector(`#body-${key}`).innerHTML = ok? mdSafe(text) : `<div style="color:var(--err)">${I18N[S.lang].fail}</div>`;
  // ØªØ¨Ø¯ÙŠÙ„ Ø²Ø±/Ø­Ø§Ù„Ø©
  if(ok){ btn.remove(); }
  else { btn.disabled=false; btn.textContent='â†» '+I18N[S.lang].retry; }
});

/* ====== Events ====== */
$('btn-generate-all').addEventListener('click', generateAll);
$('btn-save').addEventListener('click', ()=>{ saveForm(); alert('Saved'); });
$('btn-print-form').addEventListener('click', ()=>window.print());
$('btn-top').addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));
$('btn-print').addEventListener('click', ()=>window.print());
$('btn-theme').addEventListener('click', ()=>document.body.classList.toggle('light'));

$('btn-ar').onclick=()=>{ if(S.lang!=='ar'){ S.lang='ar'; applyLang(); } };
$('btn-en').onclick=()=>{ if(S.lang!=='en'){ S.lang='en'; applyLang(); } };

['change','keyup'].forEach(ev=>{
  document.querySelector('main').addEventListener(ev, ()=>{ saveForm(); }, {passive:true});
});

/* ====== Init ====== */
window.addEventListener('load', ()=>{
  applyLang();
  loadForm();
  saveForm();
  buildSections();
  buildTimeline(S.sectionList);
});
</script>
</body>
</html>
