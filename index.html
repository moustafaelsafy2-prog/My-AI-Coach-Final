<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ | Intelligent Health Coach</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --brand:#6c5ce7; --brand2:#00c2ff;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      --card:#0b1220; --muted:#93a2b8;
    }
    html[dir="rtl"] body{font-family:'Tajawal',system-ui,-apple-system,'Segoe UI',Roboto,"Noto Naskh Arabic",sans-serif}
    html[dir="ltr"] body{font-family:'Poppins',system-ui,-apple-system,'Segoe UI',Roboto,Inter,sans-serif}
    body{background:linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%); color:#eaf0ff}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08)}
    .title-grad{background:linear-gradient(90deg,var(--brand),var(--brand2)); -webkit-background-clip:text; background-clip:text; color:transparent}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.70rem 1rem; border-radius:.8rem; font-weight:800; transition:.2s}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff}
    .btn-ghost{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:#eaf0ff}
    .field{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:.7rem; padding:.6rem .8rem; width:100%; outline:none; color:#eaf0ff}
    .field:focus{border-color:var(--brand2); box-shadow:0 0 0 3px rgba(0,194,255,.15)}
    .progress{height:.45rem; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
    .progress > i{display:block; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand2)); width:0%; transition:width .25s ease}
    @media print{
      body{background:#fff; color:#111}
      #bar, #wizard-actions, #fixed-actions {display:none !important}
      .glass{background:#fff; border-color:#ddd}
      .title-grad{color:#111; -webkit-background-clip:unset; background-clip:unset}
    }
  </style>
</head>
<body>

  <!-- Top bar -->
  <header id="bar" class="sticky top-0 z-40 glass">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="size-9 rounded-xl bg-gradient-to-br from-[var(--brand)] to-[var(--brand2)] grid place-items-center font-black">AI</div>
        <div>
          <div class="text-lg font-extrabold">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ</div>
          <div class="text-xs text-[color:var(--muted)]">Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ù„Ø§ Ø¥Ø·Ø§Ù„Ø© â€” Ù…Ø®ØµØµØ© Ù„Ùƒ</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-theme" class="btn-ghost rounded-lg px-3">â˜¾</button>
        <button id="btn-en" class="btn-ghost rounded-lg px-3">EN</button>
        <button id="btn-ar" class="btn-ghost rounded-lg px-3">Ø¹Ø±Ø¨Ù€ÙŠ</button>
        <button id="btn-print" class="btn-ghost rounded-lg px-3">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Stepper/Hints -->
    <section class="glass rounded-xl p-4 mb-4">
      <div class="flex items-center justify-between">
        <div class="w-full progress"><i id="global-progress"></i></div>
      </div>
    </section>

    <!-- Wizard (Profile / Prefs / Lifestyle / Medical) -->
    <section class="glass rounded-xl p-4 mb-4">
      <div class="flex items-center justify-between">
        <h2 class="title-grad text-xl font-extrabold">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
        <div class="flex items-center gap-2">
          <button id="prev" class="btn btn-ghost" disabled>â—€ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <button id="next" class="btn btn-primary">Ø§Ù„ØªØ§Ù„ÙŠ â–¶</button>
          <button id="gen-one" class="btn btn-primary" title="ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ">âš¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
        </div>
      </div>

      <!-- Step body -->
      <div id="step-body" class="mt-4">
        <!-- Step 0 (profile + core inputs) -->
        <div id="step0" class="grid md:grid-cols-3 gap-3">
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„Ø§Ø³Ù…</div>
            <input id="name" class="field" placeholder="Ø§Ù„Ø§Ø³Ù…">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„Ø¹Ù…Ø±</div>
            <input id="age" class="field" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„Ø¬Ù†Ø³</div>
            <select id="sex" class="field">
              <option value="Male">Ø°ÙƒØ±</option>
              <option value="Female">Ø£Ù†Ø«Ù‰</option>
            </select>
          </label>

          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</div>
            <input id="height" class="field" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</div>
            <input id="weight" class="field" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (ÙƒØº)</div>
            <input id="targetWeight" class="field" inputmode="numeric" pattern="[0-9]*">
          </label>

          <label class="block md:col-span-3">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
              <label class="flex items-center gap-2"><input id="g-fat" type="checkbox" class="accent-[var(--brand2)]"><span>Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†</span></label>
              <label class="flex items-center gap-2"><input id="g-build" type="checkbox" class="accent-[var(--brand2)]"><span>Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª</span></label>
              <label class="flex items-center gap-2"><input id="g-strength" type="checkbox" class="accent-[var(--brand2)]"><span>Ø§Ù„Ù‚ÙˆØ©</span></label>
              <label class="flex items-center gap-2"><input id="g-endurance" type="checkbox" class="accent-[var(--brand2)]"><span>Ø§Ù„ØªØ­Ù…Ù„</span></label>
              <label class="flex items-center gap-2"><input id="g-health" type="checkbox" class="accent-[var(--brand2)]"><span>ØµØ­Ø© Ø¹Ø§Ù…Ø©</span></label>
            </div>
          </label>
        </div>

        <!-- Step 1 (diet prefs) -->
        <div id="step1" class="grid md:grid-cols-3 gap-3 hidden">
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª/ÙŠÙˆÙ…</div>
            <input id="meals" class="field" value="3" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù‘Ù„</div>
            <select id="prefDiet" class="field">
              <option value="Balanced">Ù…ØªÙˆØ§Ø²Ù†</option>
              <option value="LowCarb">Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª</option>
              <option value="Keto">ÙƒÙŠØªÙˆ</option>
              <option value="Arabic/Mediter.">Ù…ØªÙˆØ³Ø·ÙŠ/Ø¹Ø±Ø¨ÙŠ</option>
              <option value="Plant">Ù†Ø¨Ø§ØªÙŠ/Ù…Ø±Ù†</option>
            </select>
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹</div>
            <select id="fasting" class="field">
              <option value="off">ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</option>
              <option>16:8</option><option>18:6</option><option>20:4</option>
            </select>
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„Ù…Ø·Ø¨Ø®</div>
            <input id="cuisine" class="field" value="Arabic/Mediter.">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø²Ù…Ù† Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø¯)</div>
            <input id="prep" class="field" value="20" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
            <input id="budget" class="field" value="0" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block md:col-span-3">
            <div class="mb-1 text-sm opacity-80">Ø£Ø·Ø¹Ù…Ø© Ù„Ø§ ØªØ±ØºØ¨ Ø¨Ù‡Ø§/Ø­Ø³Ø§Ø³ÙŠØ§Øª</div>
            <input id="avoid" class="field" placeholder="Ù…Ø«Ø§Ù„: Ù„Ø§ Ø£Ø­Ø¨ Ø§Ù„Ø³Ù…ÙƒØŒ Ø­Ø³Ø§Ø³ÙŠØ© ÙØ³ØªÙ‚â€¦">
          </label>
        </div>

        <!-- Step 2 (lifestyle) -->
        <div id="step2" class="grid md:grid-cols-3 gap-3 hidden">
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</div>
            <select id="work" class="field">
              <option>Sedentary</option><option>Light</option><option>Moderate</option><option>High</option>
            </select>
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„Ø®Ø·ÙˆØ§Øª/Ø§Ù„ÙŠÙˆÙ…</div>
            <input id="steps" class="field" value="6000" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„Ù†ÙˆÙ…</div>
            <select id="sleep" class="field"><option>Low</option><option>Medium</option><option>High</option></select>
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø§Ù„ØªÙˆØªØ±</div>
            <select id="stress" class="field"><option>Low</option><option>Medium</option><option>High</option></select>
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>
            <input id="place" class="field" value="Home/Gym">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯)</div>
            <input id="session" class="field" value="60" inputmode="numeric" pattern="[0-9]*">
          </label>
        </div>

        <!-- Step 3 (medical/challenges) -->
        <div id="step3" class="grid md:grid-cols-2 gap-3 hidden">
          <label class="block md:col-span-2">
            <div class="mb-1 text-sm opacity-80">Ø¥ØµØ§Ø¨Ø§Øª/Ù‚ÙŠÙˆØ¯</div>
            <input id="injuries" class="field" placeholder="Shoulder impingement â€¦">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ØªØ­Ø¯ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©</div>
            <input id="past" class="field" placeholder="Ø¬ÙˆØ¹ Ø´Ø¯ÙŠØ¯ØŒ Ù…Ù„Ù„ Ù…Ù† Ø§Ù„Ø·Ø¹Ø§Ù…â€¦">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØ­ÙÙŠØ²</div>
            <select id="motiv" class="field"><option value="Direct">Ø¹Ù…Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±</option><option value="Warm">ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…</option></select>
          </label>
        </div>
      </div>

      <!-- Bottom actions (persist at the bottom of wizard card) -->
      <div id="wizard-actions" class="mt-5 flex items-center justify-between">
        <div class="text-sm text-[color:var(--muted)]" id="hint">â€” Ø³ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„ Ù‚Ø³Ù… ÙÙˆØ± ØªÙˆÙ„ÙŠØ¯Ù‡ â€”</div>
        <div class="flex items-center gap-2">
          <button id="prev-bottom" class="btn btn-ghost" disabled>â—€ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <button id="next-bottom" class="btn btn-primary">Ø§Ù„ØªØ§Ù„ÙŠ â–¶</button>
          <button id="generate" class="btn btn-primary">âš¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© ÙƒØ§Ù…Ù„Ø©</button>
        </div>
      </div>
    </section>

    <!-- Plan output -->
    <section id="plan" class="glass rounded-xl p-5">
      <div class="text-sm text-[color:var(--muted)]" id="plan-empty">â€” Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù‡Ù†Ø§ ÙÙˆØ± ØªÙˆÙ„ÙŠØ¯Ù‡Ø§ â€”</div>
      <div id="plan-content" class="ai-content"></div>
    </section>

    <!-- Footer -->
    <footer class="text-center text-xs text-[color:var(--muted)] mt-6">
      Powered by <strong>Coach Mustafa Elsafy</strong> Â© 2025
    </footer>
  </main>

  <!-- ====================== APP LOGIC ====================== -->
  <script>
  /* ---------- App state (Ù…Ø®ØªØµØ± ÙˆØ¹Ù…Ù„ÙŠ) ---------- */
  const state = {
    lang: (document.documentElement.dir === 'rtl') ? 'ar' : 'en',
    step: 0, // 0..3
    profile: {name:'', age:'', height:'', weight:'', sex:'Male', targetWeight:''},
    diet: { goals:[], mealsPerDay:3, preferredDiet:'Balanced', fasting:'off', cuisine:'Arabic/Mediter.', prepTime:20, monthlyBudget:0, foodsToAvoid:'' },
    lifestyle: { workActivity:'Sedentary', stepsPerDay:6000, sleep:'Low', stress:'Low', trainingPlace:'Home/Gym', sessionLength:60 },
    medical:{ injuries:'', other:'', meds:'', supplements:'' },
    challenges:{ past:'', motivation:'Direct' },
    targets: null
  };

  const $ = (id)=>document.getElementById(id);

  /* ---------- Step navigation ---------- */
  function showStep(){
    for(let i=0;i<=3;i++){
      const s = document.getElementById('step'+i);
      if(s) s.classList.toggle('hidden', state.step!==i);
    }
    $('prev').disabled = $('prev-bottom').disabled = (state.step===0);
    $('next').classList.toggle('hidden', state.step===3);
    $('next-bottom').classList.toggle('hidden', state.step===3);
  }
  function saveStep(){
    if(state.step===0){
      state.profile.name = $('name').value.trim();
      state.profile.age = $('age').value.trim();
      state.profile.sex = $('sex').value;
      state.profile.height = $('height').value.trim();
      state.profile.weight = $('weight').value.trim();
      state.profile.targetWeight = $('targetWeight').value.trim();
      // Ø£Ù‡Ø¯Ø§Ù
      const goals=[]; if($('g-fat').checked) goals.push('Fat loss');
      if($('g-build').checked) goals.push('Build muscle');
      if($('g-strength').checked) goals.push('Strength');
      if($('g-endurance').checked) goals.push('Endurance');
      if($('g-health').checked) goals.push('General health');
      state.diet.goals = goals;
    }
    if(state.step===1){
      state.diet.mealsPerDay = +$('meals').value||3;
      state.diet.preferredDiet = $('prefDiet').value;
      state.diet.fasting = $('fasting').value;
      state.diet.cuisine = $('cuisine').value;
      state.diet.prepTime = +$('prep').value||20;
      state.diet.monthlyBudget = +$('budget').value||0;
      state.diet.foodsToAvoid = $('avoid').value;
    }
    if(state.step===2){
      state.lifestyle.workActivity = $('work').value;
      state.lifestyle.stepsPerDay = +$('steps').value||6000;
      state.lifestyle.sleep = $('sleep').value;
      state.lifestyle.stress = $('stress').value;
      state.lifestyle.trainingPlace = $('place').value;
      state.lifestyle.sessionLength = +$('session').value||60;
    }
    if(state.step===3){
      state.medical.injuries = $('injuries').value;
      state.challenges.past = $('past').value;
      state.challenges.motivation = $('motiv').value;
    }
  }
  $('next').onclick = $('next-bottom').onclick = ()=>{
    saveStep();
    state.step = Math.min(3, state.step+1);
    showStep();
  };
  $('prev').onclick = $('prev-bottom').onclick = ()=>{
    state.step = Math.max(0, state.step-1);
    showStep();
  };

  /* ---------- Theme / Lang ---------- */
  $('btn-theme').onclick = ()=>{
    const dark = getComputedStyle(document.body).backgroundImage.includes('#0a0f1c');
    document.body.style.background = dark ? 'linear-gradient(180deg,#eef2ff 0%,#f7f9ff 100%)' : 'linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%)';
  };
  $('btn-print').onclick = ()=>window.print();
  $('btn-ar').onclick = ()=>{ document.documentElement.lang='ar'; document.documentElement.dir='rtl'; state.lang='ar'; };
  $('btn-en').onclick = ()=>{ document.documentElement.lang='en'; document.documentElement.dir='ltr'; state.lang='en'; };

  /* ---------- Targets (Mifflin-St Jeor) ---------- */
  function computeTargets(){
    const p = state.profile, L = state.lifestyle, goals = state.diet.goals;
    const W=+p.weight||0, H=+p.height||0, A=+p.age||0;
    const male = (p.sex==='Male' || p.sex==='Ø°ÙƒØ±');
    const BMR = male ? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161;
    const actMap = {'Sedentary':1.2,'Light':1.35,'Moderate':1.5,'High':1.7};
    let TDEE = BMR*(actMap[L.workActivity]||1.35);
    if(goals.includes('Fat loss')) TDEE*=0.85;
    if(goals.includes('Build muscle')) TDEE*=1.10;
    const targetW = Number(p.targetWeight)||W||1;
    const protein = Math.round(2.0*targetW);
    const fat = Math.round(Math.max(0.8*W, 40));
    let carbs = Math.round((TDEE - (protein*4 + fat*9))/4);
    carbs = Math.max(40, Math.min(carbs, 120 * (state.diet.preferredDiet==='Keto'?1:5)));
    return { bmr:Math.round(BMR), tdee:Math.round(TDEE), protein_g:protein, fat_g:fat, carb_g:carbs };
  }

  /* ---------- PlanState & LLM controls (Ø§Ù†Ø³ÙŠØ§Ø¨ÙŠØ© + Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±) ---------- */
  const PlanState = {
    lang: state.lang,
    profile: null,
    completed: [], // {key,title,text}
    seenLines: new Set(),
    push(key,title,text){ this.completed.push({key,title,text}); },
    context(max=5000){ const s=this.completed.map(x=>`## ${x.title}\n${x.text}`).join('\n\n'); return s.slice(-max); }
  };
  const i18n = {
    ar:{ long:"Ø§ÙƒØªØ¨ Ø¨Ø¥Ø³Ù‡Ø§Ø¨ Ø¯ÙˆÙ† Ø§Ø®ØªØµØ§Ø±.", only:"Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·.", noDup:"Ù„Ø§ ØªÙÙƒØ±Ø± Ø§Ù„ØªØ±Ø­ÙŠØ¨/Ø§Ù„Ù…Ù„Ù/Ø§Ù„Ø¬ÙÙ…Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.", noDisc:"Ù„Ø§ ØªÙƒØªØ¨: Ø§Ù„Ø®Ø·Ø© Ø¹Ø§Ù…Ø©/Ø§Ø³ØªØ´Ø± Ø£Ø®ØµØ§Ø¦ÙŠâ€¦", flow:"Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ ØªØ³Ù„Ø³Ù„ ÙŠØ³ØªÙ†Ø¯ Ù„Ù…Ø§ Ø³Ø¨Ù‚.", intro:"Ø§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø­ØªÙˆÙ‰ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….", wait:"â€” Ø³ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„ Ù‚Ø³Ù… ÙÙˆØ± ØªÙˆÙ„ÙŠØ¯Ù‡ â€”" },
    en:{ long:"Write in-depth. No summaries.", only:"English only.", noDup:"No repeating welcome/profile/previous lines.", noDisc:"No generic disclaimers.", flow:"Keep narrative continuity.", intro:"Start directly with the section.", wait:"â€” Each section appears as itâ€™s ready â€”" }
  };
  function buildRules(lang){
    const t=i18n[lang];
    return ['- '+t.long,'- '+t.only,'- '+t.noDup,'- '+t.noDisc,'- '+t.flow,'- '+t.intro,'- Ø§Ø³ØªØ®Ø¯Ù… Ù†Ù‚Ø§Ø· ÙˆØ¬Ø¯Ø§ÙˆÙ„ Ø­ÙŠØ« ÙŠÙ„Ø²Ù….','- Ù„Ø§ ØªÙØ¯Ø±Ø¬ ÙˆØ³ÙˆÙ… HTML.'].join('\n');
  }
  const SECTIONS = [
    {key:'welcome', title:{ar:'Ø§Ù„ØªØ±Ø­ÙŠØ¨',en:'Welcome'}, ask:{ar:"ÙÙ‚Ø±Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© Ù‚ØµÙŠØ±Ø© (3-4 Ø£Ø³Ø·Ø±) Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….",en:"Short welcome (3â€“4 lines) tied to profile."}},
    {key:'analysis', title:{ar:'Ø§Ù„ØªØ­Ù„ÙŠÙ„',en:'Analysis'}, ask:{ar:"ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±Ø§Øª/Ø§Ù„Ù…Ø§ÙƒØ±ÙˆØ²/Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ø¹ Ø§Ù„Ù…Ù†Ù‡Ø¬ÙŠØ©.",en:"Calorie/macro/activity analysis with rationale."}},
    {key:'allowed', title:{ar:'Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹',en:'Allowed / Avoid'}, ask:{ar:"Ù‚Ø§Ø¦Ù…ØªØ§Ù† Ù…Ø®ØªØµØ±ØªØ§Ù† ÙˆØ¹Ù…Ù„ÙŠØªØ§Ù† ÙˆÙÙ‚ Ø§Ù„Ù…Ø·Ø¨Ø® ÙˆØ§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©.",en:"Two focused lists tailored to cuisine/budget."}},
    {key:'fasting', title:{ar:'Ø§Ù„ØµÙŠØ§Ù…',en:'Intermittent fasting'}, ask:{ar:"ØªØ·Ø¨ÙŠÙ‚ Ø¢Ù…Ù† Ù„Ù„ØµÙŠØ§Ù… (Ø§Ù„ØªÙˆÙ‚ÙŠØª/Ø§Ù„Ø³ÙˆØ§Ø¦Ù„/Ø§Ù„ÙƒØ§ÙÙŠÙŠÙ†/Ø§Ù„ØªØ¯Ø±ÙŠØ¨).",en:"Safe IF implementation (timing/hydration/caffeine/training)."}},
    ...Array.from({length:7},(_,i)=>({key:`nutrition-${i+1}`,title:{ar:`Ø§Ù„ØªØºØ°ÙŠØ© â€“ ÙŠÙˆÙ… ${i+1}`,en:`Nutrition â€“ Day ${i+1}`},ask:{ar:"Ø¬Ø¯ÙˆÙ„ ÙˆØ¬Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ… (3â€“5) + Ø³Ù†Ø§ÙƒØ³: Ø§Ù„ÙˆØ¬Ø¨Ø© | Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª(Ø¬Ø±Ø§Ù…) | kcal | Protein | Fat | Carbs + ØµÙ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Â±10% Ù…Ù† Ø§Ù„Ø£Ù‡Ø¯Ø§Ù.",en:"Meals (3â€“5) + snacks table with totals within Â±10%."}})),
    ...Array.from({length:7},(_,i)=>({key:`training-${i+1}`,title:{ar:`Ø§Ù„ØªØ¯Ø±ÙŠØ¨ â€“ ÙŠÙˆÙ… ${i+1}`,en:`Training â€“ Day ${i+1}`},ask:{ar:"Ø¬Ø¯ÙˆÙ„: Exercise(English) | Sets | Reps | Rest(s). Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª.",en:"Table: Exercise(English) | Sets | Reps | Rest(s). Respect injuries."}})),
    {key:'supplements', title:{ar:'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª',en:'Supplements'}, ask:{ar:"Ø­ÙØ²Ù… Ø£Ø³Ø§Ø³ÙŠØ©/Ù‡Ø¯ÙÙŠØ©/Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© Ø¨Ø§Ù„Ø¬Ø±Ø¹Ø§Øª ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª.",en:"Core/goal/budget stacks with doses and timing."}},
    {key:'progress', title:{ar:'Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…',en:'Progression'}, ask:{ar:"Ù†Ù…ÙˆØ°Ø¬ 8â€“12 Ø£Ø³Ø¨ÙˆØ¹Ù‹Ø§ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø­Ù…Ø§Ù„/Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª/Ø§Ù„ÙƒØ§Ø±Ø¯ÙŠÙˆ ÙˆØ¶Ø¨Ø· Ø§Ù„Ø³Ø¹Ø±Ø§Øª.",en:"8â€“12 week progression and calorie adjustments."}},
    {key:'troubleshoot', title:{ar:'Ø§Ù„Ù…Ø´Ø§ÙƒÙ„',en:'Troubleshooting'}, ask:{ar:"Ø­Ù„ÙˆÙ„ Ù„Ù„Ø¬ÙˆØ¹/Ø§Ù„Ø«Ø¨Ø§Øª/Ø§Ù„Ù†ÙˆÙ…/Ø§Ù„Ø¶ØºØ·/Ø§Ù„Ø´Ù‡ÙˆØ§Øª/Ø§Ù„Ø³ÙØ±/Ø§Ù„Ù…Ø·Ø§Ø¹Ù… (Ù¢â€“Ù£ Ù†Ù‚Ø§Ø·).",en:"Playbook for hunger/plateaus/sleep/stress/cravings/travel/eating-out."}},
    {key:'safety', title:{ar:'Ø§Ù„Ø³Ù„Ø§Ù…Ø©',en:'Safety'}, ask:{ar:"Ø³Ù„Ø§Ù…Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ† ÙˆØ§Ù„Ù†ÙˆÙ… ÙˆØ§Ù„ØªØ±Ø·ÙŠØ¨ ÙˆÙ…ØªÙ‰ ØªØªÙˆÙ‚Ù.",en:"Safety notes and when to stop."}},
    {key:'closing', title:{ar:'Ø§Ù„Ø®ØªØ§Ù…',en:'Closing'}, ask:{ar:"Ø®ØªØ§Ù… ØªØ­ÙÙŠØ²ÙŠ Ù‚ØµÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø®Ø·Ø© Ø¯ÙˆÙ† ØªØ±Ø­ÙŠØ¨ Ø¬Ø¯ÙŠØ¯.",en:"Short motivating closing tied to the plan."}},
  ];
  function buildPrompt(section, profile){
    const lang=state.lang, t=i18n[lang];
    const rules=buildRules(lang), prev=PlanState.context();
    return [
      `Ø§Ù„Ù‚Ø³Ù…: ${section.title[lang]}`,
      `Ø§Ù„Ù„ØºØ©: ${lang==='ar'?'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©':'English'}`,
      `Ù‚ÙˆØ§Ø¹Ø¯:\n${rules}`,
      "",
      "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ø§ ØªØ¹ÙØ¯ Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§):",
      JSON.stringify(profile,null,2),
      "",
      "Ø³ÙŠØ§Ù‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ù„Ù„Ø§Ù†Ø³ÙŠØ§Ø¨ÙŠØ© ÙÙ‚Ø· â€” Ù„Ø§ ØªÙƒØ±Ø§Ø±Ù‡):",
      prev || "(Ù„Ø§ Ø³ÙŠØ§Ù‚ Ø³Ø§Ø¨Ù‚.)",
      "",
      "ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…:",
      section.ask[lang],
      "",
      "Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø·ØŒ Ù…Ø·ÙˆÙ‘Ù„Ù‹Ø§ ÙˆØºÙŠØ± Ù…Ø®ØªØµØ±."
    ].join('\n');
  }
  const RE_STRIP=[/Ù‡Ø°Ù‡ (?:Ø§Ù„Ø®Ø·Ø©|Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª).*?(?:ØºÙŠØ±|Ù„ÙŠØ³Øª).*?(?:Ù…Ø®ØµØµØ©|Ø·Ø¨ÙŠØ©)[^\n]*$/gim,/Ø§Ø³ØªØ´Ø±\s+(?:Ø·Ø¨ÙŠØ¨|Ø£Ø®ØµØ§Ø¦ÙŠ|Ù…Ø¯Ø±Ø¨)[^\n]*$/gim,/this (?:plan|information).*?(?:not|isn['â€™]t).*?(?:personalized|medical advice)[^\n]*$/gim,/consult (?:a )?(?:doctor|physician|dietitian|coach)[^\n]*$/gim,/<!DOCTYPE[\s\S]*?<body[^>]*>/gim,/<\/body>\s*<\/html>/gim];
  function sanitize(text,lang){
    let out=String(text||''); RE_STRIP.forEach(rx=>out=out.replace(rx,'')); 
    if(lang==='ar'){ out=out.split('\n').filter(l=>((l.match(/[\u0600-\u06FF]/g)||[]).length>= (l.match(/[A-Za-z]/g)||[]).length)).join('\n'); }
    else{ out=out.split('\n').filter(l=>((l.match(/[A-Za-z]/g)||[]).length>= (l.match(/[\u0600-\u06FF]/g)||[]).length)).join('\n'); }
    const ded=[]; for(const ln of out.split('\n')){ const k=ln.trim().replace(/\s+/g,' ').toLowerCase(); if(!k){ded.push('');continue;} if(PlanState.seenLines.has(k)) continue; PlanState.seenLines.add(k); ded.push(ln); }
    return ded.join('\n').replace(/\n{3,}/g,'\n\n').trim();
  }
  async function callGemini(prompt){
    const res=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
    if(!res.ok){ throw new Error(await res.text()); }
    const data=await res.json(); return data.text||'';
  }
  function appendSection(title, html){
    $('plan-empty').style.display='none';
    const div=document.createElement('div');
    div.className='mb-6';
    div.innerHTML = `<h3 class="font-extrabold text-lg mb-2">${title}</h3><div class="whitespace-pre-wrap leading-relaxed">${html}</div>`;
    $('plan-content').appendChild(div);
  }
  async function generateSection(section){
    const prompt = buildPrompt(section, PlanState.profile);
    const raw = await callGemini(prompt);
    const clean = sanitize(raw, state.lang);
    appendSection(section.title[state.lang], clean);
    PlanState.push(section.key, section.title[state.lang], clean);
  }

  /* ---------- ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ / ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© ÙƒØ§Ù…Ù„Ø© ---------- */
  $('gen-one').onclick = async ()=>{
    saveStep();
    // Ø¬Ù‡Ù‘Ø² Ø§Ù„Ø£Ù‡Ø¯Ø§Ù
    state.targets = computeTargets();
    PlanState.lang = state.lang;
    PlanState.profile = {...state.profile, diet:state.diet, lifestyle:state.lifestyle, medical:state.medical, challenges:state.challenges, targets:state.targets};
    // Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const map = ['welcome','analysis','allowed','fasting'];
    const k = map[state.step] || 'welcome';
    const sec = SECTIONS.find(s=>s.key===k);
    await generateSection(sec);
  };

  $('generate').onclick = async ()=>{
    saveStep();
    if(!(state.profile.name && state.profile.age && state.profile.height && state.profile.weight)){
      alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ø·ÙˆÙ„/Ø§Ù„ÙˆØ²Ù† Ø£ÙˆÙ„Ø§Ù‹'); return;
    }
    state.targets = computeTargets();
    PlanState.lang = state.lang;
    PlanState.profile = {...state.profile, diet:state.diet, lifestyle:state.lifestyle, medical:state.medical, challenges:state.challenges, targets:state.targets};
    $('plan-content').innerHTML=''; $('plan-empty').style.display='block';
    document.querySelector('#plan .text-sm')?.textContent = i18n[state.lang].wait;
    const keys = SECTIONS.map(s=>s.key);
    const gbar = $('global-progress');
    for(let i=0;i<keys.length;i++){
      const sec = SECTIONS.find(s=>s.key===keys[i]); if(!sec) continue;
      try{
        await generateSection(sec);
      }catch(e){
        const msg=document.createElement('div');
        msg.className='mb-6';
        msg.innerHTML=`<h3 class="font-extrabold text-lg mb-2">${sec.title[state.lang]}</h3>
        <div class="text-red-400 mb-2">ÙØ´Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯: ${String(e).slice(0,180)}</div>
        <button class="btn btn-ghost" data-retry="${sec.key}">Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</button>`;
        $('plan-content').appendChild(msg);
        msg.querySelector('[data-retry]').onclick = async ()=>{
          msg.remove(); await generateSection(sec);
        };
      }
      const pct=Math.round(((i+1)/keys.length)*100); gbar.style.width=pct+'%';
    }
  };

  /* ---------- init ---------- */
  window.addEventListener('load', showStep);
  </script>
</body>
</html>
