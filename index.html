<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>المستشار الصحي الذكي | Intelligent Health Coach</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{ --brand:#6c5ce7; --brand2:#00c2ff; --ok:#16a34a; --warn:#f59e0b; --err:#dc2626; --muted:#93a2b8; }
    html[dir="rtl"] body{ font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",sans-serif }
    html[dir="ltr"] body{ font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif }
    body{ background:linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%); color:#eaf0ff }
    .glass{ background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); border-radius:14px }
    .title-grad{ background:linear-gradient(90deg,var(--brand),var(--brand2)); -webkit-background-clip:text; background-clip:text; color:transparent }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.7rem 1rem; border-radius:.8rem; font-weight:800; transition:.15s }
    .btn-primary{ background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff }
    .btn-ghost{ background:rgba(255,255,255,.06); color:#eaf0ff; border:1px solid rgba(255,255,255,.12) }
    .chip{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); padding:.35rem .6rem; border-radius:999px; font-size:.75rem }
    .field{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:.7rem; padding:.6rem .8rem; outline:none; width:100%; color:#eaf0ff }
    .field::placeholder{ color:#a9b7cf }
    .field:focus{ border-color:var(--brand2); box-shadow:0 0 0 3px rgba(0,194,255,.15) }
    .divider{ height:1px; background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent) }
    .progress{ height:.45rem; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden }
    .progress > i{ display:block; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand2)); width:0%; transition:width .25s ease }
    .badge{ font-size:.7rem; padding:.2rem .45rem; border-radius:.5rem; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06) }
    .toast{ position:fixed; inset-inline-end:14px; bottom:14px; background:#0e1a2d; border:1px solid rgba(255,255,255,.14); color:#eaf0ff; padding:.6rem .8rem; border-radius:.7rem; z-index:90; box-shadow:0 10px 20px rgba(0,0,0,.35) }
    @media print{ body{ background:#fff; color:#000 } #bar,#wizard,#actions,#controls{ display:none !important } .ai-content *{ color:#000 !important } }
  </style>
</head>
<body>

  <!-- Top bar -->
  <header id="bar" class="sticky top-0 z-40 glass border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="size-9 rounded-xl bg-gradient-to-br from-[var(--brand)] to-[var(--brand2)] grid place-items-center font-black">AI</div>
        <div>
          <div id="app-title" class="text-lg font-extrabold">المستشار الصحي الذكي</div>
          <div class="text-xs text-[color:var(--muted)]" id="subtitle">خطة دقيقة بلا لف — للتغذية والتدريب والمكملات</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="lang-en" class="chip">EN</button>
        <button id="lang-ar" class="chip">عربي</button>
        <button id="toggle-theme" class="chip">☾</button>
        <button id="btn-print" class="btn btn-ghost">🖨 طباعة</button>
      </div>
    </div>
  </header>

  <!-- Shell -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Stepper -->
    <section class="glass p-4 mb-4">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm text-[color:var(--muted)]" id="hint">سنولّد الخطة قسمًا بعد قسم: ترحيب → تحليل → المسموح/الممنوع → الصيام (إن لزم) → التغذية ٧ أيام → التدريب ٧ أيام → المكملات → التقدّم → المشاكل → السلامة → ختام.</div>
        <div class="w-56 progress"><i id="global-progress"></i></div>
      </div>
    </section>

    <!-- Wizard (4 خطوات) -->
    <section id="wizard" class="glass p-4">
      <div class="flex items-center gap-2 mb-4">
        <div id="s1" class="h-1.5 flex-1 bg-white/10 rounded-full overflow-hidden"><i class="block h-full w-0 bg-gradient-to-r from-[var(--brand)] to-[var(--brand2)]"></i></div>
        <div id="s2" class="h-1.5 flex-1 bg-white/10 rounded-full overflow-hidden"><i class="block h-full w-0 bg-gradient-to-r from-[var(--brand)] to-[var(--brand2)]"></i></div>
        <div id="s3" class="h-1.5 flex-1 bg-white/10 rounded-full overflow-hidden"><i class="block h-full w-0 bg-gradient-to-r from-[var(--brand)] to-[var(--brand2)]"></i></div>
        <div id="s4" class="h-1.5 flex-1 bg-white/10 rounded-full overflow-hidden"><i class="block h-full w-0 bg-gradient-to-r from-[var(--brand)] to-[var(--brand2)]"></i></div>
      </div>

      <div class="title-grad text-xl font-extrabold mb-2" id="step-title">الملف الشخصي</div>
      <div id="step-body"></div>

      <!-- Controls bottom -->
      <div id="controls" class="mt-6 flex items-center justify-between">
        <button id="prev" class="btn btn-ghost">◀ السابق</button>
        <div class="flex items-center gap-2">
          <button id="generate-one" class="btn btn-primary hidden">⚡ توليد القسم الحالي</button>
          <button id="next" class="btn btn-primary">التالي ▶</button>
        </div>
      </div>
    </section>

    <!-- Plan output -->
    <section id="plan" class="glass p-5 mt-6">
      <div class="flex items-center justify-between">
        <div class="font-extrabold text-lg">الخطة</div>
        <div class="text-xs text-[color:var(--muted)]" id="live-hint">— سيتم عرض الأقسام هنا فور توليدها —</div>
      </div>

      <!-- مساحة البطاقات -->
      <div id="plan-content" class="ai-content mt-4 space-y-4"></div>

      <!-- Actions -->
      <div id="actions" class="mt-5 flex items-center justify-between">
        <div class="text-xs text-[color:var(--muted)] flex items-center gap-2">
          <span class="size-2 rounded-full bg-[var(--warn)] inline-block"></span>
          <span id="gen-progress-label">تم التوليد</span>
        </div>
        <div class="flex items-center gap-2">
          <button class="btn btn-ghost" id="scroll-top">↑ أعلى</button>
          <button class="btn btn-primary" id="print-bottom">🖨 PDF / طباعة</button>
        </div>
      </div>

      <footer class="text-center text-xs text-[color:var(--muted)] mt-6">2025 © المدرب <strong>مصطفى الصافي</strong> — Powered by Coach <strong>Mustafa Elsafy</strong></footer>
    </section>
  </main>

  <!-- Overlay (قناع التوليد الحي) -->
  <div id="overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-40">
    <div class="absolute inset-0 grid place-items-center">
      <div class="glass p-6 w-[min(92vw,520px)] text-center">
        <div class="mx-auto size-11 rounded-full border-4 border-white/20 border-t-[color:var(--brand2)] animate-spin mb-3"></div>
        <div class="font-extrabold mb-1" id="ov-title">نُجهّز خطتك الآن</div>
        <div class="text-sm text-[color:var(--muted)]" id="ov-sub">سيظهر كل قسم فور توليده.</div>
        <div class="mt-3 progress"><i id="ov-bar"></i></div>
      </div>
    </div>
  </div>

  <script>
  /*************** الحالة العامة ***************/
  const state = {
    lang: (navigator.language||'ar').startsWith('ar')?'ar':'en',
    theme: 'dark',
    step: 0, // 0..3
    currency: detectCurrency(),
    profile: { name:'', age:'', height:'', weight:'', bodyFat:'', waist:'', sex:'Male', targetWeight:'', targetDate:'' },
    diet: {
      goals:[], mealsPerDay:3, preferredDiet:'Balanced', cuisine:'Arabic/Mediter.', prepTime:20,
      monthlyBudget:0, foodsToAvoid:'', allergies:'', fasting:'off'
    },
    lifestyle:{
      workActivity:'Sedentary', stepsPerDay:6000, sleep:'Low', stress:'Low',
      trainingPlace:'Home/Gym', sessionLength:60, availableDays:[],
      equipment:'', experience:'Beginner (0-6m)', rpe:8, caffeine:0, injuries:''
    },
    fitness:{ restingHR:'', maxPushups:'', plank:'', kmTime:'' },
    muscles: { chest:{on:false,note:''}, back:{on:false,note:''}, shoulders:{on:false,note:''},
               biceps:{on:false,note:''}, triceps:{on:false,note:''}, quads:{on:false,note:''},
               hamstrings:{on:false,note:''}, glutes:{on:false,note:''}, calves:{on:false,note:''}, abs:{on:false,note:''} },
    medical:{ conditions:[], other:'', meds:'', supplements:'' },
    challenges:{ past:'', motivation:'Direct' },
    targets:null,
    generating:false
  };

  // i18n (العربية/الإنجليزية)
  const T = {
    ar:{
      steps:['الملف الشخصي','التفضيلات الغذائية','نمط الحياة والتدريب','الحالة الصحية والتحديات'],
      next:'التالي', prev:'السابق', generateOne:'توليد القسم الحالي', print:'طباعة',
      profile:'الملف الشخصي', dietPrefs:'التفضيلات الغذائية', lifestyle:'نمط الحياة والتدريب', med:'الحالة الصحية والتحديات',
      name:'الاسم', age:'العمر', height:'الطول (سم)', weight:'الوزن (كغ)', bodyFat:'نسبة الدهون % (اختياري)', waist:'محيط الخصر (سم) (اختياري)', sex:'الجنس',
      male:'ذكر', female:'أنثى', targetWeight:'الوزن المستهدف (كغ)', targetDate:'موعد تحقيق الهدف (تاريخ)',
      goals:'الأهداف', fatLoss:'خسارة الدهون', build:'بناء العضلات', strength:'زيادة القوة', endurance:'تحسين التحمل', health:'صحة عامة',
      mealsPerDay:'عدد الوجبات', preferredDiet:'النظام المفضّل', balanced:'متوازن', lowCarb:'قليل الكربوهيدرات', keto:'كيتو', med:'متوسطي/عربي', veg:'نباتي/مرن',
      fasting:'الصيام المتقطع', fastingOff:'غير مفعّل', fasting16:'16:8', fasting18:'18:6', fasting20:'20:4',
      cuisine:'المطبخ', prepTime:'زمن التحضير (د)', budget:'الميزانية الشهرية', foodsAvoid:'أطعمة لا ترغب بها/حساسيات', allergies:'حساسيات شائعة',
      workActivity:'العمل/النشاط', steps:'خطوات/اليوم', sleep:'النوم', stress:'التوتر', place:'مكان التمرين', session:'مدة الجلسة (د)',
      days:'أيام التدريب', equipment:'المعدات المتاحة', experience:'الخبرة', rpe:'RPE', caffeine:'كافيين/أكواب', injuries:'إصابات/قيود',
      quick:'اختبار لياقة مبسّط', restingHR:'نبض الراحة (bpm)', pushups:'أقصى ضغط', plank:'Plank (د)', kmTime:'زمن 1 كم (د:ث)',
      medicalStatus:'الحالة الصحية', otherCond:'أمراض أخرى', currentMeds:'أدوية حالية', currentSupp:'مكملات حالية',
      pastCh:'تحديات سابقة', motiv:'أسلوب التحفيز', motivDir:'عملي مباشر', motivWarm:'تشجيعي',
      hint:'سنولّد الخطة قسمًا بعد قسم: ترحيب → تحليل → المسموح/الممنوع → الصيام (إن لزم) → التغذية ٧ أيام → التدريب ٧ أيام → المكملات → التقدّم → المشاكل → السلامة → الختام.',
      keep:'— سيتم عرض الأقسام هنا فور توليدها —',
      needBasics:'أكمل: الاسم/العمر/الطول/الوزن.'
    },
    en:{
      steps:['Profile','Diet preferences','Lifestyle & training','Medical & challenges'],
      next:'Next', prev:'Back', generateOne:'Generate current section', print:'Print',
      profile:'Profile', dietPrefs:'Diet preferences', lifestyle:'Lifestyle & training', med:'Medical & challenges',
      name:'Name', age:'Age', height:'Height (cm)', weight:'Weight (kg)', bodyFat:'Body fat % (optional)', waist:'Waist (cm) (optional)', sex:'Sex',
      male:'Male', female:'Female', targetWeight:'Target weight (kg)', targetDate:'Target date',
      goals:'Goals', fatLoss:'Fat loss', build:'Build muscle', strength:'Strength', endurance:'Endurance', health:'General health',
      mealsPerDay:'Meals/day', preferredDiet:'Preferred diet', balanced:'Balanced', lowCarb:'Low-carb', keto:'Keto', med:'Mediterranean/Arabic', veg:'Plant-forward',
      fasting:'Intermittent fasting', fastingOff:'Off', fasting16:'16:8', fasting18:'18:6', fasting20:'20:4',
      cuisine:'Cuisine', prepTime:'Prep time (min)', budget:'Monthly budget', foodsAvoid:'Foods to avoid / dislikes', allergies:'Common allergies',
      workActivity:'Work/activity', steps:'Steps/day', sleep:'Sleep', stress:'Stress', place:'Training place', session:'Session length (min)',
      days:'Available training days', equipment:'Available equipment', experience:'Experience', rpe:'RPE', caffeine:'Caffeine/day (cups)', injuries:'Injuries/constraints',
      quick:'Quick fitness test', restingHR:'Resting HR (bpm)', pushups:'Max push-ups', plank:'Plank (min)', kmTime:'1 km time (m:s)',
      medicalStatus:'Medical status', otherCond:'Other conditions', currentMeds:'Current medications', currentSupp:'Current supplements',
      pastCh:'Past challenges', motiv:'Motivation style', motivDir:'Direct & pragmatic', motivWarm:'Supportive & encouraging',
      hint:'We will generate the plan section-by-section…',
      keep:'— Sections will appear here as they are generated —',
      needBasics:'Complete: name/age/height/weight.'
    }
  };

  const t = (k)=> (T[state.lang] && T[state.lang][k]) || k;

  /*************** أدوات واجهة ***************/
  function detectCurrency(){
    try{
      const loc = Intl.DateTimeFormat().resolvedOptions().locale || navigator.language || 'en-US';
      if(loc.includes('EG')) return 'EGP';
      if(loc.includes('SA')) return 'SAR';
      if(loc.includes('AE')) return 'AED';
      if(loc.includes('QA')) return 'QAR';
      if(loc.includes('KW')) return 'KWD';
      if(loc.includes('GB')) return 'GBP';
      if(loc.includes('EU')||loc.includes('DE')||loc.includes('FR')||loc.includes('IT')||loc.includes('ES')) return 'EUR';
      return 'USD';
    }catch{ return 'USD'; }
  }
  function toast(msg){ const d=document.createElement('div'); d.className='toast'; d.innerHTML=`<div class="font-bold mb-1">${msg}</div>`; document.body.appendChild(d); setTimeout(()=>d.remove(),3200) }
  function esc(s){ return (s??'').toString().replace(/"/g,'&quot;') }

  /*************** تبديل اللغة/السِمة ***************/
  function setLang(lang){
    state.lang = lang;
    const html = document.documentElement;
    html.lang = lang; html.dir = (lang==='ar')?'rtl':'ltr';
    document.getElementById('app-title').textContent = (lang==='ar')?'المستشار الصحي الذكي':'Intelligent Health Coach';
    document.getElementById('subtitle').textContent = (lang==='ar')?'خطة دقيقة بلا لف — للتغذية والتدريب والمكملات':'100% precise plan for nutrition, training & supplements';
    document.getElementById('hint').textContent = t('hint');
    document.getElementById('live-hint').textContent = t('keep');
    document.getElementById('next').textContent = (lang==='ar')? 'التالي ▶':'Next ▶';
    document.getElementById('prev').textContent = (lang==='ar')? '◀ السابق':'◀ Back';
    document.getElementById('generate-one').textContent = (lang==='ar')?'⚡ توليد القسم الحالي':'⚡ Generate current section';
    renderStep();
  }
  document.getElementById('toggle-theme').onclick = ()=>{
    state.theme = (state.theme==='dark'?'light':'dark');
    document.body.style.background = (state.theme==='dark')
      ? 'linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%)'
      : 'linear-gradient(180deg,#eef2ff 0%,#f7f9ff 100%)';
  };
  document.getElementById('lang-ar').onclick = ()=> setLang('ar');
  document.getElementById('lang-en').onclick = ()=> setLang('en');

  /*************** عرض الخطوة ***************/
  function weekInputs(){
    const days = (state.lang==='ar')? ['السبت','الأحد','الإثنين','الثلاثاء','الأربعاء','الخميس','الجمعة'] : ['Sat','Sun','Mon','Tue','Wed','Thu','Fri'];
    return days.map((d,i)=>`<label class="flex items-center gap-1 bg-white/5 px-2 py-1 rounded-md border border-white/10"><input type="checkbox" id="day-${i}" class="accent-[var(--brand2)]"><span>${d}</span></label>`).join('');
  }
  function muscleInputs(){
    const map = [
      ['chest','الصدر','Chest'],['back','الظهر','Back'],['shoulders','الأكتاف','Shoulders'],
      ['biceps','البايسبس','Biceps'],['triceps','الترايسبس','Triceps'],['quads','الأرجل الأمامية','Quads'],
      ['hamstrings','الأرجل الخلفية','Hamstrings'],['glutes','المؤخرة','Glutes'],['calves','السمانة','Calves'],['abs','البطن','Abs']
    ];
    return map.map(([k,ar,en])=>{
      const lab = (state.lang==='ar'?ar:en), v = state.muscles[k]||{on:false,note:''};
      return `<div class="grid grid-cols-2 gap-2 items-center">
        <label class="flex items-center gap-2"><input type="checkbox" id="m-${k}" class="accent-[var(--brand2)]" ${v.on?'checked':''}><span>${lab}</span></label>
        <input id="mnote-${k}" class="field" placeholder="${(state.lang==='ar')?'وصف المشكلة/السبب':'Describe the issue/reason'}" value="${esc(v.note)}">
      </div>`;
    }).join('');
  }
  function medicalInputs(){
    const items = [
      ['Hypertension','ضغط الدم'],['Diabetes','السكري'],['Insulin Resistance','مقاومة الأنسولين'],
      ['Thyroid issues','مشاكل الغدة'],['Hormonal issues','مشاكل هرمونية'],['Fatty Liver','الكبد الدهني'],
      ['Joint/Knee problems','مشاكل مفاصل/ركب'],['Heart disease','أمراض القلب'],['IBD/Ulcer','IBD/قرحة'],
      ['GERD/Reflux','GERD/ارتجاع'],['Gluten intolerance','عدم تحمل الجلوتين'],['Lactose intolerance','عدم تحمل اللاكتوز']
    ];
    return `<div class="grid md:grid-cols-2 gap-2">
      ${items.map(([en,ar],i)=>{
        const lab=(state.lang==='ar')?ar:en, checked = state.medical.conditions.includes(en);
        return `<label class="flex items-center gap-2"><input id="cond-${i}" type="checkbox" class="accent-[var(--brand2)]" ${checked?'checked':''}><span>${lab}</span></label>`;
      }).join('')}
    </div>`;
  }
  function currencyOptions(sel){ return ['USD','EUR','GBP','SAR','AED','KWD','QAR','EGP'].map(c=>`<option ${sel===c?'selected':''}>${c}</option>`).join('') }

  function renderStep(){
    const titles = T[state.lang].steps;
    document.getElementById('step-title').textContent = titles[state.step];
    const el = document.getElementById('step-body');
    const L=(k)=>t(k); const num=(ph='')=>`inputmode="numeric" pattern="[0-9]*" class="field" placeholder="${ph}"`;
    if(state.step===0){
      el.innerHTML = `
        <div class="grid md:grid-cols-3 gap-3">
          <div>
            <div class="font-extrabold mb-2">${L('profile')}</div>
            <div class="space-y-2">
              <label>${L('name')}<input id="name" class="field" value="${esc(state.profile.name)}" placeholder="${L('name')}"></label>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('age')}<input id="age" ${num()} value="${esc(state.profile.age)}"></label>
                <label>${L('sex')}
                  <select id="sex" class="field">
                    <option value="Male">${L('male')}</option>
                    <option value="Female">${L('female')}</option>
                  </select>
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('height')}<input id="height" ${num()} value="${esc(state.profile.height)}"></label>
                <label>${L('weight')}<input id="weight" ${num()} value="${esc(state.profile.weight)}"></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('bodyFat')}<input id="bodyFat" ${num()} value="${esc(state.profile.bodyFat)}"></label>
                <label>${L('waist')}<input id="waist" ${num()} value="${esc(state.profile.waist)}"></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('targetWeight')}<input id="targetWeight" ${num()} value="${esc(state.profile.targetWeight)}"></label>
                <label>${L('targetDate')}<input id="targetDate" type="date" class="field" value="${esc(state.profile.targetDate)}"></label>
              </div>
            </div>
          </div>

          <div>
            <div class="font-extrabold mb-2">${L('dietPrefs')}</div>
            <div class="space-y-2">
              <div>${L('goals')}</div>
              <div class="grid grid-cols-2 gap-2">
                ${['fatLoss','build','strength','endurance','health'].map(g=>`<label class="flex items-center gap-2"><input type="checkbox" id="g-${g}" class="accent-[var(--brand2)]" ${state.diet.goals.includes(L(g))?'checked':''}><span>${L(g)}</span></label>`).join('')}
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('mealsPerDay')}<input id="meals" ${num()} value="${esc(state.diet.mealsPerDay)}"></label>
                <label>${L('preferredDiet')}<select id="prefDiet" class="field">
                  <option value="Balanced">${L('balanced')}</option>
                  <option value="LowCarb">${L('lowCarb')}</option>
                  <option value="Keto">${L('keto')}</option>
                  <option value="Arabic/Mediter.">${L('med')}</option>
                  <option value="Plant">${L('veg')}</option>
                </select></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('fasting')}<select id="fasting" class="field">
                  <option value="off">${L('fastingOff')}</option>
                  <option value="16:8">16:8</option>
                  <option value="18:6">18:6</option>
                  <option value="20:4">20:4</option>
                </select></label>
                <label>${L('cuisine')}<input id="cuisine" class="field" value="${esc(state.diet.cuisine)}"></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('prepTime')}<input id="prep" ${num()} value="${esc(state.diet.prepTime)}"></label>
                <label>${L('budget')}<div class="flex gap-2">
                  <input id="budget" ${num()} value="${esc(state.diet.monthlyBudget)}" class="field flex-1">
                  <select id="currency" class="field w-24">${currencyOptions(state.currency)}</select>
                </div></label>
              </div>
              <label>${L('foodsAvoid')}<input id="avoid" class="field" value="${esc(state.diet.foodsToAvoid)}"></label>
              <label>${L('allergies')}<input id="allergies" class="field" value="${esc(state.diet.allergies)}"></label>
            </div>
          </div>

          <div>
            <div class="font-extrabold mb-2">${L('lifestyle')}</div>
            <div class="space-y-2">
              <div class="grid grid-cols-2 gap-2">
                <label>${L('workActivity')}<select id="work" class="field">
                  <option value="Sedentary">${(state.lang==='ar')?'مكتبي':'Sedentary'}</option>
                  <option value="Light">${(state.lang==='ar')?'نشاط خفيف':'Light'}</option>
                  <option value="Moderate">${(state.lang==='ar')?'متوسط':'Moderate'}</option>
                  <option value="High">${(state.lang==='ar')?'مرتفع':'High'}</option>
                </select></label>
                <label>${L('steps')}<input id="steps" ${num()} value="${esc(state.lifestyle.stepsPerDay)}"></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('sleep')}<select id="sleep" class="field">
                  <option value="Low">${(state.lang==='ar')?'منخفض':'Low'}</option>
                  <option value="Medium">${(state.lang==='ar')?'متوسط':'Medium'}</option>
                  <option value="High">${(state.lang==='ar')?'مرتفع':'High'}</option>
                </select></label>
                <label>${L('stress')}<select id="stress" class="field">
                  <option value="Low">${(state.lang==='ar')?'منخفض':'Low'}</option>
                  <option value="Medium">${(state.lang==='ar')?'متوسط':'Medium'}</option>
                  <option value="High">${(state.lang==='ar')?'مرتفع':'High'}</option>
                </select></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('place')}<input id="place" class="field" value="${esc(state.lifestyle.trainingPlace)}"></label>
                <label>${L('session')}<input id="session" ${num()} value="${esc(state.lifestyle.sessionLength)}"></label>
              </div>
              <div>
                <div class="mb-1">${L('days')}</div>
                <div class="grid grid-cols-7 gap-2 text-xs">${weekInputs()}</div>
              </div>
              <label>${L('equipment')}<input id="equip" class="field" value="${esc(state.lifestyle.equipment)}"></label>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('experience')}<select id="exp" class="field">
                  <option>Beginner (0-6m)</option><option>Intermediate (6-24m)</option><option>Advanced (24m+)</option>
                </select></label>
                <label>${L('rpe')}<input id="rpe" ${num()} value="${esc(state.lifestyle.rpe)}"></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('caffeine')}<input id="caf" ${num()} value="${esc(state.lifestyle.caffeine)}"></label>
                <label>${L('injuries')}<input id="inj" class="field" value="${esc(state.lifestyle.injuries)}"></label>
              </div>
              <div class="divider my-2"></div>
              <div class="font-extrabold">${L('quick')}</div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('restingHR')}<input id="q-hr" ${num()} value="${esc(state.fitness.restingHR)}"></label>
                <label>${L('pushups')}<input id="q-pu" ${num()} value="${esc(state.fitness.maxPushups)}"></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('plank')}<input id="q-pl" ${num()} value="${esc(state.fitness.plank)}"></label>
                <label>${L('kmTime')}<input id="q-km" class="field" value="${esc(state.fitness.kmTime)}" placeholder="5:30"></label>
              </div>
            </div>
          </div>

          <div class="md:col-span-3">
            <div class="font-extrabold mb-2">${L('medicalStatus')}</div>
            <div class="grid md:grid-cols-2 gap-3">
              <div class="space-y-2">
                <div class="text-sm opacity-80">${(state.lang==='ar')?'عضلات تحتاج عناية':'Muscles focus'}</div>
                ${muscleInputs()}
              </div>
              <div class="space-y-2">
                <div class="text-sm opacity-80">${L('medicalStatus')}</div>
                ${medicalInputs()}
                <label>${L('otherCond')}<input id="otherCond" class="field" value="${esc(state.medical.other)}"></label>
                <label>${L('currentMeds')}<input id="meds" class="field" value="${esc(state.medical.meds)}"></label>
                <label>${L('currentSupp')}<input id="supps" class="field" value="${esc(state.medical.supplements)}"></label>
                <label>${L('pastCh')}<input id="past" class="field" value="${esc(state.challenges.past)}"></label>
                <label>${L('motiv')}<select id="motiv" class="field">
                  <option value="Direct">${L('motivDir')}</option><option value="Warm">${L('motivWarm')}</option>
                </select></label>
              </div>
            </div>
          </div>
        </div>
      `;
      document.getElementById('sex').value = state.profile.sex||'Male';
      document.getElementById('prefDiet').value = state.diet.preferredDiet;
      document.getElementById('fasting').value = state.diet.fasting;
      document.getElementById('currency').value = state.currency;
      document.getElementById('work').value = state.lifestyle.workActivity;
      document.getElementById('sleep').value = state.lifestyle.sleep;
      document.getElementById('stress').value = state.lifestyle.stress;
      document.getElementById('exp').value = state.lifestyle.experience;
      document.getElementById('motiv').value = state.challenges.motivation;
    }
    // أزرار
    document.getElementById('prev').disabled = state.step===0;
    document.getElementById('next').classList.toggle('hidden', state.step!==0 ? false : false);
    document.getElementById('generate-one').classList.toggle('hidden', state.step!==0);
  }

  function saveStep(){
    if(state.step!==0) return;
    const $ = (id)=>document.getElementById(id);
    // Profile
    state.profile.name = $('name').value.trim(); state.profile.age = $('age').value.trim();
    state.profile.height = $('height').value.trim(); state.profile.weight = $('weight').value.trim();
    state.profile.bodyFat = $('bodyFat').value.trim(); state.profile.waist = $('waist').value.trim();
    state.profile.sex = $('sex').value; state.profile.targetWeight = $('targetWeight').value.trim();
    state.profile.targetDate = $('targetDate').value;
    // Diet
    const goals=[]; ['fatLoss','build','strength','endurance','health'].forEach(g=>{ if($('g-'+g).checked) goals.push(t(g)) });
    state.diet.goals = goals; state.diet.mealsPerDay = Number($('meals').value||3);
    state.diet.preferredDiet = $('prefDiet').value; state.diet.fasting = $('fasting').value;
    state.diet.cuisine = $('cuisine').value; state.diet.prepTime = Number($('prep').value||20);
    state.diet.monthlyBudget = Number($('budget').value||0); state.currency = $('currency').value;
    state.diet.foodsToAvoid = $('avoid').value; state.diet.allergies = $('allergies').value;
    // Lifestyle
    state.lifestyle.workActivity = $('work').value; state.lifestyle.stepsPerDay = Number($('steps').value||6000);
    state.lifestyle.sleep = $('sleep').value; state.lifestyle.stress = $('stress').value;
    state.lifestyle.trainingPlace = $('place').value; state.lifestyle.sessionLength = Number($('session').value||60);
    state.lifestyle.availableDays = []; for(let i=0;i<7;i++) if($(`day-${i}`).checked) state.lifestyle.availableDays.push(i);
    state.lifestyle.equipment = $('equip').value; state.lifestyle.experience = $('exp').value;
    state.lifestyle.rpe = Number($('rpe').value||8); state.lifestyle.caffeine = Number($('caf').value||0);
    state.lifestyle.injuries = $('inj').value;
    // Fitness
    state.fitness.restingHR = $('q-hr').value; state.fitness.maxPushups = $('q-pu').value;
    state.fitness.plank = $('q-pl').value; state.fitness.kmTime = $('q-km').value;
    // Muscles
    Object.keys(state.muscles).forEach(k=>{
      state.muscles[k].on = $(`m-${k}`).checked; state.muscles[k].note = $(`mnote-${k}`).value;
    });
    // Medical
    state.medical.conditions = [];
    const map=['Hypertension','Diabetes','Insulin Resistance','Thyroid issues','Hormonal issues','Fatty Liver','Joint/Knee problems','Heart disease','IBD/Ulcer','GERD/Reflux','Gluten intolerance','Lactose intolerance'];
    for(let i=0;i<map.length;i++){ const el=document.getElementById(`cond-${i}`); if(el && el.checked) state.medical.conditions.push(map[i]) }
    state.medical.other = $('otherCond').value; state.medical.meds = $('meds').value; state.medical.supplements = $('supps').value;
    state.challenges.past = $('past').value; state.challenges.motivation = $('motiv').value;
  }

  /*************** حساب السعرات/الماكروز ***************/
  function computeTargets(){
    const p=state.profile, L=state.lifestyle, D=state.diet;
    const W=+p.weight||0, H=+p.height||0, A=+p.age||0;
    const male = (p.sex==='Male'||p.sex===t('male'));
    const BMR = male ? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161;
    const actMap = { 'Sedentary':1.2, 'Light':1.35, 'Moderate':1.5, 'High':1.7 };
    let TDEE = BMR * (actMap[L.workActivity]||1.35);
    if(D.goals.includes(t('fatLoss'))) TDEE *= 0.85;
    if(D.goals.includes(t('build'))) TDEE *= 1.10;
    const targetW = Number(p.targetWeight)||W||1;
    let protein = Math.round(2.0*targetW);
    let fat = Math.round(Math.max(0.8*W, 40));
    let carbs = Math.round((TDEE - (protein*4 + fat*9))/4);
    const hasIR = state.medical.conditions.includes('Diabetes')||state.medical.conditions.includes('Insulin Resistance');
    if(hasIR) carbs = Math.min(carbs, 120);
    carbs = Math.max(40, carbs);
    return { bmr:Math.round(BMR), tdee:Math.round(TDEE), protein_g:protein, fat_g:fat, carb_g:carbs };
  }

  /*************** Gemini سياق/قواعد ومنع التكرار ***************/
  // كتلة الذكاء تم تضمينها كملحق منفصل لضمان جودة المخرجات
  // (PlanState/SECTIONS/callGemini/sanitize موجودة أدناه)
  </script>

  <!-- ====== محرّك الذكاء: سياق وانسيابية ومنع تكرار ====== -->
  <script>
  let APP_LANG = (state.lang || 'ar');

  // حالة الخطة المشتركة بين الأقسام
  const PlanState = {
    lang: APP_LANG,
    profile: null,
    completedSections: [],
    seenSentences: new Set(),
    pushSection(key,text){ this.completedSections.push({key,text}) },
    previousContext(max=5000){
      const joined = this.completedSections.map(s=>`# ${s.key}\n${s.text}`).join('\n\n');
      return joined.slice(-max);
    }
  };

  const i18nLLM = {
    ar: {
      longForm: "اكتب بإسهاب وبدون اختصار وبنبرة عملية واضحة.",
      noDup: "لا تُكرر بيانات الملف الشخصي أو الترحيب أو أي محتوى سبق ذكره.",
      noDisc: "يُمنع كتابة جُمل عامة من نوع: هذه خطة عامة/ليست مخصصة/استشر أخصائي/ليست نصيحة طبية… إلخ.",
      flow: "حافظ على انسيابية الحديث وبنِ على الأقسام السابقة. لا تبدأ محادثة جديدة.",
      only: "اكتب باللغة العربية فقط.",
      sectionIntro: "ابدأ مباشرة بمحتوى هذا القسم بلا ترحيب ولا إعادة تعريف."
    },
    en: {
      longForm: "Write in-depth (no summaries) with a practical, direct tone.",
      noDup: "Do not repeat the profile, welcome, or previous content.",
      noDisc: "Do NOT add generic warnings like 'not personalized', 'consult a professional', or 'not medical advice'.",
      flow: "Ensure narrative continuity; build on earlier sections.",
      only: "Write in English only.",
      sectionIntro: "Start directly with the content for this section; no greetings."
    }
  };

  function buildRules(lang){
    const t=i18nLLM[lang];
    return `- ${t.longForm}\n- ${t.only}\n- ${t.noDup}\n- ${t.noDisc}\n- ${t.flow}\n- ${t.sectionIntro}\n- قدّم عناوين فرعية وجداول عند الحاجة فقط داخل هذا القسم.`;
  }

  function sanitizeLLM(raw, lang='ar'){
    let text=String(raw||'');
    const RE_STRIP=[
      /هذه المعلومات.*?ليست(?:\s|\S){0,40}?استشارة(?:\s|\S){0,10}?طبيب.*$/gim,
      /هذه الخطة.*?(?:غير|ليست).*?(?:مخصصة|طبية).*$/gim,
      /استشر\s+(?:طبيب|أخصائي|مدرب)[^\n]*$/gim,
      /this (?:plan|information).*?(?:not|isn['’]t).*?(?:personalized|medical advice)[^\n]*$/gim,
      /consult (?:a )?(?:physician|doctor|dietitian|coach)[^\n]*$/gim,
      /<!DOCTYPE[\s\S]*?<body[^>]*>/gim, /<\/body>\s*<\/html>/gim
    ];
    RE_STRIP.forEach(rx=>text=text.replace(rx,''));
    if(lang==='ar'){
      text = text.split('\n').filter(line=>{
        const latin=(line.match(/[A-Za-z]/g)||[]).length, arab=(line.match(/[\u0600-\u06FF]/g)||[]).length;
        return arab>=latin;
      }).join('\n');
    }else{
      text = text.split('\n').filter(line=>{
        const latin=(line.match(/[A-Za-z]/g)||[]).length, arab=(line.match(/[\u0600-\u06FF]/g)||[]).length;
        return latin>=arab;
      }).join('\n');
    }
    const dedup=[]; for(const para of text.split('\n')){ const p=para.trim(); if(!p){dedup.push(''); continue;}
      const key=p.replace(/\s+/g,' ').toLowerCase(); if(PlanState.seenSentences.has(key)) continue; PlanState.seenSentences.add(key); dedup.push(para); }
    text=dedup.join('\n').replace(/\n{3,}/g,'\n\n').trim();
    return text;
  }

  function buildSectionPrompt({lang, sectionKey, title, directives}){
    const rules = buildRules(lang);
    const prev = PlanState.previousContext();
    const profile = PlanState.profile||{};
    return [
      `القسم: ${title} (${sectionKey})`,
      `اللغة: ${lang==='ar'?'العربية':'English'}`,
      `قواعد ملزمة:\n${rules}`,
      `بيانات المستخدم (لا تُعد طباعتها):\n${JSON.stringify(profile)}`,
      `سياق أقسام سابقة (ملخص للاستدلال فقط):\n${prev || '(لا سياق سابق)'}\n----`,
      `تعليمات هذا القسم:\n${directives}`,
      `أنتج الآن محتوى هذا القسم فقط، مطوّلًا وغير مختصر.`
    ].join('\n');
  }

  async function callGemini(prompt){
    const res = await fetch('/.netlify/functions/gemini-proxy', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({prompt}) });
    if(!res.ok){ const msg=await res.text(); throw new Error(`Gemini proxy error: ${res.status} ${msg}`) }
    const data = await res.json(); return data.text||'';
  }

  // تعريف الأقسام كاملة (عربي/إنجليزي)
  const SECTIONS = (()=> {
    const base = [
      { key:'welcome', title:{ar:'الترحيب',en:'Welcome'},
        ar:`فقرة ترحيبية قصيرة (3–4 أسطر) مرتبطة بأهداف المستخدم المحددة، دون إعادة تعريف أو سرد بيانات شخصية.`,
        en:`Short welcome (3–4 lines) tied to the user's stated goals; no re-introductions.` },
      { key:'analysis', title:{ar:'التحليل',en:'Analysis'},
        ar:`تحليل وضع المستخدم (السعرات والماكروز المشتقة من الحسابات، والنشاط، والقيود الطبية) مع ربط منطقي بما ورد في الترحيب.`,
        en:`Deep analysis of calories/macros/activity and medical constraints with narrative continuity.` },
      { key:'allowed', title:{ar:'المسموح/الممنوع',en:'Allowed / Avoid'},
        ar:`قائمة بالأطعمة المسموح بها والممنوعة/المحددة حسب المطبخ المفضل والميزانية والحساسيات، بنقاط مركزة وعملية.`,
        en:`Allowed and limit/avoid lists tailored to cuisine, budget, allergies.` },
      { key:'fasting', title:{ar:'الصيام',en:'Fasting'},
        ar:`شرح عملي لتطبيق الصيام المتقطع (${state.diet.fasting}) مع التنظيم الزمني للسوائل والكافيين والتدريب.`,
        en:`Actionable guide to implement intermittent fasting (${state.diet.fasting}).` },
    ];

    // تغذية 1..7
    for(let d=1; d<=7; d++){
      base.push({
        key:`nutrition-${d}`,
        title:{ar:`التغذية – يوم ${d}`, en:`Nutrition – Day ${d}`},
        ar:`ابنِ خطة يوم ${d} بجدول: الوجبة | المكونات بالجرامات | kcal | Protein | Fat | Carbs. 
             قدّم 3–${state.diet.mealsPerDay} وجبات + 1–2 سناك. أختم بسطر إجمالي مطابق للأهداف ضمن ±10%.`,
        en:`Build day ${d} meals table with grams and macros; end with totals within ±10% of targets.`
      });
    }
    // تدريب 1..7
    for(let d=1; d<=7; d++){
      base.push({
        key:`training-${d}`,
        title:{ar:`التدريب – يوم ${d}`, en:`Training – Day ${d}`},
        ar:`جدول: التمرين (إنجليزي) | المجموعات | العدّات | الراحة (ث). راعِ الإصابات والعضلات الضعيفة.`,
        en:`Table: Exercise (EN) | Sets | Reps | Rest (s). Respect injuries and weak muscles.`
      });
    }
    // بقية الأقسام
    base.push(
      { key:'supplements', title:{ar:'المكملات',en:'Supplements'},
        ar:`مكدّس أساسي + خاص بالهدف + خيار اقتصادي مع الجرعات والتوقيت، دون أي إخلاء طبي عام.`,
        en:`Essential stack + goal-specific + budget option with doses & timing.` },
      { key:'progression', title:{ar:'التقدّم',en:'Progression'},
        ar:`نموذج تقدّم 8–12 أسبوعًا (رفع أوزان/تكرارات، دلود، إعادة تقدير TDEE مع تغيّر الوزن، كارديو).`,
        en:`8–12 week progression model with weights/reps increases, deloads, and TDEE recalcs.` },
      { key:'troubleshoot', title:{ar:'المشاكل',en:'Troubleshooting'},
        ar:`حلول موجزة لـ: الجوع، الثبات، النوم، التوتر، الشره، السفر، الأكل خارج المنزل (2–3 نقاط لكل مشكلة).`,
        en:`2–3 bullets each for hunger, plateaus, sleep, stress, cravings, travel, eating out.` },
      { key:'safety', title:{ar:'السلامة',en:'Safety'},
        ar:`ملاحظات السلامة: تقنية، وقاية إصابات، سوائل ونوم، ومتى ننهي الجلسة.`,
        en:`Safety notes: technique, injury prevention, hydration, sleep, when to stop a session.` },
      { key:'closing', title:{ar:'الختام',en:'Closing'},
        ar:`فقرة ختامية قصيرة متسقة مع ما سبق، بلا ترحيب جديد أو إعادة سرد.`,
        en:`Short closing consistent with prior sections; no new greeting or re-introductions.` },
    );
    return base;
  })();

  function sectionSpecByKey(key){
    return SECTIONS.find(s=>s.key===key);
  }

  async function generateSection(key, targets){
    const spec = sectionSpecByKey(key);
    if(!spec) throw new Error('Unknown section '+key);
    const title = spec.title[PlanState.lang];
    let directives = spec[PlanState.lang === 'ar' ? 'ar':'en'];

    // إدراج أهداف الطاقة/الماكروز عند الحاجة
    if(/nutrition|analysis|allowed|fasting|training|supplements|progression/i.test(key)){
      directives += `\n\nالأهداف اليومية: ~${targets.tdee} kcal | بروتين ${targets.protein_g}g | دهون ${targets.fat_g}g | كارب ${targets.carb_g}g.`;
    }

    const prompt = buildSectionPrompt({
      lang: PlanState.lang,
      sectionKey: key,
      title, directives
    });
    const raw = await callGemini(prompt);
    const clean = sanitizeLLM(raw, PlanState.lang);
    PlanState.pushSection(key, clean);
    return clean;
  }

  // توليد متسلسل مع رد نداء تقدم
  async function generatePlanSequential(keys, onProgress, targets){
    for(let i=0;i<keys.length;i++){
      const k=keys[i];
      try{
        const txt = await generateSection(k, targets);
        onProgress?.({key:k,status:'ok',text:txt,index:i,total:keys.length});
      }catch(e){
        onProgress?.({key:k,status:'error',error:String(e),index:i,total:keys.length});
      }
    }
  }

  // واجهة ربط مع نموذج الإدخال
  window.APP_API = {
    setProfile:(obj)=>{ PlanState.profile={...obj}; },
    generateAllSequentially:(keys,onProgress,targets)=>generatePlanSequential(keys,onProgress,targets)
  };
  </script>

  <!-- ====== ربط التوليد بالواجهة وDl/Regenerate ====== -->
  <script>
  function sectionCard(key,title){
    return `
    <div class="glass p-3" data-section="${key}">
      <div class="flex items-center justify-between">
        <div class="font-extrabold">${title}</div>
        <div class="flex items-center gap-2">
          <button class="btn btn-ghost text-xs" data-reg="${key}">↻ ${ (state.lang==='ar')?'إعادة توليد هذا القسم':'Regenerate' }</button>
          <span class="badge" id="st-${key}">…</span>
        </div>
      </div>
      <div class="mt-3 progress"><i id="bar-${key}" style="width:0%"></i></div>
      <div class="mt-3 prose prose-invert max-w-none section-body text-sm leading-7"></div>
    </div>`;
  }

  function addSectionCard(key,title){
    const wrap=document.getElementById('plan-content');
    const temp=document.createElement('div'); temp.innerHTML=sectionCard(key,title);
    wrap.appendChild(temp.firstElementChild);
    document.querySelector(`[data-reg="${key}"]`).onclick = ()=> regenerateOne(key);
  }

  async function regenerateOne(key){
    const targets=state.targets||computeTargets();
    const spec = sectionSpecByKey(key);
    if(!spec) return;
    const bar=document.getElementById(`bar-${key}`), st=document.getElementById(`st-${key}`);
    st.textContent=(state.lang==='ar')?'يعاد التوليد…':'Regenerating…'; bar.style.width='15%';
    try{
      const txt = await generateSection(key, targets);
      renderSection(key, txt);
      st.textContent=(state.lang==='ar')?'تم':'Done'; bar.style.width='100%';
    }catch(e){
      st.textContent='Failed'; bar.style.width='100%';
      renderSection(key, `**${(state.lang==='ar')?'فشل التوليد':'Generation failed'}**\n\n\`${String(e).slice(0,280)}\``);
    }
  }

  function renderSection(key, md){
    const el = document.querySelector(`[data-section="${key}"] .section-body`);
    if(!el) return;
    el.innerHTML = marked.parse(md||'');
  }

  // الأحداث
  document.getElementById('btn-print').onclick = ()=>window.print();
  document.getElementById('print-bottom').onclick = ()=>window.print();
  document.getElementById('scroll-top').onclick = ()=>window.scrollTo({top:0,behavior:'smooth'});

  document.getElementById('prev').onclick = ()=>{ state.step=Math.max(0,state.step-1); renderStep(); };
  document.getElementById('next').onclick = ()=>{
    if(state.step===0){
      saveStep();
      if(!(state.profile.name && state.profile.age && state.profile.height && state.profile.weight)){ toast(t('needBasics')); return; }
      // جهِّز الأهداف ثم ابدأ المعاينة
      state.targets = computeTargets();
      // جهز الحالة المشتركة للذكاء
      PlanState.lang = state.lang; PlanState.profile = {...state.profile, diet:state.diet, lifestyle:state.lifestyle, medical:state.medical };
      beginGenerationFlow();
    }
    state.step = Math.min(3, state.step+1);
    renderStep();
  };

  async function beginGenerationFlow(){
    // مصفوفة الأقسام بالترتيب (مع الصيام إن لزم)
    const keys = ['welcome','analysis','allowed', ...(state.diet.fasting!=='off'?['fasting']:[]),
      ...Array.from({length:7},(_,i)=>`nutrition-${i+1}`),
      ...Array.from({length:7},(_,i)=>`training-${i+1}`),
      'supplements','progression','troubleshoot','safety','closing'
    ];
    // بطاقات
    const planWrap=document.getElementById('plan-content'); planWrap.innerHTML='';
    keys.forEach(k=> addSectionCard(k, sectionSpecByKey(k).title[state.lang]));
    // تقدم عام
    const gbar=document.getElementById('global-progress'), ov=document.getElementById('overlay'), ovbar=document.getElementById('ov-bar');
    ov.classList.remove('hidden');

    // ابدأ توليد متسلسل مع عرض النتائج لحظيًا
    await window.APP_API.generateAllSequentially(keys, (ev)=>{
      const bar=document.getElementById(`bar-${ev.key}`), st=document.getElementById(`st-${ev.key}`);
      const pct=Math.round(((ev.index)/keys.length)*100); gbar.style.width=pct+'%'; ovbar.style.width=pct+'%';
      if(ev.status==='ok'){ st.textContent=(state.lang==='ar')?'تم التوليد':'Ready'; bar.style.width='100%'; renderSection(ev.key, ev.text); }
      else{ st.textContent='Failed'; bar.style.width='100%'; renderSection(ev.key, `**${(state.lang==='ar')?'تعذّر توليد هذا القسم':'Failed to generate'}**`); }
      if(ev.index===keys.length-1){ gbar.style.width='100%'; ovbar.style.width='100%'; ov.classList.add('hidden'); }
    }, state.targets);
  }

  // بدء
  window.addEventListener('load', ()=>{ setLang(state.lang); renderStep(); });
  </script>
</body>
</html>
