<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ± â€” Ø®Ø·Ø© Ù…Ø®ØµØµØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- html2pdf -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --sub:#475569;
      --line:#e5e7eb;
      --brand:#645cff;
      --accent:#22c55e;
      --chip:#eef2ff;
    }
    html.dark{
      --bg:#0b0f17;
      --card:#0f1624;
      --ink:#f1f5f9;
      --sub:#9aa4b2;
      --line:#1f2738;
      --brand:#7d86ff;
      --accent:#34d399;
      --chip:#121a2b;
    }
    *{ font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,sans-serif }
    body{ background:var(--bg); color:var(--ink) }
    .card{ background:var(--card); border:1px solid var(--line) }
    .btn{ @apply px-4 py-2 rounded-lg font-bold }
    .btn-primary{ background:var(--brand); color:#fff }
    .btn-ghost{ background:transparent; border:1px solid var(--line); color:var(--ink) }
    .progress-bar{ height:8px; background:linear-gradient(90deg,var(--brand),var(--accent)); transition:width .25s }
    .tag{ background:var(--chip); border:1px solid var(--line); color:var(--sub); @apply text-xs px-2 py-0.5 rounded }
    .h-title{ @apply text-xl md:text-2xl font-extrabold; letter-spacing:.1px }
    .h-sec{ @apply text-lg md:text-xl font-extrabold mt-6 mb-3; border-inline-start:6px solid var(--brand); padding-inline-start:.75rem }
    .h-day{ @apply text-base md:text-lg font-extrabold mt-4 mb-2; color:var(--brand) }
    .prose :where(h3){ @apply text-xl font-extrabold mt-6 mb-3; border-inline-start-8:var(--brand) }
    .kbd{ @apply text-xs px-2 py-0.5 rounded border; border-color:var(--line); background:var(--chip); color:var(--sub) }
    .print-ready *{ animation:none !important; transition:none !important }
    @media print{
      body{ background:#fff }
      #topbar,#setup,#topActions{display:none !important}
      #resultRoot{ box-shadow:none !important; border:none !important }
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- Topbar -->
  <header id="topbar" class="sticky top-0 z-40 backdrop-blur bg-[color:var(--card)]/90 border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="size-9 rounded-lg grid place-items-center text-white font-extrabold" style="background:var(--brand)">AI</div>
        <div>
          <div class="font-extrabold">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±</div>
          <div class="text-[11px] text-[color:var(--sub)]">Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© 100% Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ø®ØµØµØ© Ù„Ùƒ</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="lang-ar" class="btn btn-ghost text-sm">Ø¹Ø±Ø¨ÙŠ</button>
        <button id="lang-en" class="btn btn-ghost text-sm">EN</button>
        <div class="w-px h-6 bg-[color:var(--line)]"></div>
        <button id="btn-theme" class="btn btn-ghost text-sm" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ">ğŸŒ“</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Intro -->
    <section class="card rounded-2xl p-5 md:p-7 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h1 class="h-title mb-1">Ù„Ù†ÙÙ†Ø´Ø¦ Ø£ÙØ¶Ù„ Ø®Ø·Ø© Ù…Ù…ÙƒÙ†Ø© Ù„Ù‡Ø¯ÙÙƒ</h1>
          <p class="text-sm text-[color:var(--sub)]">
            Ø³Ù†ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø®Ø·Ø© **Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù…** Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ù‘Ø© ÙˆØ§Ù„Ø´Ù…ÙˆÙ„. Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© = Ø®Ø·Ø© Ø£Ø´Ø¯ ØªØ®ØµÙŠØµÙ‹Ø§.
          </p>
        </div>
        <div id="topActions" class="flex flex-wrap items-center gap-2">
          <button id="start" class="btn btn-primary">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙˆÙ„ÙŠØ¯</button>
          <button id="regen" class="btn btn-ghost hidden">Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ ÙƒØ§Ù…Ù„</button>
        </div>
      </div>

      <!-- Progress -->
      <div class="mt-4">
        <div class="w-full h-2 rounded-full overflow-hidden bg-[color:var(--line)]">
          <div id="progress" class="progress-bar w-0"></div>
        </div>
        <div id="ptext" class="text-[12px] text-[color:var(--sub)] mt-1">Ø¬Ø§Ù‡Ø²</div>
      </div>
    </section>

    <!-- Form -->
    <section id="setup" class="grid grid-cols-1 lg:grid-cols-3 gap-5">
      <!-- Profile -->
      <div class="card rounded-2xl p-5">
        <div class="h-sec">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
        <div class="grid grid-cols-2 gap-3">
          <label class="col-span-2">
            <div class="text-sm mb-1">Ø§Ù„Ø§Ø³Ù…</div>
            <input id="name" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="Ø§Ù„Ø§Ø³Ù…"/>
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„Ø¹Ù…Ø±</div>
            <input id="age" type="number" min="12" max="100" class="w-full rounded-lg border px-3 py-2 bg-transparent"/>
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</div>
            <input id="height" type="number" min="120" max="230" class="w-full rounded-lg border px-3 py-2 bg-transparent"/>
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</div>
            <input id="weight" type="number" min="30" max="250" class="w-full rounded-lg border px-3 py-2 bg-transparent"/>
          </label>
          <label>
            <div class="text-sm mb-1">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† %</div>
            <input id="bodyfat" type="number" step="0.1" min="3" max="60" class="w-full rounded-lg border px-3 py-2 bg-transparent"/>
          </label>
          <label>
            <div class="text-sm mb-1">Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ± (Ø³Ù…)</div>
            <input id="waist" type="number" min="40" max="160" class="w-full rounded-lg border px-3 py-2 bg-transparent"/>
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„Ø¬Ù†Ø³</div>
            <select id="gender" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option value="Male">Ø°ÙƒØ±</option>
              <option value="Female">Ø£Ù†Ø«Ù‰</option>
            </select>
          </label>
          <label class="col-span-2">
            <div class="text-sm mb-1">Ù‡Ø¯Ù Ø±Ù‚Ù…ÙŠ/Ù…ÙˆØ¹Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
            <input id="targetNote" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="Ù…Ø«Ø§Ù„: -8ÙƒØº Ø®Ù„Ø§Ù„ 12 Ø£Ø³Ø¨ÙˆØ¹Ø§Ù‹â€¦"/>
          </label>
        </div>
      </div>

      <!-- Diet & Preferences -->
      <div class="card rounded-2xl p-5">
        <div class="h-sec">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª</div>
        <div class="grid grid-cols-2 gap-3">
          <label class="col-span-2">
            <div class="text-sm mb-1">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ø§Ø®ØªØ± Ø¹Ø¯Ø©)</div>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†" class="accent-[var(--brand)]"><span>Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª" class="accent-[var(--brand)]"><span>Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©" class="accent-[var(--brand)]"><span>Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„" class="accent-[var(--brand)]"><span>ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="ØµØ­Ø© Ø¹Ø§Ù…Ø©" class="accent-[var(--brand)]"><span>ØµØ­Ø© Ø¹Ø§Ù…Ø©</span></label>
            </div>
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù„</div>
            <select id="diet" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>Ù†Ø¸Ø§Ù… Ù…ØªÙˆØ§Ø²Ù†</option>
              <option>Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª</option>
              <option>ØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹</option>
              <option>ÙƒÙŠØªÙˆ</option>
              <option>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
              <option>Ù†Ø¨Ø§ØªÙŠ</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</div>
            <select id="meals" class="w-full rounded-lg border px-3 py-2 bg-transparent"><option>3</option><option>4</option><option>5</option></select>
          </label>
          <label>
            <div class="text-sm mb-1">ØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹</div>
            <select id="fasting" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option value="off">ØºÙŠØ± Ù…ÙØ¹Ù„</option>
              <option>16:8</option><option>18:6</option><option>20:4</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">Ù…Ø·Ø¨Ø® Ù…ÙØ¶Ù„</div>
            <select id="cuisine" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>Ø¹Ø±Ø¨ÙŠ/Ù…ØªÙˆØ³Ø·ÙŠ</option><option>ØºØ±Ø¨ÙŠ</option><option>Ø¢Ø³ÙŠÙˆÙŠ</option><option>Ù…ØªÙ†ÙˆØ¹</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">Ø²Ù…Ù† Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø¯)</div>
            <input id="cookTime" type="number" min="5" max="90" class="w-full rounded-lg border px-3 py-2 bg-transparent"/>
          </label>
          <label>
            <div class="text-sm mb-1">Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙŠÙˆÙ…ÙŠØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©</div>
            <input id="budget" type="number" min="0" step="1" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="Ø¹Ù…Ù„Ø© Ù…Ø­Ù„ÙŠØ©"/>
          </label>
          <label class="col-span-2">
            <div class="text-sm mb-1">Ø£Ø·Ø¹Ù…Ø© Ù„Ø§ ØªØ±ØºØ¨ Ø¨Ù‡Ø§/Ø­Ø³Ø§Ø³ÙŠØ©</div>
            <input id="dislikes" class="w-full rounded-lg border px-3 py-2 bg-transparent"/>
          </label>
        </div>
      </div>

      <!-- Lifestyle & Training -->
      <div class="card rounded-2xl p-5">
        <div class="h-sec">Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨</div>
        <div class="grid grid-cols-2 gap-3">
          <label>
            <div class="text-sm mb-1">Ø§Ù„Ø¹Ù…Ù„</div>
            <select id="job" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option value="Sedentary">Ù…ÙƒØªØ¨ÙŠ</option><option value="Light">Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ</option><option value="Moderate">Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">Ø®Ø·ÙˆØ§Øª/Ø§Ù„ÙŠÙˆÙ…</div>
            <input id="steps" type="number" min="0" step="100" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="Ù…Ø«Ø§Ù„: 6000"/>
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„Ù†ÙˆÙ… (Ø³)</div>
            <input id="sleep" type="number" min="3" max="12" class="w-full rounded-lg border px-3 py-2 bg-transparent"/>
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„ØªÙˆØªØ±</div>
            <select id="stress" class="w-full rounded-lg border px-3 py-2 bg-transparent"><option>Ù…Ù†Ø®ÙØ¶</option><option>Ù…ØªÙˆØ³Ø·</option><option>Ù…Ø±ØªÙØ¹</option></select>
          </label>
          <label>
            <div class="text-sm mb-1">Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>
            <select id="place" class="w-full rounded-lg border px-3 py-2 bg-transparent"><option>Ù†Ø§Ø¯ÙŠ</option><option>Ù…Ù†Ø²Ù„</option></select>
          </label>
          <label>
            <div class="text-sm mb-1">Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯)</div>
            <input id="session" type="number" min="20" max="120" class="w-full rounded-lg border px-3 py-2 bg-transparent"/>
          </label>
          <label class="col-span-2">
            <div class="text-sm mb-1">Ø£ÙŠØ§Ù… Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ¯Ø±ÙŠØ¨</div>
            <div class="grid grid-cols-4 gap-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Sat" class="accent-[var(--brand)]"><span>Ø§Ù„Ø³Ø¨Øª</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Sun" class="accent-[var(--brand)]"><span>Ø§Ù„Ø£Ø­Ø¯</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Mon" class="accent-[var(--brand)]"><span>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Tue" class="accent-[var(--brand)]"><span>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Wed" class="accent-[var(--brand)]"><span>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Thu" class="accent-[var(--brand)]"><span>Ø§Ù„Ø®Ù…ÙŠØ³</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="days" value="Fri" class="accent-[var(--brand)]"><span>Ø§Ù„Ø¬Ù…Ø¹Ø©</span></label>
            </div>
          </label>
          <label class="col-span-2">
            <div class="text-sm mb-1">Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
            <input id="equipment" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="Ø¯Ù…Ø¨Ù„ØŒ Ø¨Ø§Ø±â€¦"/>
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„Ø®Ø¨Ø±Ø© (RPE)</div>
            <select id="exp" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>Ù…Ø¨ØªØ¯Ø¦ (0-6 Ø£Ø´Ù‡Ø±)</option><option>Ù…ØªÙˆØ³Ø· (6-24 Ø´Ù‡Ø±)</option><option>Ù…ØªÙ‚Ø¯Ù… (+24 Ø´Ù‡Ø±)</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">ÙƒØ§ÙÙŠÙŠÙ†/ÙŠÙˆÙ… (Ø£ÙƒÙˆØ§Ø¨)</div>
            <input id="caffeine" type="number" min="0" max="10" class="w-full rounded-lg border px-3 py-2 bg-transparent"/>
          </label>
          <label class="col-span-2">
            <div class="text-sm mb-1">Ø¥ØµØ§Ø¨Ø§Øª/Ù‚ÙŠÙˆØ¯</div>
            <input id="injuries" class="w-full rounded-lg border px-3 py-2 bg-transparent"/>
          </label>
          <label class="col-span-2">
            <div class="text-sm mb-1">Ø£Ø¯ÙˆÙŠØ©/Ù…ÙƒÙ…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ©</div>
            <input id="meds" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©/Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øªâ€¦"/>
          </label>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section id="result" class="hidden mt-6">
      <div id="resultRoot" class="card rounded-2xl p-5 md:p-8">
        <div class="flex items-center justify-between gap-3 mb-3">
          <div class="h-title">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© â€” Ù…Ø®ØµØµØ© 100%</div>
          <div class="flex items-center gap-2">
            <span class="tag">Ø³ÙŠØ§Ù‚ ÙˆØ§Ø­Ø¯ â€¢ Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</span>
            <span class="tag">ØªÙˆÙ„ÙŠØ¯ ÙŠÙˆÙ… Ø¨ÙŠÙˆÙ…</span>
          </div>
        </div>
        <article id="ai" class="prose max-w-none prose-p:leading-7 prose-ul:leading-7 prose-ol:leading-7"></article>

        <!-- Bottom actions (as requested) -->
        <div class="mt-6 flex flex-wrap items-center justify-center gap-2">
          <button id="print2" class="btn btn-ghost">Ø·Ø¨Ø§Ø¹Ø©</button>
          <button id="pdf2" class="btn btn-ghost">PDF</button>
        </div>
      </div>
    </section>

    <footer class="text-center text-[11px] text-[color:var(--sub)] mt-6">
      Powered by Mustafa Elsafy 2025 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
    </footer>
  </main>

  <script>
    /*********** Helpers ***********/
    const $ = (id)=>document.getElementById(id);
    const PROXY_URL = '/.netlify/functions/gemini-proxy';

    const st = { lang:'ar' };
    const tr = (ar,en)=> st.lang==='ar'? ar : en;

    function setLang(l){
      st.lang=l;
      document.documentElement.lang = l==='ar'?'ar':'en';
      document.documentElement.dir  = l==='ar'?'rtl':'ltr';
      $('lang-ar').classList.toggle('btn-primary', l==='ar');
      $('lang-en').classList.toggle('btn-primary', l==='en');
      $('ptext').textContent = tr('Ø¬Ø§Ù‡Ø²','Ready');
    }
    function toggleTheme(){ document.documentElement.classList.toggle('dark') }

    function setProgress(step,total,label){
      $('progress').style.width = Math.round((step/total)*100)+'%';
      $('ptext').textContent = `${Math.round((step/total)*100)}% â€” ${label}`;
    }

    function spinner(label){
      const d = document.createElement('div');
      d.id = 'spin';
      d.className = "tag block w-full text-center my-2 py-2";
      d.textContent = tr('Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¹Ø¯Ø§Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ù†Ø§ÙŠØ©ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±â€¦','Preparing this section carefully, please waitâ€¦')+' â€” '+label;
      $('ai').appendChild(d);
    }
    function endSpin(html){
      const s = $('spin'); if(s) s.remove();
      const box = document.createElement('section');
      box.innerHTML = marked.parse(html);
      $('ai').appendChild(box);
    }

    /*********** Collect ***********/
    function getChecks(name){ return [...document.querySelectorAll(`input[name="${name}"]:checked`)].map(e=>e.value) }
    function collect(){
      return {
        name:$('name').value?.trim(),
        age:+$('age').value||0,
        height:+$('height').value||0,
        weight:+$('weight').value||0,
        bodyfat:+$('bodyfat').value||0,
        waist:+$('waist').value||0,
        gender:$('gender').value,
        targetNote:$('targetNote').value?.trim(),
        goals:getChecks('goals'),
        diet:$('diet').value,
        meals:+$('meals').value,
        fasting:$('fasting').value,
        cuisine:$('cuisine').value,
        cookTime:+$('cookTime').value||0,
        budget:+$('budget').value||0,
        dislikes:$('dislikes').value?.trim(),
        job:$('job').value,
        steps:+$('steps').value||0,
        sleep:+$('sleep').value||0,
        stress:$('stress').value,
        place:$('place').value,
        session:+$('session').value||0,
        days:getChecks('days'),
        equipment:$('equipment').value?.trim(),
        exp:$('exp').value,
        caffeine:+$('caffeine').value||0,
        injuries:$('injuries').value?.trim(),
        meds:$('meds').value?.trim()
      }
    }

    function targets(){
      const u=collect();
      const male=u.gender==='Male';
      const BMR = male? (10*u.weight + 6.25*u.height - 5*u.age + 5)
                       : (10*u.weight + 6.25*u.height - 5*u.age - 161);
      const factor=(u.job==='Sedentary'?1.2: u.job==='Moderate'?1.5:1.35);
      let TDEE=Math.round(BMR*factor);
      if(u.goals.includes('Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†')) TDEE=Math.round(TDEE*0.88);
      if(u.goals.includes('Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª'))  TDEE=Math.round(TDEE*1.10);
      const P=Math.round(2.0*(u.weight||1));
      const F=Math.round(0.8*(u.weight||1));
      let C=Math.max(0,Math.round((TDEE-(P*4+F*9))/4));
      if(['Ø§Ù„Ø³ÙƒØ±ÙŠ','Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø§Ù†Ø³ÙˆÙ„ÙŠÙ†'].some(h=>u.goals.includes(h)||u.meds.toLowerCase().includes('metformin'))) C=Math.min(C,140);
      return {TDEE,P,F,C};
    }

    /*********** AI call ***********/
    async function callAI(prompt){
      const r = await fetch(PROXY_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
      if(!r.ok){ const t = await r.text().catch(()=> ''); throw new Error('Proxy '+r.status+': '+t.slice(0,250)) }
      const j = await r.json();
      if(!j?.text) throw new Error('Empty AI response');
      return j.text;
    }

    /*********** Prompts ***********/
    function headerStrict(){
      const u=collect(), t=targets(), locale = st.lang==='ar'?'Arabic':'English';
      return `
GLOBAL RULES
- OUTPUT LANGUAGE: ${locale} ONLY. Do NOT mix languages.
- Greet the client **only once** in the WELCOME section. In all other sections, write content directly with no greeting and do NOT repeat profile fields.
- Use clear Markdown headings and tables. No placeholders or "etc.".
- Keep accuracy: calories/macros within Â±2% of targets; exercises safe for injuries.

CLIENT PROFILE (internal reference; never restate inside sections)
- Name: ${u.name}; Sex: ${u.gender}
- Age/Height/Weight: ${u.age}y / ${u.height}cm / ${u.weight}kg; Bodyfat: ${u.bodyfat||'n/a'}%; Waist: ${u.waist||'n/a'}cm
- Goals: ${(u.goals||[]).join(', ')}; Target note: ${u.targetNote||'â€”'}
- Diet: ${u.diet}; Meals/day: ${u.meals}; Fasting: ${u.fasting}; Cuisine: ${u.cuisine}; Cook time <= ${u.cookTime||'n/a'} min; Budget ~ ${u.budget||'n/a'}
- Dislikes/allergies to avoid: ${u.dislikes||'None'}
- Activity: ${u.job} (+~${u.steps||'n/a'} steps/day); Sleep: ${u.sleep}h; Stress: ${u.stress}; Caffeine: ${u.caffeine} cups
- Training: ${u.place}; Days available: ${(u.days||[]).join(', ')||'n/a'}; Session ~${u.session||'n/a'} min; Equipment: ${u.equipment||'â€”'}; Experience: ${u.exp}; Injuries: ${u.injuries||'None'}
- Medications/supps: ${u.meds||'None'}

DAILY TARGETS (reference only; do not restate as profile)
- Calories â‰ˆ ${t.TDEE} kcal; Protein â‰ˆ ${t.P} g; Fat â‰ˆ ${t.F} g; Carbs â‰ˆ ${t.C} g`.trim();
    }

    // sections short (no greeting except welcome)
    function pWelcome(){
      const u=collect();
      return `${headerStrict()}

SECTION: WELCOME
Write a single short welcome paragraph addressing **${u.name||tr('Ø§Ù„Ø¹Ù…ÙŠÙ„','the client')}** by name, congratulating them on starting, and clarifying that the plan will be delivered in ordered sections. Keep it 5â€“7 lines.`;
    }

    function pAnalysis(){
      return `${headerStrict()}

SECTION: PROFILE ANALYSIS & GOAL
Provide a concise expert analysis: why these calories/macros fit the goal and constraints; how steps, sleep, stress and schedule impact progress; how to use RPE and session duration. No greeting.`;
    }

    function pAllowed(){
      const u=collect();
      return `${headerStrict()}

SECTION: ALLOWED & LIMIT LIST
Two bullet lists only:
- Allowed & preferred foods (consider ${u.diet}, ${u.cuisine}, cook time <= ${u.cookTime||'n/a'} min, budget ~ ${u.budget||'n/a'})
- Limit/avoid (consider dislikes/allergies: ${u.dislikes||'None'})`;
    }

    function pIF(){
      const u=collect();
      return `${headerStrict()}

SECTION: INTERMITTENT FASTING
If fasting is "${u.fasting}", explain schedule (window, hydration, electrolytes), first/last meal structure, caffeine timing and sleep hygiene. If "off", say "Not applicable". No greeting.`;
    }

    // nutrition day-by-day
    function pNutritionDay(d){
      const u=collect(), t=targets(), day=st.lang==='ar'?`Ø§Ù„ÙŠÙˆÙ… ${d}`:`Day ${d}`;
      return `${headerStrict()}

SECTION: NUTRITION â€” ${day}
- Provide a MARKDOWN TABLE with EXACTLY ${u.meals} meals and columns:
| ${tr('Ø§Ù„ÙŠÙˆÙ…','Day')} | ${tr('Ø§Ù„ÙˆØ¬Ø¨Ø©','Meal')} | ${tr('Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª (Ø¬Ø±Ø§Ù…Ø§Øª/Ù…Ù„)','Ingredients (g/ml)')} | Protein (g) | Fat (g) | Carbs (g) | kcal |
- Meals must reflect ${u.diet}, ${u.cuisine}, cook time <= ${u.cookTime||'n/a'} min, budget ~ ${u.budget||'n/a'}, avoid: ${u.dislikes||'None'}.
- Add a final "Totals" row close to: ${t.P}P / ${t.F}F / ${t.C}C / ${t.TDEE} kcal (Â±2%).
- After the table add one short compliance tip line.
- No greeting; no profile repetition.`;
    }

    // training day-by-day
    function pTrainingDay(d){
      const u=collect();
      const day=st.lang==='ar'?`Ø§Ù„ÙŠÙˆÙ… ${d}`:`Day ${d}`;
      return `${headerStrict()}

SECTION: TRAINING â€” ${day}
- Tailor to: experience ${u.exp}, place ${u.place}, equipment "${u.equipment||'â€”'}", session ~${u.session||'n/a'} min; days available ${(u.days||[]).join(', ')||'n/a'}.
- STRICTLY avoid aggravating injuries: ${u.injuries||'None'}.
- Provide a MARKDOWN TABLE:
| ${tr('Ø§Ù„ÙŠÙˆÙ…','Day')} | Exercise (English) | Sets | Reps | Tempo | Rest (s) | Notes (form cue or RPE) |
- Include warm-up/mobility and cool-down notes beneath the table.
- No greeting; no profile repetition.`;
    }

    function pSupps(){
      const u=collect();
      return `${headerStrict()}

SECTION: SUPPLEMENTS
Two sublists only:
1) Core stack â€” item, dose, timing, duration.
2) Condition-linked â€” only if clinically relevant to: ${u.meds||'None'} / injuries: ${u.injuries||'None'}; otherwise "Not indicated".
Respect allergies/dislikes: ${u.dislikes||'None'}. Add a short safety note.`;
    }

    function pProgress(){
      return `${headerStrict()}

SECTION: PROGRESSION & TRACKING
How to add load/reps weekly, when to deload, adjust calories if weekly average deviates from target, weekly checklist.`;
    }

    function pTroubleshoot(){
      return `${headerStrict()}

SECTION: TROUBLESHOOTING
List common issues (hunger, plateau, fatigue, poor sleep/time) with precise fixes.`;
    }

    function pSafety(){
      return `${headerStrict()}

SECTION: SAFETY & HEALTH
Hydration, sleep, technique, warm-up, red flags to stop and seek medical care.`;
    }

    function pClosing(){
      return `${headerStrict()}

SECTION: CLOSING
Positive, motivating paragraph (no greeting) encouraging adherence and celebrating progress.`;
    }

    /*********** Validators ***********/
    const hasTable = md => md.split('\n').filter(l=>l.includes('|')).length>=5;
    function vNutrition(md,d){
      const dayOk = st.lang==='ar'? new RegExp(`Ø§Ù„ÙŠÙˆÙ…\\s*${d}\\b`).test(md) : new RegExp(`\\bDay\\s*${d}\\b`).test(md);
      return dayOk && hasTable(md);
    }
    function vTraining(md,d){
      const dayOk = st.lang==='ar'? new RegExp(`Ø§Ù„ÙŠÙˆÙ…\\s*${d}\\b`).test(md) : new RegExp(`\\bDay\\s*${d}\\b`).test(md);
      return dayOk && hasTable(md);
    }

    /*********** Pipeline (section-by-section + day-by-day) ***********/
    async function generate(){
      const u=collect();
      if(!u.name||!u.age||!u.height||!u.weight||!u.sleep){
        alert(tr('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ø·ÙˆÙ„/Ø§Ù„ÙˆØ²Ù†/Ø§Ù„Ù†ÙˆÙ….','Fill required fields: name/age/height/weight/sleep.'));
        return;
      }
      $('result').classList.remove('hidden');
      $('ai').innerHTML = '';

      const steps = 4 /*core*/ + 7 /*nutrition*/ + 7 /*training*/ + 4 /*rest*/;
      let i = 0;

      // Welcome
      setProgress(++i,steps,tr('ØªØ±Ø­ÙŠØ¨','Welcome')); spinner(tr('ØªØ±Ø­ÙŠØ¨','Welcome'));
      endSpin(await callAI(pWelcome()));

      // Analysis
      setProgress(++i,steps,tr('ØªØ­Ù„ÙŠÙ„','Analysis')); spinner(tr('ØªØ­Ù„ÙŠÙ„','Analysis'));
      endSpin(await callAI(pAnalysis()));

      // Allowed/Limits
      setProgress(++i,steps,tr('Ù…Ø³Ù…ÙˆØ­/Ù…Ù…Ù†ÙˆØ¹','Allowed/Limits')); spinner(tr('Ù…Ø³Ù…ÙˆØ­/Ù…Ù…Ù†ÙˆØ¹','Allowed/Limits'));
      endSpin(await callAI(pAllowed()));

      // IF
      setProgress(++i,steps,tr('Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹','Intermittent Fasting')); spinner(tr('Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹','Intermittent Fasting'));
      endSpin(await callAI(pIF()));

      // Nutrition Days 1..7
      for(let d=1; d<=7; d++){
        const label = tr(`Ø§Ù„ØªØºØ°ÙŠØ© â€” Ø§Ù„ÙŠÙˆÙ… ${d}`,`Nutrition â€” Day ${d}`);
        setProgress(++i,steps,label); spinner(label);
        let ok=false,md='',attempts=0;
        while(!ok && attempts<2){
          attempts++;
          md = await callAI(pNutritionDay(d));
          ok = vNutrition(md,d);
          if(!ok){
            md = await callAI(`${headerStrict()}

The previous nutrition for ${st.lang==='ar'?`Ø§Ù„ÙŠÙˆÙ… ${d}`:`Day ${d}`} failed validation (missing proper table or wrong day marker). Regenerate exactly per rules.`);
            ok = vNutrition(md,d);
          }
        }
        endSpin(md);
      }

      // Training Days 1..7
      for(let d=1; d<=7; d++){
        const label = tr(`Ø§Ù„ØªØ¯Ø±ÙŠØ¨ â€” Ø§Ù„ÙŠÙˆÙ… ${d}`,`Training â€” Day ${d}`);
        setProgress(++i,steps,label); spinner(label);
        let ok=false,md='',attempts=0;
        while(!ok && attempts<2){
          attempts++;
          md = await callAI(pTrainingDay(d));
          ok = vTraining(md,d);
          if(!ok){
            md = await callAI(`${headerStrict()}

The previous training for ${st.lang==='ar'?`Ø§Ù„ÙŠÙˆÙ… ${d}`:`Day ${d}`} failed validation (missing proper table or wrong day marker). Regenerate exactly per rules.`);
            ok = vTraining(md,d);
          }
        }
        endSpin(md);
      }

      // Supplements
      setProgress(++i,steps,tr('Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª','Supplements')); spinner(tr('Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª','Supplements'));
      endSpin(await callAI(pSupps()));

      // Progression
      setProgress(++i,steps,tr('Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„ØªØªØ¨Ù‘Ø¹','Progress & Tracking')); spinner(tr('Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„ØªØªØ¨Ù‘Ø¹','Progress & Tracking'));
      endSpin(await callAI(pProgress()));

      // Troubleshooting
      setProgress(++i,steps,tr('Ø§Ù„Ù…Ø´ÙƒÙ„Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©','Troubleshooting')); spinner(tr('Ø§Ù„Ù…Ø´ÙƒÙ„Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©','Troubleshooting'));
      endSpin(await callAI(pTroubleshoot()));

      // Safety
      setProgress(++i,steps,tr('Ø§Ù„Ø³Ù„Ø§Ù…Ø©','Safety')); spinner(tr('Ø§Ù„Ø³Ù„Ø§Ù…Ø©','Safety'));
      endSpin(await callAI(pSafety()));

      // Closing
      setProgress(++i,steps,tr('Ø§Ù„Ø®ØªØ§Ù…','Closing')); spinner(tr('Ø§Ù„Ø®ØªØ§Ù…','Closing'));
      endSpin(await callAI(pClosing()));

      setProgress(steps,steps,tr('Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯','Generation complete'));
      $('resultRoot').scrollIntoView({behavior:'smooth',block:'start'});
      $('regen').classList.remove('hidden');
    }

    /*********** Export / Print ***********/
    function exportPDF(){
      const node=$('resultRoot'); if(!node){ window.print(); return; }
      const fn = (st.lang==='ar'?'Ø®Ø·Ø©-':'plan-') + (collect().name||'client') + '.pdf';
      const opt = { filename:fn, margin:[10,10,10,10], image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2,useCORS:true}, pagebreak:{mode:['css','legacy']}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
      document.documentElement.classList.add('print-ready');
      setTimeout(()=>{ try{ html2pdf().from(node).set(opt).save().finally(()=>document.documentElement.classList.remove('print-ready')); }
                       catch{ document.documentElement.classList.remove('print-ready'); window.print(); } },80);
    }

    /*********** Events ***********/
    $('lang-ar').onclick=()=>setLang('ar');
    $('lang-en').onclick=()=>setLang('en');
    $('btn-theme').onclick=toggleTheme;
    $('start').onclick=generate;
    $('regen').onclick=generate;
    $('print2').onclick=()=>window.print();
    $('pdf2').onclick=exportPDF;

    setLang('ar');
  </script>
</body>
</html>
