<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>المستشار الصحي الذكي</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      --bg:#0b1020; --card:#0f162e; --muted:#94a3b8; --primary:#7c3aed; --accent:#22c55e;
    }
    html,body{height:100%}
    body{background:linear-gradient(180deg,#0b1020,#0a0f1d); font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    [lang="en"] body{font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{max-width:1200px; margin:24px auto; padding:0 16px}
    .card{background:rgba(15,22,46,.88); border:1px solid rgba(255,255,255,.06); border-radius:18px}
    .btn{height:44px; border-radius:12px; padding:0 16px; font-weight:800}
    .btn-primary{background:linear-gradient(45deg,#7c3aed,#a855f7); color:white}
    .btn-ghost{background:rgba(255,255,255,.06); color:#e2e8f0}
    .badge{font-size:12px; padding:6px 10px; border-radius:9999px; background:rgba(124,58,237,.15); color:#c4b5fd}
    .field{display:flex; flex-direction:column; gap:6px}
    .input,.select,.textarea{
      background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
      border-radius:12px; padding:.65rem .8rem; color:#e5e7eb; outline:none;
    }
    .input:focus,.select:focus,.textarea:focus{border-color:#a78bfa; box-shadow:0 0 0 3px rgba(167,139,250,.2)}
    .grid-3{
      display:grid; gap:16px;
      grid-template-columns: 1fr; grid-template-areas:
        "profile"
        "diet"
        "lifestyle";
    }
    /* English layout (LTR): profile first at left */
    html[dir="ltr"] .grid-3{
      grid-template-columns: repeat(3,1fr);
      grid-template-areas: "profile diet lifestyle";
    }
    /* Arabic layout (RTL): profile first at right */
    html[dir="rtl"] .grid-3{
      grid-template-columns: repeat(3,1fr);
      grid-template-areas: "lifestyle diet profile";
    }
    .box{padding:18px}
    .profile{grid-area:profile}
    .diet{grid-area:diet}
    .lifestyle{grid-area:lifestyle}
    @media (max-width:1024px){
      .grid-3{grid-template-columns:1fr; grid-template-areas:"profile" "diet" "lifestyle";}
    }
    .h-title{font-weight:800; color:#e2e8f0; display:flex; align-items:center; gap:8px}
    .h-sub{color:#94a3b8; font-size:.9rem}
    .divider{height:1px; background:rgba(255,255,255,.08); margin:12px 0}
    .sticky-actions{position:sticky; bottom:0; backdrop-filter:blur(10px); background:rgba(11,16,32,.6); border-top:1px solid rgba(255,255,255,.06)}
    .waiting{animation:pulse 1.6s infinite}
    @keyframes pulse{0%{opacity:.4}50%{opacity:1}100%{opacity:.4}}
    .print-hide{display:block}
    @media print{
      .print-hide{display:none}
      body{background:white}
      .card{border:none}
    }
    /* RTL/LTR logical alignment helpers */
    .ltr-text{direction:ltr; text-align:left}
    .rtl-text{direction:rtl; text-align:right}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Top Bar -->
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="badge">AI</div>
        <div>
          <div class="text-slate-100 font-extrabold" id="appTitle">المستشار الصحي الذكي</div>
          <div class="text-slate-400 text-sm" id="appTag">خطة دقيقة 100% للتغذية والتدريب والمكملات – مخصصة لك</div>
        </div>
      </div>
      <div class="flex items-center gap-2 print-hide">
        <button id="btnAr" class="btn btn-ghost">عربى</button>
        <button id="btnEn" class="btn btn-ghost">EN</button>
        <button id="btnTheme" class="btn btn-ghost" title="Theme">🌓</button>
      </div>
    </header>

    <!-- Helper note -->
    <div class="card box mb-4">
      <div class="h-title">
        <span>ℹ️</span><span id="helperTitle">لنُنشئ أفضل خطة محكمة لهدفك</span>
      </div>
      <div class="h-sub mt-1" id="helperDesc">
        سنولّد الخطة قسمًا بعد قسم: ترحيب → تحليل → المسموح/الممنوع → الصيام المتقطع (إن لزم) → التغذية يومًا بيوم (7) → التدريب يومًا بيوم (7) → المكملات → المتابعة → معالجة التحديات → السلامة → إغلاق.
      </div>
    </div>

    <!-- 3-column form grid -->
    <form id="form" class="grid-3">
      <!-- Lifestyle & Training -->
      <section class="card lifestyle">
        <div class="box">
          <div class="h-title">🏃‍♂️ <span id="secLifestyle">نمط الحياة والتدريب</span></div>
          <div class="divider"></div>

          <div class="grid md:grid-cols-2 gap-3">
            <div class="field">
              <label id="lblWork">العمل/النشاط</label>
              <select id="work" class="select">
                <option value="sedentary">مكتبي</option>
                <option value="light">نشاط خفيف</option>
                <option value="moderate">نشاط متوسط</option>
                <option value="active">نشاط عالٍ</option>
              </select>
            </div>
            <div class="field">
              <label id="lblSteps">الخطوات/اليوم</label>
              <input id="steps" type="number" class="input" inputmode="numeric" placeholder="6000" />
            </div>
            <div class="field">
              <label id="lblSleep">النوم (س)</label>
              <select id="sleep" class="select">
                <option value="low">منخفض</option>
                <option value="medium">متوسط</option>
                <option value="high">مرتفع</option>
              </select>
            </div>
            <div class="field">
              <label id="lblStress">التوتر</label>
              <select id="stress" class="select">
                <option value="low">منخفض</option>
                <option value="medium">متوسط</option>
                <option value="high">مرتفع</option>
              </select>
            </div>
            <div class="field">
              <label id="lblPlace">مكان التدريب</label>
              <input id="place" class="input" placeholder="نادي / منزل..." />
            </div>
            <div class="field">
              <label id="lblSession">مدة الجلسة (د)</label>
              <input id="session" type="number" class="input" inputmode="numeric" placeholder="60" />
            </div>
          </div>

          <div class="divider"></div>
          <div class="h-title text-sm" id="quickFit">اختبار اللياقة المبسط</div>
          <div class="grid md:grid-cols-3 gap-3 mt-2">
            <div class="field">
              <label id="lblRHR">النبض راحة (نب/د)</label>
              <input id="rhr" type="number" class="input" inputmode="numeric" />
            </div>
            <div class="field">
              <label id="lblPushups">أقصى ضغط</label>
              <input id="pushups" type="number" class="input" inputmode="numeric" />
            </div>
            <div class="field">
              <label id="lblRun1k">زمن 1كم (د:ث)</label>
              <input id="run1k" class="input ltr-text" placeholder="6:30" />
            </div>
          </div>

          <div class="divider"></div>
          <div class="grid md:grid-cols-2 gap-3">
            <div class="field">
              <label id="lblDays">أيام التدريب المتاحة</label>
              <div class="grid grid-cols-4 gap-2 text-sm text-slate-300">
                <label><input type="checkbox" class="mr-1 align-middle" value="sat" /> <span id="dSat">السبت</span></label>
                <label><input type="checkbox" class="mr-1 align-middle" value="sun" /> <span id="dSun">الأحد</span></label>
                <label><input type="checkbox" class="mr-1 align-middle" value="mon" /> <span id="dMon">الاثنين</span></label>
                <label><input type="checkbox" class="mr-1 align-middle" value="tue" /> <span id="dTue">الثلاثاء</span></label>
                <label><input type="checkbox" class="mr-1 align-middle" value="wed" /> <span id="dWed">الأربعاء</span></label>
                <label><input type="checkbox" class="mr-1 align-middle" value="thu" /> <span id="dThu">الخميس</span></label>
                <label><input type="checkbox" class="mr-1 align-middle" value="fri" /> <span id="dFri">الجمعة</span></label>
              </div>
            </div>
            <div class="field">
              <label id="lblEq">المعدات المتاحة</label>
              <input id="equipment" class="input" placeholder="بار، دمبل..." />
            </div>
            <div class="field">
              <label id="lblExp">الخبرة</label>
              <select id="experience" class="select">
                <option value="beginner">مبتدئ (0-6 أشهر)</option>
                <option value="intermediate">متوسط (6-24 شهر)</option>
                <option value="advanced">متقدم (+24 شهر)</option>
              </select>
            </div>
            <div class="field">
              <label id="lblRpe">RPE</label>
              <input id="rpe" type="number" class="input" inputmode="numeric" placeholder="8" />
            </div>
            <div class="field">
              <label id="lblCaffeine">كافيين (أكواب/يوم)</label>
              <input id="caffeine" type="number" class="input" inputmode="numeric" />
            </div>
            <div class="field">
              <label id="lblInj">إصابات/قيود</label>
              <input id="injuries" class="input" />
            </div>
          </div>
        </div>
      </section>

      <!-- Diet & Preferences -->
      <section class="card diet">
        <div class="box">
          <div class="h-title">🍽️ <span id="secDiet">النظام الغذائي والتفضيلات</span></div>
          <div class="divider"></div>

          <div class="grid md:grid-cols-2 gap-3">
            <div class="field">
              <label id="lblGoals">الأهداف (متعدد)</label>
              <div class="grid grid-cols-2 gap-2 text-sm text-slate-300">
                <label><input type="checkbox" value="fat" class="mr-1" /> <span id="gFat">خسارة الدهون</span></label>
                <label><input type="checkbox" value="muscle" class="mr-1" /> <span id="gMuscle">بناء العضلات</span></label>
                <label><input type="checkbox" value="strength" class="mr-1" /> <span id="gStrength">زيادة القوة</span></label>
                <label><input type="checkbox" value="endurance" class="mr-1" /> <span id="gEndurance">التحمل</span></label>
                <label class="col-span-2"><input type="checkbox" value="health" class="mr-1" /> <span id="gHealth">صحة عامة</span></label>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="field">
                <label id="lblMeals">عدد الوجبات/اليوم</label>
                <select id="meals" class="select">
                  <option value="3">3</option><option value="4">4</option>
                  <option value="5">5</option><option value="2">2</option>
                </select>
              </div>
              <div class="field">
                <label id="lblDietType">النظام المفضل</label>
                <select id="dietType" class="select">
                  <option value="balanced">Balanced</option>
                  <option value="lowcarb">Low-Carb</option>
                  <option value="med">Mediterranean</option>
                  <option value="keto">Keto</option>
                  <option value="if">Intermittent Fasting</option>
                  <option value="vegan">Vegan</option>
                </select>
              </div>
              <div class="field">
                <label id="lblCuisine">المطبخ المفضل</label>
                <select id="cuisine" class="select">
                  <option value="arab">Arabic/Middle Eastern</option>
                  <option value="med">Mediterranean</option>
                  <option value="indian">Indian</option>
                  <option value="western">Western</option>
                </select>
              </div>
              <div class="field">
                <label id="lblPrep">زمن التحضير (د)</label>
                <input id="prep" type="number" class="input" inputmode="numeric" placeholder="20" />
              </div>
              <div class="field">
                <label id="lblBudget">ميزانية شهرية تقريبية</label>
                <div class="flex gap-2">
                  <input id="budget" type="number" class="input flex-1" inputmode="numeric" placeholder="0" />
                  <select id="currency" class="select">
                    <option value="auto" selected>Auto</option>
                    <option value="USD">USD</option><option value="SAR">SAR</option>
                    <option value="AED">AED</option><option value="EGP">EGP</option>
                    <option value="KWD">KWD</option><option value="QAR">QAR</option>
                  </select>
                </div>
                <div class="text-xs text-slate-400" id="budgetHint">سنحاول الالتزام بالميزانية الشهرية.</div>
              </div>
              <div class="field">
                <label id="lblAllergy">أطعمة لا ترغب/حساسية</label>
                <input id="avoid" class="input" placeholder="جلوتين، لاكتوز..." />
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="h-title text-sm" id="musclesHeader">عضلات تحتاج عناية خاصة</div>
          <!-- Muscles with per-muscle issue -->
          <div class="grid md:grid-cols-2 gap-3 mt-2" id="musclesWrap">
            <!-- Generated by JS for consistency in both languages -->
          </div>

          <div class="divider"></div>
          <div class="field">
            <label id="lblChallenges">تحديات سابقة مع الأنظمة</label>
            <textarea id="challenges" class="textarea" rows="2" placeholder="جوع شديد، ملل من الطعام، إصابات..."></textarea>
          </div>
          <div class="field">
            <label id="lblMotivation">أسلوب التحفيز المفضل</label>
            <select id="motivation" class="select">
              <option value="direct">عملي ومباشر</option>
              <option value="supportive">تشجيعي/مرن</option>
              <option value="strict">صارم ومنضبط</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Profile (always first column logically, re-ordered by CSS per dir) -->
      <section class="card profile">
        <div class="box">
          <div class="h-title">👤 <span id="secProfile">الملف الشخصي</span></div>
          <div class="divider"></div>

          <div class="grid md:grid-cols-2 gap-3">
            <div class="field">
              <label id="lblName">الاسم</label>
              <input id="name" class="input" />
            </div>
            <div class="field">
              <label id="lblAge">العمر</label>
              <input id="age" type="number" class="input" inputmode="numeric" />
            </div>
            <div class="field">
              <label id="lblHeight">الطول (سم)</label>
              <input id="height" type="number" class="input" inputmode="numeric" />
            </div>
            <div class="field">
              <label id="lblWeight">الوزن (كغ)</label>
              <input id="weight" type="number" class="input" inputmode="numeric" />
            </div>
            <div class="field">
              <label id="lblBf">% نسبة الدهون (اختياري)</label>
              <input id="bodyfat" type="number" class="input" inputmode="numeric" placeholder="اختياري" />
            </div>
            <div class="field">
              <label id="lblWaist">محيط الخصر (سم) (اختياري)</label>
              <input id="waist" type="number" class="input" inputmode="numeric" placeholder="اختياري" />
            </div>
            <div class="field">
              <label id="lblSex">الجنس</label>
              <select id="sex" class="select">
                <option value="male">ذكر</option><option value="female">أنثى</option>
              </select>
            </div>
            <div class="field">
              <label id="lblGoalNum">هدف رقمي (وزن مستهدف كغ) (اختياري)</label>
              <input id="targetWeight" type="number" class="input" inputmode="numeric" placeholder="مثال: 84" />
            </div>
            <div class="field">
              <label id="lblGoalDate">موعد تحقيق الهدف (اختياري)</label>
              <input id="targetDate" type="date" class="input" />
            </div>
          </div>

          <div class="divider"></div>
          <div class="h-title text-sm" id="medicalTitle">الحالة الصحية</div>
          <div class="grid md:grid-cols-2 gap-3 mt-2">
            <div class="field">
              <div class="grid grid-cols-2 gap-2 text-sm text-slate-300" id="medicalList">
                <!-- filled by JS: checklist + others/supplements/medications -->
              </div>
            </div>
            <div class="grid gap-3">
              <div class="field">
                <label id="lblOtherCond">أمراض أخرى</label>
                <input id="otherConditions" class="input" />
              </div>
              <div class="field">
                <label id="lblMedications">أدوية حالية</label>
                <input id="medications" class="input" />
              </div>
              <div class="field">
                <label id="lblSupps">مكملات حالية</label>
                <input id="supplements" class="input" />
              </div>
            </div>
          </div>
        </div>
      </section>
    </form>

    <!-- Generate / Print / PDF -->
    <div class="sticky-actions mt-5 card box print-hide">
      <div class="flex flex-wrap items-center gap-3 justify-between">
        <div class="text-slate-300 text-sm" id="genHint">
          ✅ عند الضغط على “توليد الخطة” سنُنشئ الأقسام بالترتيب. الرجاء الانتظار حتى يكتمل التوليد بالكامل.
        </div>
        <div class="flex gap-2">
          <button id="btnGenerate" class="btn btn-primary">توليد الخطة</button>
          <button id="btnPrint" class="btn btn-ghost">طباعة</button>
          <button id="btnPDF" class="btn btn-ghost">PDF</button>
        </div>
      </div>
    </div>

    <!-- Output -->
    <article id="output" class="card box mt-4">
      <div id="wait" class="hidden waiting text-slate-300"></div>
      <div id="plan" class="prose prose-invert max-w-none"></div>
    </article>

    <footer class="text-center text-slate-500 text-sm mt-6">
      Powered by Mustafa Elsafy 2025 — جميع الحقوق محفوظة
    </footer>
  </div>

  <script>
    /* =========================
       I18N
    ========================== */
    const i18n = {
      ar: {
        title: "المستشار الصحي الذكي",
        tag: "خطة دقيقة 100% للتغذية والتدريب والمكملات – مخصصة لك",
        helperTitle: "لنُنشئ أفضل خطة محكمة لهدفك",
        helperDesc: "سنولّد الخطة قسمًا بعد قسم: ترحيب → تحليل → المسموح/الممنوع → الصيام المتقطع (إن لزم) → التغذية يومًا بيوم (7) → التدريب يومًا بيوم (7) → المكملات → المتابعة → معالجة التحديات → السلامة → إغلاق.",
        secLifestyle: "نمط الحياة والتدريب",
        secDiet: "النظام الغذائي والتفضيلات",
        secProfile: "الملف الشخصي",
        work: "العمل/النشاط",
        steps: "الخطوات/اليوم",
        sleep: "النوم (س)",
        stress: "التوتر",
        place: "مكان التدريب",
        session: "مدة الجلسة (د)",
        quickFit: "اختبار اللياقة المبسط",
        rhr: "النبض راحة (نب/د)",
        pushups: "أقصى ضغط",
        run1k: "زمن 1كم (د:ث)",
        days: "أيام التدريب المتاحة",
        eq: "المعدات المتاحة",
        exp: "الخبرة",
        rpe: "RPE",
        caffeine: "كافيين (أكواب/يوم)",
        injuries: "إصابات/قيود",
        goals: "الأهداف (متعدد)",
        gFat: "خسارة الدهون",
        gMuscle: "بناء العضلات",
        gStrength: "زيادة القوة",
        gEndurance: "التحمل",
        gHealth: "صحة عامة",
        meals: "عدد الوجبات/اليوم",
        dietType: "النظام المفضل",
        cuisine: "المطبخ المفضل",
        prep: "زمن التحضير (د)",
        budget: "ميزانية شهرية تقريبية",
        budgetHint: "سنحاول الالتزام بالميزانية الشهرية.",
        avoid: "أطعمة لا ترغب/حساسية",
        musclesHeader: "عضلات تحتاج عناية خاصة",
        challenges: "تحديات سابقة مع الأنظمة",
        motivation: "أسلوب التحفيز المفضل",
        name: "الاسم",
        age: "العمر",
        height: "الطول (سم)",
        weight: "الوزن (كغ)",
        bodyfat: "% نسبة الدهون (اختياري)",
        waist: "محيط الخصر (سم) (اختياري)",
        sex: "الجنس",
        targetWeight: "هدف رقمي (وزن مستهدف كغ) (اختياري)",
        targetDate: "موعد تحقيق الهدف (اختياري)",
        medTitle: "الحالة الصحية",
        otherCond: "أمراض أخرى",
        meds: "أدوية حالية",
        supps: "مكملات حالية",
        btnGenerate: "توليد الخطة",
        btnPrint: "طباعة",
        btnPDF: "PDF",
        waiting: "🧠 نُعدّ خطتك بعناية… الرجاء الانتظار حتى يكتمل كل قسم.",
        daysNames: ["السبت","الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس","الجمعة"],
        workVals: ["مكتبي","نشاط خفيف","نشاط متوسط","نشاط عالٍ"],
        sleepVals: ["منخفض","متوسط","مرتفع"],
        motivationVals: ["عملي ومباشر","تشجيعي/مرن","صارم ومنضبط"],
        muscleList: [
          ["chest","الصدر"],["back","الظهر"],["shoulders","الأكتاف"],["biceps","البايسبس"],["triceps","الترايسبس"],
          ["quads","الأرجل الأمامية"],["hamstrings","الأرجل الخلفية"],["glutes","المؤخرة"],["calves","السمانة"],["abs","البطن"]
        ],
        medicalList: [
          ["hypertension","ضغط الدم"],["diabetes","السكري"],["insulin","مقاومة الأنسولين"],["thyroid","الغدة الدرقية"],
          ["fatty","الكبد الدهني"],["hormonal","مشاكل هرمونية"],["joint","مشاكل مفاصل/ركب"],["heart","أمراض القلب"],
          ["ulcer","قرحة/قولون عصبي"],["gerd","ارتجاع/حموضة"],["gluten","حساسية جلوتين"],["lactose","عدم تحمل لاكتوز"]
        ]
      },
      en: {
        title: "Intelligent Health Coach",
        tag: "100% precise plan for nutrition, training and supplements — fully personalized",
        helperTitle: "Let's build the best plan for your goal",
        helperDesc: "We will generate the plan section-by-section: Welcome → Analysis → Allowed/Limits → Intermittent Fasting (if relevant) → Nutrition day-by-day (7) → Training day-by-day (7) → Supplements → Progression → Troubleshooting → Safety → Closing.",
        secLifestyle: "Lifestyle & Training",
        secDiet: "Diet & Preferences",
        secProfile: "Profile",
        work: "Work/Activity",
        steps: "Steps/day",
        sleep: "Sleep",
        stress: "Stress",
        place: "Training place",
        session: "Session length (min)",
        quickFit: "Quick Fitness Test",
        rhr: "Resting HR (bpm)",
        pushups: "Max push-ups",
        run1k: "1 km time (m:s)",
        days: "Available training days",
        eq: "Available equipment",
        exp: "Experience",
        rpe: "RPE",
        caffeine: "Caffeine/day (cups)",
        injuries: "Injuries/constraints",
        goals: "Goals (multi-select)",
        gFat: "Fat Loss",
        gMuscle: "Build Muscle",
        gStrength: "Strength",
        gEndurance: "Endurance",
        gHealth: "General Health",
        meals: "Meals per day",
        dietType: "Preferred diet",
        cuisine: "Cuisine",
        prep: "Prep time (min)",
        budget: "Monthly budget",
        budgetHint: "We'll try to stay within the monthly budget.",
        avoid: "Foods to avoid / allergies",
        musclesHeader: "Muscles needing special focus",
        challenges: "Past challenges with plans",
        motivation: "Preferred motivation style",
        name: "Name",
        age: "Age",
        height: "Height (cm)",
        weight: "Weight (kg)",
        bodyfat: "Body fat % (optional)",
        waist: "Waist (cm) (optional)",
        sex: "Sex",
        targetWeight: "Numeric target (kg) (optional)",
        targetDate: "Target date (optional)",
        medTitle: "Medical status",
        otherCond: "Other conditions",
        meds: "Current medications",
        supps: "Current supplements",
        btnGenerate: "Generate Plan",
        btnPrint: "Print",
        btnPDF: "PDF",
        waiting: "🧠 Crafting your plan with care… please wait until all sections complete.",
        daysNames: ["Sat","Sun","Mon","Tue","Wed","Thu","Fri"],
        workVals: ["Sedentary","Light","Moderate","Active"],
        sleepVals: ["Low","Medium","High"],
        motivationVals: ["Direct/Practical","Supportive","Strict/Disciplined"],
        muscleList: [
          ["chest","Chest"],["back","Back"],["shoulders","Shoulders"],["biceps","Biceps"],["triceps","Triceps"],
          ["quads","Quads"],["hamstrings","Hamstrings"],["glutes","Glutes"],["calves","Calves"],["abs","Abs"]
        ],
        medicalList: [
          ["hypertension","Hypertension"],["diabetes","Diabetes"],["insulin","Insulin Resistance"],["thyroid","Thyroid issues"],
          ["fatty","Fatty Liver"],["hormonal","Hormonal issues"],["joint","Joint/Knee problems"],["heart","Heart disease"],
          ["ulcer","IBD/Ulcer"],["gerd","GERD/Reflux"],["gluten","Gluten intolerance"],["lactose","Lactose intolerance"]
        ]
      }
    };

    /* =========================
       Language / Theme
    ========================== */
    let lang = (navigator.language||'ar').toLowerCase().startsWith('ar') ? 'ar' : 'en';
    const $ = sel => document.querySelector(sel);

    function fillStatic() {
      const t = i18n[lang];
      document.documentElement.lang = lang;
      document.documentElement.dir  = (lang==='ar') ? 'rtl' : 'ltr';
      $('#appTitle').textContent = t.title;
      $('#appTag').textContent   = t.tag;
      $('#helperTitle').textContent = t.helperTitle;
      $('#helperDesc').textContent  = t.helperDesc;
      $('#secLifestyle').textContent= t.secLifestyle;
      $('#secDiet').textContent     = t.secDiet;
      $('#secProfile').textContent  = t.secProfile;
      $('#lblWork').textContent     = t.work;
      $('#lblSteps').textContent    = t.steps;
      $('#lblSleep').textContent    = t.sleep;
      $('#lblStress').textContent   = t.stress;
      $('#lblPlace').textContent    = t.place;
      $('#lblSession').textContent  = t.session;
      $('#quickFit').textContent    = t.quickFit;
      $('#lblRHR').textContent      = t.rhr;
      $('#lblPushups').textContent  = t.pushups;
      $('#lblRun1k').textContent    = t.run1k;
      $('#lblDays').textContent     = t.days;
      $('#lblEq').textContent       = t.eq;
      $('#lblExp').textContent      = t.exp;
      $('#lblRpe').textContent      = t.rpe;
      $('#lblCaffeine').textContent = t.caffeine;
      $('#lblInj').textContent      = t.injuries;
      $('#lblGoals').textContent    = t.goals;
      $('#gFat').textContent        = t.gFat;
      $('#gMuscle').textContent     = t.gMuscle;
      $('#gStrength').textContent   = t.gStrength;
      $('#gEndurance').textContent  = t.gEndurance;
      $('#gHealth').textContent     = t.gHealth;
      $('#lblMeals').textContent    = t.meals;
      $('#lblDietType').textContent = t.dietType;
      $('#lblCuisine').textContent  = t.cuisine;
      $('#lblPrep').textContent     = t.prep;
      $('#lblBudget').textContent   = t.budget;
      $('#budgetHint').textContent  = t.budgetHint;
      $('#lblAllergy').textContent  = t.avoid;
      $('#musclesHeader').textContent= t.musclesHeader;
      $('#lblChallenges').textContent= t.challenges;
      $('#lblMotivation').textContent = t.motivation;
      $('#lblName').textContent     = t.name;
      $('#lblAge').textContent      = t.age;
      $('#lblHeight').textContent   = t.height;
      $('#lblWeight').textContent   = t.weight;
      $('#lblBf').textContent       = t.bodyfat;
      $('#lblWaist').textContent    = t.waist;
      $('#lblSex').textContent      = t.sex;
      $('#lblGoalNum').textContent  = t.targetWeight;
      $('#lblGoalDate').textContent = t.targetDate;
      $('#medicalTitle').textContent= t.medTitle;
      $('#lblOtherCond').textContent= t.otherCond;
      $('#lblMedications').textContent= t.meds;
      $('#lblSupps').textContent    = t.supps;
      $('#btnGenerate').textContent = t.btnGenerate;
      $('#btnPrint').textContent    = t.btnPrint;
      $('#btnPDF').textContent      = t.btnPDF;
      $('#genHint').textContent     = (lang==='ar')
        ? "✅ عند الضغط على “توليد الخطة” سنُنشئ الأقسام بالترتيب. الرجاء الانتظار حتى يكتمل التوليد بالكامل."
        : "✅ When you click “Generate Plan”, we’ll generate sections in order. Please wait until everything completes.";
      $('#wait').textContent        = t.waiting;

      // Select options text
      const workMap = t.workVals;
      const sleepMap= t.sleepVals;
      const motMap  = t.motivationVals;
      ['sedentary','light','moderate','active'].forEach((v,i)=> $('#work').options[i].textContent = workMap[i]);
      ['low','medium','high'].forEach((v,i)=> { $('#sleep').options[i].textContent = sleepMap[i]; $('#stress').options[i].textContent=sleepMap[i]; });
      ['direct','supportive','strict'].forEach((v,i)=> $('#motivation').options[i].textContent = motMap[i]);

      // Weekday labels
      const ids=['#dSat','#dSun','#dMon','#dTue','#dWed','#dThu','#dFri'];
      t.daysNames.forEach((d,i)=> $(ids[i]).textContent = d);

      // Build muscles list with per-muscle issue
      const mWrap = $('#musclesWrap'); mWrap.innerHTML='';
      t.muscleList.forEach(([key,label])=>{
        const row = document.createElement('div');
        row.innerHTML = `
          <label class="flex items-center gap-2 text-slate-300 text-sm">
            <input type="checkbox" data-muscle="${key}" class="align-middle">
            <span>${label}</span>
          </label>
          <input id="muscle_${key}" class="input mt-1" placeholder="${(lang==='ar'?'وصف المشكلة/السبب':'Describe the issue/reason')}" />
        `;
        mWrap.appendChild(row);
      });

      // Build medical checklist
      const ml = $('#medicalList'); ml.innerHTML='';
      t.medicalList.forEach(([key,label])=>{
        const item = document.createElement('label');
        item.className='flex items-center gap-2';
        item.innerHTML = `<input type="checkbox" value="${key}" class="align-middle"> <span>${label}</span>`;
        ml.appendChild(item);
      });
    }

    $('#btnAr').onclick = ()=>{lang='ar'; fillStatic();};
    $('#btnEn').onclick = ()=>{lang='en'; fillStatic();};

    // Theme
    let dark=true;
    const applyTheme=()=>{document.body.style.background = dark? 'linear-gradient(180deg,#0b1020,#0a0f1d)' : '#f8fafc'; document.querySelectorAll('.card').forEach(c=> c.style.background = dark? 'rgba(15,22,46,.88)':'#fff'); document.querySelectorAll('.prose-invert').forEach(p=> p.classList.toggle('prose', !dark));};
    $('#btnTheme').onclick = ()=>{dark=!dark; applyTheme();};

    // Currency auto
    try{
      const region = Intl.DateTimeFormat().resolvedOptions().locale.split('-')[1] || '';
      const map = {SA:'SAR',AE:'AED',EG:'EGP',KW:'KWD',QA:'QAR',US:'USD',GB:'USD'};
      if(map[region]) { $('#currency').value = map[region]; }
    }catch{ /* ignore */ }

    // Initial load
    fillStatic(); applyTheme();

    /* =========================
       Generate Plan (AI)
    ========================== */
    function gatherForm(){
      const days = [...document.querySelectorAll('[id="lblDays"] ~ div input:checked')].map(c=>c.value);
      const muscles = {};
      i18n[lang].muscleList.forEach(([k])=>{
        const checked = document.querySelector(`[data-muscle="${k}"]`)?.checked;
        if (checked) muscles[k] = $('#muscle_'+k).value || '';
      });
      const medical = [...$('#medicalList').querySelectorAll('input:checked')].map(i=>i.value);
      return {
        lang,
        profile:{
          name:$('#name').value.trim(),
          age:+$('#age').value || null,
          height:+$('#height').value || null,
          weight:+$('#weight').value || null,
          bodyfat: $('#bodyfat').value ? +$('#bodyfat').value : null,
          waist:   $('#waist').value ? +$('#waist').value : null,
          sex:$('#sex').value,
          targetWeight: $('#targetWeight').value ? +$('#targetWeight').value : null,
          targetDate: $('#targetDate').value || null,
        },
        lifestyle:{
          work:$('#work').value,
          steps:+$('#steps').value || 0,
          sleep:$('#sleep').value,
          stress:$('#stress').value,
          place:$('#place').value,
          session:+$('#session').value || 0,
          rhr:$('#rhr').value,
          pushups:$('#pushups').value,
          run1k:$('#run1k').value,
          days,
          equipment:$('#equipment').value,
          experience:$('#experience').value,
          rpe:$('#rpe').value,
          caffeine:$('#caffeine').value,
          injuries:$('#injuries').value
        },
        diet:{
          goals:[...document.querySelectorAll('#lblGoals ~ div input:checked')].map(i=>i.value),
          meals:+$('#meals').value,
          type:$('#dietType').value,
          cuisine:$('#cuisine').value,
          prep:+$('#prep').value||0,
          budget:$('#budget').value || null,
          currency:$('#currency').value,
          avoid:$('#avoid').value,
          motivation:$('#motivation').value,
          challenges:$('#challenges').value,
          muscles
        },
        medical:{
          list: medical,
          other: $('#otherConditions').value,
          meds:  $('#medications').value,
          supps: $('#supplements').value
        }
      };
    }

    function buildPrompt(p){
      const t = i18n[lang];
      const d = new Date();
      const welcome = (lang==='ar')
        ? `ابدأ برسالة ترحيب وتحفيز مهنية مناسبة للسياق (مرة واحدة فقط في بداية الخطة).`
        : `Start with a single professional welcome & motivation paragraph (once at the beginning).`;

      return `
Act as "Coach Mustafa Elsafy", a certified international nutrition & fitness expert.
Language: ${lang}. Use clear headings and tables.
Respect **RTL** formatting if Arabic.

${welcome}

### User Profile
- Name: ${p.profile.name || '-'}
- Sex: ${p.profile.sex}, Age: ${p.profile.age}, Height: ${p.profile.height} cm, Weight: ${p.profile.weight} kg
- Body fat: ${p.profile.bodyfat ?? 'N/A'}%, Waist: ${p.profile.waist ?? 'N/A'} cm
- Numeric target (kg): ${p.profile.targetWeight ?? 'N/A'}, Target date: ${p.profile.targetDate ?? 'N/A'}

### Lifestyle & Training Context
- Work/Activity: ${p.lifestyle.work}, Steps/day: ${p.lifestyle.steps}
- Sleep: ${p.lifestyle.sleep}, Stress: ${p.lifestyle.stress}
- Session length: ${p.lifestyle.session} min, Place: ${p.lifestyle.place}
- Fitness test: RHR ${p.lifestyle.rhr || '-'}, Push-ups ${p.lifestyle.pushups || '-'}, 1km ${p.lifestyle.run1k || '-'}
- Available days: ${p.lifestyle.days.join(', ') || 'N/A'}
- Equipment: ${p.lifestyle.equipment || 'Bodyweight only'}
- Experience: ${p.lifestyle.experience}, RPE: ${p.lifestyle.rpe}
- Injuries/constraints: ${p.lifestyle.injuries || 'None'}

### Diet & Preferences
- Goals: ${p.diet.goals.join(', ') || 'N/A'}, Meals/day: ${p.diet.meals}
- Diet type: ${p.diet.type}, Cuisine: ${p.diet.cuisine}, Prep time: ${p.diet.prep} min
- Budget: ${p.diet.budget || 'Auto'} ${p.diet.currency}
- Avoid/allergies: ${p.diet.avoid || 'None'}
- Preferred motivation style: ${p.diet.motivation}
- Past challenges: ${p.diet.challenges || 'None'}

### Special Muscles (each with issue)
${Object.keys(p.diet.muscles).length ? Object.entries(p.diet.muscles).map(([k,v])=>`- ${k}: ${v||'-'}`).join('\n') : 'None'}

### Medical
- Flags: ${p.medical.list.join(', ') || 'None'}
- Other: ${p.medical.other || 'None'}
- Current medications: ${p.medical.meds || 'None'}
- Current supplements: ${p.medical.supps || 'None'}

### What to produce
1) **Analysis**: brief precise assessment of the case and the goal path.
2) **Allowed & Limits**: lists of allowed, limited, avoid (consider allergies/medical).
3) **Intermittent Fasting** (only if helpful for goals or medical flags): protocol, feeding window, hydration, cautions.
4) **Daily Nutrition Plan (7 days)**: For each day produce all meals (as many as meals/day), with grams, macros and kcal totals. No placeholders. Distinct menus across 7 days.
5) **Training Plan (7 days)**: For each training day, list exercises (English names), sets/reps, tempo/RPE/rest, cardio (type/duration/HR zone). Adapt to experience and injuries and focused muscles.
6) **Supplements**: tailored to goals and medical flags with dosage, timing, and cautions.
7) **Progression**: how to progress weekly (load, volume, steps).
8) **Troubleshooting**: common issues and fixes.
9) **Safety**: red-flags and when to seek medical advice.
10) **Closing**: short commitment message.

Use neat Markdown with clear headings. Avoid repeating the welcome paragraph in later sections.
`;
    }

    async function callAI(prompt){
      const res = await fetch('/.netlify/functions/gemini-proxy', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt })
      });
      if(!res.ok){ throw new Error(await res.text()); }
      return res.json();
    }

    $('#btnGenerate').onclick = async (e)=>{
      e.preventDefault();
      const data = gatherForm();
      if(!data.profile.name || !data.profile.age || !data.profile.height || !data.profile.weight){
        alert( lang==='ar' ? 'أكمل الحقول الأساسية: الاسم/العمر/الطول/الوزن.' : 'Please complete name/age/height/weight.' );
        return;
      }
      $('#wait').classList.remove('hidden');
      $('#plan').innerHTML='';
      try{
        const prompt = buildPrompt(data);
        const ai = await callAI(prompt);
        const html = marked.parse(ai.text || '');
        $('#plan').innerHTML = html;
      }catch(err){
        $('#plan').innerHTML = `<div class="text-red-400 text-sm whitespace-pre-wrap">${String(err).slice(0,800)}</div>`;
      }finally{
        $('#wait').classList.add('hidden');
        window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
      }
    };

    $('#btnPrint').onclick = (e)=>{ e.preventDefault(); window.print(); };
    $('#btnPDF').onclick   = (e)=>{ e.preventDefault(); window.print(); }; // same action in browser

  </script>
</body>
</html>
