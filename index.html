<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark">
  <title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ± â€” Ù†Ø³Ø®Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
  <!-- SEO / Social -->
  <meta name="description" content="Ø®Ø·Ø© ØªØ¯Ø±ÙŠØ¨ ÙˆØªØºØ°ÙŠØ© Ø°ÙƒÙŠØ© Ù…Ø®ØµØµØ© Ù„Ù…Ø¯Ø© 7 Ø£ÙŠØ§Ù… Ù…Ø¹ ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ ØªØµØ¯ÙŠØ±ØŒ ÙˆØ·Ø¨Ø§Ø¹Ø© â€” Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©.">
  <meta property="og:title" content="Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±">
  <meta property="og:description" content="Ø®Ø·Ø© ØªØ¯Ø±ÙŠØ¨ ÙˆØªØºØ°ÙŠØ© Ø°ÙƒÙŠØ© Ù…Ø®ØµØµØ© Ù„Ù…Ø¯Ø© 7 Ø£ÙŠØ§Ù…">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="ar">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root { --card: 255 255 255; }
    html, body { height: 100%; scroll-behavior: smooth; }
    body { background: linear-gradient(180deg, #f6f7fb 0%, #eef1f7 100%); }
    .font-tajawal { font-family: 'Tajawal', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .font-poppins { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .card { background: rgba(var(--card)/1); }
    .stage-enter { animation: fadeIn .35s ease-out both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .file-drop { border: 2px dashed #d1d5db; transition: all .2s; }
    .file-drop.ready { border-color: #16a34a; background: #f0fdf4; }
    .ai-content h2, .ai-content h3 { scroll-margin-top: 96px; }
    .ai-content h3 { font-size: 1.35rem; font-weight: 800; color: #4338ca; padding-bottom: .5rem; border-bottom: 2px solid #e5e7eb; margin-top: 1.5rem; margin-bottom: .75rem; }
    .ai-content table { width: 100%; border-collapse: collapse; margin: 1.25rem 0; box-shadow: 0 2px 8px rgba(0,0,0,.05); border-radius: .5rem; overflow: hidden; }
    .ai-content th, .ai-content td { border: 1px solid #e5e7eb; padding: .75rem; vertical-align: top; }
    .ai-content th { background: #f9fafb; font-weight: 700; }
    [dir="rtl"] .ai-content th, [dir="rtl"] .ai-content td { text-align: right; }
    [dir="ltr"] .ai-content th, [dir="ltr"] .ai-content td { text-align: left; }
    .ltr-text { direction: ltr; text-align: left; }
    .num-input { direction: ltr; text-align: left; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#1118270d; border:1px solid #1118271a; border-radius:.375rem; padding:.15rem .35rem; font-size:.75rem }
    /* Print */
    @media print {
      body { background: #fff; }
      #app { box-shadow: none; margin: 0; max-width: 100%; border: none; }
      #topbar, #sticky, #progress-wrap, .no-print, #aside { display: none !important; }
    }
  </style>
</head>
<body class="font-tajawal min-h-screen">

  <!-- Container -->
  <div id="app" class="max-w-6xl mx-auto my-4 sm:my-10 card rounded-2xl shadow-2xl overflow-hidden border border-gray-200/60">
    <!-- Topbar -->
    <header id="topbar" class="px-4 sm:px-6 py-4 bg-white border-b flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-xl bg-indigo-600 text-white grid place-items-center font-extrabold text-lg">AI</div>
        <div class="leading-tight">
          <h1 class="text-base sm:text-lg font-extrabold text-gray-900">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±</h1>
          <p class="text-xs sm:text-sm text-gray-500">Ø®Ø·Ø© Ù…Ø®ØµØµØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ â”‚ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØµØ¯ÙŠØ± â”‚ Ø­Ù…Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª</p>
        </div>
      </div>
      <div class="flex items-center gap-2" aria-label="Language & Settings">
        <button id="btn-ar" class="px-2.5 py-1.5 rounded-lg text-sm font-bold" type="button">Ø¹Ø±Ø¨ÙŠ</button>
        <button id="btn-en" class="px-2.5 py-1.5 rounded-lg text-sm font-bold" type="button">EN</button>
        <button id="btn-theme" class="px-2.5 py-1.5 rounded-lg text-sm font-bold" type="button" title="Toggle Theme">ğŸŒ“</button>
      </div>
    </header>

    <!-- Progress -->
    <div id="progress-wrap" class="px-4 sm:px-6 pt-4 hidden">
      <div class="h-2.5 bg-gray-200 rounded-full overflow-hidden" role="progressbar" aria-valuemin="0" aria-valuemax="100">
        <div id="progress" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300" style="width:0%"></div>
      </div>
      <div class="mt-2 text-xs text-gray-500">Ø§Ù„Ø®Ø·ÙˆØ© <span id="step">1</span> Ù…Ù† 12</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12">
      <!-- Main -->
      <main id="content" class="lg:col-span-8 p-5 sm:p-8"></main>

      <!-- Aside: Live Summary -->
      <aside id="aside" class="lg:col-span-4 p-5 sm:p-8 bg-white/60 border-t lg:border-t-0 lg:border-l">
        <h2 class="text-sm font-extrabold text-gray-700 mb-3">Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª</h2>
        <div id="summary" class="text-sm text-gray-700 space-y-2">
          <p class="text-gray-400">Ø§Ø¨Ø¯Ø£ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù„Ø­Ø¸ÙŠâ€¦</p>
        </div>
        <div class="mt-4 flex gap-2">
          <button id="btn-save" class="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-bold" type="button">Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§</button>
          <button id="btn-load" class="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-bold" type="button">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
          <button id="btn-reset" class="px-3 py-1.5 rounded-lg bg-rose-50 hover:bg-rose-100 text-rose-700 text-sm font-bold" type="button">Ù…Ø³Ø­</button>
        </div>
        <p class="mt-3 text-xs text-gray-500">ÙŠÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·. Ù„Ø§ ØªÙØ±Ø³Ù„ Ù…Ù„ÙØ§Øª Ø£Ùˆ ØµÙˆØ± Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù….</p>
      </aside>
    </div>

    <!-- Sticky Nav -->
    <div id="sticky" class="hidden sticky bottom-0 bg-white/85 backdrop-blur-md border-t px-4 sm:px-6 py-3 flex gap-3 justify-between" style="padding-bottom:calc(.75rem + env(safe-area-inset-bottom))">
      <button id="prev" class="w-1/3 sm:w-40 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2.5 rounded-lg disabled:opacity-50" type="button">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <div class="flex items-center gap-3">
        <span class="hidden sm:inline text-xs text-gray-500">â†©ï¸ <span class="kbd">Enter</span> Ø§Ù„ØªØ§Ù„ÙŠ</span>
      </div>
      <button id="next" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-extrabold py-2.5 rounded-lg" type="button">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
  </div>

  <script>
  /************************** State **************************/
  const totalStages = 12;
  let state = { currentStage: 0, lang: 'ar', userData: { goals: [], weak_points: {}, health_conditions: [], allergies: [] } };
  let started = false;

  // Rate Limiter (client)
  const rate = { windowMs: 60_000, max: 10, queue: [] };
  const canCall = () => { const now = Date.now(); rate.queue = rate.queue.filter(t => now - t < rate.windowMs); return rate.queue.length < rate.max; };
  const markCall = () => rate.queue.push(Date.now());

  // Elements
  const content = document.getElementById('content');
  const summary = document.getElementById('summary');
  const progressWrap = document.getElementById('progress-wrap');
  const progressBar = document.getElementById('progress');
  const stepEl = document.getElementById('step');
  const sticky = document.getElementById('sticky');
  const btnPrev = document.getElementById('prev');
  const btnNext = document.getElementById('next');

  // i18n (Arabic only shown for brevity)
  const i18n = {
    ar: {
      start:"Ø§Ø¨Ø¯Ø£", welcome_title:"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­ÙˆÙ„!", welcome_desc:"Ø£Ù†Ø§ Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø°ÙƒÙŠ. Ø³Ù†Ø¨Ù†ÙŠ Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© ØªØ­Ù‚Ù‚ Ø£Ù‚ØµÙ‰ Ù†ØªØ§Ø¦Ø¬.",
      stage_1_title:"Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù…Ù† Ø£Ù†ØªØŸ", stage_1_desc:"Ø¹Ø±Ù‘ÙÙ†Ø§ Ø¨Ø§Ø³Ù…Ùƒ.",
      stage_2_title:"Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", stage_2_desc:"Ø§Ù„Ø¹Ù…Ø± ÙˆØ§Ù„Ø·ÙˆÙ„ ÙˆØ§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø¬Ù†Ø³.",
      stage_3_title:"ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù", stage_3_desc:"Ø§Ø®ØªØ± Ø£Ù‡Ø¯Ø§ÙÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.", goal_sub:"ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù‡Ø¯Ù.",
      stage_4_title:"Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©", stage_4_desc:"Ù‡Ø¯Ù ÙˆØ²Ù†ÙŠ/ØªØ§Ø±ÙŠØ® Ù…Ù†Ø§Ø³Ø¨Ø©.",
      stage_5_title:"Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ Ø§Ù„Ù…ÙØ¶Ù„", stage_5_desc:"Ù†Ø±Ø´Ø­ Ø§Ù„Ø£ÙØ¶Ù„ Ø­Ø³Ø¨ Ø§Ù„Ù‡Ø¯Ù.",
      stage_6_title:"Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©", stage_6_desc:"Ù„Ø®Ø·Ø© Ø¢Ù…Ù†Ø© ÙˆÙØ¹Ø§Ù„Ø©.",
      stage_7_title:"Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ", stage_7_desc:"Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ù„Ø®Ø¨Ø±Ø© ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª.",
      stage_8_title:"Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØªØ±ÙƒÙŠØ²", stage_8_desc:"Ø­Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù ÙˆØ£ÙˆØµØ§ÙÙ‡Ø§.",
      stage_9_title:"Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©", stage_9_desc:"Ø£Ù…Ø±Ø§Ø¶ ÙˆØ¥ØµØ§Ø¨Ø§Øª Ù„Ù„ØªÙØ§Ø¯ÙŠ.",
      stage_10_title:"Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©", stage_10_desc:"Ø§Ù„Ø¹Ù…Ù„ØŒ Ø§Ù„Ù†ÙˆÙ…ØŒ Ø§Ù„ØªÙˆØªØ±.",
      stage_11_title:"ØªØ­Ù„ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", stage_11_desc:"ØµÙˆØ±/InBody Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¯Ù‚Ø©.",
      name_q:"Ù…Ø§ Ø§Ø³Ù…ÙƒØŸ", age:"Ø§Ù„Ø¹Ù…Ø±", height:"Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)", weight:"Ø§Ù„ÙˆØ²Ù† (ÙƒØº)", gender:"Ø§Ù„Ø¬Ù†Ø³", male:"Ø°ÙƒØ±", female:"Ø£Ù†Ø«Ù‰",
      goal1:"Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†", goal2:"Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª", goal3:"Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©", goal4:"ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„", goal5:"ØµØ­Ø© Ø¹Ø§Ù…Ø©",
      target_weight:"Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù", target_date:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©",
      diet_pref:"Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ", diet_opt1:"Ù…ØªÙˆØ§Ø²Ù†", diet_opt2:"Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª", diet_opt3:"ØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹", diet_opt4:"ÙƒÙŠØªÙˆ", diet_opt5:"Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·", diet_opt6:"Ù†Ø¨Ø§ØªÙŠ", recommended:"Ù…Ø±Ø´Ø­",
      allergies_q:"Ø­Ø³Ø§Ø³ÙŠØ©/Ø§Ù„ØªÙ‡Ø§Ø¨Ø§ØªØŸ", allergy1:"Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†", allergy2:"Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²", allergy3:"Ø§Ù„Ù…ÙƒØ³Ø±Ø§Øª", allergy4:"Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ©", allergy5:"Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø©", allergy6:"Ø§Ù„Ø²ÙŠÙˆØª Ø§Ù„Ù†Ø¨Ø§ØªÙŠØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©", other_allergies:"Ø­Ø³Ø§Ø³ÙŠØ© Ø£Ø®Ø±Ù‰",
      training_history_q:"ØªØ§Ø±ÙŠØ®Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ", history_last_train:"Ø¢Ø®Ø± Ø§Ù„ØªØ²Ø§Ù…ØŸ", last_train_opt1:"Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±", last_train_opt2:"3-12 Ø´Ù‡Ø±", last_train_opt3:"Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†Ø©",
      history_exp:"Ø®Ø¨Ø±Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©", exp_opt1:"Ù…Ø¨ØªØ¯Ø¦", exp_opt2:"Ù…ØªÙˆØ³Ø·", exp_opt3:"Ù…ØªÙ‚Ø¯Ù…", history_supps:"Ù…ÙƒÙ…Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©", upload_supps:"Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª",
      weak_points_q:"Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØªØ±ÙƒÙŠØ²", weak_points_sub:"Ø§Ø°ÙƒØ± Ù‡Ø¯Ù ÙƒÙ„ Ø¹Ø¶Ù„Ø©.",
      health_q:"ØµØ­ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹", health_cond1:"Ø¶ØºØ· Ø§Ù„Ø¯Ù…", health_cond2:"Ø§Ù„Ø³ÙƒØ±ÙŠ", health_cond3:"Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†", health_cond4:"Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©", health_cond5:"Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ", health_cond6:"Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©", health_cond7:"Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù‡Ø¶Ù…ÙŠ", injuries_q:"Ø¥ØµØ§Ø¨Ø§ØªØŸ", injuries_sub:"Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…ÙƒØ§Ù†",
      lifestyle_q:"Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©", job:"Ø§Ù„Ø¹Ù…Ù„", job_opt1:"Ù…ÙƒØªØ¨ÙŠ", job_opt2:"Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ", job_opt3:"Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·", sleep:"Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù†ÙˆÙ…", stress:"Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙˆØªØ±", stress_opt1:"Ù…Ù†Ø®ÙØ¶", stress_opt2:"Ù…ØªÙˆØ³Ø·", stress_opt3:"Ù…Ø±ØªÙØ¹",
      files_q:"Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©", photos_up:"ğŸ“· Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ø¬Ø³Ù…", inbody_up:"ğŸ“„ Ø±ÙØ¹ InBody", photos_done:(n)=>`âœ… ${n} ØµÙˆØ±Ø©`, inbody_done:"âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù",
      loading_title:(n)=>`Ø¬Ø§Ù‡Ø² ÙŠØ§ ${n}!`, loading_sub:"Ù†Ø¹Ø§Ù„Ø¬ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙˆÙ†Ø¨Ù†ÙŠ Ø®Ø·Ø© Ù…ØªÙƒØ§Ù…Ù„Ø©.", print_btn:"Ø·Ø¨Ø§Ø¹Ø© / ØªØ­Ù…ÙŠÙ„", restart_btn:"Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯", next:"Ø§Ù„ØªØ§Ù„ÙŠ", prev:"Ø§Ù„Ø³Ø§Ø¨Ù‚", submit:"Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†!", swap:"ØªØ¨Ø¯ÙŠÙ„", swapping:"Ø¬Ø§Ø±ÙŠâ€¦", error_fill_fields:"Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.",
      chest:"Ø§Ù„ØµØ¯Ø±", back:"Ø§Ù„Ø¸Ù‡Ø±", shoulders:"Ø§Ù„Ø£ÙƒØªØ§Ù", biceps:"Ø§Ù„Ø¨Ø§ÙŠØ³Ø¨Ø³", triceps:"Ø§Ù„ØªØ±Ø§ÙŠØ³Ø¨Ø³", quads:"Ø§Ù„ÙØ®Ø° Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ", hamstrings:"Ø§Ù„ÙØ®Ø° Ø§Ù„Ø®Ù„ÙÙŠ", glutes:"Ø§Ù„Ø£Ù„ÙˆÙŠØ©", calves:"Ø§Ù„Ø³Ù…Ø§Ù†Ø©", abs:"Ø§Ù„Ø¨Ø·Ù†",
      export:"ØªØµØ¯ÙŠØ±", export_json:"JSON", export_csv:"CSV", days_check:"ÙØ­Øµ Ø§Ù„Ø£ÙŠØ§Ù…", nutrition:"Ø§Ù„ØªØºØ°ÙŠØ© (7 Ø£ÙŠØ§Ù…)", training:"Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)", daily_targets:"Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ÙŠÙˆÙ…ÙŠØ©",
      api_key_error: "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ø£Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­.",
    },
    en: { /* kept minimal to reduce size; logic supports en toggle */ }
  };
  const muscles = ['chest','back','shoulders','biceps','triceps','quads','hamstrings','glutes','calves','abs'];

  /*********************** Utils ************************/ 
  function T(key, ...args) { const t = i18n[state.lang]?.[key]; return typeof t === 'function' ? t(...args) : (t || key); }
  function $(sel){ return document.querySelector(sel); }
  function stageLayout(title, desc, inner){ return `<section class="stage-enter" aria-live="polite"><h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900">${title}</h2><p class="mt-1 text-gray-600">${desc||''}</p><form id="form" class="space-y-5 mt-6" onsubmit="event.preventDefault();">${inner}</form></section>`; }
  function field(label,id,opts={}){ const { type='text', value='', required=false, select=null, placeholder='', num=false } = opts; if(select){ return `<label class="block"><span class="font-medium text-gray-800">${label}</span><select id="${id}" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">${select.map(o=>`<option ${String(value)===String(o.value)?'selected':''} value="${o.value}">${o.label}</option>`).join('')}</select></label>`;} if(type==='textarea'){ return `<label class="block"><span class="font-medium text-gray-800">${label}</span><textarea id="${id}" rows="3" placeholder="${placeholder}" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">${value||''}</textarea></label>`;} return `<label class="block"><span class="font-medium text-gray-800">${label}</span><input id="${id}" type="${type}" ${required?'required':''} value="${value}" placeholder="${placeholder}" ${num?'inputmode="numeric" pattern="[0-9]*"':''} class="${num?'num-input ':''}mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></label>`; }

  function applyLocale(){ const html = document.documentElement; html.lang = state.lang; html.dir = state.lang==='ar' ? 'rtl' : 'ltr'; document.body.classList.toggle('font-tajawal', state.lang==='ar'); document.body.classList.toggle('font-poppins', state.lang!=='ar'); $('#btn-ar').className = `px-2.5 py-1.5 rounded-lg text-sm font-bold ${state.lang==='ar'?'bg-indigo-600 text-white':'bg-gray-100 text-gray-700'}`; $('#btn-en').className = `px-2.5 py-1.5 rounded-lg text-sm font-bold ${state.lang==='en'?'bg-indigo-600 text-white':'bg-gray-100 text-gray-700'}`; if(started){ btnPrev.textContent=T('prev'); btnNext.textContent = state.currentStage===totalStages?T('submit'):T('next'); } renderSummary(); }
  function updateProgress(){ const p = Math.max(0, ((state.currentStage-1)/totalStages)*100); progressBar.style.width = `${p}%`; stepEl.textContent = String(Math.min(state.currentStage,totalStages)); progressWrap.classList.toggle('hidden', !started || state.currentStage===0 || state.currentStage>totalStages); }

  /********************* Stages *************************/
  function renderStage(stage){ applyLocale(); updateProgress(); content.innerHTML = '<div class="py-14 grid place-items-center"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500" aria-hidden="true"></div></div>';
    setTimeout(()=>{ const s = state.userData; let title='', desc='', html=''; switch(stage){
      case 0: content.innerHTML = `<section class="stage-enter text-center p-6 sm:p-10"><h2 class="text-3xl font-extrabold text-gray-900 mb-2">${T('welcome_title')}</h2><p class="text-gray-600 max-w-xl mx-auto">${T('welcome_desc')}</p><div class="mt-8"><div class="inline-flex gap-2 items-center"><select id="lang-select" class="p-3 rounded-lg border-gray-300 border"><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option></select><button id="start" class="bg-indigo-600 hover:bg-indigo-700 text-white font-extrabold px-8 py-3 rounded-xl" type="button">${T('start')}</button></div><p class="mt-3 text-xs text-gray-500">Enter â†©ï¸ Ù„Ù„ØªØ§Ù„ÙŠ Â· <span class="kbd">Ctrl</span> + <span class="kbd">S</span> Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ</p></div></section>`; $('#start').onclick=()=>{ state.lang=$('#lang-select').value; started=true; sticky.classList.remove('hidden'); btnPrev.disabled=true; state.currentStage=1; renderStage(1); }; break;
      case 1: title=T('stage_1_title'); desc=T('stage_1_desc'); html=field(T('name_q'),'name',{required:true,value:s.name||''}); content.innerHTML=stageLayout(title,desc,html); $('#name').focus(); break;
      case 2: title=T('stage_2_title'); desc=T('stage_2_desc'); html=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${field(T('age'),'age',{type:'number',value:s.age||'',required:true,num:true})}${field(T('height'),'height',{type:'number',value:s.height||'',required:true,num:true})}${field(T('weight'),'weight',{type:'number',value:s.weight||'',required:true,num:true})}${field(T('gender'),'gender',{select:[{value:'Male',label:T('male')},{value:'Female',label:T('female')}],value:s.gender||'Male'})}</div>`; content.innerHTML=stageLayout(title,desc,html); break;
      case 3: title=T('stage_3_title'); desc=T('stage_3_desc'); const goals=['goal1','goal2','goal3','goal4','goal5']; html=`<p class="text-sm text-gray-500">${T('goal_sub')}</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">${goals.map(k=>{ const v=T(k); const on=(s.goals||[]).includes(v)?'checked':''; return `<label class="block p-4 rounded-lg border custom-checkbox-label cursor-pointer"><input ${on} type="checkbox" name="goal" value="${v}" class="mr-4 ml-2 accent-indigo-600"><span>${v}</span></label>`}).join('')}</div>`; content.innerHTML=stageLayout(title,desc,html); break;
      case 4: title=T('stage_4_title'); desc=T('stage_4_desc'); html=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${field(T('target_weight'),'target_weight',{type:'number',value:s.target_weight||'',num:true})}${field(T('target_date'),'target_date',{type:'date',value:s.target_date||''})}</div>`; content.innerHTML=stageLayout(title,desc,html); break;
      case 5: title=T('stage_5_title'); desc=T('stage_5_desc'); let rec=T('diet_opt1'); if((s.goals||[]).includes(T('goal1'))) rec=T('diet_opt2'); const dietKeys=['diet_opt1','diet_opt2','diet_opt3','diet_opt4','diet_opt5','diet_opt6']; html=`${field(T('diet_pref'),'diet_preference',{select:dietKeys.map(k=>({value:T(k),label:`${T(k)}${rec===T(k)?` (${T('recommended')})`:''}`})),value:s.diet_preference||T('diet_opt1')})}`; content.innerHTML=stageLayout(title,desc,html); break;
      case 6: title=T('stage_6_title'); desc=T('stage_6_desc'); const allergyVals=[T('allergy1'),T('allergy2'),T('allergy3'),T('allergy4'),T('allergy5'),T('allergy6')]; html=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${allergyVals.map(v=>{ const on=(s.allergies||[]).includes(v)?'checked':''; return `<label class="block p-3 rounded-lg border custom-checkbox-label cursor-pointer"><input ${on} type="checkbox" name="allergy" value="${v}" class="mr-4 ml-2 accent-indigo-600"><span>${v}</span></label>`}).join('')}</div>${field(T('other_allergies'),'other_allergies',{value:s.other_allergies||''})}`; content.innerHTML=stageLayout(title,desc,html); break;
      case 7: title=T('stage_7_title'); desc=T('stage_7_desc'); html=`${field(T('history_last_train'),'last_train',{select:[{value:T('last_train_opt1'),label:T('last_train_opt1')},{value:T('last_train_opt2'),label:T('last_train_opt2')},{value:T('last_train_opt3'),label:T('last_train_opt3')}],value:s.last_train||T('last_train_opt1')})}${field(T('history_exp'),'training_exp',{select:[{value:T('exp_opt1'),label:T('exp_opt1')},{value:T('exp_opt2'),label:T('exp_opt2')},{value:T('exp_opt3'),label:T('exp_opt3')}],value:s.training_exp||T('exp_opt1')})}${field(T('history_supps'),'prev_supps',{value:s.prev_supps||'',placeholder:'Omegaâ€‘3, Vitamin D ...'})}<label class="file-drop p-3 mt-2 block text-center rounded-lg cursor-pointer text-sm"><span id="supp-feedback">${T('upload_supps')}</span><input type="file" id="supp_photos" class="hidden" multiple accept="image/*"></label>`; content.innerHTML=stageLayout(title,desc,html); attachFileListeners(); break;
      case 8: title=T('stage_8_title'); desc=T('stage_8_desc'); html=`<div class="space-y-4">${muscles.map(m=>`<div class="relative flex items-start"><div class="flex items-center h-5"><input id="${m}" name="${m}" type="checkbox" ${(s.weak_points||{})[m]?'checked':''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"></div><div class="ml-3 mr-3 text-sm flex-1"><label for="${m}" class="font-medium text-gray-700">${T(m)}</label><input type="text" id="${m}_desc" class="w-full p-1 border-b-2 focus:border-indigo-500 outline-none" value="${(s.weak_points||{})[m]||''}" placeholder="${T('weak_points_sub')}"></div></div>`).join('')}</div>`; content.innerHTML=stageLayout(title,desc,html); break;
      case 9: title=T('stage_9_title'); desc=T('stage_9_desc'); const cond=['health_cond1','health_cond2','health_cond3','health_cond4','health_cond5','health_cond6','health_cond7']; html=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${cond.map(k=>{ const v=T(k); const on=(s.health_conditions||[]).includes(v)?'checked':''; return `<label class="block p-3 rounded-lg border custom-checkbox-label cursor-pointer"><input ${on} type="checkbox" name="health_condition" value="${v}" class="mr-4 ml-2 accent-indigo-600"><span>${v}</span></label>`}).join('')}</div>${field(T('injuries_q'),'injuries',{type:'textarea',value:s.injuries||'',placeholder:T('injuries_sub')})}`; content.innerHTML=stageLayout(title,desc,html); break;
      case 10: title=T('stage_10_title'); desc=T('stage_10_desc'); html=`<div class="grid grid-cols-1 sm:grid-cols-3 gap-4">${field(T('job'),'job_activity',{select:[{value:T('job_opt1'),label:T('job_opt1')},{value:T('job_opt2'),label:T('job_opt2')},{value:T('job_opt3'),label:T('job_opt3')}],value:s.job_activity||T('job_opt1')})}${field(T('sleep'),'sleep_hours',{type:'number',value:s.sleep_hours||'',required:true,num:true})}${field(T('stress'),'stress_level',{select:[{value:T('stress_opt1'),label:T('stress_opt1')},{value:T('stress_opt2'),label:T('stress_opt2')},{value:T('stress_opt3'),label:T('stress_opt3')}],value:s.stress_level||T('stress_opt2')})}</div>`; content.innerHTML=stageLayout(title,desc,html); break;
      case 11: title=T('stage_11_title'); desc=T('stage_11_desc'); html=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><label class="file-drop p-6 block text-center rounded-xl cursor-pointer"><span id="photo-feedback">${T('photos_up')}</span><input type="file" id="photos" class="hidden" multiple accept="image/*"></label><label class="file-drop p-6 block text-center rounded-xl cursor-pointer"><span id="inbody-feedback">${T('inbody_up')}</span><input type="file" id="inbody" class="hidden" accept="image/*,.pdf"></label></div>`; content.innerHTML=stageLayout(title,desc,html); attachFileListeners(); break;
      case 12: content.innerHTML = `<section class="stage-enter p-5 sm:p-8"><div class="no-print text-center"><h2 class="text-2xl font-extrabold text-gray-900 mb-1">${T('loading_title', s.name || '')}</h2><p class="text-gray-600">${T('loading_sub')}</p><div class="mt-6 animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600 mx-auto" aria-hidden="true"></div></div><div id="plan" class="mt-6 ai-content" dir="${state.lang==='ar'?'rtl':'ltr'}"></div><div id="qc" class="mt-3 text-xs text-gray-500"></div><div class="no-print mt-6 flex flex-wrap gap-3 justify-center"><button id="btn-print" class="hidden bg-green-600 hover:bg-green-700 text-white font-extrabold px-6 py-2.5 rounded-lg" type="button">${T('print_btn')}</button><div class="hidden" id="export-wrap"><span class="px-3 py-2 bg-gray-100 rounded-lg text-sm font-medium">${T('export')}:</span><button id="exp-json" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold px-3 py-2 rounded-lg" type="button">${T('export_json')}</button><button id="exp-csv" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold px-3 py-2 rounded-lg" type="button">${T('export_csv')}</button></div><button id="btn-restart" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-800 font-extrabold px-6 py-2.5 rounded-lg" type="button">${T('restart_btn')}</button></div></section>`; generatePlan(); break; }
      if(started){ btnNext.textContent = state.currentStage===totalStages?T('submit'):T('next'); btnNext.className = `flex-1 ${state.currentStage===totalStages?'bg-green-600 hover:bg-green-700':'bg-indigo-600 hover:bg-indigo-700'} text-white font-extrabold py-2.5 rounded-lg`; btnPrev.textContent=T('prev'); btnPrev.disabled = state.currentStage<=1; }
    },150);
  }

  /**************** Navigation + Save ****************/
  function saveAndNext(stage){ try{ const s=state.userData; switch(stage){
      case 1: s.name=$('#name').value.trim(); if(!s.name) throw 0; break;
      case 2: s.age=$('#age').value; s.height=$('#height').value; s.weight=$('#weight').value; s.gender=$('#gender').value; if(!s.age||!s.height||!s.weight) throw 0; break;
      case 3: s.goals=[...document.querySelectorAll('input[name="goal"]:checked')].map(e=>e.value); if(!s.goals.length) throw 0; break;
      case 4: s.target_weight=$('#target_weight').value; s.target_date=$('#target_date').value; break;
      case 5: s.diet_preference=$('#diet_preference').value; break;
      case 6: s.allergies=[...document.querySelectorAll('input[name="allergy"]:checked')].map(e=>e.value); { const other=$('#other_allergies').value.trim(); if(other) s.allergies.push(other); } break;
      case 7: s.last_train=$('#last_train').value; s.training_exp=$('#training_exp').value; s.prev_supps=$('#prev_supps').value; s.has_supp_photos=$('#supp_photos')?.files.length>0; break;
      case 8: s.weak_points={}; muscles.forEach(m=>{ const cb=$(`#${m}`); if(cb?.checked) s.weak_points[m]=$(`#${m}_desc`).value||'General'; }); break;
      case 9: s.health_conditions=[...document.querySelectorAll('input[name="health_condition"]:checked')].map(e=>e.value); s.injuries=$('#injuries').value; break;
      case 10: s.job_activity=$('#job_activity')?.value||$('#job_activity')?.textContent; s.sleep_hours=$('#sleep_hours').value; s.stress_level=$('#stress_level').value; if(!s.sleep_hours) throw 0; break;
      case 11: s.has_photos=$('#photos')?.files.length>0; s.has_inbody=$('#inbody')?.files.length>0; break; }
      state.currentStage++; renderStage(state.currentStage); renderSummary();
    }catch(e){ notify(T('error_fill_fields'),'error'); }
  }
  function goBack(){ if(state.currentStage>1){ state.currentStage--; renderStage(state.currentStage); renderSummary(); } }
  btnPrev.onclick = goBack; btnNext.onclick = ()=> saveAndNext(state.currentStage);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey && started){ e.preventDefault(); saveAndNext(state.currentStage); } if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveLocal(); } });

  // Local persistence
  function saveLocal(){ localStorage.setItem('aiCoachState', JSON.stringify(state)); notify('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§'); }
  function loadLocal(){ const raw=localStorage.getItem('aiCoachState'); if(!raw) return notify('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©','warning'); try{ const st=JSON.parse(raw); if(st) { state=st; started=state.currentStage>0; sticky.classList.toggle('hidden',!started); renderStage(state.currentStage); renderSummary(); notify('ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹'); } }catch{ notify('ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹','error'); } }
  function resetLocal(){ localStorage.removeItem('aiCoachState'); notify('ØªÙ… Ø§Ù„Ù…Ø³Ø­'); }
  document.getElementById('btn-save').onclick = saveLocal;
  document.getElementById('btn-load').onclick = loadLocal;
  document.getElementById('btn-reset').onclick = resetLocal;

  /**************** Files ****************/
  function attachFileListeners(){ const p=$('#photos'); if(p) p.addEventListener('change', e=>{ $('#photo-feedback').textContent = i18n[state.lang].photos_done(e.target.files.length); p.parentElement.classList.add('ready'); }); const i=$('#inbody'); if(i) i.addEventListener('change', ()=>{ $('#inbody-feedback').textContent=T('inbody_done'); i.parentElement.classList.add('ready'); }); const s=$('#supp_photos'); if(s) s.addEventListener('change', e=>{ $('#supp-feedback').textContent = i18n[state.lang].photos_done(e.target.files.length); s.parentElement.classList.add('ready'); }); }

  /**************** Calculations ****************/
  function computeTargets(p){ const W=Number(p.weight)||0, H=Number(p.height)||0, A=Number(p.age)||0; const male=p.gender==='Male'; const BMR = male ? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161; const factor=(p.job_activity===T('job_opt1')?1.2:(p.job_activity===T('job_opt3')?1.5:1.35)); let TDEE=BMR*factor; const goals=p.goals||[]; if(goals.includes(T('goal1'))) TDEE*=0.86; else if(goals.includes(T('goal2'))) TDEE*=1.1; const targetW=Number(p.target_weight)||W||1; const protein_g=Math.round(2.0*targetW); const fat_g=Math.round(Math.max(0,0.8*W)); let carb_g=Math.round((TDEE - (protein_g*4 + fat_g*9))/4); const hasIR=(p.health_conditions||[]).some(h=>[T('health_cond2'),T('health_cond3')].includes(h)); if(hasIR) carb_g=Math.min(carb_g,120); carb_g=Math.max(0,carb_g); return { calories: Math.round(TDEE), macros:{ protein_g, fat_g, carb_g } } }

  /**************** AI ****************/
  let lastPlanJSON=null;
  async function generatePlan(){ const p=state.userData; const targets=computeTargets(p); const proxyUrl='/.netlify/functions/gemini-proxy'; const prompt=buildAIPrompt(p,state.lang,targets); const aiResponse=await callAI(prompt,proxyUrl); if(aiResponse.ok && aiResponse.text){ renderAI(aiResponse.text); } else { console.error('AI call failed', aiResponse.error); renderErrorMessage(aiResponse.error); }
    // controls
    $('#btn-print').classList.remove('hidden'); $('#btn-restart').classList.remove('hidden'); $('#export-wrap').classList.remove('hidden'); $('#btn-print').onclick=()=>window.print(); $('#exp-json').onclick=()=>exportJSON(lastPlanJSON); $('#exp-csv').onclick=()=>exportCSV(lastPlanJSON); $('#btn-restart').onclick=restartApp; }

  function buildAIPrompt(profile, lang, targets){ const weak = Object.entries(profile.weak_points||{}).map(([muscle,desc])=>`${T(muscle)}: ${desc}`).join(', ') || 'None'; return `Act as \"Coach Mustafa Al-Safi\", a world-class nutrition & fitness expert. Create a professional, SAFE, personalized 7-day plan for \"${profile.name}\".\nCRITICAL: Reply in ${lang} only. Food names in ${lang}. Exercise names in English only. Use clear Markdown tables. Avoid contraindicated movements per injuries: \"${profile.injuries||'None'}\".\n\nUser Data:\n- Goals: ${(profile.goals||[]).join(', ')}\n- Target: W ${profile.target_weight||'N/A'} by ${profile.target_date||'N/A'}\n- History: last train ${profile.last_train}, experience ${profile.training_exp}\n- Focus: ${weak}\n- Stats: age ${profile.age}, height ${profile.height} cm, weight ${profile.weight} kg, gender ${profile.gender}\n- Health: ${(profile.health_conditions||[]).join(', ')||'None'}; Allergies: ${(profile.allergies||[]).join(', ')||'None'}\n- Diet: ${profile.diet_preference}\n- Daily targets: P ${targets.macros.protein_g} g, F ${targets.macros.fat_g} g, C ${targets.macros.carb_g} g (~${targets.calories} kcal)\n\nOUTPUT STRUCTURE:\n### 1) Ù…Ù‚Ø¯Ù…Ø© Ø´Ø®ØµÙŠØ© ÙˆØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„\n(ÙÙ‚Ø±Ø© Ø¥ÙØªØªØ§Ø­ÙŠØ© Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚ ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø±.)\n### 2) Ø®Ø·Ø© Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© (7 Ø£ÙŠØ§Ù…)\n- Ø¬Ø¯ÙˆÙ„ ÙŠÙˆÙ…ÙŠ Ø¨ÙˆØ¬Ø¨Ø§Øª Ù…ÙØµÙ„Ø© ÙˆÙ…ÙƒÙˆÙ†Ø§Øª ÙˆÙƒÙ…ÙŠØ§Øª. ÙƒÙ„ ÙˆØ¬Ø¨Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø¨Ø± [SWAP:MEAL:Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ø¨Ø©].\n### 3) Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù…\n- Ù†Ù‚Ø§Ø· ÙˆØ§Ø¶Ø­Ø© Ù…Ø®ØªØµØ±Ø©.\n### 4) Ø®Ø·Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…) â€” progressive overload\n- Ø¬Ø¯ÙˆÙ„ Ù„ÙƒÙ„ ÙŠÙˆÙ…: Exercise | Sets | Reps | Rest (sec). ÙƒÙ„ ØªÙ…Ø±ÙŠÙ† Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ [SWAP:EXERCISE:Exercise].\n### 5) Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±\n- ÙƒÙŠÙ Ù†Ø²ÙŠØ¯ Ø§Ù„Ø­Ù…Ù„ + Ù…ØªÙ‰ Ù†Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø©.\n### 6) Ù…ÙƒÙ…Ù„Ø§Øª ÙˆÙ†Ù…Ø· Ø­ÙŠØ§Ø©\n- Ù…ÙƒÙ…Ù„Ø§Øª Ø¢Ù…Ù†Ø© (Ø¬Ø±Ø¹Ø§Øª) + Ù†ÙˆÙ… ÙˆÙ…Ø§Ø¡ ÙˆØªÙˆØªØ±.\n\nÙ‚Ù‘Ù… Ø§Ù„Ù†Øµ Ø¨Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ø¶Ø­Ø©ØŒ ÙˆØ§Ù†Ù‡Ù Ø¨ØªÙˆÙ‚ÙŠØ¹: **Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ**.`; }

  async function callAI(prompt, url){ if(!canCall()) return { ok:false, error:'Rate limited' }; try{ markCall(); const res=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt }) }); if(!res.ok){ const errorText=await res.text(); return { ok:false, error:errorText||'Server error' }; } const data=await res.json(); return { ok:true, text:data.text }; } catch(e){ return { ok:false, error:String(e) }; } }

  function renderAI(markdown){ let html=marked.parse(markdown); html = html.replace(/\[SWAP:(EXERCISE|MEAL):(.*?)\]/g,(m,type,item)=>{ const t=type.toLowerCase(); const clean=item.replace(/\"/g,'&quot;'); const btn=`<button type="button" onclick="swapItem(event)" data-type="${t}" data-item="${clean}" class="no-print bg-gray-200 hover:bg-gray-300 text-gray-800 text-xs px-2 py-1 rounded-md">${T('swap')}</button>`; return t==='meal' ? `<span class="inline-flex items-center gap-2">${item} ${btn}</span>` : `<span class="inline-flex items-center gap-2 ltr-text"><span class="font-semibold">${item}</span>${btn}</span>`; }); const planEl=$('#plan'); planEl.innerHTML=html; document.querySelectorAll('.no-print .animate-spin').forEach(e=>e.style.display='none'); document.querySelectorAll('.no-print h2, .no-print p').forEach(e=>e.style.display='none'); lastPlanJSON={ source:'ai_markdown', raw: markdown }; qualityCheck(); renderSummary(); }
  function renderErrorMessage(error){ const planEl=$('#plan'); planEl.innerHTML = `<div class="p-4 bg-red-100 border-l-4 border-red-500 rounded-r-lg mb-4"><h3 class="font-bold text-red-800">${T('api_key_error')}</h3><p class="text-red-700 text-xs ltr-text">${String(error).slice(0,800)}</p></div>`; document.querySelectorAll('.no-print .animate-spin, .no-print h2, .no-print p').forEach(e=>e.style.display='none'); $('#btn-restart').classList.remove('hidden'); $('#btn-restart').onclick=restartApp; }
  function qualityCheck(){ const qc=$('#qc'); if(!qc) return; try{ const txt=$('#plan').innerText||''; const days=[1,2,3,4,5,6,7]; const found=days.filter(d=> new RegExp(`(Day\\s*${d}|Ø§Ù„ÙŠÙˆÙ…\\s*${d})`,'i').test(txt)); const badge=`${T('days_check')}: ${found.length}/7`; qc.innerHTML = `<span class="inline-flex items-center gap-2 px-2 py-1 rounded-lg ${found.length===7?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800'}">${badge}</span>`; } catch { qc.textContent=''; } }

  /**************** Swap ****************/
  async function swapItem(e){ const button=e.target.closest('button'); if(!button) return; const type=button.dataset.type; const item=(button.dataset.item||'').toString(); const original=button.textContent; button.disabled=true; button.textContent=T('swapping'); const { userData }=state; let prompt=''; if(type==='meal'){ prompt=`Ø¨Ø¯Ù‘Ù„ ÙˆØ¬Ø¨Ø© \"${item}\" Ø¨ÙˆØ¬Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù†Ø¸Ø§Ù… ${userData.diet_preference}. ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©: ${(userData.allergies||[]).join(', ')||'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}. Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª ÙÙ‚Ø· Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.`; } else { prompt=`Ø¨Ø¯Ù‘Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ† \"${item}\" Ø¨Ø¨Ø¯ÙŠÙ„ ÙŠØ³ØªÙ‡Ø¯Ù Ù†ÙØ³ Ø§Ù„Ø¹Ø¶Ù„Ø© ÙˆØ¨Ù…Ø§ ÙŠÙ„Ø§Ø¦Ù… Ù…Ø³ØªÙˆÙ‰ ${userData.training_exp} ÙˆÙŠØªØ¬Ù†Ø¨ Ø¥ØµØ§Ø¨Ø§Øª: ${userData.injuries||'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}. Ø§ÙƒØªØ¨: Exercise + sets x reps ÙÙ‚Ø·.`; } const proxyUrl='/.netlify/functions/gemini-proxy'; const ai=await callAI(prompt,proxyUrl); let suggestion=''; if(ai.ok && ai.text){ suggestion=ai.text.trim().replace(/"/g,''); } else { notify(T('api_key_error'),'error'); } if(suggestion){ const target=button.parentElement; if(type==='meal'){ target.childNodes[0].nodeValue = `${suggestion} `; button.dataset.item=suggestion; } else { const newName = suggestion.split(':')[0]?.trim()||suggestion; target.querySelector('.font-semibold').textContent=newName; const cell=button.closest('td'); if(cell){ cell.innerHTML = cell.innerHTML.replace(item,newName); } button.dataset.item=newName; } } button.disabled=false; button.textContent=original; }

  /**************** Export ****************/
  function exportJSON(data){ if(!data) return; const blob=new Blob([JSON.stringify({ userData: state.userData, plan: data }, null, 2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ai-coach-plan.json'; a.click(); }
  function exportCSV(data){ if(!data) return; let rows=[]; if(data.source==='ai_markdown'){ rows.push(['source','ai_markdown']); rows.push(['prompt_data', JSON.stringify(state.userData)]); rows.push(['raw_response', data.raw]); } const csv=rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ai-coach-plan.csv'; a.click(); }

  /**************** Summary Panel ****************/
  function renderSummary(){ const s=state.userData; const items=[ ['Ø§Ù„Ø§Ø³Ù…', s.name||'â€”'], ['Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ø·ÙˆÙ„/Ø§Ù„ÙˆØ²Ù†', [s.age,s.height,s.weight].filter(Boolean).join(' / ')||'â€”'], ['Ø§Ù„Ø¬Ù†Ø³', s.gender||'â€”'], ['Ø§Ù„Ø£Ù‡Ø¯Ø§Ù', (s.goals||[]).join(', ')||'â€”'], ['Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…', `${s.target_weight||'â€”'} | ${s.target_date||'â€”'}`], ['Ø§Ù„Ù†Ø¸Ø§Ù…', s.diet_preference||'â€”'], ['Ø­Ø³Ø§Ø³ÙŠØ§Øª', (s.allergies||[]).join(', ')||'â€”'], ['Ø®Ø¨Ø±Ø©/Ø¢Ø®Ø± ØªØ¯Ø±ÙŠØ¨', `${s.training_exp||'â€”'} | ${s.last_train||'â€”'}`], ['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©', (s.health_conditions||[]).join(', ')||'â€”'], ['Ø¥ØµØ§Ø¨Ø§Øª', s.injuries||'â€”'] ]; summary.innerHTML = `<ul class="space-y-1">${items.map(([k,v])=>`<li class="flex justify-between gap-2"><span class="text-gray-500">${k}</span><span class="font-semibold text-gray-800 ltr-text">${v}</span></li>`).join('')}</ul>`; }

  /**************** App Control ****************/
  function restartApp(){ state = { currentStage: 0, lang: state.lang, userData: { goals: [], weak_points: {}, health_conditions: [], allergies: [] } }; started=false; progressWrap.classList.add('hidden'); sticky.classList.add('hidden'); renderStage(0); renderSummary(); }
  function notify(message,type='success'){ const el=document.createElement('div'); el.className=`fixed top-5 ${document.documentElement.dir==='rtl'?'left-5':'right-5'} p-3 rounded-lg shadow-lg text-white font-bold z-50 ${type==='error'?'bg-red-500':type==='warning'?'bg-amber-500':'bg-green-600'}`; el.textContent=message; document.body.appendChild(el); setTimeout(()=>el.remove(),3200); }

  // Theme toggle
  document.getElementById('btn-theme').onclick = ()=>{ document.documentElement.classList.toggle('dark'); };

  // Language buttons
  document.getElementById('btn-ar').onclick = ()=>{ state.lang='ar'; renderStage(state.currentStage); };
  document.getElementById('btn-en').onclick = ()=>{ state.lang='en'; renderStage(state.currentStage); };

  // Init
  window.addEventListener('load', ()=>{ renderStage(0); renderSummary(); });
  </script>
</body>
</html>
