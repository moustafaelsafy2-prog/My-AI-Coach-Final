<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>المدرب الشخصي الخبير — مصطفى الصافي</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14;             /* خلفية مريحة */
      --card:#0f1620;           /* بطاقات */
      --ink:#e7eaf0;            /* نص رئيس */
      --ink-soft:#aab1bc;       /* نص ثانوي */
      --line:#1b2430;           /* حدود */
      --brand:#7c3aed;          /* بنفسجي */
      --brand-2:#06b6d4;        /* سيان */
      --ok:#10b981;             /* نجاح */
      --warn:#f59e0b;           /* تحذير */
      --err:#ef4444;            /* خطأ */
    }
    html,body{height:100%}
    body{background:linear-gradient(180deg,var(--bg) 0%, #0c131c 100%);color:var(--ink);-webkit-font-smoothing:antialiased}
    .font-ar{font-family:"Tajawal",sans-serif}
    .font-en{font-family:"Poppins",sans-serif}
    .glass{background:rgba(15,22,32,.78);border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(8px)}
    .panel{background:var(--card);border:1px solid var(--line)}
    .btn{border:1px solid #2a3646;border-radius:1rem;padding:.8rem 1rem;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand-2));border-color:transparent;color:#fff}
    .btn-ghost{background:#0b121a}
    .chip{padding:.25rem .6rem;border-radius:.6rem;font-size:.75rem;background:#0b121a;border:1px dashed #334155;color:#93c5fd}
    .kpi{background:#0b121a;border:1px solid #223043;border-radius:.8rem;padding:.6rem}
    .prose :where(table){width:100%;border-collapse:collapse}
    .prose :where(th,td){border:1px solid #263241;padding:.6rem;vertical-align:top}
    .prose :where(th){background:#0b121a;color:#cbd5e1}
    .rtl\:text-right[dir="rtl"]{text-align:right}
    .ltr\:text-left[dir="ltr"]{text-align:left}
    .muted{color:var(--ink-soft)}
    @media print{
      .no-print, header, #controls {display:none!important}
      body{background:#fff;color:#000}
      .panel,.glass{background:#fff;border:none}
      #result{box-shadow:none;border:none}
    }
  </style>
</head>
<body class="font-ar">

  <!-- Header -->
  <header class="glass sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-600 to-cyan-500 text-white grid place-items-center font-extrabold">AI</div>
        <div class="leading-tight">
          <div class="text-xs muted">COACH</div>
          <div class="font-extrabold">Mustafa Al-Safi</div>
          <div class="text-[11px] muted">Certified International Coach</div>
        </div>
      </div>
      <div class="flex items-center gap-2 no-print">
        <button id="btn-lang-ar" class="btn btn-ghost">AR</button>
        <button id="btn-lang-en" class="btn btn-ghost">EN</button>
        <button id="btn-print" class="btn btn-primary">طباعة / Print</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-6xl mx-auto px-4 sm:px-6 mt-6">
    <div class="glass rounded-2xl p-6 relative overflow-hidden">
      <div class="absolute -top-10 -left-10 w-56 h-56 rounded-full bg-gradient-to-br from-violet-600/25 to-cyan-500/25 blur-2xl"></div>
      <div class="absolute -bottom-10 -right-10 w-56 h-56 rounded-full bg-gradient-to-br from-cyan-500/18 to-violet-600/18 blur-2xl"></div>
      <div class="relative grid lg:grid-cols-[1.1fr,.9fr] gap-6 items-center">
        <div>
          <h1 id="hero-title" class="text-3xl sm:text-4xl font-extrabold">المدرب الشخصي الخبير</h1>
          <p id="hero-sub" class="muted mt-1">خطة دقيقة 100% للتغذية والتدريب والمكملات — مصممة لتناسب أهدافك وصحتك ونمط حياتك، دون اختصار.</p>
          <p class="text-xs muted mt-2">المدرب <b>مصطفى الصافي</b> — خبير التغذية واللياقة البدنية │ مدرب دولي معتمد • <b>Powered by Mustafa Elsafy 2025</b></p>
          <div class="flex items-center gap-2 mt-4">
            <span class="chip">7 أيام تغذية كاملة</span>
            <span class="chip">7 أيام تدريب كاملة</span>
            <span class="chip">مكملات حسب الحالة</span>
            <span class="chip">صيام متقطع (اختياري)</span>
          </div>
        </div>
        <div class="panel rounded-2xl p-4">
          <div class="text-xs muted mb-2" id="kpi-title">مؤشرات سريعة</div>
          <div class="grid grid-cols-3 gap-3 text-center">
            <div class="kpi">
              <div class="text-[11px] muted">TDEE</div>
              <div id="kpi-tdee" class="font-extrabold">—</div>
            </div>
            <div class="kpi">
              <div class="text-[11px] muted">Protein</div>
              <div id="kpi-P" class="font-extrabold">—</div>
            </div>
            <div class="kpi">
              <div class="text-[11px] muted">Carbs</div>
              <div id="kpi-C" class="font-extrabold">—</div>
            </div>
          </div>
          <div class="mt-3">
            <div class="h-2 bg-[#0b121a] rounded-full overflow-hidden">
              <div id="bar" class="h-full bg-gradient-to-r from-violet-600 to-cyan-500 w-0 transition-all duration-300"></div>
            </div>
            <div class="text-[11px] muted mt-1">Step <span id="step">1</span> / 5</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Content -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 mt-6 grid lg:grid-cols-[minmax(0,1fr),380px] gap-6">
    <!-- Builder -->
    <section id="builder" class="panel rounded-2xl p-6">
      <div id="stage"></div>
      <div id="controls" class="mt-6 flex gap-2">
        <button id="btn-prev" class="btn btn-ghost flex-1">السابق</button>
        <button id="btn-next" class="btn btn-primary flex-1">التالي</button>
      </div>
    </section>

    <!-- Live summary -->
    <aside class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <div id="live-title" class="text-sm font-bold">ملخص فوري</div>
        <span id="lang-badge" class="chip">AR</span>
      </div>
      <div id="live" class="mt-3 space-y-2 text-sm"></div>
      <div class="mt-3 text-[11px] muted">* يتم استخدام الذكاء الاصطناعي لتوليد خطة شاملة قابلة للطباعة، 7 أيام كاملة بدون اختصار.</div>
    </aside>
  </main>

  <!-- Result -->
  <section id="result" class="max-w-6xl mx-auto px-4 sm:px-6 mt-6 mb-16 hidden">
    <article class="glass rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <h2 id="plan-title" class="text-2xl font-extrabold">الخطة الشاملة</h2>
        <div class="no-print flex gap-2">
          <button id="btn-again" class="btn btn-ghost">إنشاء جديد</button>
          <button id="btn-print-2" class="btn btn-primary">طباعة / حفظ</button>
        </div>
      </div>
      <div class="text-[13px] muted">تشمل التشخيص، المسموح/الممنوع، الصيام، 7 أيام تغذية بجداول كاملة، 7 أيام تدريب مفصلة حسب الشدة، مكملات، إرشادات، رسائل تحفيزية، ووحدات إضافية.</div>
      <div id="ai-html" class="prose prose-invert rtl:text-right ltr:text-left mt-4"></div>
      <div class="border-t border-slate-700 mt-6 pt-2 text-[11px] muted">
        <b>مصطفى الصافي — خبير التغذية واللياقة البدنية │ مدرب دولي معتمد</b> • <b>Powered by Mustafa Elsafy 2025</b>
      </div>
    </article>
  </section>

  <script>
    /* ======================== State & I18N ======================== */
    const el = (id)=>document.getElementById(id);
    const content = el('stage');
    const live = el('live');
    const bar = el('bar');
    const stepSpan = el('step');
    const kTDEE = el('kpi-tdee'), kP = el('kpi-P'), kC = el('kpi-C');

    const i18n = {
      ar:{
        title:'المدرب الشخصي الخبير',
        sub:'خطة دقيقة 100% للتغذية والتدريب والمكملات — مصممة لتناسب أهدافك وصحتك ونمط حياتك، دون اختصار.',
        kpi:'مؤشرات سريعة',
        live:'ملخص فوري',
        steps:['الأساسيات','الأهداف & النظام','الصحة & الحساسية','التاريخ & التركيز','إنشاء الخطة'],
        next:'التالي', prev:'السابق', submit:'إنشاء الخطة الآن',
        name:'الاسم', age:'العمر', height:'الطول (سم)', weight:'الوزن (كغ)', gender:'الجنس', male:'ذكر', female:'أنثى',
        job:'طبيعة العمل', jobVals:['مكتبي','نشاط خفيف','نشاط متوسط'],
        goals:['خسارة الدهون','بناء العضلات','زيادة القوة','تحسين التحمل','صحة عامة'],
        meals:'عدد الوجبات', diet:'النظام الغذائي', diets:['متوازن','قليل الكربوهيدرات','كيتو','البحر المتوسط','نباتي'],
        fasting:'الصيام المتقطع', enable:'تفعيل', protocol:'البروتوكول', from:'من', to:'إلى',
        health:'حالات صحية', healthVals:['ضغط الدم','السكري','مقاومة الأنسولين','الغدة الدرقية','الكبد الدهني','مشاكل هرمونية','الجهاز الهضمي'],
        allergies:'حساسيات', allergyVals:['الجلوتين','اللاكتوز','المكسرات','المأكولات البحرية','البقوليات','السكريات المصنعة','الزيوت النباتية'],
        injuries:'إصابات (إن وجدت)', exp:'خبرة المقاومة', expVals:['مبتدئ','متوسط','متقدم'],
        weak:'نقاط التركيز (اختياري)', desc:'وصف الهدف لكل منطقة (إن وُجدت)',
        error:'أكمل المعلومات المطلوبة',
        apiFail:'تعذر الاتصال بالموديل، حاول مرة أخرى.',
        building:'جاري توليد الخطة بالذكاء الاصطناعي بدون أي اختصار...'
      },
      en:{
        title:'Expert Personal Coach',
        sub:'100% precise plan for nutrition, training & supplements—tailored to your goals, health and lifestyle. No shortcuts.',
        kpi:'Quick KPIs',
        live:'Live Summary',
        steps:['Basics','Goals & Diet','Health & Allergies','History & Focus','Create Plan'],
        next:'Next', prev:'Back', submit:'Generate Plan',
        name:'Name', age:'Age', height:'Height (cm)', weight:'Weight (kg)', gender:'Gender', male:'Male', female:'Female',
        job:'Job activity', jobVals:['Desk','Light','Moderate'],
        goals:['Fat loss','Muscle gain','Strength','Endurance','General health'],
        meals:'Meals per day', diet:'Preferred diet', diets:['Balanced','Low-Carb','Keto','Mediterranean','Plant-based'],
        fasting:'Intermittent fasting', enable:'Enable', protocol:'Protocol', from:'from', to:'to',
        health:'Health conditions', healthVals:['Hypertension','Diabetes','Insulin Resistance','Thyroid','Fatty Liver','Hormonal issues','GI issues'],
        allergies:'Allergies', allergyVals:['Gluten','Lactose','Nuts','Seafood','Legumes','Added sugars','Vegetable oils'],
        injuries:'Injuries (if any)', exp:'Resistance experience', expVals:['Beginner','Intermediate','Advanced'],
        weak:'Focus points (optional)', desc:'Describe target per area (optional)',
        error:'Please complete required fields',
        apiFail:'Model unreachable. Try again.',
        building:'Generating a complete, no-shortcut plan with AI...'
      }
    };

    let lang = 'ar';
    let step = 0;
    const total = 5;

    const user = {
      name:'', age:'', height:'', weight:'', gender:'Male', job:'Desk',
      goals:[], meals:4, diet:'Balanced',
      fasting:{enabled:false, protocol:'16:8', start:'12:00', end:'20:00'},
      health:[], allergies:[], injuries:'',
      exp:'Beginner', weak_points:{},

      // مقابض تفصيل ووحدات إضافية
      detail:'max',               // minimal | standard | max
      train_days: 7,
      include:{
        grocery:true,
        micro:true,
        hydration:true,
        periodization:true,
        budget:false,
        prepGuide:true,
        cookingTips:true
      }
    };

    /* ======================== Helpers ======================== */
    const T = (k)=>i18n[lang][k];
    function setLang(l){
      lang=l;
      document.documentElement.lang=lang;
      document.documentElement.dir = lang==='ar'?'rtl':'ltr';
      document.body.classList.toggle('font-ar',lang==='ar');
      document.body.classList.toggle('font-en',lang!=='ar');
      el('hero-title').textContent=T('title');
      el('hero-sub').textContent=T('sub');
      el('kpi-title').textContent=T('kpi');
      el('live-title').textContent=T('live');
      el('lang-badge').textContent=lang.toUpperCase();
      draw(); updateLive(); updateCTA();
    }
    function f(label,id,opt={}){
      const {type='text',value='',select=null,rows=3,placeholder=''}=opt;
      if(select){
        return `<label class="block">
          <span class="text-sm">${label}</span>
          <select id="${id}" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700">
            ${select.map(o=>`<option value="${o.value}" ${String(value)===String(o.value)?'selected':''}>${o.label}</option>`).join('')}
          </select>
        </label>`;
      }
      if(type==='textarea'){
        return `<label class="block">
          <span class="text-sm">${label}</span>
          <textarea id="${id}" rows="${rows}" placeholder="${placeholder}" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700">${value||''}</textarea>
        </label>`;
      }
      return `<label class="block">
        <span class="text-sm">${label}</span>
        <input id="${id}" type="${type}" value="${value}" placeholder="${placeholder}" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700"/>
      </label>`;
    }
    function chips(name,arr,checked=[]){
      return `<div class="flex flex-wrap gap-2">${arr.map(v=>`
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-[#0b121a] border border-slate-700 cursor-pointer">
          <input type="checkbox" name="${name}" value="${v}" class="accent-violet-600" ${checked.includes(v)?'checked':''}/>
          <span class="text-sm">${v}</span>
        </label>`).join('')}</div>`;
    }

    function calc(){
      const W=+user.weight||0, H=+user.height||0, A=+user.age||0, male = user.gender==='Male';
      const BMR = male ? 10*W+6.25*H-5*A+5 : 10*W+6.25*H-5*A-161;
      const pal = user.job.match(/Desk|مكتبي/)?1.2 : user.job.match(/Moderate|متوسط/)?1.5 : 1.35;
      let TDEE = BMR*pal;
      if(user.goals.some(g=>/Fat|دهون/.test(g))) TDEE *= 0.85;
      if(user.goals.some(g=>/Muscle|عضلات/.test(g))) TDEE *= 1.10;
      const P = Math.round(2.0*(+user.weight||1));
      const F = Math.round(0.8*(+user.weight||1));
      let C = Math.round((TDEE - (P*4+F*9))/4);
      if(user.health.some(h=>/Diab|السكري|Insulin|الأنسولين/.test(h))) C = Math.min(C,120);
      C=Math.max(0,C);
      return {TDEE:Math.round(TDEE),P,F,C};
    }

    function updateKPIs(){
      const c = calc();
      kTDEE.textContent = c.TDEE;
      kP.textContent = c.P + ' g';
      kC.textContent = c.C + ' g';
    }

    function updateProgress(){
      const p = ((step+1)/total)*100;
      bar.style.width = p + '%';
      stepSpan.textContent = String(step+1);
    }

    function updateCTA(){
      el('btn-prev').textContent = T('prev');
      el('btn-next').textContent = step===total-1 ? T('submit') : T('next');
      el('btn-prev').disabled = step===0;
    }

    function updateLive(){
      updateKPIs();
      const c = calc();
      live.innerHTML = `
        <div class="text-xs muted">${T('name')}: <b class="text-slate-200">${user.name||'—'}</b></div>
        <div class="grid grid-cols-3 gap-2 text-xs">
          <div class="kpi"><div class="muted">${T('age')}</div><b>${user.age||'—'}</b></div>
          <div class="kpi"><div class="muted">${T('height')}</div><b>${user.height||'—'}</b></div>
          <div class="kpi"><div class="muted">${T('weight')}</div><b>${user.weight||'—'}</b></div>
        </div>
        <div class="text-xs muted">${lang==='ar'?'الأهداف':'Goals'}: <b class="text-slate-200">${(user.goals||[]).join('، ')||'—'}</b></div>
        <div class="text-xs muted">${T('diet')}: <b class="text-slate-200">${user.diet}</b> — ${T('meals')}: <b class="text-slate-200">${user.meals}</b></div>
        <div class="text-xs muted">${T('fasting')}: <b class="text-slate-200">${user.fasting.enabled? user.fasting.protocol+' '+user.fasting.start+'-'+user.fasting.end : '—'}</b></div>
        <div class="grid grid-cols-3 gap-2 text-xs mt-2">
          <div class="kpi"><div>السعرات</div><b>${c.TDEE} kcal</b></div>
          <div class="kpi"><div>البروتين</div><b>${c.P} g</b></div>
          <div class="kpi"><div>الكارب</div><b>${c.C} g</b></div>
        </div>
      `;
      const mods = Object.entries(user.include).filter(([k,v])=>v).map(([k])=>k).join(' • ') || '—';
      live.innerHTML += `<div class="text-[11px] muted mt-2">وحدات مفعّلة: ${mods}</div>`;
    }

    /* ======================== Stages ======================== */
    function draw(){
      updateProgress();
      if(step===0){
        content.innerHTML = `
          <h3 class="text-xl font-extrabold mb-3">${i18n[lang].steps[0]}</h3>
          <div class="grid sm:grid-cols-2 gap-4">
            ${f(T('name'),'name',{value:user.name})}
            ${f(T('gender'),'gender',{select:[
              {value:'Male',label:T('male')},{value:'Female',label:T('female')}
            ],value:user.gender})}
            ${f(T('age'),'age',{type:'number',value:user.age})}
            ${f(T('height'),'height',{type:'number',value:user.height})}
            ${f(T('weight'),'weight',{type:'number',value:user.weight})}
            ${f(T('job'),'job',{select:[
              {value: lang==='ar'?'مكتبي':'Desk', label: lang==='ar'?'مكتبي':'Desk'},
              {value: lang==='ar'?'نشاط خفيف':'Light', label: lang==='ar'?'نشاط خفيف':'Light'},
              {value: lang==='ar'?'نشاط متوسط':'Moderate', label: lang==='ar'?'نشاط متوسط':'Moderate'},
            ], value: user.job})}
          </div>

          <div class="grid sm:grid-cols-3 gap-4 mt-3">
            <label class="block">
              <span class="text-sm">مستوى التفصيل</span>
              <select id="detail" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700">
                <option value="minimal">مختصر</option>
                <option value="standard">قياسي</option>
                <option value="max" selected>موسع</option>
              </select>
            </label>
            <label class="block">
              <span class="text-sm">أيام التدريب/أسبوع</span>
              <select id="train_days" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700">
                <option>3</option><option>4</option><option>5</option><option selected>7</option>
              </select>
            </label>
            <div class="rounded-xl p-3 bg-[#0b121a] border border-slate-700">
              <div class="text-sm mb-2">وحدات إضافية</div>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <label class="inline-flex items-center gap-2"><input id="inc_grocery" type="checkbox" class="accent-violet-600" checked/>قائمة المشتريات</label>
                <label class="inline-flex items-center gap-2"><input id="inc_micro" type="checkbox" class="accent-violet-600" checked/>المغذيات الدقيقة</label>
                <label class="inline-flex items-center gap-2"><input id="inc_hyd" type="checkbox" class="accent-violet-600" checked/>السوائل</label>
                <label class="inline-flex items-center gap-2"><input id="inc_period" type="checkbox" class="accent-violet-600" checked/>تصعيد 4 أسابيع</label>
                <label class="inline-flex items-center gap-2"><input id="inc_budget" type="checkbox" class="accent-violet-600"/>بدائل اقتصادية</label>
                <label class="inline-flex items-center gap-2"><input id="inc_prep" type="checkbox" class="accent-violet-600" checked/>دليل التحضير</label>
                <label class="inline-flex items-center gap-2"><input id="inc_cook" type="checkbox" class="accent-violet-600" checked/>نصائح طبخ</label>
              </div>
            </div>
          </div>
        `;
      }
      else if(step===1){
        content.innerHTML = `
          <h3 class="text-xl font-extrabold mb-3">${i18n[lang].steps[1]}</h3>
          <div class="space-y-4">
            <div>
              <div class="text-sm mb-1">${lang==='ar'?'الأهداف':'Goals'}</div>
              ${chips('goal', i18n[lang].goals, user.goals)}
            </div>
            <div class="grid sm:grid-cols-3 gap-4">
              ${f(T('meals'),'meals',{select:[{value:3,label:'3'},{value:4,label:'4'},{value:5,label:'5'},{value:6,label:'6'}],value:user.meals})}
              ${f(T('diet'),'diet',{select:i18n[lang].diets.map(d=>({value: (lang==='ar'? (d==='متوازن'?'Balanced':d==='قليل الكربوهيدرات'?'Low-Carb':d==='البحر المتوسط'?'Mediterranean':d==='نباتي'?'Plant-based':'Keto') : d), label:d})),value:user.diet})}
            </div>
            <div class="rounded-xl p-3 bg-[#0b121a] border border-slate-700">
              <label class="inline-flex items-center gap-2">
                <input id="fasting_enabled" type="checkbox" class="accent-violet-600" ${user.fasting.enabled?'checked':''}/>
                <span>${T('fasting')} — ${T('enable')}</span>
              </label>
              <div class="grid sm:grid-cols-3 gap-3 mt-2">
                ${f(T('protocol'),'fasting_protocol',{select:['14:10','16:8','18:6','20:4'].map(x=>({value:x,label:x})),value:user.fasting.protocol})}
                <label><span class="text-sm">${T('from')}</span><input id="fasting_start" type="time" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700" value="${user.fasting.start}"/></label>
                <label><span class="text-sm">${T('to')}</span><input id="fasting_end" type="time" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700" value="${user.fasting.end}"/></label>
              </div>
            </div>
          </div>`;
      }
      else if(step===2){
        content.innerHTML = `
          <h3 class="text-xl font-extrabold mb-3">${i18n[lang].steps[2]}</h3>
          <div class="space-y-4">
            <div>
              <div class="text-sm mb-1">${T('health')}</div>
              ${chips('health', i18n[lang].healthVals, user.health)}
            </div>
            <div>
              <div class="text-sm mb-1">${T('allergies')}</div>
              ${chips('all', i18n[lang].allergyVals, user.allergies)}
            </div>
            ${f(T('injuries'),'injuries',{type:'textarea',rows:3,value:user.injuries})}
          </div>`;
      }
      else if(step===3){
        content.innerHTML = `
          <h3 class="text-xl font-extrabold mb-3">${i18n[lang].steps[3]}</h3>
          <div class="grid sm:grid-cols-3 gap-4">
            ${f(T('exp'),'exp',{select:i18n[lang].expVals.map(x=>({value: x==='مبتدئ'?'Beginner':x==='متوسط'?'Intermediate':x==='متقدم'?'Advanced':x,label:x})),value:user.exp})}
            <label class="block col-span-2">
              <span class="text-sm">${T('weak')}</span>
              <input id="weak_raw" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700" placeholder="${T('desc')}" value="${Object.keys(user.weak_points||{}).length? Object.entries(user.weak_points).map(([k,v])=>`${k}:${v}`).join('; '):''}">
            </label>
          </div>`;
      }
      else{
        content.innerHTML = `
          <div class="text-center py-8">
            <div class="text-sm muted mb-2">${T('building')}</div>
            <div class="w-12 h-12 rounded-full border-4 border-violet-600 border-t-transparent animate-spin mx-auto"></div>
          </div>`;
      }
    }

    function saveStep(){
      try{
        if(step===0){
          user.name = el('name').value.trim();
          user.gender = el('gender').value;
          user.age = +el('age').value;
          user.height = +el('height').value;
          user.weight = +el('weight').value;
          user.job = el('job').value;

          user.detail = el('detail').value;
          user.train_days = +el('train_days').value;
          user.include = {
            grocery: el('inc_grocery').checked,
            micro: el('inc_micro').checked,
            hydration: el('inc_hyd').checked,
            periodization: el('inc_period').checked,
            budget: el('inc_budget').checked,
            prepGuide: el('inc_prep').checked,
            cookingTips: el('inc_cook').checked
          };

          if(!user.name||!user.age||!user.height||!user.weight) throw 0;
        } else if(step===1){
          user.goals = [...document.querySelectorAll('input[name="goal"]:checked')].map(e=>e.value);
          user.meals = +el('meals').value;
          user.diet = el('diet').value;
          user.fasting.enabled = el('fasting_enabled').checked;
          user.fasting.protocol = el('fasting_protocol').value;
          user.fasting.start = el('fasting_start').value;
          user.fasting.end = el('fasting_end').value;
          if(!user.goals.length) throw 0;
        } else if(step===2){
          user.health = [...document.querySelectorAll('input[name="health"]:checked')].map(e=>e.value);
          user.allergies = [...document.querySelectorAll('input[name="all"]:checked')].map(e=>e.value);
          user.injuries = el('injuries').value || '';
        } else if(step===3){
          user.exp = el('exp').value;
          const weak_raw = el('weak_raw').value.trim();
          user.weak_points = {};
          if(weak_raw){
            weak_raw.split(';').forEach(pair=>{
              const [k,...rest]=pair.split(':'); const v=rest.join(':').trim(); if(k&&v) user.weak_points[k.trim()] = v;
            });
          }
        }
        updateLive();
        return true;
      }catch{
        toast(T('error'),'err'); return false;
      }
    }

    /* ======================== AI PROMPT (مُوسع + بدون اختصار) ======================== */
    function buildPrompt(){
      const c = calc();
      const langTag = lang.toUpperCase();
      const meals = user.meals;
      const detail = user.detail;        // minimal | standard | max
      const trainDays = user.train_days;
      const inc = user.include;

      const DETAIL_RULES = {
        minimal: {
          mealLines: '• سطرين لكل وجبة (الاسم + المكونات والجرامات).',
          trainingLines: '• 3 تمارين لكل يوم تدريب.',
          explainDepth: 'مختصر وواضح.'
        },
        standard: {
          mealLines: '• 4–5 أسطر لكل وجبة، تتضمن بدائل وأسباب الاختيار.',
          trainingLines: '• 4–5 تمارين/يوم مع Tempo/Rest/RIR.',
          explainDepth: 'متوسط مع أمثلة.'
        },
        max: {
          mealLines: '• 6–8 أسطر لكل وجبة، تشمل بدائل متاحة، سبب الاختيار، وطريقة التحضير بسرعة.',
          trainingLines: '• 5–7 تمارين/يوم + Tempo + RIR + ملاحظات فنية/وقائية مُفصلة.',
          explainDepth: 'مفصل للغاية مع أمثلة وتبرير علمي مختصر.'
        }
      }[detail];

      const OPTIONAL_BLOCKS = `
${inc.grocery ? '- **قائمة المشتريات الأسبوعية** منظمة حسب الأقسام (بروتين، كارب، دهون، خضار/فاكهة، توابل، مستلزمات التحضير) مع كميات تقريبية ووِحدة قياس.' : ''}
${inc.micro ? '- **أهداف المغذيات الدقيقة**: صوديوم ≤ 2000mg، بوتاسيوم ≥ 3000mg، كالسيوم 1000mg، ماغنسيوم 400mg، ألياف ${Math.max(25, Math.round(c.C*0.08))}g، أوميغا-3 ≥ 1g، Vit-D 800–2000 IU. عدّل حسب الحالة.' : ''}
${inc.hydration ? '- **خطة السوائل**: ماء 30–40ml/‏kg، توزيع على اليوم، وما قبل/أثناء/بعد التمرين، مع بدائل خالية من السكر.' : ''}
${inc.periodization ? '- **تصعيد تدريبي (4 أسابيع)**: الأسبوع 1 أساس، 2 تعزيز، 3 ذروة، 4 تخفيف؛ نسب أحمال مقترحة ونطاقات RIR لكل أسبوع.' : ''}
${inc.budget ? '- **نسخ اقتصادية**: بدائل منخفضة التكلفة لكل مكوّن مع الحفاظ على الماكروز.' : ''}
${inc.prepGuide ? '- **دليل التحضير الأسبوعي**: Batch cooking، أوزان قياسية، حفظ/تجميد، إعادة تسخين آمن، وتخطيط يوم التسوق.' : ''}
${inc.cookingTips ? '- **نصائح طبخ صحية**: تقليل الدهون المضافة، تتبيلات منخفضة الصوديوم، طرق شواء/طبخ بالبخار/هوائي.' : ''}
`.trim();

      return `
Act as **Coach Mustafa Al-Safi**, a world-class nutrition & fitness expert. Output language: **${langTag}**.
Use **Arabic** for prose and food names; use **English exercise names** followed by a brief Arabic note. **Never use placeholders or generic "N/A". No shortcuts.**

### Client Data
- Name: ${user.name}
- Age/Height/Weight/Gender: ${user.age} / ${user.height} cm / ${user.weight} kg / ${user.gender}
- Job activity: ${user.job}
- Goals: ${(user.goals||[]).join(', ')}
- Diet: ${user.diet} • Meals/day: ${meals}
- Fasting: ${user.fasting.enabled? (user.fasting.protocol+' '+user.fasting.start+'-'+user.fasting.end):'Disabled'}
- Health conditions: ${(user.health||[]).join(', ')||'None'}
- Allergies: ${(user.allergies||[]).join(', ')||'None'}
- Injuries: ${user.injuries||'None'}
- Training experience: ${user.exp}
- Weak points: ${Object.entries(user.weak_points||{}).map(([k,v])=>`${k}:${v}`).join(', ')||'None'}

### Strict Daily Targets (must match ±1% EVERY day)
- Calories: **${c.TDEE} kcal**
- Macros: **Protein ${c.P} g • Fat ${c.F} g • Carbs ${c.C} g**

### REQUIRED STRUCTURE (All 10 sections are mandatory. 7 FULL different days. No merging, no summarizing.)
1) ## مقدمة وتشخيص الحالة (${DETAIL_RULES.explainDepth})
   - الحالة، الهدف النهائي، مؤشرات قياس أسبوعية (وزن/محيط/قوة/راحة نوم/طاقة)، المخاطر، كيف نعالج القيود الصحية والحساسيات.
2) ## قائمة المسموح والممنوع
   - حسب نظام "${user.diet}" والحساسيات. قوائم نقطية تفصيلية للأطعمة/المشروبات/التتبيلات.
3) ## بروتوكول الصيام المتقطع ${user.fasting.enabled?'(مُفعّل)':'(اختياري)'}
   - بروتوكول ${user.fasting.enabled? user.fasting.protocol : 'مقترح 16:8'}، نافذة الطعام ${user.fasting.start}–${user.fasting.end} (قابلة للتعديل).
   - ما يُكسر به الصيام، مشروبات مسموحة، أخطاء شائعة، تحذيرات مرتبطة بـ (${(user.health||[]).join(', ')||'لا توجد'}).
4) ## خطة التغذية (7 أيام كاملة ومختلفة)
   - **لكل يوم** جدول Markdown بالأعمدة التالية (لا تغيّر أسماء الأعمدة):
     | Meal # | الوجبة | المكونات (بالجرام/الوحدة) | Protein (g) | Fat (g) | Carbs (g) | Calories |
     |---:|---|---|---:|---:|---:|---:|
     ${DETAIL_RULES.mealLines}
   - بعد الجدول: **الإجمالي اليومي** بصيغة: **Total → P:__ F:__ C:__ Kcal:__** ويجب أن يطابق الهدف (±1%).
   - ضع كلمة **[Swap]** بعد اسم كل وجبة لتسهيل الاستبدال.
5) ## خطة التدريب (${trainDays} أيام) — مستوى ${user.exp}
   - **لكل يوم** جدول Markdown بالأعمدة:
     | اليوم | Exercise (EN) | Notes (AR) | Sets | Reps | Tempo | Rest (s) | RIR |
     |---|---|---|---:|---:|---|---:|---:|
     ${DETAIL_RULES.trainingLines}
   - شدّة اليوم يجب أن تعكس الخبرة: ${user.exp}. تجنّب ما يُفاقم الإصابات: ${user.injuries||'None'}.
   - ركّز على: ${Object.entries(user.weak_points||{}).map(([k,v])=>`${k}:${v}`).join(', ')||'None'}.
6) ## المكملات والتعافي (أساسي + مرتبط بالحالة الصحية)
   - جدولان منسَّقان:
     - **أساسي**: Whey/Casein, Creatine, Omega-3, Vitamin D, Magnesium, Electrolytes (جرعات، توقيت، أيام الراحة/التمرين).
     - **مرتبط بالحالة**: مكملات مخصّصة لـ (${(user.health||[]).join(', ')||'لا توجد حالة'}) مع الجرعات والتحذيرات والتداخلات الدوائية إن لزم.
7) ## إرشادات النجاح والمتابعة
   - تعديل السعرات (±150 kcal) وفق التقدّم كل 7–14 يوم، خطوات/نوم/ماء/توتر، وكيفية تعديل الكارب للسكري/الأنسولين.
8) ## رسائل تحفيزية يومية
   - 7 رسائل قصيرة عملية (يوم 1 → يوم 7)، بدون عبارات عامة.
9) ## وحدات إضافية (إن وُجدت)
${OPTIONAL_BLOCKS || '- (لا وحدات إضافية مختارة)'}
10) ## توقيع المدرب والحقوق
   - **مصطفى الصافي — خبير التغذية واللياقة البدنية │ مدرب دولي معتمد**
   - **Powered by Mustafa Elsafy 2025**

### VALIDATION RULES (critical)
- 7 أيام تغذية و7 أيام تدريب **كاملة ومختلفة** — يُمنع الدمج أو الاكتفاء بنموذج يوم واحد.
- لا تغيّر عناوين الجداول وأسماء الأعمدة.
- كل يوم تغذية: إجمالي P/F/C/Kcal يجب أن يطابق الهدف اليومي ضمن ±1%.
- لا تستخدم أطعمة ضمن الحساسية. راعِ القيود الصحية بدقة.
- لا تكتب "N/A" أو أمثلة شكلية — محتوى عملي قابل للتطبيق فورًا.
`.trim();
    }

    /* ======================== AI CALL + Render ======================== */
    async function generatePlan(){
      el('result').classList.remove('hidden');
      el('ai-html').innerHTML = `
        <div class="text-center py-10">
          <div class="w-12 h-12 rounded-full border-4 border-violet-600 border-t-transparent animate-spin mx-auto"></div>
          <div class="mt-3">${T('building')}</div>
        </div>`;

      try{
        const prompt = buildPrompt();
        const res = await fetch('/.netlify/functions/gemini-proxy',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({prompt})
        });
        const text = await res.text();
        if(!res.ok) throw new Error(text||'Server error');

        let md = text;
        try{ const j = JSON.parse(text); if(j && j.text) md = j.text; }catch{}
        renderAI(md);
        scrollToResult();
      }catch(e){
        el('ai-html').innerHTML = `
          <div class="rounded-xl p-4 border border-[color:var(--err)]/40 bg-red-500/10" style="color:#fecaca">
            <div class="font-bold mb-1">${T('apiFail')}</div>
            <div class="text-xs opacity-80">${String(e).slice(0,500)}</div>
          </div>`;
      }
    }

    function renderAI(markdown){
      // إدراج مرساة للعناوين + فهرس
      const withAnchors = markdown.replace(/^#{2,3}\s+(.*)$/gm, (m,h)=> {
        const id = h.trim().toLowerCase().replace(/[^\w\u0600-\u06FF]+/g,'-');
        return `${m}\n[⬆︎](#top)\n<a id="${id}"></a>`;
      });

      let html = marked.parse(withAnchors);
      const planEl = document.getElementById('ai-html');
      planEl.innerHTML = `<div id="top"></div>` + html;

      // تدقيق وجود الأقسام الرئيسية
      const must = ['مقدمة','المسموح','الصيام','خطة التغذية','خطة التدريب','المكملات','إرشادات','رسائل','توقيع'];
      const text = planEl.innerText;
      const missing = must.filter(k => !new RegExp(k,'i').test(text));
      if(missing.length){
        const warn = document.createElement('div');
        warn.className = 'rounded-xl p-3 border border-amber-500/40 bg-amber-500/10 text-amber-200 mt-3';
        warn.innerHTML = `<b>تحذير جودة:</b> أقسام ناقصة: ${missing.join('، ')}`;
        planEl.prepend(warn);
      }

      // تلوين الجداول وتحسين القراءة
      planEl.querySelectorAll('table').forEach(t=>{
        t.classList.add('w-full','text-sm');
        t.querySelectorAll('th').forEach(th=>th.classList.add('bg-[#0b121a]'));
      });

      el('btn-print').classList.remove('hidden');
      el('btn-print-2').classList.remove('hidden');
    }

    function scrollToResult(){
      el('result').scrollIntoView({behavior:'smooth',block:'start'});
    }

    /* ======================== Events ======================== */
    el('btn-prev').onclick = ()=>{
      if(step>0){ step--; draw(); updateCTA(); }
    };
    el('btn-next').onclick = async ()=>{
      if(step<total-1){
        if(!saveStep()) return;
        step++; draw(); updateCTA();
        if(step===total-1){ if(!saveStep()) return; await generatePlan(); }
      }
    };
    el('btn-again').onclick = ()=>{ location.reload(); };
    el('btn-print').onclick = ()=>window.print();
    el('btn-print-2').onclick = ()=>window.print();

    el('btn-lang-ar').onclick=()=>setLang('ar');
    el('btn-lang-en').onclick=()=>setLang('en');

    function toast(msg,kind='ok'){
      const box=document.createElement('div');
      box.className=`fixed top-5 ${lang==='ar'?'right-5':'left-5'} z-50 px-3 py-2 rounded-xl text-sm text-white ${kind==='err'?'bg-red-600':'bg-emerald-600'}`;
      box.textContent=msg; document.body.appendChild(box);
      setTimeout(()=>box.remove(),2200);
    }

    /* ======================== Init ======================== */
    setLang('ar');
    draw(); updateLive(); updateCTA();
  </script>
</body>
</html>
