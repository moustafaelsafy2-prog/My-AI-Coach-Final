<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ± â€” Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ</title>

  <!-- Tailwind + Marked -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Theme -->
  <style>
    :root{
      --bg:#f8fafc; --surface:#ffffff; --border:#e5e7eb;
      --text:#0f172a; --muted:#475569;
      --primary:#1d4ed8; --primary-700:#1e40af;
    }
    html,body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .font-tajawal{font-family:'Tajawal',sans-serif}
    .font-poppins{font-family:'Poppins',sans-serif}
    .card{background:var(--surface);border:1px solid var(--border);box-shadow:0 6px 18px rgba(2,6,23,.06)}
    .btn{border:1px solid var(--border);padding:.6rem .9rem;border-radius:.6rem}
    .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn-primary:hover{background:var(--primary-700)}
    .btn-ghost{background:#e2e8f0}
    header{background:linear-gradient(90deg,rgba(29,78,216,.08),rgba(16,185,129,.08))}
    .badge{padding:.2rem .5rem;border-radius:.45rem;font-size:.75rem;border:1px solid}
    .ok{color:#065f46;background:#ecfdf5;border-color:#a7f3d0}
    .warn{color:#92400e;background:#fffbeb;border-color:#fde68a}
    .err{color:#991b1b;background:#fef2f2;border-color:#fecaca}
    .ai-prose table{width:100%;border-collapse:collapse;margin:12px 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .ai-prose th,.ai-prose td{border:1px solid #e5e7eb;padding:.65rem;vertical-align:top}
    .ai-prose th{background:#f8fafc;font-weight:700}
    @media print{
      header,#sticky,.no-print{display:none!important}
      body{background:#fff}
      #app{box-shadow:none;border:none;max-width:100%;margin:0}
      .page-break{page-break-before:always}
    }
  </style>
</head>

<body class="font-tajawal min-h-screen">
  <!-- Topbar -->
  <header class="px-4 sm:px-6 py-3 flex items-center justify-between border-b">
    <div class="leading-tight">
      <div class="text-xs text-slate-600">COACH</div>
      <div class="font-extrabold">Mustafa Al-Safi</div>
      <div class="text-xs text-slate-500">Certified International Coach</div>
    </div>
    <div class="flex items-center gap-2">
      <button id="cmd-print" class="btn no-print" type="button">Ø·Ø¨Ø§Ø¹Ø© PDF</button>
      <button id="btn-en" class="btn" type="button">EN</button>
      <button id="btn-ar" class="btn" type="button">Ø¹Ø±Ø¨ÙŠ</button>
    </div>
  </header>

  <!-- Shell -->
  <div id="app" class="max-w-4xl mx-auto my-5 sm:my-10 card rounded-2xl overflow-hidden">
    <!-- Hero -->
    <div class="p-6 sm:p-8">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-center">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±</h1>
      <p class="text-sm text-slate-600 text-center mt-1">
        Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© 100% Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ø£Ù‡Ø¯Ø§ÙÙƒ ÙˆØµØ­ØªÙƒ ÙˆÙ†Ù…Ø· Ø­ÙŠØ§ØªÙƒ.
      </p>
      <p class="text-xs text-slate-500 text-center mt-1">
        Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯ â€¢ Powered by Mustafa Elsafy 2025
      </p>

      <div class="grid sm:grid-cols-3 gap-3 mt-5">
        <div class="card p-3">
          <div class="text-xs text-slate-600 mb-1">Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</div>
          <div class="text-sm">Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© | Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯</div>
          <div class="text-xs text-slate-500 mt-1">Powered by Mustafa Elsafy 2025</div>
        </div>
        <div class="card p-3">
          <div class="text-xs text-slate-600 mb-1">Ø¬ÙˆØ¯Ø© Ø§Ù„Ø®Ø·Ø©</div>
          <div class="flex items-center gap-2">
            <span id="badgeDays" class="badge warn">0/7</span>
            <span id="badgeMacros" class="badge warn">Â±2% 0/7</span>
          </div>
        </div>
        <div class="card p-3">
          <div class="text-xs text-slate-600 mb-1">Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙ‚Ø¯Ù…</div>
          <div class="h-2.5 bg-gray-200 rounded-full overflow-hidden">
            <div id="progress" class="h-full bg-gradient-to-r from-indigo-500 to-blue-500 transition-all duration-300" style="width:0%"></div>
          </div>
          <div class="mt-2 text-xs text-gray-500">Ø§Ù„Ø®Ø·ÙˆØ© <span id="step">0</span> Ù…Ù† 12</div>
        </div>
      </div>
    </div>

    <!-- Dynamic content -->
    <main id="content" class="p-5 sm:p-8"></main>

    <!-- Sticky nav -->
    <div id="sticky" class="sticky bottom-0 bg-white/80 backdrop-blur-md border-t px-4 sm:px-6 py-3 flex gap-3 justify-between">
      <button id="prev" class="btn btn-ghost w-1/3 sm:w-40" type="button">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button id="next" class="btn btn-primary flex-1" type="button">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
  </div>

  <!-- App -->
  <script>
  /* ---------- STATE ---------- */
  const TOTAL = 12;
  const content = document.getElementById('content');
  const progressBar = document.getElementById('progress');
  const stepEl = document.getElementById('step');
  const badgeDays = document.getElementById('badgeDays');
  const badgeMacros = document.getElementById('badgeMacros');
  const btnPrev = document.getElementById('prev');
  const btnNext = document.getElementById('next');
  const btnAr = document.getElementById('btn-ar');
  const btnEn = document.getElementById('btn-en');

  let state = {
    lang: 'ar',
    step: 0,
    user: {
      name: '',
      age: null, height: null, weight: null, gender: 'Male',
      goals: [], target_weight: null, target_date: null,
      diet_preference: 'Balanced / Ù…ØªÙˆØ§Ø²Ù†',
      meals_per_day: 4,
      fasting: { enabled: false, protocol: '16:8', start: '12:00', end: '20:00' },
      allergies: [], other_allergies: '',
      last_train: '', training_exp: 'Ù…Ø¨ØªØ¯Ø¦',
      weak_points: {}, health_conditions: [], injuries: '',
      job_activity: 'Ù…ÙƒØªØ¨ÙŠ', sleep_hours: null, stress_level: 'Ù…ØªÙˆØ³Ø·',
      steps_target: 9000,
      has_photos: false, has_inbody: false
    },
    calc: { tdee: 0, P: 0, F: 0, C: 0, pal: 1.35 }
  };

  /* ---------- I18N ---------- */
  const I = {
    ar: {
      start:"Ø§Ø¨Ø¯Ø£", next:"Ø§Ù„ØªØ§Ù„ÙŠ", prev:"Ø§Ù„Ø³Ø§Ø¨Ù‚", submit:"Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†!",
      welcome_title:"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!", welcome_desc:"Ø³Ø£ØµÙ…Ù… Ù„Ùƒ Ø®Ø·Ø© Ù…ÙƒØªÙ…Ù„Ø© Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª.",
      name_q:"Ø§Ù„Ø§Ø³Ù…", age:"Ø§Ù„Ø¹Ù…Ø±", height:"Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)", weight:"Ø§Ù„ÙˆØ²Ù† (ÙƒØº)", gender:"Ø§Ù„Ø¬Ù†Ø³", male:"Ø°ÙƒØ±", female:"Ø£Ù†Ø«Ù‰",
      stage_1:"Ù…Ù† Ø£Ù†ØªØŸ", stage_2:"Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©", stage_3:"Ø§Ù„Ø£Ù‡Ø¯Ø§Ù", stage_4:"Ù‡Ø¯Ù Ù…ØªÙ‚Ø¯Ù…", stage_5:"Ù†Ø¸Ø§Ù…Ùƒ Ø§Ù„Ù…ÙØ¶Ù„",
      stage_6:"Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©", stage_7:"ØªØ§Ø±ÙŠØ® Ø±ÙŠØ§Ø¶ÙŠ", stage_8:"Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ±ÙƒÙŠØ²", stage_9:"Ø§Ù„ØµØ­Ø©", stage_10:"Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©", stage_11:"Ù…Ù„ÙØ§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©",
      api_error:"ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ø£Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­."
    },
    en: {
      start:"Start", next:"Next", prev:"Back", submit:"Generate Plan",
      welcome_title:"Welcome!", welcome_desc:"I'll craft a complete plan for nutrition, training and supplements.",
      name_q:"Name", age:"Age", height:"Height (cm)", weight:"Weight (kg)", gender:"Gender", male:"Male", female:"Female",
      stage_1:"Who are you?", stage_2:"Basics", stage_3:"Goals", stage_4:"Advanced target", stage_5:"Diet style",
      stage_6:"Allergies", stage_7:"Training history", stage_8:"Focus areas", stage_9:"Health", stage_10:"Lifestyle", stage_11:"Optional files",
      api_error:"Cannot reach model. Check function or key."
    }
  };
  function t(k){return I[state.lang][k]||k}
  function setLang(l){
    state.lang=l; document.documentElement.lang=l; document.documentElement.dir=l==='ar'?'rtl':'ltr';
    document.body.classList.toggle('font-tajawal',l==='ar'); document.body.classList.toggle('font-poppins',l!=='ar');
    btnEn.className='btn '+(l==='en'?'btn-primary':''); btnAr.className='btn '+(l==='ar'?'btn-primary':'');
    updateCTA();
  }
  btnAr.onclick=()=>setLang('ar'); btnEn.onclick=()=>setLang('en');
  document.getElementById('cmd-print').onclick=()=>window.print();

  /* ---------- RENDER UTILS ---------- */
  function updateProgress(){ const p=Math.max(0,((state.step-1)/TOTAL)*100); progressBar.style.width=p+'%'; stepEl.textContent=String(Math.min(state.step,TOTAL)); }
  function updateCTA(){ btnPrev.textContent=t('prev'); btnNext.textContent = state.step===TOTAL ? t('submit') : t('next'); btnPrev.disabled=state.step<=1; }
  function field(label,id,opt={}){ const {type='text',value='',required=false,select=null,placeholder='',num=false}=opt;
    if(select) return `<label class="block"><span class="font-medium">${label}</span><select id="${id}" class="mt-1 w-full p-3 border rounded-lg">${select.map(o=>`<option ${String(value)===String(o.value)?'selected':''} value="${o.value}">${o.label}</option>`).join('')}</select></label>`;
    if(type==='textarea') return `<label class="block"><span class="font-medium">${label}</span><textarea id="${id}" rows="3" placeholder="${placeholder}" class="mt-1 w-full p-3 border rounded-lg">${value||''}</textarea></label>`;
    return `<label class="block"><span class="font-medium">${label}</span><input id="${id}" type="${type}" ${required?'required':''} value="${value}" placeholder="${placeholder}" ${num?'inputmode="numeric" pattern="[0-9]*"':''} class="mt-1 w-full p-3 border rounded-lg"></label>`;
  }
  function stage(title,desc,inner){ return `<section><h2 class="text-2xl sm:text-3xl font-extrabold">${title}</h2><p class="mt-1 text-slate-600">${desc||''}</p><form class="space-y-5 mt-6" onsubmit="event.preventDefault();">${inner}</form></section>` }

  /* ---------- STAGES ---------- */
  function render(){
    updateProgress(); updateCTA();
    const s = state.user; let html='';
    switch(state.step){
      case 0:
        content.innerHTML=`<section class="text-center p-10"><h2 class="text-3xl font-extrabold mb-2">${t('welcome_title')}</h2><p class="text-slate-600">${t('welcome_desc')}</p><div class="mt-6 inline-flex items-center gap-2"><select id="lang-select" class="p-3 border rounded"><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option></select><button id="start" class="btn btn-primary">${t('start')}</button></div></section>`;
        document.getElementById('start').onclick=()=>{ setLang(document.getElementById('lang-select').value); state.step=1; render(); }; break;

      case 1:
        html = field(t('name_q'),'name',{required:true,value:s.name||''});
        content.innerHTML=stage(t('stage_1'),' ',html); break;

      case 2:
        html = `<div class="grid sm:grid-cols-2 gap-4">
          ${field(t('age'),'age',{type:'number',num:true,value:s.age||'',required:true})}
          ${field(t('height'),'height',{type:'number',num:true,value:s.height||'',required:true})}
          ${field(t('weight'),'weight',{type:'number',num:true,value:s.weight||'',required:true})}
          ${field(t('gender'),'gender',{select:[{value:'Male',label:t('male')},{value:'Female',label:t('female')}],value:s.gender||'Male'})}
        </div>`;
        content.innerHTML=stage(t('stage_2'),' ',html); break;

      case 3:
        const goals = (state.lang==='ar')? ['Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†','Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª','Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©','ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„','ØµØ­Ø© Ø¹Ø§Ù…Ø©'] : ['Fat loss','Muscle gain','Strength','Endurance','General health'];
        html = `<div class="grid sm:grid-cols-2 gap-2">${goals.map(g=>`<label class="p-3 border rounded cursor-pointer"><input type="checkbox" name="goal" value="${g}" class="mr-2 accent-indigo-600"> ${g}</label>`).join('')}</div>`;
        content.innerHTML=stage(t('stage_3'),' ',html); break;

      case 4:
        html = `<div class="grid sm:grid-cols-2 gap-4">
          ${field('Target weight / Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù','target_weight',{type:'number',num:true,value:s.target_weight||''})}
          ${field('Target date / ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¯Ù','target_date',{type:'date',value:s.target_date||''})}
        </div>`;
        content.innerHTML=stage(t('stage_4'),' ',html); break;

      case 5: {
        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… + Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª + Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹
        const ds = [
          'Balanced / Ù…ØªÙˆØ§Ø²Ù†','Low-Carb / Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª','IF / ØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹',
          'Keto / ÙƒÙŠØªÙˆ','Mediterranean / Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·','Plant-based / Ù†Ø¨Ø§ØªÙŠ'
        ];
        const showFasting = (s.goals||[]).some(g => /Ø®Ø³Ø§Ø±Ø©|Fat/i.test(g)) ||
                            (s.health_conditions||[]).some(h => /Ø³ÙƒØ±ÙŠ|Insulin|Diab/i.test(h)) ||
                            /IF|ØµÙŠØ§Ù…/.test(s.diet_preference);

        const fastingBlock = `
          <div id="fasting-wrap" class="${showFasting?'':'hidden'} grid sm:grid-cols-3 gap-3 mt-2 border p-3 rounded">
            <label class="flex items-center gap-2">
              <input id="fasting_enabled" type="checkbox" class="accent-indigo-600" ${s.fasting?.enabled?'checked':''}>
              <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹</span>
            </label>
            <label>
              <span class="text-sm text-slate-600">Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</span>
              <select id="fasting_protocol" class="mt-1 w-full p-2 border rounded">
                ${['14:10','16:8','18:6'].map(p=>`<option ${s.fasting?.protocol===p?'selected':''}>${p}</option>`).join('')}
              </select>
            </label>
            <div class="grid grid-cols-2 gap-2">
              <label><span class="text-sm text-slate-600">Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙƒÙ„ Ù…Ù†</span>
                <input id="fasting_start" type="time" value="${s.fasting?.start||'12:00'}" class="mt-1 w-full p-2 border rounded">
              </label>
              <label><span class="text-sm text-slate-600">Ø¥Ù„Ù‰</span>
                <input id="fasting_end" type="time" value="${s.fasting?.end||'20:00'}" class="mt-1 w-full p-2 border rounded">
              </label>
            </div>
            <p class="sm:col-span-3 text-xs text-slate-500">* Ù„Ø§ ØªÙØªÙÙ†Ø§ÙˆÙ„ Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø©. Ø§Ù„Ù…Ø§Ø¡/Ø§Ù„Ù‚Ù‡ÙˆØ© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡/Ø§Ù„Ø´Ø§ÙŠ Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ± Ù…Ø³Ù…ÙˆØ­. Ø£Ø¶Ù Ø¥Ù„ÙƒØªØ±ÙˆÙ„Ø§ÙŠØª Ø¹Ù†Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ØµØ¨Ø§Ø­Ù‹Ø§.</p>
          </div>`;

        const mealsSelect = `
          <label class="block">
            <span class="font-medium">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª/Ø§Ù„ÙŠÙˆÙ…</span>
            <select id="meals_per_day" class="mt-1 w-full p-3 border rounded">
              ${[3,4,5,6].map(n=>`<option ${Number(s.meals_per_day)===n?'selected':''} value="${n}">${n}</option>`).join('')}
            </select>
          </label>`;

        const html5 = `
          ${field(t('stage_5'),'diet_preference',{select:ds.map(x=>({value:x,label:x})), value:s.diet_preference||ds[0]})}
          ${mealsSelect}
          ${fastingBlock}`;

        content.innerHTML = stage(t('stage_5'),'Ø§Ø®ØªØ± Ù†Ø¸Ø§Ù…ÙƒØŒ Ø­Ø¯Ù‘Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§ØªØŒ ÙˆÙØ¹Ù‘Ù„ Ø§Ù„ØµÙŠØ§Ù… Ø¥Ù† ÙƒØ§Ù† Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹.', html5);

        setTimeout(()=>{
          const dp = document.getElementById('diet_preference');
          dp?.addEventListener('change',()=>document.getElementById('fasting-wrap')?.classList.toggle('hidden', !/IF|ØµÙŠØ§Ù…/.test(dp.value)));
        },0);
        break;
      }

      case 6:
        const al = ['Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†','Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²','Ø§Ù„Ù…ÙƒØ³Ø±Ø§Øª','Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ©','Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø©','Ø§Ù„Ø²ÙŠÙˆØª Ø§Ù„Ù†Ø¨Ø§ØªÙŠØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©','Ø§Ù„Ø¨Ù‚ÙˆÙ„ÙŠØ§Øª','Ø§Ù„Ø£ÙƒØªÙŠÙ†'];
        html = `<div class="grid sm:grid-cols-2 gap-2">${al.map(v=>`<label class="p-3 border rounded cursor-pointer"><input type="checkbox" name="allergy" value="${v}" class="mr-2 accent-indigo-600"> ${v}</label>`).join('')}</div>${field('Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø£Ø®Ø±Ù‰ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)','other_allergies',{value:s.other_allergies||''})}`;
        content.innerHTML=stage(t('stage_6'),' ',html); break;

      case 7:
        html = `${field('Ø¢Ø®Ø± Ø§Ù„ØªØ²Ø§Ù… ØªØ¯Ø±ÙŠØ¨ÙŠ','last_train',{select:[{value:'Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±',label:'Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±'},{value:'3-12 Ø´Ù‡Ø±',label:'3-12 Ø´Ù‡Ø±'},{value:'Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†Ø©',label:'Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†Ø©'}],value:s.last_train||'Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±'})}
                ${field('Ø®Ø¨Ø±ØªÙƒ ÙÙŠ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©','training_exp',{select:[{value:'Ù…Ø¨ØªØ¯Ø¦',label:'Ù…Ø¨ØªØ¯Ø¦'},{value:'Ù…ØªÙˆØ³Ø·',label:'Ù…ØªÙˆØ³Ø·'},{value:'Ù…ØªÙ‚Ø¯Ù…',label:'Ù…ØªÙ‚Ø¯Ù…'}],value:s.training_exp||'Ù…Ø¨ØªØ¯Ø¦'})}`;
        content.innerHTML=stage(t('stage_7'),' ',html); break;

      case 8:
        const muscles=['chest','back','shoulders','biceps','triceps','quads','hamstrings','glutes','calves','abs'];
        html = `<div class="space-y-3">${muscles.map(m=>`<div class="flex items-center gap-3"><input id="${m}" type="checkbox" class="accent-indigo-600"><label class="w-28">${m}</label><input id="${m}_desc" class="flex-1 p-2 border rounded" placeholder="ÙˆØµÙ Ø§Ù„Ù‡Ø¯Ù"></div>`).join('')}</div>`;
        content.innerHTML=stage(t('stage_8'),' ',html); break;

      case 9:
        const cond=['Ø¶ØºØ· Ø§Ù„Ø¯Ù…','Ø§Ù„Ø³ÙƒØ±ÙŠ','Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†','Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©','Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ','Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©','Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù‡Ø¶Ù…ÙŠ'];
        html = `<div class="grid sm:grid-cols-2 gap-2">${cond.map(v=>`<label class="p-3 border rounded cursor-pointer"><input type="checkbox" name="hc" value="${v}" class="mr-2 accent-indigo-600"> ${v}</label>`).join('')}</div>${field('Ø¥ØµØ§Ø¨Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)','injuries',{type:'textarea',value:s.injuries||''})}`;
        content.innerHTML=stage(t('stage_9'),' ',html); break;

      case 10:
        html = `<div class="grid sm:grid-cols-3 gap-4">
          ${field('Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¹Ù…Ù„','job_activity',{select:[{value:'Ù…ÙƒØªØ¨ÙŠ',label:'Ù…ÙƒØªØ¨ÙŠ'},{value:'Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ',label:'Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ'},{value:'Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·',label:'Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·'}],value:s.job_activity||'Ù…ÙƒØªØ¨ÙŠ'})}
          ${field('Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù†ÙˆÙ…','sleep_hours',{type:'number',num:true,value:s.sleep_hours||'',required:true})}
          ${field('Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙˆØªØ±','stress_level',{select:[{value:'Ù…Ù†Ø®ÙØ¶',label:'Ù…Ù†Ø®ÙØ¶'},{value:'Ù…ØªÙˆØ³Ø·',label:'Ù…ØªÙˆØ³Ø·'},{value:'Ù…Ø±ØªÙØ¹',label:'Ù…Ø±ØªÙØ¹'}],value:s.stress_level||'Ù…ØªÙˆØ³Ø·'})}
        </div>${field('Ù‡Ø¯Ù Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (NEAT)','steps_target',{type:'number',num:true,value:s.steps_target||9000})}`;
        content.innerHTML=stage(t('stage_10'),' ',html); break;

      case 11:
        html = `<div class="grid sm:grid-cols-2 gap-4">
          <label class="p-6 border rounded-xl text-center cursor-pointer">ğŸ“· ØµÙˆØ± Ø§Ù„Ø¬Ø³Ù…<input type="file" id="photos" class="hidden" multiple accept="image/*"></label>
          <label class="p-6 border rounded-xl text-center cursor-pointer">ğŸ“„ InBody<input type="file" id="inbody" class="hidden" accept="image/*,.pdf"></label>
        </div>`;
        content.innerHTML=stage(t('stage_11'),' ',html); break;

      case 12:
        content.innerHTML=`<section class="text-center p-8"><h2 class="text-2xl font-extrabold mb-1">${state.user.name?('Ù…Ø¹Ùƒ '+state.user.name):'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„'}</h2><p class="text-slate-600">Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„ØµÙŠØ§ØºØ© Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…ØªÙƒØ§Ù…Ù„Ø©â€¦</p><div class="mt-6 animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600 mx-auto"></div><div id="plan" class="mt-8" dir="${state.lang==='ar'?'rtl':'ltr'}"></div></section>`;
        generatePlan(); break;
    }
  }

  /* ---------- SAVE & NAV ---------- */
  function saveAndNext(){
    const s=state.user;
    try{
      switch(state.step){
        case 1: s.name=document.getElementById('name').value.trim(); if(!s.name) throw 0; break;
        case 2: s.age=+document.getElementById('age').value; s.height=+document.getElementById('height').value; s.weight=+document.getElementById('weight').value; s.gender=document.getElementById('gender').value; if(!s.age||!s.height||!s.weight) throw 0; break;
        case 3: s.goals=[...document.querySelectorAll('input[name="goal"]:checked')].map(e=>e.value); if(!s.goals.length) throw 0; break;
        case 4: s.target_weight=+document.getElementById('target_weight').value||null; s.target_date=document.getElementById('target_date').value||null; break;
        case 5:
          s.diet_preference = document.getElementById('diet_preference').value;
          s.meals_per_day = Number(document.getElementById('meals_per_day').value)||4;
          if (document.getElementById('fasting_enabled')) {
            s.fasting = {
              enabled: document.getElementById('fasting_enabled').checked,
              protocol: document.getElementById('fasting_protocol').value,
              start: document.getElementById('fasting_start').value,
              end: document.getElementById('fasting_end').value
            };
          }
          break;
        case 6: s.allergies=[...document.querySelectorAll('input[name="allergy"]:checked')].map(e=>e.value); const other=document.getElementById('other_allergies').value.trim(); if(other) s.allergies.push(other); break;
        case 7: s.last_train=document.getElementById('last_train').value; s.training_exp=document.getElementById('training_exp').value; break;
        case 8: const muscles=['chest','back','shoulders','biceps','triceps','quads','hamstrings','glutes','calves','abs']; s.weak_points={}; muscles.forEach(m=>{ const cb=document.getElementById(m); if(cb?.checked) s.weak_points[m]=document.getElementById(m+'_desc').value||'Strengthening'; }); break;
        case 9: s.health_conditions=[...document.querySelectorAll('input[name="hc"]:checked')].map(e=>e.value); s.injuries=document.getElementById('injuries').value||''; break;
        case 10: s.job_activity=document.getElementById('job_activity').value; s.sleep_hours=+document.getElementById('sleep_hours').value; s.stress_level=document.getElementById('stress_level').value; s.steps_target=+document.getElementById('steps_target').value||9000; if(!s.sleep_hours) throw 0; break;
        case 11: s.has_photos=document.getElementById('photos')?.files.length>0; s.has_inbody=document.getElementById('inbody')?.files.length>0; break;
      }
      state.step++; render();
    }catch{ notify(state.lang==='ar'?'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©':'Complete required fields','err'); }
  }
  function back(){ if(state.step>1){ state.step--; render(); } }
  btnPrev.onclick=back; btnNext.onclick=()=>{ if(state.step<TOTAL) saveAndNext(); else generatePlan(); };

  /* ---------- CALC ---------- */
  function compute(){
    const p=state.user; const W=+p.weight||0,H=+p.height||0,A=+p.age||0; const male=p.gender==='Male';
    const BMR = male ? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161;
    const pal = p.job_activity==='Ù…ÙƒØªØ¨ÙŠ' ? 1.2 : (p.job_activity==='Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·' ? 1.5 : 1.35);
    let TDEE=BMR*pal;
    if((p.goals||[]).includes('Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†')|| (p.goals||[]).includes('Fat loss')) TDEE*=0.85;
    else if((p.goals||[]).includes('Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª')|| (p.goals||[]).includes('Muscle gain')) TDEE*=1.10;
    const targetW=+p.target_weight||W||1;
    const P=Math.round(2.0*targetW), F=Math.round(Math.max(0,0.8*W));
    let C=Math.round((TDEE-(P*4+F*9))/4);
    if((p.health_conditions||[]).some(h=>/Ø³ÙƒØ±ÙŠ|Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†|Insulin|Diab/i.test(h))) C=Math.min(C,120);
    C=Math.max(0,C);
    state.calc={tdee:Math.round(TDEE),P,F,C,pal};
  }

  /* ---------- AI CALL ---------- */
  async function generatePlan(){
    compute();
    lock(true);
    try{
      const prompt = buildPrompt(state.user,state.lang,state.calc);
      const r = await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
      const raw=await r.text(); let data=null; try{data=raw?JSON.parse(raw):null;}catch{}
      if(!r.ok) throw new Error(data?.error||raw||'Server error');
      renderAI(data?.text||''); audit(data?.text||'');
      notify(state.lang==='ar'?'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©':'Plan generated','ok');
    }catch(e){ showError(e.message||String(e)); notify(t('api_error'),'err'); }
    finally{ lock(false); }
  }

  function buildPrompt(p, lang, c) {
    const weak = Object.entries(p.weak_points||{}).map(([k,v])=>`${k}: ${v}`).join(', ') || 'None';
    const meals = Number(p.meals_per_day||4);
    const fasting = p.fasting?.enabled ? `YES (${p.fasting.protocol}, window ${p.fasting.start}-${p.fasting.end})` : 'NO';

    return `
Act as "Coach Mustafa Al-Safi" (Certified International Coach).
You MUST deliver a COMPLETE, SAFE, EXECUTABLE plan in ${lang.toUpperCase()}.

HARD RULES:
1) Use clean Markdown with clear tables.
2) Calories and macros must be **accurate**:
   - Daily target: ~${c.tdee} kcal (tolerance â‰¤ 2%).
   - Macros per day: Protein ${c.P} g, Fat ${c.F} g, Carbs ${c.C} g.
   - Show **per-meal** calories & P/F/C AND a **Daily Total** line at the bottom of each day's table.
3) Meals per day: **${meals}**. Distribute calories/macros accordingly.
4) Fasting: ${fasting}.
   - If fasting YES: No calories outside window; water/black coffee/unsweetened tea allowed.
   - Add hydration & electrolytes guidance on fasted training.
5) Allergies/Health must be respected strictly:
   - Allergies: ${(p.allergies||[]).join(', ')||'None'}.
   - Conditions: ${(p.health_conditions||[]).join(', ')||'None'}.
   - If diabetes/insulin resistance: keep carbs â‰¤ 120 g/day unless rationally explained.
6) Supplements must be **condition-tailored** with safety notes.

USER SNAPSHOT:
- ${p.name} â€” ${p.gender}, ${p.age}y, ${p.height}cm, ${p.weight}kg
- Goals: ${(p.goals||[]).join(', ')}; Target: ${p.target_weight||'â€”'} by ${p.target_date||'â€”'}
- Experience: ${p.training_exp||'â€”'}, Last train: ${p.last_train||'â€”'}
- Weak points: ${weak}
- Diet: ${p.diet_preference||'â€”'}; Meals/day: ${meals}; Fasting: ${fasting}
- Lifestyle: Job ${p.job_activity||'â€”'}, Sleep ${p.sleep_hours||'â€”'}h, Stress ${p.stress_level||'â€”'}, Steps ${p.steps_target}/d, PAL ${c.pal}
- Daily Targets: ~${c.tdee} kcal | P ${c.P} g / F ${c.F} g / C ${c.C} g

OUTPUT (exact order, Arabic headings):

### 1) Ø´Ø±Ø­ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù‡Ø¯Ù Ù…Ù† Ø§Ù„Ø­Ù…ÙŠØ©
- Ù„Ø®Øµ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµØ­ÙŠ ÙˆØ§Ù„Ø¨Ø¯Ù†ÙŠ Ø¨Ø¯Ù‚Ø© (ÙˆØ²Ù†/Ø¹Ù…Ø±/Ø¬Ù†Ø³/ØªØ§Ø±ÙŠØ® ØªØ¯Ø±ÙŠØ¨ÙŠ/Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù).
- Ø§Ø±Ø¨Ø· Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø¨Ø³Ù„ÙˆÙƒÙŠØ§Øª ÙŠÙˆÙ…ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚ÙŠØ§Ø³ (Ø³Ø¹Ø±Ø§Øª/Ù…Ø§ÙƒØ±ÙˆØ²/Ù†ÙˆÙ…/Ø®Ø·ÙˆØ§Øª/ØªÙ…Ø§Ø±ÙŠÙ†).

### 2) Ø£Ù‡Ù… Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©
- 6â€“10 Ù†Ù‚Ø§Ø· Ù‚ØµÙŠØ±Ø© ÙˆØ¹Ù…Ù„ÙŠØ© (Ø§Ù„Ù†ÙˆÙ…ØŒ Ø§Ù„ØªØ±Ø·ÙŠØ¨ØŒ Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†ØŒ ØªÙˆÙ‚ÙŠØª Ø§Ù„ÙˆØ¬Ø¨Ø§ØªØŒ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù†Ø²Ù„â€¦).

### 3) Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹
- Ø¬Ø¯ÙˆÙ„Ø§Ù† Ù…Ù†ÙØµÙ„Ø§Ù†: "Ù…Ø³Ù…ÙˆØ­" Ùˆ"Ù…Ù…Ù†ÙˆØ¹" (ÙŠÙØ±Ø§Ø¹ÙŠ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© ÙˆØ§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±).

### 4) Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹ (Ø¥Ù† ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹)
- Ø§Ø´Ø±Ø­ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ${p.fasting?.protocol||'â€”'} Ù…Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© ${p.fasting?.start||'â€”'}â€“${p.fasting?.end||'â€”'}.
- ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¯Ø§Ø®Ù„/Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø©ØŒ Ù…ØªÙ‰ Ø§Ù„Ù‚Ù‡ÙˆØ© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ØŒ Ù…ØªÙ‰ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ„ÙŠØªØŒ ÙˆÙ…ØªÙ‰ ÙƒØ³Ø± Ø§Ù„ØµÙŠØ§Ù….
- Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ø§Ù„ØµÙŠØ§Ù… ÙØ¹Ø§Ù„Ø§Ù‹: Ø¶Ø¹ ÙÙ‚Ø±Ø© Ù‚ØµÙŠØ±Ø© ØªØ´Ø±Ø­ Ù„Ù…Ø§Ø°Ø§ ÙˆÙ„Ù…Ø§Ø°Ø§ Ù‚Ø¯ ÙŠÙÙ†ØµØ­ Ø¨Ù‡ Ø£Ùˆ Ù„Ø§.

### 5) Ø§Ù„ØªØºØ°ÙŠØ© â€” 7 Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø©
- Ù„ÙƒÙ„ ÙŠÙˆÙ… **${meals} ÙˆØ¬Ø¨Ø§Øª**.
- Ø¬Ø¯ÙˆÙ„ Ù‚ÙŠØ§Ø³ÙŠ:
| Ø§Ù„ÙŠÙˆÙ… | Ø§Ù„ÙˆØ¬Ø¨Ø© | Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª (Øº) | Ø§Ù„Ø³Ø¹Ø±Ø§Øª | Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† (g) | Ø§Ù„Ø¯Ù‡ÙˆÙ† (g) | Ø§Ù„ÙƒØ§Ø±Ø¨ (g) |
|---|---|---|---:|---:|---:|---:|
(Ø§ÙƒØªØ¨ ÙƒÙ„ Ø§Ù„ÙˆØ¬Ø¨Ø§ØªØŒ Ø«Ù… ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ø³Ø·Ø±: **Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ: XXXX kcal â€” P XX / F XX / C XX** ÙˆÙŠØ¬Ø¨ Ø£Ù† ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„ØªØ§Ø±Ø¬Øª Â±2%)

### 6) Ø§Ù„ØªØ¯Ø±ÙŠØ¨ â€” 7 Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø©
- Ø§Ø³ØªØ®Ø¯Ù… EN Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† + Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ø±Ø¨ÙŠØ© Ù…ÙˆØ¬Ø²Ø©.
- Ø¬Ø¯ÙˆÙ„:
| Ø§Ù„ÙŠÙˆÙ… | Exercise (EN) + Ù…Ù„Ø§Ø­Ø¸Ø© | Sets | Reps | Tempo | RIR | Rest(s) |
|---|---|---:|---:|---:|---:|---:|
- Ø±Ø§Ø¹Ù Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø©: "${p.injuries||'None'}".
- Ø§Ø±Ø¨Ø· Ø§Ù„Ø®Ø·Ø© Ø¨Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù: "${weak}".

### 7) Ø§Ù„ÙƒØ§Ø±Ø¯ÙŠÙˆ Ùˆ NEAT
- Ø¯Ù‚Ø§Ø¦Ù‚/Ø§Ù„ÙŠÙˆÙ… + Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†Ø¨Ø¶ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© + Ù‡Ø¯Ù Ø§Ù„Ø®Ø·ÙˆØ§Øª (${p.steps_target}/Ø§Ù„ÙŠÙˆÙ…).
- Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ ÙÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø³ÙØ±/Ø§Ù„Ø¶ØºÙˆØ·.

### 8) Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª (Ù…Ø®ØµØµØ© Ù„Ù„Ø­Ø§Ù„Ø©)
- Ø¬Ø¯ÙˆÙ„ Ø´Ø§Ù…Ù„:
| Ø§Ù„Ù…ÙƒÙ…Ù„ | Ø§Ù„Ø¬Ø±Ø¹Ø© | Ø§Ù„ØªÙˆÙ‚ÙŠØª | Ø§Ù„Ù‡Ø¯Ù | ØªØ­Ø°ÙŠØ±Ø§Øª |
- Ù…Ø«Ø§Ù„ (Ø¹Ø¯Ù‘ÙÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©): Vitamin D3 (2000 IU AM)ØŒ Omega-3 (2â€“3 g/d with fat)ØŒ Creatine (5 g post-workout)ØŒ Magnesium glycinate (200â€“400 mg PM)ØŒ Electrolytes ÙÙŠ Ø§Ù„ØµÙŠØ§Ù…/ÙƒÙŠØªÙˆØŒ Probiotic/Prebiotic Ù„Ù„Ù€GIâ€¦ Ù…Ø¹ ØªØ­Ø°ÙŠØ±Ø§Øª Ø§Ù„ØªØ¯Ø§Ø®Ù„Ø§Øª/Ø§Ù„Ø­Ù…Ù„/Ø§Ù„Ø£Ø¯ÙˆÙŠØ©.

### 9) Ø±Ø³Ø§Ø¦Ù„ ØªØ­ÙÙŠØ²ÙŠØ© ÙŠÙˆÙ…ÙŠØ©
- 7 Ø±Ø³Ø§Ø¦Ù„ Ù‚ØµÙŠØ±Ø© Ø¹Ù…Ù„ÙŠØ© (ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ ÙŠÙˆÙ…) ØªØ±Ø¨Ø· Ø§Ù„Ø³Ù„ÙˆÙƒ Ø¨Ø§Ù„Ù‡Ø¯Ù.

### 10) Ø®Ø·Ø© Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„
- ÙƒÙŠÙ ØªØ²ÙŠØ¯ Ø§Ù„Ø£Ø­Ù…Ø§Ù„/Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§ØªØŒ ÙˆÙƒÙŠÙ ØªØ¹Ø¯Ù„ Ø§Ù„Ø³Ø¹Ø±Ø§Øª Â±100â€“150 Ø¹Ù†Ø¯ Ø«Ø¨Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ØŒ ÙˆÙ…ØªÙ‰ ØªÙØ¹Ø§Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª.

### 11) Ø¥Ø®Ù„Ø§Ø¡ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© ÙˆØ­Ù‚ÙˆÙ‚
- Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·. Ø§Ø³ØªØ´Ø± Ø·Ø¨ÙŠØ¨Ùƒ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„Ø§Øª Ù…Ø²Ù…Ù†Ø©.

**Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:**
**Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯**  
**Powered by Mustafa Elsafy 2025**
`;
  }

  /* ---------- RENDER RESULTS + TOOLS ---------- */
  function renderAI(md){
    const html = marked.parse(
      md.replace(/\[SWAP:(EXERCISE|MEAL):(.*?)\]/g,(m,type,item)=>{
        const t=type.toLowerCase(); const clean=(item||'').replace(/"/g,'&quot;');
        const btn=`<button type="button" class="btn no-print" data-type="${t}" data-item="${encodeURIComponent(clean)}" onclick="swapItem(event)">${state.lang==='ar'?'ØªØ¨Ø¯ÙŠÙ„':'Swap'}</button>`;
        return t==='meal'? `<span class="inline-flex items-center gap-2">${item} ${btn}</span>` : `<span class="inline-flex items-center gap-2"><b>${item}</b>${btn}</span>`;
      })
    );
    content.innerHTML = `<section class="card p-6"><article class="ai-prose max-w-none">${html}</article>
      <div class="no-print mt-4 flex gap-2"><button class="btn" onclick="doJSON()">JSON</button><button class="btn" onclick="doCSV()">CSV</button><button class="btn" onclick="window.print()">${state.lang==='ar'?'Ø·Ø¨Ø§Ø¹Ø© PDF':'Print PDF'}</button></div>
      <div class="mt-6 text-xs text-slate-500 border-t pt-3"><b>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯</b><div>Powered by Mustafa Elsafy 2025</div></div></section>`;
  }

  function audit(md){
    const days = (md.match(/(?:^|\n)(?:Day|Ø§Ù„ÙŠÙˆÙ…)\s*\d/gi)||[]).length;
    badgeDays.textContent = `${Math.min(days,7)}/7`;
    badgeDays.className = 'badge ' + (days===7 ? 'ok':'warn');

    const totals = [...md.matchAll(/Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ\s*:\s*([\d,.]+)\s*kcal/gi)].map(m=>Number((m[1]||'0').replace(/[^\d.]/g,'')));
    badgeMacros.textContent = `Â±2% ${Math.min(totals.length,7)}/7`;
    badgeMacros.className = 'badge ' + (totals.length===7 ? 'ok':'warn');
  }

  async function swapItem(ev){
    const b=ev.target.closest('button'); if(!b) return;
    const type=b.dataset.type, original=decodeURIComponent(b.dataset.item||''); const old=b.textContent;
    b.disabled=true; b.textContent=state.lang==='ar'?'Ø¬Ø§Ø±ÙŠâ€¦':'Workingâ€¦';
    try{
      const prompt=(type==='meal')
        ? `Give ONE ${state.lang==='ar'?'ÙˆØ¬Ø¨Ø© Ø¨Ø¯ÙŠÙ„Ø©':'alternative meal'} for "${original}" in ${state.lang.toUpperCase()}, respecting diet "${state.user.diet_preference}", avoiding "${(state.user.allergies||[]).join(', ')}". Include calories and P/F/C. End with [SWAP:MEAL:<name>].`
        : `Give ONE alternative exercise (EN name + Arabic cue) for "${original}", same muscle, safe for injuries "${state.user.injuries||'None'}". Include Sets x Reps, Tempo, RIR, Rest(s). End with [SWAP:EXERCISE:<EN>].`;
      const r=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
      const raw=await r.text(); let data=null; try{data=raw?JSON.parse(raw):null;}catch{}
      if(!r.ok) throw new Error(data?.error||raw||'Server error');
      const txt=data?.text?.trim()||'';
      b.parentElement.childNodes[0].nodeValue=(type==='meal'?txt:txt.split('\n')[0])+' ';
      b.dataset.item=encodeURIComponent(txt.replace(/\[.*?\]$/,'').trim());
    }catch{ notify(state.lang==='ar'?'ØªØ¹Ø°Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„':'Swap failed','err'); }
    b.disabled=false; b.textContent=old;
  }

  // Exporters
  function doJSON(){
    const payload={ user:state.user, calc:state.calc, raw:content.querySelector('.ai-prose')?.innerText||'' };
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='ai-coach-plan.json'; a.click();
  }
  function doCSV(){
    const text=content.querySelector('.ai-prose')?.innerText||''; const rows=[['section','day','type','details']];
    text.split('\n').forEach(line=>{ if(line.trim()) rows.push(['plan','','',line.trim()]); });
    const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ai-coach-plan.csv'; a.click();
  }

  /* ---------- UX ---------- */
  function notify(msg,level='ok'){ const c=document.createElement('div'); c.className=`fixed top-5 right-5 z-50 text-white px-3 py-2 rounded ${level==='ok'?'bg-emerald-600':level==='warn'?'bg-amber-600':'bg-rose-600'}`; c.textContent=msg; document.body.appendChild(c); setTimeout(()=>c.remove(),2600); }
  function showError(m){ content.innerHTML=`<section class="card p-6"><div class="p-4 bg-rose-50 border border-rose-200 rounded text-rose-800"><b>${state.lang==='ar'?'Ø®Ø·Ø£':'Error'}</b><div class="text-sm mt-1">${m}</div></div></section>`; }
  function lock(on){ btnPrev.disabled=on; btnNext.disabled=on; btnNext.textContent = on ? (state.lang==='ar'?'Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ†ÙÙŠØ°â€¦':'Workingâ€¦') : (state.step>=12?t('submit'):t('next')); }

  // Init
  setLang('ar'); state.step=0; render();
  </script>
</body>
</html>
