<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ | Intelligent Health Coach</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Marked (Markdown Parser) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- DOMPurify (Sanitizer) -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --brand:#6c5ce7; --brand-2:#00c2ff;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      --card:#0b1220; --muted:#93a2b8;
    }
    html[dir="rtl"] body { font-family: 'Tajawal', system-ui, -apple-system, Segoe UI, Roboto, "Noto Naskh Arabic", sans-serif; }
    html[dir="ltr"] body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; }
    body{ background:linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%); color:#eaf0ff; }
    .glass{ background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); }
    .title-grad{ background:linear-gradient(90deg,var(--brand),var(--brand-2)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .card{ border-radius:16px; }
    .chip{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); padding:.35rem .6rem; border-radius:999px; font-size:.75rem; }
    .kbd{ border:1px solid rgba(255,255,255,.2); border-bottom-width:2px; padding:.05rem .4rem; border-radius:6px; font-size:.75rem; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.75rem 1rem; border-radius:.8rem; font-weight:800; transition:.2s; }
    .btn-primary{ background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#fff; }
    .btn-primary:hover{ filter:brightness(1.1); transform:translateY(-1px); }
    .btn-ghost{ background:rgba(255,255,255,.06); color:#eaf0ff; border:1px solid rgba(255,255,255,.1); }
    .btn-ghost:hover{ background:rgba(255,255,255,.1); }
    .field{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:.7rem; padding:.65rem .8rem; outline:none; width:100%; color:#eaf0ff; }
    .field::placeholder{ color:#9fb0c7; }
    .field:focus{ border-color:var(--brand-2); box-shadow:0 0 0 3px rgba(0,194,255,.15); }
    .section-title{ font-weight:900; letter-spacing:.3px; }
    .divider{ height:1px; background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent); }
    .toast{ position:fixed; inset-inline-end:16px; bottom:16px; background:#0e1a2d; border:1px solid rgba(255,255,255,.14); color:#eaf0ff; padding:.6rem .8rem; border-radius:.7rem; z-index:80; box-shadow:0 10px 20px rgba(0,0,0,.35)}
    .tag{ font-size:.72rem; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); border-radius:.5rem; padding:.2rem .5rem;}
    .progress{ height:.45rem; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; }
    .progress > i{ display:block; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); width:0%; transition:width .25s ease; }

    /* Grid ordering per language */
    .col{ display:flex; flex-direction:column; gap:.75rem;}
    /* Arabic: Profile on right */
    html[dir="rtl"] .g{ display:grid; grid-template-columns:repeat(12, minmax(0,1fr)); gap:14px;}
    html[dir="rtl"] .g .c-profile   { grid-column: 9 / span 4; }
    html[dir="rtl"] .g .c-diet      { grid-column: 5 / span 4; }
    html[dir="rtl"] .g .c-life      { grid-column: 1 / span 4; }
    html[dir="rtl"] .g .c-med       { grid-column: 1 / span 12; }
    /* English: Profile on left */
    html[dir="ltr"] .g{ display:grid; grid-template-columns:repeat(12, minmax(0,1fr)); gap:14px;}
    html[dir="ltr"] .g .c-profile   { grid-column: 1 / span 4; }
    html[dir="ltr"] .g .c-diet      { grid-column: 5 / span 4; }
    html[dir="ltr"] .g .c-life      { grid-column: 9 / span 4; }
    html[dir="ltr"] .g .c-med       { grid-column: 1 / span 12; }

    /* Wizard (Ø«Ø§Ø¨Øª Ø¨ØµØ±ÙŠÙ‹Ø§ Ø§Ù„Ø¢Ù†) */
    .stepper{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
    .stepper > div{ height:6px; border-radius:6px; background:rgba(255,255,255,.08); position:relative; overflow:hidden; }
    .stepper > .on:before{ content:''; position:absolute; inset:0; background:linear-gradient(90deg,var(--brand),var(--brand-2)); }

    /* Overlay */
    #overlay{ position:fixed; inset:0; background:rgba(9,12,20,.6); backdrop-filter:blur(6px); z-index:70; display:none; align-items:center; justify-content:center;}
    .spinner{ width:44px; height:44px; border-radius:50%; border:4px solid rgba(255,255,255,.2); border-top-color:var(--brand-2); animation:spin 1s linear infinite;}
    @keyframes spin{ to { transform:rotate(360deg)}}

    /* Plan content */
    .ai-content h2{ font-weight:900; font-size:1.5rem; margin:.75rem 0; color:#eaf0ff }
    .ai-content h3{ font-weight:800; font-size:1.2rem; margin:.6rem 0; color:#d7e3fb }
    .ai-content table{ border-collapse:collapse; width:100%; background:rgba(255,255,255,.04); margin:.75rem 0; }
    .ai-content th,.ai-content td{ border:1px solid rgba(255,255,255,.12); padding:.55rem; vertical-align:top; }
    .ai-content th{ background:rgba(255,255,255,.07); font-weight:800 }

    /* Print */
    @media print{
      body{ background:#fff; color:#111 }
      #shell, #bar, #wizard, #actions { display:none !important; }
      #plan { margin:0 !important; padding:0 !important; border:0 !important; box-shadow:none !important; }
      .ai-content h2, .ai-content h3 { color:#111 }
      .ai-content table { background:#fff; border-color:#333 }
      .ai-content th { background:#f3f4f6; }
    }
    /* Ù…Ù†Ø¹ ØªÙ‚Ø·ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    .ai-content table, .ai-content tr, .ai-content td { page-break-inside: avoid; }
    /* ØªØ­Ø³ÙŠÙ† Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„Ù„Ù€ SR ÙÙ‚Ø· */
    .sr-only{ position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0; }
  </style>
</head>
<body>

  <!-- Top bar -->
  <header id="bar" class="sticky top-0 z-40 glass border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-[var(--brand)] to-[var(--brand-2)] grid place-items-center font-black">AI</div>
        <div>
          <div id="app-title" class="text-lg font-extrabold">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ</div>
          <div class="text-xs text-[color:var(--muted)]" id="subtitle">Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù % Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€“ Ù…Ø®ØµØµØ© Ù„Ùƒ</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="lang-ar" class="chip" type="button">Ø¹Ø±Ø¨ÙŠ</button>
        <button id="lang-en" class="chip" type="button">EN</button>
        <button id="toggle-theme" class="chip" title="Theme" type="button">â˜¾</button>
        <button id="btn-print" class="btn btn-ghost" type="button"><span id="t-print">Ø·Ø¨Ø§Ø¹Ø©</span></button>
      </div>
    </div>
  </header>

  <!-- Shell -->
  <main id="shell" class="max-w-6xl mx-auto px-4 py-6">
    <!-- Stepper + hint -->
    <section class="glass card p-4 mb-4">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <span class="kbd">1</span><span class="kbd">2</span><span class="kbd">3</span><span class="kbd">4</span>
          <span class="text-sm text-[color:var(--muted)]" id="hint">Ø³Ù†ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø®Ø·Ø© Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù…: ØªØ±Ø­ÙŠØ¨ â†’ ØªØ­Ù„ÙŠÙ„ â†’ Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹ â†’ Ø§Ù„ØµÙŠØ§Ù… (Ø¥Ù† Ù„Ø²Ù…) â†’ Ø§Ù„ØªØºØ°ÙŠØ© Ù§ Ø£ÙŠØ§Ù… â†’ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù§ Ø£ÙŠØ§Ù… â†’ Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â†’ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… â†’ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ â†’ Ø§Ù„Ø³Ù„Ø§Ù…Ø© â†’ Ø®ØªØ§Ù….</span>
        </div>
        <div class="w-56 progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><i id="global-progress"></i></div>
      </div>
    </section>

    <!-- Wizard (Ø­Ø§Ù„ÙŠÙ‹Ø§ Ø®Ø·ÙˆØ© ÙˆØ§Ø­Ø¯Ø© Ø´Ø§Ù…Ù„Ø©) -->
    <section id="wizard" class="glass card p-4">
      <div class="stepper mb-5"><div class="on" id="s1"></div><div id="s2"></div><div id="s3"></div><div id="s4"></div></div>
      <div id="step-title" class="section-title title-grad text-xl mb-3">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
      <div id="step-body"></div>
      <div id="wizard-actions" class="mt-5 flex items-center justify-between">
        <button id="prev" class="btn btn-ghost" type="button" disabled>â—€ <span id="t-prev">Ø§Ù„Ø³Ø§Ø¨Ù‚</span></button>
        <div class="flex items-center gap-2">
          <button id="next" class="btn btn-primary hidden" type="button"><span id="t-next">Ø§Ù„ØªØ§Ù„ÙŠ</span> â–¶</button>
          <button id="generate" class="btn btn-primary" type="button">âš¡ <span id="t-generate">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©</span></button>
        </div>
      </div>
    </section>

    <!-- Plan output -->
    <section id="plan" class="glass card p-5 mt-6">
      <div class="text-sm text-[color:var(--muted)]" id="plan-empty">â€” Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø© Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ â€”</div>
      <div id="plan-content" class="ai-content"></div>
      <div id="actions" class="mt-5 flex items-center justify-end gap-2">
        <button class="btn btn-ghost" id="scroll-top" type="button">â†‘ <span id="t-top">Ø£Ø¹Ù„Ù‰</span></button>
        <button class="btn btn-primary" id="print-bottom" type="button">ğŸ–¨ <span id="t-print2">Ø·Ø¨Ø§Ø¹Ø© / PDF</span></button>
      </div>
    </section>

    <footer class="text-center text-xs text-[color:var(--muted)] mt-6">Powered by <strong>Mustafa Elsafy</strong> 2025 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</footer>
  </main>

  <!-- Live region for accessibility -->
  <div id="live" class="sr-only" aria-live="polite"></div>

  <!-- Overlay -->
  <div id="overlay" aria-busy="true" aria-hidden="true">
    <div class="glass card p-6 w-[min(92vw,520px)] text-center">
      <div class="spinner mx-auto mb-3"></div>
      <div class="font-extrabold mb-1" id="ov-title">Ù†ÙØ¬Ù‡Ù‘Ø² Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†</div>
      <div class="text-sm text-[color:var(--muted)]" id="ov-sub">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±. Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù…: Ø§Ù„ØªØ±Ø­ÙŠØ¨ØŒ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹ØŒ Ø§Ù„ØµÙŠØ§Ù…ØŒ Ø§Ù„ØªØºØ°ÙŠØ© 7 Ø£ÙŠØ§Ù…ØŒ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ 7 Ø£ÙŠØ§Ù…ØŒ Ø§Ù„Ù…ÙƒÙ…Ù„Ø§ØªØŒ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…ØŒ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ØŒ Ø§Ù„Ø³Ù„Ø§Ù…Ø©ØŒ Ø§Ù„Ø®Ø§ØªÙ…Ø©.</div>
      <div class="mt-3 progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><i id="ov-bar"></i></div>
    </div>
  </div>

  <script>
    /***** Marked + DOMPurify config *****/
    marked.setOptions({ breaks:true, mangle:false, headerIds:false });

    /***** App state *****/
    const state = {
      lang: (navigator.language || 'ar').startsWith('ar') ? 'ar' : 'en',
      theme: 'dark',
      // Ù†ÙØ¨Ù‚ÙŠ step=0 ÙˆÙ†Ø¸Ù‡Ø± Ø²Ø± Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ù…Ø¨Ø§Ø´Ø±Ø©
      step: 0,
      currency: detectCurrency(),
      profile: { name:'', age:'', height:'', weight:'', bodyFat:'', waist:'', sex:'Male', targetWeight:'', targetDate:'' },
      diet: {
        goals:[], // <-- Ù…ÙØ§ØªÙŠØ­ Ø«Ø§Ø¨ØªØ©
        mealsPerDay:3, preferredDiet:'Balanced', cuisine:'Arabic/Mediter.', prepTime:20,
        monthlyBudget:0, foodsToAvoid:'', allergies:'', fasting:'off'
      },
      lifestyle:{
        workActivity:'Sedentary', stepsPerDay:6000, sleep:'Low', stress:'Low',
        trainingPlace:'Home/Gym', sessionLength:60, availableDays:[],
        equipment:'', experience:'Beginner (0-6m)', rpe:8, caffeine:0, injuries:''
      },
      fitness:{ restingHR:'', maxPushups:'', plank:'', kmTime:'' },
      muscles: { chest:{on:false,note:''}, back:{on:false,note:''}, shoulders:{on:false,note:''},
                 biceps:{on:false,note:''}, triceps:{on:false,note:''}, quads:{on:false,note:''},
                 hamstrings:{on:false,note:''}, glutes:{on:false,note:''}, calves:{on:false,note:''}, abs:{on:false,note:''} },
      medical:{ conditions:[], other:'', meds:'', supplements:'' },
      challenges:{ past:'', motivation:'Direct' },
      targets: null,
      generating:false
    };

    /***** Constants *****/
    const GOALS = [
      {key:'fatLoss',   ar:'Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†',   en:'Fat loss'},
      {key:'build',     ar:'Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª',   en:'Build muscle'},
      {key:'strength',  ar:'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©',     en:'Strength'},
      {key:'endurance', ar:'ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„',    en:'Endurance'},
      {key:'health',    ar:'ØµØ­Ø© Ø¹Ø§Ù…Ø©',        en:'General health'},
    ];
    function goalLabel(key){ const g=GOALS.find(x=>x.key===key); return state.lang==='ar' ? g.ar : g.en; }

    /***** i18n *****/
    const T = {
      ar:{
        appTitle:'Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ',
        subtitle:'Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù Ùª Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ø®ØµØµØ© Ù„Ùƒ',
        steps:['Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ','Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª','Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØªÙ…Ø§Ø±ÙŠÙ†','Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª'],
        next:'Ø§Ù„ØªØ§Ù„ÙŠ', prev:'Ø§Ù„Ø³Ø§Ø¨Ù‚', generate:'ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©', print:'Ø·Ø¨Ø§Ø¹Ø©', top:'Ø£Ø¹Ù„Ù‰',
        hint:'Ø³Ù†ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø®Ø·Ø© Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù…: ØªØ±Ø­ÙŠØ¨ â†’ ØªØ­Ù„ÙŠÙ„ â†’ Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹ â†’ Ø§Ù„ØµÙŠØ§Ù… (Ø¥Ù† Ù„Ø²Ù…) â†’ Ø§Ù„ØªØºØ°ÙŠØ© Ù§ Ø£ÙŠØ§Ù… â†’ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù§ Ø£ÙŠØ§Ù… â†’ Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â†’ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… â†’ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ â†’ Ø§Ù„Ø³Ù„Ø§Ù…Ø© â†’ Ø®ØªØ§Ù….',
        profile:'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', dietPrefs:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª', lifestyle:'Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨', med:'Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØµØ­ÙŠØ© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª',
        name:'Ø§Ù„Ø§Ø³Ù…', age:'Ø§Ù„Ø¹Ù…Ø±', height:'Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)', weight:'Ø§Ù„ÙˆØ²Ù† (ÙƒØº)', bodyFat:'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† % (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', waist:'Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ± (Ø³Ù…) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', sex:'Ø§Ù„Ø¬Ù†Ø³',
        male:'Ø°ÙƒØ±', female:'Ø£Ù†Ø«Ù‰', targetWeight:'Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (ÙƒØº)', targetDate:'Ù…ÙˆØ¹Ø¯ ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù (ØªØ§Ø±ÙŠØ®)',
        goals:'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ù…ØªØ¹Ø¯Ø¯)', fatLoss:'Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†', build:'Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª', strength:'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©', endurance:'ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„', health:'ØµØ­Ø© Ø¹Ø§Ù…Ø©',
        mealsPerDay:'Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª', preferredDiet:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù‘Ù„', balanced:'Ù†Ø¸Ø§Ù… Ù…ØªÙˆØ§Ø²Ù†', lowCarb:'Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª', keto:'ÙƒÙŠØªÙˆ', med:'Ù…ØªÙˆØ³Ø·ÙŠ/Ø¹Ø±Ø¨ÙŠ', veg:'Ù†Ø¨Ø§ØªÙŠ/Ù…Ø±Ù†',
        fasting:'Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹', fastingOff:'ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„', fasting16:'16:8', fasting18:'18:6', fasting20:'20:4',
        cuisine:'Ø§Ù„Ù…Ø·Ø¨Ø®', prepTime:'Ø²Ù…Ù† Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø¯)', budget:'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©', foodsAvoid:'Ø£Ø·Ø¹Ù…Ø© Ù„Ø§ ØªØ±ØºØ¨ Ø¨Ù‡Ø§/Ø­Ø³Ø§Ø³ÙŠØ§Øª', allergies:'Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø´Ø§Ø¦Ø¹Ø©',
        workActivity:'Ø§Ù„Ø¹Ù…Ù„/Ø§Ù„Ù†Ø´Ø§Ø·', steps:'Ø®Ø·ÙˆØ§Øª/Ø§Ù„ÙŠÙˆÙ…', sleep:'Ø§Ù„Ù†ÙˆÙ…', stress:'Ø§Ù„ØªÙˆØªØ±', place:'Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ…Ø±ÙŠÙ†', session:'Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯)',
        days:'Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©', equipment:'Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©', experience:'Ø§Ù„Ø®Ø¨Ø±Ø©', rpe:'RPE', caffeine:'ÙƒØ§ÙÙŠÙŠÙ†/Ø£ÙƒÙˆØ§Ø¨', injuries:'Ø¥ØµØ§Ø¨Ø§Øª/Ù‚ÙŠÙˆØ¯',
        quick:'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ù…Ø¨Ø³Ù‘Ø·', restingHR:'Ù†Ø¨Ø¶ Ø§Ù„Ø±Ø§Ø­Ø© (bpm)', pushups:'Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø£Ù‚ØµÙ‰', plank:'Plank (Ø¯)', kmTime:'Ø²Ù…Ù† 1 ÙƒÙ… (Ø¯:Ø«)',
        musclesFocus:'Ø¹Ø¶Ù„Ø§Øª ØªØ­ØªØ§Ø¬ Ø¹Ù†Ø§ÙŠØ© Ø®Ø§ØµØ©', describe:'ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©/Ø§Ù„Ø³Ø¨Ø¨',
        medicalStatus:'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©', otherCond:'Ø£Ù…Ø±Ø§Ø¶ Ø£Ø®Ø±Ù‰', currentMeds:'Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ©', currentSupp:'Ù…ÙƒÙ…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ©',
        pastCh:'ØªØ­Ø¯ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©', motiv:'Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØ­ÙÙŠØ² Ø§Ù„Ù…ÙØ¶Ù„', motivDir:'Ø¹Ù…Ù„ÙŠ ÙˆÙ…Ø¨Ø§Ø´Ø±', motivWarm:'ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…',
        generatingTitle:'Ù†ÙØ¬Ù‡Ù‘Ø² Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†', generatingSub:'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±â€¦ Ø³Ù†ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­ØªÙ‰ ØªÙƒØªÙ…Ù„ Ø§Ù„Ø®Ø·Ø©.',
        print2:'Ø·Ø¨Ø§Ø¹Ø© / PDF',
        needBasics:'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ø·ÙˆÙ„/Ø§Ù„ÙˆØ²Ù†.',
        failed:'ØªØ¹Ø°Ù‘Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©. ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.'
      },
      en:{
        appTitle:'Intelligent Health Coach',
        subtitle:'100% precise plan for nutrition, training & supplements â€“ fully personalized',
        steps:['Profile','Diet & Preferences','Lifestyle & Training','Medical & Challenges'],
        next:'Next', prev:'Back', generate:'Generate Plan', print:'Print', top:'Top',
        hint:'We will generate the plan section-by-section: Welcome â†’ Analysis â†’ Allowed/Limits â†’ Intermittent Fasting (if any) â†’ Nutrition 7-day â†’ Training 7-day â†’ Supplements â†’ Progression â†’ Troubleshooting â†’ Safety â†’ Closing.',
        profile:'Profile', dietPrefs:'Diet & Preferences', lifestyle:'Lifestyle & Training', med:'Medical & Challenges',
        name:'Name', age:'Age', height:'Height (cm)', weight:'Weight (kg)', bodyFat:'Body fat % (optional)', waist:'Waist (cm) (optional)', sex:'Sex',
        male:'Male', female:'Female', targetWeight:'Target weight (kg)', targetDate:'Target date',
        goals:'Goals (multi-select)', fatLoss:'Fat loss', build:'Build muscle', strength:'Strength', endurance:'Endurance', health:'General health',
        mealsPerDay:'Meals per day', preferredDiet:'Preferred diet', balanced:'Balanced', lowCarb:'Low-carb', keto:'Keto', med:'Mediterranean/Arabic', veg:'Plant-forward',
        fasting:'Intermittent fasting', fastingOff:'Off', fasting16:'16:8', fasting18:'18:6', fasting20:'20:4',
        cuisine:'Cuisine', prepTime:'Prep time (min)', budget:'Monthly budget (approx.)', foodsAvoid:'Foods to avoid / dislikes', allergies:'Common allergies',
        workActivity:'Work/Activity', steps:'Steps/day', sleep:'Sleep', stress:'Stress', place:'Training place', session:'Session length (min)',
        days:'Available training days', equipment:'Available equipment', experience:'Experience', rpe:'RPE', caffeine:'Caffeine/day (cups)', injuries:'Injuries/constraints',
        quick:'Quick fitness test', restingHR:'Resting HR (bpm)', pushups:'Max push-ups', plank:'Plank (min)', kmTime:'1 km time (m:s)',
        musclesFocus:'Muscles needing special focus', describe:'Describe the issue/reason',
        medicalStatus:'Medical status', otherCond:'Other conditions', currentMeds:'Current medications', currentSupp:'Current supplements',
        pastCh:'Past challenges with plans', motiv:'Preferred motivation style', motivDir:'Direct & pragmatic', motivWarm:'Supportive & encouraging',
        generatingTitle:'Preparing your plan', generatingSub:'Please wait. We will build the plan section by section until completion.',
        print2:'Print / PDF',
        needBasics:'Please complete: name/age/height/weight.',
        failed:'Plan generation failed. Check connectivity.'
      }
    };
    const t = (k)=> (T[state.lang] && T[state.lang][k]) || k;

    /***** Helpers *****/
    function esc(s){
      return (s??'').toString()
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    function $(id){ return document.getElementById(id); }
    function val(id){ const el=$(id); return el? el.value.trim():''; }
    function numVal(id, fallback=0){ const el=$(id); return el? Number(el.value||fallback):fallback; }

    /***** Language & UI *****/
    function setLang(lang){
      state.lang = lang;
      const html = document.documentElement;
      html.lang = lang;
      html.dir = (lang==='ar') ? 'rtl' : 'ltr';
      // texts
      $('app-title').textContent = t('appTitle');
      $('subtitle').textContent = t('subtitle');
      $('hint').textContent = t('hint');
      $('t-prev').textContent = t('prev');
      $('t-next').textContent = t('next');
      $('t-generate').textContent = t('generate');
      $('t-print').textContent = t('print');
      $('t-print2').textContent = t('print2');
      $('t-top').textContent = t('top');
      $('ov-title').textContent = t('generatingTitle');
      $('ov-sub').textContent = t('generatingSub');
      renderStep();
    }

    /***** Theme *****/
    $('toggle-theme').onclick = ()=>{
      state.theme = (state.theme==='dark'?'light':'dark');
      document.body.style.background = (state.theme==='dark')
        ? 'linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%)'
        : 'linear-gradient(180deg,#eef2ff 0%,#f7f9ff 100%)';
    };

    /***** Step rendering (Ø®Ø·ÙˆØ© ÙˆØ§Ø­Ø¯Ø© Ø´Ø§Ù…Ù„Ø©) *****/
    function renderStep(){
      const titles = T[state.lang].steps;
      $('step-title').textContent = titles[0]; // Ø®Ø·ÙˆØ© ÙˆØ§Ø­Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
      // stepper Ø­Ø§Ù„Ø© Ù…Ø±Ø¦ÙŠØ© ÙÙ‚Ø·
      ['s1','s2','s3','s4'].forEach((id,i)=>$(id).className = (i===0?'on':''));

      const L = (k)=>t(k);
      const num = (placeholder='')=>`inputmode="numeric" pattern="[0-9]*" class="field" placeholder="${placeholder}"`;
      const option = (val, lab)=>`<option value="${val}">${lab}</option>`;
      const ch = (id,lab,checked=false)=>`<label class="flex items-center gap-2"><input type="checkbox" id="${id}" ${checked?'checked':''} class="accent-[var(--brand-2)]"><span>${lab}</span></label>`;

      // Ø£Ù‡Ø¯Ø§Ù (Ø¨Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø«Ø§Ø¨ØªØ©)
      const goalChk = (key)=>`<label class="flex items-center gap-2">
        <input type="checkbox" data-goal="${key}" class="accent-[var(--brand-2)]" ${state.diet.goals.includes(key)?'checked':''}>
        <span>${goalLabel(key)}</span>
      </label>`;

      // body
      const el = $('step-body');
      el.innerHTML = `
        <div class="g">
          <div class="glass card p-4 c-profile">
            <div class="section-title mb-2">${L('profile')}</div>
            <div class="col">
              <label>${L('name')}<input id="name" class="field" value="${esc(state.profile.name)}" placeholder="${L('name')}"></label>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('age')}<input id="age" ${num()} value="${esc(state.profile.age)}"></label>
                <label>${L('sex')}
                  <select id="sex" class="field">
                    ${option('Male',L('male'))}${option('Female',L('female'))}
                  </select>
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('height')}<input id="height" ${num()} value="${esc(state.profile.height)}"></label>
                <label>${L('weight')}<input id="weight" ${num()} value="${esc(state.profile.weight)}"></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('bodyFat')}<input id="bodyFat" ${num()} value="${esc(state.profile.bodyFat)}"></label>
                <label>${L('waist')}<input id="waist" ${num()} value="${esc(state.profile.waist)}"></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('targetWeight')}<input id="targetWeight" ${num()} value="${esc(state.profile.targetWeight)}"></label>
                <label>${L('targetDate')}<input id="targetDate" type="date" class="field" value="${esc(state.profile.targetDate)}"></label>
              </div>
            </div>
          </div>

          <div class="glass card p-4 c-diet">
            <div class="section-title mb-2">${L('dietPrefs')}</div>
            <div class="col">
              <div>${L('goals')}</div>
              <div class="grid grid-cols-2 gap-2">
                ${goalChk('fatLoss')}${goalChk('build')}${goalChk('strength')}${goalChk('endurance')}${goalChk('health')}
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('mealsPerDay')}<input id="meals" ${num()} value="${esc(state.diet.mealsPerDay)}"></label>
                <label>${L('preferredDiet')}
                  <select id="prefDiet" class="field">
                    ${option('Balanced',L('balanced'))}
                    ${option('LowCarb',L('lowCarb'))}
                    ${option('Keto',L('keto'))}
                    ${option('Arabic/Mediter.',L('med'))}
                    ${option('Plant',L('veg'))}
                  </select>
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('fasting')}
                  <select id="fasting" class="field">
                    ${option('off',L('fastingOff'))}${option('16:8',L('fasting16'))}${option('18:6',L('fasting18'))}${option('20:4',L('fasting20'))}
                  </select>
                </label>
                <label>${L('cuisine')}<input id="cuisine" class="field" value="${esc(state.diet.cuisine)}"></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('prepTime')}<input id="prep" ${num()} value="${esc(state.diet.prepTime)}"></label>
                <label>${L('budget')} <div class="flex gap-2">
                  <input id="budget" ${num()} value="${esc(state.diet.monthlyBudget)}" class="field flex-1">
                  <select id="currency" class="field w-28">${currencyOptions(state.currency)}</select>
                </div></label>
              </div>
              <label>${L('foodsAvoid')}<input id="avoid" class="field" value="${esc(state.diet.foodsToAvoid)}" placeholder="Ù…Ø«Ø§Ù„: Ù„Ø§ Ø£Ø­Ø¨ Ø§Ù„Ø³Ù…ÙƒØŒ Ø­Ø³Ø§Ø³ÙŠØ© ÙØ³ØªÙ‚â€¦"></label>
              <label>${L('allergies')}<input id="allergies" class="field" value="${esc(state.diet.allergies)}" placeholder="Gluten, Lactose, Nuts â€¦"></label>
            </div>
          </div>

          <div class="glass card p-4 c-life">
            <div class="section-title mb-2">${L('lifestyle')}</div>
            <div class="col">
              <div class="grid grid-cols-2 gap-2">
                <label>${L('workActivity')}
                  <select id="work" class="field">
                    ${option('Sedentary',state.lang==='ar'?'Ù…ÙƒØªØ¨ÙŠ':'Sedentary')}
                    ${option('Light',state.lang==='ar'?'Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ':'Light')}
                    ${option('Moderate',state.lang==='ar'?'Ù…ØªÙˆØ³Ø·':'Moderate')}
                    ${option('High',state.lang==='ar'?'Ù…Ø±ØªÙØ¹':'High')}
                  </select>
                </label>
                <label>${L('steps')}<input id="steps" ${num()} value="${esc(state.lifestyle.stepsPerDay)}"></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('sleep')}
                  <select id="sleep" class="field">
                    ${option('Low',state.lang==='ar'?'Ù…Ù†Ø®ÙØ¶':'Low')}
                    ${option('Medium',state.lang==='ar'?'Ù…ØªÙˆØ³Ø·':'Medium')}
                    ${option('High',state.lang==='ar'?'Ù…Ø±ØªÙØ¹':'High')}
                  </select>
                </label>
                <label>${L('stress')}
                  <select id="stress" class="field">
                    ${option('Low',state.lang==='ar'?'Ù…Ù†Ø®ÙØ¶':'Low')}
                    ${option('Medium',state.lang==='ar'?'Ù…ØªÙˆØ³Ø·':'Medium')}
                    ${option('High',state.lang==='ar'?'Ù…Ø±ØªÙØ¹':'High')}
                  </select>
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('place')}<input id="place" class="field" value="${esc(state.lifestyle.trainingPlace)}"></label>
                <label>${L('session')}<input id="session" ${num()} value="${esc(state.lifestyle.sessionLength)}"></label>
              </div>
              <div>
                <div class="mb-1">${L('days')}</div>
                <div class="grid grid-cols-7 gap-2 text-xs">
                  ${weekInputs()}
                </div>
              </div>
              <label>${L('equipment')}<input id="equip" class="field" value="${esc(state.lifestyle.equipment)}" placeholder="Dumbbells, barbell, bandsâ€¦"></label>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('experience')}
                  <select id="exp" class="field">
                    <option>Beginner (0-6m)</option>
                    <option>Intermediate (6-24m)</option>
                    <option>Advanced (24m+)</option>
                  </select>
                </label>
                <label>${L('rpe')}<input id="rpe" ${num()} value="${esc(state.lifestyle.rpe)}"></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('caffeine')}<input id="caf" ${num()} value="${esc(state.lifestyle.caffeine)}"></label>
                <label>${L('injuries')}<input id="inj" class="field" value="${esc(state.lifestyle.injuries)}" placeholder="Shoulder impingementâ€¦"></label>
              </div>
              <div class="divider my-2"></div>
              <div class="section-title mb-1">${L('quick')}</div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('restingHR')}<input id="q-hr" ${num()} value="${esc(state.fitness.restingHR)}"></label>
                <label>${L('pushups')}<input id="q-pu" ${num()} value="${esc(state.fitness.maxPushups)}"></label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label>${L('plank')}<input id="q-pl" ${num()} value="${esc(state.fitness.plank)}"></label>
                <label>${L('kmTime')}<input id="q-km" class="field" value="${esc(state.fitness.kmTime)}" placeholder="5:30"></label>
              </div>
            </div>
          </div>

          <div class="glass card p-4 c-med">
            <div class="section-title mb-2">${L('med')}</div>
            <div class="grid md:grid-cols-2 gap-2">
              <div class="col">
                <div class="section-title text-sm opacity-80">${L('musclesFocus')}</div>
                ${muscleInputs()}
              </div>
              <div class="col">
                <div class="section-title text-sm opacity-80">${L('medicalStatus')}</div>
                ${medicalInputs()}
                <label class="mt-2">${L('otherCond')}<input id="otherCond" class="field" value="${esc(state.medical.other)}"></label>
                <label>${L('currentMeds')}<input id="meds" class="field" value="${esc(state.medical.meds)}"></label>
                <label>${L('currentSupp')}<input id="supps" class="field" value="${esc(state.medical.supplements)}"></label>
                <label class="mt-2">${L('pastCh')}<input id="past" class="field" value="${esc(state.challenges.past)}" placeholder="Ø¬ÙˆØ¹ Ø´Ø¯ÙŠØ¯ØŒ Ù…Ù„Ù„ Ù…Ù† Ø§Ù„Ø·Ø¹Ø§Ù…ØŒ Ø¥ØµØ§Ø¨Ø§Øªâ€¦"></label>
                <label>${L('motiv')}
                  <select id="motiv" class="field">
                    ${option('Direct',L('motivDir'))}${option('Warm',L('motivWarm'))}
                  </select>
                </label>
              </div>
            </div>
          </div>
        </div>
      `;

      // Ø¶Ø¨Ø· Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
      $('sex').value = state.profile.sex || 'Male';
      $('prefDiet').value = state.diet.preferredDiet;
      $('fasting').value = state.diet.fasting;
      $('currency').value = state.currency;
      $('work').value = state.lifestyle.workActivity;
      $('sleep').value = state.lifestyle.sleep;
      $('stress').value = state.lifestyle.stress;
      $('exp').value = state.lifestyle.experience;
      $('motiv').value = state.challenges.motivation;

      // Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      $('prev').disabled = true; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¬ÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹
      $('next').classList.add('hidden');
      $('generate').classList.remove('hidden');
    }

    /***** Inputs builders *****/
    function weekInputs(){
      const days = (state.lang==='ar')? ['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'] : ['Sat','Sun','Mon','Tue','Wed','Thu','Fri'];
      return days.map((d,i)=>`<label class="flex items-center gap-1 bg-white/5 px-2 py-1 rounded-md border border-white/10">
        <input type="checkbox" id="day-${i}" class="accent-[var(--brand-2)]" ${state.lifestyle.availableDays.includes(i)?'checked':''}>
        <span>${d}</span>
      </label>`).join('');
    }
    function muscleInputs(){
      const map = [
        ['chest','Ø§Ù„ØµØ¯Ø±','Chest'],['back','Ø§Ù„Ø¸Ù‡Ø±','Back'],['shoulders','Ø§Ù„Ø£ÙƒØªØ§Ù','Shoulders'],
        ['biceps','Ø§Ù„Ø¨Ø§ÙŠØ³Ø¨Ø³','Biceps'],['triceps','Ø§Ù„ØªØ±Ø§ÙŠØ³Ø¨Ø³','Triceps'],['quads','Ø§Ù„Ø£Ø±Ø¬Ù„ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©','Quads'],
        ['hamstrings','Ø§Ù„Ø£Ø±Ø¬Ù„ Ø§Ù„Ø®Ù„ÙÙŠØ©','Hamstrings'],['glutes','Ø§Ù„Ù…Ø¤Ø®Ø±Ø©','Glutes'],['calves','Ø§Ù„Ø³Ù…Ø§Ù†Ø©','Calves'],['abs','Ø§Ù„Ø¨Ø·Ù†','Abs']
      ];
      return map.map(([k,ar,en])=>{
        const lab = (state.lang==='ar'?ar:en);
        const v = state.muscles[k]||{on:false,note:''};
        return `
          <div class="grid grid-cols-2 gap-2 items-center">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="m-${k}" class="accent-[var(--brand-2)]" ${v.on?'checked':''}>
              <span>${lab}</span>
            </label>
            <input id="mnote-${k}" class="field" placeholder="${t('describe')}" value="${esc(v.note)}">
          </div>
        `;
      }).join('');
    }
    function medicalInputs(){
      const items = [
        ['Hypertension','Ø¶ØºØ· Ø§Ù„Ø¯Ù…'],['Diabetes','Ø§Ù„Ø³ÙƒØ±ÙŠ'],['Insulin Resistance','Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†'],
        ['Thyroid issues','Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØºØ¯Ø©'],['Hormonal issues','Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©'],['Fatty Liver','Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ'],
        ['Joint/Knee problems','Ù…Ø´Ø§ÙƒÙ„ Ù…ÙØ§ØµÙ„/Ø±ÙƒØ¨'],['Heart disease','Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨'],['IBD/Ulcer','IBD/Ù‚Ø±Ø­Ø©'],
        ['GERD/Reflux','GERD/Ø§Ø±ØªØ¬Ø§Ø¹'],['Gluten intolerance','Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†'],['Lactose intolerance','Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²']
      ];
      return `<div class="grid md:grid-cols-2 gap-2">
        ${items.map(([en,ar],idx)=>{
          const lab = (state.lang==='ar')? ar : en;
          const id = \`cond-\${idx}\`;
          const checked = state.medical.conditions.includes(en)||state.medical.conditions.includes(ar);
          return \`<label class="flex items-center gap-2"><input id="\${id}" type="checkbox" \${checked?'checked':''} class="accent-[var(--brand-2)]"><span>\${lab}</span></label>\`;
        }).join('')}
      </div>`;
    }
    function currencyOptions(sel){
      const all = ['USD','EUR','GBP','SAR','AED','KWD','QAR','EGP'];
      return all.map(c=>`<option ${sel===c?'selected':''}>${c}</option>`).join('');
    }

    /***** Persist step data *****/
    function saveStep(){
      // Profile
      state.profile.name = val('name');
      state.profile.age = val('age');
      state.profile.height = val('height');
      state.profile.weight = val('weight');
      state.profile.bodyFat = val('bodyFat');
      state.profile.waist = val('waist');
      if($('sex')) state.profile.sex = $('sex').value;
      state.profile.targetWeight = val('targetWeight');
      state.profile.targetDate = val('targetDate');

      // Diet
      const goalInputs = [...document.querySelectorAll('input[data-goal]')];
      state.diet.goals = goalInputs.filter(i=>i.checked).map(i=>i.getAttribute('data-goal'));
      if($('meals')) state.diet.mealsPerDay = numVal('meals',3);
      if($('prefDiet')) state.diet.preferredDiet = $('prefDiet').value;
      if($('fasting')) state.diet.fasting = $('fasting').value;
      state.diet.cuisine = val('cuisine');
      state.diet.prepTime = numVal('prep',20);
      state.diet.monthlyBudget = numVal('budget',0);
      if($('currency')) state.currency = $('currency').value;
      state.diet.foodsToAvoid = val('avoid');
      state.diet.allergies = val('allergies');

      // Lifestyle
      if($('work')) state.lifestyle.workActivity = $('work').value;
      state.lifestyle.stepsPerDay = numVal('steps',6000);
      if($('sleep')) state.lifestyle.sleep = $('sleep').value;
      if($('stress')) state.lifestyle.stress = $('stress').value;
      state.lifestyle.trainingPlace = val('place');
      state.lifestyle.sessionLength = numVal('session',60);
      state.lifestyle.availableDays = [];
      for(let i=0;i<7;i++){ const d=$(`day-${i}`); if(d && d.checked) state.lifestyle.availableDays.push(i); }
      state.lifestyle.equipment = val('equip');
      if($('exp')) state.lifestyle.experience = $('exp').value;
      state.lifestyle.rpe = numVal('rpe',8);
      state.lifestyle.caffeine = numVal('caf',0);
      state.lifestyle.injuries = val('inj');
      // fitness
      state.fitness.restingHR = val('q-hr');
      state.fitness.maxPushups = val('q-pu');
      state.fitness.plank = val('q-pl');
      state.fitness.kmTime = val('q-km');
      // muscles
      const keys = Object.keys(state.muscles);
      keys.forEach(k=>{
        const ck = $(`m-${k}`), note = $(`mnote-${k}`);
        if(ck) state.muscles[k].on = ck.checked;
        if(note) state.muscles[k].note = note.value;
      });
      // medical
      state.medical.conditions = [];
      for(let i=0;i<12;i++){
        const id=`cond-${i}`; const el=$(id);
        if(el && el.checked){
          const map = ['Hypertension','Diabetes','Insulin Resistance','Thyroid issues','Hormonal issues','Fatty Liver','Joint/Knee problems','Heart disease','IBD/Ulcer','GERD/Reflux','Gluten intolerance','Lactose intolerance'];
          state.medical.conditions.push(map[i]);
        }
      }
      state.medical.other = val('otherCond');
      state.medical.meds = val('meds');
      state.medical.supplements = val('supps');
      state.challenges.past = val('past');
      if($('motiv')) state.challenges.motivation = $('motiv').value;

      persist();
    }

    /***** Navigation *****/
    $('next').onclick = ()=>{/* Ù…Ø®ÙÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹ */};
    $('prev').onclick = ()=>{/* Ù…Ø¹Ø·Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ */};
    $('generate').onclick = startGenerate;

    $('lang-ar').onclick = ()=>{ saveStep(); setLang('ar'); };
    $('lang-en').onclick = ()=>{ saveStep(); setLang('en'); };

    $('btn-print').onclick = ()=>window.print();
    $('print-bottom').onclick = ()=>window.print();
    $('scroll-top').onclick = ()=>window.scrollTo({top:0,behavior:'smooth'});

    /***** Toasts *****/
    function toast(msg, type='info'){
      const div = document.createElement('div');
      div.className='toast';
      div.innerHTML = `<div class="font-bold mb-1">${type==='err'?'âš ï¸':''} ${msg}</div>`;
      document.body.appendChild(div);
      $('live').textContent = msg;
      setTimeout(()=>div.remove(), 3500);
    }

    /***** Currency detect (region-first) *****/
    function detectCurrency(){
      try{
        const loc = Intl.DateTimeFormat().resolvedOptions().locale || navigator.language || 'en-US';
        const upper = loc.toUpperCase();
        if(upper.includes('AR-AE') || upper.includes('AE')) return 'AED';
        if(upper.includes('AR-SA') || upper.includes('SA')) return 'SAR';
        if(upper.includes('AR-EG') || upper.includes('EG')) return 'EGP';
        if(upper.includes('QA')) return 'QAR';
        if(upper.includes('KW')) return 'KWD';
        if(upper.includes('GB')) return 'GBP';
        if(upper.includes('DE')||upper.includes('FR')||upper.includes('IT')||upper.includes('ES')||upper.includes('EU')) return 'EUR';
        return 'USD';
      }catch{ return 'USD'; }
    }

    /***** Targets calc (Ù…Ø­Ø³Ù‘Ù†) *****/
    function computeTargets(){
      const p = state.profile, L = state.lifestyle, goals = state.diet.goals;
      const W=+p.weight||0, H=+p.height||0, A=+p.age||0;
      const male = (p.sex==='Male'||p.sex===t('male'));
      const BMR = male ? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161;
      const actMap = { 'Sedentary':1.2, 'Light':1.35, 'Moderate':1.5, 'High':1.7 };
      let TDEE = BMR * (actMap[L.workActivity] || 1.35);

      if(goals.includes('fatLoss')) TDEE *= 0.85;
      if(goals.includes('build'))   TDEE *= 1.10;

      const bf = +p.bodyFat || null;
      const LM = bf ? W*(1-bf/100) : (p.targetWeight? +p.targetWeight : W*0.8);

      let protein = Math.round(2.0 * Math.max(LM, 40));      // g
      let fat     = Math.round(Math.max(0.8*W, 40));         // g
      let carbs   = Math.round((TDEE - (protein*4 + fat*9))/4);

      const hasIR = state.medical.conditions.some(c=>c==='Diabetes' || c==='Insulin Resistance');
      if(hasIR) carbs = Math.min(carbs, 120);
      carbs = Math.max(40, carbs);

      const kcalPF = protein*4 + fat*9;
      const rest = Math.round(TDEE - (kcalPF + carbs*4));
      if(rest > 20) carbs += Math.round(rest/4);
      if(rest < -20) fat = Math.max(40, Math.round((kcalPF + carbs*4 + rest - protein*4)/9));

      return { bmr:Math.round(BMR), tdee:Math.round(TDEE), protein_g:protein, fat_g:fat, carb_g:carbs };
    }

    /***** AI calls (Ù…Ù‡Ù„Ø© + Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©) *****/
    async function callAI(prompt, retries=2){
      const ctrl = new AbortController();
      const timer = setTimeout(()=>ctrl.abort(), 45_000);
      try{
        const res = await fetch('/.netlify/functions/gemini-proxy', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ prompt }), signal: ctrl.signal
        });
        if(!res.ok) throw new Error('Bad response: '+res.status);
        const data = await res.json();
        return { ok:true, text:data.text };
      }catch(e){
        if(retries>0) return await callAI(prompt, retries-1);
        return { ok:false, error:String(e) };
      }finally{ clearTimeout(timer); }
    }

    /***** Prompt builder (ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù…ÙØ§ØªÙŠØ­) *****/
    function buildPrompt(section, extra={}){
      const lang = state.lang;
      const L = (k)=>t(k);
      const P = state.profile, D = state.diet, Ls = state.lifestyle, F = state.fitness;
      const targets = state.targets;
      const weak = Object.entries(state.muscles).filter(([k,v])=>v.on).map(([k,v])=>`${k}: ${v.note}`).join(', ') || 'None';
      const med = state.medical.conditions.join(', ') || 'None';
      const allergies = (D.allergies || 'None');
      const avoid = (D.foodsToAvoid || 'None');
      const days = (state.lang==='ar')? ['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'] : ['Sat','Sun','Mon','Tue','Wed','Thu','Fri'];
      const avail = Ls.availableDays.map(i=>days[i]).join(', ') || (state.lang==='ar'?'ØºÙŠØ± Ù…Ø­Ø¯Ø¯':'Not specified');
      const tone = state.challenges.motivation==='Direct' ? (lang==='ar'?'Ø¹Ù…Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø± Ø¨Ù„Ø§ Ù…Ø¨Ø§Ù„ØºØ©':'Pragmatic, direct, no fluff') : (lang==='ar'?'ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…':'Supportive & warm');

      const goalLabels = state.diet.goals.map(goalLabel).join(', ') || (state.lang==='ar'?'ØºÙŠØ± Ù…Ø­Ø¯Ø¯':'Not specified');

      const header = `
Name: ${P.name} | Sex: ${P.sex} | Age: ${P.age} | H: ${P.height}cm | W: ${P.weight}kg | BodyFat%: ${P.bodyFat||'n/a'} | Waist: ${P.waist||'n/a'}
Goals: ${goalLabels} | Preferred diet: ${D.preferredDiet} | Meals/day: ${D.mealsPerDay} | Fasting: ${D.fasting}
Cuisine: ${D.cuisine} | Prep time: ${D.prepTime}min | Budget: ${state.currency} ${D.monthlyBudget}
Work/Activity: ${Ls.workActivity} | Steps/day: ${Ls.stepsPerDay} | Sleep: ${Ls.sleep} | Stress: ${Ls.stress}
Training place: ${Ls.trainingPlace} | Session length: ${Ls.sessionLength}min | Available days: ${avail} | RPE: ${Ls.rpe} | Equipment: ${Ls.equipment||'Bodyweight'}
Fitness test: HR ${F.restingHR||'?'}, Push-ups ${F.maxPushups||'?'}, Plank ${F.plank||'?'}, 1km ${F.kmTime||'?'}
Weak muscles: ${weak} | Injuries: ${Ls.injuries || 'None'}
Medical: ${med} | Other: ${state.medical.other||'None'} | Meds: ${state.medical.meds||'None'} | Supplements: ${state.medical.supplements||'None'}
Allergies: ${allergies} | Dislikes: ${avoid}
Energy targets: ~${targets.tdee} kcal/day | Macros: P ${targets.protein_g}g / F ${targets.fat_g}g / C ${targets.carb_g}g
Tone: ${tone}.
LANGUAGE: ${lang}. ALL FOOD IN ${lang}. EXERCISES NAMES IN ENGLISH ONLY.
      `.trim();

      if(section==='welcome'){
        return `${header}

Create a short warm ${lang} welcome for the user by name ONLY ONCE, congratulate the commitment, and preview what the plan includes. Do not repeat welcome later. Keep it crisp and professional.`;
      }
      if(section==='analysis'){
        return `${header}

Write a concise ${lang} analysis of the user's situation (goals, health, constraints) and explain the logic behind the plan and energy/macros numbers. Use bullet points.`;
      }
      if(section==='allowed'){
        return `${header}

List in ${lang} two bullet lists: 
1) Allowed / Recommended foods (by cuisine), 
2) Limits / to avoid (honor allergies and dislikes).
Keep it practical.`;
      }
      if(section==='fasting' && D.fasting!=='off'){
        return `${header}

Explain in ${lang} how to implement Intermittent Fasting (${D.fasting}) safely with tips, hydration, caffeine timing, and training timing.`;
      }
      if(section==='nutrition-day'){
        const day = extra.day;
        return `${header}

Build the ${lang} nutrition plan for Day ${day} (of 7). 
- Provide 3â€“${D.mealsPerDay} meals + 1â€“2 snacks as needed.
- For each meal show a table row with: Meal | Ingredients (with grams) | kcal | Protein | Fat | Carbs.
- Finish with a summary row for total daily kcal and macros; must match the macro targets within Â±10%.
- Mark each main meal with [SWAP:MEAL:<meal-name>] to allow swapping later.`;
      }
      if(section==='training-day'){
        const day = extra.day;
        return `${header}

Build the ${lang} training plan for Day ${day} (of 7) matching the user's experience and injuries.
- Provide a Markdown table: Day | Exercise (English) | Sets | Reps | Rest (sec).
- Include warm-up note if needed.
- Ensure exercise selection respects injuries and focuses on weak muscles.
- Mark each exercise with [SWAP:EXERCISE:<exercise>].`;
      }
      if(section==='supplements'){
        return `${header}

Suggest evidence-based supplements in ${lang} with doses and timing:
- Essential stack, Goal-specific stack (fat loss/strength), Budget option.
- Consider medical conditions and possible interactions with common meds.
- Add a short disclaimer to consult a physician if uncertain.`;
      }
      if(section==='progression'){
        return `${header}

Describe in ${lang} a clear progression model for 8â€“12 weeks: how to adjust weights, reps, rest, deloads, cardio minutes, and how to re-estimate TDEE if weight changes.`;
      }
      if(section==='troubleshoot'){
        return `${header}

Write in ${lang} a troubleshooting section: hunger, plateaus, poor sleep, high stress, cravings, travel, eating out. Provide 2â€“3 bullet solutions each.`;
      }
      if(section==='safety'){
        return `${header}

Add ${lang} safety notes: technique reminders, injury prevention, hydration, sleep hygiene, and when to stop a session and seek medical advice.`;
      }
      if(section==='closing'){
        return `${header}

End with a short ${lang} motivating closing paragraph (no repeated welcome). Address the user by name.`;
      }
      return header;
    }

    /***** Generate plan (section-by-section) *****/
    async function startGenerate(){
      saveStep();
      // Ù…Ø¯Ø®Ù„Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© + Ù†Ø·Ø§Ù‚Ø§Øª Ù…Ù†Ø·Ù‚ÙŠØ©
      const age=+state.profile.age, h=+state.profile.height, w=+state.profile.weight;
      if(!(state.profile.name && age && h && w)){
        toast(t('needBasics'),'err'); return;
      }
      if(age<10 || age>90){ toast('âš ï¸ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù…Ø±', 'err'); return; }
      if(h<120 || h>230){ toast('âš ï¸ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·ÙˆÙ„ (120-230Ø³Ù…)', 'err'); return; }
      if(w<35 || w>250){ toast('âš ï¸ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ²Ù† (35-250ÙƒØº)', 'err'); return; }

      state.targets = computeTargets();
      state.generating = true;
      $('overlay').style.display='flex';
      $('overlay').setAttribute('aria-hidden','false');
      $('plan-empty').style.display='none';
      $('plan-content').innerHTML='';
      const bar = $('ov-bar'), gbar = $('global-progress');
      const progBars = [bar.parentElement, gbar.parentElement];

      const sections = ['welcome','analysis','allowed', ...(state.diet.fasting!=='off'?['fasting']:[]),
                        ...Array.from({length:7},(_,i)=>`nutrition-day-${i+1}`),
                        ...Array.from({length:7},(_,i)=>`training-day-${i+1}`),
                        'supplements','progression','troubleshoot','safety','closing'];
      let done = 0;
      for(const s of sections){
        const pct = Math.round((done/sections.length)*100);
        bar.style.width = pct+'%'; gbar.style.width = pct+'%';
        progBars.forEach(pb=>pb.setAttribute('aria-valuenow', String(pct)));

        let section = s, extra={};
        if(s.startsWith('nutrition-day')){ section='nutrition-day'; extra.day=Number(s.split('-').pop()); }
        if(s.startsWith('training-day')){ section='training-day'; extra.day=Number(s.split('-').pop()); }
        const prompt = buildPrompt(section, extra);
        const {ok, text, error} = await callAI(prompt);
        if(!ok){ toast(t('failed'),'err'); console.error(error); break; }
        appendToPlan(text);
        done++;
      }
      bar.style.width='100%'; gbar.style.width='100%';
      progBars.forEach(pb=>pb.setAttribute('aria-valuenow', '100'));
      $('overlay').style.display='none';
      $('overlay').setAttribute('aria-hidden','true');
      state.generating=false;
      $('plan').scrollIntoView({behavior:'smooth'});
    }

    /***** Safe append *****/
    function appendToPlan(markdown){
      const unsafe = marked.parse(markdown||'');
      const safe = DOMPurify.sanitize(unsafe, {USE_PROFILES:{html:true}});
      const wrap = $('plan-content');
      const sec = document.createElement('div');
      sec.className='mb-6';
      sec.innerHTML = safe;
      wrap.appendChild(sec);
    }

    /***** Persistence (localStorage) *****/
    const STORAGE_KEY='ihc_state_v1';
    function persist(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{} }
    function restore(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){ 
          const s = JSON.parse(raw);
          // Ø§Ù†Ø¯Ù…Ø¬ Ø¨Ø£Ù…Ø§Ù† (Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙŠØ©)
          Object.assign(state, s);
          // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„Ø©
          state.profile = Object.assign({ name:'', age:'', height:'', weight:'', bodyFat:'', waist:'', sex:'Male', targetWeight:'', targetDate:'' }, state.profile||{});
          state.diet = Object.assign({ goals:[], mealsPerDay:3, preferredDiet:'Balanced', cuisine:'Arabic/Mediter.', prepTime:20, monthlyBudget:0, foodsToAvoid:'', allergies:'', fasting:'off' }, state.diet||{});
          state.lifestyle = Object.assign({ workActivity:'Sedentary', stepsPerDay:6000, sleep:'Low', stress:'Low', trainingPlace:'Home/Gym', sessionLength:60, availableDays:[], equipment:'', experience:'Beginner (0-6m)', rpe:8, caffeine:0, injuries:'' }, state.lifestyle||{});
          state.fitness = Object.assign({ restingHR:'', maxPushups:'', plank:'', kmTime:'' }, state.fitness||{});
          state.medical = Object.assign({ conditions:[], other:'', meds:'', supplements:'' }, state.medical||{});
          state.challenges = Object.assign({ past:'', motivation:'Direct' }, state.challenges||{});
          if(!Array.isArray(state.diet.goals)) state.diet.goals=[];
          if(!Array.isArray(state.lifestyle.availableDays)) state.lifestyle.availableDays=[];
        }
      }catch{}
    }
    document.addEventListener('input', ()=>{ persist(); }, {capture:true});

    /***** Init *****/
    window.addEventListener('load', ()=>{
      restore();
      setLang(state.lang); // renderStep Ø¯Ø§Ø®Ù„ setLang
    });
  </script>
</body>
</html>
