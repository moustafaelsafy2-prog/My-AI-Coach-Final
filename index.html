<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ | Intelligent Health Coach</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Marked + DOMPurify (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ§Ù† Ù…Ø¹ Fallback Ø¢Ù…Ù†) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>

  <style>
    :root{
      --brand:#6c5ce7; --brand-2:#00c2ff;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      --card:#0b1220; --muted:#93a2b8;
    }
    html[dir="rtl"] body{ font-family: Tajawal, system-ui, -apple-system, Segoe UI, Roboto, "Noto Naskh Arabic", sans-serif; }
    html[dir="ltr"] body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; }

    body{ background:linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%); color:#eaf0ff; }
    .glass{ background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); }
    .title-grad{ background:linear-gradient(90deg,var(--brand),var(--brand-2)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; font-weight:800; border-radius:.8rem; padding:.7rem 1rem; }
    .btn-primary{ background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#fff; }
    .btn-ghost{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); }
    .field{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:.7rem; padding:.65rem .8rem; outline:none; width:100%; color:#eaf0ff; }
    .field:focus{ border-color:var(--brand-2); box-shadow:0 0 0 3px rgba(0,194,255,.15); }
    .chip{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:999px; padding:.35rem .6rem; font-size:.75rem; }

    /* ØªÙ‚Ø¯Ù… */
    .progress{ height:.4rem; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; }
    .progress > i{ display:block; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); width:0%; transition:width .25s ease; }

    /* Ù…Ø®Ø·Ø· Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
    .status-dot{ width:.6rem; height:.6rem; border-radius:999px; display:inline-block; }
    .st-pending{ background:#64748b }
    .st-running{ background:var(--warn) }
    .st-done{ background:var(--ok) }
    .st-fail{ background:var(--err) }

    /* Markdown Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®Ø·Ø© */
    .ai-content h2{ font-weight:900; font-size:1.35rem; margin:.6rem 0; color:#eaf0ff }
    .ai-content h3{ font-weight:800; font-size:1.1rem; margin:.5rem 0; color:#d7e3fb }
    .ai-content table{ border-collapse:collapse; width:100%; background:rgba(255,255,255,.04); margin:.6rem 0; }
    .ai-content th,.ai-content td{ border:1px solid rgba(255,255,255,.14); padding:.5rem; vertical-align:top; }
    .ai-content th{ background:rgba(255,255,255,.08); font-weight:800 }

    /* Ø·Ø¨Ø§Ø¹Ø© */
    @media print{
      body{ background:#fff; color:#111 }
      #sticky, #bar, #actions { display:none !important; }
      #plan { border:0; box-shadow:none; }
      .ai-content th,.ai-content td{ border-color:#333; color:#111 }
      .ai-content th{ background:#f3f4f6 }
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù…Ø³: ØªÙƒØ¨ÙŠØ± Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù„Ù…Ø³ */
    @media (hover:none){
      .btn, .chip, .field{ font-size:1rem }
      .chip{ padding:.45rem .7rem }
    }
  </style>
</head>
<body>

  <!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
  <header id="bar" class="sticky top-0 z-40 glass border-b border-white/10 backdrop-blur">
    <div class="max-w-6xl mx-auto px-3 md:px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-[var(--brand)] to-[var(--brand-2)] grid place-items-center font-black">AI</div>
        <div>
          <div id="app-title" class="text-base md:text-lg font-extrabold">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ</div>
          <div class="hidden md:block text-xs text-[color:var(--muted)]" id="subtitle">Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù % Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€“ Ù…Ø®ØµØµØ© Ù„Ùƒ</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="lang-ar" class="chip" type="button">Ø¹Ø±Ø¨Ù‰</button>
        <button id="lang-en" class="chip" type="button">EN</button>
        <button id="toggle-theme" class="chip" type="button">â˜¾</button>
        <button id="btn-print" class="btn btn-ghost" type="button">ğŸ–¨ï¸ <span id="t-print">Ø·Ø¨Ø§Ø¹Ø©</span></button>
      </div>
    </div>
    <!-- Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… Ù„Ø²Ù…Ù† Ø§Ù„ØªÙˆÙ„ÙŠØ¯ -->
    <div id="sticky" class="border-t border-white/10">
      <div class="max-w-6xl mx-auto px-3 md:px-4 py-2 flex items-center justify-between gap-3">
        <div class="text-xs text-[color:var(--muted)]" id="hint">Ø§Ù„ØªÙ‚Ø¯Ù…</div>
        <div class="w-40 md:w-60 progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><i id="global-progress"></i></div>
      </div>
    </div>
  </header>

  <!-- Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <main class="max-w-6xl mx-auto px-3 md:px-4 py-5">

    <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø´Ø¨ÙƒØ© Ù…Ø±Ù†Ø©: Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ØŒ 3 Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù„Ù‰ md+) -->
    <section class="glass rounded-2xl p-4 md:p-5 mb-4">
      <div class="text-xl title-grad font-extrabold mb-3" id="step-title">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">

        <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
        <div class="glass rounded-xl p-4">
          <div class="font-extrabold mb-2">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
          <div class="space-y-2">
            <label class="block text-sm">Ø§Ù„Ø§Ø³Ù…
              <input id="name" class="field mt-1" placeholder="Ø§Ù„Ø§Ø³Ù…" />
            </label>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm">Ø§Ù„Ø¹Ù…Ø±
                <input id="age" class="field mt-1" inputmode="numeric" pattern="[0-9]*" />
              </label>
              <label class="block text-sm">Ø§Ù„Ø¬Ù†Ø³
                <select id="sex" class="field mt-1">
                  <option value="Male">Ø°ÙƒØ±</option>
                  <option value="Female">Ø£Ù†Ø«Ù‰</option>
                </select>
              </label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)
                <input id="height" class="field mt-1" inputmode="numeric" pattern="[0-9]*" />
              </label>
              <label class="block text-sm">Ø§Ù„ÙˆØ²Ù† (ÙƒØº)
                <input id="weight" class="field mt-1" inputmode="numeric" pattern="[0-9]*" />
              </label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† % (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                <input id="bodyFat" class="field mt-1" inputmode="numeric" pattern="[0-9]*" />
              </label>
              <label class="block text-sm">Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ± (Ø³Ù…) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                <input id="waist" class="field mt-1" inputmode="numeric" pattern="[0-9]*" />
              </label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (ÙƒØº)
                <input id="targetWeight" class="field mt-1" inputmode="numeric" pattern="[0-9]*" />
              </label>
              <label class="block text-sm">Ù…ÙˆØ¹Ø¯ ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù
                <input id="targetDate" type="date" class="field mt-1" />
              </label>
            </div>
          </div>
        </div>

        <!-- Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ -->
        <div class="glass rounded-xl p-4">
          <div class="font-extrabold mb-2">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª</div>
          <div class="space-y-2">
            <div class="text-sm">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ù…ØªØ¹Ø¯Ø¯)</div>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <label><input type="checkbox" class="goal" value="fatLoss" /> Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†</label>
              <label><input type="checkbox" class="goal" value="build" /> Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª</label>
              <label><input type="checkbox" class="goal" value="strength" /> Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©</label>
              <label><input type="checkbox" class="goal" value="endurance" /> ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„</label>
              <label><input type="checkbox" class="goal" value="health" /> ØµØ­Ø© Ø¹Ø§Ù…Ø©</label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª
                <input id="meals" class="field mt-1" inputmode="numeric" pattern="[0-9]*" value="3" />
              </label>
              <label class="block text-sm">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù‘Ù„
                <select id="prefDiet" class="field mt-1">
                  <option value="Balanced">Ù†Ø¸Ø§Ù… Ù…ØªÙˆØ§Ø²Ù†</option>
                  <option value="LowCarb">Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª</option>
                  <option value="Keto">ÙƒÙŠØªÙˆ</option>
                  <option value="Arabic/Mediter.">Ù…ØªÙˆØ³Ø·ÙŠ/Ø¹Ø±Ø¨ÙŠ</option>
                  <option value="Plant">Ù†Ø¨Ø§ØªÙŠ/Ù…Ø±Ù†</option>
                </select>
              </label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm">Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹
                <select id="fasting" class="field mt-1">
                  <option value="off">ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</option>
                  <option value="16:8">16:8</option>
                  <option value="18:6">18:6</option>
                  <option value="20:4">20:4</option>
                </select>
              </label>
              <label class="block text-sm">Ø§Ù„Ù…Ø·Ø¨Ø®
                <input id="cuisine" class="field mt-1" value="Arabic/Mediter." />
              </label>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="block text-sm">Ø²Ù…Ù† Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø¯)
                <input id="prep" class="field mt-1" inputmode="numeric" pattern="[0-9]*" value="20" />
              </label>
              <label class="block text-sm">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
                <div class="flex gap-2 mt-1">
                  <input id="budget" class="field flex-1" inputmode="numeric" pattern="[0-9]*" value="0" />
                  <select id="currency" class="field w-28">
                    <option>USD</option><option>EUR</option><option>GBP</option>
                    <option>SAR</option><option>AED</option><option>KWD</option><option>QAR</option><option>EGP</option>
                  </select>
                </div>
              </label>
            </div>
            <label class="block text-sm">Ø£Ø·Ø¹Ù…Ø© Ù„Ø§ ØªØ±ØºØ¨ Ø¨Ù‡Ø§/Ø­Ø³Ø§Ø³ÙŠØ§Øª
              <input id="avoid" class="field mt-1" placeholder="Ù…Ø«Ø§Ù„: Ù„Ø§ Ø£Ø­Ø¨ Ø§Ù„Ø³Ù…ÙƒØŒ Ø­Ø³Ø§Ø³ÙŠØ© ÙØ³ØªÙ‚â€¦" />
            </label>
            <label class="block text-sm">Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø´Ø§Ø¦Ø¹Ø©
              <input id="allergies" class="field mt-1" placeholder="Gluten, Lactose, Nutsâ€¦" />
            </label>
          </div>
        </div>

        <!-- Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØµØ­Ø© -->
        <div class="space-y-3">
          <div class="glass rounded-xl p-4">
            <div class="font-extrabold mb-2">Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨</div>
            <div class="space-y-2">
              <div class="grid grid-cols-2 gap-2">
                <label class="block text-sm">Ø§Ù„Ø¹Ù…Ù„/Ø§Ù„Ù†Ø´Ø§Ø·
                  <select id="work" class="field mt-1">
                    <option value="Sedentary">Ù…ÙƒØªØ¨ÙŠ</option>
                    <option value="Light">Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ</option>
                    <option value="Moderate">Ù…ØªÙˆØ³Ø·</option>
                    <option value="High">Ù…Ø±ØªÙØ¹</option>
                  </select>
                </label>
                <label class="block text-sm">Ø®Ø·ÙˆØ§Øª/Ø§Ù„ÙŠÙˆÙ…
                  <input id="steps" class="field mt-1" inputmode="numeric" pattern="[0-9]*" value="6000" />
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label class="block text-sm">Ø§Ù„Ù†ÙˆÙ…
                  <select id="sleep" class="field mt-1"><option>Low</option><option>Medium</option><option>High</option></select>
                </label>
                <label class="block text-sm">Ø§Ù„ØªÙˆØªØ±
                  <select id="stress" class="field mt-1"><option>Low</option><option>Medium</option><option>High</option></select>
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label class="block text-sm">Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ…Ø±ÙŠÙ†
                  <input id="place" class="field mt-1" value="Home/Gym" />
                </label>
                <label class="block text-sm">Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯)
                  <input id="session" class="field mt-1" inputmode="numeric" pattern="[0-9]*" value="60" />
                </label>
              </div>
              <div class="text-sm">Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
              <div class="grid grid-cols-7 gap-2 text-xs">
                <label class="chip"><input type="checkbox" id="d0" class="mr-1" /> Ø³</label>
                <label class="chip"><input type="checkbox" id="d1" class="mr-1" /> Ø­</label>
                <label class="chip"><input type="checkbox" id="d2" class="mr-1" /> Ù†</label>
                <label class="chip"><input type="checkbox" id="d3" class="mr-1" /> Ø«</label>
                <label class="chip"><input type="checkbox" id="d4" class="mr-1" /> Ø±</label>
                <label class="chip"><input type="checkbox" id="d5" class="mr-1" /> Ø®</label>
                <label class="chip"><input type="checkbox" id="d6" class="mr-1" /> Ø¬</label>
              </div>
              <label class="block text-sm">Ø§Ù„Ù…Ø¹Ø¯Ø§Øª
                <input id="equip" class="field mt-1" placeholder="Dumbbells, barbell, bandsâ€¦" />
              </label>
              <div class="grid grid-cols-2 gap-2">
                <label class="block text-sm">Ø§Ù„Ø®Ø¨Ø±Ø©
                  <select id="exp" class="field mt-1"><option>Beginner (0-6m)</option><option>Intermediate (6-24m)</option><option>Advanced (24m+)</option></select>
                </label>
                <label class="block text-sm">RPE
                  <input id="rpe" class="field mt-1" inputmode="numeric" pattern="[0-9]*" value="8" />
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label class="block text-sm">ÙƒØ§ÙÙŠÙŠÙ†/Ø§Ù„ÙŠÙˆÙ…
                  <input id="caf" class="field mt-1" inputmode="numeric" pattern="[0-9]*" value="0" />
                </label>
                <label class="block text-sm">Ø¥ØµØ§Ø¨Ø§Øª/Ù‚ÙŠÙˆØ¯
                  <input id="inj" class="field mt-1" placeholder="Shoulder impingementâ€¦" />
                </label>
              </div>
            </div>
          </div>

          <div class="glass rounded-xl p-4">
            <div class="font-extrabold mb-2">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª</div>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <label><input type="checkbox" class="cond" value="Hypertension" /> Ø¶ØºØ· Ø§Ù„Ø¯Ù…</label>
              <label><input type="checkbox" class="cond" value="Diabetes" /> Ø§Ù„Ø³ÙƒØ±ÙŠ</label>
              <label><input type="checkbox" class="cond" value="Insulin Resistance" /> Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†</label>
              <label><input type="checkbox" class="cond" value="Thyroid issues" /> Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØºØ¯Ø©</label>
              <label><input type="checkbox" class="cond" value="Hormonal issues" /> Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©</label>
              <label><input type="checkbox" class="cond" value="Fatty Liver" /> Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ</label>
              <label><input type="checkbox" class="cond" value="Joint/Knee problems" /> Ù…ÙØ§ØµÙ„/Ø±ÙƒØ¨</label>
              <label><input type="checkbox" class="cond" value="Heart disease" /> Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨</label>
              <label><input type="checkbox" class="cond" value="IBD/Ulcer" /> IBD/Ù‚Ø±Ø­Ø©</label>
              <label><input type="checkbox" class="cond" value="GERD/Reflux" /> GERD/Ø§Ø±ØªØ¬Ø§Ø¹</label>
              <label><input type="checkbox" class="cond" value="Gluten intolerance" /> Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†</label>
              <label><input type="checkbox" class="cond" value="Lactose intolerance" /> Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²</label>
            </div>
            <div class="mt-2 space-y-2">
              <label class="block text-sm">Ø£Ù…Ø±Ø§Ø¶ Ø£Ø®Ø±Ù‰
                <input id="otherCond" class="field mt-1" />
              </label>
              <label class="block text-sm">Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ©
                <input id="meds" class="field mt-1" />
              </label>
              <label class="block text-sm">Ù…ÙƒÙ…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ©
                <input id="supps" class="field mt-1" />
              </label>
              <label class="block text-sm">ØªØ­Ø¯ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
                <input id="past" class="field mt-1" placeholder="Ø¬ÙˆØ¹ Ø´Ø¯ÙŠØ¯ØŒ Ù…Ù„Ù„ Ù…Ù† Ø§Ù„Ø·Ø¹Ø§Ù…ØŒ Ø¥ØµØ§Ø¨Ø§Øªâ€¦" />
              </label>
              <label class="block text-sm">Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØ­ÙÙŠØ²
                <select id="motiv" class="field mt-1">
                  <option value="Direct">Ø¹Ù…Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±</option>
                  <option value="Warm">ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…</option>
                </select>
              </label>
            </div>
          </div>
        </div>

      </div>

      <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙˆÙ„ÙŠØ¯ -->
      <div class="mt-4 flex items-center justify-between">
        <button id="cancel" class="btn btn-ghost hidden" type="button">âœ– Ø¥Ù„ØºØ§Ø¡</button>
        <div class="flex items-center gap-2">
          <button id="generate" class="btn btn-primary" type="button">âš¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©</button>
        </div>
      </div>
    </section>

    <!-- Ù…Ø®Ø·Ø· Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
    <section class="glass rounded-2xl p-4 md:p-5 mb-4">
      <div class="font-extrabold mb-2">ØªÙ‚Ø¯Ù… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ (Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù…)</div>
      <div id="timeline" class="flex flex-wrap gap-2 text-xs"></div>
    </section>

    <!-- Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ø®Ø·Ø© -->
    <section id="plan" class="glass rounded-2xl p-4 md:p-5">
      <div id="plan-empty" class="text-sm text-[color:var(--muted)]">â€” Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù‡Ù†Ø§ Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø± Ø¹Ù†Ø¯ ØªÙˆÙ„ÙŠØ¯Ù‡Ø§ â€”</div>
      <div id="plan-content" class="ai-content"></div>
      <div id="actions" class="mt-5 flex items-center justify-end gap-2">
        <button class="btn btn-ghost" id="scroll-top" type="button">â†‘ Ø£Ø¹Ù„Ù‰</button>
        <button class="btn btn-primary" id="print-bottom" type="button">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
      </div>
    </section>
  </main>

  <script>
    /* ========= Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø§Ù… ========= */
    const hasMarked = !!window.marked;
    const hasDOMPurify = !!window.DOMPurify;
    if (hasMarked) { try { marked.setOptions({ breaks:true, mangle:false, headerIds:false }); } catch(_){} }

    const state = {
      lang: (navigator.language||'ar').startsWith('ar')?'ar':'en',
      currency: detectCurrency(),
      cancelToken: null,
      profile:{}, diet:{}, lifestyle:{availableDays:[]}, fitness:{}, muscles:{}, medical:{}, challenges:{}
    };

    /* ========= Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ========= */
    const $ = (id)=>document.getElementById(id);
    const esc = s => (s??'').toString().replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));

    function detectCurrency(){
      try{
        const u=(Intl.DateTimeFormat().resolvedOptions().locale||navigator.language||'en-US').toUpperCase();
        if(u.includes('AE')) return 'AED'; if(u.includes('SA')) return 'SAR'; if(u.includes('EG')) return 'EGP';
        if(u.includes('QA')) return 'QAR'; if(u.includes('KW')) return 'KWD'; if(u.includes('GB')) return 'GBP';
        if(u.includes('DE')||u.includes('FR')||u.includes('IT')||u.includes('ES')||u.includes('EU')) return 'EUR';
        return 'USD';
      }catch{ return 'USD'; }
    }

    function readForm(){
      // profile
      const goals=[...document.querySelectorAll('.goal')].filter(x=>x.checked).map(x=>x.value);
      const cond=[...document.querySelectorAll('.cond')].filter(x=>x.checked).map(x=>x.value);
      state.profile = {
        name: $('name').value.trim(), age: $('age').value.trim(), height: $('height').value.trim(), weight: $('weight').value.trim(),
        bodyFat:$('bodyFat').value.trim(), waist:$('waist').value.trim(), sex:$('sex').value, targetWeight:$('targetWeight').value.trim(), targetDate:$('targetDate').value
      };
      state.diet = {
        goals, mealsPerDay: +($('meals').value||3), preferredDiet:$('prefDiet').value, cuisine:$('cuisine').value,
        prepTime:+($('prep').value||20), monthlyBudget:+($('budget').value||0), foodsToAvoid:$('avoid').value, allergies:$('allergies').value,
        fasting:$('fasting').value
      };
      const days=[]; for(let i=0;i<7;i++){ if($('d'+i).checked) days.push(i); }
      state.lifestyle = {
        workActivity:$('work').value, stepsPerDay:+($('steps').value||6000), sleep:$('sleep').value, stress:$('stress').value,
        trainingPlace:$('place').value, sessionLength:+($('session').value||60), availableDays:days,
        equipment:$('equip').value, experience:$('exp').value, rpe:+($('rpe').value||8), caffeine:+($('caf').value||0), injuries:$('inj').value
      };
      state.fitness = { restingHR:$('q-hr')?.value||'', maxPushups:$('q-pu')?.value||'', plank:$('q-pl')?.value||'', kmTime:$('q-km')?.value||'' };
      state.medical = { conditions:cond, other:$('otherCond').value, meds:$('meds').value, supplements:$('supps').value };
      state.challenges = { past:$('past').value, motivation:$('motiv').value };
      state.currency = $('currency').value;
    }

    function computeTargets(){
      const p=state.profile, L=state.lifestyle, goals=state.diet.goals||[];
      const W=+p.weight||0, H=+p.height||0, A=+p.age||0, male=(p.sex==='Male'||p.sex==='Ø°ÙƒØ±');
      const BMR = male ? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161;
      const act={Sedentary:1.2,Light:1.35,Moderate:1.5,High:1.7}[L.workActivity]||1.35;
      let TDEE=BMR*act; if(goals.includes('fatLoss')) TDEE*=0.85; if(goals.includes('build')) TDEE*=1.10;
      const bf=+p.bodyFat||null; const LM=bf? W*(1-bf/100):(p.targetWeight?+p.targetWeight:W*0.8);
      let protein=Math.round(2.0*Math.max(LM,40)), fat=Math.round(Math.max(0.8*W,40)), carb=Math.round((TDEE-(protein*4+fat*9))/4);
      if(state.medical.conditions?.some(c=>c==='Diabetes'||c==='Insulin Resistance')) carb=Math.min(carb,120);
      carb=Math.max(40,carb);
      return { bmr:Math.round(BMR), tdee:Math.round(TDEE), protein_g:protein, fat_g:fat, carb_g:carb };
    }

    /* ========= UI: Timeline ========= */
    const SECTION_ORDER = ()=>{
      const base=['welcome','analysis','allowed'];
      if((state.diet?.fasting||'off')!=='off') base.push('fasting');
      for(let i=1;i<=7;i++) base.push('nutrition-day-'+i);
      for(let i=1;i<=7;i++) base.push('training-day-'+i);
      base.push('supplements','progression','troubleshoot','safety','closing');
      return base;
    };
    const SECTION_TITLES_AR = {
      welcome:'ØªØ±Ø­ÙŠØ¨', analysis:'ØªØ­Ù„ÙŠÙ„', allowed:'Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹', fasting:'Ø§Ù„ØµÙŠØ§Ù…',
      'nutrition-day':'ØªØºØ°ÙŠØ© ÙŠÙˆÙ…', 'training-day':'ØªØ¯Ø±ÙŠØ¨ ÙŠÙˆÙ…',
      supplements:'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª', progression:'Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…', troubleshoot:'Ø§Ù„Ù…Ø´Ø§ÙƒÙ„', safety:'Ø§Ù„Ø³Ù„Ø§Ù…Ø©', closing:'Ø§Ù„Ø®ØªØ§Ù…'
    };

    function buildTimeline(sections){
      const wrap=$('timeline'); wrap.innerHTML='';
      sections.forEach(s=>{
        const item=document.createElement('div');
        item.className='flex items-center gap-2 px-2 py-1 rounded-lg bg-white/5 border border-white/10';
        item.dataset.key=s;
        const dot=`<span class="status-dot st-pending"></span>`;
        const lab = s.startsWith('nutrition-day') ? `${SECTION_TITLES_AR['nutrition-day']} ${s.split('-').pop()}`
                 : s.startsWith('training-day') ? `${SECTION_TITLES_AR['training-day']} ${s.split('-').pop()}`
                 : SECTION_TITLES_AR[s]||s;
        item.innerHTML = `${dot}<span class="font-semibold">${lab}</span>`;
        wrap.appendChild(item);
      });
    }
    function setTimelineStatus(key,status){
      const el=[...$('timeline').children].find(x=>x.dataset.key===key);
      if(!el) return;
      const dot=el.querySelector('.status-dot');
      dot.className='status-dot '+(status==='run'?'st-running':status==='ok'?'st-done':status==='fail'?'st-fail':'st-pending');
    }

    /* ========= Markdown Safe ========= */
    const simpleMD = (md)=> (md||'').split(/\n{2,}/).map(p=>`<p>${esc(p).replace(/\n/g,'<br>')}</p>`).join('\n');
    function renderMarkdown(md){
      let html = hasMarked ? marked.parse(md||'') : simpleMD(md);
      if(hasDOMPurify) html = DOMPurify.sanitize(html, {USE_PROFILES:{html:true}});
      return html;
    }

    /* ========= AI Call ========= */
    async function callAI(prompt,{retries=1, timeoutMs=45000, signal}={}){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      const combo = signal ? new AbortController() : null;
      if(signal){
        signal.addEventListener('abort', ()=>combo.abort(), {once:true});
        ctrl.signal.addEventListener('abort', ()=>combo.abort(), {once:true});
      }
      try{
        const res = await fetch('/.netlify/functions/gemini-proxy',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ prompt }),
          signal: combo? combo.signal : ctrl.signal
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        return { ok:true, text:data.text };
      }catch(e){
        if(retries>0) return await callAI(prompt,{retries:retries-1, timeoutMs, signal});
        return { ok:false, error:String(e) };
      }finally{ clearTimeout(t); }
    }

    /* ========= Prompts ========= */
    function buildPrompt(section, extra={}){
      const P=state.profile, D=state.diet, L=state.lifestyle, F=state.fitness||{}, T=computeTargets();
      state.targets=T;
      const days=['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'];
      const avail=L.availableDays.map(i=>days[i]).join(', ')||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const med=(state.medical.conditions||[]).join(', ')||'None';
      const weak='None';
      const header=`
Name:${P.name} | Sex:${P.sex} | Age:${P.age} | H:${P.height}cm | W:${P.weight}kg
Goals:${(D.goals||[]).join(', ')} | Diet:${D.preferredDiet} | Meals:${D.mealsPerDay} | IF:${D.fasting}
Cuisine:${D.cuisine} | Prep:${D.prepTime}min | Budget:${state.currency} ${D.monthlyBudget}
Activity:${L.workActivity} | Steps:${L.stepsPerDay} | Sleep:${L.sleep} | Stress:${L.stress}
Place:${L.trainingPlace} | Session:${L.sessionLength}min | Days:${avail} | RPE:${L.rpe} | Equip:${L.equipment||'Bodyweight'}
Fitness: HR ${F.restingHR||'?'} | PU ${F.maxPushups||'?'} | Plank ${F.plank||'?'} | 1km ${F.kmTime||'?'}
Weak:${weak} | Injuries:${L.injuries||'None'} | Medical:${med}
Allergies:${D.allergies||'None'} | Dislikes:${D.foodsToAvoid||'None'}
Targets: ~${T.tdee} kcal | P ${T.protein_g}g / F ${T.fat_g}g / C ${T.carb_g}g
LANGUAGE: ar. EXERCISES IN ENGLISH.`.trim();

      if(section==='welcome') return `${header}\n\nØ§ÙƒØªØ¨ ØªØ±Ø­ÙŠØ¨Ù‹Ø§ Ù‚ØµÙŠØ±Ù‹Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ„Ù…Ø­Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø©. Ù†Ø¨Ø±Ø© Ù…Ù‡Ù†ÙŠØ© Ù…Ø®ØªØµØ±Ø©.`;
      if(section==='analysis') return `${header}\n\nØ§ÙƒØªØ¨ ØªØ­Ù„ÙŠÙ„Ù‹Ø§ Ù…ÙˆØ¬Ø²Ù‹Ø§ Ø¨Ø§Ù„Ù†ÙÙ‘Ù‚Ø§Ø· Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ‚ÙŠÙˆØ¯Ù‡ ÙˆÙ…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø¹Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø§ÙƒØ±ÙˆØ².`;
      if(section==='allowed') return `${header}\n\nØ£Ù†Ø´Ø¦ Ù‚Ø§Ø¦Ù…ØªÙŠÙ†: 1) Ø£Ø·Ø¹Ù…Ø© ÙˆØªÙˆÙ„ÙŠÙØ§Øª Ù…Ù‚ØªØ±Ø­Ø© 2) Ø£Ø·Ø¹Ù…Ø© ÙŠÙØ¶Ù„ ØªØ¬Ù†Ø¨Ù‡Ø§ (ÙŠØ±Ø§Ø¹Ù‰ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©/Ø§Ù„Ù†ÙÙˆØ±).`;
      if(section==='fasting') return `${header}\n\nØ§Ø´Ø±Ø­ ÙƒÙŠÙÙŠØ© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹ (${D.fasting}) Ø¨Ø£Ù…Ø§Ù†: Ø³ÙˆØ§Ø¦Ù„/ÙƒØ§ÙÙŠÙŠÙ†/ØªÙˆÙ‚ÙŠØª Ø§Ù„ØªÙ…Ø±ÙŠÙ†.`;
      if(section==='nutrition-day'){ const d=extra.day; return `${header}\n\nØ®Ø·Ù‘Ø© Ø§Ù„ØªØºØ°ÙŠØ© Ù„ÙŠÙˆÙ… ${d} Ù…Ù† Ù§. Ø¬Ø¯ÙˆÙ„: Ø§Ù„ÙˆØ¬Ø¨Ø© | Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø¨Ø§Ù„Ø¬Ø±Ø§Ù… | kcal | Protein | Fat | Carbs. Ø£Ø®ØªÙ… Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠÙˆÙ…ÙŠ Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Â±10%). Ø¶Ø¹ ÙˆØ³Ù… [SWAP:MEAL:<name>] Ù„ÙƒÙ„ ÙˆØ¬Ø¨Ø© Ø±Ø¦ÙŠØ³ÙŠØ©.`; }
      if(section==='training-day'){ const d=extra.day; return `${header}\n\nØ®Ø·Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ù„ÙŠÙˆÙ… ${d} Ù…Ù† Ù§. Ø¬Ø¯ÙˆÙ„: Ø§Ù„ÙŠÙˆÙ… | Exercise | Sets | Reps | Rest(s). Ø±Ø§Ø¹Ù Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª ÙˆØ±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù. Ø¶Ø¹ [SWAP:EXERCISE:<name>] Ù„ÙƒÙ„ Ø­Ø±ÙƒØ©.`; }
      if(section==='supplements') return `${header}\n\nÙ…ÙƒÙ…Ù„Ø§Øª Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù„ÙŠÙ„: Ø£Ø³Ø§Ø³ÙŠØ©ØŒ Ù…ÙˆØ¬Ù‡Ø© Ù„Ù„Ù‡Ø¯ÙØŒ Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©. Ø¬Ø±Ø¹Ø§Øª/ØªÙˆÙ‚ÙŠØª + ØªÙ†Ø¨ÙŠÙ‡ Ø·Ø¨ÙŠ Ù…Ø®ØªØµØ±.`;
      if(section==='progression') return `${header}\n\nÙ†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø¯Ù‘Ù… 8â€“12 Ø£Ø³Ø¨ÙˆØ¹Ù‹Ø§: Ø²ÙŠØ§Ø¯Ø§ØªØŒ Ø¯Ù„ÙˆØ¯ØŒ Ø¯Ù‚Ø§Ø¦Ù‚ ÙƒØ§Ø±Ø¯ÙŠÙˆØŒ Ø¶Ø¨Ø· TDEE Ù…Ø¹ ØªØºÙŠÙ‘Ø± Ø§Ù„ÙˆØ²Ù†.`;
      if(section==='troubleshoot') return `${header}\n\nØ­Ù„ÙˆÙ„ Ø³Ø±ÙŠØ¹Ø©: Ø§Ù„Ø¬ÙˆØ¹ØŒ Ø§Ù„Ø«Ø¨Ø§ØªØŒ Ø§Ù„Ù†ÙˆÙ… Ø§Ù„Ø³ÙŠØ¡ØŒ Ø§Ù„Ø¶ØºØ·ØŒ Ø§Ù„Ø´Ø±Ø§Ù‡Ø©ØŒ Ø§Ù„Ø³ÙØ±/Ø§Ù„Ù…Ø·Ø§Ø¹Ù… (Ù¢â€“Ù£ Ù†Ù‚Ø§Ø· Ù„ÙƒÙ„ Ø­Ø§Ù„Ø©).`;
      if(section==='safety') return `${header}\n\nØ¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©: ØªÙ‚Ù†ÙŠØ©ØŒ ÙˆÙ‚Ø§ÙŠØ© Ø¥ØµØ§Ø¨Ø§ØªØŒ ØªØ±ÙˆÙŠØ© ÙˆÙ†ÙˆÙ…ØŒ Ù…ØªÙ‰ Ù†ÙˆÙ‚Ù Ø§Ù„ØªÙ…Ø±ÙŠÙ† ÙˆÙ†Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨.`;
      if(section==='closing') return `${header}\n\nØ®ØªØ§Ù… ØªØ­ÙÙŠØ²ÙŠ Ù‚ØµÙŠØ± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…ÙˆØ¬Ù‘Ù‡ Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø¨Ù„Ø§ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ±Ø­ÙŠØ¨.`;
      return header;
    }

    /* ========= Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø­ÙŠ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø®Ø·Ø© ========= */
    function addSectionCard(key){
      const container=$('plan-content');
      const card=document.createElement('article');
      card.className='mb-4 rounded-xl border border-white/10 bg-white/5 p-3 md:p-4';
      const title = key.startsWith('nutrition-day') ? `Ø§Ù„ØªØºØ°ÙŠØ© â€” ÙŠÙˆÙ… ${key.split('-').pop()}`
                  : key.startsWith('training-day') ? `Ø§Ù„ØªØ¯Ø±ÙŠØ¨ â€” ÙŠÙˆÙ… ${key.split('-').pop()}`
                  : ({
                      welcome:'Ø§Ù„ØªØ±Ø­ÙŠØ¨', analysis:'Ø§Ù„ØªØ­Ù„ÙŠÙ„', allowed:'Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹', fasting:'Ø§Ù„ØµÙŠØ§Ù…',
                      supplements:'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª', progression:'Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…', troubleshoot:'Ø§Ù„Ù…Ø´Ø§ÙƒÙ„', safety:'Ø§Ù„Ø³Ù„Ø§Ù…Ø©', closing:'Ø§Ù„Ø®ØªØ§Ù…'
                    }[key]||key);
      card.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-base md:text-lg font-extrabold">${title}</h2>
          <span class="text-xs text-slate-300" id="${key}-state">ÙŠÙÙˆÙ„ÙÙ‘Ø¯â€¦</span>
        </div>
        <div id="${key}-body" class="text-sm md:text-[0.95rem] leading-6">
          <div class="animate-pulse">
            <div class="h-3 rounded bg-white/10 mb-2"></div>
            <div class="h-3 rounded bg-white/10 w-2/3"></div>
          </div>
        </div>`;
      container.appendChild(card);
      $('plan-empty').style.display='none';
      card.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function fillSectionCard(key, markdown, ok){
      const sEl=$(key+'-state'), bEl=$(key+'-body');
      if(!sEl||!bEl) return;
      sEl.textContent = ok ? 'ØªÙ…' : 'ÙØ´Ù„';
      const html = ok ? renderMarkdown(markdown) : `<div class="text-red-300">ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….</div>`;
      bEl.innerHTML = html;
    }

    /* ========= ØªÙˆÙ„ÙŠØ¯ Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù… ========= */
    async function generatePlan(){
      readForm();
      // ØªØ­Ù‚Ù‚ Ø£Ø³Ø§Ø³ÙŠ
      const must = ['name','age','height','weight'];
      if(must.some(k=>!(state.profile[k]&&String(state.profile[k]).trim()))){
        alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ø·ÙˆÙ„/Ø§Ù„ÙˆØ²Ù†.');
        return;
      }
      const sections = SECTION_ORDER();
      buildTimeline(sections);
      $('generate').classList.add('hidden'); $('cancel').classList.remove('hidden');

      // Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¥Ù„ØºØ§Ø¡
      const cancelCtrl = new AbortController();
      state.cancelToken = cancelCtrl;

      const bar=$('global-progress'); let done=0;
      const total=sections.length;

      for(const s of sections){
        if(cancelCtrl.signal.aborted) break;

        setTimelineStatus(s,'run');
        addSectionCard(s);

        let sec = s, extra={};
        if(s.startsWith('nutrition-day')){ sec='nutrition-day'; extra.day=+s.split('-').pop(); }
        if(s.startsWith('training-day')){ sec='training-day'; extra.day=+s.split('-').pop(); }

        const prompt = buildPrompt(sec, extra);
        const {ok, text} = await callAI(prompt,{retries:1, timeoutMs:45000, signal:cancelCtrl.signal});
        setTimelineStatus(s, ok?'ok':'fail');
        fillSectionCard(s, text, ok);

        done++; const pct = Math.round((done/total)*100);
        bar.style.width = pct+'%';
        $('sticky').querySelector('.progress').setAttribute('aria-valuenow', String(pct));
      }

      $('generate').classList.remove('hidden'); $('cancel').classList.add('hidden');
      state.cancelToken=null;
    }

    /* ========= Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ø¬Ù‡Ø© ========= */
    $('generate').addEventListener('click', generatePlan);
    $('cancel').addEventListener('click', ()=>{
      if(state.cancelToken) state.cancelToken.abort();
      $('generate').classList.remove('hidden'); $('cancel').classList.add('hidden');
    });
    $('scroll-top').onclick = ()=>window.scrollTo({top:0,behavior:'smooth'});
    $('btn-print').onclick = ()=>window.print();
    $('print-bottom').onclick = ()=>window.print();
    $('toggle-theme').onclick = ()=>{
      const isDark = document.body.dataset.t==='light';
      document.body.dataset.t = isDark ? 'dark' : 'light';
      document.body.style.background = isDark
        ? 'linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%)'
        : 'linear-gradient(180deg,#eef2ff 0%,#f7f9ff 100%)';
    };

    // Ù„ØºØ© (Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ ÙÙ‚Ø· ØªØºÙŠÙŠØ± Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)
    $('lang-ar').onclick = ()=>{ document.documentElement.lang='ar'; document.documentElement.dir='rtl'; };
    $('lang-en').onclick = ()=>{ document.documentElement.lang='en'; document.documentElement.dir='ltr'; };

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    $('currency').value = state.currency;

  </script>
</body>
</html>
