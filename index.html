<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>المدرب الشخصي الخبير — خطة مخصصة بالذكاء الاصطناعي</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- html2pdf for PDF Export -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --sub:#475569;
      --prime:#635bff;
      --line:#e5e7eb;
      --chip:#eef2ff;
    }
    html.dark{
      --bg:#0b0f17;
      --card:#0f1624;
      --ink:#f1f5f9;
      --sub:#98a2b3;
      --prime:#7c8cff;
      --line:#1f2738;
      --chip:#151c2c;
    }
    *{ font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    body{ background:var(--bg); color:var(--ink); }
    .card{ background:var(--card); border:1px solid var(--line); }
    .chip{ background:var(--chip); }

    /* إصلاح @apply: استخدام CSS صريح بدلًا من Tailwind @apply */
    .btn{ padding:0.5rem 1rem; border-radius:0.5rem; font-weight:800; border:0; cursor:pointer; }
    .btn-prime{ background:var(--prime); color:#fff; }
    .btn-ghost{ background:transparent; border:1px solid var(--line); color:var(--ink); }

    .kbd{
      font-size:0.75rem; padding:0.125rem 0.5rem; border-radius:0.25rem; border:1px solid var(--line);
      background:var(--chip); color:var(--sub);
    }

    .progress-bar { height:8px; background:linear-gradient(90deg, var(--prime), #22c55e); transition: width .3s; }
    .print-ready *{ animation:none !important; transition:none !important; }

    @media print{
      body { background:#fff; }
      #topbar, #setup, #actions { display:none !important; }
      #resultRoot { box-shadow:none !important; border:none !important; }
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- Top Bar -->
  <header id="topbar" class="sticky top-0 z-40 backdrop-blur bg-[color:var(--card)]/85 border-b" role="banner">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="size-9 rounded-lg grid place-items-center text-white font-extrabold" style="background:var(--prime)">AI</div>
        <div>
          <div class="text-sm font-extrabold">المدرب الشخصي الخبير</div>
          <div class="text-[11px] text-[color:var(--sub)]">خطة دقيقة 100% للتغذية والتدريب والمكملات — مخصصة لك</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btn-ar" class="btn btn-ghost text-sm">عربي</button>
        <button id="btn-en" class="btn btn-ghost text-sm">EN</button>
        <div class="w-px h-6 bg-[color:var(--line)] mx-1"></div>
        <button id="btn-theme" class="btn btn-ghost text-sm" title="الوضع الليلي/النهاري">🌓</button>
      </div>
    </div>
  </header>

  <!-- Container -->
  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- Intro Card -->
    <div class="card rounded-2xl p-5 md:p-7 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold mb-1">
            لنصمم خطتك المثالية
          </h1>
          <p class="text-sm text-[color:var(--sub)]">
            أدخل بياناتك بدقة. سنولّد النتيجة قسمًا بعد قسم لضمان الشمول والوضوح.
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-2" id="actions">
          <button id="btn-start" class="btn btn-prime">ابدأ توليد الخطة</button>
          <button id="btn-regen" class="btn btn-ghost hidden">إعادة توليد كامل</button>
          <button id="btn-print" class="btn btn-ghost hidden">طباعة</button>
          <button id="btn-pdf" class="btn btn-ghost hidden">PDF</button>
        </div>
      </div>

      <!-- Progress -->
      <div class="mt-4">
        <div class="w-full bg-[color:var(--line)] h-2 rounded-full overflow-hidden">
          <div id="progress" class="progress-bar w-0"></div>
        </div>
        <div id="progressText" class="text-[12px] text-[color:var(--sub)] mt-1">جاهز</div>
      </div>
    </div>

    <!-- Form -->
    <section id="setup" class="grid grid-cols-1 lg:grid-cols-3 gap-5">
      <!-- Profile -->
      <div class="card rounded-2xl p-5">
        <div class="text-lg font-extrabold mb-3">الملف الشخصي</div>
        <div class="grid grid-cols-2 gap-3">
          <label class="col-span-2">
            <div class="text-sm mb-1">الاسم</div>
            <input id="name" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="الاسم الأول" />
          </label>
          <label>
            <div class="text-sm mb-1">العمر</div>
            <input id="age" type="number" class="w-full rounded-lg border px-3 py-2 bg-transparent" min="12" max="100" />
          </label>
          <label>
            <div class="text-sm mb-1">الطول (سم)</div>
            <input id="height" type="number" class="w-full rounded-lg border px-3 py-2 bg-transparent" min="120" max="230" />
          </label>
          <label>
            <div class="text-sm mb-1">الوزن (كغ)</div>
            <input id="weight" type="number" class="w-full rounded-lg border px-3 py-2 bg-transparent" min="30" max="250" />
          </label>
          <label>
            <div class="text-sm mb-1">الجنس</div>
            <select id="gender" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option value="Male">ذكر</option>
              <option value="Female">أنثى</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Goals & Diet -->
      <div class="card rounded-2xl p-5">
        <div class="text-lg font-extrabold mb-3">الأهداف والنظام الغذائي</div>
        <div class="grid grid-cols-2 gap-3">
          <label class="col-span-2">
            <div class="text-sm mb-1">الأهداف (اختر عدة)</div>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="خسارة الدهون" class="accent-[var(--prime)]"><span>خسارة الدهون</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="بناء العضلات" class="accent-[var(--prime)]"><span>بناء العضلات</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="زيادة القوة" class="accent-[var(--prime)]"><span>زيادة القوة</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="تحسين التحمل" class="accent-[var(--prime)]"><span>تحسين التحمل</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="صحة عامة" class="accent-[var(--prime)]"><span>صحة عامة</span></label>
            </div>
          </label>
          <label class="col-span-2">
            <div class="text-sm mb-1">النظام الغذائي المفضل</div>
            <select id="diet" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>نظام متوازن</option>
              <option>قليل الكربوهيدرات</option>
              <option>صيام متقطع</option>
              <option>كيتو</option>
              <option>نظام البحر المتوسط</option>
              <option>نباتي</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">عدد الوجبات/اليوم</div>
            <select id="meals" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>3</option><option>4</option><option>5</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">الصيام المتقطع</div>
            <select id="fasting" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option value="off">غير مفعل</option>
              <option value="16:8">16:8</option>
              <option value="18:6">18:6</option>
              <option value="20:4">20:4</option>
            </select>
          </label>
          <label class="col-span-2">
            <div class="text-sm mb-1">أطعمة لا ترغب بها / حساسية</div>
            <input id="dislikes" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="اكتب الأطعمة أو مسببات الحساسية" />
          </label>
        </div>
      </div>

      <!-- Lifestyle & Health -->
      <div class="card rounded-2xl p-5">
        <div class="text-lg font-extrabold mb-3">نمط الحياة والحالة الصحية</div>
        <div class="grid grid-cols-2 gap-3">
          <label>
            <div class="text-sm mb-1">طبيعة العمل</div>
            <select id="job" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option value="Sedentary">عمل مكتبي</option>
              <option value="Light">نشاط خفيف</option>
              <option value="Moderate">نشاط متوسط</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">ساعات النوم</div>
            <input id="sleep" type="number" min="3" max="12" class="w-full rounded-lg border px-3 py-2 bg-transparent" />
          </label>
          <label>
            <div class="text-sm mb-1">التوتر</div>
            <select id="stress" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>منخفض</option>
              <option>متوسط</option>
              <option>مرتفع</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">مكان التدريب</div>
            <select id="place" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>نادي</option><option>منزل</option>
            </select>
          </label>
          <label class="col-span-2">
            <div class="text-sm mb-1">المعدات المتاحة (إن وجدت)</div>
            <input id="equipment" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="مثال: دمبل، بار، بنش…" />
          </label>

          <label class="col-span-2">
            <div class="text-sm mb-1">الخبرة التدريبية</div>
            <select id="exp" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>مبتدئ (0-6 أشهر)</option>
              <option>متوسط (6-24 شهر)</option>
              <option>متقدم (+24 شهر)</option>
            </select>
          </label>

          <label class="col-span-2">
            <div class="text-sm mb-1">إصابات / ملاحظات طبية</div>
            <input id="injuries" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="اذكر الإصابات أو القيود إن وجدت" />
          </label>

          <label class="col-span-2">
            <div class="text-sm mb-1">حالات صحية</div>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="health" value="ضغط الدم" class="accent-[var(--prime)]"><span>ضغط الدم</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="health" value="السكري" class="accent-[var(--prime)]"><span>السكري</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="health" value="مقاومة الانسولين" class="accent-[var(--prime)]"><span>مقاومة الانسولين</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="health" value="مشاكل الغدة" class="accent-[var(--prime)]"><span>مشاكل الغدة</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="health" value="الكبد الدهني" class="accent-[var(--prime)]"><span>الكبد الدهني</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="health" value="مشاكل هضمية" class="accent-[var(--prime)]"><span>مشاكل هضمية</span></label>
            </div>
          </label>
        </div>
      </div>
    </section>

    <!-- Result -->
    <section id="result" class="hidden mt-6">
      <div id="resultRoot" class="card rounded-2xl p-5 md:p-8">
        <div class="flex items-center justify-between gap-3 mb-3">
          <div class="text-lg font-extrabold">
            النتيجة — خطة مخصصة 100%
          </div>
          <div class="flex items-center gap-2">
            <button id="act-print" class="btn btn-ghost">طباعة</button>
            <button id="act-pdf" class="btn btn-ghost">PDF</button>
          </div>
        </div>
        <article id="ai" class="prose max-w-none prose-headings:font-extrabold prose-p:leading-7 prose-ul:leading-7 prose-ol:leading-7"></article>
      </div>
    </section>

    <footer class="text-center text-[11px] text-[color:var(--sub)] mt-6">
      Powered by Mustafa Elsafy 2025 — جميع الحقوق محفوظة
    </footer>
  </main>

  <!-- Scripts -->
  <script>
    /******************* Utilities *******************/
    const $ = (id)=>document.getElementById(id);
    const PROXY_URL = '/.netlify/functions/gemini-proxy';
    const HEALTH_URL = '/.netlify/functions/health';

    const state = { lang:'ar' };
    const t = (ar,en)=> state.lang==='ar'? ar : en;

    function setLang(l){
      state.lang = l;
      document.documentElement.lang = l==='ar'?'ar':'en';
      document.documentElement.dir  = l==='ar'?'rtl':'ltr';
      $('btn-ar').classList.toggle('btn-prime', l==='ar');
      $('btn-en').classList.toggle('btn-prime', l==='en');
      $('progressText').textContent = t('جاهز','Ready');
    }

    function toggleTheme(){ document.documentElement.classList.toggle('dark'); }

    function setProgress(step,total,label){
      const p = Math.round((step/total)*100);
      $('progress').style.width = p+'%';
      $('progressText').textContent = `${p}% — ${label}`;
    }

    function appendSpinner(label){
      const el = document.createElement('div');
      el.id = 'ai-spinner';
      el.className = "chip border rounded-lg p-3 my-2 text-sm";
      el.innerHTML = `⏳ ${t('نقوم الآن بتجهيز هذا القسم بعناية، الرجاء الانتظار…','We are preparing this section carefully, please wait…')} <span class="ml-2 text-[color:var(--sub)]">${label}</span>`;
      $('ai').appendChild(el);
    }
    function replaceLastSpinnerWith(html){
      const sp = $('ai-spinner');
      if(sp) sp.remove();
      const box = document.createElement('div');
      box.className = 'my-4';
      box.innerHTML = marked.parse(html);
      $('ai').appendChild(box);
    }

    /******************* Collect & compute *******************/
    function collect(){
      const goals = [...document.querySelectorAll('input[name="goals"]:checked')].map(e=>e.value);
      const health = [...document.querySelectorAll('input[name="health"]:checked')].map(e=>e.value);
      return {
        name:$('name').value?.trim(),
        age:+$('age').value||0,
        height:+$('height').value||0,
        weight:+$('weight').value||0,
        gender:$('gender').value,
        goals, diet:$('diet').value,
        meals:+$('meals').value,
        fasting: $('fasting').value,
        dislikes: $('dislikes').value?.trim(),
        job:$('job').value,
        sleep:+$('sleep').value||0,
        stress:$('stress').value,
        training_place:$('place').value,
        equipment:$('equipment').value?.trim(),
        exp:$('exp').value,
        injuries:$('injuries').value?.trim(),
        health
      };
    }

    function calcTargets(){
      const u = collect();
      const male = u.gender==='Male';
      const BMR = male ? 10*u.weight + 6.25*u.height - 5*u.age + 5
                       : 10*u.weight + 6.25*u.height - 5*u.age - 161;
      const factor = (u.job==='Sedentary'?1.2 : u.job==='Moderate'?1.5 : 1.35);
      let TDEE = Math.round(BMR*factor);
      if(u.goals.includes('خسارة الدهون')) TDEE = Math.round(TDEE*0.88);
      if(u.goals.includes('بناء العضلات'))   TDEE = Math.round(TDEE*1.10);
      const P = Math.round(2.0 * (u.weight||1));
      const F = Math.round(0.8 * (u.weight||1));
      let C = Math.max(0, Math.round((TDEE - (P*4 + F*9))/4));
      if(u.health.includes('السكري')||u.health.includes('مقاومة الانسولين')) C = Math.min(C, 140);
      return { TDEE, P, F, C };
    }

    /******************* Backend health *******************/
    async function checkBackend(){
      try{
        const r = await fetch(HEALTH_URL, { cache:'no-store' });
        if(!r.ok) return { ok:false, error:'health status '+r.status };
        const j = await r.json().catch(()=> ({}));
        return j?.ok? { ok:true } : { ok:false, error:'health json' };
      }catch(e){ return { ok:false, error:String(e) }; }
    }

    /******************* AI call via proxy *******************/
    async function callAI(prompt){
      const res = await fetch(PROXY_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ prompt })
      });
      if(!res.ok){
        const tt = await res.text().catch(()=> '');
        throw new Error('Proxy '+res.status+': '+tt.slice(0,300));
      }
      const data = await res.json();
      const text = data?.text || '';
      if(!text) throw new Error('Empty AI response');
      return text;
    }

    /******************* Prompts & Pipeline *******************/
    function userObj(){
      const u = collect(), t = calcTargets();
      const IF = u.fasting!=='off' ? `${u.fasting}` : 'disabled';
      return { u, t, IF };
    }

    function baseHeader(){
      const {u,t} = userObj();
      const locale = state.lang==='ar'?'Arabic':'English';
      return `
STRICT GLOBAL RULES
- OUTPUT LANGUAGE: ${locale} ONLY. DO NOT MIX.
- GREETINGS/MOTIVATION: ONLY in "Welcome" section ONCE. STRICTLY FORBIDDEN elsewhere.
- DO NOT restate the client's profile fields repeatedly. Mention the name ONCE in the welcome section only. No age/height/weight/gender repetitions later.
- Use clean Markdown. Each section must start with "### Title".
- Use tables and precise bullet points. No placeholders. No emojis.

CLIENT PROFILE (internal, do NOT restate inside sections)
- Name: ${u.name}; Sex: ${u.gender}
- Age/Height/Weight: ${u.age}y / ${u.height}cm / ${u.weight}kg
- Activity: ${u.job}; Sleep: ${u.sleep}h; Stress: ${u.stress}
- Goals: ${(u.goals||[]).join(', ')}
- Diet: ${u.diet}; Meals/day: ${u.meals}; IF: ${u.fasting}
- Place: ${u.training_place}; Equipment: ${u.equipment||'—'}
- Experience: ${u.exp}; Injuries: ${u.injuries||'None'}
- Health: ${(u.health||[]).join(', ')||'None'}
- Disliked/allergic: ${u.dislikes||'None'}

DAILY TARGETS (reference only)
- Energy ~${t.TDEE} kcal/day; P ~${t.P} g; F ~${t.F} g; C ~${t.C} g (±2% tolerance)`.trim();
    }

    // أقسام أساسية تُولَّد مرة واحدة
    const BASE_PIPE = [
      {
        key:'welcome',
        label_ar:'١) ترحيب وتحفيز',
        label_en:'1) Welcome & Motivation',
        prompt:()=>`${baseHeader()}

### Welcome & Motivation
Write a short warm welcome to **${collect().name||t('العميل','client')}** (6–8 concise lines). No lists, no tables.`
      },
      {
        key:'analysis',
        label_ar:'٢) تحليل الحالة والهدف',
        label_en:'2) Profile Analysis & Goal',
        prompt:()=>`${baseHeader()}

### Analysis
Provide a concise professional analysis (no profile repetition, no greetings). Explain rationale behind calorie target and macro split, and how the plan aligns with goals, health and constraints.`
      },
      {
        key:'allowed',
        label_ar:'٣) المسموح والممنوع',
        label_en:'3) Allowed & Avoid List',
        prompt:()=>`${baseHeader()}

### Allowed & Avoid
Two bullet lists only:
- Allowed & preferred foods (based on diet ${collect().diet}) with brief reasons
- Avoid/limit foods considering allergies/dislikes: ${collect().dislikes||'None'}`
      },
      {
        key:'fasting',
        label_ar:'٤) الصيام المتقطع (إن وُجد)',
        label_en:'4) Intermittent Fasting (if enabled)',
        prompt:()=>`${baseHeader()}

### Intermittent Fasting
If fasting = ${collect().fasting}, explain implementation (feeding window, hydration, electrolytes, first/last meal structure). If disabled, write "Not applicable". No greetings.`
      },
      {
        key:'supps',
        label_ar:'٧) المكملات — أساسية + مرتبطة بالحالة',
        label_en:'7) Supplements — Core + Condition-linked',
        prompt:()=>`${baseHeader()}

### Supplements (SAFE, PRACTICAL)
Provide two sublists:
1) Core stack — item, dose, timing, duration.
2) Condition-linked — only if relevant to: ${(collect().health||[]).join(', ')||'None'}; otherwise state "Not indicated".
Respect allergies/dislikes: ${collect().dislikes||'None'}.
Add safety line: consult physician if on medications.`
      },
      {
        key:'progress',
        label_ar:'٨) التقدم والتصعيد',
        label_en:'8) Progression & Tracking',
        prompt:()=>`${baseHeader()}

### Progress & Tracking
Explain how to progress training and when to adjust calories/macros. Provide weekly checklist.`
      },
      {
        key:'troubleshoot',
        label_ar:'٩) المشكلات الشائعة والحلول',
        label_en:'9) Troubleshooting',
        prompt:()=>`${baseHeader()}

### Troubleshooting
Bullet list of frequent issues and exact fixes (plateaus, hunger, fatigue, schedule conflicts).`
      },
      {
        key:'safety',
        label_ar:'١٠) السلامة والنصائح الصحية',
        label_en:'10) Safety & Health Notes',
        prompt:()=>`${baseHeader()}

### Safety & Health
Short section on hydration, sleep hygiene, warm-up, technique, red flags to stop and seek care.`
      },
      {
        key:'closing',
        label_ar:'١١) ختام وتحفيز',
        label_en:'11) Closing & Motivation',
        prompt:()=>`${baseHeader()}

### Closing
Positive closing paragraph encouraging adherence and celebrating small wins, without repeating the profile. No greetings duplication.`
      }
    ];

    // توليد يومي للتغذية
    function nutritionDayPrompt(dayIdx){
      return `${baseHeader()}

### 7-Day Nutrition Plan — Day ${dayIdx}
- For **Day ${dayIdx}** ONLY, provide EXACTLY ${collect().meals} meals in a MARKDOWN TABLE with columns:
| ${t('اليوم','Day')} | ${t('الوجبة','Meal')} | ${t('المكونات (بالجرامات/مل)','Ingredients (g/ml)')} | Protein (g) | Fat (g) | Carbs (g) | kcal |
- Close with a "Totals" row meeting daily targets within ±2%.
- Add one short compliance tip after the table.
- No greetings, no motivational lines.`;
    }

    // توليد يومي للتدريب
    function trainingDayPrompt(dayIdx){
      return `${baseHeader()}

### 7-Day Training Plan — Day ${dayIdx}
- Tailored to experience: ${collect().exp}, place: ${collect().training_place}, equipment: ${collect().equipment||'—'}.
- STRICTLY avoid aggravating injuries: ${collect().injuries||'None'}.
- Provide ONE table:
| ${t('اليوم','Day')} | Exercise (English) | Sets | Reps | Tempo | Rest (s) | Notes |
- Include warm-up/mobility notes if helpful.
- No greetings or motivational language.`;
    }

    // مُصادِقات مبسّطة
    function hasTable(md){ return md.split('\n').filter(l=>l.includes('|')).length>=5; }
    function containsDay(md, i){
      const d = md.toLowerCase();
      const en = new RegExp(`\\bday\\s*${i}\\b`);
      const ar = new RegExp(`\\bاليوم\\s*${i}\\b`);
      return en.test(d) || ar.test(d);
    }

    const VALIDATORS = {
      welcome: (md)=> md.length>50 && !md.includes('|'),
      analysis:(md)=> md.length>80,
      allowed: (md)=> md.includes('- '),
      fasting: (md)=> md.length>30,
      supps:   (md)=> md.includes('1)') || md.includes('2)') || md.split('\n').some(l=>l.trim().startsWith('-')),
      progress:(md)=> md.length>60,
      troubleshoot:(md)=> md.includes('- '),
      safety:  (md)=> md.length>30,
      closing: (md)=> md.length>40
    };

    /******************* Dynamic Pipeline (with daily generation) *******************/
    function buildFullPipeline(){
      const steps = [];

      // أساسيات
      steps.push(...BASE_PIPE);

      // عنوان واضح لقسمي الأيام
      steps.splice(1, 0, { // بعد الترحيب مباشرة نضيف عنوان التغذية والتدريب
        key:'nutrition_header',
        label_ar:'٥) تغذية — أيام منفصلة',
        label_en:'5) Nutrition — Day by Day',
        prompt:()=>`${baseHeader()}

### Nutrition Plan — Overview
The following 7 days will be generated **day-by-day**. Do NOT include greetings. Provide no content here other than a one-line notice: "Daily meal plans follow below."`
      });

      steps.splice(2, 0, {
        key:'training_header',
        label_ar:'٦) تدريب — أيام منفصلة',
        label_en:'6) Training — Day by Day',
        prompt:()=>`${baseHeader()}

### Training Plan — Overview
The following 7 days will be generated **day-by-day**. Do NOT include greetings. Provide no content here other than a one-line notice: "Daily training sessions follow below."`
      });

      // 7 أيام تغذية
      for(let i=1;i<=7;i++){
        steps.push({
          key:`nutrition_day_${i}`,
          label_ar:`تغذية — اليوم ${i}`,
          label_en:`Nutrition — Day ${i}`,
          prompt:()=> nutritionDayPrompt(i),
          validator:(md)=> hasTable(md) && containsDay(md, i)
        });
      }

      // 7 أيام تدريب
      for(let i=1;i<=7;i++){
        steps.push({
          key:`training_day_${i}`,
          label_ar:`تدريب — اليوم ${i}`,
          label_en:`Training — Day ${i}`,
          prompt:()=> trainingDayPrompt(i),
          validator:(md)=> hasTable(md) && containsDay(md, i)
        });
      }

      return steps;
    }

    /******************* Generation Loop *******************/
    async function generate(){
      const health = await checkBackend();
      if(!health.ok){
        alert(t('الخادم غير جاهز — يرجى المحاولة لاحقًا.\n','Backend is not ready — please try later.\n') + (health.error||''));
        return;
      }

      $('result').classList.remove('hidden');
      $('ai').innerHTML = '';
      $('btn-regen').classList.remove('hidden');
      $('btn-print').classList.remove('hidden');
      $('btn-pdf').classList.remove('hidden');

      const STEPS = buildFullPipeline();
      const total = STEPS.length;

      for(let i=0; i<total; i++){
        const sec = STEPS[i];
        const label = t(sec.label_ar || '', sec.label_en || '');
        setProgress(i, total, label || t('قيد التوليد','Generating'));
        appendSpinner(label || '');

        let ok=false, md='', attempts=0, error='';
        while(!ok && attempts<2){
          attempts++;
          try{
            md = await callAI(sec.prompt());
            const v = sec.validator || VALIDATORS[sec.key];
            ok = v ? v(md) : true;
            if(!ok){
              const fix = `${baseHeader()}

The previous attempt FAILED validation for "${label}".
Regenerate EXACTLY as requested. Ensure strict day labeling and valid table. No greetings.`;
              md = await callAI(fix);
              ok = v ? v(md) : true;
            }
          }catch(e){ error = String(e); }
        }

        if(!ok){
          md = t(
            '**تعذّر توليد هذا القسم تلقائيًا بعد محاولتين.** الرجاء إعادة المحاولة لاحقًا.',
            '**Failed to generate this section after two attempts.** Please try again later.'
          );
        }

        replaceLastSpinnerWith(md);
      }

      setProgress(total, total, t('اكتمل التوليد','Generation complete'));
      $('resultRoot').scrollIntoView({behavior:'smooth',block:'start'});
    }

    /******************* PDF Export & Print *******************/
    function exportAsPDF(){
      const node = $('resultRoot');
      if(!node){ window.print(); return; }
      if(!window.html2pdf){ window.print(); return; }

      const fn = (state.lang==='ar'?'خطة-':'plan-') + (collect().name||'client') + '.pdf';
      const opt = {
        filename: fn,
        margin: [10,10,10,10],
        image: { type:'jpeg', quality:0.98 },
        html2canvas: { scale: 2, useCORS:true },
        pagebreak: { mode:['css','legacy'] },
        jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
      };

      document.documentElement.classList.add('print-ready');
      setTimeout(()=>{
        try{
          html2pdf().from(node).set(opt).save().finally(()=> {
            document.documentElement.classList.remove('print-ready');
          });
        }catch{
          document.documentElement.classList.remove('print-ready');
          window.print();
        }
      }, 80);
    }

    /******************* Events *******************/
    $('btn-ar').onclick = ()=> setLang('ar');
    $('btn-en').onclick = ()=> setLang('en');
    $('btn-theme').onclick = toggleTheme;

    $('btn-start').onclick = async ()=>{
      const u = collect();
      if(!u.name || !u.age || !u.height || !u.weight || !u.sleep){
        alert(t('أكمل الحقول الأساسية: الاسم/العمر/الطول/الوزن/النوم.','Fill required fields: name/age/height/weight/sleep.'));
        return;
      }
      $('ai').innerHTML='';
      generate();
    };
    $('btn-regen').onclick = ()=>{ $('ai').innerHTML=''; generate(); };
    $('btn-print').onclick = ()=> window.print();
    $('btn-pdf').onclick = exportAsPDF;
    $('act-print').onclick = ()=> window.print();
    $('act-pdf').onclick = exportAsPDF;

    // defaults
    setLang('ar');
  </script>
</body>
</html>
