<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>المستشار الصحي الذكي | Intelligent Health Coach</title>

  <!-- Fonts & libs -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --brand:#6c5ce7; --brand-2:#00c2ff;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      --muted:#93a2b8;
    }
    html[dir="rtl"] body{font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",sans-serif}
    html[dir="ltr"] body{font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
    body{background:linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%);color:#eaf0ff}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.10);border-radius:16px}
    .title-grad{background:linear-gradient(90deg,var(--brand),var(--brand-2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:.35rem .6rem;border-radius:999px;font-size:.75rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1rem;border-radius:.8rem;font-weight:800;transition:.2s}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff}
    .btn-primary:hover{filter:brightness(1.08);transform:translateY(-1px)}
    .btn-ghost{background:rgba(255,255,255,.06);color:#eaf0ff;border:1px solid rgba(255,255,255,.12)}
    .field{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);border-radius:.7rem;padding:.65rem .8rem;outline:none;width:100%;color:#eaf0ff}
    .field::placeholder{color:#aab7cf}.field:focus{border-color:var(--brand-2);box-shadow:0 0 0 3px rgba(0,194,255,.15)}
    .section-title{font-weight:900;letter-spacing:.3px}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent)}
    .progress{height:.45rem;background:rgba(255,255,255,.10);border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand-2));width:0%;transition:width .25s ease}
    .badge{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .55rem;border-radius:.5rem;font-size:.72rem;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06)}
    .status-dot{width:.55rem;height:.55rem;border-radius:999px}
    .g{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:14px}
    html[dir="rtl"] .c1{grid-column:1/span 4} html[dir="rtl"] .c2{grid-column:5/span 4} html[dir="rtl"] .c3{grid-column:9/span 4}
    html[dir="ltr"] .c1{grid-column:1/span 4} html[dir="ltr"] .c2{grid-column:5/span 4} html[dir="ltr"] .c3{grid-column:9/span 4}
    @media (max-width:1024px){.g .c1,.g .c2,.g .c3{grid-column:1/span 12}}
    .light body,.light{background:linear-gradient(180deg,#eef2ff 0%,#f7f9ff 100%);color:#0e1526}
    .light .glass{background:linear-gradient(180deg,rgba(0,0,0,.03),rgba(0,0,0,.02));border-color:rgba(0,0,0,.10)}
    .light .field{background:rgba(0,0,0,.03);color:#0e1526;border-color:rgba(0,0,0,.12)}
    /* تحسين Markdown الناتج */
    .ai-content h1,.ai-content h2{font-weight:800;margin:.25rem 0 .5rem}
    .ai-content h3{font-weight:700;margin:.25rem 0}
    .ai-content p,.ai-content li{line-height:1.9}
    .ai-content table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:10px;border:1px solid rgba(255,255,255,.12)}
    .ai-content thead th{background:rgba(255,255,255,.07);font-weight:800}
    .ai-content th,.ai-content td{padding:.6rem .7rem;border-bottom:1px solid rgba(255,255,255,.08)}
    .ai-content tr:last-child td{border-bottom:0}
    .ai-content ul{list-style:disc;padding-inline-start:1.2rem}
    .ai-content ol{list-style:decimal;padding-inline-start:1.4rem}
    @media print{body{background:#fff;color:#111}.glass,.btn,.chip,.title-grad{all:unset}
      .ai-content h2,.ai-content h3{color:#111}
      .ai-content table{border-collapse:collapse;width:100%}
      .ai-content th,.ai-content td{border:1px solid #333;padding:.55rem;vertical-align:top}}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="sticky top-0 z-40 glass border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="size-9 rounded-xl bg-gradient-to-br from-[var(--brand)] to-[var(--brand-2)] grid place-items-center font-black">AI</div>
        <div>
          <div id="app-title" class="text-lg font-extrabold">المستشار الصحي الذكي</div>
          <div id="subtitle" class="text-xs text-[color:var(--muted)]">خطة دقيقة ١٠٠٪ للتغذية والتدريب والمكملات — مخصصة لك</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="toggle-theme" class="chip" title="Theme">☾/☀</button>
        <button id="lang-ar" class="chip">عربي</button>
        <button id="lang-en" class="chip">EN</button>
        <button id="btn-print" class="btn btn-ghost">🖨</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Stepper -->
    <section class="glass p-4 mb-4">
      <div class="flex items-center justify-between gap-3">
        <div id="hint" class="text-sm text-[color:var(--muted)]"></div>
        <div class="w-56 progress"><i id="global-progress"></i></div>
      </div>
    </section>

    <!-- Wizard -->
    <section id="wizard" class="glass p-4">
      <div class="section-title title-grad text-xl mb-3" id="step-title">الملف الشخصي</div>
      <div id="step-body"></div>
      <div class="divider my-4"></div>
      <div class="flex items-center justify-between">
        <div id="live-hint" class="text-xs text-[color:var(--muted)]">—</div>
        <div class="flex items-center gap-2">
          <button id="prev" class="btn btn-ghost" disabled>◀ <span id="t-prev">السابق</span></button>
          <button id="next" class="btn btn-primary"><span id="t-next">التالي</span> ▶</button>
          <!-- يظهر زر البدء في الشريحة الأخيرة فقط -->
          <button id="generate-current" class="btn btn-primary" style="display:none">⚡ <span id="t-generate">ابدأ الخطة</span></button>
        </div>
      </div>
    </section>

    <!-- Plan -->
    <section class="glass p-5 mt-6">
      <div class="flex items-center justify-between">
        <div class="section-title text-lg flex items-center gap-2">
          <span id="plan-title">الخطة</span>
          <button id="edit-data" class="chip" title="تعديل البيانات">✎ تعديل البيانات</button>
        </div>
        <div class="badge"><i id="run-dot" class="status-dot" style="background:#888"></i><span id="run-label">Idle</span></div>
      </div>

      <div class="my-3">
        <div class="w-full progress"><i id="run-progress"></i></div>
        <div id="run-msg" class="text-xs mt-1 text-[color:var(--muted)]">—</div>
      </div>

      <div id="sections-board" class="flex flex-wrap gap-2 my-2"></div>
      <div id="plan-content" class="ai-content space-y-4"></div>
    </section>

    <section class="flex items-center justify-end gap-2 mt-5">
      <button id="scroll-top" class="btn btn-ghost">↑ <span id="t-top">أعلى</span></button>
      <button id="print-bottom" class="btn btn-primary">🖨 <span id="t-print2">طباعة / PDF</span></button>
    </section>

    <footer class="text-center text-xs text-[color:var(--muted)] mt-6">
      2025 © المدرب مصطفى الصافي — Powered by <strong>Coach Mustafa Elsafy</strong>
    </footer>
  </main>

<script>
/* ===================== CONFIG ===================== */
const ENDPOINT =
  (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
    ? 'http://localhost:8888/.netlify/functions/gemini-proxy'
    : '/.netlify/functions/gemini-proxy';

const MODELS = ['gemini-1.5-pro','gemini-1.5-flash','gemini-2.0-flash-exp'];
let queue = Promise.resolve();

/* ===================== STATE ===================== */
const state = {
  lang:(navigator.language||'ar').startsWith('ar')?'ar':'en',
  theme:'dark',
  step:0,
  currency:detectCurrency(),
  profile:{name:'',age:'',height:'',weight:'',bodyFat:'',waist:'',sex:'Male',targetWeight:'',targetDate:''},
  diet:{
    goals:[], mealsPerDay:3, preferredDiet:'Balanced',
    cuisine:'Arabic', prepTime:20, monthlyBudget:0,
    foodsToAvoid:'',
    allergiesList:[], allergiesOther:'',
    fasting:'off'
  },
  lifestyle:{
    workActivity:'Sedentary', stepsPerDay:6000,
    sleep:'Low', stress:'Low',
    trainingPlace:'Home',
    trainingDaysCount:3,
    sessionHours:1,
    availableDays:[],
    equipment:'',
    experience:'Beginner (0-6m)', rpe:8, caffeine:0, injuries:''
  },
  fitness:{restingHR:'',maxPushups:'',plank:'',kmTime:''},
  muscles:{chest:{on:false,note:''},back:{on:false,note:''},shoulders:{on:false,note:''},biceps:{on:false,note:''},triceps:{on:false,note:''},quads:{on:false,note:''},hamstrings:{on:false,note:''},glutes:{on:false,note:''},calves:{on:false,note:''},abs:{on:false,note:''}},
  medical:{conditions:[],other:'',meds:'',supplements:''},
  challenges:{list:[],other:'',motivation:'Direct'},
  targets:null,
  sectionsBase:['welcome','analysis','allowed','fasting',
    'nutrition-day-1','nutrition-day-2','nutrition-day-3','nutrition-day-4','nutrition-day-5','nutrition-day-6','nutrition-day-7',
    'supplements','progression','troubleshoot','safety','closing'
  ],
  sections:[],
  sectionStatus:{}
};

/* ===================== I18N ===================== */
const T={
  ar:{appTitle:'المستشار الصحي الذكي',subtitle:'خطة دقيقة ١٠٠٪ للتغذية والتدريب والمكملات — مخصصة لك',hint:'سنُولّد الأقسام بالترتيب ويظهر كل قسم بمجرد جاهزيته.',
    steps:['الملف الشخصي','التغذية والتفضيلات','نمط الحياة','الصحة والتحديات'],
    next:'التالي',prev:'السابق',generate:'ابدأ الخطة',top:'أعلى',print2:'طباعة / PDF',
    profile:'الملف الشخصي',dietPrefs:'التغذية والتفضيلات',lifestyle:'نمط الحياة',med:'الصحة والتحديات',
    name:'الاسم',age:'العمر',height:'الطول (سم)',weight:'الوزن (كغ)',bodyFat:'نسبة الدهون % (اختياري)',waist:'محيط الخصر (سم) (اختياري)',sex:'الجنس',
    male:'ذكر',female:'أنثى',targetWeight:'الوزن المستهدف (كغ)',targetDate:'موعد تحقيق الهدف (تاريخ)',
    goals:'الأهداف',fatLoss:'خسارة الدهون',build:'بناء العضلات',strength:'زيادة القوة',endurance:'التحمل',health:'صحة عامة',
    mealsPerDay:'الوجبات/اليوم',preferredDiet:'النظام المفضل',balanced:'متوازن',lowCarb:'قليل الكربوهيدرات',keto:'كيتو',medc:'متوسطي',arabic:'عربي',asian:'آسيوي/شرقي',western:'غربي',veg:'نباتي/مرن',
    fasting:'الصيام المتقطع',off:'غير مفعّل',f16:'16:8',f18:'18:6',f20:'20:4',cuisine:'المطبخ',prepTime:'وقت التحضير (د)',budget:'الميزانية الشهرية',
    foodsAvoid:'أطعمة لا ترغب بها',allergies:'حساسيات شائعة',allergiesOther:'أخرى (أكتب هنا)',workActivity:'طبيعة العمل',steps:'الخطوات/اليوم',sleep:'النوم',stress:'التوتر',
    place:'مكان التمرين',session:'مدة الجلسة (ساعات)',days:'أيام التمرين/الأسبوع',equipment:'المعدات المتاحة',experience:'الخبرة',rpe:'RPE',caffeine:'كافيين/أكواب',injuries:'إصابات أو قيود',
    quick:'اختبار لياقة مبسّط',restingHR:'نبض الراحة (bpm)',pushups:'أقصى Push-ups',plank:'Plank (د)',kmTime:'زمن 1 كم (د:ث)',
    musclesFocus:'نقاط الضعف العضلية',describe:'صف بإيجاز',
    medicalStatus:'الحالة الصحية',otherCond:'أمراض أخرى',currentMeds:'أدوية حالية',currentSupp:'مكملات حالية',
    pastCh:'تحديات منتشرة',pastOther:'أخرى (اكتب هنا)',motiv:'أسلوب التحفيز',motivDir:'عملي مباشر',motivWarm:'تشجيعي وداعم',
    plan:'الخطة',idle:'جاهز',gen:'يتم التوليد…',done:'اكتمل',failed:'فشل',retry:'إعادة توليد هذا القسم',
    waitMsg:'سيظهر كل قسم فور توليده — الرجاء الانتظار…',
    edit:'تعديل البيانات'
  },
  en:{appTitle:'Intelligent Health Coach',subtitle:'100% precise plan for nutrition, training & supplements — fully personalized',hint:'Sections are generated sequentially and appear as soon as they are ready.',
    steps:['Profile','Diet & Preferences','Lifestyle','Medical & Challenges'],
    next:'Next',prev:'Back',generate:'Start Plan',top:'Top',print2:'Print / PDF',
    profile:'Profile',dietPrefs:'Diet & Preferences',lifestyle:'Lifestyle',med:'Medical & Challenges',
    name:'Name',age:'Age',height:'Height (cm)',weight:'Weight (kg)',bodyFat:'Body fat % (optional)',waist:'Waist (cm) (optional)',sex:'Sex',
    male:'Male',female:'Female',targetWeight:'Target weight (kg)',targetDate:'Target date',
    goals:'Goals',fatLoss:'Fat loss',build:'Build muscle',strength:'Strength',endurance:'Endurance',health:'General health',
    mealsPerDay:'Meals/day',preferredDiet:'Preferred diet',balanced:'Balanced',lowCarb:'Low-carb',keto:'Keto',medc:'Mediterranean',arabic:'Arabic',asian:'Asian',western:'Western',veg:'Plant-forward',
    fasting:'Intermittent fasting',off:'Off',f16:'16:8',f18:'18:6',f20:'20:4',cuisine:'Cuisine',prepTime:'Prep time (min)',budget:'Monthly budget',
    foodsAvoid:'Foods to avoid',allergies:'Common allergies',allergiesOther:'Other (type here)',workActivity:'Work/Activity',steps:'Steps/day',sleep:'Sleep',stress:'Stress',
    place:'Training place',session:'Session length (hours)',days:'Training days/week',equipment:'Available equipment',experience:'Experience',rpe:'RPE',caffeine:'Caffeine/day (cups)',injuries:'Injuries/constraints',
    quick:'Quick fitness test',restingHR:'Resting HR (bpm)',pushups:'Max push-ups',plank:'Plank (min)',kmTime:'1 km time (m:s)',
    musclesFocus:'Muscle weak points',describe:'Brief note',
    medicalStatus:'Medical status',otherCond:'Other conditions',currentMeds:'Current medications',currentSupp:'Current supplements',
    pastCh:'Common challenges',pastOther:'Other (type here)',motiv:'Preferred motivation',motivDir:'Direct & pragmatic',motivWarm:'Supportive & encouraging',
    plan:'Plan',idle:'Idle',gen:'Generating…',done:'Done',failed:'Failed',retry:'Retry this section',
    waitMsg:'Each section will appear as soon as it’s generated. Please wait…',
    edit:'Edit data'
  }
};
const t=(k)=> (T[state.lang]&&T[state.lang][k])||k;

/* ===================== HELPERS ===================== */
function detectCurrency(){
  try{
    const loc=Intl.DateTimeFormat().resolvedOptions().locale||navigator.language||'en-US';
    if(loc.includes('EG'))return 'EGP'; if(loc.includes('SA'))return 'SAR'; if(loc.includes('AE'))return 'AED';
    if(loc.includes('QA'))return 'QAR'; if(loc.includes('KW'))return 'KWD'; if(loc.includes('GB'))return 'GBP';
    if(/(DE|FR|IT|ES)/.test(loc))return 'EUR'; return 'USD';
  }catch{ return 'USD'; }
}
function esc(s){return (s??'').toString().replace(/"/g,'&quot;')}
function Lbl(label,id,value='',ph=''){return `<label class="block mb-2"><div class="mb-1">${label}</div><input id="${id}" class="field" value="${esc(value)}" placeholder="${ph}"></label>`}
function Num(label,id,value='',ph=''){return `<label class="block mb-2"><div class="mb-1">${label}</div><input id="${id}" inputmode="numeric" pattern="[0-9]*" class="field" value="${esc(value)}" placeholder="${ph}"></label>`}
function id(x){return document.getElementById(x)}

/* ===================== UI ===================== */
function setLang(lang){
  state.lang=lang; document.documentElement.lang=lang; document.documentElement.dir=(lang==='ar'?'rtl':'ltr');
  id('app-title').textContent=t('appTitle'); id('subtitle').textContent=t('subtitle'); id('hint').textContent=t('hint');
  id('t-prev').textContent=t('prev'); id('t-next').textContent=t('next'); id('t-generate').textContent=t('generate');
  id('t-top').textContent=t('top'); id('t-print2').textContent=t('print2'); id('plan-title').textContent=t('plan');
  id('edit-data').textContent = '✎ ' + t('edit');
  renderStep(); renderBoard();
}
function setTheme(mode){state.theme=mode; if(mode==='light')document.documentElement.classList.add('light'); else document.documentElement.classList.remove('light')}

function renderStep(){
  const titles=T[state.lang].steps; id('step-title').textContent=titles[state.step];
  const el=id('step-body');

  if(state.step===0){
    el.innerHTML=`
      <div class="g">
        <div class="glass p-4 c1">
          <div class="section-title mb-2">${t('profile')}</div>
          ${Lbl(t('name'),'name',state.profile.name,t('name'))}
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('age'),'age',state.profile.age)}
            <label class="block mb-2"><div class="mb-1">${t('sex')}</div>
              <select id="sex" class="field">
                <option value="Male">${t('male')}</option>
                <option value="Female">${t('female')}</option>
              </select>
            </label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('height'),'height',state.profile.height)} ${Num(t('weight'),'weight',state.profile.weight)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('bodyFat'),'bodyFat',state.profile.bodyFat)} ${Num(t('waist'),'waist',state.profile.waist)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('targetWeight'),'targetWeight',state.profile.targetWeight)}
            <label class="block mb-2"><div class="mb-1">${t('targetDate')}</div><input id="targetDate" type="date" class="field" value="${esc(state.profile.targetDate)}"></label>
          </div>
        </div>

        <div class="glass p-4 c2">
          <div class="section-title mb-2">${t('dietPrefs')}</div>
          <div class="mb-2">${t('goals')}</div>
          <div class="grid grid-cols-2 gap-2 mb-2">
            ${['fatLoss','build','strength','endurance','health'].map(k=>`
              <label class="flex items-center gap-2">
                <input type="checkbox" id="g-${k}" class="accent-[var(--brand-2)]" ${state.diet.goals.includes(k)?'checked':''}>
                <span>${t(k)}</span>
              </label>`).join('')}
          </div>

          <div class="grid grid-cols-2 gap-2">
            ${Num(t('mealsPerDay'),'meals',state.diet.mealsPerDay)}
            <label class="block mb-2"><div class="mb-1">${t('preferredDiet')}</div>
              <select id="prefDiet" class="field">
                <option value="Balanced">${t('balanced')}</option>
                <option value="LowCarb">${t('lowCarb')}</option>
                <option value="Keto">${t('keto')}</option>
                <option value="Mediterranean">${t('medc')}</option>
                <option value="Arabic">${t('arabic')}</option>
                <option value="Asian">${t('asian')}</option>
                <option value="Western">${t('western')}</option>
                <option value="Plant">${t('veg')}</option>
              </select>
            </label>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('fasting')}</div>
              <select id="fasting" class="field">
                <option value="off">${t('off')}</option><option value="16:8">${t('f16')}</option>
                <option value="18:6">${t('f18')}</option><option value="20:4">${t('f20')}</option>
              </select>
            </label>
            <label class="block mb-2"><div class="mb-1">${t('cuisine')}</div>
              <select id="cuisine" class="field">
                <option value="Arabic">${t('arabic')}</option>
                <option value="Mediterranean">${t('medc')}</option>
                <option value="Asian">${t('asian')}</option>
                <option value="Western">${t('western')}</option>
                <option value="Plant">${t('veg')}</option>
              </select>
            </label>
          </div>

          <div class="grid grid-cols-2 gap-2">
            ${Num(t('prepTime'),'prep',state.diet.prepTime)}
            <label class="block mb-2"><div class="mb-1">${t('budget')}</div>
              <div class="flex gap-2">
                <input id="budget" class="field flex-1" inputmode="numeric" value="${esc(state.diet.monthlyBudget)}">
                <select id="currency" class="field w-28">
                  ${['USD','EUR','GBP','SAR','AED','KWD','QAR','EGP'].map(c=>`<option ${state.currency===c?'selected':''}>${c}</option>`).join('')}
                </select>
              </div>
            </label>
          </div>

          ${Lbl(t('foodsAvoid'),'avoid',state.diet.foodsToAvoid,"مثال: لا أحب السمك…")}

          <div class="mb-2">
            <div class="mb-1">${t('allergies')}</div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2">
              ${['Gluten','Lactose','Peanuts','Tree nuts','Eggs','Soy','Fish','Shellfish','Sesame','Corn'].map(al=>`
                <label class="flex items-center gap-2 bg-white/5 px-2 py-1 rounded-md border border-white/10">
                  <input type="checkbox" class="accent-[var(--brand-2)]" data-allergy="${al}" ${state.diet.allergiesList.includes(al)?'checked':''}>
                  <span>${al}</span>
                </label>`).join('')}
            </div>
            ${Lbl(t('allergiesOther'),'allergiesOther',state.diet.allergiesOther,'e.g. citrus…')}
          </div>
        </div>

        <div class="glass p-4 c3">
          <div class="section-title mb-2">${t('lifestyle')}</div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('workActivity')}</div>
              <select id="work" class="field"><option value="Sedentary">Sedentary</option><option value="Light">Light</option><option value="Moderate">Moderate</option><option value="High">High</option></select>
            </label>
            ${Num(t('steps'),'steps',state.lifestyle.stepsPerDay)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('sleep')}</div>
              <select id="sleep" class="field"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option></select>
            </label>
            <label class="block mb-2"><div class="mb-1">${t('stress')}</div>
              <select id="stress" class="field"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option></select>
            </label>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('place')}</div>
              <select id="place" class="field">
                <option value="Home">${state.lang==='ar'?'المنزل':'Home'}</option>
                <option value="Gym">${state.lang==='ar'?'الجيم':'Gym'}</option>
                <option value="Home/Gym">${state.lang==='ar'?'كلاهما':'Home & Gym'}</option>
              </select>
            </label>
            ${Num(t('session'),'sessionHours',state.lifestyle.sessionHours)}
          </div>

          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('days')}</div>
              <select id="daysCount" class="field">
                ${[1,2,3,4,5,6,7].map(n=>`<option value="${n}" ${state.lifestyle.trainingDaysCount===n?'selected':''}>${n}</option>`).join('')}
              </select>
            </label>
            ${Lbl(t('equipment'),'equip',state.lifestyle.equipment,'Dumbbells, barbell, bands…')}
          </div>

          <div class="grid grid-cols-2 gap-2">
            <label class="block mb-2"><div class="mb-1">${t('experience')}</div>
              <select id="exp" class="field"><option>Beginner (0-6m)</option><option>Intermediate (6-24m)</option><option>Advanced (24m+)</option></select>
            </label>
            ${Num(t('rpe'),'rpe',state.lifestyle.rpe)}
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${Num(t('caffeine'),'caf',state.lifestyle.caffeine)} ${Lbl(t('injuries'),'inj',state.lifestyle.injuries,'Shoulder impingement…')}
          </div>
        </div>
      </div>`;
    id('sex').value=state.profile.sex||'Male';
    id('prefDiet').value=state.diet.preferredDiet; id('fasting').value=state.diet.fasting; id('currency').value=state.currency;
    id('cuisine').value=state.diet.cuisine; id('place').value=state.lifestyle.trainingPlace;
    id('work').value=state.lifestyle.workActivity; id('sleep').value=state.lifestyle.sleep; id('stress').value=state.lifestyle.stress; id('exp').value=state.lifestyle.experience;
  }

  if(state.step===1){
    el.innerHTML=`
      <div class="glass p-4">
        <div class="section-title mb-2">${t('quick')}</div>
        <div class="grid grid-cols-2 gap-2">
          ${Num(t('restingHR'),'q-hr',state.fitness.restingHR)} ${Num(t('pushups'),'q-pu',state.fitness.maxPushups)}
        </div>
        <div class="grid grid-cols-2 gap-2">
          ${Num(t('plank'),'q-pl',state.fitness.plank)} ${Lbl(t('kmTime'),'q-km',state.fitness.kmTime,'5:30')}
        </div>
      </div>`;
  }

  if(state.step===2){
    el.innerHTML=`
      <div class="glass p-4">
        <div class="section-title mb-2">${t('musclesFocus')}</div>
        ${['chest','back','shoulders','biceps','triceps','quads','hamstrings','glutes','calves','abs'].map(k=>{
          const ar={chest:'الصدر',back:'الظهر',shoulders:'الأكتاف',biceps:'البايسبس',triceps:'الترايسبس',quads:'الأرجل الأمامية',hamstrings:'الأرجل الخلفية',glutes:'المؤخرة',calves:'السمانة',abs:'البطن'};
          const lab=(state.lang==='ar'?ar[k]:k[0].toUpperCase()+k.slice(1)), v=state.muscles[k];
          return `<div class="grid grid-cols-2 gap-2 items-center mb-2">
            <label class="flex items-center gap-2"><input type="checkbox" id="m-${k}" class="accent-[var(--brand-2)]" ${v.on?'checked':''}><span>${lab}</span></label>
            <input id="mnote-${k}" class="field" value="${esc(v.note)}" placeholder="${t('describe')}">
          </div>`;}).join('')}
      </div>`;
  }

  if(state.step===3){
    const items=[['Hypertension','ضغط الدم'],['Diabetes','السكري'],['Insulin Resistance','مقاومة الأنسولين'],['Thyroid issues','مشاكل الغدة'],['Hormonal issues','مشاكل هرمونية'],['Fatty Liver','الكبد الدهني'],['Joint/Knee problems','مشاكل مفاصل/ركب'],['Heart disease','أمراض القلب'],['IBD/Ulcer','IBD/قرحة'],['GERD/Reflux','GERD/ارتجاع'],['Gluten intolerance','عدم تحمل الجلوتين'],['Lactose intolerance','عدم تحمل اللاكتوز']];
    const chList = ['Hunger','Cravings','Busy schedule','Social events','Travel & eating out','Injuries/pain','Low motivation','High stress','Poor sleep'];
    el.innerHTML=`
      <div class="g">
        <div class="glass p-4 c1">
          <div class="section-title mb-2">${t('medicalStatus')}</div>
          <div class="grid md:grid-cols-2 gap-2 mb-2">
            ${items.map(([en,ar],i)=>{const lab=(state.lang==='ar'?ar:en); const chkd=state.medical.conditions.includes(en);
              return `<label class="flex items-center gap-2"><input type="checkbox" id="cond-${i}" class="accent-[var(--brand-2)]" ${chkd?'checked':''}><span>${lab}</span></label>`}).join('')}
          </div>
          ${Lbl(t('otherCond'),'otherCond',state.medical.other)} ${Lbl(t('currentMeds'),'meds',state.medical.meds)} ${Lbl(t('currentSupp'),'supps',state.medical.supplements)}
        </div>

        <div class="glass p-4 c2">
          <div class="section-title mb-2">${t('pastCh')}</div>
          <div class="grid md:grid-cols-2 gap-2 mb-2">
            ${chList.map((c,i)=>`<label class="flex items-center gap-2"><input type="checkbox" class="accent-[var(--brand-2)]" id="ch-${i}" ${state.challenges.list.includes(c)?'checked':''}><span>${state.lang==='ar'?({'Hunger':'الجوع','Cravings':'الرغبة في الأكل','Busy schedule':'انشغال شديد','Social events':'مناسبات اجتماعية','Travel & eating out':'السفر/الأكل خارجاً','Injuries/pain':'إصابات/ألم','Low motivation':'انخفاض الدافع','High stress':'توتر عالٍ','Poor sleep':'نوم سيء'})[c]:c}</span></label>`).join('')}
          </div>
          ${Lbl(t('pastOther'),'pastOther',state.challenges.other)}
          <label class="block mb-2"><div class="mb-1">${t('motiv')}</div>
            <select id="motiv" class="field"><option value="Direct">${t('motivDir')}</option><option value="Warm">${t('motivWarm')}</option></select>
          </label>
        </div>

        <div class="glass p-4 c3">
          <div class="section-title mb-2">${t('plan')}</div>
          <div class="text-sm text-[color:var(--muted)]">${t('waitMsg')}</div>
        </div>
      </div>`;
    id('motiv').value=state.challenges.motivation;
  }

  id('live-hint').textContent=t('hint');
  id('prev').disabled=(state.step===0);
  id('next').disabled=(state.step===3);

  // زر “ابدأ الخطة” في الشريحة الأخيرة فقط
  id('generate-current').style.display = (state.step===3)?'inline-flex':'none';
}

function saveStep(){
  const $=(x)=>id(x);
  if(state.step===0){
    state.profile.name=$('name').value.trim(); state.profile.age=$('age').value.trim();
    state.profile.height=$('height').value.trim(); state.profile.weight=$('weight').value.trim();
    state.profile.bodyFat=$('bodyFat').value.trim(); state.profile.waist=$('waist').value.trim();
    state.profile.sex=$('sex').value; state.profile.targetWeight=$('targetWeight').value.trim(); state.profile.targetDate=$('targetDate').value;

    const goals=[]; ['fatLoss','build','strength','endurance','health'].forEach(k=>{ const el=$('g-'+k); if(el?.checked) goals.push(k) }); state.diet.goals=goals;
    state.diet.mealsPerDay=Number($('meals').value||3);
    state.diet.preferredDiet=$('prefDiet').value; state.diet.fasting=$('fasting').value;
    state.diet.cuisine=$('cuisine').value; state.diet.prepTime=Number($('prep').value||20);
    state.diet.monthlyBudget=Number($('budget').value||0); state.currency=$('currency').value;
    state.diet.foodsToAvoid=$('avoid').value;
    // الحساسية
    state.diet.allergiesList = Array.from(document.querySelectorAll('[data-allergy]')).filter(x=>x.checked).map(x=>x.getAttribute('data-allergy'));
    state.diet.allergiesOther = $('allergiesOther').value.trim();

    state.lifestyle.workActivity=$('work').value; state.lifestyle.stepsPerDay=Number($('steps').value||6000);
    state.lifestyle.sleep=$('sleep').value; state.lifestyle.stress=$('stress').value;
    state.lifestyle.trainingPlace=$('place').value;
    state.lifestyle.sessionHours=Number($('sessionHours').value||1);
    state.lifestyle.trainingDaysCount=Number($('daysCount').value||3);
    state.lifestyle.equipment=$('equip').value; state.lifestyle.experience=$('exp').value;
    state.lifestyle.rpe=Number($('rpe').value||8); state.lifestyle.caffeine=Number($('caf').value||0); state.lifestyle.injuries=$('inj').value;
  }
  if(state.step===1){ state.fitness.restingHR=$('q-hr').value; state.fitness.maxPushups=$('q-pu').value; state.fitness.plank=$('q-pl').value; state.fitness.kmTime=$('q-km').value; }
  if(state.step===2){ Object.keys(state.muscles).forEach(k=>{ const c=id('m-'+k), n=id('mnote-'+k); if(c) state.muscles[k].on=c.checked; if(n) state.muscles[k].note=n.value; }); }
  if(state.step===3){
    const map=['Hypertension','Diabetes','Insulin Resistance','Thyroid issues','Hormonal issues','Fatty Liver','Joint/Knee problems','Heart disease','IBD/Ulcer','GERD/Reflux','Gluten intolerance','Lactose intolerance'];
    state.medical.conditions=[]; for(let i=0;i<12;i++){const el=id('cond-'+i); if(el?.checked) state.medical.conditions.push(map[i]);}
    state.medical.other=$('otherCond').value; state.medical.meds=$('meds').value; state.medical.supplements=$('supps').value;

    const chList = ['Hunger','Cravings','Busy schedule','Social events','Travel & eating out','Injuries/pain','Low motivation','High stress','Poor sleep'];
    state.challenges.list = chList.filter((_,i)=>id('ch-'+i)?.checked);
    state.challenges.other = $('pastOther').value;
    state.challenges.motivation=$('motiv').value;
  }
}

/* ===================== BOARD ===================== */
function buildSections(){
  const n=state.lifestyle.trainingDaysCount||3;
  const training = Array.from({length:n},(_,i)=>`training-day-${i+1}`);
  const base = [...state.sectionsBase];
  if(state.diet.fasting==='off'){
    const idx = base.indexOf('fasting');
    if(idx>-1) base.splice(idx,1);
  }
  const insertAt = base.indexOf('supplements');
  base.splice(insertAt,0,...training);
  state.sections = base;
}
function renderBoard(){
  const board=id('sections-board'); board.innerHTML='';
  buildSections();
  state.sections.forEach(sec=>{
    if(!state.sectionStatus[sec]) state.sectionStatus[sec]={status:'idle'};
    const st=state.sectionStatus[sec].status;
    const color = st==='ok'?'var(--ok)':st==='fail'?'var(--err)':st==='run'?'var(--warn)':'#888';
    const b=document.createElement('button');
    b.className='badge'; b.innerHTML=`<span class="status-dot" style="background:${color}"></span><span>${pretty(sec)}</span>`;
    b.onclick=()=>{const card=id('sec-'+sec); if(card) card.scrollIntoView({behavior:'smooth',block:'center'});};
    board.appendChild(b);
  });
}
const pretty=(idstr)=>{
  if(idstr==='welcome') return state.lang==='ar'?'الترحيب':'Welcome';
  if(idstr==='analysis') return state.lang==='ar'?'التحليل':'Analysis';
  if(idstr==='allowed') return state.lang==='ar'?'المسموح/الممنوع':'Allowed / Limits';
  if(idstr==='fasting') return state.lang==='ar'?'الصيام':'Fasting';
  if(idstr.startsWith('nutrition-day')) return (state.lang==='ar'?'التغذية — يوم ':'Nutrition — Day ')+idstr.split('-').pop();
  if(idstr.startsWith('training-day')) return (state.lang==='ar'?'التدريب — يوم ':'Training — Day ')+idstr.split('-').pop();
  if(idstr==='supplements') return state.lang==='ar'?'المكملات':'Supplements';
  if(idstr==='progression') return state.lang==='ar'?'التقدّم':'Progression';
  if(idstr==='troubleshoot') return state.lang==='ar'?'المشاكل':'Troubleshooting';
  if(idstr==='safety') return state.lang==='ar'?'السلامة':'Safety';
  if(idstr==='closing') return state.lang==='ar'?'الختام':'Closing';
  return idstr;
};

/* ===================== TARGETS & PROMPTS ===================== */
function computeTargets(){
  const p=state.profile,L=state.lifestyle,D=state.diet;
  const W=+p.weight||0,H=+p.height||0,A=+p.age||0;
  const male=(p.sex==='Male'||p.sex===t('male'));
  const BMR= male? 10*W+6.25*H-5*A+5 : 10*W+6.25*H-5*A-161;
  const act={'Sedentary':1.2,'Light':1.35,'Moderate':1.5,'High':1.7}[L.workActivity]||1.35;
  let TDEE=BMR*act; if(D.goals.includes('fatLoss')) TDEE*=0.86; if(D.goals.includes('build')) TDEE*=1.10;
  const targetW=Number(p.targetWeight)||W||1; let protein=Math.round(2.0*targetW); let fat=Math.round(Math.max(0.8*W,40));
  let carbs=Math.round((TDEE-(protein*4+fat*9))/4);
  const hasIR=state.medical.conditions.includes('Diabetes')||state.medical.conditions.includes('Insulin Resistance');
  if(hasIR) carbs=Math.min(carbs,120); carbs=Math.max(40,carbs);
  return {bmr:Math.round(BMR),tdee:Math.round(TDEE),protein_g:protein,fat_g:fat,carb_g:carbs};
}
function headerBlock(){
  const P=state.profile,D=state.diet,L=state.lifestyle,F=state.fitness,T=state.targets;
  const weak=Object.entries(state.muscles).filter(([k,v])=>v.on).map(([k,v])=>`${k}: ${v.note}`).join(', ')||'None';
  const med=state.medical.conditions.join(', ')||'None';
  const tone=state.challenges.motivation==='Direct'?(state.lang==='ar'?'عملي مباشر بلا مبالغة':'Pragmatic, direct, no fluff'):(state.lang==='ar'?'تشجيعي وداعم':'Supportive & warm');
  const goalsLocalized=state.diet.goals.map(k=>t(k)).join(', ');
  const allergies = [...(state.diet.allergiesList||[]), ...(state.diet.allergiesOther?[state.diet.allergiesOther]:[])].join(', ')||'None';
  return `User:${P.name} (${P.sex}, ${P.age}y) | H:${P.height}cm | W:${P.weight}kg
Goals:${goalsLocalized} | Diet:${D.preferredDiet} | Meals:${D.mealsPerDay} | Fast:${D.fasting}
Cuisine:${D.cuisine} | Prep:${D.prepTime}min | Budget:${state.currency} ${D.monthlyBudget} | Allergies:${allergies} | Dislikes:${D.foodsToAvoid}
Activity:${L.workActivity} | Steps:${L.stepsPerDay} | Sleep:${L.sleep} | Stress:${L.stress}
Training place:${L.trainingPlace} | Session:${L.sessionHours}h | Days/week:${L.trainingDaysCount} | RPE:${L.rpe} | Equip:${L.equipment||'Bodyweight'}
Fitness: HR ${F.restingHR||'?'}; PU ${F.maxPushups||'?'}; Plank ${F.plank||'?'}; 1km ${F.kmTime||'?'}
Weak:${weak} | Injuries:${L.injuries||'None'} | Medical:${med}
Targets: ~${T.tdee} kcal; P ${T.protein_g}g / F ${T.fat_g}g / C ${T.carb_g}g
Tone:${tone}. LANGUAGE:${state.lang}.`.trim();
}
function promptFor(section){
  const H=headerBlock();
  const lang=state.lang;
  const long = lang==='ar' ? 'أجب بإسهاب دون اختصار.' : 'Be comprehensive, not brief.';
  const keepScope = lang==='ar'
    ? 'التزم بموضوع هذا القسم فقط. لا تتحدث عن التدريب داخل التغذية ولا العكس.'
    : 'Stay strictly within this section. Do not mix training in nutrition or vice versa.';
  const fattyNote = lang==='ar'
    ? 'إذا وُجدت Fatty Liver فاذكرها بهذا الاسم فقط (الكبد الدهني) ولا تضف تشخيصات لم تُذكر مثل تليّف الكبد.'
    : 'If Fatty Liver exists, name it exactly as Fatty Liver; do not add new diagnoses (e.g., cirrhosis).';
  const noGeneric = lang==='ar'
    ? 'لا تكتب عبارات عامة مثل: هذه الخطة غير مخصصة/استشر مختص.'
    : 'Do not add generic disclaimers like “not personalized/consult a professional”.';

  if(section==='welcome'){
    return `${H}

${long}
${keepScope}
${noGeneric}

اكتب ترحيبًا قصيرًا (3–4 أسطر) يذكر اسم المستخدم (${state.profile.name}) ويؤكد أن الخطة مكملة للأقسام القادمة، دون تكرار بيانات الملف الشخصي حرفيًا.`;
  }

  if(section==='analysis'){
    return `${H}

${long}
${keepScope}
${fattyNote}
- قدّم تحليلًا واضحًا لمنطق السعرات والماكروز والقيود والحياد الميزاني. 
- لا تُدرج جداول وجبات أو تمارين هنا. نقاط/فقرات فقط.`;
  }

  if(section==='allowed'){
    return `${H}

${long}
${keepScope}
- قدّم قائمتين: (١) المسموح والمستحسن حسب المطبخ والميزانية، (٢) المحدود/الممنوع مع مراعاة الحساسية.
- لا تذكر تمارين.`;
  }

  if(section==='fasting' && state.diet.fasting!=='off'){
    return `${H}

${long}
${keepScope}
- اشرح نمط ${state.diet.fasting} للصيام: نافذة الأكل، السوائل، الكافيين، توقيت التمرين المناسب، ومعايير الأمان. لا تذكر جداول وجبات.`;
  }

  if(section.startsWith('nutrition-day')){
    const d=+section.split('-').pop();
    return `${H}

${long}
${keepScope}
STRICT OUTPUT: Markdown table ONLY (no prose).
Columns: | Meal | Ingredients (g) | kcal | Protein | Fat | Carbs |
Rows: 3 main meals + TOTAL row (4 rows).
Daily macros within ±10% of Targets.
Language: ${state.lang}. Day ${d} of 7.`;
  }

  if(section.startsWith('training-day')){
    const d=+section.split('-').pop();
    return `${H}

${long}
${keepScope}
STRICT OUTPUT: Markdown table ONLY.
Columns: | Day | Exercise | Sets | Reps | Rest (sec) |
- ضع أول صف للإحماء عند الحاجة.
- احترم الإصابات ونقاط الضعف.
- صِغ البرنامج ليوم ${d} فقط (لا تُدرج بقية الأيام هنا).`;
  }

  if(section==='supplements'){
    return `${H}

${long}
${keepScope}
- مكملات مبنية على الدليل: أساسي/حسب الهدف/حسب الميزانية مع الجرعات والتوقيت.
- لا تضف تحذيرات عامة.`;
  }
  if(section==='progression'){
    return `${H}

${long}
${keepScope}
- خطة تقدّم 8–12 أسبوعًا: زيادات أحمال/تكرارات/راحة، ديلوود، كارديو، وكيفية تعديل TDEE عند تغيّر الوزن.`;
  }
  if(section==='troubleshoot'){
    return `${H}

${long}
${keepScope}
- حلول عملية للجوع، الثبات، النوم السيّئ، التوتر، الشهوة، السفر/المطاعم (٢–٣ نقاط لكل بند).`;
  }
  if(section==='safety'){
    return `${H}

${long}
${keepScope}
- نقاط السلامة: التقنية، الوقاية من الإصابات، الترطيب، النوم، إشارات التوقف. بدون جداول غذاء/تمارين.`;
  }
  if(section==='closing'){
    return `${H}

${long}
${keepScope}
- خاتمة تحفيزية قصيرة تُخاطب ${state.profile.name} بالاسم وتشير للخطوات التالية باختصار.`;
  }
  return H;
}

/* ===================== API (robust) ===================== */
async function callAI(prompt, opt={}, { attempts=4, sectionId="" } = {}){
  return queue = queue.then(() => _call(prompt, opt, {attempts, sectionId}));
}
async function _call(prompt, opt={}, { attempts, sectionId }){
  for(let i=0;i<attempts;i++){
    const model = MODELS[i % MODELS.length];
    try{
      const body = JSON.stringify({
        prompt, model,
        response_mime_type:'text/markdown',
        temperature: i>=2 ? 0.25 : 0.35,
        top_p: 0.9, max_output_tokens: 8192, section: sectionId
      });
      const ctrl = new AbortController();
      const to = setTimeout(()=>ctrl.abort(), 45000);
      const r = await fetch(ENDPOINT, {method:'POST',headers:{'content-type':'application/json'},body,signal:ctrl.signal});
      clearTimeout(to);

      const raw = await r.text(); let data=null; try{ data=JSON.parse(raw); }catch{}
      if(!r.ok) throw new Error((data && (data.error||data.details||data.message))||raw.slice(0,400));
      const text = (data && data.text) ? String(data.text).trim() : '';
      if(!text || /^<!doctype/i.test(text)) throw new Error('Invalid body');
      return {ok:true, text};
    }catch(e){ await new Promise(res=>setTimeout(res, 700*(i+1))); }
  }
  return {ok:false, error:'Both endpoints failed'};
}

/* Nutrition fallback (rare) */
async function generateNutritionFallback(sectionId){
  const day=+sectionId.split('-').pop();
  const base=headerBlock();
  const mk=(mealName)=>`${base}

STRICT OUTPUT: Markdown single row ONLY for ${mealName}.
Columns: | Meal | Ingredients (g) | kcal | Protein | Fat | Carbs |
Language: ${state.lang}. Day ${day}.`;
  const [r1,r2,r3]=await Promise.all([
    callAI(mk(state.lang==='ar'?'وجبة 1':'Meal 1'),{}, {attempts:3,sectionId}),
    callAI(mk(state.lang==='ar'?'وجبة 2':'Meal 2'),{}, {attempts:3,sectionId}),
    callAI(mk(state.lang==='ar'?'وجبة 3':'Meal 3'),{}, {attempts:3,sectionId})
  ]);
  if(!(r1.ok && r2.ok && r3.ok)) return {ok:false,error:'Both endpoints failed'};
  const total=await callAI(`${base}

You are given three Markdown rows (without header). Compute a TOTAL row and return ONLY that TOTAL row. 
Rows:
${r1.text}
${r2.text}
${r3.text}`,{}, {attempts:2,sectionId});
  if(!total.ok) return {ok:false,error:'Both endpoints failed'};
  return {ok:true,text:r1.text.trim()+"\n"+r2.text.trim()+"\n"+r3.text.trim()+"\n"+total.text.trim()};
}

/* ===================== GENERATION ===================== */
function ensureTargets(){state.targets=computeTargets()}
function planCard(sectionId){
  const wrap=id('plan-content');
  const card=document.createElement('div'); card.className='glass p-4'; card.id='sec-'+sectionId;
  card.innerHTML=`
    <div class="flex items-center justify-between mb-2">
      <div class="section-title">${pretty(sectionId)}</div>
      <button id="retry-${sectionId}" class="chip" style="display:none;">⟳ ${t('retry')}</button>
    </div>
    <div id="note-${sectionId}" class="text-xs text-[color:var(--muted)]">${t('gen')}</div>
    <div class="w-full progress my-2"><i id="bar-${sectionId}" style="width:0%"></i></div>
    <div id="body-${sectionId}" class="ai-content"></div>
    <div id="err-${sectionId}" class="text-xs text-[color:var(--muted)] mt-2"></div>`;
  wrap.appendChild(card);
  id(`retry-${sectionId}`).onclick=()=>regenerateSection(sectionId);
  return card;
}
function setSectionStatus(sec,st,err){
  state.sectionStatus[sec]={status:st,error:err}; renderBoard();
  const dot=id('run-dot');
  if(st==='run'){dot.style.background='var(--warn)'; id('run-label').textContent=t('gen')}
  if(st==='ok'){dot.style.background='var(--ok)'; id('run-label').textContent=t('done')}
  if(st==='fail'){dot.style.background='var(--err)'; id('run-label').textContent=t('failed')}
}
function updateGlobalProgress(p){id('run-progress').style.width=p+'%'; id('global-progress').style.width=p+'%'; id('run-msg').textContent=Math.round(p)+'% — '+t('waitMsg')}

async function generateAllSequential(){
  saveStep(); ensureTargets(); buildSections();
  id('plan-content').innerHTML=''; state.sectionStatus = {}; renderBoard();
  const list=state.sections.slice();
  for(let i=0;i<list.length;i++){ await generateOne(list[i], (i/list.length)*100, ((i+1)/list.length)*100); }
  updateGlobalProgress(100);
}
async function generateOne(sectionId,startPct,endPct){
  setSectionStatus(sectionId,'run'); planCard(sectionId);
  const bodyEl=id('body-'+sectionId), noteEl=id('note-'+sectionId), barEl=id('bar-'+sectionId);
  noteEl.textContent=t('gen');

  let r=await callAI(promptFor(sectionId),{}, {attempts:4,sectionId});
  if(!r.ok && sectionId.startsWith('nutrition-day')) r=await generateNutritionFallback(sectionId);

  if(!r.ok){
    setSectionStatus(sectionId,'fail',r.error);
    id('err-'+sectionId).textContent=r.error||'Failed'; id('retry-'+sectionId).style.display='inline-flex';
    barEl.style.width=(startPct+(endPct-startPct)*.2)+'%'; return;
  }
  bodyEl.innerHTML = marked.parse(r.text);
  noteEl.textContent=t('done'); barEl.style.width='100%'; setSectionStatus(sectionId,'ok'); updateGlobalProgress(endPct);
}
async function regenerateSection(sectionId){
  const card=id('sec-'+sectionId); if(card) card.remove();
  await generateOne(sectionId,0,5);
}

/* ===================== EVENTS ===================== */
id('next').onclick=()=>{saveStep(); state.step=Math.min(3,state.step+1); renderStep()};
id('prev').onclick=()=>{saveStep(); state.step=Math.max(0,state.step-1); renderStep()};
id('generate-current').onclick=()=>generateAllSequential();
id('btn-print').onclick=()=>window.print();
id('print-bottom').onclick=()=>window.print();
id('scroll-top').onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
id('lang-ar').onclick=()=>setLang('ar');
id('lang-en').onclick=()=>setLang('en');
id('toggle-theme').onclick=()=>setTheme(state.theme==='dark'?'light':'dark');
id('edit-data').onclick=()=>{ window.scrollTo({top:0,behavior:'smooth'}); state.step=0; renderStep(); };

/* ===================== INIT ===================== */
window.addEventListener('load',()=>{
  setLang(state.lang); setTheme('dark'); renderStep(); renderBoard();
  id('run-label').textContent=t('idle'); id('hint').textContent=t('hint');
});
</script>
</body>
</html>
