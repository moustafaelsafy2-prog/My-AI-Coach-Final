<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ุงููุณุชุดุงุฑ ุงูุตุญู ุงูุฐูู | Intelligent Health Coach</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --brand:#6c5ce7; --brand2:#00c2ff;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      --card:#0b1220; --muted:#93a2b8;
    }
    html[dir="rtl"] body{font-family:'Tajawal',system-ui,-apple-system,'Segoe UI',Roboto,"Noto Naskh Arabic",sans-serif}
    html[dir="ltr"] body{font-family:'Poppins',system-ui,-apple-system,'Segoe UI',Roboto,Inter,sans-serif}
    body{background:linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%); color:#eaf0ff}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08)}
    .title-grad{background:linear-gradient(90deg,var(--brand),var(--brand2)); -webkit-background-clip:text; background-clip:text; color:transparent}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.70rem 1rem; border-radius:.8rem; font-weight:800; transition:.2s}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff}
    .btn-ghost{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:#eaf0ff}
    .field{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:.7rem; padding:.6rem .8rem; width:100%; outline:none; color:#eaf0ff}
    .field:focus{border-color:var(--brand2); box-shadow:0 0 0 3px rgba(0,194,255,.15)}
    .progress{height:.45rem; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
    .progress > i{display:block; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand2)); width:0%; transition:width .25s ease}
    @media print{
      body{background:#fff; color:#111}
      #bar, #wizard-actions, #fixed-actions {display:none !important}
      .glass{background:#fff; border-color:#ddd}
      .title-grad{color:#111; -webkit-background-clip:unset; background-clip:unset}
    }
  </style>
</head>
<body>

  <!-- Top bar -->
  <header id="bar" class="sticky top-0 z-40 glass">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="size-9 rounded-xl bg-gradient-to-br from-[var(--brand)] to-[var(--brand2)] grid place-items-center font-black">AI</div>
        <div>
          <div class="text-lg font-extrabold">ุงููุณุชุดุงุฑ ุงูุตุญู ุงูุฐูู</div>
          <div class="text-xs text-[color:var(--muted)]">ุฎุทุฉ ุฏูููุฉ ุจูุง ุฅุทุงูุฉ โ ูุฎุตุตุฉ ูู</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-theme" class="btn-ghost rounded-lg px-3">โพ</button>
        <button id="btn-en" class="btn-ghost rounded-lg px-3">EN</button>
        <button id="btn-ar" class="btn-ghost rounded-lg px-3">ุนุฑุจูู</button>
        <button id="btn-print" class="btn-ghost rounded-lg px-3">๐จ ุทุจุงุนุฉ</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Stepper/Hints -->
    <section class="glass rounded-xl p-4 mb-4">
      <div class="flex items-center justify-between">
        <div class="w-full progress"><i id="global-progress"></i></div>
      </div>
    </section>

    <!-- Wizard (Profile / Prefs / Lifestyle / Medical) -->
    <section class="glass rounded-xl p-4 mb-4">
      <div class="flex items-center justify-between">
        <h2 class="title-grad text-xl font-extrabold">ุงูููู ุงูุดุฎุตู</h2>
        <div class="flex items-center gap-2">
          <button id="prev" class="btn btn-ghost" disabled>โ ุงูุณุงุจู</button>
          <button id="next" class="btn btn-primary">ุงูุชุงูู โถ</button>
          <button id="gen-one" class="btn btn-primary" title="ุชูููุฏ ุงููุณู ุงูุญุงูู">โก ุชูููุฏ ุงููุณู ุงูุญุงูู</button>
        </div>
      </div>

      <!-- Step body -->
      <div id="step-body" class="mt-4">
        <!-- Step 0 (profile + core inputs) -->
        <div id="step0" class="grid md:grid-cols-3 gap-3">
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงูุงุณู</div>
            <input id="name" class="field" placeholder="ุงูุงุณู">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงูุนูุฑ</div>
            <input id="age" class="field" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงูุฌูุณ</div>
            <select id="sex" class="field">
              <option value="Male">ุฐูุฑ</option>
              <option value="Female">ุฃูุซู</option>
            </select>
          </label>

          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงูุทูู (ุณู)</div>
            <input id="height" class="field" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงููุฒู (ูุบ)</div>
            <input id="weight" class="field" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงููุฒู ุงููุณุชูุฏู (ูุบ)</div>
            <input id="targetWeight" class="field" inputmode="numeric" pattern="[0-9]*">
          </label>

          <label class="block md:col-span-3">
            <div class="mb-1 text-sm opacity-80">ุงูุฃูุฏุงู</div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
              <label class="flex items-center gap-2"><input id="g-fat" type="checkbox" class="accent-[var(--brand2)]"><span>ุฎุณุงุฑุฉ ุงูุฏููู</span></label>
              <label class="flex items-center gap-2"><input id="g-build" type="checkbox" class="accent-[var(--brand2)]"><span>ุจูุงุก ุงูุนุถูุงุช</span></label>
              <label class="flex items-center gap-2"><input id="g-strength" type="checkbox" class="accent-[var(--brand2)]"><span>ุงูููุฉ</span></label>
              <label class="flex items-center gap-2"><input id="g-endurance" type="checkbox" class="accent-[var(--brand2)]"><span>ุงูุชุญูู</span></label>
              <label class="flex items-center gap-2"><input id="g-health" type="checkbox" class="accent-[var(--brand2)]"><span>ุตุญุฉ ุนุงูุฉ</span></label>
            </div>
          </label>
        </div>

        <!-- Step 1 (diet prefs) -->
        <div id="step1" class="grid md:grid-cols-3 gap-3 hidden">
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุนุฏุฏ ุงููุฌุจุงุช/ููู</div>
            <input id="meals" class="field" value="3" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงููุธุงู ุงูููุถูู</div>
            <select id="prefDiet" class="field">
              <option value="Balanced">ูุชูุงุฒู</option>
              <option value="LowCarb">ูููู ุงููุฑุจูููุฏุฑุงุช</option>
              <option value="Keto">ููุชู</option>
              <option value="Arabic/Mediter.">ูุชูุณุทู/ุนุฑุจู</option>
              <option value="Plant">ูุจุงุชู/ูุฑู</option>
            </select>
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงูุตูุงู ุงููุชูุทุน</div>
            <select id="fasting" class="field">
              <option value="off">ุบูุฑ ููุนูู</option>
              <option>16:8</option><option>18:6</option><option>20:4</option>
            </select>
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงููุทุจุฎ</div>
            <input id="cuisine" class="field" value="Arabic/Mediter.">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุฒูู ุงูุชุญุถูุฑ (ุฏ)</div>
            <input id="prep" class="field" value="20" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงูููุฒุงููุฉ ุงูุดูุฑูุฉ</div>
            <input id="budget" class="field" value="0" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block md:col-span-3">
            <div class="mb-1 text-sm opacity-80">ุฃุทุนูุฉ ูุง ุชุฑุบุจ ุจูุง/ุญุณุงุณูุงุช</div>
            <input id="avoid" class="field" placeholder="ูุซุงู: ูุง ุฃุญุจ ุงูุณููุ ุญุณุงุณูุฉ ูุณุชูโฆ">
          </label>
        </div>

        <!-- Step 2 (lifestyle) -->
        <div id="step2" class="grid md:grid-cols-3 gap-3 hidden">
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงููุดุงุท ุงููุธููู</div>
            <select id="work" class="field">
              <option>Sedentary</option><option>Light</option><option>Moderate</option><option>High</option>
            </select>
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงูุฎุทูุงุช/ุงูููู</div>
            <input id="steps" class="field" value="6000" inputmode="numeric" pattern="[0-9]*">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงูููู</div>
            <select id="sleep" class="field"><option>Low</option><option>Medium</option><option>High</option></select>
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุงูุชูุชุฑ</div>
            <select id="stress" class="field"><option>Low</option><option>Medium</option><option>High</option></select>
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ููุงู ุงูุชุฏุฑูุจ</div>
            <input id="place" class="field" value="Home/Gym">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ูุฏุฉ ุงูุฌูุณุฉ (ุฏ)</div>
            <input id="session" class="field" value="60" inputmode="numeric" pattern="[0-9]*">
          </label>
        </div>

        <!-- Step 3 (medical/challenges) -->
        <div id="step3" class="grid md:grid-cols-2 gap-3 hidden">
          <label class="block md:col-span-2">
            <div class="mb-1 text-sm opacity-80">ุฅุตุงุจุงุช/ูููุฏ</div>
            <input id="injuries" class="field" placeholder="Shoulder impingement โฆ">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุชุญุฏูุงุช ุณุงุจูุฉ</div>
            <input id="past" class="field" placeholder="ุฌูุน ุดุฏูุฏุ ููู ูู ุงูุทุนุงูโฆ">
          </label>
          <label class="block">
            <div class="mb-1 text-sm opacity-80">ุฃุณููุจ ุงูุชุญููุฒ</div>
            <select id="motiv" class="field"><option value="Direct">ุนููู ูุจุงุดุฑ</option><option value="Warm">ุชุดุฌูุนู ูุฏุงุนู</option></select>
          </label>
        </div>
      </div>

      <!-- Bottom actions (persist at the bottom of wizard card) -->
      <div id="wizard-actions" class="mt-5 flex items-center justify-between">
        <div class="text-sm text-[color:var(--muted)]" id="hint">โ ุณูุชู ุฅุธูุงุฑ ูู ูุณู ููุฑ ุชูููุฏู โ</div>
        <div class="flex items-center gap-2">
          <button id="prev-bottom" class="btn btn-ghost" disabled>โ ุงูุณุงุจู</button>
          <button id="next-bottom" class="btn btn-primary">ุงูุชุงูู โถ</button>
          <button id="generate" class="btn btn-primary">โก ุชูููุฏ ุงูุฎุทุฉ ูุงููุฉ</button>
        </div>
      </div>
    </section>

    <!-- Plan output -->
    <section id="plan" class="glass rounded-xl p-5">
      <div class="text-sm text-[color:var(--muted)]" id="plan-empty">โ ุณูุชู ุนุฑุถ ุงูุฃูุณุงู ููุง ููุฑ ุชูููุฏูุง โ</div>
      <div id="plan-content" class="ai-content"></div>
    </section>

    <!-- Footer -->
    <footer class="text-center text-xs text-[color:var(--muted)] mt-6">
      Powered by <strong>Coach Mustafa Elsafy</strong> ยฉ 2025
    </footer>
  </main>

  <!-- ====================== APP LOGIC ====================== -->
  <script>
  /* ---------- App state (ูุฎุชุตุฑ ูุนููู) ---------- */
  const state = {
    lang: (document.documentElement.dir === 'rtl') ? 'ar' : 'en',
    step: 0, // 0..3
    profile: {name:'', age:'', height:'', weight:'', sex:'Male', targetWeight:''},
    diet: { goals:[], mealsPerDay:3, preferredDiet:'Balanced', fasting:'off', cuisine:'Arabic/Mediter.', prepTime:20, monthlyBudget:0, foodsToAvoid:'' },
    lifestyle: { workActivity:'Sedentary', stepsPerDay:6000, sleep:'Low', stress:'Low', trainingPlace:'Home/Gym', sessionLength:60 },
    medical:{ injuries:'', other:'', meds:'', supplements:'' },
    challenges:{ past:'', motivation:'Direct' },
    targets: null
  };

  const $ = (id)=>document.getElementById(id);

  /* ---------- Step navigation ---------- */
  function showStep(){
    for(let i=0;i<=3;i++){
      const s = document.getElementById('step'+i);
      if(s) s.classList.toggle('hidden', state.step!==i);
    }
    $('prev').disabled = $('prev-bottom').disabled = (state.step===0);
    $('next').classList.toggle('hidden', state.step===3);
    $('next-bottom').classList.toggle('hidden', state.step===3);
  }
  function saveStep(){
    if(state.step===0){
      state.profile.name = $('name').value.trim();
      state.profile.age = $('age').value.trim();
      state.profile.sex = $('sex').value;
      state.profile.height = $('height').value.trim();
      state.profile.weight = $('weight').value.trim();
      state.profile.targetWeight = $('targetWeight').value.trim();
      // ุฃูุฏุงู
      const goals=[]; if($('g-fat').checked) goals.push('Fat loss');
      if($('g-build').checked) goals.push('Build muscle');
      if($('g-strength').checked) goals.push('Strength');
      if($('g-endurance').checked) goals.push('Endurance');
      if($('g-health').checked) goals.push('General health');
      state.diet.goals = goals;
    }
    if(state.step===1){
      state.diet.mealsPerDay = +$('meals').value||3;
      state.diet.preferredDiet = $('prefDiet').value;
      state.diet.fasting = $('fasting').value;
      state.diet.cuisine = $('cuisine').value;
      state.diet.prepTime = +$('prep').value||20;
      state.diet.monthlyBudget = +$('budget').value||0;
      state.diet.foodsToAvoid = $('avoid').value;
    }
    if(state.step===2){
      state.lifestyle.workActivity = $('work').value;
      state.lifestyle.stepsPerDay = +$('steps').value||6000;
      state.lifestyle.sleep = $('sleep').value;
      state.lifestyle.stress = $('stress').value;
      state.lifestyle.trainingPlace = $('place').value;
      state.lifestyle.sessionLength = +$('session').value||60;
    }
    if(state.step===3){
      state.medical.injuries = $('injuries').value;
      state.challenges.past = $('past').value;
      state.challenges.motivation = $('motiv').value;
    }
  }
  $('next').onclick = $('next-bottom').onclick = ()=>{
    saveStep();
    state.step = Math.min(3, state.step+1);
    showStep();
  };
  $('prev').onclick = $('prev-bottom').onclick = ()=>{
    state.step = Math.max(0, state.step-1);
    showStep();
  };

  /* ---------- Theme / Lang ---------- */
  $('btn-theme').onclick = ()=>{
    const dark = getComputedStyle(document.body).backgroundImage.includes('#0a0f1c');
    document.body.style.background = dark ? 'linear-gradient(180deg,#eef2ff 0%,#f7f9ff 100%)' : 'linear-gradient(180deg,#0a0f1c 0%,#0e1526 100%)';
  };
  $('btn-print').onclick = ()=>window.print();
  $('btn-ar').onclick = ()=>{ document.documentElement.lang='ar'; document.documentElement.dir='rtl'; state.lang='ar'; };
  $('btn-en').onclick = ()=>{ document.documentElement.lang='en'; document.documentElement.dir='ltr'; state.lang='en'; };

  /* ---------- Targets (Mifflin-St Jeor) ---------- */
  function computeTargets(){
    const p = state.profile, L = state.lifestyle, goals = state.diet.goals;
    const W=+p.weight||0, H=+p.height||0, A=+p.age||0;
    const male = (p.sex==='Male' || p.sex==='ุฐูุฑ');
    const BMR = male ? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161;
    const actMap = {'Sedentary':1.2,'Light':1.35,'Moderate':1.5,'High':1.7};
    let TDEE = BMR*(actMap[L.workActivity]||1.35);
    if(goals.includes('Fat loss')) TDEE*=0.85;
    if(goals.includes('Build muscle')) TDEE*=1.10;
    const targetW = Number(p.targetWeight)||W||1;
    const protein = Math.round(2.0*targetW);
    const fat = Math.round(Math.max(0.8*W, 40));
    let carbs = Math.round((TDEE - (protein*4 + fat*9))/4);
    carbs = Math.max(40, Math.min(carbs, 120 * (state.diet.preferredDiet==='Keto'?1:5)));
    return { bmr:Math.round(BMR), tdee:Math.round(TDEE), protein_g:protein, fat_g:fat, carb_g:carbs };
  }

  /* ---------- PlanState & LLM controls (ุงูุณูุงุจูุฉ + ููุน ุงูุชูุฑุงุฑ) ---------- */
  const PlanState = {
    lang: state.lang,
    profile: null,
    completed: [], // {key,title,text}
    seenLines: new Set(),
    push(key,title,text){ this.completed.push({key,title,text}); },
    context(max=5000){ const s=this.completed.map(x=>`## ${x.title}\n${x.text}`).join('\n\n'); return s.slice(-max); }
  };
  const i18n = {
    ar:{ long:"ุงูุชุจ ุจุฅุณูุงุจ ุฏูู ุงุฎุชุตุงุฑ.", only:"ุงุณุชุฎุฏู ุงูุนุฑุจูุฉ ููุท.", noDup:"ูุง ุชููุฑุฑ ุงูุชุฑุญูุจ/ุงูููู/ุงูุฌููู ุงูุณุงุจูุฉ.", noDisc:"ูุง ุชูุชุจ: ุงูุฎุทุฉ ุนุงูุฉ/ุงุณุชุดุฑ ุฃุฎุตุงุฆูโฆ", flow:"ุญุงูุธ ุนูู ุชุณูุณู ูุณุชูุฏ ููุง ุณุจู.", intro:"ุงุจุฏุฃ ูุจุงุดุฑุฉ ุจูุญุชูู ูุฐุง ุงููุณู.", wait:"โ ุณูุชู ุฅุธูุงุฑ ูู ูุณู ููุฑ ุชูููุฏู โ" },
    en:{ long:"Write in-depth. No summaries.", only:"English only.", noDup:"No repeating welcome/profile/previous lines.", noDisc:"No generic disclaimers.", flow:"Keep narrative continuity.", intro:"Start directly with the section.", wait:"โ Each section appears as itโs ready โ" }
  };
  function buildRules(lang){
    const t=i18n[lang];
    return ['- '+t.long,'- '+t.only,'- '+t.noDup,'- '+t.noDisc,'- '+t.flow,'- '+t.intro,'- ุงุณุชุฎุฏู ููุงุท ูุฌุฏุงูู ุญูุซ ููุฒู.','- ูุง ุชูุฏุฑุฌ ูุณูู HTML.'].join('\n');
  }
  const SECTIONS = [
    {key:'welcome', title:{ar:'ุงูุชุฑุญูุจ',en:'Welcome'}, ask:{ar:"ููุฑุฉ ุชุฑุญูุจูุฉ ูุตูุฑุฉ (3-4 ุฃุณุทุฑ) ูุฑุจูุทุฉ ุจุฃูุฏุงู ุงููุณุชุฎุฏู.",en:"Short welcome (3โ4 lines) tied to profile."}},
    {key:'analysis', title:{ar:'ุงูุชุญููู',en:'Analysis'}, ask:{ar:"ุชุญููู ุงูุณุนุฑุงุช/ุงููุงูุฑูุฒ/ุงููุดุงุท ูุน ุงููููุฌูุฉ.",en:"Calorie/macro/activity analysis with rationale."}},
    {key:'allowed', title:{ar:'ุงููุณููุญ/ุงูููููุน',en:'Allowed / Avoid'}, ask:{ar:"ูุงุฆูุชุงู ูุฎุชุตุฑุชุงู ูุนูููุชุงู ููู ุงููุทุจุฎ ูุงูููุฒุงููุฉ.",en:"Two focused lists tailored to cuisine/budget."}},
    {key:'fasting', title:{ar:'ุงูุตูุงู',en:'Intermittent fasting'}, ask:{ar:"ุชุทุจูู ุขูู ููุตูุงู (ุงูุชูููุช/ุงูุณูุงุฆู/ุงููุงูููู/ุงูุชุฏุฑูุจ).",en:"Safe IF implementation (timing/hydration/caffeine/training)."}},
    ...Array.from({length:7},(_,i)=>({key:`nutrition-${i+1}`,title:{ar:`ุงูุชุบุฐูุฉ โ ููู ${i+1}`,en:`Nutrition โ Day ${i+1}`},ask:{ar:"ุฌุฏูู ูุฌุจุงุช ุงูููู (3โ5) + ุณูุงูุณ: ุงููุฌุจุฉ | ุงูููููุงุช(ุฌุฑุงู) | kcal | Protein | Fat | Carbs + ุตู ุฅุฌูุงูู ยฑ10% ูู ุงูุฃูุฏุงู.",en:"Meals (3โ5) + snacks table with totals within ยฑ10%."}})),
    ...Array.from({length:7},(_,i)=>({key:`training-${i+1}`,title:{ar:`ุงูุชุฏุฑูุจ โ ููู ${i+1}`,en:`Training โ Day ${i+1}`},ask:{ar:"ุฌุฏูู: Exercise(English) | Sets | Reps | Rest(s). ูุฑุงุนุงุฉ ุงูุฅุตุงุจุงุช.",en:"Table: Exercise(English) | Sets | Reps | Rest(s). Respect injuries."}})),
    {key:'supplements', title:{ar:'ุงูููููุงุช',en:'Supplements'}, ask:{ar:"ุญูุฒู ุฃุณุงุณูุฉ/ูุฏููุฉ/ุงูุชุตุงุฏูุฉ ุจุงูุฌุฑุนุงุช ูุงูุชูููุช.",en:"Core/goal/budget stacks with doses and timing."}},
    {key:'progress', title:{ar:'ุงูุชูุฏูู',en:'Progression'}, ask:{ar:"ูููุฐุฌ 8โ12 ุฃุณุจูุนูุง ูุฒูุงุฏุฉ ุงูุฃุญูุงู/ุงูุชูุฑุงุฑุงุช/ุงููุงุฑุฏูู ูุถุจุท ุงูุณุนุฑุงุช.",en:"8โ12 week progression and calorie adjustments."}},
    {key:'troubleshoot', title:{ar:'ุงููุดุงูู',en:'Troubleshooting'}, ask:{ar:"ุญููู ููุฌูุน/ุงูุซุจุงุช/ุงูููู/ุงูุถุบุท/ุงูุดููุงุช/ุงูุณูุฑ/ุงููุทุงุนู (ูขโูฃ ููุงุท).",en:"Playbook for hunger/plateaus/sleep/stress/cravings/travel/eating-out."}},
    {key:'safety', title:{ar:'ุงูุณูุงูุฉ',en:'Safety'}, ask:{ar:"ุณูุงูุฉ ุงูุชูุฑูู ูุงูููู ูุงูุชุฑุทูุจ ููุชู ุชุชููู.",en:"Safety notes and when to stop."}},
    {key:'closing', title:{ar:'ุงูุฎุชุงู',en:'Closing'}, ask:{ar:"ุฎุชุงู ุชุญููุฒู ูุตูุฑ ูุฑุชุจุท ุจุงูุฎุทุฉ ุฏูู ุชุฑุญูุจ ุฌุฏูุฏ.",en:"Short motivating closing tied to the plan."}},
  ];
  function buildPrompt(section, profile){
    const lang=state.lang, t=i18n[lang];
    const rules=buildRules(lang), prev=PlanState.context();
    return [
      `ุงููุณู: ${section.title[lang]}`,
      `ุงููุบุฉ: ${lang==='ar'?'ุงูุนุฑุจูุฉ':'English'}`,
      `ููุงุนุฏ:\n${rules}`,
      "",
      "ุจูุงูุงุช ุงููุณุชุฎุฏู (ูุง ุชุนูุฏ ุทุจุงุนุชูุง):",
      JSON.stringify(profile,null,2),
      "",
      "ุณูุงู ุงูุฃูุณุงู ุงูุณุงุจูุฉ (ููุงูุณูุงุจูุฉ ููุท โ ูุง ุชูุฑุงุฑู):",
      prev || "(ูุง ุณูุงู ุณุงุจู.)",
      "",
      "ุชุนูููุงุช ูุฐุง ุงููุณู:",
      section.ask[lang],
      "",
      "ุงูุชุจ ูุญุชูู ูุฐุง ุงููุณู ููุทุ ูุทููููุง ูุบูุฑ ูุฎุชุตุฑ."
    ].join('\n');
  }
  const RE_STRIP=[/ูุฐู (?:ุงูุฎุทุฉ|ุงููุนูููุงุช).*?(?:ุบูุฑ|ููุณุช).*?(?:ูุฎุตุตุฉ|ุทุจูุฉ)[^\n]*$/gim,/ุงุณุชุดุฑ\s+(?:ุทุจูุจ|ุฃุฎุตุงุฆู|ูุฏุฑุจ)[^\n]*$/gim,/this (?:plan|information).*?(?:not|isn['โ]t).*?(?:personalized|medical advice)[^\n]*$/gim,/consult (?:a )?(?:doctor|physician|dietitian|coach)[^\n]*$/gim,/<!DOCTYPE[\s\S]*?<body[^>]*>/gim,/<\/body>\s*<\/html>/gim];
  function sanitize(text,lang){
    let out=String(text||''); RE_STRIP.forEach(rx=>out=out.replace(rx,'')); 
    if(lang==='ar'){ out=out.split('\n').filter(l=>((l.match(/[\u0600-\u06FF]/g)||[]).length>= (l.match(/[A-Za-z]/g)||[]).length)).join('\n'); }
    else{ out=out.split('\n').filter(l=>((l.match(/[A-Za-z]/g)||[]).length>= (l.match(/[\u0600-\u06FF]/g)||[]).length)).join('\n'); }
    const ded=[]; for(const ln of out.split('\n')){ const k=ln.trim().replace(/\s+/g,' ').toLowerCase(); if(!k){ded.push('');continue;} if(PlanState.seenLines.has(k)) continue; PlanState.seenLines.add(k); ded.push(ln); }
    return ded.join('\n').replace(/\n{3,}/g,'\n\n').trim();
  }
  async function callGemini(prompt){
    const res=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
    if(!res.ok){ throw new Error(await res.text()); }
    const data=await res.json(); return data.text||'';
  }
  function appendSection(title, html){
    $('plan-empty').style.display='none';
    const div=document.createElement('div');
    div.className='mb-6';
    div.innerHTML = `<h3 class="font-extrabold text-lg mb-2">${title}</h3><div class="whitespace-pre-wrap leading-relaxed">${html}</div>`;
    $('plan-content').appendChild(div);
  }
  async function generateSection(section){
    const prompt = buildPrompt(section, PlanState.profile);
    const raw = await callGemini(prompt);
    const clean = sanitize(raw, state.lang);
    appendSection(section.title[state.lang], clean);
    PlanState.push(section.key, section.title[state.lang], clean);
  }

  /* ---------- ุชูููุฏ ุงููุณู ุงูุญุงูู / ุชูููุฏ ุงูุฎุทุฉ ูุงููุฉ ---------- */
  $('gen-one').onclick = async ()=>{
    saveStep();
    // ุฌููุฒ ุงูุฃูุฏุงู
    state.targets = computeTargets();
    PlanState.lang = state.lang;
    PlanState.profile = {...state.profile, diet:state.diet, lifestyle:state.lifestyle, medical:state.medical, challenges:state.challenges, targets:state.targets};
    // ุงุฎุชุฑ ุงููุณู ุงูููุงูู ููุฎุทูุฉ ุงูุญุงููุฉ
    const map = ['welcome','analysis','allowed','fasting'];
    const k = map[state.step] || 'welcome';
    const sec = SECTIONS.find(s=>s.key===k);
    await generateSection(sec);
  };

  $('generate').onclick = async ()=>{
    saveStep();
    if(!(state.profile.name && state.profile.age && state.profile.height && state.profile.weight)){
      alert('ุฃููู ุงูุงุณู/ุงูุนูุฑ/ุงูุทูู/ุงููุฒู ุฃููุงู'); return;
    }
    state.targets = computeTargets();
    PlanState.lang = state.lang;
    PlanState.profile = {...state.profile, diet:state.diet, lifestyle:state.lifestyle, medical:state.medical, challenges:state.challenges, targets:state.targets};
    $('plan-content').innerHTML=''; $('plan-empty').style.display='block';
    document.querySelector('#plan .text-sm')?.textContent = i18n[state.lang].wait;
    const keys = SECTIONS.map(s=>s.key);
    const gbar = $('global-progress');
    for(let i=0;i<keys.length;i++){
      const sec = SECTIONS.find(s=>s.key===keys[i]); if(!sec) continue;
      try{
        await generateSection(sec);
      }catch(e){
        const msg=document.createElement('div');
        msg.className='mb-6';
        msg.innerHTML=`<h3 class="font-extrabold text-lg mb-2">${sec.title[state.lang]}</h3>
        <div class="text-red-400 mb-2">ูุดู ุงูุชูููุฏ: ${String(e).slice(0,180)}</div>
        <button class="btn btn-ghost" data-retry="${sec.key}">ุฅุนุงุฏุฉ ุชูููุฏ ูุฐุง ุงููุณู</button>`;
        $('plan-content').appendChild(msg);
        msg.querySelector('[data-retry]').onclick = async ()=>{
          msg.remove(); await generateSection(sec);
        };
      }
      const pct=Math.round(((i+1)/keys.length)*100); gbar.style.width=pct+'%';
    }
  };

  /* ---------- init ---------- */
  window.addEventListener('load', showStep);
  </script>
</body>
</html>
