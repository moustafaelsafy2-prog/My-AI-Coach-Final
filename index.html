<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
Â  <title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
Â  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
Â  <style>
Â  Â  :root { --card: 255 255 255; }
Â  Â  html, body { height: 100%; scroll-behavior: smooth; }
Â  Â  body { background: linear-gradient(180deg, #f6f7fb 0%, #eef1f7 100%); }
Â  Â  .font-tajawal { font-family: 'Tajawal', sans-serif; }
Â  Â  .font-poppins { font-family: 'Poppins', sans-serif; }
Â  Â  .stage-enter { animation: fadeIn .5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
Â  Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
Â  Â  .card { background: rgba(var(--card)/1); }
Â  Â  .num-input { direction: ltr; text-align: left; }
Â  Â  .file-drop { border: 2px dashed #d1d5db; transition: all .2s; }
Â  Â  .file-drop.ready { border-color: #16a34a; background: #f0fdf4; }
Â  Â  .custom-checkbox-label { border: 2px solid #e5e7eb; transition: all .2s; }
Â  Â  .custom-checkbox-label:has(:checked) { border-color: #4f46e5; background: #eef2ff; box-shadow: 0 0 0 2px #c7d2fe; }
Â  Â  .ai-content h3 { font-size: 1.5rem; font-weight: 800; color: #4338ca; padding-bottom: .5rem; border-bottom: 2px solid #e5e7eb; margin-top: 1.75rem; margin-bottom: 1rem; }
Â  Â  .ai-content h4 { font-size: 1.15rem; font-weight: 700; color: #1f2937; margin-top: 1rem; margin-bottom: .5rem; }
Â  Â  .ai-content table { width: 100%; border-collapse: collapse; margin: 1.25rem 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-radius: .5rem; overflow: hidden; }
Â  Â  .ai-content th, .ai-content td { border: 1px solid #e5e7eb; padding: .75rem; vertical-align: top; }
Â  Â  .ai-content th { background-color: #f9fafb; font-weight: bold; }
Â  Â  [dir="rtl"] .ai-content th, [dir="rtl"] .ai-content td { text-align: right; }
Â  Â  [dir="ltr"] .ai-content th, [dir="ltr"] .ai-content td { text-align: left; }
Â  Â  .ltr-text { direction: ltr; text-align: left; }
Â  Â  @media print {
Â  Â  Â  body { background: #fff; }
Â  Â  Â  #app { box-shadow: none; margin: 0; max-width: 100%; border: none; }
Â  Â  Â  #topbar, #sticky, #progress-wrap, .no-print, #api-key-section { display: none !important; }
Â  Â  }
Â  </style>
</head>
<body class="font-tajawal min-h-screen">
Â  
Â  <div id="app" class="max-w-3xl mx-auto my-4 sm:my-10 card rounded-2xl shadow-2xl overflow-hidden border border-gray-200/50">
Â  Â  <header id="topbar" class="px-4 sm:px-6 py-4 bg-white border-b flex items-center justify-between">
Â  Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  Â  <div class="size-10 rounded-xl bg-indigo-600 text-white grid place-items-center font-extrabold text-lg">AI</div>
Â  Â  Â  Â  <div class="leading-tight">
Â  Â  Â  Â  Â  <h1 class="text-base sm:text-lg font-extrabold text-gray-900">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±</h1>
Â  Â  Â  Â  Â  <p class="text-xs sm:text-sm text-gray-500">Ø®Ø·Ø© Ù…Ø®ØµØµØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ â”‚ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØµØ¯ÙŠØ±</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="flex items-center gap-2" aria-label="Language and Settings">
Â  Â  Â  Â  <button id="btn-ar" class="px-2.5 py-1.5 rounded-lg text-sm font-bold" type="button">Ø¹Ø±Ø¨ÙŠ</button>
Â  Â  Â  Â  <button id="btn-en" class="px-2.5 py-1.5 rounded-lg text-sm font-bold" type="button">EN</button>
Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <div id="progress-wrap" class="px-4 sm:px-6 pt-4 hidden">
Â  Â  Â  <div class="h-2.5 bg-gray-200 rounded-full overflow-hidden" role="progressbar" aria-valuemin="0" aria-valuemax="100">
Â  Â  Â  Â  <div id="progress" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300" style="width:0%"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="mt-2 text-xs text-gray-500">Ø§Ù„Ø®Ø·ÙˆØ© <span id="step">1</span> Ù…Ù† 12</div>
Â  Â  </div>

Â  Â  <main id="content" class="p-5 sm:p-8"></main>

Â  Â  <div id="sticky" class="hidden sticky bottom-0 bg-white/80 backdrop-blur-md border-t px-4 sm:px-6 py-3 flex gap-3 justify-between" style="padding-bottom:calc(.75rem + env(safe-area-inset-bottom))">
Â  Â  Â  <button id="prev" class="w-1/3 sm:w-40 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2.5 rounded-lg disabled:opacity-50" type="button">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
Â  Â  Â  <button id="next" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-extrabold py-2.5 rounded-lg" type="button">Ø§Ù„ØªØ§Ù„ÙŠ</button>
Â  Â  </div>
Â  </div>

<script>
/*************** App State & Configuration ***************/
const totalStages = 12;
let state = { currentStage: 0, lang: 'ar', userData: { goals: [], weak_points: {}, health_conditions: [], allergies: [] } };
let started = false;

/*************** Rate Limiter for API Calls ***************/
const rate = { windowMs: 60_000, max: 8, queue: [] };
const canCall = () => { const now = Date.now(); rate.queue = rate.queue.filter(t => now - t < rate.windowMs); return rate.queue.length < rate.max; };
const markCall = () => rate.queue.push(Date.now());

/*************** DOM Elements ***************/
const content = document.getElementById('content');
const progressWrap = document.getElementById('progress-wrap');
const progressBar = document.getElementById('progress');
const stepEl = document.getElementById('step');
const sticky = document.getElementById('sticky');
const btnPrev = document.getElementById('prev');
const btnNext = document.getElementById('next');

/*************** Internationalization (i18n) ***************/
const i18n = {
Â  ar: {
Â  Â  start:"Ø§Ø¨Ø¯Ø£", welcome_title:"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­ÙˆÙ„!", welcome_desc:"Ø£Ù†Ø§ Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø°ÙƒÙŠØŒ ÙˆÙ…Ù‡Ù…ØªÙŠ Ù‡ÙŠ ØªØµÙ…ÙŠÙ… Ø®Ø·Ø© Ù…Ø®ØµØµØ© Ù„Ùƒ Ø¨Ù†Ø³Ø¨Ø© 100% Ù„ØªØ­Ù‚ÙŠÙ‚ Ø£Ù‡Ø¯Ø§ÙÙƒ. Ù„Ù†Ø¨Ø¯Ø£ Ù…Ø¹Ù‹Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø­Ù„Ø© Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.",
Â  Â  stage_1_title:"Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù…Ù† Ø£Ù†ØªØŸ", stage_1_desc:"Ù„Ù†Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙƒ. Ø§Ø³Ù…Ùƒ Ù‡Ùˆ Ø¨Ø¯Ø§ÙŠØ© ØªØ®ØµÙŠØµ Ù‡Ø°Ù‡ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ù„Ùƒ ÙˆØ­Ø¯Ùƒ.",
Â  Â  stage_2_title:"Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", stage_2_desc:"Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‡ÙŠ Ø­Ø¬Ø± Ø§Ù„Ø£Ø³Ø§Ø³ Ù„Ø­Ø³Ø§Ø¨ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ù…Ù† Ø§Ù„Ø³Ø¹Ø±Ø§Øª ÙˆØªØµÙ…ÙŠÙ… Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ù†Ø§Ø³Ø¨.",
Â  Â  stage_3_title:"ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù", stage_3_desc:"ØªØ­Ø¯ÙŠØ¯ Ø£Ù‡Ø¯Ø§ÙÙƒ Ø¨ÙˆØ¶ÙˆØ­ ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ø¹Ù„Ù‰ ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø®Ø·Ø©.", goal_sub:"ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù‡Ø¯Ù.",
Â  Â  stage_4_title:"Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©", stage_4_desc:"Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ù‡Ø¯Ù Ø±Ù‚Ù…ÙŠ Ù…Ø¹ÙŠÙ† Ø£Ùˆ Ù…Ù†Ø§Ø³Ø¨Ø© Ù‚Ø§Ø¯Ù…Ø©ØŒ ÙØ³Ù†Ø£Ø®Ø° Ø°Ù„Ùƒ ÙÙŠ Ø§Ù„Ø§Ø¹ØªØ¨Ø§Ø±.",
Â  Â  stage_5_title:"Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ Ø§Ù„Ù…ÙØ¶Ù„", stage_5_desc:"Ø£ÙØ¶Ù„ Ù†Ø¸Ø§Ù… Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù‡. Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ù‡Ø¯Ø§ÙÙƒØŒ Ø³Ù†Ø±Ø´Ø­ Ù„Ùƒ Ø§Ù„Ø£Ù†Ø³Ø¨.",
Â  Â  stage_6_title:"Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©", stage_6_desc:"ØµØ­ØªÙƒ Ù‡ÙŠ Ø§Ù„Ø£Ù‡Ù…. ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø­Ø³Ø§Ø³ÙŠØ© ÙŠØ¶Ù…Ù† Ù„Ùƒ Ø®Ø·Ø© Ø¢Ù…Ù†Ø© ÙˆÙØ¹Ø§Ù„Ø©.",
Â  Â  stage_7_title:"Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ", stage_7_desc:"ÙÙ‡Ù… Ø®Ø¨Ø±ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ø¹Ù„Ù‰ Ø¨Ù†Ø§Ø¡ Ø®Ø·Ø© ÙˆØ§Ù‚Ø¹ÙŠØ© ØªØ¨Ø¯Ø£ Ù…Ù† Ù…Ø³ØªÙˆØ§Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ.",
Â  Â  stage_8_title:"Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØªØ±ÙƒÙŠØ²", stage_8_desc:"ØªØ­Ø¯ÙŠØ¯ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙŠØ³Ù…Ø­ Ù„Ù†Ø§ Ø¨ØªØµÙ…ÙŠÙ… Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ÙŠ ÙŠØ±ÙƒØ² Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø¶Ø¹ÙÙƒ.",
Â  Â  stage_9_title:"Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©", stage_9_desc:"ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø®Ø·Ø© Ø¢Ù…Ù†Ø©. Ù…Ø´Ø§Ø±ÙƒØ© Ø£ÙŠ Ø­Ø§Ù„Ø§Øª ØµØ­ÙŠØ© Ø£Ùˆ Ø¥ØµØ§Ø¨Ø§Øª ÙŠØ¶Ù…Ù† ØªØµÙ…ÙŠÙ… Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù„Ø§ ÙŠØ³Ø¨Ø¨ Ù„Ùƒ Ø£ÙŠ Ø¶Ø±Ø±.",
Â  Â  stage_10_title:"Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©", stage_10_desc:"Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù†Ø§Ø¬Ø­Ø© ØªØªÙƒÙŠÙ Ù…Ø¹ Ø­ÙŠØ§ØªÙƒ ÙˆÙ„ÙŠØ³ Ø§Ù„Ø¹ÙƒØ³. Ø·Ø¨ÙŠØ¹Ø© Ø¹Ù…Ù„ÙƒØŒ Ù†ÙˆÙ…ÙƒØŒ ÙˆÙ…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙˆØªØ± ÙƒÙ„Ù‡Ø§ Ø¹ÙˆØ§Ù…Ù„ Ù†Ø£Ø®Ø°Ù‡Ø§ ÙÙŠ Ø§Ù„Ø­Ø³Ø¨Ø§Ù†.",
Â  Â  stage_11_title:"ØªØ­Ù„ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", stage_11_desc:"Ù„Ø£Ù‚ØµÙ‰ Ø¯Ù‚Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±Ùƒ Ø£Ùˆ ØªØ­Ù„ÙŠÙ„ InBody. Ø³ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªÙ‚Ø¯ÙŠÙ… ØªÙˆØµÙŠØ§Øª Ø£ÙƒØ«Ø± ØªØ®ØµÙŠØµÙ‹Ø§.",
Â  Â  name_q:"Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ", age:"Ø§Ù„Ø¹Ù…Ø±", height:"Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)", weight:"Ø§Ù„ÙˆØ²Ù† (ÙƒØº)", gender:"Ø§Ù„Ø¬Ù†Ø³", male:"Ø°ÙƒØ±", female:"Ø£Ù†Ø«Ù‰",
Â  Â  goal1:"Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†", goal2:"Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª", goal3:"Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©", goal4:"ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„", goal5:"ØµØ­Ø© Ø¹Ø§Ù…Ø©",
Â  Â  target_weight:"Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (ÙƒØº)", target_date:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© (Ø¥Ù† ÙˆØ¬Ø¯)",
Â  Â  diet_pref:"Ø£ÙŠ Ù†Ø¸Ø§Ù… ØºØ°Ø§Ø¦ÙŠ ØªÙØ¶Ù„ØŸ", diet_opt1:"Ù†Ø¸Ø§Ù… Ù…ØªÙˆØ§Ø²Ù†", diet_opt2:"Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª", diet_opt3:"ØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹", diet_opt4:"ÙƒÙŠØªÙˆ", diet_opt5:"Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·", diet_opt6:"Ù†Ø¨Ø§ØªÙŠ", recommended:"Ù…Ø±Ø´Ø­ Ù„Ùƒ",
Â  Â  allergies_q:"Ù‡Ù„ ØªØ¹Ø§Ù†ÙŠ Ù…Ù† Ø­Ø³Ø§Ø³ÙŠØ©/Ø§Ù„ØªÙ‡Ø§Ø¨Ø§ØªØŸ", allergies_sub:"Ø§Ø®ØªØ± Ø£ÙŠ Ø­Ø³Ø§Ø³ÙŠØ© Ù…Ø¹Ø±ÙˆÙØ©.", allergy1:"Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†", allergy2:"Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²", allergy3:"Ø§Ù„Ù…ÙƒØ³Ø±Ø§Øª", allergy4:"Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ©", allergy5:"Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø©", allergy6:"Ø§Ù„Ø²ÙŠÙˆØª Ø§Ù„Ù†Ø¨Ø§ØªÙŠØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©", other_allergies:"Ø­Ø³Ø§Ø³ÙŠØ© Ø£Ø®Ø±Ù‰ (Ø§Ø°ÙƒØ±Ù‡Ø§)",
Â  Â  training_history_q:"ØªØ§Ø±ÙŠØ®Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ", history_last_train:"Ù…ØªÙ‰ ÙƒØ§Ù†Øª Ø¢Ø®Ø± Ù…Ø±Ø© Ø§Ù„ØªØ²Ù…ØªØŸ", last_train_opt1:"Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±", last_train_opt2:"Ù…Ù†Ø° 3-12 Ø´Ù‡Ø±", last_train_opt3:"Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†Ø©",
Â  Â  history_exp:"Ø®Ø¨Ø±ØªÙƒ ÙÙŠ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©ØŸ", exp_opt1:"Ù…Ø¨ØªØ¯Ø¦ (0-6 Ø£Ø´Ù‡Ø±)", exp_opt2:"Ù…ØªÙˆØ³Ø· (6-24 Ø´Ù‡Ø±)", exp_opt3:"Ù…ØªÙ‚Ø¯Ù… (Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†ØªÙŠÙ†)", history_supps:"Ù‡Ù„ Ø§Ø³ØªØ®Ø¯Ù…Øª Ù…ÙƒÙ…Ù„Ø§ØªØŸ Ø§Ø°ÙƒØ±Ù‡Ø§.", upload_supps:"Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª",
Â  Â  weak_points_q:"Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØªØ±ÙƒÙŠØ²", weak_points_sub:"Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ù‡Ø¯Ù Ù„ÙƒÙ„ Ù…Ù†Ø·Ù‚Ø©.",
Â  Â  health_q:"ØµØ­ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹", health_cond1:"Ø¶ØºØ· Ø§Ù„Ø¯Ù…", health_cond2:"Ø§Ù„Ø³ÙƒØ±ÙŠ", health_cond3:"Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†", health_cond4:"Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©", health_cond5:"Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ", health_cond6:"Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©", health_cond7:"Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù‡Ø¶Ù…ÙŠ", injuries_q:"Ø¥ØµØ§Ø¨Ø§ØªØŸ", injuries_sub:"Ø§Ø°ÙƒØ± Ø§Ù„Ù…ÙƒØ§Ù† ÙˆØ§Ù„ÙˆØµÙ",
Â  Â  lifestyle_q:"Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©", job:"Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¹Ù…Ù„", job_opt1:"Ø¹Ù…Ù„ Ù…ÙƒØªØ¨ÙŠ", job_opt2:"Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ", job_opt3:"Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·", sleep:"Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù†ÙˆÙ… Ù„ÙŠÙ„Ø§Ù‹", stress:"Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙˆØªØ±", stress_opt1:"Ù…Ù†Ø®ÙØ¶", stress_opt2:"Ù…ØªÙˆØ³Ø·", stress_opt3:"Ù…Ø±ØªÙØ¹",
Â  Â  files_q:"Ù„Ø£Ù‚ØµÙ‰ Ø¯Ù‚Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±/InBody.", files_sub:"(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", photos_up:"ğŸ“· Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ø¬Ø³Ù…", inbody_up:"ğŸ“„ Ø±ÙØ¹ ØªØ­Ù„ÙŠÙ„ InBody", photos_done:(n)=>`âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${n} ØµÙˆØ±!`, inbody_done:"âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù InBody!",
Â  Â  loading_title:(n)=>`Ù„Ø­Ø¸Ø§Øª Ù…Ù† ÙØ¶Ù„Ùƒ ÙŠØ§ ${n}...`, loading_sub:"ÙŠÙ‚ÙˆÙ… Ø®Ø¨ÙŠØ±Ù†Ø§ Ø§Ù„Ø°ÙƒÙŠ Ø¨ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø¨Ù†Ø§Ø¡ Ø®Ø·Ø© Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©.", print_btn:"Ø·Ø¨Ø§Ø¹Ø© / ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·Ø©", restart_btn:"Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯", next:"Ø§Ù„ØªØ§Ù„ÙŠ", prev:"Ø§Ù„Ø³Ø§Ø¨Ù‚", submit:"Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†!", swap:"ØªØ¨Ø¯ÙŠÙ„", swapping:"Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„...", error_fill_fields:"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.",
Â  Â  chest:"Ø§Ù„ØµØ¯Ø±", back:"Ø§Ù„Ø¸Ù‡Ø±", shoulders:"Ø§Ù„Ø£ÙƒØªØ§Ù", biceps:"Ø§Ù„Ø¨Ø§ÙŠØ³Ø¨Ø³", triceps:"Ø§Ù„ØªØ±Ø§ÙŠØ³Ø¨Ø³", quads:"Ø§Ù„Ø£Ø±Ø¬Ù„ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©", hamstrings:"Ø§Ù„Ø£Ø±Ø¬Ù„ Ø§Ù„Ø®Ù„ÙÙŠØ©", glutes:"Ø§Ù„Ù…Ø¤Ø®Ø±Ø©", calves:"Ø§Ù„Ø³Ù…Ø§Ù†Ø©", abs:"Ø§Ù„Ø¨Ø·Ù†",
Â  Â  export:"ØªØµØ¯ÙŠØ±", export_json:"JSON", export_csv:"CSV", days_check:"ÙØ­Øµ Ø§Ù„Ø£ÙŠØ§Ù…", nutrition:"Ø§Ù„ØªØºØ°ÙŠØ© (7 Ø£ÙŠØ§Ù…)", training:"Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)", daily_targets:"Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ÙŠÙˆÙ…ÙŠØ©",
Â  Â  api_key_error: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…Ù† Ø®Ø¯Ù…Ø© Google Ø£Ùˆ Ø£Ù† Ù…ÙØªØ§Ø­ API Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
Â  },
Â  en: {
Â  Â  // English translations are omitted for brevity
Â  }
};
const muscles = ['chest', 'back', 'shoulders', 'biceps', 'triceps', 'quads', 'hamstrings', 'glutes', 'calves', 'abs'];

/*************** Helper Functions ***************/
function T(key, ...args) { const t = i18n[state.lang]?.[key]; return typeof t === 'function' ? t(...args) : (t || key); }

function applyLocale() {
Â  const html = document.documentElement;
Â  html.lang = state.lang;
Â  html.dir = state.lang === 'ar' ? 'rtl' : 'ltr';
Â  document.body.classList.toggle('font-tajawal', state.lang === 'ar');
Â  document.body.classList.toggle('font-poppins', state.lang !== 'ar');
Â  document.getElementById('btn-ar').className = `px-2.5 py-1.5 rounded-lg text-sm font-bold ${state.lang === 'ar' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'}`;
Â  document.getElementById('btn-en').className = `px-2.5 py-1.5 rounded-lg text-sm font-bold ${state.lang === 'en' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'}`;
Â  if (started) {
Â  Â  btnPrev.textContent = T('prev');
Â  Â  btnNext.textContent = state.currentStage === totalStages ? T('submit') : T('next');
Â  }
}

function updateProgress() {
Â  const p = Math.max(0, ((state.currentStage - 1) / totalStages) * 100);
Â  progressBar.style.width = `${p}%`;
Â  stepEl.textContent = String(Math.min(state.currentStage, totalStages));
Â  progressWrap.classList.toggle('hidden', !started || state.currentStage === 0 || state.currentStage > totalStages);
}

function field(label, id, opts = {}) {
Â  const { type = 'text', value = '', required = false, select = null, placeholder = '', num = false } = opts;
Â  if (select) {
Â  Â  return `<label class="block"><span class="font-medium text-gray-800">${label}</span><select id="${id}" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">${select.map(o => `<option ${String(value) === String(o.value) ? 'selected' : ''} value="${o.value}">${o.label}</option>`).join('')}</select></label>`;
Â  }
Â  if (type === 'textarea') {
Â  Â  return `<label class="block"><span class="font-medium text-gray-800">${label}</span><textarea id="${id}" rows="3" placeholder="${placeholder}" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">${value || ''}</textarea></label>`;
Â  }
Â  return `<label class="block"><span class="font-medium text-gray-800">${label}</span><input id="${id}" type="${type}" ${required ? 'required' : ''} value="${value}" placeholder="${placeholder}" ${num ? 'inputmode="numeric" pattern="[0-9]*"' : ''} class="${num ? 'num-input ' : ''}mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></label>`;
}

function stageLayout(title, desc, inner) {
Â  return `<section class="stage-enter" aria-live="polite"><h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900">${title}</h2><p class="mt-1 text-gray-600">${desc || ''}</p><form id="form" class="space-y-5 mt-6" onsubmit="event.preventDefault();">${inner}</form></section>`;
}

/*************** Stage Rendering Logic ***************/
function renderStage(stage) {
Â  applyLocale();
Â  updateProgress();
Â  const spinner = '<div class="py-14 grid place-items-center"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500" aria-hidden="true"></div></div>';
Â  content.innerHTML = spinner;

Â  setTimeout(() => {
Â  Â  const s = state.userData;
Â  Â  let title = '', desc = '', html = '';
Â  Â  switch (stage) {
Â  Â  Â  case 0:
Â  Â  Â  Â  content.innerHTML = `<section class="stage-enter text-center p-6 sm:p-10"><h2 class="text-3xl font-extrabold text-gray-900 mb-2">${T('welcome_title')}</h2><p class="text-gray-600 max-w-xl mx-auto">${T('welcome_desc')}</p><div class="mt-8"><div class="inline-flex gap-2 items-center"><select id="lang-select" class="p-3 rounded-lg border-gray-300 border"><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option></select><button id="start" class="bg-indigo-600 hover:bg-indigo-700 text-white font-extrabold px-8 py-3 rounded-xl" type="button">${T('start')}</button></div></div></section>`;
Â  Â  Â  Â  document.getElementById('start').onclick = () => {
Â  Â  Â  Â  Â  state.lang = document.getElementById('lang-select').value;
Â  Â  Â  Â  Â  started = true;
Â  Â  Â  Â  Â  sticky.classList.remove('hidden');
Â  Â  Â  Â  Â  btnPrev.disabled = true;
Â  Â  Â  Â  Â  state.currentStage = 1;
Â  Â  Â  Â  Â  renderStage(1);
Â  Â  Â  Â  };
Â  Â  Â  Â  break;
Â  Â  Â  case 1:
Â  Â  Â  Â  title = T('stage_1_title'); desc = T('stage_1_desc'); html = field(T('name_q'), 'name', { required: true, value: s.name || '' });
Â  Â  Â  Â  content.innerHTML = stageLayout(title, desc, html);
Â  Â  Â  Â  document.getElementById('name').focus();
Â  Â  Â  Â  break;
Â  Â  Â  case 2:
Â  Â  Â  Â  title = T('stage_2_title'); desc = T('stage_2_desc');
Â  Â  Â  Â  html = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${field(T('age'), 'age', { type: 'number', value: s.age || '', required: true, num: true })}${field(T('height'), 'height', { type: 'number', value: s.height || '', required: true, num: true })}${field(T('weight'), 'weight', { type: 'number', value: s.weight || '', required: true, num: true })}${field(T('gender'), 'gender', { select: [{ value: 'Male', label: T('male') }, { value: 'Female', label: T('female') }], value: s.gender || 'Male' })}</div>`;
Â  Â  Â  Â  content.innerHTML = stageLayout(title, desc, html);
Â  Â  Â  Â  break;
Â  Â  Â  case 3:
Â  Â  Â  Â  title = T('stage_3_title'); desc = T('stage_3_desc');
Â  Â  Â  Â  const goals = ['goal1', 'goal2', 'goal3', 'goal4', 'goal5'];
Â  Â  Â  Â  html = `<p class="text-sm text-gray-500">${T('goal_sub')}</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">${goals.map(k => { const v = T(k); const on = (s.goals || []).includes(v) ? 'checked' : ''; return `<label class="custom-checkbox-label block p-4 rounded-lg cursor-pointer"><input ${on} type="checkbox" name="goal" value="${v}" class="mr-4 ml-2 accent-indigo-600"><span>${v}</span></label>` }).join('')}</div>`;
Â  Â  Â  Â  content.innerHTML = stageLayout(title, desc, html);
Â  Â  Â  Â  break;
Â  Â  Â  case 4:
Â  Â  Â  Â  title = T('stage_4_title'); desc = T('stage_4_desc');
Â  Â  Â  Â  html = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${field(T('target_weight'), 'target_weight', { type: 'number', value: s.target_weight || '', num: true })}${field(T('target_date'), 'target_date', { type: 'date', value: s.target_date || '' })}</div>`;
Â  Â  Â  Â  content.innerHTML = stageLayout(title, desc, html);
Â  Â  Â  Â  break;
Â  Â  Â  case 5:
Â  Â  Â  Â  title = T('stage_5_title'); desc = T('stage_5_desc');
Â  Â  Â  Â  let rec = T('diet_opt1');
Â  Â  Â  Â  if ((s.goals || []).includes(T('goal1'))) rec = T('diet_opt2');
Â  Â  Â  Â  const dietKeys = ['diet_opt1', 'diet_opt2', 'diet_opt3', 'diet_opt4', 'diet_opt5', 'diet_opt6'];
Â  Â  Â  Â  html = `${field(T('diet_pref'), 'diet_preference', { select: dietKeys.map(k => ({ value: T(k), label: `${T(k)}${rec === T(k) ? ` (${T('recommended')})` : ''}` })), value: s.diet_preference || T('diet_opt1') })}`;
Â  Â  Â  Â  content.innerHTML = stageLayout(title, desc, html);
Â  Â  Â  Â  break;
Â  Â  Â  case 6:
Â  Â  Â  Â  title = T('stage_6_title'); desc = T('stage_6_desc');
Â  Â  Â  Â  const allergyVals = [T('allergy1'), T('allergy2'), T('allergy3'), T('allergy4'), T('allergy5'), T('allergy6')];
Â  Â  Â  Â  html = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${allergyVals.map(v => { const on = (s.allergies || []).includes(v) ? 'checked' : ''; return `<label class="custom-checkbox-label block p-3 rounded-lg cursor-pointer"><input ${on} type="checkbox" name="allergy" value="${v}" class="mr-4 ml-2 accent-indigo-600"><span>${v}</span></label>` }).join('')}</div>${field(T('other_allergies'), 'other_allergies', { value: s.other_allergies || '' })}`;
Â  Â  Â  Â  content.innerHTML = stageLayout(title, desc, html);
Â  Â  Â  Â  break;
Â  Â  Â  case 7:
Â  Â  Â  Â  title = T('stage_7_title'); desc = T('stage_7_desc');
Â  Â  Â  Â  html = `${field(T('history_last_train'), 'last_train', { select: [{ value: T('last_train_opt1'), label: T('last_train_opt1') }, { value: T('last_train_opt2'), label: T('last_train_opt2') }, { value: T('last_train_opt3'), label: T('last_train_opt3') }], value: s.last_train || T('last_train_opt1') })}${field(T('history_exp'), 'training_exp', { select: [{ value: T('exp_opt1'), label: T('exp_opt1') }, { value: T('exp_opt2'), label: T('exp_opt2') }, { value: T('exp_opt3'), label: T('exp_opt3') }], value: s.training_exp || T('exp_opt1') })}${field(T('history_supps'), 'prev_supps', { value: s.prev_supps || '', placeholder: 'Omegaâ€‘3, Vitamin D ...' })}<label class="file-drop p-3 mt-2 block text-center rounded-lg cursor-pointer text-sm"><span id="supp-feedback">${T('upload_supps')}</span><input type="file" id="supp_photos" class="hidden" multiple accept="image/*"></label>`;
Â  Â  Â  Â  content.innerHTML = stageLayout(title, desc, html);
Â  Â  Â  Â  attachFileListeners();
Â  Â  Â  Â  break;
Â  Â  Â  case 8:
Â  Â  Â  Â  title = T('stage_8_title'); desc = T('stage_8_desc');
Â  Â  Â  Â  html = `<div class="space-y-4">${muscles.map(m => `<div class="relative flex items-start"><div class="flex items-center h-5"><input id="${m}" name="${m}" type="checkbox" ${(s.weak_points || {})[m] ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"></div><div class="ml-3 mr-3 text-sm flex-1"><label for="${m}" class="font-medium text-gray-700">${T(m)}</label><input type="text" id="${m}_desc" class="w-full p-1 border-b-2 focus:border-indigo-500 outline-none" value="${(s.weak_points || {})[m] || ''}" placeholder="${T('weak_points_sub')}"></div></div>`).join('')}</div>`;
Â  Â  Â  Â  content.innerHTML = stageLayout(title, desc, html);
Â  Â  Â  Â  break;
Â  Â  Â  case 9:
Â  Â  Â  Â  title = T('stage_9_title'); desc = T('stage_9_desc');
Â  Â  Â  Â  const cond = ['health_cond1', 'health_cond2', 'health_cond3', 'health_cond4', 'health_cond5', 'health_cond6', 'health_cond7'];
Â  Â  Â  Â  html = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${cond.map(k => { const v = T(k); const on = (s.health_conditions || []).includes(v) ? 'checked' : ''; return `<label class="custom-checkbox-label block p-3 rounded-lg cursor-pointer"><input ${on} type="checkbox" name="health_condition" value="${v}" class="mr-4 ml-2 accent-indigo-600"><span>${v}</span></label>` }).join('')}</div>${field(T('injuries_q'), 'injuries', { type: 'textarea', value: s.injuries || '', placeholder: T('injuries_sub') })}`;
Â  Â  Â  Â  content.innerHTML = stageLayout(title, desc, html);
Â  Â  Â  Â  break;
Â  Â  Â  case 10:
Â  Â  Â  Â  title = T('stage_10_title'); desc = T('stage_10_desc');
Â  Â  Â  Â  html = `<div class="grid grid-cols-1 sm:grid-cols-3 gap-4">${field(T('job'), 'job_activity', { select: [{ value: T('job_opt1'), label: T('job_opt1') }, { value: T('job_opt2'), label: T('job_opt2') }, { value: T('job_opt3'), label: T('job_opt3') }], value: s.job_activity || T('job_opt1') })}${field(T('sleep'), 'sleep_hours', { type: 'number', value: s.sleep_hours || '', required: true, num: true })}${field(T('stress'), 'stress_level', { select: [{ value: T('stress_opt1'), label: T('stress_opt1') }, { value: T('stress_opt2'), label: T('stress_opt2') }, { value: T('stress_opt3'), label: T('stress_opt3') }], value: s.stress_level || T('stress_opt2') })}</div>`;
Â  Â  Â  Â  content.innerHTML = stageLayout(title, desc, html);
Â  Â  Â  Â  break;
Â  Â  Â  case 11:
Â  Â  Â  Â  title = T('stage_11_title'); desc = T('stage_11_desc');
Â  Â  Â  Â  html = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><label class="file-drop p-6 block text-center rounded-xl cursor-pointer"><span id="photo-feedback">${T('photos_up')}</span><input type="file" id="photos" class="hidden" multiple accept="image/*"></label><label class="file-drop p-6 block text-center rounded-xl cursor-pointer"><span id="inbody-feedback">${T('inbody_up')}</span><input type="file" id="inbody" class="hidden" accept="image/*,.pdf"></label></div>`;
Â  Â  Â  Â  content.innerHTML = stageLayout(title, desc, html);
Â  Â  Â  Â  attachFileListeners();
Â  Â  Â  Â  break;
Â  Â  Â  case 12:
Â  Â  Â  Â  content.innerHTML = `<section class="stage-enter text-center p-8"><div class="no-print"><h2 class="text-2xl font-extrabold text-gray-900 mb-2">${T('loading_title', s.name || '')}</h2><p class="text-gray-600">${T('loading_sub')}</p><div class="mt-6 animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600 mx-auto" aria-hidden="true"></div></div><div id="plan" class="mt-8 ai-content" dir="${state.lang === 'ar' ? 'rtl' : 'ltr'}"></div><div id="qc" class="mt-3 text-xs text-gray-500"></div><div class="no-print mt-6 flex flex-wrap gap-3 justify-center"><button id="btn-print" class="hidden bg-green-600 hover:bg-green-700 text-white font-extrabold px-6 py-2.5 rounded-lg" type="button">${T('print_btn')}</button><div class="hidden" id="export-wrap"><span class="px-3 py-2 bg-gray-100 rounded-lg text-sm font-medium">${T('export')}:</span><button id="exp-json" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold px-3 py-2 rounded-lg" type="button">${T('export_json')}</button><button id="exp-csv" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold px-3 py-2 rounded-lg" type="button">${T('export_csv')}</button></div><button id="btn-restart" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-800 font-extrabold px-6 py-2.5 rounded-lg" type="button">${T('restart_btn')}</button></div></section>`;
Â  Â  Â  Â  generatePlan();
Â  Â  Â  Â  break;
Â  Â  }
Â  Â  if (started) {
Â  Â  Â  btnNext.textContent = state.currentStage === totalStages ? T('submit') : T('next');
Â  Â  Â  btnNext.className = `flex-1 ${state.currentStage === totalStages ? 'bg-green-600 hover:bg-green-700' : 'bg-indigo-600 hover:bg-indigo-700'} text-white font-extrabold py-2.5 rounded-lg`;
Â  Â  Â  btnPrev.textContent = T('prev');
Â  Â  Â  btnPrev.disabled = state.currentStage <= 1;
Â  Â  }
Â  }, 200);
}

/*************** Form Saving & Navigation ***************/
function saveAndNext(stage) {
Â  try {
Â  Â  const s = state.userData;
Â  Â  switch (stage) {
Â  Â  Â  case 0: break;
Â  Â  Â  case 1: s.name = document.getElementById('name').value.trim(); if (!s.name) throw 0; break;
Â  Â  Â  case 2: s.age = document.getElementById('age').value; s.height = document.getElementById('height').value; s.weight = document.getElementById('weight').value; s.gender = document.getElementById('gender').value; if (!s.age || !s.height || !s.weight) throw 0; break;
Â  Â  Â  case 3: s.goals = [...document.querySelectorAll('input[name="goal"]:checked')].map(e => e.value); if (!s.goals.length) throw 0; break;
Â  Â  Â  case 4: s.target_weight = document.getElementById('target_weight').value; s.target_date = document.getElementById('target_date').value; break;
Â  Â  Â  case 5: s.diet_preference = document.getElementById('diet_preference').value; break;
Â  Â  Â  case 6: s.allergies = [...document.querySelectorAll('input[name="allergy"]:checked')].map(e => e.value); { const other = document.getElementById('other_allergies').value.trim(); if (other) s.allergies.push(other); } break;
Â  Â  Â  case 7: s.last_train = document.getElementById('last_train').value; s.training_exp = document.getElementById('training_exp').value; s.prev_supps = document.getElementById('prev_supps').value; s.has_supp_photos = document.getElementById('supp_photos')?.files.length > 0; break;
Â  Â  Â  case 8: s.weak_points = {}; muscles.forEach(m => { const cb = document.getElementById(m); if (cb?.checked) s.weak_points[m] = document.getElementById(`${m}_desc`).value || 'General Strengthening' }); break;
Â  Â  Â  case 9: s.health_conditions = [...document.querySelectorAll('input[name="health_condition"]:checked')].map(e => e.value); s.injuries = document.getElementById('injuries').value; break;
Â  Â  Â  case 10: s.job_activity = document.getElementById('job_activity').value; s.sleep_hours = document.getElementById('sleep_hours').value; s.stress_level = document.getElementById('stress_level').value; if (!s.sleep_hours) throw 0; break;
Â  Â  Â  case 11: s.has_photos = document.getElementById('photos')?.files.length > 0; s.has_inbody = document.getElementById('inbody')?.files.length > 0; break;
Â  Â  }
Â  Â  state.currentStage++;
Â  Â  renderStage(state.currentStage);
Â  } catch (e) {
Â  Â  showNotification(T('error_fill_fields'), 'error');
Â  }
}

function goBack() {
Â  if (state.currentStage > 1) {
Â  Â  state.currentStage--;
Â  Â  renderStage(state.currentStage);
Â  }
}
btnPrev.onclick = goBack;
btnNext.onclick = () => { saveAndNext(state.currentStage); };

/*************** File Input Listeners ***************/
function attachFileListeners() {
Â  const p = document.getElementById('photos'); if (p) p.addEventListener('change', e => { const f = document.getElementById('photo-feedback'); f.textContent = i18n[state.lang].photos_done(e.target.files.length); f.parentElement.classList.add('ready'); });
Â  const i = document.getElementById('inbody'); if (i) i.addEventListener('change', () => { const f = document.getElementById('inbody-feedback'); f.textContent = T('inbody_done'); f.parentElement.classList.add('ready'); });
Â  const s = document.getElementById('supp_photos'); if (s) s.addEventListener('change', e => { const f = document.getElementById('supp-feedback'); f.textContent = i18n[state.lang].photos_done(e.target.files.length); f.parentElement.classList.add('ready'); });
}

/*************** Calculations Engine ***************/
function computeTargets(p) {
Â  const W = Number(p.weight) || 0, H = Number(p.height) || 0, A = Number(p.age) || 0;
Â  const male = p.gender === 'Male';
Â  const BMR = male ? 10 * W + 6.25 * H - 5 * A + 5 : 10 * W + 6.25 * H - 5 * A - 161;
Â  const factor = (p.job_activity === T('job_opt1') ? 1.2 : p.job_activity === T('job_opt3') ? 1.5 : 1.35);
Â  let TDEE = BMR * factor;
Â  const goals = p.goals || [];
Â  if (goals.includes(T('goal1'))) TDEE *= 0.85; else if (goals.includes(T('goal2'))) TDEE *= 1.1;
Â  const targetW = Number(p.target_weight) || W || 1;
Â  const protein_g = Math.round(2.0 * targetW);
Â  const fat_g = Math.round(Math.max(0, 0.8 * W));
Â  let carb_g = Math.round((TDEE - (protein_g * 4 + fat_g * 9)) / 4);
Â  const hasIR = (p.health_conditions || []).some(h => [T('health_cond2'), T('health_cond3')].includes(h));
Â  if (hasIR) carb_g = Math.min(carb_g, 120); // Carb guardrail
Â  carb_g = Math.max(0, carb_g);
Â  return { calories: Math.round(TDEE), macros: { protein_g, fat_g, carb_g } };
}

/*************** AI Generation & Rendering ***************/
let lastPlanJSON = null;

async function generatePlan() {
    const p = state.userData;
    const targets = computeTargets(p);

    const proxyUrl = '/.netlify/functions/gemini-proxy';
    
    const prompt = buildAIPrompt(p, state.lang, targets);
    const aiResponse = await callAI(prompt, proxyUrl);

    if (aiResponse.ok && aiResponse.text) {
        renderAI(aiResponse.text);
    } else {
        console.error("AI call failed.", aiResponse.error);
        renderErrorMessage(aiResponse.error);
    }
    
    document.getElementById('btn-print').classList.remove('hidden');
    document.getElementById('btn-restart').classList.remove('hidden');
    document.getElementById('export-wrap').classList.remove('hidden');
    document.getElementById('btn-print').onclick = () => window.print();
    document.getElementById('exp-json').onclick = () => exportJSON(lastPlanJSON);
    document.getElementById('exp-csv').onclick = () => exportCSV(lastPlanJSON);
    document.getElementById('btn-restart').onclick = restartApp;
}


function renderAI(markdown) {
Â  let html = marked.parse(markdown);
Â  html = html.replace(/\[SWAP:(EXERCISE|MEAL):(.*?)\]/g, (m, type, item) => {
Â  Â  const t = type.toLowerCase();
Â  Â  const cleanItem = item.replace(/\"/g, '&quot;');
Â  Â  const btn = `<button type="button" onclick="swapItem(event)" data-type="${t}" data-item="${cleanItem}" class="no-print bg-gray-200 hover:bg-gray-300 text-gray-800 text-xs px-2 py-1 rounded-md transition-colors">${T('swap')}</button>`;
Â  Â  return t === 'meal'
Â  Â  Â  ? `<span class="inline-flex items-center gap-2">${item} ${btn}</span>`
Â  Â  Â  : `<span class="inline-flex items-center gap-2 ltr-text"><span class="font-semibold">${item}</span>${btn}</span>`;
Â  });
Â  const planEl = document.getElementById('plan');
Â  planEl.innerHTML = html;
Â  document.querySelector('.no-print .animate-spin').style.display = 'none';
Â  document.querySelector('.no-print h2').style.display = 'none';
Â  document.querySelector('.no-print p').style.display = 'none';

Â  lastPlanJSON = { source: 'ai_markdown', raw: markdown };
Â  qualityCheck();
}

function renderErrorMessage(error) {
Â  Â  const planEl = document.getElementById('plan');
Â  Â  planEl.innerHTML = `<div class="p-4 bg-red-100 border-l-4 border-red-500 rounded-r-lg mb-4">
Â  Â  Â  Â  <h3 class="font-bold text-red-800">${T('api_key_error')}</h3>
Â  Â  Â  Â  <p class="text-red-700 text-sm">${error}</p>
Â  Â  </div>`;
Â  Â  document.querySelector('.no-print .animate-spin').style.display = 'none';
Â  Â  document.querySelector('.no-print h2').style.display = 'none';
Â  Â  document.querySelector('.no-print p').style.display = 'none';
Â  Â  document.getElementById('btn-restart').classList.remove('hidden');
Â  Â  document.getElementById('btn-restart').onclick = restartApp;
}

function qualityCheck() {
Â  Â  const qc = document.getElementById('qc');
Â  Â  if (!qc) return;
Â  Â  try {
Â  Â  Â  Â  const txt = document.getElementById('plan').innerText || '';
Â  Â  Â  Â  const days = [1, 2, 3, 4, 5, 6, 7];
Â  Â  Â  Â  const found = days.filter(d => new RegExp(`(Day\\s*${d}|Ø§Ù„ÙŠÙˆÙ…\\s*${d})`, 'i').test(txt));
Â  Â  Â  Â  const badge = `${T('days_check')}: ${found.length}/7`;
Â  Â  Â  Â  qc.innerHTML = `<span class="inline-flex items-center gap-2 px-2 py-1 rounded-lg ${found.length === 7 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${badge}</span>`;
Â  Â  } catch { qc.textContent = ''; }
}

/*************** AI Prompt & API Call ***************/
function buildAIPrompt(profile, lang, targets) {
Â  const weak = Object.entries(profile.weak_points || {}).map(([muscle, desc]) => `${T(muscle)}: ${desc}`).join(', ') || 'None';
Â  return `Act as "Coach Mustafa Al-Safi," a world-class nutrition and fitness expert. Create a professional, highly detailed, and SAFE plan for "${profile.name}".
**CRITICAL: The final response must be in ${lang} language only, with all food items in ${lang} and exercise names in English ONLY.**

**User's Comprehensive Data:**
- Goals: **${(profile.goals || []).join(', ')}**
- Target: Weight ${profile.target_weight || 'N/A'}, by ${profile.target_date || 'N/A'}.
- History: Last trained: ${profile.last_train}. Experience: **${profile.training_exp}**.
- Areas of Focus (Weak Points): ${weak}.
- Core Stats: Age: ${profile.age}, H: ${profile.height}cm, W: ${profile.weight}kg, Gender: ${profile.gender}.
- Health: Chronic Conditions: ${(profile.health_conditions || []).join(', ') || 'None'}. Injuries: **${profile.injuries || 'None'}**. Food Allergies: ${(profile.allergies || []).join(', ') || 'None'}.
- Diet: Preferred System: ${profile.diet_preference}.
- Daily macros target: P ${targets.macros.protein_g}g / F ${targets.macros.fat_g}g / C ${targets.macros.carb_g}g (~${targets.calories} kcal).

**REQUIRED OUTPUT FORMAT (Use professional, clean Markdown with clear tables and headings. Address user by name):**
### 1. Ù…Ù‚Ø¯Ù…Ø© Ø´Ø®ØµÙŠØ© ÙˆØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„
(Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${profile.name}. Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ÙŠ Ù„Ø¨ÙŠØ§Ù†Ø§ØªÙƒ... Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ø£Ù‡Ø¯Ø§ÙÙ‡ØŒ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„ØµØ­ÙŠØ©ØŒ ÙˆØªØ§Ø±ÙŠØ®Ù‡. Ø§Ø´Ø±Ø­ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø·Ø©.)
*Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø© Ù…Ø®ØµØµØ© Ù„Ùƒ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¯Ø®Ù„Ø§ØªÙƒ ÙˆÙ„Ø§ ÙŠØ¬ÙˆØ² Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø´Ø®Øµ Ø¢Ø®Ø±.*
### 2. Ø®Ø·Ø© Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© (Ù„Ù…Ø¯Ø© 7 Ø£ÙŠØ§Ù…)
(Ù‚Ø¯Ù… Ø¬Ø¯ÙˆÙ„Ø§Ù‹ ÙˆØ§Ø¶Ø­Ø§Ù‹ Ù„Ù„ÙˆØ¬Ø¨Ø§Øª Ù„Ø³Ø¨Ø¹Ø© Ø£ÙŠØ§Ù…. **ÙƒÙ„ ÙˆØ¬Ø¨Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… [SWAP:MEAL:Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ø¨Ø©]**. Ø§Ø°ÙƒØ± Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª.)
### 3. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹
(Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†Ø¸Ø§Ù… "${profile.diet_preference}"ØŒ Ø£Ù†Ø´Ø¦ Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ø¶Ø­Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù‚Ø§Ø·.)
### 4. Ø®Ø·Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©
**Ø§Ù„Ø£Ù‡Ù…ÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù…Ù†Ø§Ø³Ø¨Ù‹Ø§ ØªÙ…Ø§Ù…Ù‹Ø§ Ù„Ù…Ø³ØªÙˆÙ‰ Ø®Ø¨Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ('${profile.training_exp}'). ØªØ¬Ù†Ø¨ ØªÙ…Ø§Ù…Ù‹Ø§ Ø£ÙŠ ØªÙ…Ø§Ø±ÙŠÙ† Ù‚Ø¯ ØªØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ ØªÙØ§Ù‚Ù… Ø¥ØµØ§Ø¨Ø§ØªÙ‡ Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø©: '${profile.injuries || 'None'}'. ÙŠØ¬Ø¨ Ø£Ù† ØªØ±ÙƒØ² Ø§Ù„Ø®Ø·Ø© Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø¶Ø¹ÙÙ‡: '${weak}'.**
(Ù‚Ø¯Ù… Ø§Ù„Ø®Ø·Ø© ÙÙŠ **Ø¬Ø¯ÙˆÙ„ Markdown ÙˆØ§Ø¶Ø­** Ù„ÙƒÙ„ ÙŠÙˆÙ…. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„ÙŠÙˆÙ…ØŒ Ø§Ù„ØªÙ…Ø±ÙŠÙ†ØŒ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§ØªØŒ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§ØªØŒ ÙˆØ§Ù„Ø±Ø§Ø­Ø© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ. Ù…Ø«Ø§Ù„:)
| Ø§Ù„ÙŠÙˆÙ… Â  | Ø§Ù„ØªÙ…Ø±ÙŠÙ† (Exercise) Â  Â  Â | Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (Sets) | Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª (Reps) | Ø§Ù„Ø±Ø§Ø­Ø© (Rest) |
|---------|--------------------------|-------------------|-------------------|---------------|
| Ø§Ù„ÙŠÙˆÙ… 1 | Bench Press Â  Â  Â  Â  Â  Â  Â | 4 Â  Â  Â  Â  Â  Â  Â  Â  | 8-12 Â  Â  Â  Â  Â  Â  Â | 90s Â  Â  Â  Â  Â  |

**ÙƒÙ„ ØªÙ…Ø±ÙŠÙ† ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„ØªØ¨Ø¯ÙŠÙ„: [SWAP:EXERCISE:Exercise Name]**.
### 5. Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„ØªØ·ÙˆØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ
(Ø§Ø´Ø±Ø­ Ø¨ÙˆØ¶ÙˆØ­ **ÙƒÙŠÙ ÙˆÙ…ØªÙ‰** ÙŠØ²ÙŠØ¯ Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ø£Ùˆ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª. Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø·Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„ØªØ¹Ø¯ÙŠÙ„.)
### 6. ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©
(Ø§Ù‚ØªØ±Ø­ Ù…ÙƒÙ…Ù„Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ù‡Ø¯Ø§ÙÙ‡ ÙˆØ­Ø§Ù„ØªÙ‡ Ø§Ù„ØµØ­ÙŠØ©. Ù‚Ø¯Ù… Ù†ØµØ§Ø¦Ø­ Ø¹Ù…Ù„ÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„Ù†ÙˆÙ… ÙˆØ§Ù„ØªÙˆØªØ±.)
**--- Ø®Ø§ØªÙ…Ø© ÙˆØªÙˆÙ‚ÙŠØ¹ ---**
(Ø§Ø®ØªØªÙ… Ø¨ÙÙ‚Ø±Ø© ØªØ­ÙÙŠØ²ÙŠØ©ØŒ Ø«Ù… Ø£Ø¶Ù Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:)
**Ù…Ø¹ Ø®Ø§Ù„Øµ ØªÙ…Ù†ÙŠØ§ØªÙŠ Ù„Ùƒ Ø¨Ø§Ù„Ù†Ø¬Ø§Ø­ØŒ**
**Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ**`;
}

async function callAI(prompt, url) {
    if (!canCall()) return { ok: false, error: 'Rate limited' };
    try {
        markCall();
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: prompt })
        });
        if (!res.ok) {
            const errorText = await res.text();
            return { ok: false, error: errorText || 'Server error' };
        }
        const data = await res.json();
        return { ok: true, text: data.text };
    } catch (e) {
        return { ok: false, error: String(e) };
    }
}

/*************** Item Swap Logic ***************/
async function swapItem(e) {
Â  const button = e.target.closest('button');
Â  if (!button) return;
Â  
Â  const type = button.dataset.type;
Â  const item = decodeURIComponent(button.dataset.item || '');
Â  const originalLabel = button.textContent;
Â  button.disabled = true;
Â  button.innerHTML = `<span class="inline-block animate-spin h-4 w-4 border-2 border-current border-t-transparent rounded-full" role="status" aria-hidden="true"></span>`;

Â  const { userData } = state;
Â  let prompt = '';
Â  if (type === 'meal') {
Â  Â  Â  prompt = `User wants a swap for the meal "${item}".
Â  Â  Â  CRITICAL: The new meal must be suitable for a "${userData.diet_preference}" diet and must NOT contain these allergens: "${(userData.allergies || []).join(', ')}".
Â  Â  Â  Provide ONE alternative only. Reply with ingredients + quantities in ${state.lang}.`;
Â  } else { // exercise
Â  Â  Â  prompt = `User with "${userData.training_exp}" experience needs an alternative for the exercise "${item}".
Â  Â  Â  CRITICAL: The new exercise must target the same muscle group but AVOID aggravating these injuries: "${userData.injuries || 'None'}".
Â  Â  Â  Reply with ONE alternative: English name + sets/reps.`;
Â  }
Â  
Â  const proxyUrl = '/.netlify/functions/gemini-proxy';
Â  const ai = await callAI(prompt, proxyUrl);
Â  let suggestion = '';

Â  if (ai.ok && ai.text) {
Â  Â  suggestion = ai.text.trim().replace(/"/g, '');
Â  } else {
Â  Â  showNotification(T('api_key_error'), 'error');
Â  }

Â  if (suggestion) {
Â  Â  const target = button.parentElement;
Â  Â  if (type === 'meal') {
Â  Â  Â  Â  target.childNodes[0].nodeValue = `${suggestion} `;
Â  Â  Â  Â  button.dataset.item = encodeURIComponent(suggestion);
Â  Â  } else { // exercise
Â  Â  Â  Â  const newName = suggestion.split(':')[0]?.trim() || suggestion;
Â  Â  Â  Â  target.querySelector('.font-semibold').textContent = newName;
Â  Â  Â  Â  const cell = button.closest('td');
Â  Â  Â  Â  if (cell) {
Â  Â  Â  Â  Â  Â  cell.innerHTML = cell.innerHTML.replace(item, newName);
Â  Â  Â  Â  }
Â  Â  Â  Â  button.dataset.item = encodeURIComponent(newName);
Â  Â  }
Â  }

Â  button.disabled = false;
Â  button.innerHTML = originalLabel;
}

/*************** Data Export ***************/
function exportJSON(data) {
Â  if (!data) return;
Â  const blob = new Blob([JSON.stringify({ userData: state.userData, plan: data }, null, 2)], { type: 'application/json' });
Â  const a = document.createElement('a');
Â  a.href = URL.createObjectURL(blob);
Â  a.download = 'ai-coach-plan.json';
Â  a.click();
}

function exportCSV(data) {
Â  if (!data) return;
Â  let rows = [];
Â  if (data.source === 'ai_markdown') {
Â  Â  rows.push(['source', 'ai_markdown']);
Â  Â  rows.push(['prompt_data', JSON.stringify(state.userData)]);
Â  Â  rows.push(['raw_response', data.raw]);
Â  } else {
Â  Â  rows.push(['day', 'type', 'details']);
Â  Â  (data.nutrition || []).forEach(d => d.meals.forEach(m => rows.push([d.day, 'meal', `${m.name}: ${m.items.join(', ')}`])));
Â  Â  (data.training || []).forEach(d => d.blocks.forEach(b => rows.push([d.day, 'exercise', `${b.exercise} ${b.sets}x${b.reps}`])));
Â  }
Â  const csv = rows.map(r => r.map(x => `"${String(x).replaceAll('"', '""')}"`).join(',')).join('\n');
Â  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
Â  const a = document.createElement('a');
Â  a.href = URL.createObjectURL(blob);
Â  a.download = 'ai-coach-plan.csv';
Â  a.click();
}

/*************** App Control & Initialization ***************/
function restartApp() {
Â  state = { currentStage: 0, lang: 'ar', userData: { goals: [], weak_points: {}, health_conditions: [], allergies: [] } };
Â  started = false;
Â  progressWrap.classList.add('hidden');
Â  sticky.classList.add('hidden');
Â  renderStage(0);
}

function showNotification(message, type = 'success') {
Â  Â  const el = document.createElement('div');
Â  Â  el.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white font-bold z-50 ${type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-amber-500' : 'bg-green-500'}`;
Â  Â  el.textContent = message;
Â  Â  document.body.appendChild(el);
Â  Â  setTimeout(() => el.remove(), 4000);
}

// Event Listeners
document.getElementById('btn-ar').onclick = () => { state.lang = 'ar'; renderStage(state.currentStage); };
document.getElementById('btn-en').onclick = () => { state.lang = 'en'; renderStage(state.currentStage); };

// Initial Load
window.addEventListener('load', () => {
Â  Â  renderStage(0);
});
</script>
</body>
</html>

