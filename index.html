<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>المدرب الشخصي الخبير — مصطفى الصافي</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* ألوان مريحة مستوحاة من أدوات تصميم عالمية */
      --bg:#0a0f15;
      --panel:#0e1621;
      --ink:#e7eaf0;
      --ink-soft:#a8b0bc;
      --line:#1b2736;
      --brand:#7c3aed; /* violet */
      --brand2:#06b6d4; /* cyan */
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    }
    html,body{height:100%}
    body{background:linear-gradient(180deg,var(--bg) 0%, #0c141d 100%);color:var(--ink);-webkit-font-smoothing:antialiased}
    .font-ar{font-family:"Tajawal",sans-serif}
    .font-en{font-family:"Poppins",sans-serif}
    .glass{background:rgba(14,22,33,.8);border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(10px)}
    .panel{background:var(--panel);border:1px solid var(--line)}
    .btn{border:1px solid #2a384a;border-radius:1rem;padding:.85rem 1rem;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand2));border-color:transparent;color:#fff}
    .btn-ghost{background:#0b121a}
    .chip{padding:.3rem .65rem;border-radius:.6rem;font-size:.75rem;background:#0b121a;border:1px dashed #334155;color:#93c5fd}
    .kpi{background:#0b121a;border:1px solid #223043;border-radius:.8rem;padding:.6rem}
    .muted{color:var(--ink-soft)}
    .prose :where(table){width:100%;border-collapse:collapse}
    .prose :where(th,td){border:1px solid #263241;padding:.6rem;vertical-align:top}
    .prose :where(th){background:#0b121a;color:#cbd5e1}
    .rtl\:text-right[dir="rtl"]{text-align:right}
    .ltr\:text-left[dir="ltr"]{text-align:left}
    .pill{font-size:.7rem;padding:.2rem .5rem;border:1px solid #334155;border-radius:.5rem}
    @media (max-width:420px){.hide-xs{display:none}}
    @media print{
      .no-print, header, #controls {display:none!important}
      body{background:#fff;color:#000}
      .panel,.glass{background:#fff;border:none}
      #result{box-shadow:none;border:none}
    }
  </style>
</head>
<body class="font-ar">

  <!-- Header -->
  <header class="glass sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-600 to-cyan-500 text-white grid place-items-center font-extrabold">AI</div>
        <div class="leading-tight">
          <div class="text-xs muted">COACH</div>
          <div class="font-extrabold">Mustafa Al-Safi</div>
          <div class="text-[11px] muted">Certified International Coach</div>
        </div>
      </div>
      <div class="flex items-center gap-2 no-print">
        <button id="btn-lang-ar" class="btn btn-ghost">AR</button>
        <button id="btn-lang-en" class="btn btn-ghost">EN</button>
        <button id="btn-print" class="btn btn-primary">طباعة / Print</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 mt-6">
    <div class="glass rounded-2xl p-6 relative overflow-hidden">
      <div class="absolute -top-10 -left-10 w-56 h-56 rounded-full bg-gradient-to-br from-violet-600/25 to-cyan-500/25 blur-2xl"></div>
      <div class="absolute -bottom-10 -right-10 w-56 h-56 rounded-full bg-gradient-to-br from-cyan-500/18 to-violet-600/18 blur-2xl"></div>
      <div class="relative grid lg:grid-cols-[1.1fr,.9fr] gap-6 items-center">
        <div>
          <h1 id="hero-title" class="text-3xl sm:text-4xl font-extrabold">المدرب الشخصي الخبير</h1>
          <p id="hero-sub" class="muted mt-1">
            خطة نهائية بلا اختصار: تغذية 7 أيام كاملة، تدريب 7 أيام بمستوى شدة مناسب، مكملات حسب الحالة، وصيام متقطع اختياري — بتوقيع
            <b>مصطفى الصافي</b> خبير التغذية واللياقة │ مدرب دولي معتمد.
          </p>
          <p class="text-xs muted mt-2"><b>Powered by Mustafa Elsafy 2025</b></p>
          <div class="flex items-center gap-2 mt-4 flex-wrap">
            <span class="chip">جداول دقيقة</span>
            <span class="chip">بدون اختصار</span>
            <span class="chip">RTL/LTR</span>
            <span class="chip">مراجعة جودة</span>
            <span class="chip">طباعة/حفظ</span>
          </div>
        </div>
        <div class="panel rounded-2xl p-4">
          <div class="text-xs muted mb-2" id="kpi-title">مؤشرات سريعة</div>
          <div class="grid grid-cols-3 gap-3 text-center">
            <div class="kpi">
              <div class="text-[11px] muted">TDEE</div>
              <div id="kpi-tdee" class="font-extrabold">—</div>
            </div>
            <div class="kpi">
              <div class="text-[11px] muted">Protein</div>
              <div id="kpi-P" class="font-extrabold">—</div>
            </div>
            <div class="kpi">
              <div class="text-[11px] muted">Carbs</div>
              <div id="kpi-C" class="font-extrabold">—</div>
            </div>
          </div>
          <div class="mt-3">
            <div class="h-2 bg-[#0b121a] rounded-full overflow-hidden">
              <div id="bar" class="h-full bg-gradient-to-r from-violet-600 to-cyan-500 w-0 transition-all duration-300"></div>
            </div>
            <div class="text-[11px] muted mt-1">Step <span id="step">1</span> / 5</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 mt-6 grid xl:grid-cols-[minmax(0,1fr),420px] gap-6">
    <!-- Builder -->
    <section id="builder" class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="text-sm pill muted hide-xs" id="a11y-hint">Tab-friendly • ARIA labeled • Error guards</div>
        <div class="text-xs pill">© مصطفى الصافي • Powered by Mustafa Elsafy 2025</div>
      </div>
      <div id="stage"></div>
      <div id="controls" class="mt-6 flex gap-2">
        <button id="btn-prev" class="btn btn-ghost flex-1">السابق</button>
        <button id="btn-next" class="btn btn-primary flex-1">التالي</button>
      </div>
    </section>

    <!-- Live summary -->
    <aside class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <div id="live-title" class="text-sm font-bold">ملخص فوري</div>
        <span id="lang-badge" class="chip">AR</span>
      </div>
      <div id="live" class="mt-3 space-y-2 text-sm"></div>
      <div class="mt-3 text-[11px] muted">* الذكاء الاصطناعي يلتزم بـ 7 أيام كاملة ومختلفة + جداول صارمة + تطابق الماكروز يوميًا (±1%).</div>
    </aside>
  </main>

  <!-- Result -->
  <section id="result" class="max-w-7xl mx-auto px-4 sm:px-6 mt-6 mb-16 hidden">
    <article class="glass rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <h2 id="plan-title" class="text-2xl font-extrabold">الخطة الشاملة</h2>
        <div class="no-print flex gap-2">
          <button id="btn-again" class="btn btn-ghost">إنشاء جديد</button>
          <button id="btn-print-2" class="btn btn-primary">طباعة / حفظ</button>
        </div>
      </div>
      <div class="text-[13px] muted">
        تشخيص مفصل، مسموح/ممنوع، صيام متقطع، تغذية 7 أيام بجداول كاملة، تدريب 7 أيام (Tempo/RIR/Rest)، مكملات أساسية وصحية، إرشادات نجاح، رسائل تحفيزية، ووحدات إضافية.
      </div>
      <div id="ai-html" class="prose prose-invert rtl:text-right ltr:text-left mt-4"></div>
      <div class="border-t border-slate-700 mt-6 pt-2 text-[11px] muted">
        <b>مصطفى الصافي — خبير التغذية واللياقة البدنية │ مدرب دولي معتمد</b> • <b>Powered by Mustafa Elsafy 2025</b>
      </div>
    </article>
  </section>

  <script>
    /* ======================== I18N ======================== */
    const L = {
      ar:{
        ui:{
          title:'المدرب الشخصي الخبير',
          sub:'خطة نهائية بلا اختصار: تغذية 7 أيام كاملة، تدريب 7 أيام بمستوى شدة مناسب، مكملات حسب الحالة، وصيام متقطع اختياري — بتوقيع مصطفى الصافي.',
          kpi:'مؤشرات سريعة', live:'ملخص فوري',
          steps:['الأساسيات','الأهداف & النظام','الصحة & الحساسية','التاريخ & التركيز','إنشاء الخطة'],
          next:'التالي', prev:'السابق', submit:'إنشاء الخطة الآن',
          name:'الاسم', age:'العمر', height:'الطول (سم)', weight:'الوزن (كغ)', gender:'الجنس', male:'ذكر', female:'أنثى',
          job:'طبيعة العمل', jobVals:['مكتبي','نشاط خفيف','نشاط متوسط'],
          goals:['خسارة الدهون','بناء العضلات','زيادة القوة','تحسين التحمل','صحة عامة'],
          meals:'عدد الوجبات', diet:'النظام الغذائي', diets:['متوازن','قليل الكربوهيدرات','كيتو','البحر المتوسط','نباتي'],
          fasting:'الصيام المتقطع', enable:'تفعيل', protocol:'البروتوكول', from:'من', to:'إلى',
          health:'حالات صحية', healthVals:['ضغط الدم','السكري','مقاومة الأنسولين','الغدة الدرقية','الكبد الدهني','مشاكل هرمونية','الجهاز الهضمي'],
          allergies:'حساسيات', allergyVals:['الجلوتين','اللاكتوز','المكسرات','المأكولات البحرية','البقوليات','السكريات المصنعة','الزيوت النباتية'],
          injuries:'إصابات (إن وجدت)', exp:'خبرة المقاومة', expVals:['مبتدئ','متوسط','متقدم'],
          weak:'نقاط التركيز (اختياري)', desc:'اكتب العضلة: الهدف (مثال: صدر: إبراز الأعلى؛ ظهر: كثافة)',
          detail:'مستوى التفصيل', days:'أيام التدريب/أسبوع', addons:'وحدات إضافية',
          add:{ grocery:'قائمة المشتريات', micro:'المغذيات الدقيقة', hydration:'السوائل', periodization:'تصعيد 4 أسابيع', budget:'بدائل اقتصادية', prep:'دليل التحضير', cooking:'نصائح الطبخ' },
          building:'جاري توليد خطة نهائية بلا اختصار…', apiFail:'تعذر الاتصال بالموديل. حاول مرة أخرى.',
          err:'أكمل الحقول المطلوبة', print:'طباعة / Print',
        },
        map:{
          job:{'Desk':'مكتبي','Light':'نشاط خفيف','Moderate':'نشاط متوسط'},
          diet:{'Balanced':'متوازن','Low-Carb':'قليل الكربوهيدرات','Keto':'كيتو','Mediterranean':'البحر المتوسط','Plant-based':'نباتي'},
          goals:{'Fat loss':'خسارة الدهون','Muscle gain':'بناء العضلات','Strength':'زيادة القوة','Endurance':'تحسين التحمل','General health':'صحة عامة'},
          exp:{'Beginner':'مبتدئ','Intermediate':'متوسط','Advanced':'متقدم'}
        }
      },
      en:{
        ui:{
          title:'Expert Personal Coach',
          sub:'A no-shortcut plan: full 7-day nutrition, 7-day training with proper intensity, condition-aware supplements, optional IF — signed by Mustafa Al-Safi.',
          kpi:'Quick KPIs', live:'Live Summary',
          steps:['Basics','Goals & Diet','Health & Allergies','History & Focus','Create Plan'],
          next:'Next', prev:'Back', submit:'Generate Now',
          name:'Name', age:'Age', height:'Height (cm)', weight:'Weight (kg)', gender:'Gender', male:'Male', female:'Female',
          job:'Job activity', jobVals:['Desk','Light','Moderate'],
          goals:['Fat loss','Muscle gain','Strength','Endurance','General health'],
          meals:'Meals per day', diet:'Preferred diet', diets:['Balanced','Low-Carb','Keto','Mediterranean','Plant-based'],
          fasting:'Intermittent fasting', enable:'Enable', protocol:'Protocol', from:'from', to:'to',
          health:'Health conditions', healthVals:['Hypertension','Diabetes','Insulin Resistance','Thyroid','Fatty Liver','Hormonal issues','GI issues'],
          allergies:'Allergies', allergyVals:['Gluten','Lactose','Nuts','Seafood','Legumes','Added sugars','Vegetable oils'],
          injuries:'Injuries (if any)', exp:'Resistance experience', expVals:['Beginner','Intermediate','Advanced'],
          weak:'Focus points (optional)', desc:'Type muscle: goal (e.g., Chest: upper emphasis; Back: density)',
          detail:'Detail level', days:'Training days/week', addons:'Add-on modules',
          add:{ grocery:'Grocery list', micro:'Micronutrient targets', hydration:'Hydration plan', periodization:'4-week periodization', budget:'Budget swaps', prep:'Meal prep guide', cooking:'Cooking tips' },
          building:'Generating a fully-detailed plan, no shortcuts…', apiFail:'Model unreachable. Try again.',
          err:'Please complete required fields', print:'Print / Save',
        },
        map:{
          job:{'مكتبي':'Desk','نشاط خفيف':'Light','نشاط متوسط':'Moderate'},
          diet:{'متوازن':'Balanced','قليل الكربوهيدرات':'Low-Carb','كيتو':'Keto','البحر المتوسط':'Mediterranean','نباتي':'Plant-based'},
          goals:{'خسارة الدهون':'Fat loss','بناء العضلات':'Muscle gain','زيادة القوة':'Strength','تحسين التحمل':'Endurance','صحة عامة':'General health'},
          exp:{'مبتدئ':'Beginner','متوسط':'Intermediate','متقدم':'Advanced'}
        }
      }
    };

    /* ======================== State ======================== */
    const el = id=>document.getElementById(id);
    const content = el('stage'), live = el('live'), bar=el('bar'), stepSpan=el('step');
    const kTDEE = el('kpi-tdee'), kP = el('kpi-P'), kC = el('kpi-C');

    let lang='ar';
    let step=0; const total=5;
    const user={
      name:'', age:'', height:'', weight:'', gender:'Male', job:'Desk',
      goals:[], meals:4, diet:'Balanced',
      fasting:{enabled:false, protocol:'16:8', start:'12:00', end:'20:00'},
      health:[], allergies:[], injuries:'',
      exp:'Beginner', weak_points:{},
      detail:'max', train_days:7,
      include:{grocery:true, micro:true, hydration:true, periodization:true, budget:false, prepGuide:true, cookingTips:true}
    };

    /* ======================== Helpers ======================== */
    const T = k=>L[lang].ui[k];
    function setLang(l){
      lang=l;
      document.documentElement.lang=l;
      document.documentElement.dir = l==='ar'?'rtl':'ltr';
      document.body.classList.toggle('font-ar',l==='ar');
      document.body.classList.toggle('font-en',l!=='ar');
      el('hero-title').textContent=T('title');
      el('hero-sub').textContent=L[lang].ui.sub;
      el('kpi-title').textContent=T('kpi');
      el('live-title').textContent=T('live');
      el('lang-badge').textContent=l.toUpperCase();
      el('btn-print').textContent=T('print');
      el('btn-print-2').textContent=T('print');
      draw(); updateLive(); updateCTA();
    }
    function f(label,id,opt={}){
      const {type='text',value='',select=null,rows=3,placeholder=''}=opt;
      if(select){
        return `<label class="block">
          <span class="text-sm">${label}</span>
          <select id="${id}" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700">
            ${select.map(o=>`<option value="${o.value}" ${String(value)===String(o.value)?'selected':''}>${o.label}</option>`).join('')}
          </select>
        </label>`;
      }
      if(type==='textarea'){
        return `<label class="block">
          <span class="text-sm">${label}</span>
          <textarea id="${id}" rows="${rows}" placeholder="${placeholder}" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700">${value||''}</textarea>
        </label>`;
      }
      return `<label class="block">
        <span class="text-sm">${label}</span>
        <input id="${id}" type="${type}" value="${value}" placeholder="${placeholder}" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700"/>
      </label>`;
    }
    function chips(name,arr,checked=[]){
      return `<div class="flex flex-wrap gap-2">${arr.map(v=>`
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-[#0b121a] border border-slate-700 cursor-pointer">
          <input type="checkbox" name="${name}" value="${v}" class="accent-violet-600" ${checked.includes(v)?'checked':''}/>
          <span class="text-sm">${v}</span>
        </label>`).join('')}</div>`;
    }

    function calc(){
      const W=+user.weight||0, H=+user.height||0, A=+user.age||0, male = user.gender==='Male';
      const BMR = male ? 10*W+6.25*H-5*A+5 : 10*W+6.25*H-5*A-161;
      const pal = user.job.match(/Desk|مكتبي/)?1.2 : user.job.match(/Moderate|متوسط/)?1.5 : 1.35;
      let TDEE = BMR*pal;
      if(user.goals.some(g=>/Fat|دهون/.test(g))) TDEE *= 0.85;
      if(user.goals.some(g=>/Muscle|عضلات/.test(g))) TDEE *= 1.10;
      const P = Math.round(2.0*(+user.weight||1));
      const F = Math.round(0.8*(+user.weight||1));
      let C = Math.round((TDEE - (P*4+F*9))/4);
      if(user.health.some(h=>/Diab|السكري|Insulin|الأنسولين/.test(h))) C = Math.min(C,120);
      C=Math.max(0,C);
      return {TDEE:Math.round(TDEE),P,F,C};
    }

    function updateKPIs(){ const c=calc(); el('kpi-tdee').textContent=c.TDEE; el('kpi-P').textContent=c.P+' g'; el('kpi-C').textContent=c.C+' g'; }
    function updateProgress(){ bar.style.width = (((step+1)/total)*100)+'%'; stepSpan.textContent=String(step+1); }
    function updateCTA(){ el('btn-prev').textContent=T('prev'); el('btn-next').textContent = step===total-1?T('submit'):T('next'); el('btn-prev').disabled = step===0; }

    function updateLive(){
      updateKPIs(); const c=calc();
      const g = (user.goals||[]).join(lang==='ar'?'، ':', ')||'—';
      live.innerHTML = `
        <div class="text-xs muted">${T('name')}: <b class="text-slate-200">${user.name||'—'}</b></div>
        <div class="grid grid-cols-3 gap-2 text-xs">
          <div class="kpi"><div class="muted">${T('age')}</div><b>${user.age||'—'}</b></div>
          <div class="kpi"><div class="muted">${T('height')}</div><b>${user.height||'—'}</b></div>
          <div class="kpi"><div class="muted">${T('weight')}</div><b>${user.weight||'—'}</b></div>
        </div>
        <div class="text-xs muted">${lang==='ar'?'الأهداف':'Goals'}: <b class="text-slate-200">${g}</b></div>
        <div class="text-xs muted">${T('diet')}: <b class="text-slate-200">${mapOut('diet',user.diet)}</b> — ${T('meals')}: <b class="text-slate-200">${user.meals}</b></div>
        <div class="text-xs muted">${T('fasting')}: <b class="text-slate-200">${user.fasting.enabled? user.fasting.protocol+' '+user.fasting.start+'-'+user.fasting.end : '—'}</b></div>
        <div class="grid grid-cols-3 gap-2 text-xs mt-2">
          <div class="kpi"><div>السعرات</div><b>${c.TDEE} kcal</b></div>
          <div class="kpi"><div>البروتين</div><b>${c.P} g</b></div>
          <div class="kpi"><div>الكارب</div><b>${c.C} g</b></div>
        </div>
      `;
      const mods = Object.entries(user.include).filter(([_,v])=>v).map(([k])=>T('add')[k]||k).join(' • ')||'—';
      live.innerHTML += `<div class="text-[11px] muted mt-2">${T('addons')}: ${mods}</div>`;
    }

    function mapOut(type,val){
      // عرض القيمة الحالية بلغة الواجهة
      if(lang==='ar'){ // إنجليزي → عربي
        const map=L.ar.map[type]||{}; return map[val]||val;
      } else { // عربي → إنجليزي
        const map=L.en.map[type]||{}; return map[val]||val;
      }
    }
    function mapGoalsOut(arr){
      if(lang==='ar'){ // en→ar
        return arr.map(v=>L.ar.map.goals[v]||v);
      } else { // ar→en
        return arr.map(v=>L.en.map.goals[v]||v);
      }
    }

    /* ======================== Stages (UX) ======================== */
    function draw(){
      updateProgress();
      const U=L[lang].ui;
      if(step===0){
        content.innerHTML = `
          <h3 class="text-xl font-extrabold mb-3">${U.steps[0]}</h3>
          <div class="grid sm:grid-cols-2 gap-4">
            ${f(U.name,'name',{value:user.name})}
            ${f(U.gender,'gender',{select:[{value:'Male',label:U.male},{value:'Female',label:U.female}],value:user.gender})}
            ${f(U.age,'age',{type:'number',value:user.age})}
            ${f(U.height,'height',{type:'number',value:user.height})}
            ${f(U.weight,'weight',{type:'number',value:user.weight})}
            ${f(U.job,'job',{select:U.jobVals.map(v=>({value:v,label:v})),value:mapOut('job',user.job)})}
          </div>

          <div class="grid lg:grid-cols-3 gap-4 mt-3">
            <label class="block">
              <span class="text-sm">${U.detail}</span>
              <select id="detail" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700">
                <option value="minimal">minimal</option>
                <option value="standard">standard</option>
                <option value="max" selected>max</option>
              </select>
            </label>
            <label class="block">
              <span class="text-sm">${U.days}</span>
              <select id="train_days" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700">
                <option>3</option><option>4</option><option>5</option><option selected>7</option>
              </select>
            </label>
            <div class="rounded-xl p-3 bg-[#0b121a] border border-slate-700">
              <div class="text-sm mb-2">${U.addons}</div>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <label class="inline-flex items-center gap-2"><input id="inc_grocery" type="checkbox" class="accent-violet-600" checked/>${U.add.grocery}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_micro" type="checkbox" class="accent-violet-600" checked/>${U.add.micro}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_hyd" type="checkbox" class="accent-violet-600" checked/>${U.add.hydration}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_period" type="checkbox" class="accent-violet-600" checked/>${U.add.periodization}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_budget" type="checkbox" class="accent-violet-600"/>${U.add.budget}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_prep" type="checkbox" class="accent-violet-600" checked/>${U.add.prep}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_cook" type="checkbox" class="accent-violet-600" checked/>${U.add.cooking}</label>
              </div>
            </div>
          </div>
        `;
      }
      else if(step===1){
        content.innerHTML = `
          <h3 class="text-xl font-extrabold mb-3">${U.steps[1]}</h3>
          <div class="space-y-4">
            <div>
              <div class="text-sm mb-1">${lang==='ar'?'الأهداف':'Goals'}</div>
              ${chips('goal', U.goals, mapGoalsOut(user.goals))}
            </div>
            <div class="grid sm:grid-cols-3 gap-4">
              ${f(U.meals,'meals',{select:[{value:3,label:'3'},{value:4,label:'4'},{value:5,label:'5'},{value:6,label:'6'}],value:user.meals})}
              ${f(U.diet,'diet',{select:U.diets.map(d=>({value:d,label:d})),value:mapOut('diet',user.diet)})}
            </div>
            <div class="rounded-xl p-3 bg-[#0b121a] border border-slate-700">
              <label class="inline-flex items-center gap-2">
                <input id="fasting_enabled" type="checkbox" class="accent-violet-600" ${user.fasting.enabled?'checked':''}/>
                <span>${U.fasting} — ${U.enable}</span>
              </label>
              <div class="grid sm:grid-cols-3 gap-3 mt-2">
                ${f(U.protocol,'fasting_protocol',{select:['14:10','16:8','18:6','20:4'].map(x=>({value:x,label:x})),value:user.fasting.protocol})}
                <label><span class="text-sm">${U.from}</span><input id="fasting_start" type="time" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700" value="${user.fasting.start}"/></label>
                <label><span class="text-sm">${U.to}</span><input id="fasting_end" type="time" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700" value="${user.fasting.end}"/></label>
              </div>
            </div>
          </div>`;
      }
      else if(step===2){
        content.innerHTML = `
          <h3 class="text-xl font-extrabold mb-3">${U.steps[2]}</h3>
          <div class="space-y-4">
            <div><div class="text-sm mb-1">${U.health}</div>${chips('health', U.healthVals, user.health)}</div>
            <div><div class="text-sm mb-1">${U.allergies}</div>${chips('all', U.allergyVals, user.allergies)}</div>
            ${f(U.injuries,'injuries',{type:'textarea',rows:3,value:user.injuries,placeholder: lang==='ar'?'اذكر المكان والوصف':'Describe area & details'})}
          </div>`;
      }
      else if(step===3){
        content.innerHTML = `
          <h3 class="text-xl font-extrabold mb-3">${U.steps[3]}</h3>
          <div class="grid sm:grid-cols-3 gap-4">
            ${f(U.exp,'exp',{select:U.expVals.map(x=>({value:x,label:x})),value:mapOut('exp',user.exp)})}
            <label class="block col-span-2">
              <span class="text-sm">${U.weak}</span>
              <input id="weak_raw" class="mt-1 w-full p-3 rounded-xl bg-[#0b121a] border border-slate-700" placeholder="${U.desc}" value="${serializeWeak()}">
            </label>
          </div>`;
      }
      else{
        content.innerHTML = `
          <div class="text-center py-8">
            <div class="text-sm muted mb-2">${U.building}</div>
            <div class="w-12 h-12 rounded-full border-4 border-violet-600 border-t-transparent animate-spin mx-auto" aria-label="loading"></div>
          </div>`;
      }
    }

    function serializeWeak(){
      const entries = Object.entries(user.weak_points||{});
      return entries.length? entries.map(([k,v])=>`${k}:${v}`).join('; '):'';
    }

    function saveStep(){
      const U=L[lang].ui;
      try{
        if(step===0){
          user.name = el('name').value.trim();
          user.gender = el('gender').value;
          user.age = +el('age').value;
          user.height = +el('height').value;
          user.weight = +el('weight').value;
          const jobVal = el('job').value; // localized
          user.job = (lang==='ar') ? (L.en.map.job[jobVal]||jobVal) : jobVal; // normalize to EN
          user.detail = el('detail').value;
          user.train_days = +el('train_days').value;
          user.include = {
            grocery: el('inc_grocery').checked,
            micro: el('inc_micro').checked,
            hydration: el('inc_hyd').checked,
            periodization: el('inc_period').checked,
            budget: el('inc_budget').checked,
            prepGuide: el('inc_prep').checked,
            cookingTips: el('inc_cook').checked
          };
          if(!user.name||!user.age||!user.height||!user.weight) throw 0;
        } else if(step===1){
          const rawGoals = [...document.querySelectorAll('input[name="goal"]:checked')].map(e=>e.value);
          // normalize goals to EN base for prompt consistency
          user.goals = (lang==='ar') ? rawGoals.map(g=>L.en.map.goals[g]||g) : rawGoals;
          const dietVal = el('diet').value;
          user.diet = (lang==='ar') ? (L.en.map.diet[dietVal]||dietVal) : dietVal;
          user.meals = +el('meals').value;
          user.fasting.enabled = el('fasting_enabled').checked;
          user.fasting.protocol = el('fasting_protocol').value;
          user.fasting.start = el('fasting_start').value;
          user.fasting.end = el('fasting_end').value;
          if(!user.goals.length) throw 0;
        } else if(step===2){
          user.health = [...document.querySelectorAll('input[name="health"]:checked')].map(e=>e.value);
          user.allergies = [...document.querySelectorAll('input[name="all"]:checked')].map(e=>e.value);
          user.injuries = el('injuries').value || '';
        } else if(step===3){
          const expVal = el('exp').value;
          user.exp = (lang==='ar') ? (L.en.map.exp[expVal]||expVal) : expVal;
          const weak_raw = el('weak_raw').value.trim();
          user.weak_points = {};
          if(weak_raw){
            weak_raw.split(';').forEach(pair=>{
              const [k,...rest]=pair.split(':'); const v=rest.join(':').trim(); if(k&&v) user.weak_points[k.trim()] = v;
            });
          }
        }
        updateLive(); return true;
      }catch{ toast(U.err,'err'); return false; }
    }

    /* ======================== Prompt (قوي جدًا + ثنائي اللغة) ======================== */
    function buildPrompt(){
      const c = calc();
      const outLang = (lang==='ar'?'AR':'EN');
      const meals = user.meals, trainDays=user.train_days, inc=user.include;
      const DETAIL = user.detail; // minimal | standard | max

      const RULE = {
        minimal:{meal:'• 2 lines per meal.',train:'• 3 exercises/day.'},
        standard:{meal:'• 4–5 lines per meal incl. swaps & rationale.',train:'• 4–5 exercises/day + Tempo/Rest/RIR.'},
        max:{meal:'• 6–8 lines per meal incl. swaps, rationale, quick prep.',train:'• 5–7 exercises/day + Tempo + RIR + technical & safety notes.'}
      }[DETAIL];

      const ADDONS = [
        inc.grocery ? '- Grocery list by section with approximate quantities (g/ml/unit).' : '',
        inc.micro ? `- Micronutrients: Sodium ≤ 2000mg, Potassium ≥ 3000mg, Calcium 1000mg, Magnesium 400mg, Fiber ${Math.max(25,Math.round(c.C*0.08))}g, Omega-3 ≥ 1g, Vit-D 800–2000 IU.` : '',
        inc.hydration ? '- Hydration: 30–40 ml/kg, distribution + pre/intra/post training, sugar-free options.' : '',
        inc.periodization ? '- 4-week periodization: Base → Build → Peak → Deload with %load and RIR guidance.' : '',
        inc.budget ? '- Budget variants for each ingredient preserving macros.' : '',
        inc.prepGuide ? '- Meal-prep guide: batch cooking, storage, reheating safety.' : '',
        inc.cookingTips ? '- Cooking tips: low-sodium marinades, air-fry/steam/grill, reduce added fats.' : ''
      ].filter(Boolean).join('\n');

      // NOTE: We demand full bilingual discipline in outputs:
      //  - Arabic prose & food names when AR; English exercise names always + Arabic short note.
      //  - English prose when EN; still keep exercise names in English (normal), with short note in English.

      return `
You are **Coach Mustafa Al-Safi**, world-class nutrition & fitness expert.
OUTPUT LANGUAGE: **${outLang}**.
- If AR: Use Arabic prose & food names; **exercise names in English with brief Arabic note**.
- If EN: Use English prose & food names; **exercise names in English with a brief English note**.
- **No placeholders. No summaries. No shortcuts. 7 FULL and DIFFERENT days for nutrition & training.**

### Client Profile (normalized)
- Name: ${user.name}
- Age/Height/Weight/Gender: ${user.age} / ${user.height} cm / ${user.weight} kg / ${user.gender}
- Job Activity: ${user.job}
- Goals: ${(user.goals||[]).join(', ')}
- Preferred Diet: ${user.diet} • Meals/Day: ${meals}
- Intermittent Fasting: ${user.fasting.enabled? (user.fasting.protocol+' '+user.fasting.start+'-'+user.fasting.end):'Disabled'}
- Health Conditions: ${(user.health||[]).join(', ')||'None'}
- Allergies: ${(user.allergies||[]).join(', ')||'None'}
- Injuries: ${user.injuries||'None'}
- Resistance Experience: ${user.exp}
- Focus Points: ${Object.entries(user.weak_points||{}).map(([k,v])=>`${k}:${v}`).join(', ')||'None'}

### Strict Daily Targets (hard constraint — hit within ±1% EVERY day)
- Calories: **${c.TDEE} kcal**
- Macros: **Protein ${c.P} g • Fat ${c.F} g • Carbs ${c.C} g**
- Diabetic/IR guardrail respected when applicable.

### REQUIRED SECTIONS (do not skip, rename, or merge)
1) ## Intro & Case Assessment (deep, practical)
   - Goals, constraints, risks, weekly KPIs (weight/waist/strength/sleep/resting pulse/energy), exact measurement cadence.
2) ## Allowed & Avoid List
   - Tailored to **${user.diet}** and allergies/conditions. Include sauces/marinades and beverages.
3) ## Intermittent Fasting ${user.fasting.enabled?'(ENABLED)':'(OPTIONAL)'}
   - Protocol ${user.fasting.enabled? user.fasting.protocol : '16:8 suggested'}, window ${user.fasting.start}–${user.fasting.end} (editable).
   - What breaks the fast, permitted drinks, common mistakes, condition-specific cautions.
4) ## Nutrition Plan (7 FULL DIFFERENT DAYS)
   - **For each day**, include a Markdown table with columns EXACTLY:
     | Meal # | Meal | Ingredients (g/unit) | Protein (g) | Fat (g) | Carbs (g) | Calories |
     |---:|---|---|---:|---:|---:|---:|
     ${RULE.meal}
   - After table: **Daily Total → P:__ F:__ C:__ Kcal:__** (must match daily target ±1%).
   - Append **[Swap]** next to each meal name to signal swappability.
5) ## Training Plan (${trainDays} days) — Intensity aligned with **${user.exp}**
   - **For each day**, include a Markdown table with columns EXACTLY:
     | Day | Exercise (EN) | Notes | Sets | Reps | Tempo | Rest (s) | RIR |
     |---:|---|---|---:|---:|---|---:|---:|
     ${RULE.train}
   - Avoid exacerbating injuries: ${user.injuries||'None'}. Emphasize focus areas: ${Object.entries(user.weak_points||{}).map(([k,v])=>`${k}:${v}`).join(', ')||'None'}.
6) ## Supplements & Recovery
   - Two tables:
     - **Core**: Whey/Casein, Creatine, Omega-3, Vitamin D, Magnesium, Electrolytes (dose, timing, training vs rest).
     - **Condition-Specific**: tailored to (${(user.health||[]).join(', ')||'No condition'}) with dose, timing, cautions, interactions if any.
7) ## Success & Progression
   - How to adjust calories (±150 kcal) based on 7–14 day trend, steps/sleep/water/stress playbook, carb tuning for diabetes/IR.
8) ## 7 Daily Motivation Messages
   - Short, actionable, non-generic (Day 1 → Day 7).
9) ## Add-On Modules
${ADDONS || '- (No add-ons selected)'}
10) ## Coach Signature & Rights
   - **مصطفى الصافي — خبير التغذية واللياقة البدنية │ مدرب دولي معتمد**
   - **Powered by Mustafa Elsafy 2025**

### VALIDATION RULES (critical and non-negotiable)
- 7 distinct days for nutrition **and** 7 distinct days for training.
- Column names EXACTLY as specified. Do not change or localize column keys beyond language directive above.
- Every nutrition day: Sum of P/F/C/Kcal ≈ daily target within ±1%.
- Respect allergies and conditions strictly; avoid forbidden items automatically.
- No "N/A", no templates, no placeholder text. Provide fully actionable content.
`.trim();
    }

    /* ======================== AI ======================== */
    async function generatePlan(){
      el('result').classList.remove('hidden');
      el('ai-html').innerHTML = `
        <div class="text-center py-10">
          <div class="w-12 h-12 rounded-full border-4 border-violet-600 border-t-transparent animate-spin mx-auto"></div>
          <div class="mt-3">${L[lang].ui.building}</div>
        </div>`;

      try{
        const prompt = buildPrompt();
        const res = await fetch('/.netlify/functions/gemini-proxy',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({prompt})
        });
        const text = await res.text();
        if(!res.ok) throw new Error(text||'Server error');

        let md = text;
        try{ const j = JSON.parse(text); if(j && j.text) md = j.text; }catch{}
        renderAI(md);
        scrollToResult();
      }catch(e){
        el('ai-html').innerHTML = `
          <div class="rounded-xl p-4 border border-rose-500/40 bg-rose-500/10" style="color:#fecaca">
            <div class="font-bold mb-1">${L[lang].ui.apiFail}</div>
            <div class="text-xs opacity-80">${String(e).slice(0,600)}</div>
          </div>`;
      }
    }

    function renderAI(markdown){
      // أربط عناوين لفهرس داخلي
      const withAnchors = markdown.replace(/^#{2,3}\s+(.*)$/gm, (m,h)=>{
        const id = (h||'').trim().toLowerCase().replace(/[^\w\u0600-\u06FF]+/g,'-');
        return `${m}\n[⬆︎](#top)\n<a id="${id}"></a>`;
      });
      const html = marked.parse(withAnchors);
      const planEl = document.getElementById('ai-html');
      planEl.innerHTML = `<div id="top"></div>` + html;

      // تحسين الجداول
      planEl.querySelectorAll('table').forEach(t=>{
        t.classList.add('w-full','text-sm');
        t.querySelectorAll('th').forEach(th=>th.classList.add('bg-[#0b121a]'));
      });

      // تحذير إذا اختصر النموذج
      const required = ['Intro','مقدمة','Allowed','المسموح','الصيام','Fasting','Nutrition Plan','خطة التغذية','Training Plan','خطة التدريب','Supplements','المكملات','Success','إرشادات','Motivation','رسائل','Signature','توقيع'];
      const text = planEl.innerText;
      const miss = required.filter(k=>!new RegExp(k,'i').test(text));
      if(miss.length){
        const warn=document.createElement('div');
        warn.className='rounded-xl p-3 border border-amber-500/40 bg-amber-500/10 text-amber-200 mt-3';
        warn.innerHTML=`<b>Quality Warning:</b> Missing sections → ${miss.join(' / ')}`;
        planEl.prepend(warn);
      }

      el('btn-print').classList.remove('hidden');
      el('btn-print-2').classList.remove('hidden');
    }

    /* ======================== Flow Controls ======================== */
    function scrollToResult(){ el('result').scrollIntoView({behavior:'smooth',block:'start'}); }
    function toast(msg,kind='ok'){
      const box=document.createElement('div');
      box.className=`fixed top-5 ${lang==='ar'?'right-5':'left-5'} z-50 px-3 py-2 rounded-xl text-sm text-white ${kind==='err'?'bg-red-600':'bg-emerald-600'}`;
      box.textContent=msg; document.body.appendChild(box);
      setTimeout(()=>box.remove(),2200);
    }

    el('btn-prev').onclick=()=>{ if(step>0){ step--; draw(); updateCTA(); } };
    el('btn-next').onclick=async ()=>{
      if(step<total-1){
        if(!saveStep()) return;
        step++; draw(); updateCTA();
        if(step===total-1){ if(!saveStep()) return; await generatePlan(); }
      }
    };
    el('btn-again').onclick=()=>location.reload();
    el('btn-print').onclick=()=>window.print();
    el('btn-print-2').onclick=()=>window.print();
    el('btn-lang-ar').onclick=()=>setLang('ar');
    el('btn-lang-en').onclick=()=>setLang('en');

    /* ======================== Init ======================== */
    setLang('ar'); draw(); updateLive(); updateCTA();
  </script>
</body>
</html>
