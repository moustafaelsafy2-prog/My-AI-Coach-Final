<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ | Intelligent Health Coach</title>

<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>

<style>
:root{
  --brand:#6c5ce7; --brand2:#00c2ff;
  --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
  --bg1:#0a0f1c; --bg2:#0e1526; --fg:#eaf0ff; --mut:#93a2b8;
  --card1:rgba(255,255,255,.08); --card2:rgba(255,255,255,.03); --border:rgba(255,255,255,.12); --field:rgba(255,255,255,.06);
}
body.light{
  --bg1:#eef2ff; --bg2:#f7f9ff; --fg:#0b1220; --mut:#4b5563;
  --card1:#ffffff; --card2:#ffffff; --border:#d1d5db; --field:#ffffff;
}
html[dir="rtl"] body{font-family:Tajawal,system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",sans-serif}
html[dir="ltr"] body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
body{background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%); color:var(--fg)}

.container{max-width:1120px;margin-inline:auto}
.glass{background:linear-gradient(180deg,var(--card1),var(--card2)); border:1px solid var(--border); border-radius:16px}
.section{padding:16px}
@media (min-width:768px){ .section{padding:20px} }

.btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.8rem;font-weight:800;padding:.7rem 1rem}
.btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff}
.btn-ghost{background:var(--field); border:1px solid var(--border); color:var(--fg)}
.chip{background:var(--field); border:1px solid var(--border); border-radius:999px; padding:.35rem .6rem; font-size:.78rem; color:var(--fg)}
.field{background:var(--field); border:1px solid var(--border); border-radius:.7rem; padding:.6rem .8rem; outline:none; width:100%; color:var(--fg)}
.field:focus{border-color:var(--brand2); box-shadow:0 0 0 3px rgba(0,194,255,.15)}

.grid-form{display:grid; gap:12px}
@media (min-width:768px){ .grid-form{grid-template-columns: repeat(12,minmax(0,1fr)); gap:14px} }
.form-card{grid-column:1/-1}
@media (min-width:768px){
  .col-3{grid-column: span 3 / span 3}
  .col-4{grid-column: span 4 / span 4}
  .col-6{grid-column: span 6 / span 6}
  .col-12{grid-column: span 12 / span 12}
}

.label{font-size:.85rem; opacity:.9; margin-bottom:6px; display:block}
.progress{height:.42rem; background:rgba(127,127,127,.18); border-radius:999px; overflow:hidden}
.progress>i{display:block;height:100%; background:linear-gradient(90deg,var(--brand),var(--brand2)); width:0%; transition:width .25s}
.title-grad{background:linear-gradient(90deg,var(--brand),var(--brand2)); -webkit-background-clip:text; background-clip:text; color:transparent}
.status{width:.6rem;height:.6rem;border-radius:999px;background:#94a3b8}
.status.run{background:var(--warn)} .status.ok{background:var(--ok)} .status.fail{background:var(--err)}

.ai-content h2{font-weight:900;font-size:1.2rem;margin:.5rem 0}
.ai-content h3{font-weight:800;font-size:1.05rem;margin:.4rem 0}
.ai-content table{width:100%;border-collapse:collapse;margin:.6rem 0}
.ai-content th,.ai-content td{border:1px solid var(--border);padding:.5rem;vertical-align:top}
.ai-content th{background:rgba(255,255,255,.06)}

/* Top mini progress */
#miniProgress{position:sticky; top:0; z-index:50; padding:.4rem .8rem; display:none}
#miniProgress.show{display:flex}

/* Live notice (bottom) */
#liveNotice{position:fixed; inset-inline:0; bottom:0; z-index:60; display:none}
#liveNotice.show{display:block}

/* Spinner */
.spin{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.3);border-top-color:var(--brand2);display:inline-block;animation:sp 1s linear infinite;vertical-align:-3px}
@keyframes sp{to{transform:rotate(360deg)}}

/* Toast */
.toast{position:fixed;inset-inline-end:16px;bottom:16px;background:#0e1a2d;color:#eaf0ff;border:1px solid rgba(255,255,255,.14);padding:.6rem .8rem;border-radius:.7rem;z-index:90}
@media print{#topbar,#wizard,#actions,#miniProgress,#liveNotice{display:none!important} body{background:#fff;color:#111}}
</style>
</head>
<body>

<!-- Top bar -->
<header id="topbar" class="glass section" style="position:sticky;top:0;z-index:40;backdrop-filter:blur(6px)">
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div style="display:flex;align-items:center;gap:10px">
      <div style="width:36px;height:36px" class="rounded-xl bg-gradient-to-br from-[var(--brand)] to-[var(--brand2)] grid place-items-center font-black">AI</div>
      <div>
        <div id="app-title" class="text-lg font-extrabold">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ</div>
        <div id="subtitle" class="text-xs" style="color:var(--mut)">Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù Ùª Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ø®ØµØµØ© Ù„Ùƒ</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <button id="btn-ar" class="chip">Ø¹Ø±Ø¨ÙŠ</button>
      <button id="btn-en" class="chip">EN</button>
      <button id="btn-theme" class="chip">â˜€/â˜¾</button>
      <button id="btn-mock" class="chip" title="ØªØ´ØºÙŠÙ„ Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù†Ø¯ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø°ÙƒØ§Ø¡">Mock: OFF</button>
      <button id="btn-print" class="btn btn-ghost">ğŸ–¨ <span id="t-print">Ø·Ø¨Ø§Ø¹Ø©</span></button>
    </div>
  </div>
</header>

<!-- Mini progress -->
<div id="miniProgress" class="glass">
  <div class="container" style="display:flex;align-items:center;gap:10px;justify-content:space-between">
    <div id="mp-text" class="text-xs">Ù†ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¢Ù†â€¦</div>
    <div class="progress" style="width:240px"><i id="mp-bar"></i></div>
  </div>
</div>

<!-- Bottom live notice -->
<div id="liveNotice">
  <div class="glass section" style="max-width:640px;margin:0 auto 12px">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div><span class="spin"></span> <span id="ln-msg">Ø¬Ø§Ø±Ù ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹â€¦</span></div>
      <div class="progress" style="width:220px"><i id="ln-bar"></i></div>
    </div>
  </div>
</div>

<main class="container" style="padding:18px 12px 28px">
  <!-- Wizard -->
  <section id="wizard" class="glass section" style="margin-bottom:14px">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
      <div id="step-title" class="title-grad text-xl font-extrabold">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
      <div class="progress" style="width:240px"><i id="wizard-bar"></i></div>
    </div>

    <div id="step-body" class="grid-form"></div>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px">
      <button id="prev" class="btn btn-ghost" disabled>â—€ <span id="t-prev">Ø§Ù„Ø³Ø§Ø¨Ù‚</span></button>
      <div style="display:flex;gap:8px">
        <button id="next" class="btn btn-primary"><span id="t-next">Ø§Ù„ØªØ§Ù„ÙŠ</span> â–¶</button>
        <button id="generate" class="btn btn-primary hidden">âš¡ <span id="t-generate">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©</span></button>
      </div>
    </div>
  </section>

  <!-- Timeline -->
  <section class="glass section" style="margin-bottom:14px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
      <div id="sectionsTitle" class="font-extrabold">ØªÙ‚Ø¯Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (ÙŠÙØ¹Ø±Ø¶ ÙƒÙ„ Ù‚Ø³Ù… ÙÙˆØ± ØªÙˆÙ„ÙŠØ¯Ù‡)</div>
      <div class="text-xs" style="color:var(--mut)">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ§Ø´Ù„ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯Ù‡</div>
    </div>
    <div id="timeline" style="display:flex;flex-wrap:wrap;gap:8px"></div>
  </section>

  <!-- Plan live -->
  <section class="glass section">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <h2 id="resultTitle" class="text-lg font-extrabold">Ø§Ù„Ø®Ø·Ø©</h2>
      <div id="actions" style="display:flex;gap:8px">
        <button class="btn btn-ghost" id="btn-top">â†‘ Ø£Ø¹Ù„Ù‰</button>
        <button class="btn btn-primary" id="btn-print2">ğŸ–¨ PDF / Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    </div>
    <div id="plan-empty" class="text-sm" style="color:var(--mut)">â€” Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù‡Ù†Ø§ ÙÙˆØ± ØªÙˆÙ„ÙŠØ¯Ù‡Ø§ â€”</div>
    <div id="plan-content" class="ai-content"></div>
  </section>

  <footer class="text-center text-[.85rem]" style="color:var(--mut);margin-top:18px">
    Powered by <strong>Coach Mustafa Elsafy</strong> â€” Ø§Ù„Ù…Ø¯Ø±Ø¨ <strong>Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ</strong> Â© 2025
  </footer>
</main>

<script>
/* ===== Helpers ===== */
const $=id=>document.getElementById(id);
const hasMD=!!window.marked, purifier=window.DOMPurify;
if(hasMD){ try{ marked.setOptions({breaks:true,mangle:false,headerIds:false}); }catch{} }
function mdSafe(s){ let html=hasMD?marked.parse(s):(s||'').replace(/\n/g,'<br>'); return purifier?DOMPurify.sanitize(html,{USE_PROFILES:{html:true}}):html; }
function toast(msg){ const d=document.createElement('div'); d.className='toast'; d.textContent=msg; document.body.appendChild(d); setTimeout(()=>d.remove(),3500); }

/* ===== State ===== */
const saveKey='ihc.v7';
const S={
  lang:(navigator.language||'ar').startsWith('ar')?'ar':'en',
  step:0, theme:'dark', mock:false,
  data:{
    profile:{name:'',age:'',height:'',weight:'',sex:'Male',bodyFat:'',waist:'',targetWeight:'',targetDate:''},
    diet:{goals:[],mealsPerDay:3,preferredDiet:'Balanced',fasting:'off',cuisine:'Arabic/Mediter.',prepTime:20,monthlyBudget:0,foodsToAvoid:'',allergies:''},
    lifestyle:{workActivity:'Sedentary',stepsPerDay:6000,sleep:'Low',stress:'Low',trainingPlace:'Home/Gym',sessionLength:60,availableDays:[],equipment:'',experience:'Beginner (0-6m)',rpe:8,caffeine:0,injuries:''},
    medical:{conditions:[],other:'',meds:'',supplements:''},
    challenges:{past:'',motivation:'Direct'},
    currency:'USD'
  },
  sectionList:[], statuses:{}, results:{}
};

/* ===== I18N ===== */
const I={
  ar:{app:'Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ', sub:'Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù¡Ù Ù Ùª Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ø®ØµØµØ© Ù„Ùƒ',
      steps:['Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ','Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª','Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨','Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª'],
      prev:'Ø§Ù„Ø³Ø§Ø¨Ù‚', next:'Ø§Ù„ØªØ§Ù„ÙŠ', generate:'ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©', print:'Ø·Ø¨Ø§Ø¹Ø©',
      sectionsTitle:'ØªÙ‚Ø¯Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (ÙŠÙØ¹Ø±Ø¶ ÙƒÙ„ Ù‚Ø³Ù… ÙÙˆØ± ØªÙˆÙ„ÙŠØ¯Ù‡)', result:'Ø§Ù„Ø®Ø·Ø©',
      retry:'Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…', need:'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ø·ÙˆÙ„/Ø§Ù„ÙˆØ²Ù†.', fail:'ÙØ´Ù„', done:'ØªÙ…', run:'Ø¬Ø§Ø±Ùâ€¦',
      reading:'ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ ØªØ¨Ø§Ø¹Ù‹Ø§ â€” Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠÙƒØªÙ…Ù„ (%s%)',
      sec:{welcome:'Ø§Ù„ØªØ±Ø­ÙŠØ¨',analysis:'Ø§Ù„ØªØ­Ù„ÙŠÙ„',allowed:'Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹',fasting:'Ø§Ù„ØµÙŠØ§Ù…',nut:'Ø§Ù„ØªØºØ°ÙŠØ© â€” ÙŠÙˆÙ…',tra:'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ â€” ÙŠÙˆÙ…',supp:'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª',prog:'Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…',trbl:'Ø§Ù„Ù…Ø´Ø§ÙƒÙ„',safe:'Ø§Ù„Ø³Ù„Ø§Ù…Ø©',close:'Ø§Ù„Ø®ØªØ§Ù…'}
  },
  en:{app:'Intelligent Health Coach', sub:'100% precise plan for nutrition, training & supplements â€“ fully personalized',
      steps:['Profile','Diet & Preferences','Lifestyle & Training','Medical & Challenges'],
      prev:'Back', next:'Next', generate:'Generate Plan', print:'Print',
      sectionsTitle:'Section progress (each appears when ready)', result:'Plan',
      retry:'Regenerate this section', need:'Please complete: name/age/height/weight.', fail:'Failed', done:'Done', run:'Runningâ€¦',
      reading:'Generating sequentially â€” please keep reading (%s%)',
      sec:{welcome:'Welcome',analysis:'Analysis',allowed:'Allowed / Limits',fasting:'Intermittent fasting',nut:'Nutrition â€” Day',tra:'Training â€” Day',supp:'Supplements',prog:'Progression',trbl:'Troubleshooting',safe:'Safety',close:'Closing'}
  }
};
const t=k=>(I[S.lang]&&I[S.lang][k])||k;
function secName(key){
  const s=I[S.lang].sec;
  if(key.startsWith('nutrition-day')) return `${s.nut} ${key.split('-').pop()}`;
  if(key.startsWith('training-day')) return `${s.tra} ${key.split('-').pop()}`;
  const map={welcome:'welcome',analysis:'analysis',allowed:'allowed',fasting:'fasting',supplements:'supp',progression:'prog',troubleshoot:'trbl',safety:'safe',closing:'close'};
  return s[map[key]]||key;
}
function applyLang(){
  document.documentElement.lang=S.lang; document.documentElement.dir=(S.lang==='ar')?'rtl':'ltr';
  $('app-title').textContent=I[S.lang].app; $('subtitle').textContent=I[S.lang].sub; $('t-print').textContent=I[S.lang].print;
  $('sectionsTitle').textContent=I[S.lang].sectionsTitle; $('resultTitle').textContent=I[S.lang].result;
  $('t-prev').textContent=I[S.lang].prev; $('t-next').textContent=I[S.lang].next; $('t-generate').textContent=I[S.lang].generate;
}

/* ===== Wizard ===== */
function renderStep(){
  const L=(S.lang==='ar'); const b=$('step-body'); const names=I[S.lang].steps;
  $('step-title').textContent=names[S.step];
  $('wizard-bar').style.width=((S.step+1)/4*100)+'%';

  if(S.step===0){
    b.innerHTML=`
      <div class="form-card">
        <div class="grid-form">
          <div class="col-6"><label class="label">${L?'Ø§Ù„Ø§Ø³Ù…':'Name'}</label><input id="name" class="field" placeholder="${L?'Ø§Ù„Ø§Ø³Ù…':'Name'}"/></div>
          <div class="col-3"><label class="label">${L?'Ø§Ù„Ø¹Ù…Ø±':'Age'}</label><input id="age" class="field" inputmode="numeric"/></div>
          <div class="col-3"><label class="label">${L?'Ø§Ù„Ø¬Ù†Ø³':'Sex'}</label><select id="sex" class="field"><option value="Male">${L?'Ø°ÙƒØ±':'Male'}</option><option value="Female">${L?'Ø£Ù†Ø«Ù‰':'Female'}</option></select></div>

          <div class="col-3"><label class="label">${L?'Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)':'Height (cm)'}</label><input id="height" class="field" inputmode="numeric"/></div>
          <div class="col-3"><label class="label">${L?'Ø§Ù„ÙˆØ²Ù† (ÙƒØº)':'Weight (kg)'}</label><input id="weight" class="field" inputmode="numeric"/></div>
          <div class="col-3"><label class="label">${L?'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† %':'Body fat %'}</label><input id="bodyFat" class="field" inputmode="numeric"/></div>
          <div class="col-3"><label class="label">${L?'Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ± (Ø³Ù…)':'Waist (cm)'}</label><input id="waist" class="field" inputmode="numeric"/></div>

          <div class="col-3"><label class="label">${L?'Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (ÙƒØº)':'Target weight (kg)'}</label><input id="targetWeight" class="field" inputmode="numeric"/></div>
          <div class="col-3"><label class="label">${L?'Ù…ÙˆØ¹Ø¯ ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù':'Target date'}</label><input id="targetDate" type="date" class="field"/></div>
        </div>
      </div>`;
  } else if(S.step===1){
    b.innerHTML=`
      <div class="form-card">
        <div class="grid-form">
          <div class="col-6">
            <label class="label">${L?'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ù…ØªØ¹Ø¯Ø¯)':'Goals (multi-select)'}</label>
            <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px" class="text-sm">
              ${[['fatLoss','Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†','Fat loss'],['build','Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª','Build muscle'],['strength','Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©','Strength'],['endurance','ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„','Endurance'],['health','ØµØ­Ø© Ø¹Ø§Ù…Ø©','General health']]
                .map(([v,ar,en])=>`<label><input type="checkbox" class="goal" value="${v}"/> ${L?ar:en}</label>`).join('')}
            </div>
          </div>

          <div class="col-3"><label class="label">${L?'Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª':'Meals/day'}</label><input id="meals" class="field" value="3" inputmode="numeric"/></div>
          <div class="col-3"><label class="label">${L?'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù‘Ù„':'Preferred diet'}</label>
            <select id="prefDiet" class="field">
              <option value="Balanced">${L?'Ù†Ø¸Ø§Ù… Ù…ØªÙˆØ§Ø²Ù†':'Balanced'}</option>
              <option value="LowCarb">${L?'Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª':'Low-carb'}</option>
              <option value="Keto">${L?'ÙƒÙŠØªÙˆ':'Keto'}</option>
              <option value="Arabic/Mediter.">${L?'Ù…ØªÙˆØ³Ø·ÙŠ/Ø¹Ø±Ø¨ÙŠ':'Mediterranean/Arabic'}</option>
              <option value="Plant">${L?'Ù†Ø¨Ø§ØªÙŠ/Ù…Ø±Ù†':'Plant-forward'}</option>
            </select>
          </div>

          <div class="col-3"><label class="label">${L?'Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹':'Intermittent fasting'}</label>
            <select id="fasting" class="field"><option value="off">${L?'ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„':'Off'}</option><option>16:8</option><option>18:6</option><option>20:4</option></select>
          </div>
          <div class="col-3"><label class="label">${L?'Ø§Ù„Ù…Ø·Ø¨Ø®':'Cuisine'}</label><input id="cuisine" class="field" value="Arabic/Mediter."/></div>

          <div class="col-3"><label class="label">${L?'Ø²Ù…Ù† Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø¯)':'Prep time (min)'}</label><input id="prep" class="field" value="20" inputmode="numeric"/></div>
          <div class="col-3"><label class="label">${L?'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©':'Monthly budget'}</label><input id="budget" class="field" value="0" inputmode="numeric"/></div>
          <div class="col-3"><label class="label">Currency</label><select id="currency" class="field"><option>USD</option><option>EUR</option><option>GBP</option><option>SAR</option><option>AED</option><option>KWD</option><option>QAR</option><option>EGP</option></select></div>

          <div class="col-6"><label class="label">${L?'Ø£Ø·Ø¹Ù…Ø© Ù„Ø§ ØªØ±ØºØ¨ Ø¨Ù‡Ø§/Ø­Ø³Ø§Ø³ÙŠØ§Øª':'Foods to avoid / dislikes'}</label><input id="avoid" class="field" placeholder="Fish dislike, nut allergy â€¦"/></div>
          <div class="col-6"><label class="label">${L?'Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø´Ø§Ø¦Ø¹Ø©':'Common allergies'}</label><input id="allergies" class="field" placeholder="Gluten, Lactose, Nuts â€¦"/></div>
        </div>
      </div>`;
  } else if(S.step===2){
    b.innerHTML=`
      <div class="form-card">
        <div class="grid-form">
          <div class="col-3"><label class="label">${L?'Ø§Ù„Ø¹Ù…Ù„/Ø§Ù„Ù†Ø´Ø§Ø·':'Work/Activity'}</label>
            <select id="work" class="field"><option value="Sedentary">${L?'Ù…ÙƒØªØ¨ÙŠ':'Sedentary'}</option><option value="Light">${L?'Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ':'Light'}</option><option value="Moderate">${L?'Ù…ØªÙˆØ³Ø·':'Moderate'}</option><option value="High">${L?'Ù…Ø±ØªÙØ¹':'High'}</option></select></div>
          <div class="col-3"><label class="label">${L?'Ø®Ø·ÙˆØ§Øª/Ø§Ù„ÙŠÙˆÙ…':'Steps/day'}</label><input id="steps" class="field" value="6000" inputmode="numeric"/></div>
          <div class="col-3"><label class="label">${L?'Ø§Ù„Ù†ÙˆÙ…':'Sleep'}</label><select id="sleep" class="field"><option>Low</option><option>Medium</option><option>High</option></select></div>
          <div class="col-3"><label class="label">${L?'Ø§Ù„ØªÙˆØªØ±':'Stress'}</label><select id="stress" class="field"><option>Low</option><option>Medium</option><option>High</option></select></div>

          <div class="col-3"><label class="label">${L?'Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ…Ø±ÙŠÙ†':'Training place'}</label><input id="place" class="field" value="Home/Gym"/></div>
          <div class="col-3"><label class="label">${L?'Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯)':'Session length (min)'}</label><input id="session" class="field" value="60" inputmode="numeric"/></div>
          <div class="col-6"><label class="label">${L?'Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©':'Available equipment'}</label><input id="equip" class="field" placeholder="Dumbbells, barbell, bandsâ€¦"/></div>

          <div class="col-12">
            <label class="label">${L?'Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©':'Available training days'}</label>
            <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px" class="text-xs">
              ${['Ø³','Ø­','Ù†','Ø«','Ø±','Ø®','Ø¬'].map((d,i)=>`<label class="chip"><input type="checkbox" id="d${i}" class="me-1"/> ${d}</label>`).join('')}
            </div>
          </div>

          <div class="col-3"><label class="label">${L?'Ø§Ù„Ø®Ø¨Ø±Ø©':'Experience'}</label><select id="exp" class="field"><option>Beginner (0-6m)</option><option>Intermediate (6-24m)</option><option>Advanced (24m+)</option></select></div>
          <div class="col-3"><label class="label">RPE</label><input id="rpe" class="field" value="8" inputmode="numeric"/></div>
          <div class="col-3"><label class="label">${L?'ÙƒØ§ÙÙŠÙŠÙ†/Ø§Ù„ÙŠÙˆÙ…':'Caffeine/day'}</label><input id="caf" class="field" value="0" inputmode="numeric"/></div>
          <div class="col-3"><label class="label">${L?'Ø¥ØµØ§Ø¨Ø§Øª/Ù‚ÙŠÙˆØ¯':'Injuries/constraints'}</label><input id="inj" class="field" placeholder="Shoulder impingementâ€¦"/></div>
        </div>
      </div>`;
  } else {
    b.innerHTML=`
      <div class="form-card">
        <div class="grid-form">
          <div class="col-12">
            <label class="label">${L?'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©':'Medical status'}</label>
            <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px" class="text-sm">
              ${[['Hypertension','Ø¶ØºØ· Ø§Ù„Ø¯Ù…'],['Diabetes','Ø§Ù„Ø³ÙƒØ±ÙŠ'],['Insulin Resistance','Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†'],['Thyroid issues','Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØºØ¯Ø©'],['Hormonal issues','Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©'],['Fatty Liver','Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ'],['Joint/Knee problems','Ù…ÙØ§ØµÙ„/Ø±ÙƒØ¨'],['Heart disease','Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨'],['IBD/Ulcer','IBD/Ù‚Ø±Ø­Ø©'],['GERD/Reflux','GERD/Ø§Ø±ØªØ¬Ø§Ø¹'],['Gluten intolerance','Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†'],['Lactose intolerance','Ø¹Ø¯Ù… ØªØ­Ù…Ù„ Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²']]
              .map(([v,ar])=>`<label><input type="checkbox" class="cond" value="${v}"/> ${L?ar:v}</label>`).join('')}
            </div>
          </div>
          <div class="col-6"><label class="label">${L?'Ø£Ù…Ø±Ø§Ø¶ Ø£Ø®Ø±Ù‰':'Other conditions'}</label><input id="otherCond" class="field"/></div>
          <div class="col-6"><label class="label">${L?'Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ©':'Current medications'}</label><input id="meds" class="field"/></div>
          <div class="col-6"><label class="label">${L?'Ù…ÙƒÙ…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ©':'Current supplements'}</label><input id="supps" class="field"/></div>
          <div class="col-6"><label class="label">${L?'ØªØ­Ø¯ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©':'Past challenges'}</label><input id="past" class="field" placeholder="${L?'Ø¬ÙˆØ¹ Ø´Ø¯ÙŠØ¯ØŒ Ù…Ù„Ù„â€¦':'Strong hunger, boredomâ€¦'}"/></div>
          <div class="col-4"><label class="label">${L?'Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØ­ÙÙŠØ²':'Motivation style'}</label><select id="motiv" class="field"><option value="Direct">${L?'Ø¹Ù…Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±':'Direct & pragmatic'}</option><option value="Warm">${L?'ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…':'Supportive & warm'}</option></select></div>
        </div>
      </div>`;
  }
  restoreValues();
  $('prev').disabled=(S.step===0);
  $('next').classList.toggle('hidden',S.step===3);
  $('generate').classList.toggle('hidden',S.step!==3);
}
function saveStep(){
  try{
    if(S.step===0){const p=S.data.profile; p.name=$('name').value.trim(); p.age=$('age').value.trim(); p.height=$('height').value.trim(); p.weight=$('weight').value.trim(); p.bodyFat=$('bodyFat').value.trim(); p.waist=$('waist').value.trim(); p.sex=$('sex').value; p.targetWeight=$('targetWeight').value.trim(); p.targetDate=$('targetDate').value;}
    else if(S.step===1){const goals=[...document.querySelectorAll('.goal')].filter(x=>x.checked).map(x=>x.value); const d=S.data.diet; d.goals=goals; d.mealsPerDay=+($('meals').value||3); d.preferredDiet=$('prefDiet').value; d.fasting=$('fasting').value; d.cuisine=$('cuisine').value; d.prepTime=+($('prep').value||20); d.monthlyBudget=+($('budget').value||0); d.foodsToAvoid=$('avoid').value; d.allergies=$('allergies').value; S.data.currency=$('currency').value;}
    else if(S.step===2){const L=S.data.lifestyle; L.workActivity=$('work').value; L.stepsPerDay=+($('steps').value||6000); L.sleep=$('sleep').value; L.stress=$('stress').value; L.trainingPlace=$('place').value; L.sessionLength=+($('session').value||60); const days=[]; for(let i=0;i<7;i++) if($('d'+i).checked) days.push(i); L.availableDays=days; L.equipment=$('equip').value; L.experience=$('exp').value; L.rpe=+($('rpe').value||8); L.caffeine=+($('caf').value||0); L.injuries=$('inj').value;}
    else{const cond=[...document.querySelectorAll('.cond')].filter(x=>x.checked).map(x=>x.value); S.data.medical.conditions=cond; S.data.medical.other=$('otherCond').value; S.data.medical.meds=$('meds').value; S.data.medical.supplements=$('supps').value; S.data.challenges.past=$('past').value; S.data.challenges.motivation=$('motiv').value;}
    localStorage.setItem(saveKey, JSON.stringify(S.data));
  }catch(e){}
}
function restoreValues(){
  try{
    const d=S.data, set=(id,v)=>{ const el=$(id); if(el!=null && v!=null) el.value=v; };
    if(S.step===0){const p=d.profile; set('name',p.name); set('age',p.age); set('height',p.height); set('weight',p.weight); set('bodyFat',p.bodyFat); set('waist',p.waist); set('sex',p.sex); set('targetWeight',p.targetWeight); set('targetDate',p.targetDate);}
    if(S.step===1){(d.diet.goals||[]).forEach(g=>{const el=[...document.querySelectorAll('.goal')].find(x=>x.value===g); if(el) el.checked=true;}); set('meals',d.diet.mealsPerDay); set('prefDiet',d.diet.preferredDiet); set('fasting',d.diet.fasting); set('cuisine',d.diet.cuisine); set('prep',d.diet.prepTime); set('budget',d.diet.monthlyBudget); set('avoid',d.diet.foodsToAvoid); set('allergies',d.diet.allergies); set('currency',d.currency);}
    if(S.step===2){const L=d.lifestyle; set('work',L.workActivity); set('steps',L.stepsPerDay); set('sleep',L.sleep); set('stress',L.stress); set('place',L.trainingPlace); set('session',L.sessionLength); (L.availableDays||[]).forEach(i=>{const el=$('d'+i); if(el) el.checked=true;}); set('equip',L.equipment); set('exp',L.experience); set('rpe',L.rpe); set('caf',L.caffeine); set('inj',L.injuries);}
    if(S.step===3){(d.medical.conditions||[]).forEach(c=>{const el=[...document.querySelectorAll('.cond')].find(x=>x.value===c); if(el) el.checked=true;}); set('otherCond',d.medical.other); set('meds',d.medical.meds); set('supps',d.medical.supplements); set('past',d.challenges.past); set('motiv',d.challenges.motivation);}
  }catch{}
}

/* ===== Targets ===== */
function targets(){
  const p=S.data.profile, L=S.data.lifestyle, goals=S.data.diet.goals;
  const W=+p.weight||0, H=+p.height||0, A=+p.age||0, male=(p.sex==='Male'||p.sex==='Ø°ÙƒØ±');
  const BMR= male? 10*W+6.25*H-5*A+5 : 10*W+6.25*H-5*A-161;
  const mult={Sedentary:1.2,Light:1.35,Moderate:1.5,High:1.7}[L.workActivity||'Light'];
  let T=BMR*mult; if(goals.includes('fatLoss')) T*=0.85; if(goals.includes('build')) T*=1.10;
  let P=Math.round(2.0*Math.max(+p.targetWeight||W||40,40)), F=Math.round(Math.max(0.8*W,40)), C=Math.round((T-(P*4+F*9))/4);
  if((S.data.medical.conditions||[]).some(c=>c==='Diabetes'||c==='Insulin Resistance')) C=Math.min(C,120);
  return {bmr:Math.round(BMR), tdee:Math.round(T), protein_g:P, fat_g:F, carb_g:Math.max(40,C)};
}

/* ===== Sections ===== */
function listSections(){
  const arr=['welcome','analysis','allowed']; const f=S.data.diet.fasting||'off'; if(f!=='off') arr.push('fasting');
  for(let i=1;i<=7;i++) arr.push('nutrition-day-'+i);
  for(let i=1;i<=7;i++) arr.push('training-day-'+i);
  arr.push('supplements','progression','troubleshoot','safety','closing'); S.sectionList=arr;
}
function headerBlock(){
  const P=S.data.profile,D=S.data.diet,L=S.data.lifestyle,M=S.data.medical,C=S.data.currency,T=targets();
  const daysAR=['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'], daysEN=['Sat','Sun','Mon','Tue','Wed','Thu','Fri'];
  const days=(S.lang==='ar')?daysAR:daysEN; const avail=(L.availableDays||[]).map(i=>days[i]).join(', ')||(S.lang==='ar'?'ØºÙŠØ± Ù…Ø­Ø¯Ø¯':'Not specified');
  const tone=S.data.challenges.motivation==='Direct' ? (S.lang==='ar'?'Ø¹Ù…Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø± Ø¨Ù„Ø§ Ù…Ø¨Ø§Ù„ØºØ©':'Pragmatic, direct, no fluff') : (S.lang==='ar'?'ØªØ´Ø¬ÙŠØ¹ÙŠ ÙˆØ¯Ø§Ø¹Ù…':'Supportive & warm');
  return `Name:${P.name} | Sex:${P.sex} | Age:${P.age} | H:${P.height}cm | W:${P.weight}kg
Goals:${(D.goals||[]).join(', ')} | Pref diet:${D.preferredDiet} | Meals:${D.mealsPerDay} | IF:${D.fasting}
Cuisine:${D.cuisine} | Prep:${D.prepTime}min | Budget:${C} ${D.monthlyBudget}
Activity:${L.workActivity} | Steps:${L.stepsPerDay} | Sleep:${L.sleep} | Stress:${L.stress}
Place:${L.trainingPlace} | Session:${L.sessionLength} | Days:${avail} | RPE:${L.rpe} | Equip:${L.equipment||'Bodyweight'}
Medical:${(M.conditions||[]).join(', ')||'None'} | Injuries:${L.injuries||'None'}
Allergies:${D.allergies||'None'} | Dislikes:${D.foodsToAvoid||'None'}
Targets:~${T.tdee} kcal / P ${T.protein_g}g / F ${T.fat_g}g / C ${T.carb_g}g
Tone:${tone}. LANGUAGE:${S.lang}. EXERCISES in English.
STRICT: Output in ${S.lang==='ar'?'Arabic':'English'} only. Never apologize. If exact data unavailable, create a valid table matching macros within Â±10% and proceed.`.trim();
}
function prompt(section,extra={},mode='full'){
  const A=(S.lang==='ar'), H=headerBlock();
  const onlyTable = '\n\nØ£Ø¬Ø¨ Ø¨Ø¬Ø¯ÙˆÙ„ Ù…Ø§Ø±ÙƒØ¯Ø§ÙˆÙ† ÙÙ‚Ø· Ø¯ÙˆÙ† Ø£ÙŠ ÙÙ‚Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©. Ø¥Ø°Ø§ Ù„Ù… ØªØªÙ…ÙƒÙ‘Ù† Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ØŒ Ù‚Ø³Ù‘Ù… Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ù…Ø¹ ØµÙ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø¶Ù…Ù† Â±10%. Ù„Ø§ ØªÙƒØªØ¨ Ø£ÙŠ Ø³Ø·ÙˆØ± ØªÙØ³ÙŠØ±ÙŠØ©.';
  if(section==='welcome') return `${H}\n\n${A?'Ø§ÙƒØªØ¨ ØªØ±Ø­ÙŠØ¨Ù‹Ø§ Ù‚ØµÙŠØ±Ù‹Ø§ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ„Ù…Ø­Ø© Ù…ÙˆØ¬Ø²Ø© Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø©.':''}`;
  if(section==='analysis') return `${H}\n\n${A?'Ø­Ù„Ù‘Ù„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙˆØ§Ù„Ù‚ÙŠÙˆØ¯ ÙˆÙ…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø¹Ø±Ø§Øª/Ø§Ù„Ù…Ø§ÙƒØ±ÙˆØ² Ø¨Ù†Ù‚Ø§Ø· Ù…Ø±ÙƒÙ‘Ø²Ø©.':''}`;
  if(section==='allowed') return `${H}\n\n${A?'Ù‚Ø§Ø¦Ù…ØªØ§Ù†: 1) Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù‚ØªØ±Ø­ 2) Ù…Ø§ ÙŠÙØ¶Ù‘Ù„ Ø§Ù„Ø­Ø¯ Ù…Ù†Ù‡/ØªØ¬Ù†Ø¨Ù‡.':''}`;
  if(section==='fasting') return `${H}\n\n${A?'Ø§Ø´Ø±Ø­ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹ Ø¨Ø£Ù…Ø§Ù† Ù…Ø¹ ØªÙˆÙ‚ÙŠØª Ø§Ù„ØªÙ…Ø±ÙŠÙ† ÙˆØ§Ù„ÙƒØ§ÙÙŠÙŠÙ†.':''}`;
  if(section==='nutrition-day'){const d=extra.day; const base=`${H}\n\n${A?`Ø®Ø·Ø© Ø§Ù„ØªØºØ°ÙŠØ© Ù„ÙŠÙˆÙ… ${d} Ù…Ù† Ù§. Ø¬Ø¯ÙˆÙ„: Ø§Ù„ÙˆØ¬Ø¨Ø© | Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª (Ø¬Ø±Ø§Ù…) | kcal | Protein | Fat | Carbs. Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠÙˆÙ…ÙŠ Ø¶Ù…Ù† Â±10% Ù…Ù† Ø§Ù„Ø£Ù‡Ø¯Ø§Ù. Ø¶Ø¹ [SWAP:MEAL:<name>].`:''}`; return mode==='table'? base+onlyTable : base;}
  if(section==='training-day'){const d=extra.day; const base=`${H}\n\n${A?`Ø®Ø·Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ù„ÙŠÙˆÙ… ${d} Ù…Ù† Ù§. Ø¬Ø¯ÙˆÙ„: Ø§Ù„ÙŠÙˆÙ… | Exercise | Sets | Reps | Rest(s). Ø±Ø§Ø¹Ù Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª ÙˆØ±ÙƒØ² Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù. Ø¶Ø¹ [SWAP:EXERCISE:<name>].`:''}`; return mode==='table'? base+onlyTable : base;}
  if(section==='supplements') return `${H}\n\n${A?'Ù…ÙƒÙ…Ù„Ø§Øª Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù„ÙŠÙ„: Ø£Ø³Ø§Ø³ÙŠ/Ù…ÙˆØ¬Ù‘Ù‡/Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ù…Ø¹ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª + ØªÙ†Ø¨ÙŠÙ‡ Ø·Ø¨ÙŠ.':''}`;
  if(section==='progression') return `${H}\n\n${A?'Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø¯Ù‘Ù… 8â€“12 Ø£Ø³Ø¨ÙˆØ¹Ù‹Ø§: Ø²ÙŠØ§Ø¯Ø§Øª ÙˆØ¯Ù„ÙˆØ¯ ÙˆÙƒØ§Ø±Ø¯ÙŠÙˆ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· TDEE.':''}`;
  if(section==='troubleshoot') return `${H}\n\n${A?'Ø­Ù„ÙˆÙ„ Ù„Ù„Ø¬ÙˆØ¹/Ø§Ù„Ø«Ø¨Ø§Øª/Ø§Ù„Ù†ÙˆÙ…/Ø§Ù„Ø¶ØºØ·/Ø§Ù„Ø±ØºØ¨Ø§Øª/Ø§Ù„Ø³ÙØ± ÙˆØ§Ù„Ù…Ø·Ø§Ø¹Ù… (Ù¢â€“Ù£ Ù†Ù‚Ø§Ø·).':''}`;
  if(section==='safety') return `${H}\n\n${A?'Ø³Ù„Ø§Ù…Ø©: ØªÙ‚Ù†ÙŠØ©ØŒ ÙˆÙ‚Ø§ÙŠØ© Ø¥ØµØ§Ø¨Ø§ØªØŒ ØªØ±ÙˆÙŠØ© ÙˆÙ†ÙˆÙ…ØŒ Ù…ØªÙ‰ Ù†ÙˆÙ‚Ù Ø§Ù„ØªÙ…Ø±ÙŠÙ† ÙˆÙ†Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨.':''}`;
  if(section==='closing') return `${H}\n\n${A?'Ø®ØªØ§Ù… ØªØ­ÙÙŠØ²ÙŠ Ù‚ØµÙŠØ± Ù…ÙˆØ¬Ù‘Ù‡ Ø¨Ø§Ù„Ø§Ø³Ù… Ø¨Ù„Ø§ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ±Ø­ÙŠØ¨.':''}`;
  return H;
}

/* ===== AI / Mock ===== */
async function callAI(p,{tries=3,base=900,timeout=60000}={}){
  if(S.mock){ return {ok:true,text:mockText(p)}; }
  for(let i=0;i<tries;i++){
    const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(),timeout);
    try{
      const res=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:p}),signal:ctrl.signal});
      clearTimeout(to);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json(); const text=data.text||'';
      if(validate(text)) return {ok:true,text};
      throw new Error('Invalid output');
    }catch(e){ if(i===tries-1) return {ok:false,error:String(e)}; await new Promise(r=>setTimeout(r, base*(2**i))); }
  }
}
function validate(s){
  if(!s || s.trim().length<40) return false;
  if(S.lang==='ar' && /[A-Za-z]{6,}/.test(s) && !/kcal|Protein|Fat|Carbs|Exercise|Sets|Reps/i.test(s)) return false;
  if(/\|.*kcal/i.test(s)) return true; // Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªØºØ°ÙŠØ©
  if(/Exercise|Sets|Reps/i.test(s)) return true; // Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨
  if(/^\s*[-*]|^#|\n-/.test(s)) return true; // Ù‚ÙˆØ§Ø¦Ù… Ø¹Ø§Ù…Ø©
  return false;
}
function mockText(p){
  if(/Ø®Ø·Ø© Ø§Ù„ØªØºØ°ÙŠØ© Ù„ÙŠÙˆÙ…/.test(p)) return localNutritionSkeleton(1);
  if(/Ø®Ø·Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ù„ÙŠÙˆÙ…/.test(p)) return localTrainingSkeleton(1);
  if(/Ø§Ù„ØªØ±Ø­ÙŠØ¨|Welcome/.test(p)) return (S.lang==='ar')?`### Ø£Ù‡Ù„Ø§Ù‹ ${S.data.profile.name}\nØ³Ù†Ø¨Ù†ÙŠ Ø®Ø·Ø© Ø¹Ù…Ù„ÙŠØ© Ù…Ø®ØµØµØ© Ù„Ùƒ. Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ØªØ¨Ø§Ø¹Ù‹Ø§ Ù‡Ù†Ø§.`:`### Welcome ${S.data.profile.name}\nYour personalized plan will stream in below.`;
  if(/Ø§Ù„Ù…Ø³Ù…ÙˆØ­/.test(p)) return (S.lang==='ar')?`- Ø¨Ø±ÙˆØªÙŠÙ†Ø§Øª: Ø¯Ø¬Ø§Ø¬ØŒ Ù„Ø­Ù… Ø®ÙÙŠÙØŒ Ø³Ù…Ùƒ\n- ÙƒØ§Ø±Ø¨: Ø£Ø±Ø²/Ø¨Ø·Ø§Ø·Ø³/Ø´ÙˆÙØ§Ù†\n- Ø¯Ù‡ÙˆÙ†: Ø²ÙŠØª Ø²ÙŠØªÙˆÙ†/Ù…ÙƒØ³Ø±Ø§Øª\n\n**Ø§Ù„ØªÙ‚Ù„ÙŠÙ„:** Ø³ÙƒØ±ÙŠØ§Øª Ø³Ø§Ø¦Ù„Ø©ØŒ Ø£Ø·Ø¹Ù…Ø© Ù…Ù‚Ù„ÙŠØ©.`:`- Proteins: chicken/lean beef/fish\n- Carbs: rice/potatoes/oats\n- Fats: olive oil/nuts\n\n**Limit:** liquid sugars, deep-fried foods.`;
  return (S.lang==='ar')?`Ù†Øµ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©.`:`Mock text generated locally.`;
}

/* Local skeletons (fallback) */
function localNutritionSkeleton(day){
  const T=targets(); const meals=Math.max(3, +S.data.diet.mealsPerDay||3);
  const p=T.protein_g, f=T.fat_g, c=T.carb_g, kcal=T.tdee, per=(x)=>Math.round(x/meals);
  let out=`| Ø§Ù„ÙˆØ¬Ø¨Ø© | Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª (Ø¬Ø±Ø§Ù…) | kcal | Protein | Fat | Carbs |\n|---|---|---|---|---|---|\n`;
  for(let i=1;i<=meals;i++) out+=`| ÙˆØ¬Ø¨Ø© ${i} | Ø¨Ø±ÙˆØªÙŠÙ† + ÙƒØ§Ø±Ø¨ Ù…Ø¹Ù‚Ù‘Ø¯ + Ø¯Ù‡ÙˆÙ† ØµØ­ÙŠØ© | ${per(kcal)} | ${per(p)} | ${per(f)} | ${per(c)} |\n`;
  out+=`| **Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ** | â€” | **${kcal}** | **${p}** | **${f}** | **${c}** |`;
  return out;
}
function localTrainingSkeleton(day){
  return `| Day | Exercise | Sets | Reps | Rest (sec) |\n|---|---|---|---|---|\n| ${day} | Squat | 4 | 6â€“8 | 120 |\n| ${day} | Bench Press | 4 | 6â€“8 | 120 |\n| ${day} | Row | 4 | 8â€“10 | 90 |\n| ${day} | Plank | 3 | 45â€“60s | 60 |`;
}

/* ===== Timeline & Rendering ===== */
function buildTimeline(){ $('timeline').innerHTML=''; S.sectionList.forEach(k=>{ const el=document.createElement('div'); el.className='chip'; el.dataset.key=k; el.innerHTML=`<span class="status"></span> <span class="label">${secName(k)}</span>`; $('timeline').appendChild(el); }); }
function setTL(k,st){ const el=[...$('timeline').children].find(x=>x.dataset.key===k); if(el) el.querySelector('.status').className='status '+st; }
function appendCard(key,html,status){
  const wrap=$('plan-content'); const card=document.createElement('article'); card.className='glass section'; card.style.marginBottom='12px'; card.id='sec-'+key;
  const head=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
      <h2 class="text-base md:text-lg font-extrabold">${secName(key)}</h2>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="text-xs" style="color:var(--mut)">${status==='ok'?I[S.lang].done:status==='fail'?I[S.lang].fail:I[S.lang].run}</span>
        ${status==='fail'?`<button class="btn btn-ghost text-xs" data-retry="${key}">â†» ${I[S.lang].retry}</button>`:''}
      </div>
    </div>`;
  const note = status==='run'
      ? `<div id="note-${key}" class="text-xs" style="color:var(--mut);margin:.3rem 0 .6rem"><span class="spin"></span> ${I[S.lang].reading.replace('%s','0')}</div>`
      : '';
  card.innerHTML=head+ note + `<div id="body-${key}" class="text-sm leading-6">${html}</div>`;
  wrap.appendChild(card);
}

/* ===== Orchestrate generation ===== */
async function generateAll(){
  saveStep();
  const p=S.data.profile; if(!(p.name&&p.age&&p.height&&p.weight)){ toast(t('need')); return; }

  $('plan-empty').style.display='none'; $('plan-content').innerHTML='';
  listSections(); buildTimeline();
  $('miniProgress').classList.add('show'); $('liveNotice').classList.add('show');

  const total=S.sectionList.length; let done=0;
  const updateBars=()=>{ const pct=Math.round((done/total)*100); $('mp-bar').style.width=pct+'%'; $('ln-bar').style.width=pct+'%'; $('ln-msg').textContent=I[S.lang].reading.replace('%s',pct); };

  for(const key of S.sectionList){
    setTL(key,'run'); S.statuses[key]='run';
    let sec=key, extra={}; if(key.startsWith('nutrition-day')){sec='nutrition-day'; extra.day=+key.split('-').pop();} if(key.startsWith('training-day')){sec='training-day'; extra.day=+key.split('-').pop();}
    appendCard(key, '', 'run'); // ÙØ§Ø±ØºØ© Ù…Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©

    // 1) ÙƒØ§Ù…Ù„  2) Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø·  3) Ø¬Ø¯ÙˆÙ„ Ù…Ø´Ø¯Ø¯  4) fallback Ù…Ø­Ù„ÙŠ
    let res = await callAI(prompt(sec,extra,'full'),{tries:2,base:900,timeout:60000});
    if(!res.ok) res = await callAI(prompt(sec,extra,'table'),{tries:2,base:1100,timeout:60000});
    if(!res.ok) res = await callAI(prompt(sec,extra,'table')+'\n\nØ£Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ù‹Ø§ Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¬Ø¯ÙˆÙ„.',{tries:1,base:1300,timeout:60000});

    let ok=res.ok, text=res.text;
    if(!ok){ if(sec==='nutrition-day') text=localNutritionSkeleton(extra.day); else if(sec==='training-day') text=localTrainingSkeleton(extra.day); }

    S.results[key]=text||''; S.statuses[key]= ok? 'ok':'fail'; setTL(key,S.statuses[key]);

    const n=$('note-'+key); if(n) n.remove();
    const bodyEl = document.querySelector('#body-' + key);
    if(bodyEl) bodyEl.innerHTML = mdSafe(text||`<div style="color:var(--err)">${I[S.lang].fail}</div>`);
    // Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø°Ø§ ÙØ´Ù„
    if(!ok){
      const headEl=document.querySelector('#sec-'+key+' [data-retry]'); if(headEl){ headEl.disabled=false; }
    } else {
      const btn=document.querySelector('#sec-'+key+' [data-retry]'); if(btn) btn.remove();
    }

    done++; updateBars();
    document.getElementById('sec-'+key).scrollIntoView({behavior:'smooth',block:'center'});
  }
  $('miniProgress').classList.remove('show'); $('liveNotice').classList.remove('show');
}

/* ===== Retry click (fixed) ===== */
document.addEventListener('click', async (e)=>{
  const btn=e.target.closest('[data-retry]'); if(!btn) return;
  const key=btn.getAttribute('data-retry'); btn.disabled=true; btn.textContent='â€¦'; setTL(key,'run');
  const noteId='note-'+key; const note=document.createElement('div'); note.id=noteId; note.className='text-xs'; note.style.color='var(--mut)'; note.style.margin='.3rem 0 .6rem'; note.innerHTML=`<span class="spin"></span> ${I[S.lang].reading.replace('%s','â€¦')}`; document.querySelector('#sec-'+key).insertAdjacentElement('afterbegin',note);
  let sec=key, extra={}; if(key.startsWith('nutrition-day')){sec='nutrition-day'; extra.day=+key.split('-').pop();} if(key.startsWith('training-day')){sec='training-day'; extra.day=+key.split('-').pop();}
  let res = await callAI(prompt(sec,extra,'table'),{tries:3,base:1000,timeout:60000});
  if(!res.ok){ if(sec==='nutrition-day') res={ok:true,text:localNutritionSkeleton(extra.day)}; else if(sec==='training-day') res={ok:true,text:localTrainingSkeleton(extra.day)}; }
  S.results[key]=res.text||''; S.statuses[key]= res.ok? 'ok':'fail'; setTL(key,S.statuses[key]);
  const bodyEl = document.querySelector('#body-' + key);  /* <-- FIXED */
  if(bodyEl) bodyEl.innerHTML = mdSafe(res.text||`<div style="color:var(--err)">${I[S.lang].fail}</div>`);
  const n=document.getElementById(noteId); if(n) n.remove();
  if(res.ok) btn.remove(); else { btn.disabled=false; btn.textContent='â†» '+I[S.lang].retry; }
});

/* ===== Buttons / Toggles ===== */
$('prev').onclick=()=>{ saveStep(); S.step=Math.max(0,S.step-1); renderStep(); };
$('next').onclick=()=>{ saveStep(); S.step=Math.min(3,S.step+1); renderStep(); };
$('generate').onclick=generateAll;

$('btn-top').onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
$('btn-print').onclick=()=>window.print();
$('btn-print2').onclick=()=>window.print();
$('btn-theme').onclick=()=>document.body.classList.toggle('light');
$('btn-mock').onclick=()=>{ S.mock=!S.mock; $('btn-mock').textContent = 'Mock: ' + (S.mock?'ON':'OFF'); toast(S.mock?'ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©':'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©'); };

$('btn-ar').onclick=()=>{ if(S.lang!=='ar'){ S.lang='ar'; applyLang(); renderStep(); } };
$('btn-en').onclick=()=>{ if(S.lang!=='en'){ S.lang='en'; applyLang(); renderStep(); } };

['change','keyup'].forEach(ev=>document.addEventListener(ev,()=>{ try{saveStep();}catch{} },{passive:true}));

/* ===== Init ===== */
window.addEventListener('load', ()=>{
  try{ const v=JSON.parse(localStorage.getItem(saveKey)||'{}'); if(v && v.profile) S.data=v; }catch{}
  applyLang(); renderStep();
});
</script>
</body>
</html>
