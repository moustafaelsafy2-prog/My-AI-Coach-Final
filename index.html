<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light">
  <title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ± â€” Ø®Ø·Ø© Ù…Ø®ØµØµØ© 7 Ø£ÙŠØ§Ù…</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root { --card: 255 255 255; }
    html, body { height: 100%; scroll-behavior: smooth; }
    body { background: linear-gradient(180deg, #f6f7fb 0%, #eef1f7 100%); }
    .font-tajawal { font-family: 'Tajawal', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .font-poppins { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .stage-enter { animation: fadeIn .35s ease-out both; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
    .card { background: rgba(var(--card)/1); }
    .file-drop { border: 2px dashed #d1d5db; transition: all .2s; }
    .file-drop.ready { border-color:#16a34a; background:#f0fdf4; }
    .ai-content h3 { font-size:1.35rem; font-weight:800; color:#4338ca; padding-bottom:.5rem; border-bottom:2px solid #e5e7eb; margin-top:1.5rem; margin-bottom:.75rem; }
    .ai-content table { width:100%; border-collapse:collapse; margin:1.25rem 0; box-shadow:0 2px 8px rgba(0,0,0,.05); border-radius:.5rem; overflow:hidden; }
    .ai-content th,.ai-content td { border:1px solid #e5e7eb; padding:.75rem; vertical-align:top; }
    .ai-content th { background:#f9fafb; font-weight:700; }
    [dir="rtl"] .ai-content th, [dir="rtl"] .ai-content td { text-align:right; }
    [dir="ltr"] .ai-content th, [dir="ltr"] .ai-content td { text-align:left; }
    .ltr-text { direction:ltr; text-align:left; }
    .num-input { direction:ltr; text-align:left; }

    footer.site-footer { background:#0f172a; color:#fff; }
    .watermark { position:fixed; bottom:12px; inset-inline:0; text-align:center; font-size:.75rem; color:#334155; pointer-events:none; }
    @media print {
      body { background:#fff; }
      #app { box-shadow:none; margin:0; max-width:100%; border:none; }
      #topbar, #sticky, #progress-wrap, .no-print, #aside, footer.site-footer { display:none !important; }
      .ai-content table { break-inside:avoid; }
      .ai-content h3 { page-break-after: avoid; }
      body::after {
        content: "Powered by Mustafa Elsafy 2025 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©";
        position: fixed; bottom: 8px; left: 0; right: 0; text-align: center;
        font-size: 12px; color: #64748b; opacity:.9;
      }
    }
  </style>
</head>
<body class="font-tajawal min-h-screen">

  <!-- Container -->
  <div id="app" class="max-w-6xl mx-auto my-4 sm:my-8 card rounded-2xl shadow-2xl overflow-hidden border border-gray-200/60">
    <!-- Topbar -->
    <header id="topbar" class="px-4 sm:px-6 py-4 bg-white border-b">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="size-10 rounded-xl bg-indigo-600 text-white grid place-items-center font-extrabold text-lg">AI</div>
          <div class="leading-tight">
            <h1 class="text-base sm:text-lg font-extrabold text-gray-900">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±</h1>
            <p class="text-xs sm:text-sm text-gray-600">
              <strong>Ù…ØµØ·ÙÙŠ Ø§Ù„ØµØ§ÙÙŠ</strong> â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯
            </p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-ar" class="px-2.5 py-1.5 rounded-lg text-sm font-bold" type="button">Ø¹Ø±Ø¨ÙŠ</button>
          <button id="btn-en" class="px-2.5 py-1.5 rounded-lg text-sm font-bold" type="button">EN</button>
        </div>
      </div>
    </header>

    <!-- Progress -->
    <div id="progress-wrap" class="px-4 sm:px-6 pt-4 hidden">
      <div class="h-2.5 bg-gray-200 rounded-full overflow-hidden" role="progressbar" aria-valuemin="0" aria-valuemax="100">
        <div id="progress" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300" style="width:0%"></div>
      </div>
      <div class="mt-2 text-xs text-gray-500">Ø§Ù„Ø®Ø·ÙˆØ© <span id="step">1</span> Ù…Ù† 12</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12">
      <!-- Main -->
      <main id="content" class="lg:col-span-8 p-5 sm:p-8"></main>

      <!-- Aside: Live Summary -->
      <aside id="aside" class="lg:col-span-4 p-5 sm:p-8 bg-white/60 border-t lg:border-t-0 lg:border-l">
        <h2 class="text-sm font-extrabold text-gray-700 mb-3">Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª</h2>
        <div id="summary" class="text-sm text-gray-700 space-y-2">
          <p class="text-gray-400">Ø§Ø¨Ø¯Ø£ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù„Ø­Ø¸ÙŠâ€¦</p>
        </div>
        <div class="mt-4 flex flex-wrap gap-2">
          <button id="btn-save" class="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-bold" type="button">Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§</button>
          <button id="btn-load" class="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-bold" type="button">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
          <button id="btn-reset" class="px-3 py-1.5 rounded-lg bg-rose-50 hover:bg-rose-100 text-rose-700 text-sm font-bold" type="button">Ù…Ø³Ø­</button>
        </div>
        <p class="mt-3 text-xs text-gray-500">ÙŠØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ. Ù„Ø§ ØªÙØ±Ø³Ù„ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ø®Ø§Ø¯Ù….</p>
      </aside>
    </div>

    <!-- Sticky -->
    <div id="sticky" class="hidden sticky bottom-0 bg-white/85 backdrop-blur-md border-t px-4 sm:px-6 py-3 flex gap-3 justify-between" style="padding-bottom:calc(.75rem + env(safe-area-inset-bottom))">
      <button id="prev" class="w-1/3 sm:w-40 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2.5 rounded-lg disabled:opacity-50" type="button">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button id="next" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-extrabold py-2.5 rounded-lg" type="button">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
  </div>

  <!-- Footer (rights) -->
  <footer class="site-footer mt-8">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4 text-center text-sm">
      <span>Powered by Mustafa Elsafy 2025 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</span>
    </div>
  </footer>
  <div class="watermark no-print">Powered by Mustafa Elsafy 2025 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</div>

  <script>
  /******************** State ********************/
  const totalStages = 12;
  let state = {
    currentStage: 0,
    lang: 'ar',
    userData: {
      goals: [],
      weak_points: {},
      health_conditions: [],
      allergies: [],
      physical_activity_level: 'Sedentary',
      cardio_minutes_per_week: 0,
      has_prescription: false,
      prescription_text: '',
      accuracy_consent: false
    }
  };
  let started = false;

  // client rate limiter
  const rate = { windowMs: 60_000, max: 10, queue: [] };
  const canCall = () => { const n=Date.now(); rate.queue = rate.queue.filter(t=> n - t < rate.windowMs); return rate.queue.length < rate.max; };
  const markCall = () => rate.queue.push(Date.now());

  // elements
  const content = document.getElementById('content');
  const summary = document.getElementById('summary');
  const progressWrap = document.getElementById('progress-wrap');
  const progressBar = document.getElementById('progress');
  const stepEl = document.getElementById('step');
  const sticky = document.getElementById('sticky');
  const btnPrev = document.getElementById('prev');
  const btnNext = document.getElementById('next');

  /*************** Internationalization (i18n) ***************/
  const i18n = {
    ar: {
      start:"Ø§Ø¨Ø¯Ø£", welcome_title:"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­ÙˆÙ„!", welcome_desc:"Ø³Ù†Ù†ØªØ¬ Ø®Ø·Ø© ØªÙ†ÙÙŠØ°ÙŠØ© Ù‚ÙˆÙŠØ© ÙˆÙ…Ø®ØµØµØ© Ù„Ù…Ø¯Ø© 7 Ø£ÙŠØ§Ù….",
      stage_1_title:"Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù…Ù† Ø£Ù†ØªØŸ", stage_1_desc:"Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ.",
      stage_2_title:"Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", stage_2_desc:"Ø§Ù„Ø¹Ù…Ø± ÙˆØ§Ù„Ø·ÙˆÙ„ ÙˆØ§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø¬Ù†Ø³.",
      stage_3_title:"ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù", stage_3_desc:"Ø§Ø®ØªØ± Ø£Ù‡Ø¯Ø§ÙÙƒ.", goal_sub:"ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù‡Ø¯Ù.",
      stage_4_title:"Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©", stage_4_desc:"ÙˆØ²Ù† Ù…Ø³ØªÙ‡Ø¯Ù ÙˆØªØ§Ø±ÙŠØ® Ù…Ù†Ø§Ø³Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ).",
      stage_5_title:"Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ Ø§Ù„Ù…ÙØ¶Ù„", stage_5_desc:"Ù†Ø±Ø´Ø­ Ø§Ù„Ø£ÙØ¶Ù„ ÙˆÙÙ‚ Ø§Ù„Ù‡Ø¯Ù.",
      stage_6_title:"Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©", stage_6_desc:"Ù„Ø®Ø·Ø© Ø¢Ù…Ù†Ø© ØªÙ…Ø§Ù…Ù‹Ø§.",
      stage_7_title:"Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ", stage_7_desc:"Ø§Ù„Ø®Ø¨Ø±Ø© ÙˆØ¢Ø®Ø± Ø§Ù„ØªØ²Ø§Ù… ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª.",
      stage_8_title:"Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØªØ±ÙƒÙŠØ²", stage_8_desc:"Ø­Ø¯Ø¯ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª ÙˆØ£ÙˆØµØ§Ù Ø§Ù„Ù‡Ø¯Ù.",
      stage_9_title:"Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©", stage_9_desc:"Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø© ÙˆØ¥ØµØ§Ø¨Ø§Øª Ø¥Ù† ÙˆØ¬Ø¯Øª.",
      stage_10_title:"Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© + Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ", stage_10_desc:"Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ù†ÙˆÙ… ÙˆØ§Ù„ØªÙˆØªØ± ÙˆÙ…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙØ¹Ù„ÙŠ.",
      stage_11_title:"ØªØ­Ù„ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", stage_11_desc:"ØµÙˆØ±/InBody Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¯Ù‚Ø©.",
      name_q:"Ù…Ø§ Ø§Ø³Ù…ÙƒØŸ", age:"Ø§Ù„Ø¹Ù…Ø±", height:"Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)", weight:"Ø§Ù„ÙˆØ²Ù† (ÙƒØº)", gender:"Ø§Ù„Ø¬Ù†Ø³", male:"Ø°ÙƒØ±", female:"Ø£Ù†Ø«Ù‰",
      goal1:"Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†", goal2:"Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª", goal3:"Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©", goal4:"ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„", goal5:"ØµØ­Ø© Ø¹Ø§Ù…Ø©",
      target_weight:"Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù", target_date:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©",
      diet_pref:"Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ", diet_opt1:"Ù…ØªÙˆØ§Ø²Ù†", diet_opt2:"Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª", diet_opt3:"ØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹", diet_opt4:"ÙƒÙŠØªÙˆ", diet_opt5:"Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·", diet_opt6:"Ù†Ø¨Ø§ØªÙŠ", recommended:"Ù…Ø±Ø´Ø­",
      allergies_q:"Ø­Ø³Ø§Ø³ÙŠØ©/Ø§Ù„ØªÙ‡Ø§Ø¨Ø§ØªØŸ", allergy1:"Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†", allergy2:"Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²", allergy3:"Ø§Ù„Ù…ÙƒØ³Ø±Ø§Øª", allergy4:"Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ©", allergy5:"Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø©", allergy6:"Ø§Ù„Ø²ÙŠÙˆØª Ø§Ù„Ù†Ø¨Ø§ØªÙŠØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©", other_allergies:"Ø­Ø³Ø§Ø³ÙŠØ© Ø£Ø®Ø±Ù‰",
      training_history_q:"ØªØ§Ø±ÙŠØ®Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ", history_last_train:"Ø¢Ø®Ø± Ø§Ù„ØªØ²Ø§Ù…ØŸ", last_train_opt1:"Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±", last_train_opt2:"3-12 Ø´Ù‡Ø±", last_train_opt3:"Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†Ø©",
      history_exp:"Ø®Ø¨Ø±Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©", exp_opt1:"Ù…Ø¨ØªØ¯Ø¦", exp_opt2:"Ù…ØªÙˆØ³Ø·", exp_opt3:"Ù…ØªÙ‚Ø¯Ù…", history_supps:"Ù…ÙƒÙ…Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©", upload_supps:"Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª",
      weak_points_q:"Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØªØ±ÙƒÙŠØ²", weak_points_sub:"Ø§ÙƒØªØ¨ ÙˆØµÙ Ù‡Ø¯Ù Ù„ÙƒÙ„ Ø¹Ø¶Ù„Ø©.",
      health_q:"ØµØ­ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹", health_cond1:"Ø¶ØºØ· Ø§Ù„Ø¯Ù…", health_cond2:"Ø§Ù„Ø³ÙƒØ±ÙŠ", health_cond3:"Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†", health_cond4:"Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©", health_cond5:"Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ", health_cond6:"Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©", health_cond7:"Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù‡Ø¶Ù…ÙŠ", injuries_q:"Ø¥ØµØ§Ø¨Ø§ØªØŸ", injuries_sub:"Ø§Ø°ÙƒØ± Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…ÙƒØ§Ù†",
      lifestyle_q:"Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©", job:"Ø§Ù„Ø¹Ù…Ù„", job_opt1:"Ù…ÙƒØªØ¨ÙŠ", job_opt2:"Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ", job_opt3:"Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·", sleep:"Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù†ÙˆÙ…", stress:"Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙˆØªØ±", stress_opt1:"Ù…Ù†Ø®ÙØ¶", stress_opt2:"Ù…ØªÙˆØ³Ø·", stress_opt3:"Ù…Ø±ØªÙØ¹",
      physical_activity:"Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ", pal_opt1:"Sedentary (Ù‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©)", pal_opt2:"Light", pal_opt3:"Moderate", pal_opt4:"High", pal_opt5:"Athlete",
      cardio_weekly:"Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ÙƒØ§Ø±Ø¯ÙŠÙˆ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ‹Ø§",
      accuracy_consent:"Ø£Ù‚Ø±Ù‘ Ø¨Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©",
      prescription_label:"ÙˆØµÙØ©/ØªÙ‚Ø±ÙŠØ± Ø·Ø¨ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", prescription_hint:"Ø£ÙŠ ØªÙˆØµÙŠØ§Øª Ø£Ùˆ Ù‚ÙŠÙˆØ¯ Ø·Ø¨ÙŠØ© Ù…Ù‡Ù…Ø©",
      files_q:"Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©", photos_up:"ğŸ“· Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ø¬Ø³Ù…", inbody_up:"ğŸ“„ Ø±ÙØ¹ InBody", photos_done:(n)=>`âœ… ${n} ØµÙˆØ±Ø©`, inbody_done:"âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù",
      loading_title:(n)=>`Ø¬Ø§Ù‡Ø² ÙŠØ§ ${n}!`, loading_sub:"Ù†ÙˆÙ„Ø¯ Ø®Ø·Ø© Ù…ÙØµÙ„Ø© Ø§Ù„Ø¢Ù†â€¦",
      print_btn:"Ø·Ø¨Ø§Ø¹Ø© / ØªØ­Ù…ÙŠÙ„", restart_btn:"Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯", next:"Ø§Ù„ØªØ§Ù„ÙŠ", prev:"Ø§Ù„Ø³Ø§Ø¨Ù‚", submit:"Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†!", swap:"ØªØ¨Ø¯ÙŠÙ„", swapping:"Ø¬Ø§Ø±ÙŠâ€¦", error_fill_fields:"Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.",
      chest:"Ø§Ù„ØµØ¯Ø±", back:"Ø§Ù„Ø¸Ù‡Ø±", shoulders:"Ø§Ù„Ø£ÙƒØªØ§Ù", biceps:"Ø§Ù„Ø¨Ø§ÙŠØ³Ø¨Ø³", triceps:"Ø§Ù„ØªØ±Ø§ÙŠØ³Ø¨Ø³", quads:"Ø§Ù„ÙØ®Ø° Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ", hamstrings:"Ø§Ù„ÙØ®Ø° Ø§Ù„Ø®Ù„ÙÙŠ", glutes:"Ø§Ù„Ø£Ù„ÙˆÙŠØ©", calves:"Ø§Ù„Ø³Ù…Ø§Ù†Ø©", abs:"Ø§Ù„Ø¨Ø·Ù†",
      export:"ØªØµØ¯ÙŠØ±", export_json:"JSON", export_csv:"CSV", days_check:"ÙØ­Øµ Ø§Ù„Ø£ÙŠØ§Ù…", nutrition:"Ø§Ù„ØªØºØ°ÙŠØ© (7 Ø£ÙŠØ§Ù…)", training:"Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)", daily_targets:"Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ÙŠÙˆÙ…ÙŠØ©",
      api_key_error:"ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„. ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ø£Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­."
    },
    en: {
      start:"Start", welcome_title:"Welcome to your transformation journey!", welcome_desc:"We will generate a powerful, fully tailored 7-day plan.",
      stage_1_title:"Step 1: Who are you?", stage_1_desc:"Type your name.",
      stage_2_title:"Core data", stage_2_desc:"Age, height, weight, and gender.",
      stage_3_title:"Set your goals", stage_3_desc:"Select your goals.", goal_sub:"You can select more than one.",
      stage_4_title:"Advanced targets", stage_4_desc:"Target weight and date (optional).",
      stage_5_title:"Preferred diet", stage_5_desc:"Weâ€™ll recommend what best fits your goal.",
      stage_6_title:"Food allergies", stage_6_desc:"To keep the plan 100% safe.",
      stage_7_title:"Training history", stage_7_desc:"Experience, last consistent phase, supplements.",
      stage_8_title:"Focus areas", stage_8_desc:"Pick muscles and set a target description.",
      stage_9_title:"Health status", stage_9_desc:"Chronic conditions and injuries if any.",
      stage_10_title:"Lifestyle + Physical activity", stage_10_desc:"Work, sleep, stress, and real activity level.",
      stage_11_title:"Optional analysis", stage_11_desc:"Photos/InBody for higher accuracy.",
      name_q:"Your name?", age:"Age", height:"Height (cm)", weight:"Weight (kg)", gender:"Gender", male:"Male", female:"Female",
      goal1:"Fat loss", goal2:"Muscle gain", goal3:"Strength", goal4:"Endurance", goal5:"General health",
      target_weight:"Target weight", target_date:"Target date",
      diet_pref:"Diet preference", diet_opt1:"Balanced", diet_opt2:"Low-carb", diet_opt3:"Intermittent fasting", diet_opt4:"Keto", diet_opt5:"Mediterranean", diet_opt6:"Plant-based", recommended:"Recommended",
      allergies_q:"Allergies / intolerances?", allergy1:"Gluten", allergy2:"Lactose", allergy3:"Nuts", allergy4:"Seafood", allergy5:"Refined sugars", allergy6:"Refined seed oils", other_allergies:"Other allergy",
      training_history_q:"Training history", history_last_train:"Last consistent phase?", last_train_opt1:"Within last 3 months", last_train_opt2:"3â€“12 months ago", last_train_opt3:"More than 1 year",
      history_exp:"Resistance-training experience", exp_opt1:"Beginner", exp_opt2:"Intermediate", exp_opt3:"Advanced", history_supps:"Supplements used before", upload_supps:"Upload supplements photos",
      weak_points_q:"Focus areas", weak_points_sub:"Write a short target for each muscle.",
      health_q:"Health first", health_cond1:"Blood pressure", health_cond2:"Diabetes", health_cond3:"Insulin resistance", health_cond4:"Thyroid", health_cond5:"Fatty liver", health_cond6:"Hormonal", health_cond7:"GI disorders", injuries_q:"Injuries?", injuries_sub:"Describe location & details",
      lifestyle_q:"Lifestyle", job:"Work", job_opt1:"Desk job", job_opt2:"Light activity", job_opt3:"Moderate activity", sleep:"Night sleep (hrs)", stress:"Stress level", stress_opt1:"Low", stress_opt2:"Medium", stress_opt3:"High",
      physical_activity:"Physical activity level", pal_opt1:"Sedentary (very low)", pal_opt2:"Light", pal_opt3:"Moderate", pal_opt4:"High", pal_opt5:"Athlete",
      cardio_weekly:"Cardio minutes / week",
      accuracy_consent:"I confirm my data is accurate to ensure precise results",
      prescription_label:"Medical note / prescription (optional)", prescription_hint:"Any medical recommendations or constraints",
      files_q:"Optional uploads", photos_up:"ğŸ“· Upload body photos", inbody_up:"ğŸ“„ Upload InBody", photos_done:(n)=>`âœ… ${n} photo(s)`, inbody_done:"âœ… File selected",
      loading_title:(n)=>`One moment, ${n}â€¦`, loading_sub:"Generating your detailed planâ€¦",
      print_btn:"Print / Download", restart_btn:"Start over", next:"Next", prev:"Back", submit:"Generate my plan", swap:"Swap", swapping:"Swappingâ€¦", error_fill_fields:"Please complete the required fields.",
      chest:"Chest", back:"Back", shoulders:"Shoulders", biceps:"Biceps", triceps:"Triceps", quads:"Quads", hamstrings:"Hamstrings", glutes:"Glutes", calves:"Calves", abs:"Abs",
      export:"Export", export_json:"JSON", export_csv:"CSV", days_check:"Days covered", nutrition:"Nutrition (7 days)", training:"Training (7 days)", daily_targets:"Daily targets",
      api_key_error:"Could not reach the model. Check the function or API key."
    }
  };
  const muscles = ['chest','back','shoulders','biceps','triceps','quads','hamstrings','glutes','calves','abs'];

  /******************** Utils ********************/
  function T(key,...a){ const t=i18n[state.lang]?.[key]; return typeof t==='function'?t(...a):(t||key); }
  function $(q){ return document.querySelector(q); }
  function field(label,id,opts={}){ const {type='text',value='',required=false,select=null,placeholder='',num=false,checked=false}=opts;
    if(select){ return `<label class="block"><span class="font-medium text-gray-800">${label}</span><select id="${id}" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">${select.map(o=>`<option ${String(value)===String(o.value)?'selected':''} value="${o.value}">${o.label}</option>`).join('')}</select></label>`; }
    if(type==='textarea'){ return `<label class="block"><span class="font-medium text-gray-800">${label}</span><textarea id="${id}" rows="3" placeholder="${placeholder}" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">${value||''}</textarea></label>`; }
    if(type==='checkbox'){ return `<label class="flex items-start gap-2 p-3 rounded-lg border cursor-pointer"><input id="${id}" type="checkbox" ${checked?'checked':''} class="mt-1 accent-indigo-600"><span class="text-sm text-gray-800">${label}</span></label>`; }
    return `<label class="block"><span class="font-medium text-gray-800">${label}</span><input id="${id}" type="${type}" ${required?'required':''} value="${value}" placeholder="${placeholder}" ${num?'inputmode="numeric" pattern="[0-9]*"':''} class="${num?'num-input ':''}mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></label>`;
  }
  function stageLayout(title,desc,inner){ return `<section class="stage-enter" aria-live="polite"><h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900">${title}</h2><p class="mt-1 text-gray-600">${desc||''}</p><form id="form" class="space-y-5 mt-6" onsubmit="event.preventDefault();">${inner}</form></section>`; }
  function applyLocale(){ const html=document.documentElement; html.lang=state.lang; html.dir=state.lang==='ar'?'rtl':'ltr';
    document.body.classList.toggle('font-tajawal', state.lang==='ar'); document.body.classList.toggle('font-poppins', state.lang!=='ar');
    $('#btn-ar').className=`px-2.5 py-1.5 rounded-lg text-sm font-bold ${state.lang==='ar'?'bg-indigo-600 text-white':'bg-gray-100 text-gray-700'}`;
    $('#btn-en').className=`px-2.5 py-1.5 rounded-lg text-sm font-bold ${state.lang==='en'?'bg-indigo-600 text-white':'bg-gray-100 text-gray-700'}`;
    if(started){ btnPrev.textContent=T('prev'); btnNext.textContent=state.currentStage===totalStages?T('submit'):T('next'); }
    renderSummary();
  }
  function updateProgress(){ const p=Math.max(0,((state.currentStage-1)/totalStages)*100); progressBar.style.width=`${p}%`; stepEl.textContent=String(Math.min(state.currentStage,totalStages)); progressWrap.classList.toggle('hidden',!started || state.currentStage===0 || state.currentStage>totalStages); }

  /******************** Stages ********************/
  function renderStage(stage){
    applyLocale(); updateProgress();
    content.innerHTML = '<div class="py-14 grid place-items-center"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500" aria-hidden="true"></div></div>';
    setTimeout(()=>{ const s=state.userData; let title='',desc='',html='';
      switch(stage){
        case 0:
          content.innerHTML = `<section class="stage-enter text-center p-6 sm:p-10"><h2 class="text-3xl font-extrabold text-gray-900 mb-2">${T('welcome_title')}</h2><p class="text-gray-600 max-w-xl mx-auto">${T('welcome_desc')}</p><div class="mt-8"><div class="inline-flex gap-2 items-center"><select id="lang-select" class="p-3 rounded-lg border-gray-300 border"><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option></select><button id="start" class="bg-indigo-600 hover:bg-indigo-700 text-white font-extrabold px-8 py-3 rounded-xl" type="button">${T('start')}</button></div></div></section>`;
          document.getElementById('start').onclick=()=>{ state.lang=document.getElementById('lang-select').value; started=true; sticky.classList.remove('hidden'); btnPrev.disabled=true; state.currentStage=1; renderStage(1); };
          break;
        case 1: title=T('stage_1_title'); desc=T('stage_1_desc'); html=field(T('name_q'),'name',{required:true,value:s.name||''}); content.innerHTML=stageLayout(title,desc,html); document.getElementById('name').focus(); break;
        case 2: title=T('stage_2_title'); desc=T('stage_2_desc'); html=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${field(T('age'),'age',{type:'number',value:s.age||'',required:true,num:true})}${field(T('height'),'height',{type:'number',value:s.height||'',required:true,num:true})}${field(T('weight'),'weight',{type:'number',value:s.weight||'',required:true,num:true})}${field(T('gender'),'gender',{select:[{value:'Male',label:T('male')},{value:'Female',label:T('female')}],value:s.gender||'Male'})}</div>`; content.innerHTML=stageLayout(title,desc,html); break;
        case 3: title=T('stage_3_title'); desc=T('stage_3_desc'); const goals=['goal1','goal2','goal3','goal4','goal5']; html=`<p class="text-sm text-gray-500">${T('goal_sub')}</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">${goals.map(k=>{ const v=T(k); const on=(s.goals||[]).includes(v)?'checked':''; return `<label class="block p-4 rounded-lg border cursor-pointer"><input ${on} type="checkbox" name="goal" value="${v}" class="mr-4 ml-2 accent-indigo-600"><span>${v}</span></label>`}).join('')}</div>`; content.innerHTML=stageLayout(title,desc,html); break;
        case 4: title=T('stage_4_title'); desc=T('stage_4_desc'); html=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${field(T('target_weight'),'target_weight',{type:'number',value:s.target_weight||'',num:true})}${field(T('target_date'),'target_date',{type:'date',value:s.target_date||''})}</div>`; content.innerHTML=stageLayout(title,desc,html); break;
        case 5: title=T('stage_5_title'); desc=T('stage_5_desc'); let rec=T('diet_opt1'); if((s.goals||[]).includes(T('goal1'))) rec=T('diet_opt2'); const dietKeys=['diet_opt1','diet_opt2','diet_opt3','diet_opt4','diet_opt5','diet_opt6']; html=`${field(T('diet_pref'),'diet_preference',{select:dietKeys.map(k=>({value:T(k),label:`${T(k)}${rec===T(k)?` (${T('recommended')})`:''}`})),value:s.diet_preference||T('diet_opt1')})}`; content.innerHTML=stageLayout(title,desc,html); break;
        case 6: title=T('stage_6_title'); desc=T('stage_6_desc'); const allergyVals=[T('allergy1'),T('allergy2'),T('allergy3'),T('allergy4'),T('allergy5'),T('allergy6')]; html=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${allergyVals.map(v=>{ const on=(s.allergies||[]).includes(v)?'checked':''; return `<label class="block p-3 rounded-lg border cursor-pointer"><input ${on} type="checkbox" name="allergy" value="${v}" class="mr-4 ml-2 accent-indigo-600"><span>${v}</span></label>`}).join('')}</div>${field(T('other_allergies'),'other_allergies',{value:s.other_allergies||''})}`; content.innerHTML=stageLayout(title,desc,html); break;
        case 7: title=T('stage_7_title'); desc=T('stage_7_desc'); html=`${field(T('history_last_train'),'last_train',{select:[{value:T('last_train_opt1'),label:T('last_train_opt1')},{value:T('last_train_opt2'),label:T('last_train_opt2')},{value:T('last_train_opt3'),label:T('last_train_opt3')}],value:s.last_train||T('last_train_opt1')})}${field(T('history_exp'),'training_exp',{select:[{value:T('exp_opt1'),label:T('exp_opt1')},{value:T('exp_opt2'),label:T('exp_opt2')},{value:T('exp_opt3'),label:T('exp_opt3')}],value:s.training_exp||T('exp_opt1')})}${field(T('history_supps'),'prev_supps',{value:s.prev_supps||'',placeholder:'Omega-3, Vitamin D ...'})}<label class="file-drop p-3 mt-2 block text-center rounded-lg cursor-pointer text-sm"><span id="supp-feedback">${T('upload_supps')}</span><input type="file" id="supp_photos" class="hidden" multiple accept="image/*"></label>`; content.innerHTML=stageLayout(title,desc,html); attachFileListeners(); break;
        case 8: title=T('stage_8_title'); desc=T('stage_8_desc'); html=`<div class="space-y-4">${muscles.map(m=>`<div class="relative flex items-start"><div class="flex items-center h-5"><input id="${m}" name="${m}" type="checkbox" ${(s.weak_points||{})[m]?'checked':''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"></div><div class="ml-3 mr-3 text-sm flex-1"><label for="${m}" class="font-medium text-gray-700">${T(m)}</label><input type="text" id="${m}_desc" class="w-full p-1 border-b-2 focus:border-indigo-500 outline-none" value="${(s.weak_points||{})[m]||''}" placeholder="${T('weak_points_sub')}"></div></div>`).join('')}</div>`; content.innerHTML=stageLayout(title,desc,html); break;
        case 9: title=T('stage_9_title'); desc=T('stage_9_desc'); const cond=['health_cond1','health_cond2','health_cond3','health_cond4','health_cond5','health_cond6','health_cond7']; html=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${cond.map(k=>{ const v=T(k); const on=(s.health_conditions||[]).includes(v)?'checked':''; return `<label class="block p-3 rounded-lg border cursor-pointer"><input ${on} type="checkbox" name="health_condition" value="${v}" class="mr-4 ml-2 accent-indigo-600"><span>${v}</span></label>`}).join('')}</div>${field(T('injuries_q'),'injuries',{type:'textarea',value:s.injuries||'',placeholder:T('injuries_sub')})}${field(T('prescription_label'),'prescription_text',{type:'textarea',value:s.prescription_text||'',placeholder:T('prescription_hint')})}`; content.innerHTML=stageLayout(title,desc,html); break;
        case 10:
          title=T('stage_10_title'); desc=T('stage_10_desc');
          html = `<div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            ${field(T('job'),'job_activity',{select:[{value:T('job_opt1'),label:T('job_opt1')},{value:T('job_opt2'),label:T('job_opt2')},{value:T('job_opt3'),label:T('job_opt3')}],value:s.job_activity||T('job_opt1')})}
            ${field(T('sleep'),'sleep_hours',{type:'number',value:s.sleep_hours||'',required:true,num:true})}
            ${field(T('stress'),'stress_level',{select:[{value:T('stress_opt1'),label:T('stress_opt1')},{value:T('stress_opt2'),label:T('stress_opt2')},{value:T('stress_opt3'),label:T('stress_opt3')}],value:s.stress_level||T('stress_opt2')})}
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            ${field(T('physical_activity'),'physical_activity_level',{select:[
              {value:'Sedentary',label:T('pal_opt1')},
              {value:'Light',label:T('pal_opt2')},
              {value:'Moderate',label:T('pal_opt3')},
              {value:'High',label:T('pal_opt4')},
              {value:'Athlete',label:T('pal_opt5')}
            ], value:s.physical_activity_level||'Sedentary'})}
            ${field(T('cardio_weekly'),'cardio_minutes_per_week',{type:'number',value:s.cardio_minutes_per_week||0,num:true,placeholder:'0-600'})}
          </div>
          ${field(T('accuracy_consent'),'accuracy_consent',{type:'checkbox',checked:!!s.accuracy_consent})}`;
          content.innerHTML=stageLayout(title,desc,html);
          break;
        case 11:
          title=T('stage_11_title'); desc=T('stage_11_desc');
          html=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><label class="file-drop p-6 block text-center rounded-xl cursor-pointer"><span id="photo-feedback">${T('photos_up')}</span><input type="file" id="photos" class="hidden" multiple accept="image/*"></label><label class="file-drop p-6 block text-center rounded-xl cursor-pointer"><span id="inbody-feedback">${T('inbody_up')}</span><input type="file" id="inbody" class="hidden" accept="image/*,.pdf"></label></div>`;
          content.innerHTML=stageLayout(title,desc,html); attachFileListeners(); break;
        case 12:
          content.innerHTML = `<section class="stage-enter p-5 sm:p-8"><div class="no-print text-center"><h2 class="text-2xl font-extrabold text-gray-900 mb-1">${T('loading_title', s.name || '')}</h2><p class="text-gray-600">${T('loading_sub')}</p><div class="mt-6 animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600 mx-auto" aria-hidden="true"></div></div><div id="plan" class="mt-6 ai-content" dir="${state.lang==='ar'?'rtl':'ltr'}"></div><div id="qc" class="mt-3 text-xs text-gray-500"></div><div class="no-print mt-6 flex flex-wrap gap-3 justify-center"><button id="btn-print" class="hidden bg-green-600 hover:bg-green-700 text-white font-extrabold px-6 py-2.5 rounded-lg" type="button">${T('print_btn')}</button><div class="hidden" id="export-wrap"><span class="px-3 py-2 bg-gray-100 rounded-lg text-sm font-medium">${T('export')}:</span><button id="exp-json" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold px-3 py-2 rounded-lg" type="button">${T('export_json')}</button><button id="exp-csv" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold px-3 py-2 rounded-lg" type="button">${T('export_csv')}</button></div><button id="btn-restart" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-800 font-extrabold px-6 py-2.5 rounded-lg" type="button">${T('restart_btn')}</button></div></section>`;
          generatePlan(); break;
      }
      if(started){ btnNext.textContent=state.currentStage===totalStages?T('submit'):T('next'); btnNext.className=`flex-1 ${state.currentStage===totalStages?'bg-green-600 hover:bg-green-700':'bg-indigo-600 hover:bg-indigo-700'} text-white font-extrabold py-2.5 rounded-lg`; btnPrev.textContent=T('prev'); btnPrev.disabled=state.currentStage<=1; }
    },150);
  }

  /******************** Navigation & Save ********************/
  function saveAndNext(stage){
    try{
      const s = state.userData;
      switch(stage){
        case 1: s.name=document.getElementById('name').value.trim(); if(!s.name) throw 0; break;
        case 2: s.age=document.getElementById('age').value; s.height=document.getElementById('height').value; s.weight=document.getElementById('weight').value; s.gender=document.getElementById('gender').value; if(!s.age||!s.height||!s.weight) throw 0; break;
        case 3: s.goals=[...document.querySelectorAll('input[name="goal"]:checked')].map(e=>e.value); if(!s.goals.length) throw 0; break;
        case 4: s.target_weight=document.getElementById('target_weight').value; s.target_date=document.getElementById('target_date').value; break;
        case 5: s.diet_preference=document.getElementById('diet_preference').value; break;
        case 6: s.allergies=[...document.querySelectorAll('input[name="allergy"]:checked')].map(e=>e.value); { const other=document.getElementById('other_allergies').value.trim(); if(other) s.allergies.push(other); } break;
        case 7: s.last_train=document.getElementById('last_train').value; s.training_exp=document.getElementById('training_exp').value; s.prev_supps=document.getElementById('prev_supps').value; s.has_supp_photos=document.getElementById('supp_photos')?.files.length>0; break;
        case 8: s.weak_points={}; muscles.forEach(m=>{ const cb=document.getElementById(m); if(cb?.checked) s.weak_points[m]=document.getElementById(`${m}_desc`).value||'General'; }); break;
        case 9: s.health_conditions=[...document.querySelectorAll('input[name="health_condition"]:checked')].map(e=>e.value); s.injuries=document.getElementById('injuries').value; s.prescription_text=document.getElementById('prescription_text')?.value||''; break;
        case 10:
          s.job_activity=document.getElementById('job_activity')?.value||document.getElementById('job_activity')?.textContent;
          s.sleep_hours=document.getElementById('sleep_hours').value;
          s.stress_level=document.getElementById('stress_level').value;
          s.physical_activity_level=document.getElementById('physical_activity_level').value;
          s.cardio_minutes_per_week=Number(document.getElementById('cardio_minutes_per_week').value||0);
          s.accuracy_consent=document.getElementById('accuracy_consent')?.checked||false;
          if(!s.sleep_hours || !s.accuracy_consent) throw 0;
          break;
        case 11: s.has_photos=document.getElementById('photos')?.files.length>0; s.has_inbody=document.getElementById('inbody')?.files.length>0; break;
      }
      state.currentStage++; renderStage(state.currentStage); renderSummary();
    }catch{ notify(T('error_fill_fields'), 'error'); }
  }
  function goBack(){ if(state.currentStage>1){ state.currentStage--; renderStage(state.currentStage); renderSummary(); } }
  btnPrev.onclick = goBack;
  btnNext.onclick = () => saveAndNext(state.currentStage);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey && started){ e.preventDefault(); saveAndNext(state.currentStage); } });

  // Local storage helpers
  function saveLocal(){ localStorage.setItem('aiCoachState', JSON.stringify(state)); notify('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§'); }
  function loadLocal(){ const raw=localStorage.getItem('aiCoachState'); if(!raw) return notify('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©','warning'); try{ const st=JSON.parse(raw); state=st; started=state.currentStage>0; sticky.classList.toggle('hidden',!started); renderStage(state.currentStage); renderSummary(); notify('ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹'); }catch{ notify('ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹','error'); } }
  function resetLocal(){ localStorage.removeItem('aiCoachState'); notify('ØªÙ… Ø§Ù„Ù…Ø³Ø­'); }
  document.getElementById('btn-save').onclick = saveLocal;
  document.getElementById('btn-load').onclick = loadLocal;
  document.getElementById('btn-reset').onclick = resetLocal;

  /******************** Files ********************/
  function attachFileListeners(){
    const p=document.getElementById('photos'); if(p) p.addEventListener('change', e=>{ document.getElementById('photo-feedback').textContent = i18n[state.lang].photos_done(e.target.files.length); p.parentElement.classList.add('ready'); });
    const i=document.getElementById('inbody'); if(i) i.addEventListener('change', ()=>{ document.getElementById('inbody-feedback').textContent=T('inbody_done'); i.parentElement.classList.add('ready'); });
    const s=document.getElementById('supp_photos'); if(s) s.addEventListener('change', e=>{ document.getElementById('supp-feedback').textContent = i18n[state.lang].photos_done(e.target.files.length); s.parentElement.classList.add('ready'); });
  }

  /******************** Calculations (with activity) ********************/
  function activityFactor(level){
    switch(level){
      case 'Light': return 1.35;
      case 'Moderate': return 1.5;
      case 'High': return 1.7;
      case 'Athlete': return 1.9;
      default: return 1.2;
    }
  }
  function cardioExtra(minutes){
    const kcalWeek = Math.max(0, Number(minutes||0)) * 6; // ~6 kcal/min
    return kcalWeek / 7;
    }
  function computeTargets(p){
    const W=Number(p.weight)||0, H=Number(p.height)||0, A=Number(p.age)||0;
    const male=p.gender==='Male';
    const BMR = male ? 10*W + 6.25*H - 5*A + 5 : 10*W + 6.25*H - 5*A - 161;
    const pal = activityFactor(p.physical_activity_level || 'Sedentary');
    let TDEE = BMR * pal + cardioExtra(p.cardio_minutes_per_week);
    const goals=p.goals||[]; if(goals.includes(T('goal1'))) TDEE*=0.86; else if(goals.includes(T('goal2'))) TDEE*=1.1;
    const targetW=Number(p.target_weight)||W||1;
    const protein_g=Math.round(2.0*targetW);
    const fat_g=Math.round(Math.max(0,0.8*W));
    let carb_g=Math.round((TDEE - (protein_g*4 + fat_g*9))/4);
    const hasIR=(p.health_conditions||[]).some(h=>[T('health_cond2'),T('health_cond3')].includes(h));
    if(hasIR) carb_g=Math.min(carb_g,120);
    carb_g=Math.max(0,carb_g);
    return { calories: Math.round(TDEE), macros:{ protein_g, fat_g, carb_g } }
  }

  /******************** Prompt â€” EXEC GRADE ********************/
  function buildAIPrompt(profile, lang, targets) {
    const weak = Object.entries(profile.weak_points || {})
      .map(([muscle, desc]) => `${T(muscle)}: ${desc}`).join(', ') || 'None';

    const CONTRACT = `
- Ø§Ù„Ù„ØºØ©: ${lang} ÙÙ‚Ø·. Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø·.
- Ø§Ù„Ø­Ø¬Ù…: 1800â€“2600 ÙƒÙ„Ù…Ø©. 7/7 ØªØºØ°ÙŠØ© + 7/7 ØªØ¯Ø±ÙŠØ¨ Ø¨Ù„Ø§ Ù†Ù‚Øµ.
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø£Ø¯Ù†Ø§Ù‡ Ø­Ø±ÙÙŠÙ‹Ø§.
- ÙØ¹Ù‘Ù„ [SWAP:MEAL:Ø§Ø³Ù…] Ùˆ [SWAP:EXERCISE:Exercise] Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„.
- Ø¯Ù…Ø¬ "Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ" (PAL + Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ÙƒØ§Ø±Ø¯ÙŠÙˆ) ÙÙŠ Ø§Ù„ØªÙˆØµÙŠØ§Øª.
- ØªØ¬Ù†Ø¨ Ù…Ø§ ÙŠØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª (${profile.injuries || 'None'}) ÙˆØ§Ù„Ø­Ø³Ø§Ø³ÙŠØ§Øª (${(profile.allergies||[]).join(', ')||'None'}).
- Ù„Ø§ Ù†ØµØ§Ø¦Ø­ Ø·Ø¨ÙŠØ© ØªØ´Ø®ÙŠØµÙŠØ©Ø› ØªÙˆØµÙŠØ§Øª Ø¹Ø§Ù…Ø© ÙˆØ¢Ù…Ù†Ø©.
- Ø£Ø¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨: "Ù…ØµØ·ÙÙŠ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯".
- Ø³Ø·Ø± Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø®ØªØ§Ù…ÙŠ: "Powered by Mustafa Elsafy 2025 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©".

## (1) Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
| Target | Calories | Protein_g | Carbs_g | Fat_g |
|---|---:|---:|---:|---:|
| Daily | ${targets.calories} | ${targets.macros.protein_g} | ${targets.macros.carb_g} | ${targets.macros.fat_g} |

## (2) Ø®Ø·Ø© Ø§Ù„ØªØºØ°ÙŠØ© â€” 7 Ø£ÙŠØ§Ù…
| Ø§Ù„ÙŠÙˆÙ… | Ø§Ù„ÙˆØ¬Ø¨Ø© | Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª | Ø§Ù„Ø³Ø¹Ø±Ø§Øª | Ø¨Ø±ÙˆØªÙŠÙ†_g | ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª_g | Ø¯Ù‡ÙˆÙ†_g |
|---|---|---|---:|---:|---:|---:|
| Ø§Ù„ÙŠÙˆÙ… 1 | Ø§Ù„Ø¥ÙØ·Ø§Ø± | â€¦ [SWAP:MEAL:Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ø¨Ø©] | â€¦ | â€¦ | â€¦ | â€¦ |

## (3) Ø®Ø·Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ â€” 7 Ø£ÙŠØ§Ù… + Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ
| Ø§Ù„ÙŠÙˆÙ… | Exercise | Sets | Reps | Rest_s | Tempo | RPE |
|---|---|---:|---:|---:|---|---:|
| Ø§Ù„ÙŠÙˆÙ… 1 | Bench Press [SWAP:EXERCISE:Bench Press] | 4 | 8-12 | 90 | 2-0-2 | 7 |
> Ù„ÙƒÙ„ ÙŠÙˆÙ…: Ø£Ø¶Ù ØªÙˆØµÙŠØ© ÙƒØ§Ø±Ø¯ÙŠÙˆ/Ø®Ø·ÙˆØ§Øª Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ PAL ÙˆØ¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ÙƒØ§Ø±Ø¯ÙŠÙˆ.

## (4) Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
| Ø§Ù„ØµÙ†Ù | Ø§Ù„ÙƒÙ…ÙŠØ© | Ø§Ù„ÙˆØ­Ø¯Ø© | Ù…Ù„Ø§Ø­Ø¸Ø§Øª |
|---|---:|---|---|

## (5) Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ´ÙØ§Ø¡/Ø§Ù„Ù†ÙˆÙ…/Ø§Ù„Ù…Ø§Ø¡
| Ø§Ù„ÙŠÙˆÙ… | Ù…Ø§Ø¡_Ù„ØªØ± | Ø®Ø·ÙˆØ§Øª | Ù†ÙˆÙ…_Ø³Ø§Ø¹Ø§Øª | ØªÙ†ÙØ³_Ø¯Ù‚Ø§Ø¦Ù‚ | Ù…Ù„Ø§Ø­Ø¸Ø§Øª |
|---|---:|---:|---:|---:|---|

## (6) Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
| Ø£Ø³Ø¨ÙˆØ¹ | Ù‚ÙŠØ§Ø³_ÙˆØ²Ù† | Ù…Ø­ÙŠØ·_Ø®ØµØ± | Ù…Ù„Ø§Ø­Ø¸Ø© | ØªØ¹Ø¯ÙŠÙ„_Ø³Ø¹Ø±Ø§Øª/Ø£Ø­Ù…Ø§Ù„ |
|---:|---:|---:|---|---|

## (7) Ù…ÙƒÙ…Ù„Ø§Øª Ø¢Ù…Ù†Ø©
| Ø§Ù„Ù…ÙƒÙ…Ù„ | Ø§Ù„Ø¬Ø±Ø¹Ø© | Ø§Ù„ØªÙˆÙ‚ÙŠØª | Ø§Ù„Ù…Ø¯Ø© | Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ù…Ø§Ù† |
|---|---|---|---|---|
`;

    return `
Act as "Coach Mustafa Al-Safi", elite nutrition & strength coach (Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯).
Produce a publication-grade, fully tailored plan for "${profile.name}".

${CONTRACT}

## Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
- Ø§Ù„Ø£Ù‡Ø¯Ø§Ù: ${(profile.goals||[]).join(', ')}
- Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…: ÙˆØ²Ù† ${profile.target_weight || 'N/A'} Ø¨Ø­Ù„ÙˆÙ„ ${profile.target_date || 'N/A'}
- Ø§Ù„Ø®Ø¨Ø±Ø©: ${profile.training_exp}; Ø¢Ø®Ø± ØªØ¯Ø±ÙŠØ¨: ${profile.last_train}
- Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØªØ±ÙƒÙŠØ²: ${weak}
- Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª: Ø¹Ù…Ø± ${profile.age}, Ø·ÙˆÙ„ ${profile.height}cm, ÙˆØ²Ù† ${profile.weight}kg, Ø¬Ù†Ø³ ${profile.gender}
- Ø§Ù„ØµØ­Ø©: ${(profile.health_conditions||[]).join(', ')||'None'}Ø› Ø¥ØµØ§Ø¨Ø§Øª: ${profile.injuries||'None'}
- Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©: ${(profile.allergies||[]).join(', ')||'None'}
- Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ: ${profile.diet_preference}
- Ø§Ù„Ù†Ø´Ø§Ø· (PAL): ${profile.physical_activity_level}; ÙƒØ§Ø±Ø¯ÙŠÙˆ/Ø£Ø³Ø¨ÙˆØ¹: ${profile.cardio_minutes_per_week} Ø¯Ù‚ÙŠÙ‚Ø©
- ÙˆØµÙØ© Ø·Ø¨ÙŠØ©: ${profile.prescription_text ? profile.prescription_text : 'â€”'}
- Ø£Ù‡Ø¯Ø§Ù ÙŠÙˆÙ…ÙŠØ©: P ${targets.macros.protein_g}g / C ${targets.macros.carb_g}g / F ${targets.macros.fat_g}g (~${targets.calories} kcal)

### Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
1) Ù…Ù‚Ø¯Ù…Ø© ØªØ­Ù„ÙŠÙ„ÙŠØ© Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø±Ø¨
2) Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø§Ù„Ø¬Ø¯ÙˆÙ„ 1)
3) Ø®Ø·Ø© Ø§Ù„ØªØºØ°ÙŠØ© 7 Ø£ÙŠØ§Ù… (Ø§Ù„Ø¬Ø¯ÙˆÙ„ 2) + Ø¨Ø¯Ø§Ø¦Ù„
4) Ø®Ø·Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ 7 Ø£ÙŠØ§Ù… (Ø§Ù„Ø¬Ø¯ÙˆÙ„ 3) + Warm-up/Cool-down + Ù†Ø´Ø§Ø· ÙØ¹Ù„ÙŠ
5) Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ø§Ù„Ø¬Ø¯ÙˆÙ„ 4)
6) Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ´ÙØ§Ø¡/Ø§Ù„Ù†ÙˆÙ…/Ø§Ù„Ù…Ø§Ø¡ (Ø§Ù„Ø¬Ø¯ÙˆÙ„ 5)
7) Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù… (Ø§Ù„Ø¬Ø¯ÙˆÙ„ 6)
8) Ù…ÙƒÙ…Ù„Ø§Øª Ø¢Ù…Ù†Ø© (Ø§Ù„Ø¬Ø¯ÙˆÙ„ 7)
9) Ø£Ø³Ø¦Ù„Ø©/Ø£Ø®Ø·Ø§Ø¡ Ø´Ø§Ø¦Ø¹Ø©
10) ØªÙˆÙ‚ÙŠØ¹: **Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù…ØµØ·ÙÙ‰ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯**
11) **Powered by Mustafa Elsafy 2025 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©**
`;
  }

  /******************** AI Calls & Validation ********************/
  async function callAI(prompt, url){
    if(!canCall()) return { ok:false, error:'Rate limited' };
    try{
      markCall();
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt }) });
      const text = await res.text();
      let data=null; try{ data = text? JSON.parse(text):null; }catch{}
      if(!res.ok){ return { ok:false, error: data?.error || text || 'Server error' }; }
      return { ok:true, text: data?.text || '' };
    } catch(e){ return { ok:false, error:String(e) }; }
  }

  function wordCount(md){ return (md||'').replace(/[#>`*_|\-\n]/g,' ').split(/\s+/).filter(Boolean).length; }
  function daysMissing(md){ const d=[1,2,3,4,5,6,7]; return d.filter(x=>!new RegExp(`(Day\\s*${x}|Ø§Ù„ÙŠÙˆÙ…\\s*${x})`,'i').test(md)); }
  function hasTable(md, title, cols){
    const hasTitle = new RegExp(title,'i').test(md);
    const colsRe = new RegExp(`\\|\\s*${cols.map(c=>c.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('\\s*\\|\\s*')}\\s*\\|`,'i');
    return hasTitle && colsRe.test(md);
  }

  async function expandIfNeeded(markdown){
    const needWords = wordCount(markdown) < 1500;
    const missNutri = !hasTable(markdown, 'Ø®Ø·Ø© Ø§Ù„ØªØºØ°ÙŠØ©', ['Ø§Ù„ÙŠÙˆÙ…','Ø§Ù„ÙˆØ¬Ø¨Ø©','Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª','Ø§Ù„Ø³Ø¹Ø±Ø§Øª','Ø¨Ø±ÙˆØªÙŠÙ†_g','ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª_g','Ø¯Ù‡ÙˆÙ†_g']);
    const missTrain = !hasTable(markdown, 'Ø®Ø·Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨', ['Ø§Ù„ÙŠÙˆÙ…','Exercise','Sets','Reps','Rest_s','Tempo','RPE']);
    const missDays = daysMissing(markdown);

    if(!needWords && !missNutri && !missTrain && missDays.length===0) return markdown;

    const patchPrompt = `
Ø£ÙÙƒÙ…Ù„/Ø£ØµÙ„ÙØ­ Ø§Ù„Ø®Ø·Ø© Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù†Ø§Ù‚ØµØ© Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯:
- Ø£ÙŠØ§Ù… Ù†Ø§Ù‚ØµØ©: ${missDays.join(', ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù†Ø§Ù‚ØµØ©: ${[missNutri?'Ø§Ù„ØªØºØ°ÙŠØ©':'', missTrain?'Ø§Ù„ØªØ¯Ø±ÙŠØ¨':''].filter(Boolean).join('ØŒ ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
- Ø£Ø¯Ø®Ù„ Ø¨Ù†Ø¯ "Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ" Ù„ÙƒÙ„ ÙŠÙˆÙ….
Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ:
${markdown}
`;
    const patch = await callAI(patchPrompt, '/.netlify/functions/gemini-proxy');
    return (patch.ok && patch.text) ? (markdown + '\n\n' + patch.text) : markdown;
  }

  let lastPlanJSON=null;
  async function generatePlan(){
    const p=state.userData;
    const targets=computeTargets(p);

    if(!p.accuracy_consent){
      notify('ÙŠØ¬Ø¨ Ø§Ù„Ø¥Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©','warning');
      state.currentStage=10; renderStage(10); return;
    }

    const prompt=buildAIPrompt(p,state.lang,targets);
    const first = await callAI(prompt, '/.netlify/functions/gemini-proxy');
    if(!first.ok || !first.text){ renderErrorMessage(first.error); return; }
    let md = await expandIfNeeded(first.text);
    renderAI(md);

    // controls
    document.getElementById('btn-print').classList.remove('hidden');
    document.getElementById('btn-restart').classList.remove('hidden');
    document.getElementById('export-wrap').classList.remove('hidden');
    document.getElementById('btn-print').onclick=()=>window.print();
    document.getElementById('exp-json').onclick=()=>exportJSON(lastPlanJSON);
    document.getElementById('exp-csv').onclick=()=>exportCSV(lastPlanJSON);
    document.getElementById('btn-restart').onclick=restartApp;
  }

  function renderAI(markdown){
    const banner = `> **Ù…ØµØ·ÙÙŠ Ø§Ù„ØµØ§ÙÙŠ â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯**  \n> **Powered by Mustafa Elsafy 2025 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©**\n\n`;
    let html = marked.parse(banner + markdown);
    html = html.replace(/\[SWAP:(EXERCISE|MEAL):(.*?)\]/g,(m,type,item)=>{
      const t=type.toLowerCase(); const clean=item.replace(/\"/g,'&quot;');
      const btn = `<button type="button" onclick="swapItem(event)" data-type="${t}" data-item="${clean}" class="no-print bg-gray-200 hover:bg-gray-300 text-gray-800 text-xs px-2 py-1 rounded-md">${T('swap')}</button>`;
      return t==='meal' ? `<span class="inline-flex items-center gap-2">${item} ${btn}</span>` : `<span class="inline-flex items-center gap-2 ltr-text"><span class="font-semibold">${item}</span>${btn}</span>`;
    });
    document.getElementById('plan').innerHTML = html;
    document.querySelectorAll('.no-print .animate-spin, .no-print h2, .no-print p').forEach(e=>e.style.display='none');
    lastPlanJSON = { source:'ai_markdown', raw: markdown };
    qualityCheck(); renderSummary();
  }

  function renderErrorMessage(error){
    const planEl=document.getElementById('plan');
    planEl.innerHTML = `<div class="p-4 bg-red-100 border-l-4 border-red-500 rounded-r-lg mb-4"><h3 class="font-bold text-red-800">${T('api_key_error')}</h3><p class="text-red-700 text-xs ltr-text">${String(error).slice(0,1000)}</p></div>`;
    document.querySelectorAll('.no-print .animate-spin, .no-print h2, .no-print p').forEach(e=>e.style.display='none');
    document.getElementById('btn-restart').classList.remove('hidden'); document.getElementById('btn-restart').onclick=restartApp;
  }

  function qualityCheck(){
    const qc = document.getElementById('qc'); if(!qc) return;
    const txt = document.getElementById('plan').innerText || '';
    const days=[1,2,3,4,5,6,7];
    const found = days.filter(d=> new RegExp(`(Day\\s*${d}|Ø§Ù„ÙŠÙˆÙ…\\s*${d})`,'i').test(txt));
    qc.innerHTML = `<span class="inline-flex items-center gap-2 px-2 py-1 rounded-lg ${found.length===7?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800'}">${T('days_check')}: ${found.length}/7</span>`;
  }

  async function swapItem(e){
    const button = e.target.closest('button'); if(!button) return;
    const type = button.dataset.type; const item=(button.dataset.item||'').toString();
    const original=button.textContent; button.disabled=true; button.textContent=T('swapping');

    const u=state.userData;
    let prompt='';
    if(type==='meal'){
      prompt = `Ø¨Ø¯Ù‘Ù„ ÙˆØ¬Ø¨Ø© "${item}" Ø¨ÙˆØ¬Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù†Ø¸Ø§Ù… ${u.diet_preference}. ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©: ${(u.allergies||[]).join(', ')||'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}. Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·.`;
    } else {
      prompt = `Ø¨Ø¯Ù‘Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ† "${item}" Ø¨Ø¨Ø¯ÙŠÙ„ ÙŠØ³ØªÙ‡Ø¯Ù Ù†ÙØ³ Ø§Ù„Ø¹Ø¶Ù„Ø© Ù„Ù…Ø³ØªÙˆÙ‰ ${u.training_exp} ÙˆÙŠØªØ¬Ù†Ø¨ Ø¥ØµØ§Ø¨Ø§Øª: ${u.injuries||'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}. Ø§ÙƒØªØ¨: Exercise + sets x reps ÙÙ‚Ø·.`;
    }
    const ai = await callAI(prompt, '/.netlify/functions/gemini-proxy');
    let suggestion='';
    if(ai.ok && ai.text){ suggestion=ai.text.trim().replace(/\"/g,''); } else { notify(T('api_key_error'),'error'); }
    if(suggestion){
      const target = button.parentElement;
      if(type==='meal'){
        target.childNodes[0].nodeValue = `${suggestion} `;
        button.dataset.item = suggestion;
      } else {
        const newName = suggestion.split(':')[0]?.trim()||suggestion;
        target.querySelector('.font-semibold').textContent = newName;
        const cell = button.closest('td');
        if(cell){ cell.innerHTML = cell.innerHTML.replace(item,newName); }
        button.dataset.item = newName;
      }
    }
    button.disabled=false; button.textContent=original;
  }

  function exportJSON(data){ if(!data) return; const blob=new Blob([JSON.stringify({ userData: state.userData, plan:data }, null, 2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ai-coach-plan.json'; a.click(); }
  function exportCSV(data){ if(!data) return; const rows=[['source','ai_markdown'],['prompt_data',JSON.stringify(state.userData)],['raw_response',data.raw]]; const csv=rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ai-coach-plan.csv'; a.click(); }

  function renderSummary(){
    const s=state.userData;
    const items=[
      ['Ø§Ù„Ø§Ø³Ù…', s.name||'â€”'],
      ['Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ø·ÙˆÙ„/Ø§Ù„ÙˆØ²Ù†', [s.age,s.height,s.weight].filter(Boolean).join(' / ')||'â€”'],
      ['Ø§Ù„Ø¬Ù†Ø³', s.gender||'â€”'],
      ['Ø§Ù„Ø£Ù‡Ø¯Ø§Ù', (s.goals||[]).join(', ')||'â€”'],
      ['Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù…', `${s.target_weight||'â€”'} | ${s.target_date||'â€”'}`],
      ['Ø§Ù„Ù†Ø¸Ø§Ù…', s.diet_preference||'â€”'],
      ['Ø­Ø³Ø§Ø³ÙŠØ§Øª', (s.allergies||[]).join(', ')||'â€”'],
      ['Ø®Ø¨Ø±Ø©/Ø¢Ø®Ø± ØªØ¯Ø±ÙŠØ¨', `${s.training_exp||'â€”'} | ${s.last_train||'â€”'}`],
      ['Ø§Ù„ØµØ­Ø©', (s.health_conditions||[]).join(', ')||'â€”'],
      ['Ø¥ØµØ§Ø¨Ø§Øª', s.injuries||'â€”'],
      ['PAL', s.physical_activity_level||'â€”'],
      ['ÙƒØ§Ø±Ø¯ÙŠÙˆ/Ø£Ø³Ø¨ÙˆØ¹', `${s.cardio_minutes_per_week||0} Ø¯`],
      ['ØªØ¹Ù‡Ø¯ Ø§Ù„Ø¯Ù‚Ø©', s.accuracy_consent?'âœ…':'âŒ']
    ];
    summary.innerHTML = `<ul class="space-y-1">${items.map(([k,v])=>`<li class="flex justify-between gap-2"><span class="text-gray-500">${k}</span><span class="font-semibold text-gray-800 ltr-text">${v}</span></li>`).join('')}</ul>`;
  }

  function restartApp(){ state = { currentStage: 0, lang: state.lang, userData: { goals: [], weak_points: {}, health_conditions: [], allergies: [], physical_activity_level:'Sedentary', cardio_minutes_per_week:0, accuracy_consent:false, prescription_text:'' } }; started=false; progressWrap.classList.add('hidden'); sticky.classList.add('hidden'); renderStage(0); renderSummary(); }
  function notify(message,type='success'){ const el=document.createElement('div'); el.className=`fixed top-5 ${document.documentElement.dir==='rtl'?'left-5':'right-5'} p-3 rounded-lg shadow-lg text-white font-bold z-50 ${type==='error'?'bg-red-500':type==='warning'?'bg-amber-500':'bg-green-600'}`; el.textContent=message; document.body.appendChild(el); setTimeout(()=>el.remove(),3200); }

  // language switch
  document.getElementById('btn-ar').onclick=()=>{ state.lang='ar'; renderStage(state.currentStage); };
  document.getElementById('btn-en').onclick=()=>{ state.lang='en'; renderStage(state.currentStage); };

  // init
  window.addEventListener('load', ()=>{ renderStage(0); renderSummary(); });
  </script>
</body>
</html>
