<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ â€” Ø®Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Markdown + Sanitize + PDF -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f7f9fc; --panel:#fff; --ink:#0c1220; --muted:#5b6878; --line:#e5eaf1;
      --brand:#6d28d9; --brand2:#0891b2; --ok:#059669; --warn:#d97706; --err:#dc2626;
      --chip:#f1f5f9; --th:#f3f4f6;
    }
    [data-theme="dark"]{
      --bg:#0a0f15; --panel:#0e1621; --ink:#e7eaf0; --muted:#a8b0bc; --line:#1b2736;
      --brand:#7c3aed; --brand2:#06b6d4; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --chip:#0b121a; --th:#0b121a;
    }
    html,body{height:100%}
    body{background:linear-gradient(180deg,var(--bg) 0%, color-mix(in oklab, var(--bg) 75%, white 25%) 100%);color:var(--ink);-webkit-font-smoothing:antialiased}
    .font-ar{font-family:"Tajawal",sans-serif}
    .font-en{font-family:"Poppins",sans-serif}
    .glass{background:color-mix(in oklab, var(--panel) 92%, transparent 8%);border:1px solid color-mix(in oklab, var(--line) 85%, transparent 15%);backdrop-filter:blur(8px)}
    .panel{background:var(--panel);border:1px solid var(--line)}
    .btn{border:1px solid color-mix(in oklab, var(--line) 70%, transparent 30%);border-radius:12px;padding:.8rem 1rem;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand2));border-color:transparent;color:#fff}
    .btn-ghost{background:var(--chip);color:var(--ink)}
    .btn-soft{background:color-mix(in oklab, var(--panel) 95%, white 5%);border:1px solid color-mix(in oklab, var(--line) 80%, transparent 20%)}
    .chip{padding:.28rem .55rem;border-radius:.6rem;font-size:.74rem;background:var(--chip);border:1px dashed color-mix(in oklab, var(--line) 70%, transparent 30%);color:color-mix(in oklab, var(--brand2) 65%, var(--ink) 35%)}
    .kpi{background:color-mix(in oklab, var(--panel) 96%, white 4%);border:1px solid color-mix(in oklab, var(--line) 80%, transparent 20%);border-radius:.8rem;padding:.6rem}
    .muted{color:var(--muted)}
    .prose :where(table){width:100%;border-collapse:collapse}
    .prose :where(th,td){border:1px solid color-mix(in oklab, var(--line) 80%, transparent 20%);padding:.6rem;vertical-align:top}
    .prose :where(th){background:var(--th)}
    @media print{ .no-print, header, #themeToggle {display:none!important}
      body{background:#fff;color:#000}
      .panel,.glass{background:#fff;border:none}
      table{page-break-inside:avoid}
    }
  </style>
</head>
<body class="font-ar">
  <!-- Header -->
  <header class="glass sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-600 to-cyan-500 text-white grid place-items-center font-extrabold">AI</div>
        <div class="leading-tight">
          <div class="text-xs muted">Personal Coaching</div>
          <div class="font-extrabold">Smart Plan</div>
          <div class="text-[11px] muted">Nutrition â€¢ Training â€¢ Compliance</div>
        </div>
      </div>
      <div class="flex items-center gap-2 no-print">
        <div class="inline-flex bg-[color:var(--chip)] border border-[color:var(--line)] rounded-xl overflow-hidden">
          <button id="btn-lang-ar" class="px-3 py-2 text-sm font-bold">AR</button>
          <button id="btn-lang-en" class="px-3 py-2 text-sm font-bold">EN</button>
        </div>
        <button id="themeToggle" class="btn btn-ghost" title="Theme">â˜€ï¸/ğŸŒ™</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 mt-6">
    <div class="glass rounded-2xl p-6">
      <h1 id="hero-title" class="text-3xl sm:text-4xl font-extrabold">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ â€” Ø®Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©</h1>
      <p id="hero-sub" class="muted mt-1">
        ØªÙˆÙ„ÙŠØ¯ Ø°ÙƒÙŠ **Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù…**: ØªØ±Ø­ÙŠØ¨ØŒ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ø§Ù„Ù…Ø³Ù…ÙˆØ­/Ø§Ù„Ù…Ù…Ù†ÙˆØ¹ØŒ Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹ØŒ ØªØºØ°ÙŠØ© Ù§ Ø£ÙŠØ§Ù…ØŒ ØªØ¯Ø±ÙŠØ¨ Ù§ Ø£ÙŠØ§Ù…ØŒ Ù…ÙƒÙ…Ù„Ø§ØªØŒ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…ØŒ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ¹Ø«Ø±ØŒ Ù‚Ø§Ø¦Ù…Ø© ØªÙ†ÙÙŠØ°ØŒ Ø³Ù„Ø§Ù…Ø©ØŒ ÙˆØ£Ø³Ø¦Ù„Ø© Ø´Ø§Ø¦Ø¹Ø© â€” Ø¨Ø¯ÙˆÙ† Ø§Ø®ØªØµØ§Ø±.
      </p>
    </div>
  </section>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 mt-6 grid xl:grid-cols-[minmax(0,1fr),420px] gap-6">
    <!-- Form Panel -->
    <section class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="text-sm chip muted">AR/EN â€¢ PDF/Print â€¢ Section Pipeline</div>
        <div class="text-xs chip">Powered by Mustafa Elsafy 2025</div>
      </div>

      <div id="form"></div>

      <div id="controls" class="mt-6 flex gap-2">
        <button id="btn-start" class="btn btn-primary flex-1">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙˆÙ„ÙŠØ¯</button>
      </div>

      <div id="progress" class="mt-4 hidden">
        <div class="text-sm muted" id="prog-text">â€”</div>
        <div class="w-full h-2 bg-[color:var(--chip)] rounded-full overflow-hidden mt-2">
          <div id="prog-bar" class="h-full bg-gradient-to-r from-violet-600 to-cyan-500 w-0 transition-all duration-300"></div>
        </div>
      </div>

      <div class="mt-4 no-print">
        <button id="btn-regen" class="btn btn-soft hidden">Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ù‚Ø³Ù…</button>
        <button id="btn-print" class="btn btn-ghost hidden">Ø·Ø¨Ø§Ø¹Ø©</button>
        <button id="btn-pdf" class="btn btn-ghost hidden">PDF</button>
      </div>
    </section>

    <!-- Live Summary -->
    <aside class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <div id="live-title" class="text-sm font-bold">Ù…Ù„Ø®Øµ ÙÙˆØ±ÙŠ</div>
        <span id="lang-badge" class="chip">AR</span>
      </div>
      <div id="live" class="mt-3 space-y-2 text-sm"></div>
      <div class="mt-3 text-[11px] muted">* Ø§Ù„Ù„ØºØ© ØªÙÙ‚ÙÙ„ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„Ø®Ù„Ø·.</div>
    </aside>
  </main>

  <!-- Result -->
  <section id="result" class="max-w-7xl mx-auto px-4 sm:px-6 mt-6 mb-14 hidden">
    <article class="glass rounded-2xl p-6" id="resultRoot">
      <h2 id="plan-title" class="text-2xl font-extrabold">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© â€” Section by Section</h2>
      <div id="ai" class="prose prose-invert rtl:text-right ltr:text-left mt-4"></div>

      <div class="mt-4 no-print flex gap-2">
        <button id="act-new" class="btn btn-ghost">Ø®Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <button id="act-print" class="btn btn-primary">Ø·Ø¨Ø§Ø¹Ø©</button>
        <button id="act-pdf" class="btn btn-ghost">PDF</button>
      </div>

      <footer class="border-t border-[color:var(--line)] mt-6 pt-2 text-[12px] muted flex items-center justify-between">
        <span id="rights">Powered by Mustafa Elsafy 2025</span>
        <span id="foot-note"></span>
      </footer>
    </article>
  </section>

  <script>
  (function(){
    // ===== Shortcuts
    const $ = (id)=>document.getElementById(id);
    const setHTML = (el, html)=>{ el.innerHTML = (window.DOMPurify? window.DOMPurify.sanitize(html) : html); };

    // ===== Theme
    const themeBtn = $('themeToggle');
    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); themeBtn.textContent = (t==='dark'?'â˜€ï¸':'ğŸŒ™'); }
    applyTheme(localStorage.getItem('theme')||'light');
    themeBtn.onclick = ()=>applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

    // ===== i18n
    const L = {
      ar: {
        ui:{
          title:'Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ â€” Ø®Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©',
          live:'Ù…Ù„Ø®Øµ ÙÙˆØ±ÙŠ',
          name:'Ø§Ù„Ø§Ø³Ù…', age:'Ø§Ù„Ø¹Ù…Ø±', height:'Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)', weight:'Ø§Ù„ÙˆØ²Ù† (ÙƒØº)', gender:'Ø§Ù„Ø¬Ù†Ø³', male:'Ø°ÙƒØ±', female:'Ø£Ù†Ø«Ù‰',
          job:'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ (PAL)', jobVals:['Ù…ÙƒØªØ¨ÙŠ Ø¬Ø¯Ù‹Ø§ (PAL 1.15)','Ù…ÙƒØªØ¨ÙŠ/Ø®ÙÙŠÙ (PAL 1.25)','Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø· (PAL 1.4)','Ù†Ø´Ø§Ø· Ø¹Ø§Ù„Ù (PAL 1.6)'],
          sleep:'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù†ÙˆÙ…', stress:'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙˆØªØ±', stressVals:['Ù…Ù†Ø®ÙØ¶','Ù…ØªÙˆØ³Ø·','Ù…Ø±ØªÙØ¹'],
          goals:'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù', goalsVals:['Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†','Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª','Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©','ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„','ØµØ­Ø© Ø¹Ø§Ù…Ø©'],
          meals:'Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª/Ø§Ù„ÙŠÙˆÙ…', diet:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ', diets:['Ù…ØªÙˆØ§Ø²Ù†','Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª','ÙƒÙŠØªÙˆ','Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·','Ù†Ø¨Ø§ØªÙŠ'],
          fasting:'Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹', enable:'ØªÙØ¹ÙŠÙ„', protocol:'Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„', window:'Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙƒÙ„', from:'Ù…Ù†', to:'Ø¥Ù„Ù‰',
          training_place:'Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨', placeVals:['Ù†Ø§Ø¯ÙŠ ÙƒØ§Ù…Ù„','Ù…Ù†Ø²Ù„ + Ø¯Ø§Ù…Ø¨Ù„Ø²','Ù…Ù†Ø²Ù„ ÙˆØ²Ù† Ø§Ù„Ø¬Ø³Ù…'], equipment:'Ù…Ø¹Ø¯Ø§Øª Ù…ØªÙˆÙØ±Ø©',
          health:'Ø­Ø§Ù„Ø§Øª ØµØ­ÙŠØ©', healthVals:['Ø¶ØºØ· Ø§Ù„Ø¯Ù…','Ø§Ù„Ø³ÙƒØ±ÙŠ','Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†','Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©','Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ','Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©','Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù‡Ø¶Ù…ÙŠ'],
          meds:'Ø£Ø¯ÙˆÙŠØ© (Ø¥Ù† ÙˆØ¬Ø¯Øª)', allergies:'Ø­Ø³Ø§Ø³ÙŠØ§Øª', allergyVals:['Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†','Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²','Ø§Ù„Ù…ÙƒØ³Ø±Ø§Øª','Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ©','Ø§Ù„Ø¨Ù‚ÙˆÙ„ÙŠØ§Øª','Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©','Ø§Ù„Ø²ÙŠÙˆØª Ø§Ù„Ù†Ø¨Ø§ØªÙŠØ©'],
          injuries:'Ø¥ØµØ§Ø¨Ø§Øª (Ø§Ø°ÙƒØ± Ø§Ù„Ù…ÙƒØ§Ù† ÙˆØ§Ù„ÙˆØµÙ)', exp:'Ø®Ø¨Ø±Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©', expVals:['Ù…Ø¨ØªØ¯Ø¦','Ù…ØªÙˆØ³Ø·','Ù…ØªÙ‚Ø¯Ù…'],
          dislikes:'Ø£Ø·Ø¹Ù…Ø© ØºÙŠØ± Ù…ÙØ¶Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
          start:'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙˆÙ„ÙŠØ¯', regen:'Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ù‚Ø³Ù…', printing:'Ø·Ø¨Ø§Ø¹Ø©', pdf:'PDF',
          rights:'Powered by Mustafa Elsafy 2025',
          locked:'* ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ù„ØºØ© Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ù„Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆÙ„ÙŠØ¯.'
        }
      },
      en: {
        ui:{
          title:'Personal Coach â€” Precise Final Plan',
          live:'Live Summary',
          name:'Name', age:'Age', height:'Height (cm)', weight:'Weight (kg)', gender:'Gender', male:'Male', female:'Female',
          job:'Daily activity (PAL)', jobVals:['Very desk (PAL 1.15)','Desk/Light (PAL 1.25)','Moderate (PAL 1.4)','High (PAL 1.6)'],
          sleep:'Sleep hours', stress:'Stress level', stressVals:['Low','Moderate','High'],
          goals:'Goals', goalsVals:['Fat loss','Muscle gain','Strength','Endurance','General health'],
          meals:'Meals/day', diet:'Preferred diet', diets:['Balanced','Low-Carb','Keto','Mediterranean','Plant-based'],
          fasting:'Intermittent Fasting', enable:'Enable', protocol:'Protocol', window:'Feeding window', from:'from', to:'to',
          training_place:'Training place', placeVals:['Full gym','Home + dumbbells','Home bodyweight'], equipment:'Available equipment',
          health:'Health conditions', healthVals:['Hypertension','Diabetes','Insulin Resistance','Thyroid','Fatty Liver','Hormonal issues','GI issues'],
          meds:'Medications (if any)', allergies:'Allergies', allergyVals:['Gluten','Lactose','Nuts','Seafood','Legumes','Added sugars','Vegetable oils'],
          injuries:'Injuries (location & description)', exp:'Resistance experience', expVals:['Beginner','Intermediate','Advanced'],
          dislikes:'Disliked foods (optional)',
          start:'Start Generation', regen:'Regenerate Section', printing:'Print', pdf:'PDF',
          rights:'Powered by Mustafa Elsafy 2025',
          locked:'* Language is locked to avoid mixing during generation.'
        }
      }
    };

    // ===== State
    let lang = 'ar';   // lock on start
    let locked = false;

    const user = {
      name:'', age:'', height:'', weight:'', gender:'Male',
      jobLabel:'Desk/Light (PAL 1.25)',
      sleep:7, stress:'Ù…ØªÙˆØ³Ø·',
      goals:[], meals:4, diet:'Ù…ØªÙˆØ§Ø²Ù†',
      fasting:{enabled:false, protocol:'16:8', start:'12:00', end:'20:00'},
      training_place:'Ù†Ø§Ø¯ÙŠ ÙƒØ§Ù…Ù„', equipment:'',
      health:[], meds:'', allergies:[], injuries:'', exp:'Ù…Ø¨ØªØ¯Ø¦',
      dislikes:''
    };

    // ===== UI Build
    function optionMap(arr){ return arr.map(v => `<option>${v}</option>`).join(''); }
    function chips(name, arr){ return arr.map(v=>`
      <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)] cursor-pointer">
        <input type="checkbox" name="${name}" value="${v}" class="accent-violet-600"/><span class="text-sm">${v}</span>
      </label>`).join(''); }

    function renderForm(){
      const U = L[lang].ui;
      const html = `
        <div class="grid md:grid-cols-3 gap-4">
          <label class="block"><span class="text-sm">${U.name}</span><input id="name" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]"/></label>
          <label class="block"><span class="text-sm">${U.gender}</span>
            <select id="gender" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]">
              <option>${U.male}</option><option>${U.female}</option>
            </select></label>
          <label class="block"><span class="text-sm">${U.age}</span><input id="age" type="number" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border"/></label>
          <label class="block"><span class="text-sm">${U.height}</span><input id="height" type="number" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border"/></label>
          <label class="block"><span class="text-sm">${U.weight}</span><input id="weight" type="number" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border"/></label>
          <label class="block md:col-span-2"><span class="text-sm">${U.job}</span>
            <select id="job" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border">${optionMap(U.jobVals)}</select></label>
          <label class="block"><span class="text-sm">${U.sleep}</span><input id="sleep" type="number" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border"/></label>
          <label class="block"><span class="text-sm">${U.stress}</span>
            <select id="stress" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border">${optionMap(U.stressVals)}</select></label>
        </div>

        <div class="mt-4">
          <div class="text-sm mb-1">${U.goals}</div>
          <div class="flex flex-wrap gap-2">${chips('goals', U.goalsVals)}</div>
        </div>

        <div class="grid md:grid-cols-3 gap-4 mt-4">
          <label class="block"><span class="text-sm">${U.meals}</span>
            <select id="meals" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border">
              <option>3</option><option selected>4</option><option>5</option>
            </select></label>
          <label class="block"><span class="text-sm">${U.diet}</span>
            <select id="diet" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border">${optionMap(U.diets)}</select></label>
          <label class="inline-flex items-center gap-2 mt-7">
            <input id="ifEnabled" type="checkbox" class="accent-violet-600"/>
            <span class="text-sm">${U.fasting} â€” ${U.enable}</span>
          </label>
        </div>

        <div class="grid md:grid-cols-3 gap-4 mt-2" id="ifWrap">
          <label class="block"><span class="text-sm">${U.protocol}</span>
            <select id="ifProto" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border">
              <option>14:10</option><option selected>16:8</option><option>18:6</option><option>20:4</option>
            </select></label>
          <label class="block"><span class="text-sm">${U.window} ${U.from}</span>
            <input id="ifStart" type="time" value="12:00" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border"/></label>
          <label class="block"><span class="text-sm">${U.window} ${U.to}</span>
            <input id="ifEnd" type="time" value="20:00" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border"/></label>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <label class="block"><span class="text-sm">${U.training_place}</span>
            <select id="place" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border">${optionMap(U.placeVals)}</select></label>
          <label class="block"><span class="text-sm">${U.equipment}</span>
            <input id="equip" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border" placeholder="Dumbbells, Bandsâ€¦"/></label>
        </div>

        <div class="mt-4">
          <div class="text-sm mb-1">${U.health}</div>
          <div class="flex flex-wrap gap-2">${chips('health', U.healthVals)}</div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <label class="block"><span class="text-sm">${U.meds}</span>
            <input id="meds" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border" placeholder="Metformin, Thyroxineâ€¦"/></label>
          <label class="block"><span class="text-sm">${U.injuries}</span>
            <input id="inj" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border" placeholder="Ù…Ø«Ø§Ù„: Ø£Ù„Ù… Ø£Ø³ÙÙ„ Ø§Ù„Ø¸Ù‡Ø±"/></label>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <div class="text-sm mb-1">${U.allergies}</div>
            <div class="flex flex-wrap gap-2">${chips('allergies', U.allergyVals)}</div>
          </div>
          <label class="block"><span class="text-sm">${U.dislikes}</span>
            <input id="dislikes" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border" placeholder=""/>
          </label>
        </div>
      `;
      $('form').innerHTML = html;
      $('sleep').value = 7;
    }

    function capture(){
      const U = L[lang].ui;
      user.name     = $('name').value.trim();
      const gval    = $('gender').value;
      user.gender   = (gval === U.female ? 'Female' : 'Male');
      user.age      = +$('age').value;
      user.height   = +$('height').value;
      user.weight   = +$('weight').value;
      user.jobLabel = $('job').value;
      user.sleep    = +$('sleep').value;
      user.stress   = $('stress').value;
      user.goals    = [...document.querySelectorAll('input[name="goals"]:checked')].map(e=>e.value);
      user.meals    = +$('meals').value;
      user.diet     = $('diet').value;
      user.fasting.enabled = $('ifEnabled').checked;
      user.fasting.protocol= $('ifProto').value;
      user.fasting.start   = $('ifStart').value;
      user.fasting.end     = $('ifEnd').value;
      user.training_place  = $('place').value;
      user.equipment       = $('equip').value;
      user.health          = [...document.querySelectorAll('input[name="health"]:checked')].map(e=>e.value);
      user.meds            = $('meds').value;
      user.injuries        = $('inj').value;
      user.allergies       = [...document.querySelectorAll('input[name="allergies"]:checked')].map(e=>e.value);
      user.dislikes        = $('dislikes').value;

      if(!user.name || !user.age || !user.height || !user.weight || user.goals.length===0){
        alert(lang==='ar'?'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©':'Please complete required fields'); return false;
      }
      return true;
    }

    function live(){
      $('live').innerHTML = `
        <div class="text-xs muted">${L[lang].ui.name}: <b>${user.name||'â€”'}</b></div>
        <div class="grid grid-cols-3 gap-2 text-xs">
          <div class="kpi"><div class="muted">${L[lang].ui.age}</div><b>${user.age||'â€”'}</b></div>
          <div class="kpi"><div class="muted">${L[lang].ui.height}</div><b>${user.height||'â€”'}</b></div>
          <div class="kpi"><div class="muted">${L[lang].ui.weight}</div><b>${user.weight||'â€”'}</b></div>
        </div>
        <div class="text-xs muted">${L[lang].ui.goals}: <b>${user.goals.join(lang==='ar'?'ØŒ ':', ')}</b></div>
        <div class="text-xs muted">${L[lang].ui.diet}: <b>${user.diet}</b> â€” ${L[lang].ui.meals}: <b>${user.meals}</b></div>
        <div class="text-[11px] text-amber-600 mt-1">${L[lang].ui.locked}</div>
      `;
    }

    // ===== Language toggle (before lock)
    function applyLang(l){
      if(locked) return; // prevent switch while generating
      lang=l;
      document.documentElement.lang=l;
      document.documentElement.dir=(l==='ar'?'rtl':'ltr');
      document.body.classList.toggle('font-ar', l==='ar');
      document.body.classList.toggle('font-en', l!=='ar');
      $('lang-badge').textContent=l.toUpperCase();
      $('hero-title').textContent=L[l].ui.title;
      $('live-title').textContent=L[l].ui.live;
      $('rights').textContent=L[l].ui.rights;
      renderForm();
    }
    $('btn-lang-ar').onclick=()=>applyLang('ar');
    $('btn-lang-en').onclick=()=>applyLang('en');
    applyLang('ar'); // default

    // ===== Progress UI
    function setProgress(i, n, label){
      const pct = Math.round((i/n)*100);
      $('progress').classList.remove('hidden');
      $('prog-text').textContent = label;
      $('prog-bar').style.width = pct+'%';
    }

    // ===== Prompt Builders (strict, language-locked)
    function baseHeader(){
      const locale = (lang==='ar'?'Arabic':'English');
      const ifTxt = user.fasting.enabled ? `${user.fasting.protocol} (${user.fasting.start}-${user.fasting.end})` : 'disabled';
      return `
IMPORTANT LANGUAGE RULE: Output must be in ${locale} only. Do not use any other language or mixed terms.
FORMAT: Return Markdown only (no code blocks, no JSON). Use clean headings (###) and tables when relevant.

CLIENT PROFILE
- Name: ${user.name}; Sex: ${user.gender}
- Age/Height/Weight: ${user.age}y / ${user.height}cm / ${user.weight}kg
- Daily Activity (PAL): ${user.jobLabel}; Sleep: ${user.sleep}h; Stress: ${user.stress}
- Goals: ${user.goals.join(', ')}
- Diet style: ${user.diet}; Meals/day: ${user.meals}; Intermittent fasting: ${ifTxt}
- Training place: ${user.training_place}; Equipment: ${user.equipment||'â€”'}
- Experience: ${user.exp}; Injuries: ${user.injuries||'None'}
- Allergies: ${(user.allergies||[]).join(', ')||'None'}
- Health conditions: ${(user.health||[]).join(', ')||'None'}
- Disliked foods: ${user.dislikes||'None'}
`.trim();
    }

    const SECTIONS = [
      {key:'welcome',    label_ar:'Ù¡) ØªØ±Ø­ÙŠØ¨ ÙˆØªÙ‡Ù†Ø¦Ø© ÙˆÙ†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„Ø®Ø·Ø©', label_en:'1) Welcome, congratulations & plan overview',
        prompt:()=>`${baseHeader()}

SECTION: Welcome & Motivation and Plan Overview
- Write 2â€“3 short, warm lines to greet the user and congratulate their decision.
- Add a concise overview of the plan structure and what to expect (section-by-section).
- Keep it professional, motivating, and clear.`},

      {key:'analysis',   label_ar:'Ù¢) ØªØ´Ø®ÙŠØµ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù‡Ø¯Ù', label_en:'2) Case analysis & goal rationale',
        prompt:()=>`${baseHeader()}

SECTION: Case Analysis & Goal Rationale
- Summarize user context and constraints.
- Explain how nutrition + training address the goals, considering injuries/health/allergies.
- Bullet points, precise, no fluff.`},

      {key:'allowed',    label_ar:'Ù£) Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹', label_en:'3) Allowed vs Avoid',
        prompt:()=>`${baseHeader()}

SECTION: Allowed vs Avoid
- Tailor to the chosen diet, allergies and dislikes.
- Bulleted lists with practical examples.`},

      {key:'fasting',    label_ar:'Ù¤) Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹', label_en:'4) Intermittent Fasting',
        prompt:()=>`${baseHeader()}

SECTION: Intermittent Fasting
- If disabled, briefly explain why/when to consider it. If enabled, specify exact protocol, hydration, electrolytes, pre/after window rules, and meds note.
- Practical guidance for daily application.`},

      {key:'nutrition',  label_ar:'Ù¥) ØªØºØ°ÙŠØ© Ù§ Ø£ÙŠØ§Ù… â€” Ø¬Ø¯Ø§ÙˆÙ„ ÙƒØ§Ù…Ù„Ø©', label_en:'5) 7-Day Nutrition â€” full tables',
        prompt:()=>`${baseHeader()}

SECTION: 7-Day Nutrition Plan (FULL)
STRICT REQUIREMENTS:
- Write 7 DIFFERENT days. For EACH day write EXACTLY ${user.meals} meals.
- Each meal: name, ingredients with quantities (g/ml), per-meal macros (Protein/Fat/Carbs/kcal).
- End each day with a Totals row (must match daily targets within Â±2%), and a 1-line compliance tip.
- NO "repeat", NO "etc", NO placeholders. Everything explicit.`},

      {key:'training',   label_ar:'Ù¦) ØªØ¯Ø±ÙŠØ¨ Ù§ Ø£ÙŠØ§Ù… â€” Ø¬Ø¯Ø§ÙˆÙ„ ÙƒØ§Ù…Ù„Ø©', label_en:'6) 7-Day Training â€” full tables',
        prompt:()=>`${baseHeader()}

SECTION: 7-Day Training Plan (FULL)
- Tailored to ${user.exp} at ${user.training_place}; avoid aggravating injuries: ${user.injuries||'None'}.
- For EACH of 7 days: a table with columns: Exercise (English only) â€¢ Sets â€¢ Reps â€¢ Tempo â€¢ Rest (s) â€¢ Notes (cues/progression).
- No placeholders. Fully detailed for 7 days.`},

      {key:'supps',      label_ar:'Ù§) Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª', label_en:'7) Supplements',
        prompt:()=>`${baseHeader()}

SECTION: Supplements
- Core stack (dose & timing).
- Condition-linked supplements based on health profile (with 'consult physician' note).
- Keep it practical and safe.`},

      {key:'progress',   label_ar:'Ù¨) Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ø¶Ø¨Ø·', label_en:'8) Progression & Adjustments',
        prompt:()=>`${baseHeader()}

SECTION: Progression & Weekly Check-ins
- Rules to increase load/reps/RPE.
- Macro adjustment thresholds if weight stalls up/down.
- Deload criteria and recovery cues.`},

      {key:'troubleshoot',label_ar:'Ù©) Ø§Ù„ØªØ¹Ø«Ø± ÙˆØ§Ù„Ø­Ù„ÙˆÙ„ + Ù‚Ø§Ø¦Ù…Ø© ØªÙ†ÙÙŠØ°', label_en:'9) Troubleshooting + Implementation Checklist',
        prompt:()=>`${baseHeader()}

SECTION: Troubleshooting & Implementation Checklist
- Common pitfalls and quick fixes.
- A daily/weekly actionable checklist.`},

      {key:'safety',     label_ar:'Ù¡Ù ) Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©', label_en:'10) Safety & FAQs',
        prompt:()=>`${baseHeader()}

SECTION: Safety & FAQs
- Safety notes given injuries/conditions.
- 4â€“6 concise FAQs with precise answers.`},

      {key:'closing',    label_ar:'Ù¡Ù¡) Ø®ØªØ§Ù… Ø§Ø­ØªØ±Ø§ÙÙŠ', label_en:'11) Professional Closing',
        prompt:()=>`${baseHeader()}

SECTION: Professional Closing
- Close with a short professional paragraph reinforcing commitment and next steps.`},
    ];

    // ===== AI Call
    async function callAI(prompt, maxTokens){
      const r = await fetch('/.netlify/functions/gemini-proxy', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt, locale:(lang==='ar'?'ar':'en'), maxTokens })
      });
      if(!r.ok){ throw new Error(await r.text()); }
      const data = await r.json();
      return data?.text || '';
    }

    function appendMarkdown(md){
      const ai = $('ai');
      const html = (window.marked ? window.marked.parse(md) : md);
      const safe = (window.DOMPurify ? window.DOMPurify.sanitize(html) : html);
      ai.insertAdjacentHTML('beforeend', safe);
    }

    async function generatePipeline(){
      locked = true;
      // Ù‚ÙÙ„ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      $('btn-lang-ar').disabled = true;
      $('btn-lang-en').disabled = true;

      // Ø¥Ø¸Ù‡Ø§Ø± Ù†ØªÙŠØ­Ø©
      $('result').classList.remove('hidden');
      $('btn-regen').classList.remove('hidden');
      $('btn-print').classList.remove('hidden');
      $('btn-pdf').classList.remove('hidden');

      const n = SECTIONS.length;
      for(let i=0;i<n;i++){
        const sec = SECTIONS[i];
        const label = (lang==='ar'? sec.label_ar : sec.label_en);
        setProgress(i, n, label);

        // Ø³Ø¨ÙŠÙ†Ø± Ø®ÙÙŠÙ Ù„ÙƒÙ„ Ù‚Ø³Ù…
        appendMarkdown(`\n### ${label}\n\n> ${(lang==='ar'?'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯â€¦ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.':'Generatingâ€¦ please wait.')}\n`);

        let md = '';
        try{
          md = await callAI(sec.prompt(), (i<=1? 2048 : i<=3? 4096 : 8192));
        }catch(e){
          md = (lang==='ar'?'ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….':'Failed to generate this section.');
        }

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØªÙ„Ø© Ø§Ù„Ù€ â€œØ¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯â€ Ø¨Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙØ¹Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¹Ù‚Ø¯ØŒ Ù†Ø¶ÙŠÙ ØªØ­ØªÙ‡Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆÙ†ØªØ±Ùƒ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¦Ù„Ø§ Ù†ÙÙ‚Ø¯ Ø§Ù„ØªØªØ§Ù„ÙŠ)
        appendMarkdown(`\n${md}\n`);
      }

      setProgress(n, n, (lang==='ar'?'Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯':'Generation complete'));
    }

    // ===== Actions
    $('btn-start').onclick = async ()=>{
      if(!capture()) return;
      // Ù‚ÙÙ„ Ø§Ù„Ù„ØºØ© ÙˆØ¨Ø¯Ø¡
      $('lang-badge').textContent = (lang==='ar'?'AR':'EN');
      live();
      $('result').classList.remove('hidden');
      await generatePipeline();
      $('result').scrollIntoView({behavior:'smooth',block:'start'});
    };

    $('btn-regen').onclick = async ()=>{
      if(!locked){ alert(lang==='ar'?'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø£ÙˆÙ„Ù‹Ø§':'Start generation first'); return; }
      const label = (lang==='ar'?'Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‚Ø³Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ 11 Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯Ù‡:':'Enter section number 1..11 to regenerate:');
      const idx = Number(prompt(label));
      if(!(idx>=1 && idx<=SECTIONS.length)) return;
      const sec = SECTIONS[idx-1];
      setProgress(idx-1, SECTIONS.length, (lang==='ar'?sec.label_ar:sec.label_en)+' (regen)');
      const md = await callAI(sec.prompt(), 8192);
      appendMarkdown(`\n\n---\n\n${md}\n\n`);
      $('result').scrollIntoView({behavior:'smooth',block:'start'});
    };

    $('act-new').onclick = ()=>location.reload();
    $('act-print').onclick = ()=>window.print();
    $('act-pdf').onclick = ()=>{
      if(window.html2pdf){
        const opt={ margin:10, filename:(lang==='ar'?'Ø®Ø·Ø©-':'plan-')+(user.name||'client')+'.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
        window.html2pdf().from($('resultRoot')).set(opt).save();
      } else {
        window.print();
      }
    };

    $('btn-print').onclick = ()=>window.print();
    $('btn-pdf').onclick = ()=>$('act-pdf').click();

  })();
  </script>

  <!-- Footer -->
  <footer class="max-w-7xl mx-auto px-4 sm:px-6 mt-8 mb-10 text-center text-[12px] muted no-print">
    Powered by Mustafa Elsafy 2025
  </footer>
</body>
</html>
