<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ â€” Ø®Ø·Ø© Ø°ÙƒÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©</title>

  <!-- Tailwind (Ø¢Ù…Ù†: Ø¥Ù† ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø§ ØªØªØ¹Ø·Ù„ Ø§Ù„ØµÙØ­Ø©) -->
  <script src="https://cdn.tailwindcss.com" defer></script>

  <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©: ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„Ù‡Ø§ Ù„Ù† ØªØªØ¹Ø·Ù„ Ø§Ù„ØµÙØ­Ø© -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer onerror="window.__NO_MARKED__=true"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js" defer onerror="window.__NO_PURIFY__=true"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js" defer onerror="window.__NO_PDF__=true"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0a0f15; --panel:#0e1621; --ink:#e7eaf0; --muted:#a8b0bc; --line:#1b2736;
      --brand:#7c3aed; --brand2:#06b6d4; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --chip:#0b121a; --th:#0b121a;
    }
    [data-theme="light"]{
      --bg:#f6f8fb; --panel:#ffffff; --ink:#0b1220; --muted:#5b6878; --line:#e5eaf1;
      --brand:#6d28d9; --brand2:#0891b2; --ok:#059669; --warn:#d97706; --err:#dc2626; --chip:#f1f5f9; --th:#f3f4f6;
    }
    html,body{height:100%}
    body{background:linear-gradient(180deg,var(--bg) 0%, color-mix(in oklab, var(--bg) 75%, white 25%) 100%);color:var(--ink);-webkit-font-smoothing:antialiased}
    .font-ar{font-family:"Tajawal",sans-serif}
    .font-en{font-family:"Poppins",sans-serif}
    .glass{background:color-mix(in oklab, var(--panel) 90%, transparent 10%);border:1px solid color-mix(in oklab, var(--line) 85%, transparent 15%);backdrop-filter:blur(10px)}
    .panel{background:var(--panel);border:1px solid var(--line)}
    .btn{border:1px solid color-mix(in oklab, var(--line) 70%, transparent 30%);border-radius:12px;padding:.8rem 1rem;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand2));border-color:transparent;color:#fff}
    .btn-ghost{background:var(--chip);color:var(--ink)}
    .btn-soft{background:color-mix(in oklab, var(--panel) 95%, white 5%);border:1px solid color-mix(in oklab, var(--line) 80%, transparent 20%)}
    .chip{padding:.28rem .55rem;border-radius:.6rem;font-size:.74rem;background:var(--chip);border:1px dashed color-mix(in oklab, var(--line) 70%, transparent 30%);color:color-mix(in oklab, var(--brand2) 65%, var(--ink) 35%)}
    .kpi{background:color-mix(in oklab, var(--panel) 95%, white 5%);border:1px solid color-mix(in oklab, var(--line) 80%, transparent 20%);border-radius:.8rem;padding:.6rem}
    .muted{color:var(--muted)}
    .prose :where(table){width:100%;border-collapse:collapse}
    .prose :where(th,td){border:1px solid color-mix(in oklab, var(--line) 80%, transparent 20%);padding:.6rem;vertical-align:top}
    .prose :where(th){background:var(--th)}
    .fixed-actions{position:fixed; bottom:16px; inset-inline-end:16px; z-index:50; display:flex; gap:8px; flex-wrap:wrap}
    .avatar{position:fixed; bottom:16px; inset-inline-start:16px; z-index:40; display:flex; align-items:flex-end; gap:10px; pointer-events:none}
    .avatar .bubble{max-width:360px;background:var(--panel);border:1px solid var(--line);padding:.7rem .95rem;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.18)}
    .avatar .face{pointer-events:auto; width:56px;height:56px;border-radius:50%;background:
        radial-gradient(45% 55% at 40% 35%, #fff, #e9edf2) padding-box,
        radial-gradient(60% 80% at 65% 65%, color-mix(in oklab, var(--brand) 40%, #fff 60%), color-mix(in oklab, var(--brand2) 40%, #fff 60%)) border-box;
      border:2px solid color-mix(in oklab, var(--brand) 40%, var(--brand2) 60%); display:grid;place-items:center;box-shadow:0 4px 12px rgba(0,0,0,.2); position:relative; overflow:hidden;}
    .avatar .eyes{width:28px;height:10px;border-radius:10px;background:linear-gradient(90deg,#222,#000,#222); position:absolute; top:22px; left:50%; transform:translateX(-50%)}
    .typing{display:inline-flex;gap:4px}
    .typing span{width:6px;height:6px;border-radius:50%;background:color-mix(in oklab, var(--ink) 70%, var(--muted) 30%);animation:blink 1s infinite}
    .typing span:nth-child(2){animation-delay:.2s}.typing span:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
    @media (max-width:520px){.avatar .bubble{max-width:72vw}}
    @media print{ .no-print, header, .fixed-actions, .avatar, #themeToggle {display:none!important}
      body{background:#fff;color:#000}
      .panel,.glass{background:#fff;border:none}
      table{page-break-inside:avoid}
    }
  </style>
</head>
<body class="font-ar">
  <!-- Header -->
  <header class="glass sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-600 to-cyan-500 text-white grid place-items-center font-extrabold">AI</div>
        <div class="leading-tight">
          <div class="text-xs muted">Personal Coaching</div>
          <div class="font-extrabold">Smart Plan</div>
          <div class="text-[11px] muted">Nutrition â€¢ Training â€¢ Compliance</div>
        </div>
      </div>
      <div class="flex items-center gap-2 no-print">
        <div class="inline-flex bg-[color:var(--chip)] border border-[color:var(--line)] rounded-xl overflow-hidden">
          <button id="btn-lang-ar" class="px-3 py-2 text-sm font-bold">AR</button>
          <button id="btn-lang-en" class="px-3 py-2 text-sm font-bold">EN</button>
        </div>
        <button id="themeToggle" class="btn btn-ghost" title="Theme">â˜€ï¸/ğŸŒ™</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 mt-6">
    <div class="glass rounded-2xl p-6 relative overflow-hidden">
      <div class="absolute -top-10 -left-10 w-56 h-56 rounded-full bg-gradient-to-br from-violet-600/25 to-cyan-500/25 blur-2xl"></div>
      <div class="absolute -bottom-10 -right-10 w-56 h-56 rounded-full bg-gradient-to-br from-cyan-500/18 to-violet-600/18 blur-2xl"></div>
      <div class="relative grid lg:grid-cols-[1.1fr,.9fr] gap-6 items-center">
        <div>
          <h1 id="hero-title" class="text-3xl sm:text-4xl font-extrabold">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ â€” Ø®Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©</h1>
          <p id="hero-sub" class="muted mt-1">
            Ø®Ø·Ø© Ù…Ø®ØµØµØ© ÙƒØ§Ù…Ù„Ø©: Ù§ Ø£ÙŠØ§Ù… ØªØºØ°ÙŠØ©ØŒ Ù§ Ø£ÙŠØ§Ù… ØªØ¯Ø±ÙŠØ¨ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù…Ø³ØªÙˆØ§ÙƒØŒ Ù…ÙƒÙ…Ù„Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©ØŒ ÙˆØ¯Ù„ÙŠÙ„ ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ø¶Ø­. 
          </p>
        </div>
        <div class="panel rounded-2xl p-4">
          <div class="text-xs muted mb-2" id="kpi-title">Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
          <div class="grid grid-cols-3 gap-3 text-center">
            <div class="kpi"><div class="text-[11px] muted">TDEE</div><div id="kpi-tdee" class="font-extrabold">â€”</div></div>
            <div class="kpi"><div class="text-[11px] muted">Protein</div><div id="kpi-P" class="font-extrabold">â€”</div></div>
            <div class="kpi"><div class="text-[11px] muted">Carbs</div><div id="kpi-C" class="font-extrabold">â€”</div></div>
          </div>
          <div class="mt-3">
            <div class="h-2 bg-[color:var(--chip)] rounded-full overflow-hidden">
              <div id="bar" class="h-full bg-gradient-to-r from-violet-600 to-cyan-500 w-0 transition-all duration-300"></div>
            </div>
            <div class="text-[11px] muted mt-1">Step <span id="step">1</span> / <span id="stepsTotal">5</span></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 mt-6 grid xl:grid-cols-[minmax(0,1fr),420px] gap-6">
    <!-- Form Panel -->
    <section class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="text-sm chip muted">AR/EN â€¢ PDF/Print â€¢ Responsive</div>
        <div class="text-xs chip">Powered by Mustafa Elsafy 2025</div>
      </div>
      <div id="stage"></div>
      <div id="controls" class="mt-6 flex gap-2">
        <button id="btn-prev" class="btn btn-soft flex-1">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button id="btn-next" class="btn btn-primary flex-1">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </section>

    <!-- Live Summary -->
    <aside class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <div id="live-title" class="text-sm font-bold">Ù…Ù„Ø®Øµ ÙÙˆØ±ÙŠ</div>
        <span id="lang-badge" class="chip">AR</span>
      </div>
      <div id="live" class="mt-3 space-y-2 text-sm"></div>
      <div class="mt-3 text-[11px] muted">* Ù§ Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø©ØŒ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø§ÙƒØ±ÙˆØ² ÙŠÙˆÙ…ÙŠÙ‹Ø§ (Â±1%).</div>
    </aside>
  </main>

  <!-- Result -->
  <section id="result" class="max-w-7xl mx-auto px-4 sm:px-6 mt-6 mb-20 hidden">
    <article class="glass rounded-2xl p-6" id="resultRoot">
      <div class="flex items-center justify-between">
        <h2 id="plan-title" class="text-2xl font-extrabold">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
        <!-- Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ø¦Ù…Ø© Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ø£ÙŠØ¶Ø§Ù‹ -->
      </div>
      <div id="welcome" class="mt-3 text-sm">
        <div class="kpi">
          <b id="welcome-title">ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø·Ø© ØªÙ†ÙÙŠØ°ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø© ÙˆÙÙ‚ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.</b>
          <div id="welcome-sub" class="muted mt-1">
            ØªØªØ¶Ù…Ù† Ø§Ù„ØªØ´Ø®ÙŠØµØŒ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹ØŒ Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)ØŒ Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„Ù€ Ù§ Ø£ÙŠØ§Ù…ØŒ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª ÙˆÙÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©.
          </div>
        </div>
      </div>
      <div id="audit-banner" class="hidden mt-3"></div>
      <div id="ai-html" class="prose prose-invert rtl:text-right ltr:text-left mt-4"></div>
      <footer class="border-t border-slate-700 mt-6 pt-2 text-[11px] muted flex items-center justify-between">
        <span id="rights">Powered by Mustafa Elsafy 2025</span>
        <span id="foot-note"></span>
      </footer>
    </article>
  </section>

  <!-- Floating Actions (Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„) -->
  <div class="fixed-actions no-print">
    <button id="fab-new" class="btn btn-ghost" title="New Plan">â†»</button>
    <button id="fab-pdf" class="btn btn-ghost" title="Save PDF">PDF</button>
    <button id="fab-print" class="btn btn-primary" title="Print">Print</button>
  </div>

  <!-- Avatar (Ø¯Ø§Ø¦Ù…) -->
  <div class="avatar" id="avatar" aria-live="polite">
    <div class="face"><div class="eyes"></div></div>
    <div class="bubble" id="avatarBubble">Ù…Ø±Ø­Ø¨Ø§Ù‹. Ø£Ø¯Ø®Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ø¯Ù‚Ø© â€” Ø³Ù†Ù†ØªØ¬ Ø®Ø·Ø© ÙˆØ§Ø¶Ø­Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ°.</div>
  </div>

  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);
    const safe = (fn, fb=()=>{}) => (...a)=>{ try{ return fn(...a);}catch(e){ console.error(e); return fb(); } };

    /* ===== Theme ===== */
    const themeBtn=$('themeToggle');
    function applyTheme(t){ document.documentElement.setAttribute('data-theme',t); localStorage.setItem('theme',t); themeBtn.textContent=(t==='dark'?'â˜€ï¸':'ğŸŒ™'); }
    applyTheme(localStorage.getItem('theme')||'dark');
    themeBtn && (themeBtn.onclick=()=>applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'));

    /* ===== Language Packs ===== */
    const L={
      ar:{ ui:{
        title:'Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ â€” Ø®Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©', live:'Ù…Ù„Ø®Øµ ÙÙˆØ±ÙŠ',
        steps:['Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©','Ø§Ù„Ø£Ù‡Ø¯Ø§Ù â€¢ Ø§Ù„Ù†Ø¸Ø§Ù… â€¢ Ø§Ù„ØµÙŠØ§Ù…','Ø§Ù„ØµØ­Ø© â€¢ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© â€¢ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©','Ø§Ù„Ø®Ø¨Ø±Ø© â€¢ Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª â€¢ Ø§Ù„ØªØ±ÙƒÙŠØ²','Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©'],
        next:'Ø§Ù„ØªØ§Ù„ÙŠ', prev:'Ø§Ù„Ø³Ø§Ø¨Ù‚', submit:'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¢Ù†',
        name:'Ø§Ù„Ø§Ø³Ù…', age:'Ø§Ù„Ø¹Ù…Ø±', height:'Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)', weight:'Ø§Ù„ÙˆØ²Ù† (ÙƒØº)', gender:'Ø§Ù„Ø¬Ù†Ø³', male:'Ø°ÙƒØ±', female:'Ø£Ù†Ø«Ù‰',
        job:'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ (PAL)', jobVals:['Ù…ÙƒØªØ¨ÙŠ Ø¬Ø¯Ù‹Ø§ (PAL 1.15)','Ù…ÙƒØªØ¨ÙŠ/Ø®ÙÙŠÙ (PAL 1.25)','Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø· (PAL 1.4)','Ù†Ø´Ø§Ø· Ø¹Ø§Ù„Ù (PAL 1.6)'],
        goals:['Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†','Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª','Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©','ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„','ØµØ­Ø© Ø¹Ø§Ù…Ø©'],
        meals:'Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª/Ø§Ù„ÙŠÙˆÙ…', diet:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ', diets:['Ù…ØªÙˆØ§Ø²Ù†','Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª','ÙƒÙŠØªÙˆ','Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·','Ù†Ø¨Ø§ØªÙŠ'],
        fasting:'Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹', enable:'ØªÙØ¹ÙŠÙ„', protocol:'Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„',
        window:'Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙƒÙ„', from:'Ù…Ù†', to:'Ø¥Ù„Ù‰',
        training_place:'Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨', placeVals:['Ù†Ø§Ø¯ÙŠ ÙƒØ§Ù…Ù„','Ù…Ù†Ø²Ù„ + Ø¯Ø§Ù…Ø¨Ù„Ø²','Ù…Ù†Ø²Ù„ ÙˆØ²Ù† Ø§Ù„Ø¬Ø³Ù…'],
        equipment:'Ù…Ø¹Ø¯Ø§Øª Ù…ØªÙˆÙØ±Ø©', equipPH:'Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
        sleep:'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù†ÙˆÙ…', stress:'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙˆØªØ±', stressVals:['Ù…Ù†Ø®ÙØ¶','Ù…ØªÙˆØ³Ø·','Ù…Ø±ØªÙØ¹'],
        cuisine:'Ø§Ù„Ù…Ø·Ø¨Ø® Ø§Ù„Ù…ÙØ¶Ù„', cuisineVals:['Ø¹Ø±Ø¨ÙŠ','Ù…ØªÙˆØ³Ø·ÙŠ','Ø¢Ø³ÙŠÙˆÙŠ','ØºØ±Ø¨ÙŠ','Ù‡Ù†Ø¯ÙŠ','Ù…ØªÙ†ÙˆØ¹'],
        budget:'Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø·Ø¹Ø§Ù…', budgetVals:['Ø§Ù‚ØªØµØ§Ø¯ÙŠ','Ù‚ÙŠØ§Ø³ÙŠ','Ù…Ø±Ù†'],
        dislikes:'Ø£Ø·Ø¹Ù…Ø© ØºÙŠØ± Ù…ÙØ¶Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
        health:'Ø­Ø§Ù„Ø§Øª ØµØ­ÙŠØ©', healthVals:['Ø¶ØºØ· Ø§Ù„Ø¯Ù…','Ø§Ù„Ø³ÙƒØ±ÙŠ','Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†','Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©','Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ','Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©','Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù‡Ø¶Ù…ÙŠ'],
        meds:'Ø£Ø¯ÙˆÙŠØ© (Ø¥Ù† ÙˆØ¬Ø¯Øª)',
        allergies:'Ø­Ø³Ø§Ø³ÙŠØ§Øª', allergyVals:['Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†','Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²','Ø§Ù„Ù…ÙƒØ³Ø±Ø§Øª','Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ©','Ø§Ù„Ø¨Ù‚ÙˆÙ„ÙŠØ§Øª','Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©','Ø§Ù„Ø²ÙŠÙˆØª Ø§Ù„Ù†Ø¨Ø§ØªÙŠØ©'],
        injuries:'Ø¥ØµØ§Ø¨Ø§Øª (Ø§Ø°ÙƒØ± Ø§Ù„Ù…ÙƒØ§Ù† ÙˆØ§Ù„ÙˆØµÙ)',
        exp:'Ø®Ø¨Ø±Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©', expVals:['Ù…Ø¨ØªØ¯Ø¦','Ù…ØªÙˆØ³Ø·','Ù…ØªÙ‚Ø¯Ù…'],
        weak:'Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ±ÙƒÙŠØ² (Ø¹Ø¶Ù„Ø©: Ù‡Ø¯Ù)', weakPH:'ØµØ¯Ø±: Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø£Ø¹Ù„Ù‰Ø› Ø¸Ù‡Ø±: ÙƒØ«Ø§ÙØ©â€¦',
        days:'Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨/Ø£Ø³Ø¨ÙˆØ¹', detail:'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙØµÙŠÙ„',
        building:'Ù†Ø­Ù† Ù†Ø¬Ù‡Ù‘Ø² Ø¬Ø¯Ø§ÙˆÙ„ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØªØ¹Ù„ÙŠÙ…Ø§Øª ÙˆØ§Ø¶Ø­Ø© â€” Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.',
        apiFail:'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ â€” ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø© Ù…Ø­Ù„ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©.',
        err:'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©',
        print:'Ø·Ø¨Ø§Ø¹Ø©',
        pdf:'Ø­ÙØ¸ PDF',
        hello:'Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø¯Ù‚Ø© Ù„Ù†Ù†ØªØ¬ Ø®Ø·Ø© ÙˆØ§Ø¶Ø­Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚.',
        good:'ØªÙ… Ø§Ù„Ø­ÙØ¸ â€” ØªØ§Ø¨Ø¹.',
        back:'ØªÙ… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø®Ø·ÙˆØ©.',
        ready:'Ø§Ù„Ø®Ø·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø­ÙØ¸.',
        rights:'Powered by Mustafa Elsafy 2025'
      }},
      en:{ ui:{
        title:'Personal Coach â€” Precise Final Plan', live:'Live Summary',
        steps:['Advanced Basics','Goals â€¢ Diet â€¢ IF','Health â€¢ Allergies â€¢ Meds','Experience â€¢ Injuries â€¢ Focus','Generate Plan'],
        next:'Next', prev:'Back', submit:'Generate Plan Now',
        name:'Name', age:'Age', height:'Height (cm)', weight:'Weight (kg)', gender:'Gender', male:'Male', female:'Female',
        job:'Daily activity (PAL)', jobVals:['Very desk (PAL 1.15)','Desk/Light (PAL 1.25)','Moderate (PAL 1.4)','High (PAL 1.6)'],
        goals:['Fat loss','Muscle gain','Strength','Endurance','General health'],
        meals:'Meals/day', diet:'Preferred diet', diets:['Balanced','Low-Carb','Keto','Mediterranean','Plant-based'],
        fasting:'Intermittent Fasting', enable:'Enable', protocol:'Protocol',
        window:'Feeding window', from:'from', to:'to',
        training_place:'Training place', placeVals:['Full gym','Home + dumbbells','Home bodyweight'],
        equipment:'Available equipment', equipPH:'List available equipment (optional)',
        sleep:'Sleep hours', stress:'Stress level', stressVals:['Low','Moderate','High'],
        cuisine:'Preferred cuisine', cuisineVals:['Arabic','Mediterranean','Asian','Western','Indian','Mixed'],
        budget:'Food budget', budgetVals:['Budget','Standard','Flexible'],
        dislikes:'Disliked foods (optional)',
        health:'Health conditions', healthVals:['Hypertension','Diabetes','Insulin Resistance','Thyroid','Fatty Liver','Hormonal issues','GI issues'],
        meds:'Medications (if any)',
        allergies:'Allergies', allergyVals:['Gluten','Lactose','Nuts','Seafood','Legumes','Added sugars','Vegetable oils'],
        injuries:'Injuries (location & description)',
        exp:'Resistance experience', expVals:['Beginner','Intermediate','Advanced'],
        weak:'Focus points (muscle: goal)', weakPH:'Chest: upper; Back: densityâ€¦',
        days:'Training days/week', detail:'Detail level',
        building:'Assembling precise tables and clear guidance â€” please wait.',
        apiFail:'Model unreachable â€” local precise plan generated.',
        err:'Please complete required fields',
        print:'Print',
        pdf:'Save PDF',
        hello:'Provide accurate inputs; weâ€™ll produce a clear, actionable plan.',
        good:'Saved â€” continue.',
        back:'Step back.',
        ready:'Plan is ready for print and PDF.',
        rights:'Powered by Mustafa Elsafy 2025'
      }}
    };

    // State
    const content=$('stage'), live=$('live'), bar=$('bar'), stepSpan=$('step'), stepsTotal=$('stepsTotal');
    const kTDEE=$('kpi-tdee'), kP=$('kpi-P'), kC=$('kpi-C');
    const avatarBubble = $('avatarBubble');
    let lang='ar', step=0, total=5;
    stepsTotal.textContent=String(total);

    const user={
      name:'', age:'', height:'', weight:'', gender:'Male',
      pal:'1.25', jobLabel:'Desk/Light (PAL 1.25)',
      goals:[], meals:4, diet:(lang==='ar'?'Ù…ØªÙˆØ§Ø²Ù†':'Balanced'),
      fasting:{enabled:false, protocol:'16:8', start:'12:00', end:'20:00'},
      training_place:'Full gym', equipment:'',
      sleep:7, stress:(lang==='ar'?'Ù…ØªÙˆØ³Ø·':'Moderate'),
      cuisine:(lang==='ar'?'Ù…ØªÙ†ÙˆØ¹':'Mixed'), budget:(lang==='ar'?'Ù‚ÙŠØ§Ø³ÙŠ':'Standard'),
      dislikes:'',
      health:[], meds:'',
      allergies:[], injuries:'',
      exp:(lang==='ar'?'Ù…Ø¨ØªØ¯Ø¦':'Beginner'), weak_points:{},
      detail:'max', train_days:7
    };

    // Helpers
    function speak(text){ if(!avatarBubble) return; avatarBubble.innerHTML=text; }
    function T(k){ return L[lang].ui[k]; }
    function parsePAL(label){ const m=String(label).match(/PAL\s*([0-9.]+)/); return m? parseFloat(m[1]) : 1.25; }

    function applyLang(l){
      lang=l; document.documentElement.lang=l; document.documentElement.dir=(l==='ar'?'rtl':'ltr');
      document.body.classList.toggle('font-ar',l==='ar'); document.body.classList.toggle('font-en',l!=='ar');
      $('lang-badge').textContent=l.toUpperCase();
      $('hero-title').textContent=T('title');
      $('live-title').textContent=T('live');
      $('plan-title').textContent=(l==='ar'?'Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©':'The Comprehensive Plan');
      $('rights').textContent=T('rights');
      $('btn-prev').textContent=T('prev'); $('btn-next').textContent=(step===total-1?T('submit'):T('next'));
      speak(L[lang].ui.hello);
      renderStep(); updateLive(); updateKPIs();
    }

    // Calculations
    function calc(){
      const W=+user.weight||0, H=+user.height||0, A=+user.age||0, male=(user.gender==='Male');
      const BMR = male? 10*W+6.25*H-5*A+5 : 10*W+6.25*H-5*A-161;
      const pal = parsePAL(user.jobLabel||'PAL 1.25');
      let TDEE=BMR*pal;
      if(user.goals.some(g=>/Fat|Ø¯Ù‡ÙˆÙ†/.test(g))) TDEE*=0.86;
      if(user.goals.some(g=>/Muscle|Ø¹Ø¶Ù„Ø§Øª/.test(g))) TDEE*=1.10;
      const P=Math.round(2.0*(+user.weight||1));
      const F=Math.round(Math.max(0,0.8*(+user.weight||1)));
      let C=Math.round((TDEE-(P*4+F*9))/4);
      if(user.health.some(h=>/Diab|Ø§Ù„Ø³ÙƒØ±ÙŠ|Insulin|Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†/.test(h))) C=Math.min(C,120);
      C=Math.max(0,C);
      return {TDEE:Math.round(TDEE),P,F,C};
    }
    function updateKPIs(){ const c=calc(); kTDEE.textContent=c.TDEE; kP.textContent=c.P+' g'; kC.textContent=c.C+' g'; }
    function updateProgress(){ bar.style.width=(((step+1)/total)*100)+'%'; stepSpan.textContent=String(step+1); }
    function updateButtons(){ $('btn-prev').disabled=(step===0); $('btn-next').textContent=(step===total-1?T('submit'):T('next')); }

    function updateLive(){
      const c=calc();
      const g=(user.goals||[]).join(lang==='ar'?'ØŒ ':', ')||'â€”';
      live.innerHTML=`
        <div class="text-xs muted">${T('name')}: <b>${user.name||'â€”'}</b></div>
        <div class="grid grid-cols-3 gap-2 text-xs">
          <div class="kpi"><div class="muted">${T('age')}</div><b>${user.age||'â€”'}</b></div>
          <div class="kpi"><div class="muted">${T('height')}</div><b>${user.height||'â€”'}</b></div>
          <div class="kpi"><div class="muted">${T('weight')}</div><b>${user.weight||'â€”'}</b></div>
        </div>
        <div class="text-xs muted">${lang==='ar'?'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù':'Goals'}: <b>${g}</b></div>
        <div class="text-xs muted">${T('diet')}: <b>${user.diet}</b> â€” ${T('meals')}: <b>${user.meals}</b></div>
        <div class="grid grid-cols-3 gap-2 text-xs mt-2">
          <div class="kpi"><div>${lang==='ar'?'Ø§Ù„Ø³Ø¹Ø±Ø§Øª':'Calories'}</div><b>${c.TDEE} kcal</b></div>
          <div class="kpi"><div>${lang==='ar'?'Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†':'Protein'}</div><b>${c.P} g</b></div>
          <div class="kpi"><div>${lang==='ar'?'Ø§Ù„ÙƒØ§Ø±Ø¨':'Carbs'}</div><b>${c.C} g</b></div>
        </div>`;
    }

    // UI fields
    function field(label,id,opt={}){ const {type='text',value='',select=null,rows=3,placeholder=''}=opt;
      if(select){ return `<label class="block"><span class="text-sm">${label}</span>
        <select id="${id}" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]">
          ${select.map(o=>`<option value="${o.value}" ${String(value)===String(o.value)?'selected':''}>${o.label}</option>`).join('')}
        </select></label>`;}
      if(type==='textarea'){ return `<label class="block"><span class="text-sm">${label}</span>
        <textarea id="${id}" rows="${rows}" placeholder="${placeholder}" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]">${value||''}</textarea></label>`;}
      return `<label class="block"><span class="text-sm">${label}</span>
        <input id="${id}" type="${type}" value="${value}" placeholder="${placeholder}" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]"/></label>`;
    }
    function chips(name,arr,checked=[]){
      return `<div class="flex flex-wrap gap-2">${arr.map(v=>`
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)] cursor-pointer">
          <input type="checkbox" name="${name}" value="${v}" class="accent-violet-600" ${checked.includes(v)?'checked':''}/>
          <span class="text-sm">${v}</span></label>`).join('')}</div>`;
    }

    // Steps
    function renderStep(){
      updateProgress(); updateButtons();
      const U=L[lang].ui;
      if(step===0){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[0]}</h3>
          <div class="grid md:grid-cols-3 gap-4">
            ${field(U.name,'name',{value:user.name})}
            ${field(U.gender,'gender',{select:[{value:'Male',label:U.male},{value:'Female',label:U.female}],value:user.gender})}
            ${field(U.age,'age',{type:'number',value:user.age})}
            ${field(U.height,'height',{type:'number',value:user.height})}
            ${field(U.weight,'weight',{type:'number',value:user.weight})}
            <label class="block md:col-span-2"><span class="text-sm">${U.job}</span>
              <select id="job" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]">
                ${U.jobVals.map((lbl,i)=>`<option ${i===1?'selected':''}>${lbl}</option>`).join('')}
              </select>
            </label>
            ${field(U.sleep,'sleep',{type:'number',value:user.sleep})}
            ${field(U.stress,'stress',{select:U.stressVals.map(v=>({value:v,label:v})),value:user.stress})}
            ${field(U.training_place,'training_place',{select:U.placeVals.map(v=>({value:v,label:v})),value:user.training_place})}
            ${field(U.equipment,'equipment',{placeholder:U.equipPH,value:user.equipment})}
          </div>`;
      } else if(step===1){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[1]}</h3>
          <div class="space-y-4">
            <div><div class="text-sm mb-1">${lang==='ar'?'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù':'Goals'}</div>${chips('goal',U.goals,user.goals)}</div>
            <div class="grid md:grid-cols-3 gap-4">
              ${field(U.meals,'meals',{select:[{value:3,label:'3'},{value:4,label:'4'},{value:5,label:'5'}],value:user.meals})}
              ${field(U.diet,'diet',{select:U.diets.map(d=>({value:d,label:d})),value:user.diet})}
              <label class="block">
                <span class="text-sm">${U.fasting} â€” ${U.enable}</span>
                <input id="fasting_enabled" type="checkbox" class="accent-violet-600 ml-2" ${user.fasting.enabled?'checked':''}/>
              </label>
            </div>
            <div id="ifWrap" class="grid md:grid-cols-3 gap-4">
              ${field(U.protocol,'fasting_protocol',{select:['14:10','16:8','18:6','20:4'].map(x=>({value:x,label:x})),value:user.fasting.protocol})}
              <label><span class="text-sm">${U.window} ${U.from}</span><input id="fasting_start" type="time" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]" value="${user.fasting.start}"/></label>
              <label><span class="text-sm">${U.window} ${U.to}</span><input id="fasting_end" type="time" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]" value="${user.fasting.end}"/></label>
            </div>
            ${field(U.dislikes,'dislikes',{placeholder:(lang==='ar'?'Ù…Ø«Ø§Ù„: Ø§Ù„ÙƒØ¨Ø¯Ø©ØŒ Ø§Ù„Ù‚Ø±Ù†Ø¨ÙŠØ·':'e.g., liver, cauliflower'),value:user.dislikes})}
          </div>`;
      } else if(step===2){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[2]}</h3>
          <div class="space-y-4">
            <div><div class="text-sm mb-1">${U.health}</div>${chips('health',U.healthVals,user.health)}</div>
            ${field(U.meds,'meds',{type:'textarea',rows:2,placeholder:'Metformin, Thyroxineâ€¦',value:user.meds})}
            <div><div class="text-sm mb-1">${U.allergies}</div>${chips('all',U.allergyVals,user.allergies)}</div>
          </div>`;
      } else if(step===3){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[3]}</h3>
          <div class="grid md:grid-cols-3 gap-4">
            ${field(U.exp,'exp',{select:U.expVals.map(x=>({value:x,label:x})),value:user.exp})}
            ${field(U.injuries,'injuries',{type:'textarea',rows:2,placeholder: lang==='ar'?'Ù…Ø«Ø§Ù„: Ø£Ù„Ù… Ø£Ø³ÙÙ„ Ø§Ù„Ø¸Ù‡Ø±':'e.g., Lower-back pain',value:user.injuries})}
            <label class="md:col-span-2"><span class="text-sm">${U.weak}</span>
              <input id="weak_raw" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]" placeholder="${U.weakPH}">
            </label>
          </div>`;
      } else {
        content.innerHTML=`
          <div class="text-center py-8">
            <div class="text-sm muted mb-2">${U.building}</div>
            <div class="w-12 h-12 rounded-full border-4 border-violet-600 border-t-transparent animate-spin mx-auto"></div>
            <div class="mt-2 text-xs muted" id="buildTimer">â€¦</div>
          </div>`;
      }
    }

    function saveStep(){
      try{
        if(step===0){
          user.name=$('name').value.trim(); user.gender=$('gender').value;
          user.age=+$('age').value; user.height=+$('height').value; user.weight=+$('weight').value;
          user.jobLabel=$('job').value; user.pal=String(parsePAL(user.jobLabel));
          user.sleep=+$('sleep').value; user.stress=$('stress').value;
          user.training_place=$('training_place').value; user.equipment=$('equipment').value;
          if(!user.name||!user.age||!user.height||!user.weight) throw 0;
        } else if(step===1){
          user.goals=[...document.querySelectorAll('input[name="goal"]:checked')].map(e=>e.value);
          user.meals=+$('meals').value; user.diet=$('diet').value; user.dislikes=$('dislikes').value||'';
          user.fasting.enabled=$('fasting_enabled').checked;
          user.fasting.protocol=$('fasting_protocol').value; user.fasting.start=$('fasting_start').value; user.fasting.end=$('fasting_end').value;
          if(!user.goals.length) throw 0;
        } else if(step===2){
          user.health=[...document.querySelectorAll('input[name="health"]:checked')].map(e=>e.value);
          user.meds=$('meds').value||''; user.allergies=[...document.querySelectorAll('input[name="all"]:checked')].map(e=>e.value);
        } else if(step===3){
          user.exp=$('exp').value;
          const raw=$('weak_raw').value.trim(); user.weak_points={};
          if(raw){ raw.split(';').forEach(pair=>{ const [k,...r]=pair.split(':'); const v=r.join(':').trim(); if(k&&v) user.weak_points[k.trim()]=v; }); }
        }
        updateLive(); return true;
      }catch{ toast(L[lang].ui.err,'err'); return false; }
    }

    // Plan JSON builders
    function targetMacros(){ const c=calc(); return {kcal:c.TDEE, protein_g:c.P, fat_g:c.F, carb_g:c.C}; }
    function within1pct(a,t){ const p=(x,y)=>Math.abs(x-y)/Math.max(1,y); return p(a.kcal,t.kcal)<=0.01 && p(a.protein_g,t.protein_g)<=0.01 && p(a.fat_g,t.fat_g)<=0.01 && p(a.carb_g,t.carb_g)<=0.01; }

    function localNutrition(target, meals, day){
      const P=target.protein_g, F=target.fat_g, C=target.carb_g;
      const pShare=[0.25,0.2,0.2,0.2,0.15].slice(0,meals);
      const fShare=[0.25,0.2,0.2,0.2,0.15].slice(0,meals);
      const cShare=[0.25,0.2,0.25,0.2,0.1].slice(0,meals);
      const prot=['ØµØ¯ÙˆØ± Ø¯Ø¬Ø§Ø¬','Ù„Ø­Ù… Ø®Ø§Ù„ÙŠ','Ø³Ù„Ù…ÙˆÙ†','ØªÙˆÙ†Ø©','Ø¨ÙŠØ¶','Greek yogurt','Turkey'];
      const carb=['Ø£Ø±Ø²','Ø¨Ø·Ø§Ø·Ø³','ÙƒÙŠÙ†ÙˆØ§','Ø´ÙˆÙØ§Ù†','Ø®Ø¨Ø² ÙƒØ§Ù…Ù„','Ø¨Ø±ØºÙ„','ÙÙˆØ§ÙƒÙ‡'];
      const fat =['Ø²ÙŠØª Ø²ÙŠØªÙˆÙ†','Ø£ÙÙˆÙƒØ§Ø¯Ùˆ','Ù…ÙƒØ³Ø±Ø§Øª','Ø·Ø­ÙŠÙ†Ø©','Ø²ÙŠØª Ø¬ÙˆØ² Ø§Ù„Ù‡Ù†Ø¯'];
      const list=[]; for(let i=0;i<meals;i++){
        const p=Math.round(P*pShare[i]); const f=Math.round(F*fShare[i]); const c=Math.round(C*cShare[i]);
        list.push({index:i+1,name:(lang==='ar'?'ÙˆØ¬Ø¨Ø© ':'Meal ')+(i+1),items:[
          {name:prot[(day+i)%prot.length],qty:p*7,unit:'g'},
          {name:carb[(day*2+i)%carb.length],qty:c*8,unit:'g'},
          {name:fat[i%fat.length],qty:Math.max(5,Math.round(f*3)),unit:'g'}
        ],protein_g:p,fat_g:f,carb_g:c,kcal:p*4+f*9+c*4});
      }
      const tot=list.reduce((t,m)=>({P:t.P+m.protein_g,F:t.F+m.fat_g,C:t.C+m.carb_g,K:t.K+m.kcal}),{P:0,F:0,C:0,K:0});
      return {day, meals:list, total:{protein_g:tot.P,fat_g:tot.F,carb_g:tot.C,kcal:tot.K}};
    }
    function localTraining(day){
      const level=user.exp;
      const blocksByLevel={
        'Beginner':[
          {exercise:'Goblet Squat',sets:4,reps:'10-12',tempo:'3010',rest_s:90,rir:2},
          {exercise:'Push-Up',sets:4,reps:'8-12',tempo:'2110',rest_s:90,rir:2},
          {exercise:'DB Row',sets:4,reps:'10-12',tempo:'3011',rest_s:90,rir:2},
          {exercise:'DB RDL',sets:3,reps:'10',tempo:'3010',rest_s:90,rir:2},
          {exercise:'Plank',sets:3,reps:'45-60s',tempo:'â€”',rest_s:60,rir:1}
        ],
        'Intermediate':[
          {exercise:'Back Squat',sets:5,reps:'5-8',tempo:'3010',rest_s:120,rir:2},
          {exercise:'Bench Press',sets:5,reps:'6-8',tempo:'2110',rest_s:120,rir:2},
          {exercise:'Bent Over Row',sets:4,reps:'8-10',tempo:'3011',rest_s:90,rir:2},
          {exercise:'RDL',sets:4,reps:'8-10',tempo:'3110',rest_s:120,rir:2},
          {exercise:'Hanging Leg Raise',sets:3,reps:'10-12',tempo:'2010',rest_s:60,rir:1}
        ],
        'Advanced':[
          {exercise:'Back Squat (heavy)',sets:5,reps:'3-5',tempo:'30X0',rest_s:180,rir:2},
          {exercise:'Bench Press (pause)',sets:5,reps:'4-6',tempo:'21X0',rest_s:180,rir:2},
          {exercise:'Weighted Pull-Up',sets:5,reps:'5-8',tempo:'30X0',rest_s:150,rir:2},
          {exercise:'RDL (heavy)',sets:4,reps:'5-6',tempo:'31X0',rest_s:180,rir:2},
          {exercise:'Pallof Press',sets:3,reps:'12-15',tempo:'2010',rest_s:60,rir:1}
        ]
      };
      return {day, blocks: blocksByLevel[level] || blocksByLevel['Beginner']};
    }
    function buildLocalJSON(){
      const target=targetMacros(); const nutrition=[],training=[];
      for(let d=1; d<=7; d++){ nutrition.push(localNutrition(target, user.meals, d)); training.push(localTraining(d)); }
      const supplementsCore=[
        {name:(lang==='ar'?'Ø¨Ø±ÙˆØªÙŠÙ† ÙˆØ§ÙŠ':'Whey Protein'),dose:(lang==='ar'?'20â€“40 Ø¬Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†':'20â€“40 g post-workout')},
        {name:(lang==='ar'?'ÙƒØ±ÙŠØ§ØªÙŠÙ† Ù…ÙˆÙ†ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª':'Creatine Monohydrate'),dose:'5 g daily'},
        {name:'Omega-3 (EPA/DHA)',dose:'1â€“2 g combined'},
        {name:'Vitamin D3',dose:'2000 IU daily'},
        {name:(lang==='ar'?'Ù…ØºÙ†ÙŠØ³ÙŠÙˆÙ…':'Magnesium'),dose:'200â€“400 mg nightly'}
      ];
      const cond=[];
      if(user.health.some(h=>/Ø¶ØºØ·|Hyperten|Hypert/.test(h))) cond.push({name:'CoQ10',dose:'100â€“200 mg',note:(lang==='ar'?'Ù‚Ø¯ ÙŠÙÙŠØ¯ Ø¶ØºØ· Ø§Ù„Ø¯Ù… â€” Ø¨Ø¹Ø¯ Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨':'may support BP â€” consult physician')});
      if(user.health.some(h=>/Diab|Ø§Ù„Ø³ÙƒØ±ÙŠ|Insulin/.test(h))) cond.push({name:'Berberine',dose:'500 mg x2',note:(lang==='ar'?'Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø¥Ù†Ø³ÙˆÙ„ÙŠÙ† â€” Ø¨Ø¹Ø¯ Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨':'insulin sensitivity â€” consult physician')});
      return {
        client:{name:user.name,lang:(lang==='ar'?'AR':'EN'),goals:user.goals,diet:user.diet,meals_per_day:user.meals,fasting:user.fasting,health:user.health,allergies:user.allergies,injuries:user.injuries,experience:user.exp,focus_points:user.weak_points,training_place:user.training_place,equipment:user.equipment,dislikes:user.dislikes},
        targets:target, nutrition, training,
        supplements:{core:supplementsCore, condition:cond}
      };
    }

    // Rendering result
    function toHTML(md){
      if(window.marked && !window.__NO_MARKED__){
        const html=window.marked.parse(md);
        if(window.DOMPurify && !window.__NO_PURIFY__) return window.DOMPurify.sanitize(html);
        return html;
      }
      return `<div>${md}</div>`;
    }

    function renderPlanHTML(plan){
      const g=(plan.client.goals||[]).join(lang==='ar'?'ØŒ ':', ')||'â€”';
      const allowList=(lang==='ar'
        ? ['Ø¨Ø±ÙˆØªÙŠÙ†Ø§Øª Ø·Ø¨ÙŠØ¹ÙŠØ©','ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª Ù…Ø¹Ù‚Ù‘Ø¯Ø©','Ø¯Ù‡ÙˆÙ† ØµØ­ÙŠØ©','Ø£Ù„ÙŠØ§Ù ÙˆØ®Ø¶Ø±ÙˆØ§Øª','Ù…Ø§Ø¡ ÙƒØ§ÙÙ']
        : ['Whole proteins','Complex carbs','Healthy fats','Fiber & greens','Adequate water']);
      const avoidList=(lang==='ar'
        ? ['Ø³ÙƒØ±ÙŠØ§Øª Ù…Ø¶Ø§ÙØ©','Ø¯Ù‡ÙˆÙ† Ù…Ù‡Ø¯Ø±Ø¬Ø©','Ù…Ù‚Ù„ÙŠØ§Øª Ù…ÙØ±Ø·Ø©','Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø³ÙƒÙ‘Ø±ÙŠØ©','Ø¥ÙØ±Ø§Ø· ÙÙŠ Ø§Ù„Ù…Ø¹Ø¬Ù†Ø§Øª']
        : ['Added sugars','Trans fats','Excess fried food','Sugary drinks','Pastry overload']);

      const intro = (lang==='ar'
        ? `### Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù‡Ø¯Ù
- Ø§Ù„Ù‡Ø¯Ù: **${g}**
- Ø§Ù„Ù†Ø¸Ø§Ù…: **${plan.client.diet}** â€” Ø§Ù„ÙˆØ¬Ø¨Ø§Øª: **${plan.client.meals_per_day}**
- Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹: **${plan.client.fasting.enabled ? plan.client.fasting.protocol : 'ØºÙŠØ± Ù…ÙØ¹Ù„'}**${plan.client.fasting.enabled? ` (Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙƒÙ„: ${plan.client.fasting.start}â€“${plan.client.fasting.end})` : ''}
- Ø®Ø¨Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨: **${plan.client.experience}** â€” Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª: **${plan.client.injuries||'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}**
- Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ±ÙƒÙŠØ²: **${Object.keys(plan.client.focus_points||{}).length? JSON.stringify(plan.client.focus_points): 'â€”'}**`
        : `### Case & Goal
- Goal(s): **${g}**
- Diet: **${plan.client.diet}** â€” Meals/day: **${plan.client.meals_per_day}**
- Intermittent Fasting: **${plan.client.fasting.enabled ? plan.client.fasting.protocol : 'Disabled'}**${plan.client.fasting.enabled? ` (Feeding window: ${plan.client.fasting.start}â€“${plan.client.fasting.end})` : ''}
- Training experience: **${plan.client.experience}** â€” Injuries: **${plan.client.injuries||'None'}**
- Focus notes: **${Object.keys(plan.client.focus_points||{}).length? JSON.stringify(plan.client.focus_points): 'â€”'}**`);

      const rules = (lang==='ar'
        ? `### Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹
**Ø§Ù„Ù…Ø³Ù…ÙˆØ­:** ${allowList.join('ØŒ ')}  
**Ø§Ù„Ù…Ù…Ù†ÙˆØ¹:** ${avoidList.join('ØŒ ')}

### Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†ÙÙŠØ°
- ÙˆØ²Ù‘Ø¹ Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ.
- Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø£Ù„ÙŠØ§Ù ÙˆØ§Ù„Ù…Ø§Ø¡ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø´Ø¨Ø¹ ÙˆØ§Ù„Ù‡Ø¶Ù….
- Ù†Ù… ${user.sleep || 7} Ø³Ø§Ø¹Ø§ØªØŒ ÙˆØ®ÙÙ‘Ø¶ Ø§Ù„ØªÙˆØªØ± Ù‚Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ·Ø§Ø¹.`
        : `### Allowed & Avoid
**Allowed:** ${allowList.join(', ')}  
**Avoid:** ${avoidList.join(', ')}

### Execution Guidance
- Distribute protein evenly across meals.
- Keep fiber/water adequate for satiety and digestion.
- Sleep ${user.sleep || 7} hours; manage stress.`);

      const target = plan.targets;
      const headNut = (lang==='ar'?'### Ø®Ø·Ø© Ø§Ù„ØªØºØ°ÙŠØ© (Ù§ Ø£ÙŠØ§Ù…)':'### Nutrition Plan (7 Days)');
      const headTr  = (lang==='ar'?'### Ø®Ø·Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Ù§ Ø£ÙŠØ§Ù…)':'### Training Plan (7 Days)');

      const daysNut = plan.nutrition.map(d=>{
        const ok = within1pct({kcal:d.total.kcal,protein_g:d.total.protein_g,fat_g:d.total.fat_g,carb_g:d.total.carb_g}, target) && (d.meals||[]).length===plan.client.meals_per_day;
        const title = `${lang==='ar'?'Ø§Ù„ÙŠÙˆÙ…':'Day'} ${d.day} ${ok?'âœ…':''}`;
        const rows = d.meals.map(m=>{
          const items=(m.items||[]).map(it=>`${it.name} ${it.qty}${it.unit||''}`).join(lang==='ar'?' â€¢ ':' â€¢ ');
          return `| ${m.index} | ${m.name} | ${items} | ${m.protein_g} | ${m.fat_g} | ${m.carb_g} | ${m.kcal} |`;
        }).join('\n');
        return `#### ${title}
| # | ${lang==='ar'?'Ø§Ù„ÙˆØ¬Ø¨Ø©':'Meal'} | ${lang==='ar'?'Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª':'Ingredients'} | P | F | C | Kcal |
|---|---|---|---:|---:|---:|---:|
${rows}
**${lang==='ar'?'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ':'Total'} â†’ P:${d.total.protein_g} F:${d.total.fat_g} C:${d.total.carb_g} Kcal:${d.total.kcal}**`;
      }).join('\n\n');

      const daysTr = plan.training.map(d=>{
        const rows = d.blocks.map(b=>`| ${d.day} | ${b.exercise} | ${b.sets} | ${b.reps} | ${b.tempo} | ${b.rest_s} |`).join('\n');
        return `#### ${lang==='ar'?'Ø§Ù„ÙŠÙˆÙ…':'Day'} ${d.day}
| ${lang==='ar'?'Ø§Ù„ÙŠÙˆÙ…':'Day'} | Exercise | Sets | Reps | Tempo | Rest (s) |
|---:|---|---:|---|---|---:|
${rows}`;
      }).join('\n\n');

      const supplements = (()=>{
        const core = (plan.supplements.core||[]).map(s=>`- **${s.name}** â€” ${s.dose}`).join('\n');
        const cond = (plan.supplements.condition||[]).map(s=>`- **${s.name}** â€” ${s.dose}${s.note?` (${s.note})`:''}`).join('\n') || (lang==='ar'?'- Ù„Ø§ Ø¥Ø¶Ø§ÙØ§Øª Ø®Ø§ØµØ©':'- No condition-specific additions');
        return (lang==='ar'
          ? `### Ù…ÙƒÙ…Ù„Ø§Øª Ù…Ø³Ø§Ù†Ø¯Ø©
${core}

### Ù…ÙƒÙ…Ù„Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø­Ø§Ù„Ø© (Ø¨Ø¹Ø¯ Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨)
${cond}`
          : `### Core Supplements
${core}

### Condition-Specific (consult physician)
${cond}`);
      })();

      const ifSection = plan.client.fasting.enabled
        ? (lang==='ar'
          ? `### Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹
- Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„: **${plan.client.fasting.protocol}** â€” Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙƒÙ„: **${plan.client.fasting.start}â€“${plan.client.fasting.end}**  
- Ø±Ø§Ø¹Ù Ø§Ù„Ø£Ø¯ÙˆÙŠØ©/Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© Ø¹Ù†Ø¯ Ø¶Ø¨Ø· Ø§Ù„Ù†Ø§ÙØ°Ø©.`
          : `### Intermittent Fasting
- Protocol: **${plan.client.fasting.protocol}** â€” Feeding window: **${plan.client.fasting.start}â€“${plan.client.fasting.end}**  
- Consider meds/conditions when setting the window.`)
        : '';

      const md = `
${intro}

${rules}

${ifSection}

${headNut}

${daysNut}

${headTr}

${daysTr}

${supplements}

---
${(lang==='ar'
  ? '**ØªÙ†ÙˆÙŠÙ‡:** Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø© Ù…Ø®ØµØµØ© Ø¨Ø­Ø³Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ. Ø§Ù„ØªØ²Ù… Ø¨Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ø³ØªØ´Ø± Ø·Ø¨ÙŠØ¨Ùƒ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.'
  : '**Note:** This plan is tailored to your inputs. Stay safe and consult your physician as needed.')}`;

      return toHTML(md);
    }

    async function callProxy(prompt, timeoutMs=10000){
      const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeoutMs);
      try{
        const r=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt}),signal:ctrl.signal});
        clearTimeout(t);
        if(!r.ok) throw new Error(await r.text());
        const data=await r.json();
        return data && data.text ? data.text : '';
      }catch(e){ clearTimeout(t); return ''; }
    }

    async function generatePlan(){
      $('result').classList.remove('hidden');
      const ai = $('ai-html');
      ai.innerHTML = `<div class="text-center py-8"><div class="w-12 h-12 rounded-full border-4 border-violet-600 border-t-transparent animate-spin mx-auto"></div><div class="mt-2 text-sm muted">${L[lang].ui.building}</div></div>`;
      speak(lang==='ar'?'Ù†Ø¬Ù‡Ù‘Ø² Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª â€” ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.':'Building tables and guidance â€” please wait.');

      const targets = targetMacros();
      const prompt = `
Return JSON ONLY (no code fences). Build a 7-day nutrition + 7-day training matching daily targets within Â±1%.
Schema:
{
 "client":{"goals":[],"diet":"","meals_per_day":0,"fasting":{"enabled":false,"protocol":"","start":"","end":""},"health":[],"allergies":[],"injuries":"","experience":"","focus_points":{},"training_place":"","equipment":"","dislikes":""},
 "targets":{"kcal":0,"protein_g":0,"fat_g":0,"carb_g":0},
 "nutrition":[{"day":1,"meals":[{"index":1,"name":"","items":[{"name":"","qty":0,"unit":"g"}],"protein_g":0,"fat_g":0,"carb_g":0,"kcal":0}],"total":{"protein_g":0,"fat_g":0,"carb_g":0,"kcal":0}}],
 "training":[{"day":1,"blocks":[{"exercise":"","sets":0,"reps":"","tempo":"","rest_s":0}]}],
 "supplements":{"core":[{"name":"","dose":""}],"condition":[{"name":"","dose":"","note":""}]}
}
Constraints:
- meals_per_day must equal ${user.meals}
- Use ${lang==='ar'?'Arabic':'English'} food names, English for exercise names.
- Avoid allergies: ${user.allergies.join(', ')||'none'} and dislikes: ${user.dislikes||'none'}.
- Respect injuries: ${user.injuries||'none'} and experience: ${user.exp}.
- Diet style: ${user.diet}. Fasting: ${user.fasting.enabled? user.fasting.protocol : 'disabled'}.
      `.trim();

      // Ù†Ø­Ø§ÙˆÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø¬ÙˆØ¬Ù„ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø³Ù‚ÙˆØ· Ù…Ø­Ù„ÙŠ
      let raw = await callProxy(prompt);
      let planJSON=null;
      if(raw){
        try{
          let clean=raw.trim().replace(/^```json/,'').replace(/```$/,'');
          planJSON=JSON.parse(clean);
        }catch{ planJSON=null; }
      }
      if(!planJSON){
        toast(L[lang].ui.apiFail,'warn');
        planJSON = buildLocalJSON();
      }

      // ØªØµØ­ÙŠØ­ Ø³Ù„Ø§Ù…Ø© Ø¨Ø³ÙŠØ·Ø©
      if(!Array.isArray(planJSON.nutrition) || planJSON.nutrition.length<7){
        planJSON.nutrition = buildLocalJSON().nutrition;
      }
      if(!Array.isArray(planJSON.training) || planJSON.training.length<7){
        planJSON.training = buildLocalJSON().training;
      }
      planJSON.targets = planJSON.targets || targets;

      const html = renderPlanHTML(planJSON);
      $('ai-html').innerHTML = html;

      speak(L[lang].ui.ready);
      $('result').scrollIntoView({behavior:'smooth',block:'start'});
    }

    function toast(msg,kind='ok'){
      const box=document.createElement('div');
      const side=(document.documentElement.dir==='rtl'?'right':'left');
      box.className=`fixed top-5 ${side}-5 z-50 px-3 py-2 rounded-xl text-sm text-white ${kind==='err'?'bg-red-600':kind==='warn'?'bg-amber-600':'bg-emerald-600'}`;
      box.textContent=msg; document.body.appendChild(box); setTimeout(()=>box.remove(),2600);
    }

    // Navigation
    $('btn-prev').onclick=()=>{ if(step>0){ step--; renderStep(); updateKPIs(); updateLive(); speak(L[lang].ui.back);} };
    $('btn-next').onclick=async ()=>{
      if(step<total-1){
        if(!saveStep()) return;
        step++; renderStep(); updateKPIs(); updateLive();
        if(step===total-1){ if(!saveStep()) return; await generatePlan(); }
      }
    };

    // Floating actions
    $('fab-new').onclick=()=>location.reload();
    $('fab-print').onclick=()=>window.print();
    $('fab-pdf').onclick=()=> {
      if(window.html2pdf && !window.__NO_PDF__){
        const opt={ margin:10, filename:(lang==='ar'?'Ø®Ø·Ø©-':'plan-')+(user.name||'client')+'.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
        window.html2pdf().from($('resultRoot')).set(opt).save();
      } else { toast(lang==='ar'?'ØªØ¹Ø°Ø± Ø­ÙØ¸ PDF â€” Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©':'PDF unavailable â€” use print','warn'); window.print(); }
    };

    // Header language buttons
    $('btn-lang-ar').onclick=()=>applyLang('ar');
    $('btn-lang-en').onclick=()=>applyLang('en');

    // Init
    applyLang('ar'); renderStep(); updateKPIs(); updateLive();

  })();
  </script>

  <!-- Footer (Ø­Ù‚ÙˆÙ‚ Ù…ÙˆØ­Ù‘Ø¯Ø© ØºÙŠØ± Ù…Ø¨Ø§Ù„Øº ÙÙŠÙ‡Ø§) -->
  <footer class="max-w-7xl mx-auto px-4 sm:px-6 mt-8 mb-24 text-center text-[12px] muted">
    Powered by Mustafa Elsafy 2025
  </footer>
</body>
</html>
