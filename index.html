<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ± â€” Ø®Ø·Ø© Ù…Ø®ØµØµØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- html2pdf for PDF Export -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --sub:#475569;
      --prime:#635bff;
      --line:#e5e7eb;
      --chip:#eef2ff;
    }
    html.dark{
      --bg:#0b0f17;
      --card:#0f1624;
      --ink:#f1f5f9;
      --sub:#98a2b3;
      --prime:#7c8cff;
      --line:#1f2738;
      --chip:#151c2c;
    }
    *{ font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    body{ background:var(--bg); color:var(--ink); }
    .card{ background:var(--card); border:1px solid var(--line); }
    .chip{ background:var(--chip); }

    /* Ø¥ØµÙ„Ø§Ø­ @apply: Ø§Ø³ØªØ®Ø¯Ø§Ù… CSS ØµØ±ÙŠØ­ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Tailwind @apply */
    .btn{ padding:0.5rem 1rem; border-radius:0.5rem; font-weight:800; border:0; cursor:pointer; }
    .btn-prime{ background:var(--prime); color:#fff; }
    .btn-ghost{ background:transparent; border:1px solid var(--line); color:var(--ink); }

    .kbd{
      font-size:0.75rem; padding:0.125rem 0.5rem; border-radius:0.25rem; border:1px solid var(--line);
      background:var(--chip); color:var(--sub);
    }

    .progress-bar { height:8px; background:linear-gradient(90deg, var(--prime), #22c55e); transition: width .3s; }
    .print-ready *{ animation:none !important; transition:none !important; }

    @media print{
      body { background:#fff; }
      #topbar, #setup, #actions { display:none !important; }
      #resultRoot { box-shadow:none !important; border:none !important; }
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- Top Bar -->
  <header id="topbar" class="sticky top-0 z-40 backdrop-blur bg-[color:var(--card)]/85 border-b" role="banner">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="size-9 rounded-lg grid place-items-center text-white font-extrabold" style="background:var(--prime)">AI</div>
        <div>
          <div class="text-sm font-extrabold">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±</div>
          <div class="text-[11px] text-[color:var(--sub)]">Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø© 100% Ù„Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ù…Ø®ØµØµØ© Ù„Ùƒ</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btn-ar" class="btn btn-ghost text-sm">Ø¹Ø±Ø¨ÙŠ</button>
        <button id="btn-en" class="btn btn-ghost text-sm">EN</button>
        <div class="w-px h-6 bg-[color:var(--line)] mx-1"></div>
        <button id="btn-theme" class="btn btn-ghost text-sm" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ">ğŸŒ“</button>
      </div>
    </div>
  </header>

  <!-- Container -->
  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- Intro Card -->
    <div class="card rounded-2xl p-5 md:p-7 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold mb-1">
            Ù„Ù†ØµÙ…Ù… Ø®Ø·ØªÙƒ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©
          </h1>
          <p class="text-sm text-[color:var(--sub)]">
            Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø¯Ù‚Ø©. Ø³Ù†ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù‚Ø³Ù…Ù‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø³Ù… Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø´Ù…ÙˆÙ„ ÙˆØ§Ù„ÙˆØ¶ÙˆØ­.
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-2" id="actions">
          <button id="btn-start" class="btn btn-prime">Ø§Ø¨Ø¯Ø£ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©</button>
          <button id="btn-regen" class="btn btn-ghost hidden">Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ ÙƒØ§Ù…Ù„</button>
          <button id="btn-print" class="btn btn-ghost hidden">Ø·Ø¨Ø§Ø¹Ø©</button>
          <button id="btn-pdf" class="btn btn-ghost hidden">PDF</button>
        </div>
      </div>

      <!-- Progress -->
      <div class="mt-4">
        <div class="w-full bg-[color:var(--line)] h-2 rounded-full overflow-hidden">
          <div id="progress" class="progress-bar w-0"></div>
        </div>
        <div id="progressText" class="text-[12px] text-[color:var(--sub)] mt-1">Ø¬Ø§Ù‡Ø²</div>
      </div>
    </div>

    <!-- Form -->
    <section id="setup" class="grid grid-cols-1 lg:grid-cols-3 gap-5">
      <!-- Profile -->
      <div class="card rounded-2xl p-5">
        <div class="text-lg font-extrabold mb-3">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
        <div class="grid grid-cols-2 gap-3">
          <label class="col-span-2">
            <div class="text-sm mb-1">Ø§Ù„Ø§Ø³Ù…</div>
            <input id="name" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„" />
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„Ø¹Ù…Ø±</div>
            <input id="age" type="number" class="w-full rounded-lg border px-3 py-2 bg-transparent" min="12" max="100" />
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</div>
            <input id="height" type="number" class="w-full rounded-lg border px-3 py-2 bg-transparent" min="120" max="230" />
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</div>
            <input id="weight" type="number" class="w-full rounded-lg border px-3 py-2 bg-transparent" min="30" max="250" />
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„Ø¬Ù†Ø³</div>
            <select id="gender" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option value="Male">Ø°ÙƒØ±</option>
              <option value="Female">Ø£Ù†Ø«Ù‰</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Goals & Diet -->
      <div class="card rounded-2xl p-5">
        <div class="text-lg font-extrabold mb-3">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙˆØ§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ</div>
        <div class="grid grid-cols-2 gap-3">
          <label class="col-span-2">
            <div class="text-sm mb-1">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ø§Ø®ØªØ± Ø¹Ø¯Ø©)</div>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†" class="accent-[var(--prime)]"><span>Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª" class="accent-[var(--prime)]"><span>Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©" class="accent-[var(--prime)]"><span>Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„" class="accent-[var(--prime)]"><span>ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="goals" value="ØµØ­Ø© Ø¹Ø§Ù…Ø©" class="accent-[var(--prime)]"><span>ØµØ­Ø© Ø¹Ø§Ù…Ø©</span></label>
            </div>
          </label>
          <label class="col-span-2">
            <div class="text-sm mb-1">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ Ø§Ù„Ù…ÙØ¶Ù„</div>
            <select id="diet" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>Ù†Ø¸Ø§Ù… Ù…ØªÙˆØ§Ø²Ù†</option>
              <option>Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª</option>
              <option>ØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹</option>
              <option>ÙƒÙŠØªÙˆ</option>
              <option>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
              <option>Ù†Ø¨Ø§ØªÙŠ</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª/Ø§Ù„ÙŠÙˆÙ…</div>
            <select id="meals" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>3</option><option>4</option><option>5</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹</div>
            <select id="fasting" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option value="off">ØºÙŠØ± Ù…ÙØ¹Ù„</option>
              <option value="16:8">16:8</option>
              <option value="18:6">18:6</option>
              <option value="20:4">20:4</option>
            </select>
          </label>
          <label class="col-span-2">
            <div class="text-sm mb-1">Ø£Ø·Ø¹Ù…Ø© Ù„Ø§ ØªØ±ØºØ¨ Ø¨Ù‡Ø§ / Ø­Ø³Ø§Ø³ÙŠØ©</div>
            <input id="dislikes" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø£Ùˆ Ù…Ø³Ø¨Ø¨Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©" />
          </label>
        </div>
      </div>

      <!-- Lifestyle & Health -->
      <div class="card rounded-2xl p-5">
        <div class="text-lg font-extrabold mb-3">Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©</div>
        <div class="grid grid-cols-2 gap-3">
          <label>
            <div class="text-sm mb-1">Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¹Ù…Ù„</div>
            <select id="job" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option value="Sedentary">Ø¹Ù…Ù„ Ù…ÙƒØªØ¨ÙŠ</option>
              <option value="Light">Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ</option>
              <option value="Moderate">Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø·</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù†ÙˆÙ…</div>
            <input id="sleep" type="number" min="3" max="12" class="w-full rounded-lg border px-3 py-2 bg-transparent" />
          </label>
          <label>
            <div class="text-sm mb-1">Ø§Ù„ØªÙˆØªØ±</div>
            <select id="stress" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>Ù…Ù†Ø®ÙØ¶</option>
              <option>Ù…ØªÙˆØ³Ø·</option>
              <option>Ù…Ø±ØªÙØ¹</option>
            </select>
          </label>
          <label>
            <div class="text-sm mb-1">Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>
            <select id="place" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>Ù†Ø§Ø¯ÙŠ</option><option>Ù…Ù†Ø²Ù„</option>
            </select>
          </label>
          <label class="col-span-2">
            <div class="text-sm mb-1">Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)</div>
            <input id="equipment" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="Ù…Ø«Ø§Ù„: Ø¯Ù…Ø¨Ù„ØŒ Ø¨Ø§Ø±ØŒ Ø¨Ù†Ø´â€¦" />
          </label>

          <label class="col-span-2">
            <div class="text-sm mb-1">Ø§Ù„Ø®Ø¨Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©</div>
            <select id="exp" class="w-full rounded-lg border px-3 py-2 bg-transparent">
              <option>Ù…Ø¨ØªØ¯Ø¦ (0-6 Ø£Ø´Ù‡Ø±)</option>
              <option>Ù…ØªÙˆØ³Ø· (6-24 Ø´Ù‡Ø±)</option>
              <option>Ù…ØªÙ‚Ø¯Ù… (+24 Ø´Ù‡Ø±)</option>
            </select>
          </label>

          <label class="col-span-2">
            <div class="text-sm mb-1">Ø¥ØµØ§Ø¨Ø§Øª / Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø·Ø¨ÙŠØ©</div>
            <input id="injuries" class="w-full rounded-lg border px-3 py-2 bg-transparent" placeholder="Ø§Ø°ÙƒØ± Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø¥Ù† ÙˆØ¬Ø¯Øª" />
          </label>

          <label class="col-span-2">
            <div class="text-sm mb-1">Ø­Ø§Ù„Ø§Øª ØµØ­ÙŠØ©</div>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="health" value="Ø¶ØºØ· Ø§Ù„Ø¯Ù…" class="accent-[var(--prime)]"><span>Ø¶ØºØ· Ø§Ù„Ø¯Ù…</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="health" value="Ø§Ù„Ø³ÙƒØ±ÙŠ" class="accent-[var(--prime)]"><span>Ø§Ù„Ø³ÙƒØ±ÙŠ</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="health" value="Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø§Ù†Ø³ÙˆÙ„ÙŠÙ†" class="accent-[var(--prime)]"><span>Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø§Ù†Ø³ÙˆÙ„ÙŠÙ†</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="health" value="Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØºØ¯Ø©" class="accent-[var(--prime)]"><span>Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØºØ¯Ø©</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="health" value="Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ" class="accent-[var(--prime)]"><span>Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" name="health" value="Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø¶Ù…ÙŠØ©" class="accent-[var(--prime)]"><span>Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø¶Ù…ÙŠØ©</span></label>
            </div>
          </label>
        </div>
      </div>
    </section>

    <!-- Result -->
    <section id="result" class="hidden mt-6">
      <div id="resultRoot" class="card rounded-2xl p-5 md:p-8">
        <div class="flex items-center justify-between gap-3 mb-3">
          <div class="text-lg font-extrabold">
            Ø§Ù„Ù†ØªÙŠØ¬Ø© â€” Ø®Ø·Ø© Ù…Ø®ØµØµØ© 100%
          </div>
          <div class="flex items-center gap-2">
            <button id="act-print" class="btn btn-ghost">Ø·Ø¨Ø§Ø¹Ø©</button>
            <button id="act-pdf" class="btn btn-ghost">PDF</button>
          </div>
        </div>
        <article id="ai" class="prose max-w-none prose-headings:font-extrabold prose-p:leading-7 prose-ul:leading-7 prose-ol:leading-7"></article>
      </div>
    </section>

    <footer class="text-center text-[11px] text-[color:var(--sub)] mt-6">
      Powered by Mustafa Elsafy 2025 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
    </footer>
  </main>

  <!-- Scripts -->
  <script>
    /******************* Utilities *******************/
    const $ = (id)=>document.getElementById(id);
    const PROXY_URL = '/.netlify/functions/gemini-proxy';
    const HEALTH_URL = '/.netlify/functions/health';

    const state = { lang:'ar' };
    const t = (ar,en)=> state.lang==='ar'? ar : en;

    function setLang(l){
      state.lang = l;
      document.documentElement.lang = l==='ar'?'ar':'en';
      document.documentElement.dir  = l==='ar'?'rtl':'ltr';
      $('btn-ar').classList.toggle('btn-prime', l==='ar');
      $('btn-en').classList.toggle('btn-prime', l==='en');
      $('progressText').textContent = t('Ø¬Ø§Ù‡Ø²','Ready');
    }

    function toggleTheme(){ document.documentElement.classList.toggle('dark'); }

    function setProgress(step,total,label){
      const p = Math.round((step/total)*100);
      $('progress').style.width = p+'%';
      $('progressText').textContent = `${p}% â€” ${label}`;
    }

    function appendSpinner(label){
      const el = document.createElement('div');
      el.id = 'ai-spinner';
      el.className = "chip border rounded-lg p-3 my-2 text-sm";
      el.innerHTML = `â³ ${t('Ù†Ù‚ÙˆÙ… Ø§Ù„Ø¢Ù† Ø¨ØªØ¬Ù‡ÙŠØ² Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ù†Ø§ÙŠØ©ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±â€¦','We are preparing this section carefully, please waitâ€¦')} <span class="ml-2 text-[color:var(--sub)]">${label}</span>`;
      $('ai').appendChild(el);
    }
    function replaceLastSpinnerWith(html){
      const sp = $('ai-spinner');
      if(sp) sp.remove();
      const box = document.createElement('div');
      box.className = 'my-4';
      box.innerHTML = marked.parse(html);
      $('ai').appendChild(box);
    }

    /******************* Collect & compute *******************/
    function collect(){
      const goals = [...document.querySelectorAll('input[name="goals"]:checked')].map(e=>e.value);
      const health = [...document.querySelectorAll('input[name="health"]:checked')].map(e=>e.value);
      return {
        name:$('name').value?.trim(),
        age:+$('age').value||0,
        height:+$('height').value||0,
        weight:+$('weight').value||0,
        gender:$('gender').value,
        goals, diet:$('diet').value,
        meals:+$('meals').value,
        fasting: $('fasting').value,
        dislikes: $('dislikes').value?.trim(),
        job:$('job').value,
        sleep:+$('sleep').value||0,
        stress:$('stress').value,
        training_place:$('place').value,
        equipment:$('equipment').value?.trim(),
        exp:$('exp').value,
        injuries:$('injuries').value?.trim(),
        health
      };
    }

    function calcTargets(){
      const u = collect();
      const male = u.gender==='Male';
      const BMR = male ? 10*u.weight + 6.25*u.height - 5*u.age + 5
                       : 10*u.weight + 6.25*u.height - 5*u.age - 161;
      const factor = (u.job==='Sedentary'?1.2 : u.job==='Moderate'?1.5 : 1.35);
      let TDEE = Math.round(BMR*factor);
      if(u.goals.includes('Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†')) TDEE = Math.round(TDEE*0.88);
      if(u.goals.includes('Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª'))   TDEE = Math.round(TDEE*1.10);
      const P = Math.round(2.0 * (u.weight||1));
      const F = Math.round(0.8 * (u.weight||1));
      let C = Math.max(0, Math.round((TDEE - (P*4 + F*9))/4));
      if(u.health.includes('Ø§Ù„Ø³ÙƒØ±ÙŠ')||u.health.includes('Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø§Ù†Ø³ÙˆÙ„ÙŠÙ†')) C = Math.min(C, 140);
      return { TDEE, P, F, C };
    }

    /******************* Backend health *******************/
    async function checkBackend(){
      try{
        const r = await fetch(HEALTH_URL, { cache:'no-store' });
        if(!r.ok) return { ok:false, error:'health status '+r.status };
        const j = await r.json().catch(()=> ({}));
        return j?.ok? { ok:true } : { ok:false, error:'health json' };
      }catch(e){ return { ok:false, error:String(e) }; }
    }

    /******************* AI call via proxy *******************/
    async function callAI(prompt){
      const res = await fetch(PROXY_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ prompt })
      });
      if(!res.ok){
        const tt = await res.text().catch(()=> '');
        throw new Error('Proxy '+res.status+': '+tt.slice(0,300));
      }
      const data = await res.json();
      const text = data?.text || '';
      if(!text) throw new Error('Empty AI response');
      return text;
    }

    /******************* Prompts & Pipeline *******************/
    function userObj(){
      const u = collect(), t = calcTargets();
      const IF = u.fasting!=='off' ? `${u.fasting}` : 'disabled';
      return { u, t, IF };
    }

    function baseHeader(){
      const {u,t} = userObj();
      const locale = state.lang==='ar'?'Arabic':'English';
      return `
STRICT GLOBAL RULES
- OUTPUT LANGUAGE: ${locale} ONLY. DO NOT MIX.
- GREETINGS/MOTIVATION: ONLY in "Welcome" section ONCE. STRICTLY FORBIDDEN elsewhere.
- DO NOT restate the client's profile fields repeatedly. Mention the name ONCE in the welcome section only. No age/height/weight/gender repetitions later.
- Use clean Markdown. Each section must start with "### Title".
- Use tables and precise bullet points. No placeholders. No emojis.

CLIENT PROFILE (internal, do NOT restate inside sections)
- Name: ${u.name}; Sex: ${u.gender}
- Age/Height/Weight: ${u.age}y / ${u.height}cm / ${u.weight}kg
- Activity: ${u.job}; Sleep: ${u.sleep}h; Stress: ${u.stress}
- Goals: ${(u.goals||[]).join(', ')}
- Diet: ${u.diet}; Meals/day: ${u.meals}; IF: ${u.fasting}
- Place: ${u.training_place}; Equipment: ${u.equipment||'â€”'}
- Experience: ${u.exp}; Injuries: ${u.injuries||'None'}
- Health: ${(u.health||[]).join(', ')||'None'}
- Disliked/allergic: ${u.dislikes||'None'}

DAILY TARGETS (reference only)
- Energy ~${t.TDEE} kcal/day; P ~${t.P} g; F ~${t.F} g; C ~${t.C} g (Â±2% tolerance)`.trim();
    }

    // Ø£Ù‚Ø³Ø§Ù… Ø£Ø³Ø§Ø³ÙŠØ© ØªÙÙˆÙ„ÙÙ‘Ø¯ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
    const BASE_PIPE = [
      {
        key:'welcome',
        label_ar:'Ù¡) ØªØ±Ø­ÙŠØ¨ ÙˆØªØ­ÙÙŠØ²',
        label_en:'1) Welcome & Motivation',
        prompt:()=>`${baseHeader()}

### Welcome & Motivation
Write a short warm welcome to **${collect().name||t('Ø§Ù„Ø¹Ù…ÙŠÙ„','client')}** (6â€“8 concise lines). No lists, no tables.`
      },
      {
        key:'analysis',
        label_ar:'Ù¢) ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù‡Ø¯Ù',
        label_en:'2) Profile Analysis & Goal',
        prompt:()=>`${baseHeader()}

### Analysis
Provide a concise professional analysis (no profile repetition, no greetings). Explain rationale behind calorie target and macro split, and how the plan aligns with goals, health and constraints.`
      },
      {
        key:'allowed',
        label_ar:'Ù£) Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹',
        label_en:'3) Allowed & Avoid List',
        prompt:()=>`${baseHeader()}

### Allowed & Avoid
Two bullet lists only:
- Allowed & preferred foods (based on diet ${collect().diet}) with brief reasons
- Avoid/limit foods considering allergies/dislikes: ${collect().dislikes||'None'}`
      },
      {
        key:'fasting',
        label_ar:'Ù¤) Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹ (Ø¥Ù† ÙˆÙØ¬Ø¯)',
        label_en:'4) Intermittent Fasting (if enabled)',
        prompt:()=>`${baseHeader()}

### Intermittent Fasting
If fasting = ${collect().fasting}, explain implementation (feeding window, hydration, electrolytes, first/last meal structure). If disabled, write "Not applicable". No greetings.`
      },
      {
        key:'supps',
        label_ar:'Ù§) Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª â€” Ø£Ø³Ø§Ø³ÙŠØ© + Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø­Ø§Ù„Ø©',
        label_en:'7) Supplements â€” Core + Condition-linked',
        prompt:()=>`${baseHeader()}

### Supplements (SAFE, PRACTICAL)
Provide two sublists:
1) Core stack â€” item, dose, timing, duration.
2) Condition-linked â€” only if relevant to: ${(collect().health||[]).join(', ')||'None'}; otherwise state "Not indicated".
Respect allergies/dislikes: ${collect().dislikes||'None'}.
Add safety line: consult physician if on medications.`
      },
      {
        key:'progress',
        label_ar:'Ù¨) Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„ØªØµØ¹ÙŠØ¯',
        label_en:'8) Progression & Tracking',
        prompt:()=>`${baseHeader()}

### Progress & Tracking
Explain how to progress training and when to adjust calories/macros. Provide weekly checklist.`
      },
      {
        key:'troubleshoot',
        label_ar:'Ù©) Ø§Ù„Ù…Ø´ÙƒÙ„Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© ÙˆØ§Ù„Ø­Ù„ÙˆÙ„',
        label_en:'9) Troubleshooting',
        prompt:()=>`${baseHeader()}

### Troubleshooting
Bullet list of frequent issues and exact fixes (plateaus, hunger, fatigue, schedule conflicts).`
      },
      {
        key:'safety',
        label_ar:'Ù¡Ù ) Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„ØµØ­ÙŠØ©',
        label_en:'10) Safety & Health Notes',
        prompt:()=>`${baseHeader()}

### Safety & Health
Short section on hydration, sleep hygiene, warm-up, technique, red flags to stop and seek care.`
      },
      {
        key:'closing',
        label_ar:'Ù¡Ù¡) Ø®ØªØ§Ù… ÙˆØªØ­ÙÙŠØ²',
        label_en:'11) Closing & Motivation',
        prompt:()=>`${baseHeader()}

### Closing
Positive closing paragraph encouraging adherence and celebrating small wins, without repeating the profile. No greetings duplication.`
      }
    ];

    // ØªÙˆÙ„ÙŠØ¯ ÙŠÙˆÙ…ÙŠ Ù„Ù„ØªØºØ°ÙŠØ©
    function nutritionDayPrompt(dayIdx){
      return `${baseHeader()}

### 7-Day Nutrition Plan â€” Day ${dayIdx}
- For **Day ${dayIdx}** ONLY, provide EXACTLY ${collect().meals} meals in a MARKDOWN TABLE with columns:
| ${t('Ø§Ù„ÙŠÙˆÙ…','Day')} | ${t('Ø§Ù„ÙˆØ¬Ø¨Ø©','Meal')} | ${t('Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª (Ø¨Ø§Ù„Ø¬Ø±Ø§Ù…Ø§Øª/Ù…Ù„)','Ingredients (g/ml)')} | Protein (g) | Fat (g) | Carbs (g) | kcal |
- Close with a "Totals" row meeting daily targets within Â±2%.
- Add one short compliance tip after the table.
- No greetings, no motivational lines.`;
    }

    // ØªÙˆÙ„ÙŠØ¯ ÙŠÙˆÙ…ÙŠ Ù„Ù„ØªØ¯Ø±ÙŠØ¨
    function trainingDayPrompt(dayIdx){
      return `${baseHeader()}

### 7-Day Training Plan â€” Day ${dayIdx}
- Tailored to experience: ${collect().exp}, place: ${collect().training_place}, equipment: ${collect().equipment||'â€”'}.
- STRICTLY avoid aggravating injuries: ${collect().injuries||'None'}.
- Provide ONE table:
| ${t('Ø§Ù„ÙŠÙˆÙ…','Day')} | Exercise (English) | Sets | Reps | Tempo | Rest (s) | Notes |
- Include warm-up/mobility notes if helpful.
- No greetings or motivational language.`;
    }

    // Ù…ÙØµØ§Ø¯ÙÙ‚Ø§Øª Ù…Ø¨Ø³Ù‘Ø·Ø©
    function hasTable(md){ return md.split('\n').filter(l=>l.includes('|')).length>=5; }
    function containsDay(md, i){
      const d = md.toLowerCase();
      const en = new RegExp(`\\bday\\s*${i}\\b`);
      const ar = new RegExp(`\\bØ§Ù„ÙŠÙˆÙ…\\s*${i}\\b`);
      return en.test(d) || ar.test(d);
    }

    const VALIDATORS = {
      welcome: (md)=> md.length>50 && !md.includes('|'),
      analysis:(md)=> md.length>80,
      allowed: (md)=> md.includes('- '),
      fasting: (md)=> md.length>30,
      supps:   (md)=> md.includes('1)') || md.includes('2)') || md.split('\n').some(l=>l.trim().startsWith('-')),
      progress:(md)=> md.length>60,
      troubleshoot:(md)=> md.includes('- '),
      safety:  (md)=> md.length>30,
      closing: (md)=> md.length>40
    };

    /******************* Dynamic Pipeline (with daily generation) *******************/
    function buildFullPipeline(){
      const steps = [];

      // Ø£Ø³Ø§Ø³ÙŠØ§Øª
      steps.push(...BASE_PIPE);

      // Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø¶Ø­ Ù„Ù‚Ø³Ù…ÙŠ Ø§Ù„Ø£ÙŠØ§Ù…
      steps.splice(1, 0, { // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù†Ø¶ÙŠÙ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨
        key:'nutrition_header',
        label_ar:'Ù¥) ØªØºØ°ÙŠØ© â€” Ø£ÙŠØ§Ù… Ù…Ù†ÙØµÙ„Ø©',
        label_en:'5) Nutrition â€” Day by Day',
        prompt:()=>`${baseHeader()}

### Nutrition Plan â€” Overview
The following 7 days will be generated **day-by-day**. Do NOT include greetings. Provide no content here other than a one-line notice: "Daily meal plans follow below."`
      });

      steps.splice(2, 0, {
        key:'training_header',
        label_ar:'Ù¦) ØªØ¯Ø±ÙŠØ¨ â€” Ø£ÙŠØ§Ù… Ù…Ù†ÙØµÙ„Ø©',
        label_en:'6) Training â€” Day by Day',
        prompt:()=>`${baseHeader()}

### Training Plan â€” Overview
The following 7 days will be generated **day-by-day**. Do NOT include greetings. Provide no content here other than a one-line notice: "Daily training sessions follow below."`
      });

      // 7 Ø£ÙŠØ§Ù… ØªØºØ°ÙŠØ©
      for(let i=1;i<=7;i++){
        steps.push({
          key:`nutrition_day_${i}`,
          label_ar:`ØªØºØ°ÙŠØ© â€” Ø§Ù„ÙŠÙˆÙ… ${i}`,
          label_en:`Nutrition â€” Day ${i}`,
          prompt:()=> nutritionDayPrompt(i),
          validator:(md)=> hasTable(md) && containsDay(md, i)
        });
      }

      // 7 Ø£ÙŠØ§Ù… ØªØ¯Ø±ÙŠØ¨
      for(let i=1;i<=7;i++){
        steps.push({
          key:`training_day_${i}`,
          label_ar:`ØªØ¯Ø±ÙŠØ¨ â€” Ø§Ù„ÙŠÙˆÙ… ${i}`,
          label_en:`Training â€” Day ${i}`,
          prompt:()=> trainingDayPrompt(i),
          validator:(md)=> hasTable(md) && containsDay(md, i)
        });
      }

      return steps;
    }

    /******************* Generation Loop *******************/
    async function generate(){
      const health = await checkBackend();
      if(!health.ok){
        alert(t('Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ø¬Ø§Ù‡Ø² â€” ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.\n','Backend is not ready â€” please try later.\n') + (health.error||''));
        return;
      }

      $('result').classList.remove('hidden');
      $('ai').innerHTML = '';
      $('btn-regen').classList.remove('hidden');
      $('btn-print').classList.remove('hidden');
      $('btn-pdf').classList.remove('hidden');

      const STEPS = buildFullPipeline();
      const total = STEPS.length;

      for(let i=0; i<total; i++){
        const sec = STEPS[i];
        const label = t(sec.label_ar || '', sec.label_en || '');
        setProgress(i, total, label || t('Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯','Generating'));
        appendSpinner(label || '');

        let ok=false, md='', attempts=0, error='';
        while(!ok && attempts<2){
          attempts++;
          try{
            md = await callAI(sec.prompt());
            const v = sec.validator || VALIDATORS[sec.key];
            ok = v ? v(md) : true;
            if(!ok){
              const fix = `${baseHeader()}

The previous attempt FAILED validation for "${label}".
Regenerate EXACTLY as requested. Ensure strict day labeling and valid table. No greetings.`;
              md = await callAI(fix);
              ok = v ? v(md) : true;
            }
          }catch(e){ error = String(e); }
        }

        if(!ok){
          md = t(
            '**ØªØ¹Ø°Ù‘Ø± ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ù…Ø­Ø§ÙˆÙ„ØªÙŠÙ†.** Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.',
            '**Failed to generate this section after two attempts.** Please try again later.'
          );
        }

        replaceLastSpinnerWith(md);
      }

      setProgress(total, total, t('Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯','Generation complete'));
      $('resultRoot').scrollIntoView({behavior:'smooth',block:'start'});
    }

    /******************* PDF Export & Print *******************/
    function exportAsPDF(){
      const node = $('resultRoot');
      if(!node){ window.print(); return; }
      if(!window.html2pdf){ window.print(); return; }

      const fn = (state.lang==='ar'?'Ø®Ø·Ø©-':'plan-') + (collect().name||'client') + '.pdf';
      const opt = {
        filename: fn,
        margin: [10,10,10,10],
        image: { type:'jpeg', quality:0.98 },
        html2canvas: { scale: 2, useCORS:true },
        pagebreak: { mode:['css','legacy'] },
        jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
      };

      document.documentElement.classList.add('print-ready');
      setTimeout(()=>{
        try{
          html2pdf().from(node).set(opt).save().finally(()=> {
            document.documentElement.classList.remove('print-ready');
          });
        }catch{
          document.documentElement.classList.remove('print-ready');
          window.print();
        }
      }, 80);
    }

    /******************* Events *******************/
    $('btn-ar').onclick = ()=> setLang('ar');
    $('btn-en').onclick = ()=> setLang('en');
    $('btn-theme').onclick = toggleTheme;

    $('btn-start').onclick = async ()=>{
      const u = collect();
      if(!u.name || !u.age || !u.height || !u.weight || !u.sleep){
        alert(t('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ø·ÙˆÙ„/Ø§Ù„ÙˆØ²Ù†/Ø§Ù„Ù†ÙˆÙ….','Fill required fields: name/age/height/weight/sleep.'));
        return;
      }
      $('ai').innerHTML='';
      generate();
    };
    $('btn-regen').onclick = ()=>{ $('ai').innerHTML=''; generate(); };
    $('btn-print').onclick = ()=> window.print();
    $('btn-pdf').onclick = exportAsPDF;
    $('act-print').onclick = ()=> window.print();
    $('act-pdf').onclick = exportAsPDF;

    // defaults
    setLang('ar');
  </script>
</body>
</html>
