<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ± â€” Mustafa Elsafy</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- DOMPurify -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <!-- html2pdf -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0a0f15; --panel:#0e1621; --ink:#e7eaf0; --ink-soft:#a8b0bc; --line:#1b2736;
      --brand:#7c3aed; --brand2:#06b6d4; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --chip:#0b121a; --th:#0b121a;
    }
    [data-theme="light"]{
      --bg:#f6f8fb; --panel:#ffffff; --ink:#0b1220; --ink-soft:#5b6878; --line:#e5eaf1;
      --brand:#6d28d9; --brand2:#0891b2; --ok:#059669; --warn:#d97706; --err:#dc2626;
      --chip:#f1f5f9; --th:#f3f4f6;
    }
    html,body{height:100%}
    body{background:linear-gradient(180deg,var(--bg) 0%, color-mix(in oklab, var(--bg) 75%, white 25%) 100%);color:var(--ink);-webkit-font-smoothing:antialiased}
    .font-ar{font-family:"Tajawal",sans-serif}
    .font-en{font-family:"Poppins",sans-serif}
    .glass{background:color-mix(in oklab, var(--panel) 88%, transparent 12%);border:1px solid color-mix(in oklab, var(--line) 90%, transparent 10%);backdrop-filter:blur(10px)}
    .panel{background:var(--panel);border:1px solid var(--line)}
    .btn{border:1px solid color-mix(in oklab, var(--line) 70%, transparent 30%);border-radius:1rem;padding:.85rem 1rem;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand2));border-color:transparent;color:#fff}
    .btn-ghost{background:var(--chip)}
    .chip{padding:.32rem .6rem;border-radius:.6rem;font-size:.75rem;background:var(--chip);border:1px dashed color-mix(in oklab, var(--line) 70%, transparent 30%);color:color-mix(in oklab, var(--brand2) 65%, var(--ink) 35%)}
    .kpi{background:color-mix(in oklab, var(--panel) 95%, white 5%);border:1px solid color-mix(in oklab, var(--line) 80%, transparent 20%);border-radius:.8rem;padding:.6rem}
    .muted{color:var(--ink-soft)}
    .pill{font-size:.7rem;padding:.2rem .5rem;border:1px solid color-mix(in oklab, var(--line) 70%, transparent 30%);border-radius:.5rem}
    .prose :where(table){width:100%;border-collapse:collapse}
    .prose :where(th,td){border:1px solid color-mix(in oklab, var(--line) 80%, transparent 20%);padding:.6rem;vertical-align:top}
    .prose :where(th){background:var(--th);color:color-mix(in oklab, var(--ink) 90%, var(--ink-soft) 10%)}
    .avatar{
      position:fixed; bottom:16px; inset-inline-start:16px; z-index:50; display:flex; align-items:flex-end; gap:10px;
    }
    .avatar .bubble{max-width:340px;background:var(--panel);border:1px solid var(--line);padding:.75rem .95rem;border-radius:1rem;box-shadow:0 6px 20px rgba(0,0,0,.18)}
    .avatar .face{
      width:56px;height:56px;border-radius:50%;background:
        radial-gradient(45% 55% at 40% 35%, #fff, #e9edf2) padding-box,
        radial-gradient(60% 80% at 65% 65%, color-mix(in oklab, var(--brand) 40%, #fff 60%), color-mix(in oklab, var(--brand2) 40%, #fff 60%)) border-box;
      border:2px solid color-mix(in oklab, var(--brand) 40%, var(--brand2) 60%);
      display:grid;place-items:center;box-shadow:0 4px 12px rgba(0,0,0,.2);
      position:relative; overflow:hidden;
    }
    .avatar .eyes{
      width:28px;height:10px;border-radius:10px;background:linear-gradient(90deg,#222,#000,#222); position:absolute; top:22px; left:50%; transform:translateX(-50%);
    }
    .typing{display:inline-flex;gap:4px}
    .typing span{width:6px;height:6px;border-radius:50%;background:color-mix(in oklab, var(--ink) 70%, var(--ink-soft) 30%);animation:blink 1s infinite}
    .typing span:nth-child(2){animation-delay:.2s}.typing span:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
    @media (max-width:520px){.avatar .bubble{max-width:72vw}}
    @media print{ .no-print, header, #controls, .avatar, #themeToggle {display:none!important}
      body{background:#fff;color:#000}
      .panel,.glass{background:#fff;border:none}
      table{page-break-inside:avoid}
    }
  </style>
</head>
<body class="font-ar">
  <!-- Header -->
  <header class="glass sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-600 to-cyan-500 text-white grid place-items-center font-extrabold">AI</div>
        <div class="leading-tight">
          <div class="text-xs muted">COACH</div>
          <div class="font-extrabold">Mustafa Elsafy</div>
          <div class="text-[11px] muted">Certified International Coach</div>
        </div>
      </div>
      <div class="flex items-center gap-2 no-print">
        <button id="btn-lang-ar" class="btn btn-ghost">AR</button>
        <button id="btn-lang-en" class="btn btn-ghost">EN</button>
        <button id="themeToggle" class="btn btn-ghost" title="Theme">â˜€ï¸/ğŸŒ™</button>
        <button id="btn-print" class="btn btn-primary">Ø·Ø¨Ø§Ø¹Ø© / Print</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 mt-6">
    <div class="glass rounded-2xl p-6 relative overflow-hidden">
      <div class="absolute -top-10 -left-10 w-56 h-56 rounded-full bg-gradient-to-br from-violet-600/25 to-cyan-500/25 blur-2xl"></div>
      <div class="absolute -bottom-10 -right-10 w-56 h-56 rounded-full bg-gradient-to-br from-cyan-500/18 to-violet-600/18 blur-2xl"></div>
      <div class="relative grid lg:grid-cols-[1.15fr,.85fr] gap-6 items-center">
        <div>
          <h1 id="hero-title" class="text-3xl sm:text-4xl font-extrabold">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±</h1>
          <p id="hero-sub" class="muted mt-1">
            Ø®Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ù„Ø§ Ø§Ø®ØªØµØ§Ø±: Ù§ Ø£ÙŠØ§Ù… ØªØºØ°ÙŠØ© Ù…ÙØµÙ„Ø©ØŒ Ù§ Ø£ÙŠØ§Ù… ØªØ¯Ø±ÙŠØ¨ ÙˆÙÙ‚ Ø®Ø¨Ø±ØªÙƒØŒ Ù…ÙƒÙ…Ù„Ø§Øª Ø¨Ø­Ø³Ø¨ Ø­Ø§Ù„ØªÙƒØŒ
            ÙˆØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹ Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ø¨ØªÙˆÙ‚ÙŠØ¹ <b>Mustafa Elsafy</b> Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯.
          </p>
          <p class="text-xs muted mt-2"><b>Powered by Mustafa Elsafy 2025</b></p>
          <div class="flex items-center gap-2 mt-4 flex-wrap">
            <span class="chip">RTL/LTR</span><span class="chip">ØªØ¯Ù‚ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span><span class="chip">PDF/Ø·Ø¨Ø§Ø¹Ø©</span><span class="chip">ØªØµÙ…ÙŠÙ… Ù…Ø±ÙŠØ­</span>
          </div>
        </div>
        <div class="panel rounded-2xl p-4">
          <div class="text-xs muted mb-2" id="kpi-title">Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
          <div class="grid grid-cols-3 gap-3 text-center">
            <div class="kpi"><div class="text-[11px] muted">TDEE</div><div id="kpi-tdee" class="font-extrabold">â€”</div></div>
            <div class="kpi"><div class="text-[11px] muted">Protein</div><div id="kpi-P" class="font-extrabold">â€”</div></div>
            <div class="kpi"><div class="text-[11px] muted">Carbs</div><div id="kpi-C" class="font-extrabold">â€”</div></div>
          </div>
          <div class="mt-3">
            <div class="h-2 bg-[color:var(--chip)] rounded-full overflow-hidden">
              <div id="bar" class="h-full bg-gradient-to-r from-violet-600 to-cyan-500 w-0 transition-all duration-300"></div>
            </div>
            <div class="text-[11px] muted mt-1">Step <span id="step">1</span> / 5</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 mt-6 grid xl:grid-cols-[minmax(0,1fr),420px] gap-6">
    <!-- Builder -->
    <section class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="text-sm chip muted">Tab-friendly â€¢ ARIA â€¢ Guards</div>
        <div class="text-xs chip">Â© Mustafa Elsafy â€¢ Powered by Mustafa Elsafy 2025</div>
      </div>
      <div id="stage"></div>
      <div id="controls" class="mt-6 flex gap-2">
        <button id="btn-prev" class="btn btn-ghost flex-1">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button id="btn-next" class="btn btn-primary flex-1">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </section>

    <!-- Live summary -->
    <aside class="panel rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <div id="live-title" class="text-sm font-bold">Ù…Ù„Ø®Øµ ÙÙˆØ±ÙŠ</div>
        <span id="lang-badge" class="chip">AR</span>
      </div>
      <div id="live" class="mt-3 space-y-2 text-sm"></div>
      <div class="mt-3 text-[11px] muted">
        * ÙŠÙ„ØªØ²Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù€ 7 Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø© ÙˆÙ…Ø®ØªÙ„ÙØ© + Ø¬Ø¯Ø§ÙˆÙ„ ØµØ§Ø±Ù…Ø© + ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø§ÙƒØ±ÙˆØ² ÙŠÙˆÙ…ÙŠÙ‹Ø§ (Â±1%).
      </div>
    </aside>
  </main>

  <!-- Result -->
  <section id="result" class="max-w-7xl mx-auto px-4 sm:px-6 mt-6 mb-16 hidden">
    <article class="glass rounded-2xl p-6" id="resultRoot">
      <div class="flex items-center justify-between">
        <h2 id="plan-title" class="text-2xl font-extrabold">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
        <div class="no-print flex gap-2">
          <button id="btn-again" class="btn btn-ghost">Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</button>
          <button id="btn-pdf" class="btn btn-ghost">Save PDF</button>
          <button id="btn-print-2" class="btn btn-primary">Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
      </div>

      <div id="welcome" class="mt-3 text-sm">
        <div class="kpi">
          <b id="welcome-title">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ù‚Ø±Ø§Ø±Ùƒ Ø§Ù„ÙŠÙˆÙ… Ù†Ù‚Ø·Ø© ØªØ­ÙˆÙ‘Ù„ØŒ ÙˆØ£Ù†Ø§ Ù…Ø¹Ùƒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.</b>
          <div id="welcome-sub" class="muted mt-1">
            Ø³ØªØ¬Ø¯ Ø£Ø¯Ù†Ø§Ù‡ Ø®Ø·Ø© Ø´Ø§Ù…Ù„Ø©: ØªØ´Ø®ÙŠØµ Ø¹Ù…Ù„ÙŠØŒ Ù…Ø³Ù…ÙˆØ­/Ù…Ù…Ù†ÙˆØ¹ØŒ ØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹ØŒ ØªØºØ°ÙŠØ© Ù§ Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø©ØŒ ØªØ¯Ø±ÙŠØ¨ Ù§ Ø£ÙŠØ§Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ø®Ø¨Ø±ØªÙƒØŒ
            Ù…ÙƒÙ…Ù„Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø©ØŒ ÙˆÙ†ØµØ§Ø¦Ø­ Ù†Ø¬Ø§Ø­ ÙŠÙˆÙ…ÙŠØ©.
          </div>
        </div>
      </div>

      <div id="audit-banner" class="hidden mt-3"></div>
      <div id="ai-html" class="prose prose-invert rtl:text-right ltr:text-left mt-4"></div>
      <div class="border-t border-slate-700 mt-6 pt-2 text-[11px] muted">
        <b>Mustafa Elsafy â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯</b> â€¢ <b>Powered by Mustafa Elsafy 2025</b>
      </div>
    </article>
  </section>

  <!-- Avatar Assistant -->
  <div class="avatar no-print" id="avatar" aria-live="polite">
    <div class="face"><div class="eyes"></div></div>
    <div class="bubble" id="avatarBubble"><span class="typing"><span></span><span></span><span></span></span></div>
  </div>

  <script>
    /* ======================== Theme ======================== */
    const themeBtn = document.getElementById('themeToggle');
    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); themeBtn.textContent = (t==='dark'?'â˜€ï¸':'ğŸŒ™'); }
    applyTheme(localStorage.getItem('theme') || 'dark');
    themeBtn.onclick = ()=> applyTheme( document.documentElement.getAttribute('data-theme')==='dark' ? 'light' : 'dark');

    /* ======================== I18N ======================== */
    const L = {
      ar:{ ui:{
        title:'Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø¨ÙŠØ±',
        sub:'Ø®Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ù„Ø§ Ø§Ø®ØªØµØ§Ø± â€” Ù§ Ø£ÙŠØ§Ù… ØªØºØ°ÙŠØ©ØŒ Ù§ Ø£ÙŠØ§Ù… ØªØ¯Ø±ÙŠØ¨ØŒ Ù…ÙƒÙ…Ù„Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø©ØŒ ÙˆØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹ Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ø¨ØªÙˆÙ‚ÙŠØ¹ Mustafa Elsafy.',
        kpi:'Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©', live:'Ù…Ù„Ø®Øµ ÙÙˆØ±ÙŠ',
        steps:['Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©','Ø§Ù„Ø£Ù‡Ø¯Ø§Ù & Ø§Ù„Ù†Ø¸Ø§Ù… & Ø§Ù„ØµÙŠØ§Ù…','Ø§Ù„ØµØ­Ø© & Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© & Ø§Ù„Ø£Ø¯ÙˆÙŠØ©','Ø§Ù„Ø®Ø¨Ø±Ø© & Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª & Ø§Ù„ØªØ±ÙƒÙŠØ²','Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©'],
        next:'Ø§Ù„ØªØ§Ù„ÙŠ', prev:'Ø§Ù„Ø³Ø§Ø¨Ù‚', submit:'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¢Ù†',
        name:'Ø§Ù„Ø§Ø³Ù…', age:'Ø§Ù„Ø¹Ù…Ø±', height:'Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)', weight:'Ø§Ù„ÙˆØ²Ù† (ÙƒØº)', gender:'Ø§Ù„Ø¬Ù†Ø³', male:'Ø°ÙƒØ±', female:'Ø£Ù†Ø«Ù‰',
        job:'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ (PAL)', jobVals:['Ù…ÙƒØªØ¨ÙŠ Ø¬Ø¯Ù‹Ø§ (PAL 1.15)','Ù…ÙƒØªØ¨ÙŠ/Ø®ÙÙŠÙ (PAL 1.25)','Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø· (PAL 1.4)','Ù†Ø´Ø§Ø· Ø¹Ø§Ù„Ù (PAL 1.6)'],
        goals:['Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†','Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª','Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©','ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù…Ù„','ØµØ­Ø© Ø¹Ø§Ù…Ø©'],
        meals:'Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª/Ø§Ù„ÙŠÙˆÙ…', diet:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ', diets:['Ù…ØªÙˆØ§Ø²Ù†','Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª','ÙƒÙŠØªÙˆ','Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·','Ù†Ø¨Ø§ØªÙŠ'],
        fasting:'Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹', enable:'ØªÙØ¹ÙŠÙ„', protocol:'Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„',
        window:'Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙƒÙ„', from:'Ù…Ù†', to:'Ø¥Ù„Ù‰',
        training_place:'Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨', placeVals:['Ù†Ø§Ø¯ÙŠ ÙƒØ§Ù…Ù„','Ù…Ù†Ø²Ù„ + Ø¯Ø§Ù…Ø¨Ù„Ø²','Ù…Ù†Ø²Ù„ ÙˆØ²Ù† Ø§Ù„Ø¬Ø³Ù…'],
        equipment:'Ù…Ø¹Ø¯Ø§Øª Ù…ØªÙˆÙØ±Ø©', equipPH:'Ø£Ø°ÙƒØ± Ø§Ù„Ù…Ø¹Ø¯Ø§Øª (Ù…Ø«Ø§Ù„: Ø¯Ø§Ù…Ø¨Ù„Ø² 5-20 ÙƒØºØŒ Ù…Ù‚Ø§ÙˆÙ…Ø§ØªØŒ Ø¨Ù†Ø´...)',
        sleep:'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù†ÙˆÙ…', stress:'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙˆØªØ±', stressVals:['Ù…Ù†Ø®ÙØ¶','Ù…ØªÙˆØ³Ø·','Ù…Ø±ØªÙØ¹'],
        cuisine:'Ø§Ù„Ù…Ø·Ø¨Ø® Ø§Ù„Ù…ÙØ¶Ù„', cuisineVals:['Ø¹Ø±Ø¨ÙŠ','Ù…ØªÙˆØ³Ø·ÙŠ','Ø¢Ø³ÙŠÙˆÙŠ','ØºØ±Ø¨ÙŠ','Ù‡Ù†Ø¯ÙŠ','Ù…ØªÙ†ÙˆØ¹'],
        budget:'Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø·Ø¹Ø§Ù…', budgetVals:['Ø§Ù‚ØªØµØ§Ø¯ÙŠ','Ù‚ÙŠØ§Ø³ÙŠ','Ù…Ø±Ù†'],
        dislikes:'Ø£Ø·Ø¹Ù…Ø© ØºÙŠØ± Ù…ÙØ¶Ù„Ø©',
        health:'Ø­Ø§Ù„Ø§Øª ØµØ­ÙŠØ©', healthVals:['Ø¶ØºØ· Ø§Ù„Ø¯Ù…','Ø§Ù„Ø³ÙƒØ±ÙŠ','Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†','Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©','Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ','Ù…Ø´Ø§ÙƒÙ„ Ù‡Ø±Ù…ÙˆÙ†ÙŠØ©','Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù‡Ø¶Ù…ÙŠ'],
        meds:'Ø£Ø¯ÙˆÙŠØ© (Ø¥Ù† ÙˆØ¬Ø¯Øª)',
        allergies:'Ø­Ø³Ø§Ø³ÙŠØ§Øª', allergyVals:['Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†','Ø§Ù„Ù„Ø§ÙƒØªÙˆØ²','Ø§Ù„Ù…ÙƒØ³Ø±Ø§Øª','Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ©','Ø§Ù„Ø¨Ù‚ÙˆÙ„ÙŠØ§Øª','Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©','Ø§Ù„Ø²ÙŠÙˆØª Ø§Ù„Ù†Ø¨Ø§ØªÙŠØ©'],
        injuries:'Ø¥ØµØ§Ø¨Ø§Øª (Ø§Ø°ÙƒØ± Ø§Ù„Ù…ÙƒØ§Ù† ÙˆØ§Ù„ÙˆØµÙ)',
        exp:'Ø®Ø¨Ø±Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©', expVals:['Ù…Ø¨ØªØ¯Ø¦','Ù…ØªÙˆØ³Ø·','Ù…ØªÙ‚Ø¯Ù…'],
        weak:'Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ±ÙƒÙŠØ² (Ø¹Ø¶Ù„Ø©: Ù‡Ø¯Ù)', weakPH:'ØµØ¯Ø±: Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø£Ø¹Ù„Ù‰Ø› Ø¸Ù‡Ø±: ÙƒØ«Ø§ÙØ©Ø› Ø£ÙƒØªØ§Ù: Ø§Ø³ØªÙ‚Ø±Ø§Ø±...',
        days:'Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨/Ø£Ø³Ø¨ÙˆØ¹', detail:'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙØµÙŠÙ„',
        addons:'ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©',
        add:{ grocery:'Ù‚Ø§Ø¦Ù…Ø© Ù…Ø´ØªØ±ÙŠØ§Øª', micro:'Ù…ØºØ°ÙŠØ§Øª Ø¯Ù‚ÙŠÙ‚Ø©', hydration:'Ø®Ø·Ø© Ø§Ù„Ø³ÙˆØ§Ø¦Ù„', periodization:'ØªØµØ¹ÙŠØ¯ 4 Ø£Ø³Ø§Ø¨ÙŠØ¹', budget:'Ø¨Ø¯Ø§Ø¦Ù„ Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©', prep:'Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ­Ø¶ÙŠØ±', cooking:'Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø·Ø¨Ø®' },
        building:'Ù†Ø¬Ù‡Ù‘Ø² Ø®Ø·ØªÙƒ Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø¢Ù† â€” Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±â€¦',
        apiFail:'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ â€” Ø³Ù†ÙˆÙ„Ù‘Ø¯ Ø®Ø·Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¨Ø¯Ù‚Ù‘Ø©.',
        err:'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©',
        print:'Ø·Ø¨Ø§Ø¹Ø© / Print',
        auditOK:'ØªÙ…Ù‘ Ø§Ù„ØªØ­Ù‚Ù‚: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù… ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Â±1%) ÙˆØ¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª ØµØ­ÙŠØ­.',
        auditWarn:'ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø¨Ø¹Ø¶ Ø§Ù„Ø£ÙŠØ§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø§ÙØ­Øµ Ø§Ù„Ø´Ø§Ø±Ø§Øª.',
        auditErr:'Ø¨Ø¹Ø¶ Ø§Ù„Ø£ÙŠØ§Ù… Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚. Ø¹Ø¯Ù‘Ù„ Ø£Ùˆ Ø£Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯.',
        badgeOK:'âœ… Ù…Ø·Ø§Ø¨Ù‚', badgeFix:'ğŸ› ï¸ ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­', badgeFail:'âš ï¸ ÙŠÙ„Ø²Ù… Ù…Ø±Ø§Ø¬Ø¹Ø©',
        welcomeTitle:'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ù‚Ø±Ø§Ø±Ùƒ Ø§Ù„ÙŠÙˆÙ… Ù†Ù‚Ø·Ø© ØªØ­ÙˆÙ‘Ù„ØŒ ÙˆØ£Ù†Ø§ Ù…Ø¹Ùƒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.',
        welcomeSub:'Ø³ØªØ¬Ø¯ Ø®Ø·Ø© Ø´Ø§Ù…Ù„Ø©: ØªØ´Ø®ÙŠØµ Ø¹Ù…Ù„ÙŠØŒ Ù…Ø³Ù…ÙˆØ­/Ù…Ù…Ù†ÙˆØ¹ØŒ ØµÙŠØ§Ù… Ù…ØªÙ‚Ø·Ø¹ØŒ Ù§ Ø£ÙŠØ§Ù… ØªØºØ°ÙŠØ©ØŒ Ù§ Ø£ÙŠØ§Ù… ØªØ¯Ø±ÙŠØ¨ØŒ Ù…ÙƒÙ…Ù„Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø©ØŒ ÙˆÙ†ØµØ§Ø¦Ø­ Ù†Ø¬Ø§Ø­.',
        btnPDF:'Ø­ÙØ¸ PDF', btnNew:'Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯',
        hello:'Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ù…Ù„Ø£ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ø¯Ù‚Ø© â€” Ø³Ø£ØªÙˆÙ„Ù‘Ù‰ Ø§Ù„Ø¨Ø§Ù‚ÙŠ.',
        good:'Ù…Ù…ØªØ§Ø² â€” ØªØ§Ø¨Ø¹.',
        back:'ØªÙ… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø®Ø·ÙˆØ©.',
        ready:'ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø·ØªÙƒ â€” ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£Ùˆ Ø­ÙØ¸ PDF.'
      },
      map:{
        diet:{'Balanced':'Ù…ØªÙˆØ§Ø²Ù†','Low-Carb':'Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª','Keto':'ÙƒÙŠØªÙˆ','Mediterranean':'Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·','Plant-based':'Ù†Ø¨Ø§ØªÙŠ'},
        exp:{'Beginner':'Ù…Ø¨ØªØ¯Ø¦','Intermediate':'Ù…ØªÙˆØ³Ø·','Advanced':'Ù…ØªÙ‚Ø¯Ù…'}
      }},
      en:{ ui:{
        title:'Expert Personal Coach',
        sub:'No-shortcut plan â€” 7 full nutrition days, 7 training days, condition-aware supplements, optional IF â€” by Mustafa Elsafy.',
        kpi:'Quick KPIs', live:'Live Summary',
        steps:['Advanced Basics','Goals & Diet & IF','Health & Allergies & Meds','Experience & Injuries & Focus','Create Plan'],
        next:'Next', prev:'Back', submit:'Generate Now',
        name:'Name', age:'Age', height:'Height (cm)', weight:'Weight (kg)', gender:'Gender', male:'Male', female:'Female',
        job:'Daily activity (PAL)', jobVals:['Very desk (PAL 1.15)','Desk/Light (PAL 1.25)','Moderate (PAL 1.4)','High (PAL 1.6)'],
        goals:['Fat loss','Muscle gain','Strength','Endurance','General health'],
        meals:'Meals/day', diet:'Preferred diet', diets:['Balanced','Low-Carb','Keto','Mediterranean','Plant-based'],
        fasting:'Intermittent Fasting', enable:'Enable', protocol:'Protocol',
        window:'Feeding window', from:'from', to:'to',
        training_place:'Training place', placeVals:['Full gym','Home + dumbbells','Home bodyweight'],
        equipment:'Available equipment', equipPH:'List equipment (e.g., DB 5â€“20kg, bands, bench...)',
        sleep:'Sleep hours', stress:'Stress level', stressVals:['Low','Moderate','High'],
        cuisine:'Preferred cuisine', cuisineVals:['Arabic','Mediterranean','Asian','Western','Indian','Mixed'],
        budget:'Food budget', budgetVals:['Budget','Standard','Flexible'],
        dislikes:'Disliked foods',
        health:'Health conditions', healthVals:['Hypertension','Diabetes','Insulin Resistance','Thyroid','Fatty Liver','Hormonal issues','GI issues'],
        meds:'Medications (if any)',
        allergies:'Allergies', allergyVals:['Gluten','Lactose','Nuts','Seafood','Legumes','Added sugars','Vegetable oils'],
        injuries:'Injuries (location & description)',
        exp:'Resistance experience', expVals:['Beginner','Intermediate','Advanced'],
        weak:'Focus points (muscle: goal)', weakPH:'Chest: upper; Back: density; Shoulders: stability...',
        days:'Training days/week', detail:'Detail level',
        addons:'Add-on modules',
        add:{ grocery:'Grocery list', micro:'Micronutrients', hydration:'Hydration plan', periodization:'4-week periodization', budget:'Budget swaps', prep:'Meal-prep guide', cooking:'Cooking tips' },
        building:'Preparing your comprehensive plan â€” please waitâ€¦',
        apiFail:'Model unreachable â€” generating a precise local plan.',
        err:'Please complete required fields',
        print:'Print / Save',
        auditOK:'Validated: all days match targets (Â±1%) & meal count is correct.',
        auditWarn:'Some days were auto-repaired. Check badges.',
        auditErr:'Some days remain out of range. Adjust or regenerate.',
        badgeOK:'âœ… OK', badgeFix:'ğŸ› ï¸ Fixed', badgeFail:'âš ï¸ Check',
        welcomeTitle:'Welcome! Todayâ€™s decision is a turning point â€” Iâ€™m with you.',
        welcomeSub:'Youâ€™ll get a comprehensive plan: assessment, allowed/avoid, IF, 7-day nutrition, 7-day training, precise supplements & daily tips.',
        btnPDF:'Save PDF', btnNew:'New Plan',
        hello:'Hi! Provide precise inputs â€” Iâ€™ll handle the rest.',
        good:'Great â€” continue.',
        back:'Stepped back.',
        ready:'Your plan is ready â€” print or save as PDF.'
      },
      map:{
        diet:{'Ù…ØªÙˆØ§Ø²Ù†':'Balanced','Ù‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª':'Low-Carb','ÙƒÙŠØªÙˆ':'Keto','Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·':'Mediterranean','Ù†Ø¨Ø§ØªÙŠ':'Plant-based'},
        exp:{'Ù…Ø¨ØªØ¯Ø¦':'Beginner','Ù…ØªÙˆØ³Ø·':'Intermediate','Ù…ØªÙ‚Ø¯Ù…':'Advanced'}
      }}
    };

    /* ======================== Elements & State ======================== */
    const $ = id => document.getElementById(id);
    const content=$('stage'), live=$('live'), bar=$('bar'), stepSpan=$('step');
    const kTDEE=$('kpi-tdee'), kP=$('kpi-P'), kC=$('kpi-C');
    const avatarBubble = $('avatarBubble');
    let lang='ar', step=0; const total=5;

    const user={
      name:'', age:'', height:'', weight:'', gender:'Male',
      pal:'1.25',
      jobLabel:'Desk/Light (PAL 1.25)',
      goals:[], meals:4, diet:'Balanced',
      fasting:{enabled:false, protocol:'16:8', start:'12:00', end:'20:00'},
      training_place:'Full gym',
      equipment:'',
      sleep:7, stress:'Moderate',
      cuisine:'Mixed', budget:'Standard',
      dislikes:'',
      health:[], meds:'',
      allergies:[], injuries:'',
      exp:'Beginner', weak_points:{},
      detail:'max', train_days:7,
      include:{grocery:true, micro:true, hydration:true, periodization:true, budget:false, prep:true, cooking:true}
    };

    let planJSON=null, proseMD='', audit=null;

    /* ======================== Helpers ======================== */
    function speak(text){ avatarBubble.innerHTML = text; setTimeout(()=>avatarBubble.innerHTML='<span class="typing"><span></span><span></span><span></span></span>', 5000); }
    function T(k){ return L[lang].ui[k]; }
    function setLang(l){
      lang=l; document.documentElement.lang=l; document.documentElement.dir=(l==='ar'?'rtl':'ltr');
      document.body.classList.toggle('font-ar',l==='ar'); document.body.classList.toggle('font-en',l!=='ar');
      $('hero-title').textContent=T('title'); $('hero-sub').textContent=L[lang].ui.sub;
      $('kpi-title').textContent=T('kpi'); $('live-title').textContent=T('live');
      $('lang-badge').textContent=l.toUpperCase(); $('btn-print').textContent=T('print'); $('btn-print-2').textContent=T('print');
      $('plan-title').textContent=(l==='ar'?'Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©':'The Comprehensive Plan');
      $('welcome-title').textContent=L[lang].ui.welcomeTitle; $('welcome-sub').textContent=L[lang].ui.welcomeSub;
      $('btn-pdf').textContent=(l==='ar'? 'Ø­ÙØ¸ PDF' : L[lang].ui.btnPDF);
      $('btn-again').textContent=(l==='ar'? 'Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯' : L[lang].ui.btnNew);
      draw(); updateLive(); updateCTA(); speak( l==='ar'? L.ar.ui.hello : L.en.ui.hello );
    }
    function f(label,id,opt={}){ const {type='text',value='',select=null,rows=3,placeholder=''}=opt;
      if(select){ return `<label class="block"><span class="text-sm">${label}</span>
        <select id="${id}" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]">
          ${select.map(o=>`<option value="${o.value}" ${String(value)===String(o.value)?'selected':''}>${o.label}</option>`).join('')}
        </select></label>`;}
      if(type==='textarea'){ return `<label class="block"><span class="text-sm">${label}</span>
        <textarea id="${id}" rows="${rows}" placeholder="${placeholder}" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]">${value||''}</textarea></label>`;}
      return `<label class="block"><span class="text-sm">${label}</span>
        <input id="${id}" type="${type}" value="${value}" placeholder="${placeholder}" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]"/></label>`;
    }
    function chips(name,arr,checked=[]){
      return `<div class="flex flex-wrap gap-2">${arr.map(v=>`
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)] cursor-pointer">
          <input type="checkbox" name="${name}" value="${v}" class="accent-violet-600" ${checked.includes(v)?'checked':''}/>
          <span class="text-sm">${v}</span></label>`).join('')}</div>`;
    }
    function parsePAL(label){
      const m=String(label).match(/PAL\s*([0-9.]+)/); return m? parseFloat(m[1]) : 1.25;
    }
    function calc(){
      const W=+user.weight||0, H=+user.height||0, A=+user.age||0, male=(user.gender==='Male');
      const BMR = male? 10*W+6.25*H-5*A+5 : 10*W+6.25*H-5*A-161;
      const pal = parsePAL(user.jobLabel||'PAL 1.25');
      let TDEE=BMR*pal;
      if(user.goals.some(g=>/Fat|Ø¯Ù‡ÙˆÙ†/.test(g))) TDEE*=0.86; // Ø¹Ø¬Ø² Ù…Ø¯Ø±ÙˆØ³
      if(user.goals.some(g=>/Muscle|Ø¹Ø¶Ù„Ø§Øª/.test(g))) TDEE*=1.10; // ÙØ§Ø¦Ø¶ Ù…Ø¯Ø±ÙˆØ³
      const P=Math.round(2.0*(+user.weight||1));
      const F=Math.round(Math.max(0,0.8*(+user.weight||1)));
      let C=Math.round((TDEE-(P*4+F*9))/4);
      if(user.health.some(h=>/Diab|Ø§Ù„Ø³ÙƒØ±ÙŠ|Insulin|Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†/.test(h))) C=Math.min(C,120);
      C=Math.max(0,C);
      return {TDEE:Math.round(TDEE),P,F,C};
    }
    function updateKPIs(){ const c=calc(); kTDEE.textContent=c.TDEE; kP.textContent=c.P+' g'; kC.textContent=c.C+' g'; }
    function updateProgress(){ bar.style.width=(((step+1)/total)*100)+'%'; stepSpan.textContent=String(step+1); }
    function updateCTA(){ $('btn-prev').textContent=T('prev'); $('btn-next').textContent = step===total-1?T('submit'):T('next'); $('btn-prev').disabled=(step===0); }
    function updateLive(){
      updateKPIs(); const c=calc();
      const g = (user.goals||[]).join(lang==='ar'?'ØŒ ':', ')||'â€”';
      live.innerHTML = `
        <div class="text-xs muted">${T('name')}: <b class="text-slate-200">${user.name||'â€”'}</b></div>
        <div class="grid grid-cols-3 gap-2 text-xs">
          <div class="kpi"><div class="muted">${T('age')}</div><b>${user.age||'â€”'}</b></div>
          <div class="kpi"><div class="muted">${T('height')}</div><b>${user.height||'â€”'}</b></div>
          <div class="kpi"><div class="muted">${T('weight')}</div><b>${user.weight||'â€”'}</b></div>
        </div>
        <div class="text-xs muted">${lang==='ar'?'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù':'Goals'}: <b class="text-slate-200">${g}</b></div>
        <div class="text-xs muted">${T('diet')}: <b class="text-slate-200">${user.diet}</b> â€” ${T('meals')}: <b class="text-slate-200">${user.meals}</b></div>
        <div class="text-xs muted">${T('fasting')}: <b class="text-slate-200">${user.fasting.enabled? user.fasting.protocol+' '+user.fasting.start+'-'+user.fasting.end : 'â€”'}</b></div>
        <div class="grid grid-cols-3 gap-2 text-xs mt-2">
          <div class="kpi"><div>${lang==='ar'?'Ø§Ù„Ø³Ø¹Ø±Ø§Øª':'Calories'}</div><b>${c.TDEE} kcal</b></div>
          <div class="kpi"><div>${lang==='ar'?'Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†':'Protein'}</div><b>${c.P} g</b></div>
          <div class="kpi"><div>${lang==='ar'?'Ø§Ù„ÙƒØ§Ø±Ø¨':'Carbs'}</div><b>${c.C} g</b></div>
        </div>`;
    }

    /* ======================== UI (Stages) ======================== */
    function draw(){
      updateProgress();
      const U=L[lang].ui;
      if(step===0){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[0]}</h3>
          <div class="grid md:grid-cols-3 gap-4">
            ${f(U.name,'name',{value:user.name})}
            ${f(U.gender,'gender',{select:[{value:'Male',label:U.male},{value:'Female',label:U.female}],value:user.gender})}
            ${f(U.age,'age',{type:'number',value:user.age})}
            ${f(U.height,'height',{type:'number',value:user.height})}
            ${f(U.weight,'weight',{type:'number',value:user.weight})}
            <label class="block md:col-span-2"><span class="text-sm">${U.job}</span>
              <select id="job" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]">
                ${U.jobVals.map((lbl,i)=>`<option ${i===1?'selected':''}>${lbl}</option>`).join('')}
              </select>
            </label>
            <label>${f(U.sleep,'sleep',{type:'number',value:user.sleep})}</label>
            <label>${f(U.stress,'stress',{select:U.stressVals.map(v=>({value:v,label:v})),value:user.stress})}</label>
            <label>${f(U.training_place,'training_place',{select:U.placeVals.map(v=>({value:v,label:v})),value:user.training_place})}</label>
            <label class="md:col-span-2">${f(U.equipment,'equipment',{type:'textarea',rows:2,placeholder:U.equipPH,value:user.equipment})}</label>
            <label>${f(U.cuisine,'cuisine',{select:U.cuisineVals.map(v=>({value:v,label:v})),value:user.cuisine})}</label>
            <label>${f(U.budget,'budget',{select:U.budgetVals.map(v=>({value:v,label:v})),value:user.budget})}</label>
            <label class="md:col-span-2">${f(U.dislikes,'dislikes',{type:'textarea',rows:2,placeholder:'â€¦',value:user.dislikes})}</label>
            <label>
              <span class="text-sm">${U.days}</span>
              <select id="train_days" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]">
                <option>3</option><option>4</option><option>5</option><option selected>7</option>
              </select>
            </label>
            <label>
              <span class="text-sm">${U.detail}</span>
              <select id="detail" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]">
                <option value="minimal">minimal</option><option value="standard">standard</option><option value="max" selected>max</option>
              </select>
            </label>
            <div class="rounded-xl p-3 bg-[color:var(--chip)] border border-[color:var(--line)] md:col-span-3">
              <div class="text-sm mb-2">${U.addons}</div>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
                <label class="inline-flex items-center gap-2"><input id="inc_grocery" type="checkbox" class="accent-violet-600" checked/>${U.add.grocery}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_micro" type="checkbox" class="accent-violet-600" checked/>${U.add.micro}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_hyd" type="checkbox" class="accent-violet-600" checked/>${U.add.hydration}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_period" type="checkbox" class="accent-violet-600" checked/>${U.add.periodization}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_budget" type="checkbox" class="accent-violet-600"/>${U.add.budget}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_prep" type="checkbox" class="accent-violet-600" checked/>${U.add.prep}</label>
                <label class="inline-flex items-center gap-2"><input id="inc_cook" type="checkbox" class="accent-violet-600" checked/>${U.add.cooking}</label>
              </div>
            </div>
          </div>`;
        speak(L[lang].ui.hello);
      } else if(step===1){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[1]}</h3>
          <div class="space-y-4">
            <div><div class="text-sm mb-1">${lang==='ar'?'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù':'Goals'}</div>${chips('goal',U.goals,user.goals)}</div>
            <div class="grid md:grid-cols-3 gap-4">
              ${f(U.meals,'meals',{select:[{value:3,label:'3'},{value:4,label:'4'},{value:5,label:'5'},{value:6,label:'6'}],value:user.meals})}
              ${f(U.diet,'diet',{select:U.diets.map(d=>({value:d,label:d})),value:user.diet})}
              <label class="block">
                <span class="text-sm">${U.fasting} â€” ${U.enable}</span>
                <input id="fasting_enabled" type="checkbox" class="accent-violet-600 ml-2" ${user.fasting.enabled?'checked':''}/>
              </label>
            </div>
            <div id="ifWrap" class="grid md:grid-cols-3 gap-4">
              ${f(U.protocol,'fasting_protocol',{select:['14:10','16:8','18:6','20:4'].map(x=>({value:x,label:x})),value:user.fasting.protocol})}
              <label><span class="text-sm">${U.window} ${U.from}</span><input id="fasting_start" type="time" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]" value="${user.fasting.start}"/></label>
              <label><span class="text-sm">${U.window} ${U.to}</span><input id="fasting_end" type="time" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]" value="${user.fasting.end}"/></label>
            </div>
          </div>`;
        speak(L[lang].ui.good);
      } else if(step===2){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[2]}</h3>
          <div class="space-y-4">
            <div><div class="text-sm mb-1">${U.health}</div>${chips('health',U.healthVals,user.health)}</div>
            ${f(U.meds,'meds',{type:'textarea',rows:2,placeholder:'Metformin, Thyroxine, â€¦',value:user.meds})}
            <div><div class="text-sm mb-1">${U.allergies}</div>${chips('all',U.allergyVals,user.allergies)}</div>
          </div>`;
        speak(L[lang].ui.good);
      } else if(step===3){
        content.innerHTML=`
          <h3 class="text-xl font-extrabold mb-3">${U.steps[3]}</h3>
          <div class="grid md:grid-cols-3 gap-4">
            ${f(U.exp,'exp',{select:U.expVals.map(x=>({value:x,label:x})),value:user.exp})}
            ${f(U.injuries,'injuries',{type:'textarea',rows:2,placeholder: lang==='ar'?'Ù…Ø«Ø§Ù„: Ø£Ù„Ù… Ø£Ø³ÙÙ„ Ø§Ù„Ø¸Ù‡Ø± â€” ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ù†Ø­Ù†Ø§Ø¡ Ø§Ù„Ø²Ø§Ø¦Ø¯':'e.g., Lower-back pain â€” avoid deep flexion',value:user.injuries})}
            <label class="md:col-span-2"><span class="text-sm">${U.weak}</span>
              <input id="weak_raw" class="mt-1 w-full p-3 rounded-xl bg-[color:var(--chip)] border border-[color:var(--line)]" placeholder="${U.weakPH}" value="${serializeWeak()}">
            </label>
          </div>`;
        speak(L[lang].ui.good);
      } else {
        content.innerHTML=`
          <div class="text-center py-8">
            <div class="text-sm muted mb-2">${U.building}</div>
            <div class="w-12 h-12 rounded-full border-4 border-violet-600 border-t-transparent animate-spin mx-auto"></div>
          </div>`;
        speak(lang==='ar'?'Ø£Ø¬Ù‡Ù‘Ø² Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø´Ø±Ø­ Ø¨Ø§Ù„ØªÙØµÙŠÙ„â€¦':'Assembling detailed tables and explanationsâ€¦');
      }
    }
    function serializeWeak(){ const e=Object.entries(user.weak_points||{}); return e.length? e.map(([k,v])=>`${k}:${v}`).join('; '):''; }

    function saveStep(){
      try{
        if(step===0){
          user.name=$('name').value.trim(); user.gender=$('gender').value;
          user.age=+$('age').value; user.height=+$('height').value; user.weight=+$('weight').value;
          user.jobLabel=$('job').value; user.pal=String(parsePAL(user.jobLabel));
          user.sleep=+$('sleep').value; user.stress=$('stress').value;
          user.training_place=$('training_place').value;
          user.equipment=$('equipment').value; user.cuisine=$('cuisine').value; user.budget=$('budget').value;
          user.dislikes=$('dislikes').value;
          user.train_days=+$('train_days').value; user.detail=$('detail').value;
          user.include={grocery:$('inc_grocery').checked, micro:$('inc_micro').checked, hydration:$('inc_hyd').checked, periodization:$('inc_period').checked, budget:$('inc_budget').checked, prep:$('inc_prep').checked, cooking:$('inc_cook').checked};
          if(!user.name||!user.age||!user.height||!user.weight) throw 0;
        } else if(step===1){
          user.goals=[...document.querySelectorAll('input[name="goal"]:checked')].map(e=>e.value);
          user.meals=+$('meals').value; user.diet=$('diet').value;
          user.fasting.enabled=$('fasting_enabled').checked;
          user.fasting.protocol=$('fasting_protocol').value; user.fasting.start=$('fasting_start').value; user.fasting.end=$('fasting_end').value;
          if(!user.goals.length) throw 0;
        } else if(step===2){
          user.health=[...document.querySelectorAll('input[name="health"]:checked')].map(e=>e.value);
          user.meds=$('meds').value||''; user.allergies=[...document.querySelectorAll('input[name="all"]:checked')].map(e=>e.value);
        } else if(step===3){
          user.exp=$('exp').value;
          const weak_raw=$('weak_raw').value.trim(); user.weak_points={};
          if(weak_raw){ weak_raw.split(';').forEach(pair=>{ const [k,...rest]=pair.split(':'); const v=rest.join(':').trim(); if(k&&v) user.weak_points[k.trim()]=v; }); }
          // ready to generate
        }
        updateLive(); return true;
      }catch{ toast(L[lang].ui.err,'err'); return false; }
    }

    /* ======================== AI + Fallback ======================== */
    async function callProxy(prompt, timeoutMs=35000){
      const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const r=await fetch('/.netlify/functions/gemini-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt}),signal:ctrl.signal});
        clearTimeout(t);
        if(!r.ok) throw new Error(await r.text());
        const data=await r.json();
        return data && data.text ? data.text : '';
      }catch(e){ clearTimeout(t); return ''; }
    }

    function targetMacros(){ const c=calc(); return {kcal:c.TDEE, protein_g:c.P, fat_g:c.F, carb_g:c.C}; }

    function localNutritionGenerator(target, mealsPerDay, dayIndex, userCtx){
      // ÙŠØ¨Ù†ÙŠ 7 ÙˆØ¬Ø¨Ø§Øª Ù…Ø®ØªÙ„ÙØ© Ù„ÙƒÙ„ ÙŠÙˆÙ… Ø¹Ø¨Ø± Ù‚ÙˆØ§Ù„Ø¨ Ø¢Ù…Ù†Ø©: ÙŠØºÙŠÙ‘Ø± Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†/Ø§Ù„ÙƒØ§Ø±Ø¨/Ø§Ù„Ø¯Ù‡ÙˆÙ†ØŒ ÙˆÙŠØ­ØªØ±Ù… Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©/Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©/Ø§Ù„Ù…Ø·Ø¨Ø®
      const protBanks = {
        Mixed:['ØµØ¯ÙˆØ± Ø¯Ø¬Ø§Ø¬','Ù„Ø­Ù… Ø¨Ù‚Ø±ÙŠ Ø®Ø§Ù„ÙŠ','Ø³Ù…Ùƒ Ø³Ù„Ù…ÙˆÙ†','ØªÙˆÙ†Ø©','Ø¨ÙŠØ¶','Ø¬Ø¨Ù† Ù‚Ø±ÙŠØ´','Turkey','Greek yogurt'],
        Western:['Chicken breast','Lean beef','Salmon','Tuna','Eggs','Cottage cheese','Turkey','Greek yogurt'],
      };
      const carbBanks = {
        Mixed:['Ø£Ø±Ø² Ø¨Ø³Ù…ØªÙŠ','Ø¨Ø·Ø§Ø·Ø³','Ø´ÙˆÙØ§Ù†','Ø®Ø¨Ø² Ù‚Ù…Ø­ ÙƒØ§Ù…Ù„','ÙƒÙŠÙ†ÙˆØ§','Ø¨Ø±ØºÙ„','ÙÙˆØ§ÙƒÙ‡ Ù…ØªÙ†ÙˆØ¹Ø©','Ø®Ø¶Ø§Ø± Ù†Ø´ÙˆÙŠØ©'],
        Western:['Basmati rice','Potatoes','Oats','Whole-wheat bread','Quinoa','Bulgur','Mixed fruit','Starchy veg']
      };
      const fatBanks = {
        Mixed:['Ø²ÙŠØª Ø²ÙŠØªÙˆÙ†','Ø£ÙÙˆÙƒØ§Ø¯Ùˆ','Ù…ÙƒØ³Ø±Ø§Øª','Ø·Ø­ÙŠÙ†Ø©','Ø²ÙŠØª Ø¬ÙˆØ² Ø§Ù„Ù‡Ù†Ø¯'],
        Western:['Olive oil','Avocado','Mixed nuts','Tahini','Coconut oil']
      };
      const locale = (lang==='ar')?'Mixed':'Western';
      const P=target.protein_g, F=target.fat_g, C=target.carb_g, kcal=target.kcal;

      // ØªÙ‚Ø³ÙŠÙ… ÙŠÙˆÙ…ÙŠ Ø¨Ø³ÙŠØ· ÙŠØ¶Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¨ (Â±1% Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙŠÙØ¶Ø¨Ø·):
      const pShare = [0.25,0.2,0.2,0.2,0.15].slice(0, mealsPerDay);
      const fShare = [0.25,0.2,0.2,0.2,0.15].slice(0, mealsPerDay);
      const cShare = [0.25,0.2,0.25,0.2,0.1].slice(0, mealsPerDay);

      const meals=[];
      for(let i=0;i<mealsPerDay;i++){
        const p=Math.round(P*pShare[i]);
        const f=Math.round(F*fShare[i]);
        const c=Math.round(C*cShare[i]);
        const kcalM = p*4 + f*9 + c*4;

        const prot = protBanks[locale][(dayIndex+i)%protBanks[locale].length];
        const carb = carbBanks[locale][(dayIndex*2+i)%carbBanks[locale].length];
        const fat  = fatBanks[locale][(i)%fatBanks[locale].length];

        meals.push({
          index:i+1,
          name: (lang==='ar'?'ÙˆØ¬Ø¨Ø©':'Meal') + ' ' + (i+1),
          items:[
            {name:prot, qty: (p*7), unit:'g (raw equiv.)'},
            {name:carb, qty: (c*8), unit:'g (cooked equiv.)'},
            {name:fat,  qty: Math.max(5, Math.round(f*3)), unit:'g (oil/nuts)'}
          ],
          protein_g:p,fat_g:f,carb_g:c,kcal:kcalM
        });
      }
      const totals = meals.reduce((t,m)=>({protein_g:t.protein_g+m.protein_g,fat_g:t.fat_g+m.fat_g,carb_g:t.carb_g+m.carb_g,kcal:t.kcal+m.kcal}),{protein_g:0,fat_g:0,carb_g:0,kcal:0});
      // ØªØµØ­ÙŠØ­ ØµØºÙŠØ± Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø¨ Ù…Ù† Â±1%
      const fix=(want,got)=>{const d=want-got; return Math.round(d);};
      totals.protein_g += fix(P,totals.protein_g);
      totals.fat_g     += fix(F,totals.fat_g);
      totals.carb_g    += fix(C,totals.carb_g);
      totals.kcal       = totals.protein_g*4 + totals.fat_g*9 + totals.carb_g*4;

      return {day:dayIndex, meals, total:totals};
    }

    function localTrainingGenerator(dayIndex, userCtx){
      const level=userCtx.exp; const place=userCtx.training_place;
      const base = (lvl)=>({
        Beginner:[
          {exercise:'Goblet Squat', sets:4, reps:'10-12', tempo:'3010', rest_s:90, rir:2, notes:'Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ‚Ø¯Ù…'},
          {exercise:'Push-Up (elevated if needed)', sets:4, reps:'8-12', tempo:'2110', rest_s:90, rir:2, notes:'ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¬Ø°Ø¹'},
          {exercise:'DB Row', sets:4, reps:'10-12', tempo:'3011', rest_s:90, rir:2, notes:'ÙƒØªÙ Ø«Ø§Ø¨Øª'},
          {exercise:'DB RDL', sets:3, reps:'10', tempo:'3010', rest_s:90, rir:2},
          {exercise:'Plank', sets:3, reps:'45-60s', tempo:'â€”', rest_s:60, rir:1}
        ],
        Intermediate:[
          {exercise:'Back Squat / Front Squat', sets:5, reps:'5-8', tempo:'3010', rest_s:120, rir:2},
          {exercise:'Bench Press', sets:5, reps:'6-8', tempo:'2110', rest_s:120, rir:2},
          {exercise:'Bent Over Row', sets:4, reps:'8-10', tempo:'3011', rest_s:90, rir:2},
          {exercise:'RDL', sets:4, reps:'8-10', tempo:'3110', rest_s:120, rir:2},
          {exercise:'Hanging Leg Raise', sets:3, reps:'10-12', tempo:'2010', rest_s:60, rir:1}
        ],
        Advanced:[
          {exercise:'Back Squat (heavy)', sets:5, reps:'3-5', tempo:'30X0', rest_s:180, rir:2},
          {exercise:'Bench Press (pause)', sets:5, reps:'4-6', tempo:'21X0', rest_s:180, rir:2},
          {exercise:'Weighted Pull-Up', sets:5, reps:'5-8', tempo:'30X0', rest_s:150, rir:2},
          {exercise:'RDL (heavy)', sets:4, reps:'5-6', tempo:'31X0', rest_s:180, rir:2},
          {exercise:'Pallof Press', sets:3, reps:'12-15', tempo:'2010', rest_s:60, rir:1}
        ]
      })[lvl];
      const plan = base(level) || base('Beginner');
      // ØªÙƒÙŠÙŠÙ Ù…Ø¹ Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨
      if(/Home bodyweight/.test(place)) {
        plan.forEach(b=>{ if(/Squat|Bench|Row|RDL/i.test(b.exercise)) b.exercise='Bodyweight variation'; });
      }
      return {day:dayIndex, blocks:plan};
    }

    function buildLocalJSON(){
      const target = targetMacros();
      const nutrition=[], training=[];
      for(let d=1; d<=7; d++){
        nutrition.push(localNutritionGenerator(target, user.meals, d, user));
        training.push(localTrainingGenerator(d, user));
      }
      return {
        client:{
          name:user.name, language:(lang==='ar'?'AR':'EN'),
          goals:user.goals, diet:user.diet, meals_per_day:user.meals,
          fasting:user.fasting, health:user.health, allergies:user.allergies, meds:user.meds,
          injuries:user.injuries, experience:user.exp, focus_points:user.weak_points,
          training_place:user.training_place, equipment:user.equipment, sleep:user.sleep, stress:user.stress
        },
        targets: target,
        nutrition, training,
        supplements:{
          core:[
            {name:'Whey/Casein', dose: (lang==='ar'?'20-40 Øº Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†':'20â€“40 g post-workout'), note:(lang==='ar'?'Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ø­ØµØ© Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†':'to hit protein target')},
            {name:'Creatine Monohydrate', dose:'5 g / day', note:(lang==='ar'?'Ø«Ø§Ø¨Øª ÙŠÙˆÙ…ÙŠÙ‹Ø§':'daily, any time')},
            {name:'Omega-3', dose:'1â€“2 g EPA/DHA', note:(lang==='ar'?'Ù…Ø¹ ÙˆØ¬Ø¨Ø© Ø¯Ù‡Ù†ÙŠØ©':'with fatty meal')},
            {name:'Vitamin D3', dose:'2000 IU', note:(lang==='ar'?'ØµØ¨Ø§Ø­Ù‹Ø§':'morning')},
            {name:'Magnesium (Glycinate)', dose:'200â€“400 mg', note:(lang==='ar'?'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…':'pre-sleep')},
            {name:'Electrolytes', dose:(lang==='ar'?'Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø±Ù‚ ÙˆØ§Ù„Ù†Ø´Ø§Ø·':'per sweat/activity'), note:(lang==='ar'?'Ø®ØµÙˆØµÙ‹Ø§ Ù…Ø¹ Ø§Ù„ØµÙŠØ§Ù…':'esp. with IF')}
          ],
          condition: buildConditionSupps()
        },
        addons:{
          grocery:user.include.grocery, micronutrients:user.include.micro, hydration:user.include.hydration,
          periodization:user.include.periodization, budget:user.include.budget, prepGuide:user.include.prep, cookingTips:user.include.cooking
        }
      };
    }

    function buildConditionSupps(){
      const list=[];
      if(user.health.includes('Ø¶ØºØ· Ø§Ù„Ø¯Ù…')||user.health.includes('Hypertension')) list.push({name:'CoQ10', dose:'100â€“200 mg', caution:(lang==='ar'?'Ø±Ø§Ø¬Ø¹ Ø·Ø¨ÙŠØ¨Ùƒ':'consult your physician')});
      if(user.health.includes('Ø§Ù„Ø³ÙƒØ±ÙŠ')||user.health.includes('Diabetes')||user.health.includes('Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†')||user.health.includes('Insulin Resistance')) list.push({name:'Berberine', dose:'500 mg Ã—2', caution:(lang==='ar'?'Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø³ÙƒØ± Ù…Ø¹ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©':'monitor glucose with meds')});
      if(user.health.includes('Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©')||user.health.includes('Thyroid')) list.push({name:'Selenium', dose:'100â€“200 mcg', caution:(lang==='ar'?'Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¬Ø±Ø¹Ø©':'do not exceed')});
      if(user.health.includes('Ø§Ù„ÙƒØ¨Ø¯ Ø§Ù„Ø¯Ù‡Ù†ÙŠ')||user.health.includes('Fatty Liver')) list.push({name:'Choline', dose:'500â€“1000 mg', caution:(lang==='ar'?'Ù…Ø¹ ÙˆØ¬Ø¨Ø©':'with meal')});
      if(user.health.includes('Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù‡Ø¶Ù…ÙŠ')||user.health.includes('GI issues')) list.push({name:'Probiotics', dose:(lang==='ar'?'ÙˆÙÙ‚ Ø§Ù„Ø´Ø±ÙƒØ©':'per label'), caution:(lang==='ar'?'Ø§Ø®ØªØ± Ø³Ù„Ø§Ù„Ø§Øª Ù…ÙˆØ«ÙˆÙ‚Ø©':'use reputable strains')});
      return list;
    }

    function within1pct(actual, target){ const pct=(a,b)=>Math.abs(a-b)/Math.max(1,b); return pct(actual.kcal,target.kcal)<=0.01 && pct(actual.protein_g,target.protein_g)<=0.01 && pct(actual.fat_g,target.fat_g)<=0.01 && pct(actual.carb_g,target.carb_g)<=0.01; }

    function auditJSON(json){
      const target=json.targets; const mealsRequired=json.client.meals_per_day;
      const res={nutrition:[], training:[], summary:{ok:true, fixed:false}};
      for(const day of json.nutrition){
        const okMeals = (day.meals||[]).length===mealsRequired;
        const totals = day.total||{protein_g:0,fat_g:0,carb_g:0,kcal:0};
        const okMacros = within1pct(totals,target);
        res.nutrition.push({day:day.day, okMeals, okMacros});
        if(!okMeals || !okMacros) res.summary.ok=false;
      }
      for(const day of json.training){
        let okSchema = true;
        for(const b of (day.blocks||[])){
          if(!b.exercise || !b.sets || !b.reps || !b.tempo || !b.rest_s || (b.rir===undefined)) { okSchema=false; break; }
        }
        res.training.push({day:day.day, okSchema}); if(!okSchema) res.summary.ok=false;
      }
      return res;
    }

    function renderTablesFromJSON(json){
      const out=[];
      // Allowed/Avoid + IF + Supplements (Ù…Ø®ØªØµØ± ØªÙ†Ø¸ÙŠÙ…ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©)
      out.push(`<h2>${lang==='ar'?'Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„Ù‡Ø¯Ù':'Assessment & Goal'}</h2>`);
      const g = (json.client.goals||[]).join(lang==='ar'?'ØŒ ':', ');
      out.push(`<p>${lang==='ar'
        ? `Ø§Ù„Ù‡Ø¯Ù: ${g}. Ø§Ù„Ù†Ø¸Ø§Ù…: ${json.client.diet}. Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª: ${json.client.meals_per_day}. Ø§Ù„Ø­Ø§Ù„Ø§Øª: ${(json.client.health||[]).join('ØŒ ')||'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}. Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©: ${(json.client.allergies||[]).join('ØŒ ')||'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}.`
        : `Goal: ${g}. Diet: ${json.client.diet}. Meals/day: ${json.client.meals_per_day}. Conditions: ${(json.client.health||[]).join(', ')||'None'}. Allergies: ${(json.client.allergies||[]).join(', ')||'None'}.`
      }</p>`);

      out.push(`<h2>${lang==='ar'?'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙˆØ§Ù„Ù…Ù…Ù†ÙˆØ¹':'Allowed & Avoid'}</h2>`);
      out.push(`<ul>
        <li>${lang==='ar'?'Ø¨Ø±ÙˆØªÙŠÙ†Ø§Øª':'Proteins'}: ${lang==='ar'?'Ø¯Ø¬Ø§Ø¬ØŒ Ù„Ø­Ù… Ø®Ø§Ù„ÙŠØŒ Ø³Ù…ÙƒØŒ Ø¨ÙŠØ¶ØŒ Ø£Ù„Ø¨Ø§Ù† Ù‚Ù„ÙŠÙ„Ø© Ø§Ù„Ø¯Ø³Ù…':'chicken, lean beef, fish, eggs, low-fat dairy'}</li>
        <li>${lang==='ar'?'ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª':'Carbs'}: ${lang==='ar'?'Ø£Ø±Ø²/Ø¨Ø·Ø§Ø·Ø³/ÙƒÙŠÙ†ÙˆØ§/Ø´ÙˆÙØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù…':'rice/potato/quinoa/oats per diet'}</li>
        <li>${lang==='ar'?'Ø¯Ù‡ÙˆÙ†':'Fats'}: ${lang==='ar'?'Ø²ÙŠØª Ø²ÙŠØªÙˆÙ†/Ø£ÙÙˆÙƒØ§Ø¯Ùˆ/Ù…ÙƒØ³Ø±Ø§Øª':'olive oil/avocado/nuts'}</li>
        <li>${lang==='ar'?'ØªØ¬Ù†Ø¨':'Avoid'}: ${ (json.client.allergies||[]).length? (lang==='ar'?'Ø§Ù„Ù…Ø³Ø¨Ø¨Ø§Øª Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø©':'listed allergens') : (lang==='ar'?'Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© ÙˆØ§Ù„Ø²ÙŠÙˆØª Ø§Ù„Ù…Ù‡Ø¯Ø±Ø¬Ø©':'added sugars & trans fats') }</li>
      </ul>`);

      if(json.client.fasting?.enabled){
        out.push(`<h2>${lang==='ar'?'Ø§Ù„ØµÙŠØ§Ù… Ø§Ù„Ù…ØªÙ‚Ø·Ø¹':'Intermittent Fasting'}</h2>`);
        out.push(`<p>${lang==='ar'
          ? `Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„: ${json.client.fasting.protocol}. Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙƒÙ„: ${json.client.fasting.start}â€“${json.client.fasting.end}. Ø§Ù„Ù…Ø§Ø¡/Ø§Ù„Ù‚Ù‡ÙˆØ© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡/Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ„ÙŠØª Ù„Ø§ ÙŠÙƒØ³Ø± Ø§Ù„ØµÙŠØ§Ù….`
          : `Protocol: ${json.client.fasting.protocol}. Feeding window: ${json.client.fasting.start}â€“${json.client.fasting.end}. Water/black coffee/electrolytes donâ€™t break the fast.`}</p>`);
      }

      out.push(`<h2>${lang==='ar'?'Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª':'Supplements'}</h2>`);
      const core = (json.supplements?.core||[]).map(s=>`${s.name} â€” ${s.dose} (${s.note||''})`).join(lang==='ar'?'<br/>':'<br/>');
      const cond = (json.supplements?.condition||[]).map(s=>`${s.name} â€” ${s.dose} (${s.caution||''})`).join(lang==='ar'?'<br/>':'<br/>');
      out.push(`<p><b>${lang==='ar'?'Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©':'Core'}:</b><br/>${core||'â€”'}</p>`);
      out.push(`<p><b>${lang==='ar'?'Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©':'Condition-specific'}:</b><br/>${cond||'â€”'}</p>`);

      // ØªØºØ°ÙŠØ© 7 Ø£ÙŠØ§Ù…
      out.push(`<h2 id="nutrition">${lang==='ar'?'Ø®Ø·Ø© Ø§Ù„ØªØºØ°ÙŠØ© (7 Ø£ÙŠØ§Ù…)':'Nutrition Plan (7 Days)'}</h2>`);
      for(const day of json.nutrition){
        const badge = (()=>{ const ok=within1pct(day.total,json.targets) && (day.meals||[]).length===json.client.meals_per_day; return ok? (lang==='ar'?'âœ… Ù…Ø·Ø§Ø¨Ù‚':'âœ… OK') : (lang==='ar'?'ğŸ› ï¸ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„':'ğŸ› ï¸ Adjusted');})();
        out.push(`<h3>${lang==='ar'?'Ø§Ù„ÙŠÙˆÙ…':'Day'} ${day.day} ${badge}</h3>`);
        out.push(`<table>
          <thead><tr>
            <th style="text-align:right">#</th>
            <th style="text-align:right">${lang==='ar'?'Ø§Ù„ÙˆØ¬Ø¨Ø©':'Meal'}</th>
            <th style="text-align:right">${lang==='ar'?'Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª':'Ingredients'}</th>
            <th style="text-align:right">P</th>
            <th style="text-align:right">F</th>
            <th style="text-align:right">C</th>
            <th style="text-align:right">Kcal</th>
          </tr></thead><tbody>
          ${day.meals.map(m=>{
            const items = (m.items||[]).map(it=>`${it.name} ${it.qty}${it.unit||''}`).join(' â€¢ ');
            return `<tr>
              <td style="text-align:right">${m.index}</td>
              <td style="text-align:right">${m.name}</td>
              <td style="text-align:right">${items}</td>
              <td style="text-align:right">${m.protein_g}</td>
              <td style="text-align:right">${m.fat_g}</td>
              <td style="text-align:right">${m.carb_g}</td>
              <td style="text-align:right">${m.kcal}</td>
            </tr>`;
          }).join('')}
          </tbody></table>
          <div><b>${lang==='ar'?'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ':'Daily Total'} â†’ P:${day.total.protein_g} F:${day.total.fat_g} C:${day.total.carb_g} Kcal:${day.total.kcal}</b></div>`);
      }

      // ØªØ¯Ø±ÙŠØ¨ 7 Ø£ÙŠØ§Ù…
      out.push(`<h2 id="training">${lang==='ar'?'Ø®Ø·Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)':'Training Plan (7 Days)'}</h2>`);
      for(const day of json.training){
        out.push(`<h3>${lang==='ar'?'Ø§Ù„ÙŠÙˆÙ…':'Day'} ${day.day}</h3>`);
        out.push(`<table>
          <thead><tr>
            <th style="text-align:right">${lang==='ar'?'Ø§Ù„ÙŠÙˆÙ…':'Day'}</th>
            <th style="text-align:right">Exercise</th>
            <th style="text-align:right">${lang==='ar'?'Ù…Ù„Ø§Ø­Ø¸Ø§Øª':'Notes'}</th>
            <th style="text-align:right">Sets</th>
            <th style="text-align:right">Reps</th>
            <th style="text-align:right">Tempo</th>
            <th style="text-align:right">Rest (s)</th>
            <th style="text-align:right">RIR</th>
          </tr></thead><tbody>
          ${day.blocks.map(b=>`<tr>
            <td style="text-align:right">${day.day}</td>
            <td style="text-align:right">${b.exercise}</td>
            <td style="text-align:right">${b.notes||''}</td>
            <td style="text-align:right">${b.sets}</td>
            <td style="text-align:right">${b.reps}</td>
            <td style="text-align:right">${b.tempo}</td>
            <td style="text-align:right">${b.rest_s}</td>
            <td style="text-align:right">${b.rir}</td>
          </tr>`).join('')}
          </tbody></table>`);
      }
      return out.join('\n');
    }

    function sanitizeMarkdown(md){
      const html = marked.parse(md);
      return DOMPurify.sanitize(html, {ALLOWED_ATTR:['id','class','href','align','style']});
    }

    async function generatePlan(){
      $('result').classList.remove('hidden');
      $('ai-html').innerHTML = `<div class="text-center py-10">
        <div class="w-12 h-12 rounded-full border-4 border-violet-600 border-top-transparent animate-spin mx-auto"></div>
        <div class="mt-3">${L[lang].ui.building}</div></div>`;

      // 1) Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ (JSON Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
      const targets = targetMacros();
      const promptJSON = `
Return STRICT JSON only (no fences) for 7 full nutrition & 7 training days that meet daily targets Â±1% and meals per day = ${user.meals}.
If you cannot comply, return an empty string.

Client: ${JSON.stringify({name:user.name,lang:(lang==='ar'?'AR':'EN'),goals:user.goals,diet:user.diet,meals:user.meals,fasting:user.fasting,health:user.health,allergies:user.allergies,injuries:user.injuries,experience:user.exp,focus_points:user.weak_points,training_place:user.training_place,equipment:user.equipment,sleep:user.sleep,stress:user.stress})}
Targets: ${JSON.stringify(targets)}
      `.trim();

      let raw = await callProxy(promptJSON);
      let jsonOk=false;
      if(raw){
        try{
          raw = raw.trim().replace(/^```json|```$/g,'');
          planJSON = JSON.parse(raw);
          jsonOk=true;
        }catch{ jsonOk=false; }
      }
      if(!jsonOk){
        // 2) Ùallback Ù…Ø­Ù„ÙŠ Ù…Ø¶Ù…ÙˆÙ†
        toast(L[lang].ui.apiFail,'warn');
        planJSON = buildLocalJSON();
      }

      // 3) ØªØ¯Ù‚ÙŠÙ‚
      audit = auditJSON(planJSON);

      // 4) Ù†Ø«Ø± ØªØ£Ø³ÙŠØ³ÙŠ (Ù…Ù‚Ø¯Ù‘Ù…Ø©/Ù…Ø³Ù…ÙˆØ­/ØµÙŠØ§Ù…/Ù…ÙƒÙ…Ù„Ø§Øª/Ù†ØµØ§Ø¦Ø­) â€” Ù…Ø­Ù„ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
      const intro = (lang==='ar'
        ? `## Ù…Ù‚Ø¯Ù…Ø© Ø´Ø®ØµÙŠØ© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©
Ø£Ù‡Ù„Ø§Ù‹ ${planJSON.client.name}! Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙˆÙ†Ø´Ø§Ø·Ùƒ (${user.jobLabel}) ÙˆÙ‡Ø¯ÙÙƒ (${planJSON.client.goals.join('ØŒ ')}), ØµÙ…Ù‘Ù…Ù†Ø§ Ø®Ø·Ø© Ù…ØªÙƒØ§Ù…Ù„Ø© Ø¨Ù„Ø§ Ø§Ø®ØªØµØ§Ø± ØªÙˆØ§Ø²Ù† Ø¨ÙŠÙ† Ø§Ù„Ø¯Ù‚Ø© ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…. ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ù…Ø§ÙƒØ±ÙˆØ² Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¹Ù„Ù‰: **${planJSON.targets.kcal} Kcal** Ù…Ø¹ **P:${planJSON.targets.protein_g} / F:${planJSON.targets.fat_g} / C:${planJSON.targets.carb_g}**.`
        : `## Personalized Intro & Assessment
Welcome ${planJSON.client.name}! Based on your activity (${user.jobLabel}) and goals (${planJSON.client.goals.join(', ')}), we built a comprehensive, no-shortcut plan. Daily targets are **${planJSON.targets.kcal} Kcal** with **P:${planJSON.targets.protein_g} / F:${planJSON.targets.fat_g} / C:${planJSON.targets.carb_g}**.`);

      const tables = renderTablesFromJSON(planJSON);

      const motivation = (lang==='ar'
        ? `## Ø±Ø³Ø§Ø¦Ù„ ØªØ­ÙÙŠØ²ÙŠØ© ÙŠÙˆÙ…ÙŠØ©
- Ø§Ù„ÙŠÙˆÙ… 1: Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯.
- Ø§Ù„ÙŠÙˆÙ… 2: ØªÙ‚Ø¯Ù‘Ù… ØµØºÙŠØ± Ø§Ù„ÙŠÙˆÙ… = Ù‚ÙØ²Ø© ÙƒØ¨ÙŠØ±Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.
- Ø§Ù„ÙŠÙˆÙ… 3: Ø§Ø¶Ø¨Ø· Ø§Ù„Ù†ÙˆÙ… ÙˆØ§Ù„Ù…Ø§Ø¡ Ù„ØªØ­Ø³Ù‘Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡.
- Ø§Ù„ÙŠÙˆÙ… 4: Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ÙˆØ²Ù†.
- Ø§Ù„ÙŠÙˆÙ… 5: Ø§Ù„ØªØºØ°ÙŠØ© Ù‡ÙŠ Ø§Ù„ÙˆÙ‚ÙˆØ¯ â€” Ù„Ø§ ØªÙÙ‡Ù…ÙÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†.
- Ø§Ù„ÙŠÙˆÙ… 6: Ø±Ø§Ø­Ø© Ù†Ø´Ø·Ø© ÙˆØªÙ…Ø§Ø±ÙŠÙ† ØªÙ†ÙÙ‘Ø³.
- Ø§Ù„ÙŠÙˆÙ… 7: ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØ²Ø§Ù…Ùƒ ÙˆØ¯ÙˆÙ‘Ù† Ù…ÙƒØ§Ø³Ø¨Ùƒ.`
        : `## Daily Motivation
- Day 1: Nail the basics and timing.
- Day 2: Small wins today = big gains later.
- Day 3: Prioritize sleep & hydration.
- Day 4: Technique before load.
- Day 5: Nutrition is fuel â€” hit your protein.
- Day 6: Active recovery and breathing.
- Day 7: Review adherence and log wins.`);

      const closing = (lang==='ar'
        ? `## Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ§Ù„Ø­Ù‚ÙˆÙ‚
**Mustafa Elsafy â€” Ø®Ø¨ÙŠØ± Ø§Ù„ØªØºØ°ÙŠØ© ÙˆØ§Ù„Ù„ÙŠØ§Ù‚Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© â”‚ Ù…Ø¯Ø±Ø¨ Ø¯ÙˆÙ„ÙŠ Ù…Ø¹ØªÙ…Ø¯**  
**Powered by Mustafa Elsafy 2025**`
        : `## Signature & Rights
**Mustafa Elsafy â€” Certified International Coach**  
**Powered by Mustafa Elsafy 2025**`);

      const md = [intro, tables, motivation, closing].join('\n\n---\n\n');
      const safe = sanitizeMarkdown(md);
      $('ai-html').innerHTML = `<div id="top"></div>` + safe;

      // Ø¨Ø§Ù†Ø± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚
      const banner = $('audit-banner');
      if(audit.summary.ok){
        banner.className='mt-3 rounded-xl p-3 border border-emerald-500/30 bg-emerald-500/10';
        banner.innerHTML=`<b>${L[lang].ui.auditOK}</b>`;
      } else {
        banner.className='mt-3 rounded-xl p-3 border border-amber-500/30 bg-amber-500/10';
        banner.innerHTML=`<b>${audit.summary.fixed? L[lang].ui.auditWarn : L[lang].ui.auditErr}</b>`;
      }
      banner.classList.remove('hidden');

      // ØªØ­Ø³ÙŠÙ† Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
      $('ai-html').querySelectorAll('table').forEach(t=>{
        t.classList.add('w-full','text-sm');
        t.querySelectorAll('th').forEach(th=>th.classList.add('bg-[color:var(--th)]'));
      });

      speak(L[lang].ui.ready);
      $('result').scrollIntoView({behavior:'smooth',block:'start'});
    }

    /* ======================== Controls & Export ======================== */
    function toast(msg,kind='ok'){
      const box=document.createElement('div');
      const side = (document.documentElement.dir==='rtl'?'right':'left');
      box.className=`fixed top-5 ${side}-5 z-50 px-3 py-2 rounded-xl text-sm text-white ${kind==='err'?'bg-red-600': kind==='warn'?'bg-amber-600':'bg-emerald-600'}`;
      box.textContent=msg; document.body.appendChild(box); setTimeout(()=>box.remove(),2600);
    }
    document.getElementById('btn-prev').onclick=()=>{ if(step>0){ step--; draw(); updateCTA(); speak(L[lang].ui.back);} };
    document.getElementById('btn-next').onclick=async ()=>{
      if(step<total-1){
        if(!saveStep()) return;
        step++; draw(); updateCTA();
        if(step===total-1){ if(!saveStep()) return; await generatePlan(); }
      }
    };
    document.getElementById('btn-again').onclick=()=>location.reload();
    document.getElementById('btn-print').onclick=()=>window.print();
    document.getElementById('btn-print-2').onclick=()=>window.print();
    document.getElementById('btn-pdf').onclick=()=>{
      const opt = { margin: 10, filename: (lang==='ar'?'Ø®Ø·Ø©-':'plan-') + (user.name||'client') + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS:true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
      html2pdf().from(document.getElementById('resultRoot')).set(opt).save();
    };

    document.getElementById('btn-lang-ar').onclick=()=>{
      setLang('ar'); planJSON=null; proseMD=''; audit=null; $('result').classList.add('hidden'); step=Math.min(step, total-2); draw(); updateCTA();
    };
    document.getElementById('btn-lang-en').onclick=()=>{
      setLang('en'); planJSON=null; proseMD=''; audit=null; $('result').classList.add('hidden'); step=Math.min(step, total-2); draw(); updateCTA();
    };

    /* ======================== Init ======================== */
    setLang('ar'); draw(); updateLive(); updateCTA();
  </script>
</body>
</html>
